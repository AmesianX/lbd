<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Cpu0 architecture and LLVM structure &mdash; Tutorial: Creating an LLVM Backend for the Cpu0 Architecture</title>
    
    <link rel="stylesheet" href="_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '3.7.2',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="author" title="About these documents" href="about.html" />
    <link rel="top" title="Tutorial: Creating an LLVM Backend for the Cpu0 Architecture" href="index.html" />
    <link rel="next" title="Backend structure" href="backendstructure.html" />
    <link rel="prev" title="About" href="about.html" /> 
  </head>
  <body role="document">
      <div class="header" role="banner"><h1 class="heading"><a href="index.html">
          <span>Tutorial: Creating an LLVM Backend for the Cpu0 Architecture</span></a></h1>
        <h2 class="heading"><span>Cpu0 architecture and LLVM structure</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
        <p>
        «&#160;&#160;<a href="about.html">About</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="backendstructure.html">Backend structure</a>&#160;&#160;»
        </p>

      </div>
      <div class="content">
        
        
  <div class="section" id="cpu0-architecture-and-llvm-structure">
<span id="sec-llvmstructure"></span><h1>Cpu0 architecture and LLVM structure<a class="headerlink" href="#cpu0-architecture-and-llvm-structure" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#cpu0-processor-architecture-details" id="id53">Cpu0 Processor Architecture Details</a><ul>
<li><a class="reference internal" href="#brief-introduction" id="id54">Brief introduction</a></li>
<li><a class="reference internal" href="#the-cpu0-instruction-set" id="id55">The Cpu0 Instruction Set</a><ul>
<li><a class="reference internal" href="#why-not-using-add-instead-of-sub" id="id56">Why not using ADD instead of SUB?</a></li>
</ul>
</li>
<li><a class="reference internal" href="#the-status-register" id="id57">The Status Register</a></li>
<li><a class="reference internal" href="#cpu0-s-stages-of-instruction-execution" id="id58">Cpu0&#8217;s Stages of Instruction Execution</a></li>
<li><a class="reference internal" href="#cpu0-s-interrupt-vector" id="id59">Cpu0&#8217;s Interrupt Vector</a></li>
</ul>
</li>
<li><a class="reference internal" href="#llvm-structure" id="id60">LLVM Structure</a><ul>
<li><a class="reference internal" href="#three-phase-design" id="id61">Three-phase design</a></li>
<li><a class="reference internal" href="#llvm-s-target-description-files-td" id="id62">LLVM&#8217;s Target Description Files: .td</a></li>
<li><a class="reference internal" href="#llvm-code-generation-sequence" id="id63">LLVM Code Generation Sequence</a></li>
<li><a class="reference internal" href="#ssa-form" id="id64">SSA form</a></li>
<li><a class="reference internal" href="#dag-directed-acyclic-graph" id="id65">DAG (Directed Acyclic Graph)</a></li>
<li><a class="reference internal" href="#instruction-selection" id="id66">Instruction Selection</a></li>
<li><a class="reference internal" href="#caller-and-callee-saved-registers" id="id67">Caller and callee saved registers</a></li>
<li><a class="reference internal" href="#live-in-and-live-out-register" id="id68">Live in and live out register</a></li>
</ul>
</li>
<li><a class="reference internal" href="#create-cpu0-backend" id="id69">Create Cpu0 backend</a><ul>
<li><a class="reference internal" href="#cpu0-backend-machine-id-and-relocation-records" id="id70">Cpu0 backend machine ID and relocation records</a></li>
<li><a class="reference internal" href="#creating-the-initial-cpu0-td-files" id="id71">Creating the Initial Cpu0 .td Files</a></li>
<li><a class="reference internal" href="#write-cmake-file" id="id72">Write cmake file</a></li>
<li><a class="reference internal" href="#target-registration" id="id73">Target Registration</a></li>
<li><a class="reference internal" href="#build-libraries-and-td" id="id74">Build libraries and td</a></li>
</ul>
</li>
</ul>
</div>
<p>Before you begin this tutorial, you should know that you can always try to
develop your own backend by porting code from existing backends.
The majority of the code you will want to investigate can be found in the
/lib/Target directory of your root LLVM installation.
As most major RISC instruction sets have some similarities, this may be the
avenue you might try if you are an experienced programmer and knowledgable of
compiler backends.</p>
<p>On the other hand, there is a steep learning curve and you may easily get stuck
debugging your new backend. You can easily spend a lot of time tracing which
methods are callbacks of some function, or which are calling some overridden
method deep in the LLVM codebase - and with a codebase as large as LLVM, all of
this can easily become difficult to keep track of.
This tutorial will help you work through this process while learning the
fundamentals of LLVM backend design.
It will show you what is necessary to get your first backend functional and
complete, and it should help you understand how to debug your backend when it
produces incorrect machine code using output provided by the compiler.</p>
<p>This chapter details the Cpu0 instruction set and the structure of LLVM.
The LLVM structure information is adapted from Chris Lattner&#8217;s LLVM chapter of
the Architecture of Open Source Applications book <a class="footnote-reference" href="#aosa-book" id="id1">[9]</a>. You can read
the original article from the AOSA website if you prefer.</p>
<p>At the end of this Chapter, you will begin to create a new LLVM backend by
writing register and instruction definitions in the Target Description files
which will be used in next chapter.</p>
<p>Finally, there are compiler knowledge like DAG (Directed-Acyclic-Graph) and
instruction selection needed in llvm backend design, and they are explained
here.</p>
<div class="section" id="cpu0-processor-architecture-details">
<h2><a class="toc-backref" href="#id53">Cpu0 Processor Architecture Details</a><a class="headerlink" href="#cpu0-processor-architecture-details" title="Permalink to this headline">¶</a></h2>
<p>This section is based on materials available here <a class="footnote-reference" href="#cpu0-chinese" id="id2">[1]</a> (Chinese)
and here <a class="footnote-reference" href="#cpu0-english" id="id3">[2]</a> (English).</p>
<div class="section" id="brief-introduction">
<h3><a class="toc-backref" href="#id54">Brief introduction</a><a class="headerlink" href="#brief-introduction" title="Permalink to this headline">¶</a></h3>
<p>Cpu0 is a 32-bit architecture. It has 16 general purpose registers (R0, ...,
R15), co-processor registers (like Mips), and other special registers. Its
structure is illustrated in <a class="reference internal" href="#llvmstructure-f1"><span class="std std-numref">Fig. 2</span></a> below.</p>
<div class="figure align-center" id="id33">
<span id="llvmstructure-f1"></span><a class="reference internal image-reference" href="_images/16.png"><img alt="_images/16.png" src="_images/16.png" style="width: 608px; height: 360px;" /></a>
<p class="caption"><span class="caption-number">Fig. 2 </span><span class="caption-text">Architectural block diagram of the Cpu0 processor</span></p>
</div>
<p>The registers are used for the following purposes:</p>
<table border="1" class="docutils" id="id34">
<caption><span class="caption-number">Table 1 </span><span class="caption-text">Cpu0 general purpose registers (GPR)</span><a class="headerlink" href="#id34" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="29%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Register</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>R0</td>
<td>Constant register, value is 0</td>
</tr>
<tr class="row-odd"><td>R1-R10</td>
<td>General-purpose registers</td>
</tr>
<tr class="row-even"><td>R11</td>
<td>Global Pointer register (GP)</td>
</tr>
<tr class="row-odd"><td>R12</td>
<td>Frame Pointer register (FP)</td>
</tr>
<tr class="row-even"><td>R13</td>
<td>Stack Pointer register (SP)</td>
</tr>
<tr class="row-odd"><td>R14</td>
<td>Link Register (LR)</td>
</tr>
<tr class="row-even"><td>R15</td>
<td>Status Word Register (SW)</td>
</tr>
</tbody>
</table>
<table border="1" class="docutils" id="id35">
<caption><span class="caption-number">Table 2 </span><span class="caption-text">Cpu0 co-processor 0 registers (C0R)</span><a class="headerlink" href="#id35" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="31%" />
<col width="69%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Register</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>0</td>
<td>Program Counter (PC)</td>
</tr>
<tr class="row-odd"><td>1</td>
<td>Error Program Counter (EPC)</td>
</tr>
</tbody>
</table>
<table border="1" class="docutils" id="id36">
<caption><span class="caption-number">Table 3 </span><span class="caption-text">Cpu0 other registers</span><a class="headerlink" href="#id36" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="29%" />
<col width="71%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Register</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>IR</td>
<td>Instruction register</td>
</tr>
<tr class="row-odd"><td>MAR</td>
<td>Memory Address Register (MAR)</td>
</tr>
<tr class="row-even"><td>MDR</td>
<td>Memory Data Register (MDR)</td>
</tr>
<tr class="row-odd"><td>HI</td>
<td>High part of MULT result</td>
</tr>
<tr class="row-even"><td>LO</td>
<td>Low part of MULT result</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="the-cpu0-instruction-set">
<h3><a class="toc-backref" href="#id55">The Cpu0 Instruction Set</a><a class="headerlink" href="#the-cpu0-instruction-set" title="Permalink to this headline">¶</a></h3>
<p>The Cpu0 instruction set can be divided into three types: L-type instructions,
which are generally associated with memory operations, A-type instructions for
arithmetic operations, and J-type instructions that are typically used when
altering control flow (i.e. jumps).
<a class="reference internal" href="#llvmstructure-f2"><span class="std std-numref">Fig. 3</span></a> illustrates how the bitfields are broken down
for each type of instruction.</p>
<div class="figure align-center" id="id37">
<span id="llvmstructure-f2"></span><a class="reference internal image-reference" href="_images/23.png"><img alt="_images/23.png" src="_images/23.png" style="width: 601px; height: 331px;" /></a>
<p class="caption"><span class="caption-number">Fig. 3 </span><span class="caption-text">Cpu0&#8217;s three instruction formats</span></p>
</div>
<p>The Cpu0 has two ISA, the first ISA-I is cpu032I which hired CMP instruction
from ARM; the second ISA-II is cpu032II which hired SLT instruction from Mips.
The cpu032II include all cpu032I instruction set and add SLT, BEQ, ...,
instructions. The main purpose to add cpu032II is for instruction set design
explanation. As you will see in later chapter (chapter Control flow statements),
the SLT instruction will has better performance than CMP old style instruction.
The following table details the cpu032I instruction set:</p>
<ul class="simple">
<li>First column F.: meaning Format.</li>
</ul>
<table border="1" class="docutils" id="id38">
<caption><span class="caption-number">Table 4 </span><span class="caption-text">cpu032I Instruction Set</span><a class="headerlink" href="#id38" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="3%" />
<col width="11%" />
<col width="8%" />
<col width="31%" />
<col width="19%" />
<col width="28%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">F.</th>
<th class="head">Mnemonic</th>
<th class="head">Opcode</th>
<th class="head">Meaning</th>
<th class="head">Syntax</th>
<th class="head">Operation</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>L</td>
<td>NOP</td>
<td>00</td>
<td>No Operation</td>
<td>&nbsp;</td>
<td>&nbsp;</td>
</tr>
<tr class="row-odd"><td>L</td>
<td>LD</td>
<td>01</td>
<td>Load word</td>
<td>LD Ra, [Rb+Cx]</td>
<td>Ra &lt;= [Rb+Cx]</td>
</tr>
<tr class="row-even"><td>L</td>
<td>ST</td>
<td>02</td>
<td>Store word</td>
<td>ST Ra, [Rb+Cx]</td>
<td>[Rb+Cx] &lt;= Ra</td>
</tr>
<tr class="row-odd"><td>L</td>
<td>LB</td>
<td>03</td>
<td>Load byte</td>
<td>LB Ra, [Rb+Cx]</td>
<td>Ra &lt;= (byte)[Rb+Cx] <a class="footnote-reference" href="#lb-note" id="id4">[3]</a></td>
</tr>
<tr class="row-even"><td>L</td>
<td>LBu</td>
<td>04</td>
<td>Load byte unsigned</td>
<td>LBu Ra, [Rb+Cx]</td>
<td>Ra &lt;= (byte)[Rb+Cx] <a class="footnote-reference" href="#lb-note" id="id5">[3]</a></td>
</tr>
<tr class="row-odd"><td>L</td>
<td>SB</td>
<td>05</td>
<td>Store byte</td>
<td>SB Ra, [Rb+Cx]</td>
<td>[Rb+Cx] &lt;= (byte)Ra</td>
</tr>
<tr class="row-even"><td>L</td>
<td>LH</td>
<td>06</td>
<td>Load half word</td>
<td>LH Ra, [Rb+Cx]</td>
<td>Ra &lt;= (2bytes)[Rb+Cx] <a class="footnote-reference" href="#lb-note" id="id6">[3]</a></td>
</tr>
<tr class="row-odd"><td>L</td>
<td>LHu</td>
<td>07</td>
<td>Load half word unsigned</td>
<td>LHu Ra, [Rb+Cx]</td>
<td>Ra &lt;= (2bytes)[Rb+Cx] <a class="footnote-reference" href="#lb-note" id="id7">[3]</a></td>
</tr>
<tr class="row-even"><td>L</td>
<td>SH</td>
<td>08</td>
<td>Store half word</td>
<td>SH Ra, [Rb+Cx]</td>
<td>[Rb+Cx] &lt;= Ra</td>
</tr>
<tr class="row-odd"><td>L</td>
<td>ADDiu</td>
<td>09</td>
<td>Add immediate</td>
<td>ADDiu Ra, Rb, Cx</td>
<td>Ra &lt;= (Rb + Cx)</td>
</tr>
<tr class="row-even"><td>L</td>
<td>ANDi</td>
<td>0C</td>
<td>AND imm</td>
<td>ANDi Ra, Rb, Cx</td>
<td>Ra &lt;= (Rb &amp; Cx)</td>
</tr>
<tr class="row-odd"><td>L</td>
<td>ORi</td>
<td>0D</td>
<td>OR</td>
<td>ORi Ra, Rb, Cx</td>
<td>Ra &lt;= (Rb | Cx)</td>
</tr>
<tr class="row-even"><td>L</td>
<td>XORi</td>
<td>0E</td>
<td>XOR</td>
<td>XORi Ra, Rb, Cx</td>
<td>Ra &lt;= (Rb ^ Cx)</td>
</tr>
<tr class="row-odd"><td>L</td>
<td>LUi</td>
<td>0F</td>
<td>Load upper</td>
<td>LUi Ra, Cx</td>
<td>Ra &lt;= (Cx &lt;&lt; 16)</td>
</tr>
<tr class="row-even"><td>A</td>
<td>CMP</td>
<td>10</td>
<td>Compare</td>
<td>CMP Ra, Rb</td>
<td>SW &lt;= (Ra cond Rb) <a class="footnote-reference" href="#cond-note" id="id8">[5]</a></td>
</tr>
<tr class="row-odd"><td>A</td>
<td>ADDu</td>
<td>11</td>
<td>Add unsigned</td>
<td>ADD Ra, Rb, Rc</td>
<td>Ra &lt;= Rb + Rc <a class="footnote-reference" href="#u-note" id="id9">[4]</a></td>
</tr>
<tr class="row-even"><td>A</td>
<td>SUBu</td>
<td>12</td>
<td>Sub unsigned</td>
<td>SUB Ra, Rb, Rc</td>
<td>Ra &lt;= Rb - Rc <a class="footnote-reference" href="#u-note" id="id10">[4]</a></td>
</tr>
<tr class="row-odd"><td>A</td>
<td>ADD</td>
<td>13</td>
<td>Add</td>
<td>ADD Ra, Rb, Rc</td>
<td>Ra &lt;= Rb + Rc <a class="footnote-reference" href="#u-note" id="id11">[4]</a></td>
</tr>
<tr class="row-even"><td>A</td>
<td>SUB</td>
<td>14</td>
<td>Subtract</td>
<td>SUB Ra, Rb, Rc</td>
<td>Ra &lt;= Rb - Rc <a class="footnote-reference" href="#u-note" id="id12">[4]</a></td>
</tr>
<tr class="row-odd"><td>A</td>
<td>MUL</td>
<td>17</td>
<td>Multiply</td>
<td>MUL Ra, Rb, Rc</td>
<td>Ra &lt;= Rb * Rc</td>
</tr>
<tr class="row-even"><td>A</td>
<td>AND</td>
<td>18</td>
<td>Bitwise and</td>
<td>AND Ra, Rb, Rc</td>
<td>Ra &lt;= Rb &amp; Rc</td>
</tr>
<tr class="row-odd"><td>A</td>
<td>OR</td>
<td>19</td>
<td>Bitwise or</td>
<td>OR Ra, Rb, Rc</td>
<td>Ra &lt;= Rb | Rc</td>
</tr>
<tr class="row-even"><td>A</td>
<td>XOR</td>
<td>1A</td>
<td>Bitwise exclusive or</td>
<td>XOR Ra, Rb, Rc</td>
<td>Ra &lt;= Rb ^ Rc</td>
</tr>
<tr class="row-odd"><td>A</td>
<td>ROL</td>
<td>1B</td>
<td>Rotate left</td>
<td>ROL Ra, Rb, Cx</td>
<td>Ra &lt;= Rb rol Cx</td>
</tr>
<tr class="row-even"><td>A</td>
<td>ROR</td>
<td>1C</td>
<td>Rotate right</td>
<td>ROR Ra, Rb, Cx</td>
<td>Ra &lt;= Rb ror Cx</td>
</tr>
<tr class="row-odd"><td>A</td>
<td>SRA</td>
<td>1D</td>
<td>Shift right</td>
<td>SRA Ra, Rb, Cx</td>
<td>Ra &lt;= Rb &#8216;&gt;&gt; Cx <a class="footnote-reference" href="#sra-note" id="id13">[6]</a></td>
</tr>
<tr class="row-even"><td>A</td>
<td>SHL</td>
<td>1E</td>
<td>Shift left</td>
<td>SHL Ra, Rb, Cx</td>
<td>Ra &lt;= Rb &lt;&lt; Cx</td>
</tr>
<tr class="row-odd"><td>A</td>
<td>SHR</td>
<td>1F</td>
<td>Shift right</td>
<td>SHR Ra, Rb, Cx</td>
<td>Ra &lt;= Rb &gt;&gt; Cx</td>
</tr>
<tr class="row-even"><td>A</td>
<td>SRAV</td>
<td>20</td>
<td>Shift right</td>
<td>SRAV Ra, Rb, Rc</td>
<td>Ra &lt;= Rb &#8216;&gt;&gt; Rc <a class="footnote-reference" href="#sra-note" id="id14">[6]</a></td>
</tr>
<tr class="row-odd"><td>A</td>
<td>SHLV</td>
<td>21</td>
<td>Shift left</td>
<td>SHLV Ra, Rb, Rc</td>
<td>Ra &lt;= Rb &lt;&lt; Rc</td>
</tr>
<tr class="row-even"><td>A</td>
<td>SHRV</td>
<td>22</td>
<td>Shift right</td>
<td>SHRV Ra, Rb, Rc</td>
<td>Ra &lt;= Rb &gt;&gt; Rc</td>
</tr>
<tr class="row-odd"><td>A</td>
<td>ROL</td>
<td>23</td>
<td>Rotate left</td>
<td>ROL Ra, Rb, Rc</td>
<td>Ra &lt;= Rb rol Rc</td>
</tr>
<tr class="row-even"><td>A</td>
<td>ROR</td>
<td>24</td>
<td>Rotate right</td>
<td>ROR Ra, Rb, Rc</td>
<td>Ra &lt;= Rb ror Rc</td>
</tr>
<tr class="row-odd"><td>J</td>
<td>JEQ</td>
<td>30</td>
<td>Jump if equal (==)</td>
<td>JEQ Cx</td>
<td>if SW(==), PC &lt;= PC + Cx</td>
</tr>
<tr class="row-even"><td>J</td>
<td>JNE</td>
<td>31</td>
<td>Jump if not equal (!=)</td>
<td>JNE Cx</td>
<td>if SW(!=), PC &lt;= PC + Cx</td>
</tr>
<tr class="row-odd"><td>J</td>
<td>JLT</td>
<td>32</td>
<td>Jump if less than (&lt;)</td>
<td>JLT Cx</td>
<td>if SW(&lt;), PC &lt;= PC + Cx</td>
</tr>
<tr class="row-even"><td>J</td>
<td>JGT</td>
<td>33</td>
<td>Jump if greater than (&gt;)</td>
<td>JGT Cx</td>
<td>if SW(&gt;), PC &lt;= PC + Cx</td>
</tr>
<tr class="row-odd"><td>J</td>
<td>JLE</td>
<td>34</td>
<td>Jump if less than or equals (&lt;=)</td>
<td>JLE Cx</td>
<td>if SW(&lt;=), PC &lt;= PC + Cx</td>
</tr>
<tr class="row-even"><td>J</td>
<td>JGE</td>
<td>35</td>
<td>Jump if greater than or equals (&gt;=)</td>
<td>JGE Cx</td>
<td>if SW(&gt;=), PC &lt;= PC + Cx</td>
</tr>
<tr class="row-odd"><td>J</td>
<td>JMP</td>
<td>36</td>
<td>Jump (unconditional)</td>
<td>JMP Cx</td>
<td>PC &lt;= PC + Cx</td>
</tr>
<tr class="row-even"><td>J</td>
<td>JALR</td>
<td>39</td>
<td>Indirect jump</td>
<td>JALR Rb</td>
<td>LR &lt;= PC; PC &lt;= Rb <a class="footnote-reference" href="#call-note" id="id15">[7]</a></td>
</tr>
<tr class="row-odd"><td>J</td>
<td>JSUB</td>
<td>3B</td>
<td>Jump to subroutine</td>
<td>JSUB Cx</td>
<td>LR &lt;= PC; PC &lt;= PC + Cx</td>
</tr>
<tr class="row-even"><td>J</td>
<td>JR/RET</td>
<td>3C</td>
<td>Return from subroutine</td>
<td>JR $1 or RET LR</td>
<td>PC &lt;= LR <a class="footnote-reference" href="#jr-note" id="id16">[8]</a></td>
</tr>
<tr class="row-odd"><td>A</td>
<td>MULT</td>
<td>41</td>
<td>Multiply for 64 bits result</td>
<td>MULT Ra, Rb</td>
<td>(HI,LO) &lt;= MULT(Ra,Rb)</td>
</tr>
<tr class="row-even"><td>A</td>
<td>MULTU</td>
<td>42</td>
<td>MULT for unsigned 64 bits</td>
<td>MULTU Ra, Rb</td>
<td>(HI,LO) &lt;= MULTU(Ra,Rb)</td>
</tr>
<tr class="row-odd"><td>A</td>
<td>DIV</td>
<td>43</td>
<td>Divide</td>
<td>DIV Ra, Rb</td>
<td>HI&lt;=Ra%Rb, LO&lt;=Ra/Rb</td>
</tr>
<tr class="row-even"><td>A</td>
<td>DIVU</td>
<td>44</td>
<td>Divide unsigned</td>
<td>DIVU Ra, Rb</td>
<td>HI&lt;=Ra%Rb, LO&lt;=Ra/Rb</td>
</tr>
<tr class="row-odd"><td>A</td>
<td>MFHI</td>
<td>46</td>
<td>Move HI to GPR</td>
<td>MFHI Ra</td>
<td>Ra &lt;= HI</td>
</tr>
<tr class="row-even"><td>A</td>
<td>MFLO</td>
<td>47</td>
<td>Move LO to GPR</td>
<td>MFLO Ra</td>
<td>Ra &lt;= LO</td>
</tr>
<tr class="row-odd"><td>A</td>
<td>MTHI</td>
<td>48</td>
<td>Move GPR to HI</td>
<td>MTHI Ra</td>
<td>HI &lt;= Ra</td>
</tr>
<tr class="row-even"><td>A</td>
<td>MTLO</td>
<td>49</td>
<td>Move GPR to LO</td>
<td>MTLO Ra</td>
<td>LO &lt;= Ra</td>
</tr>
<tr class="row-odd"><td>A</td>
<td>MFC0</td>
<td>50</td>
<td>Move C0R to GPR</td>
<td>MFC0 Ra, Rb</td>
<td>Ra &lt;= Rb</td>
</tr>
<tr class="row-even"><td>A</td>
<td>MTC0</td>
<td>51</td>
<td>Move GPR to C0R</td>
<td>MTC0 Ra, Rb</td>
<td>Ra &lt;= Rb</td>
</tr>
<tr class="row-odd"><td>A</td>
<td>C0MOV</td>
<td>52</td>
<td>Move C0R to C0R</td>
<td>C0MOV Ra, Rb</td>
<td>Ra &lt;= Rb</td>
</tr>
</tbody>
</table>
<p>The following table details the cpu032II instruction set added:</p>
<table border="1" class="docutils" id="id39">
<caption><span class="caption-number">Table 5 </span><span class="caption-text">cpu032II Instruction Set</span><a class="headerlink" href="#id39" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="3%" />
<col width="11%" />
<col width="8%" />
<col width="31%" />
<col width="19%" />
<col width="28%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">F.</th>
<th class="head">Mnemonic</th>
<th class="head">Opcode</th>
<th class="head">Meaning</th>
<th class="head">Syntax</th>
<th class="head">Operation</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>L</td>
<td>SLTi</td>
<td>26</td>
<td>Set less Then</td>
<td>SLTi Ra, Rb, Cx</td>
<td>Ra &lt;= (Rb &lt; Cx)</td>
</tr>
<tr class="row-odd"><td>L</td>
<td>SLTiu</td>
<td>27</td>
<td>SLTi unsigned</td>
<td>SLTiu Ra, Rb, Cx</td>
<td>Ra &lt;= (Rb &lt; Cx)</td>
</tr>
<tr class="row-even"><td>A</td>
<td>SLT</td>
<td>28</td>
<td>Set less Then</td>
<td>SLT Ra, Rb, Rc</td>
<td>Ra &lt;= (Rb &lt; Rc)</td>
</tr>
<tr class="row-odd"><td>A</td>
<td>SLTu</td>
<td>29</td>
<td>SLT unsigned</td>
<td>SLTu Ra, Rb, Rc</td>
<td>Ra &lt;= (Rb &lt; Rc)</td>
</tr>
<tr class="row-even"><td>L</td>
<td>BEQ</td>
<td>37</td>
<td>Branch if equal</td>
<td>BEQ Ra, Rb, Cx</td>
<td>if (Ra==Rb), PC &lt;= PC + Cx</td>
</tr>
<tr class="row-odd"><td>L</td>
<td>BNE</td>
<td>38</td>
<td>Branch if not equal</td>
<td>BNE Ra, Rb, Cx</td>
<td>if (Ra!=Rb), PC &lt;= PC + Cx</td>
</tr>
<tr class="row-even"><td>J</td>
<td>BAL</td>
<td>3A</td>
<td>Branch and link</td>
<td>BAL Cx</td>
<td>LR &lt;= PC; PC &lt;= PC + Cx</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><strong>Cpu0 unsigned instructions</strong></p>
<p class="last">Like Mips, except DIVU, the mathematic unsigned instructions such as ADDu and
SUBu, are instructions of no overflow exception.
The ADDu and SUBu handle both signed and unsigned integers well.
For example, (ADDu 1, -2) is -1; (ADDu 0x01, 0xfffffffe) is 0xffffffff = (4G
- 1).
If you treat the result is negative then it is -1.
On the other hand, it&#8217;s (+4G - 1) if you treat the result is positive.</p>
</div>
<div class="section" id="why-not-using-add-instead-of-sub">
<h4><a class="toc-backref" href="#id56">Why not using ADD instead of SUB?</a><a class="headerlink" href="#why-not-using-add-instead-of-sub" title="Permalink to this headline">¶</a></h4>
<p>From text book of computer introduction, we know SUB can be replaced by
ADD as follows,</p>
<ul class="simple">
<li>(A - B) = (A + (-B))</li>
</ul>
<p>Since Mips uses 32 bits to represent int type of C language, if B is the
value of -2G, then</p>
<ul class="simple">
<li>(A - (-2G)) = (A + (2G))</li>
</ul>
<p>But the problem is value -2G can be represented in 32 bits machine while 2G
cannot,
since the range of 2&#8217;s complement representation for 32 bits is (-2G .. 2G-1).
The 2&#8217;s complement reprentation has the merit of fast computation in circuits
design, it is widely used in real CPU implementation.
That&#8217;s why almost every CPU create SUB instruction, rather than using ADD
instead of.</p>
</div>
</div>
<div class="section" id="the-status-register">
<h3><a class="toc-backref" href="#id57">The Status Register</a><a class="headerlink" href="#the-status-register" title="Permalink to this headline">¶</a></h3>
<p>The Cpu0 status word register (SW) contains the state of the Negative (N),
Zero (Z), Carry (C), Overflow (V), Debug (D), Mode (M), and Interrupt (I) flags.
The bit layout of the SW register is shown in <a class="reference internal" href="#llvmstructure-f3"><span class="std std-numref">Fig. 4</span></a>
below.</p>
<div class="figure align-center" id="id40">
<span id="llvmstructure-f3"></span><a class="reference internal image-reference" href="_images/3.png"><img alt="_images/3.png" src="_images/3.png" style="width: 684px; height: 126px;" /></a>
<p class="caption"><span class="caption-number">Fig. 4 </span><span class="caption-text">Cpu0 status word (SW) register</span></p>
</div>
<p>When a CMP Ra, Rb instruction executes, the condition flags will change.
For example:</p>
<ul class="simple">
<li>If Ra &gt; Rb, then N = 0, Z = 0</li>
<li>If Ra &lt; Rb, then N = 1, Z = 0</li>
<li>If Ra = Rb, then N = 0, Z = 1</li>
</ul>
<p>The direction (i.e. taken/not taken) of the conditional jump instructions JGT,
JLT, JGE, JLE, JEQ, JNE is determined by the N and Z flags in the SW register.</p>
</div>
<div class="section" id="cpu0-s-stages-of-instruction-execution">
<h3><a class="toc-backref" href="#id58">Cpu0&#8217;s Stages of Instruction Execution</a><a class="headerlink" href="#cpu0-s-stages-of-instruction-execution" title="Permalink to this headline">¶</a></h3>
<p>The Cpu0 architecture has a five-stage pipeline. The stages are instruction
fetch (IF), instruction decode (ID), execute (EX), memory access (MEM) and
write backe (WB).
Here is a description of what happens in the processor for each stage:</p>
<ol class="arabic simple">
<li>Instruction fetch (IF)</li>
</ol>
<ul class="simple">
<li>The Cpu0 fetches the instruction pointed to by the Program Counter (PC) into
the Instruction Register (IR): IR = [PC].</li>
<li>The PC is then updated to point to the next instruction: PC = PC + 4.</li>
</ul>
<ol class="arabic simple" start="2">
<li>Instruction decode (ID)</li>
</ol>
<ul class="simple">
<li>The control unit decodes the instruction stored in IR, which routes necessary
data stored in registers to the ALU, and sets the ALU&#8217;s operation mode based
on the current instruction&#8217;s opcode.</li>
</ul>
<ol class="arabic simple" start="3">
<li>Execute (EX)</li>
</ol>
<ul class="simple">
<li>The ALU executes the operation designated by the control unit upon data in
registers.
Except load and store instructions, the result is stored in the destination
register after the ALU is done.</li>
</ul>
<ol class="arabic simple" start="4">
<li>Memory access (MEM)</li>
</ol>
<ul class="simple">
<li>Read data from data cache to pipeline register MEM/WB if it is load
instruction; write data from register to data cache if it is strore
instruction.</li>
</ul>
<ol class="arabic simple" start="5">
<li>Write-back (WB)</li>
</ol>
<ul class="simple">
<li>Move data from pipeline register MEM/WB to Register if it is load instruction.</li>
</ul>
</div>
<div class="section" id="cpu0-s-interrupt-vector">
<h3><a class="toc-backref" href="#id59">Cpu0&#8217;s Interrupt Vector</a><a class="headerlink" href="#cpu0-s-interrupt-vector" title="Permalink to this headline">¶</a></h3>
<table border="1" class="docutils" id="id41">
<caption><span class="caption-number">Table 6 </span><span class="caption-text">Cpu0&#8217;s Interrupt Vector</span><a class="headerlink" href="#id41" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="40%" />
<col width="60%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Address</th>
<th class="head">type</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>0x00</td>
<td>Reset</td>
</tr>
<tr class="row-odd"><td>0x04</td>
<td>Error Handle</td>
</tr>
<tr class="row-even"><td>0x08</td>
<td>Interrupt</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="llvm-structure">
<h2><a class="toc-backref" href="#id60">LLVM Structure</a><a class="headerlink" href="#llvm-structure" title="Permalink to this headline">¶</a></h2>
<p>This section introduces the compiler data structure, algorithm and mechanism
that llvm uses.</p>
<div class="section" id="three-phase-design">
<h3><a class="toc-backref" href="#id61">Three-phase design</a><a class="headerlink" href="#three-phase-design" title="Permalink to this headline">¶</a></h3>
<p>The text in this and the following sub-section comes from the AOSA chapter on
LLVM written by Chris Lattner <a class="footnote-reference" href="#aosa-book" id="id17">[9]</a>.</p>
<p>The most popular design for a traditional static compiler (like most C
compilers) is the three phase design whose major components are the front end,
the optimizer and the back end, as seen in <a class="reference internal" href="#llvmstructure-f6"><span class="std std-numref">Fig. 5</span></a>.
The front end parses source code, checking it for errors, and builds a
language-specific Abstract Syntax Tree (AST) to represent the input code.
The AST is optionally converted to a new representation for optimization, and
the optimizer and back end are run on the code.</p>
<div class="figure align-center" id="id42">
<span id="llvmstructure-f6"></span><a class="reference internal image-reference" href="_images/61.png"><img alt="_images/61.png" src="_images/61.png" style="width: 329.0px; height: 44.1px;" /></a>
<p class="caption"><span class="caption-number">Fig. 5 </span><span class="caption-text">Three Major Components of a Three Phase Compiler</span></p>
</div>
<p>The optimizer is responsible for doing a broad variety of transformations to
try to improve the code&#8217;s running time, such as eliminating redundant
computations, and is usually more or less independent of language and target.
The back end (also known as the code generator) then maps the code onto the
target instruction set.
In addition to making correct code, it is responsible for generating good code
that takes advantage of unusual features of the supported architecture.
Common parts of a compiler back end include instruction selection, register
allocation, and instruction scheduling.</p>
<p>This model applies equally well to interpreters and JIT compilers.
The Java Virtual Machine (JVM) is also an implementation of this model, which
uses Java bytecode as the interface between the front end and optimizer.</p>
<p>The most important win of this classical design comes when a compiler decides
to support multiple source languages or target architectures.
If the compiler uses a common code representation in its optimizer, then a
front end can be written for any language that can compile to it, and a back
end can be written for any target that can compile from it, as shown in
<a class="reference internal" href="#llvmstructure-f7"><span class="std std-numref">Fig. 6</span></a>.</p>
<div class="figure align-center" id="id43">
<span id="llvmstructure-f7"></span><a class="reference internal image-reference" href="_images/7.png"><img alt="_images/7.png" src="_images/7.png" style="width: 585.9px; height: 209.3px;" /></a>
<p class="caption"><span class="caption-number">Fig. 6 </span><span class="caption-text">Retargetablity</span></p>
</div>
<p>With this design, porting the compiler to support a new source language (e.g.,
Algol or BASIC) requires implementing a new front end, but the existing
optimizer and back end can be reused.
If these parts weren&#8217;t separated, implementing a new source language would
require starting over from scratch, so supporting N targets and M source
languages would need N*M compilers.</p>
<p>Another advantage of the three-phase design (which follows directly from
retargetability) is that the compiler serves a broader set of programmers than
it would if it only supported one source language and one target.
For an open source project, this means that there is a larger community of
potential contributors to draw from, which naturally leads to more enhancements
and improvements to the compiler.
This is the reason why open source compilers that serve many communities (like
GCC) tend to generate better optimized machine code than narrower compilers
like FreePASCAL.
This isn&#8217;t the case for proprietary compilers, whose quality is directly
related to the project&#8217;s budget.
For example, the Intel ICC Compiler is widely known for the quality of code it
generates, even though it serves a narrow audience.</p>
<p>A final major win of the three-phase design is that the skills required to
implement a front end are different than those required for the optimizer and
back end.
Separating these makes it easier for a &#8220;front-end person&#8221; to enhance and
maintain their part of the compiler.
While this is a social issue, not a technical one, it matters a lot in
practice, particularly for open source projects that want to reduce the barrier
to contributing as much as possible.</p>
<p>The most important aspect of its design is the LLVM Intermediate Representation
(IR), which is the form it uses to represent code in the compiler.
LLVM IR is designed to host mid-level analyses and transformations that you
find in the optimizer chapter of a compiler.
It was designed with many specific goals in mind, including supporting
lightweight runtime optimizations, cross-function/interprocedural
optimizations, whole program analysis, and aggressive restructuring
transformations, etc.
The most important aspect of it, though, is that it is itself defined as a
first class language with well-defined semantics.
To make this concrete, here is a simple example of a .ll file:</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span>define i32 @add1(i32 %a, i32 %b) {
entry:
  %tmp1 = add i32 %a, %b
  ret i32 %tmp1
}
define i32 @add2(i32 %a, i32 %b) {
entry:
  %tmp1 = icmp eq i32 %a, 0
  br i1 %tmp1, label %done, label %recurse
recurse:
  %tmp2 = sub i32 %a, 1
  %tmp3 = add i32 %b, 1
  %tmp4 = call i32 @add2(i32 %tmp2, i32 %tmp3)
  ret i32 %tmp4
done:
  ret i32 %b
}
// This LLVM IR corresponds to this C code, which provides two different ways to
//  add integers:
unsigned add1(unsigned a, unsigned b) {
  return a+b;
}
// Perhaps not the most efficient way to add two numbers.
unsigned add2(unsigned a, unsigned b) {
  if (a == 0) return b;
  return add2(a-1, b+1);
}
</pre></div>
</div>
<p>As you can see from this example, LLVM IR is a low-level RISC-like virtual
instruction set.
Like a real RISC instruction set, it supports linear sequences of simple
instructions like add, subtract, compare, and branch.
These instructions are in three address form, which means that they take some
number of inputs and produce a result in a different register.
LLVM IR supports labels and generally looks like a weird form of assembly
language.</p>
<p>Unlike most RISC instruction sets, LLVM is strongly typed with a simple type
system (e.g., i32 is a 32-bit integer, i32** is a pointer to pointer to 32-bit
integer) and some details of the machine are abstracted away.
For example, the calling convention is abstracted through call and ret
instructions and explicit arguments.
Another significant difference from machine code is that the LLVM IR doesn&#8217;t
use a fixed set of named registers, it uses an infinite set of temporaries
named with a % character.</p>
<p>Beyond being implemented as a language, LLVM IR is actually defined in three
isomorphic forms: the textual format above, an in-memory data structure
inspected and modified by optimizations themselves, and an efficient and dense
on-disk binary &#8220;bitcode&#8221; format.
The LLVM Project also provides tools to convert the on-disk format from text to
binary: llvm-as assembles the textual .ll file into a .bc file containing the
bitcode goop and llvm-dis turns a .bc file into a .ll file.</p>
<p>The intermediate representation of a compiler is interesting because it can be
a &#8220;perfect world&#8221; for the compiler optimizer: unlike the front end and back end
of the compiler, the optimizer isn&#8217;t constrained by either a specific source
language or a specific target machine.
On the other hand, it has to serve both well: it has to be designed to be easy
for a front end to generate and be expressive enough to allow important
optimizations to be performed for real targets.</p>
</div>
<div class="section" id="llvm-s-target-description-files-td">
<h3><a class="toc-backref" href="#id62">LLVM&#8217;s Target Description Files: .td</a><a class="headerlink" href="#llvm-s-target-description-files-td" title="Permalink to this headline">¶</a></h3>
<p>The &#8220;mix and match&#8221; approach allows target authors to choose what makes sense
for their architecture and permits a large amount of code reuse across
different targets.
This brings up another challenge: each shared component needs to be able to
reason about target specific properties in a generic way.
For example, a shared register allocator needs to know the register file of
each target and the constraints that exist between instructions and their
register operands.
LLVM&#8217;s solution to this is for each target to provide a target description
in a declarative domain-specific language (a set of .td files) processed by the
tblgen tool.
The (simplified) build process for the x86 target is shown in
<a class="reference internal" href="#llvmstructure-f8"><span class="std std-numref">Fig. 7</span></a>.</p>
<div class="figure align-center" id="id44">
<span id="llvmstructure-f8"></span><a class="reference internal image-reference" href="_images/8.png"><img alt="_images/8.png" src="_images/8.png" style="width: 595.0px; height: 299.6px;" /></a>
<p class="caption"><span class="caption-number">Fig. 7 </span><span class="caption-text">Simplified x86 Target Definition</span></p>
</div>
<p>The different subsystems supported by the .td files allow target authors to
build up the different pieces of their target.
For example, the x86 back end defines a register class that holds all of its
32-bit registers named &#8220;GR32&#8221; (in the .td files, target specific definitions
are all caps) like this:</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="n">def</span> <span class="nl">GR32</span> <span class="p">:</span> <span class="n">RegisterClass</span><span class="o">&lt;</span><span class="p">[</span><span class="n">i32</span><span class="p">],</span> <span class="mi">32</span><span class="p">,</span>
  <span class="p">[</span><span class="n">EAX</span><span class="p">,</span> <span class="n">ECX</span><span class="p">,</span> <span class="n">EDX</span><span class="p">,</span> <span class="n">ESI</span><span class="p">,</span> <span class="n">EDI</span><span class="p">,</span> <span class="n">EBX</span><span class="p">,</span> <span class="n">EBP</span><span class="p">,</span> <span class="n">ESP</span><span class="p">,</span>
   <span class="n">R8D</span><span class="p">,</span> <span class="n">R9D</span><span class="p">,</span> <span class="n">R10D</span><span class="p">,</span> <span class="n">R11D</span><span class="p">,</span> <span class="n">R14D</span><span class="p">,</span> <span class="n">R15D</span><span class="p">,</span> <span class="n">R12D</span><span class="p">,</span> <span class="n">R13D</span><span class="p">]</span><span class="o">&gt;</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="llvm-code-generation-sequence">
<h3><a class="toc-backref" href="#id63">LLVM Code Generation Sequence</a><a class="headerlink" href="#llvm-code-generation-sequence" title="Permalink to this headline">¶</a></h3>
<p>Following diagram come from tricore_llvm.pdf.</p>
<div class="figure align-center" id="id45">
<span id="llvmstructure-f9"></span><a class="reference internal image-reference" href="_images/9.png"><img alt="_images/9.png" src="_images/9.png" style="width: 1030px; height: 537px;" /></a>
<p class="caption"><span class="caption-number">Fig. 8 </span><span class="caption-text">tricore_llvm.pdf: Code generation sequence. On the path from LLVM code to
assembly code, numerous passes are run through and several data structures
are used to represent the intermediate results.</span></p>
</div>
<p>LLVM is a Static Single Assignment (SSA) based representation.
LLVM provides an infinite virtual registers which can hold values of primitive
type (integral, floating point, or pointer values).
So, every operand can save in different virtual register in llvm SSA
representation.
Comment is “;” in llvm representation.
Following is the llvm SSA instructions.</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="n">store</span> <span class="n">i32</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">a</span>  <span class="p">;</span> <span class="n">store</span> <span class="n">i32</span> <span class="n">type</span> <span class="n">of</span> <span class="mi">0</span> <span class="n">to</span> <span class="k">virtual</span> <span class="k">register</span> <span class="o">%</span><span class="n">a</span><span class="p">,</span> <span class="o">%</span><span class="n">a</span> <span class="n">is</span>
            <span class="p">;</span>  <span class="n">pointer</span> <span class="n">type</span> <span class="n">which</span> <span class="n">point</span> <span class="n">to</span> <span class="n">i32</span> <span class="n">value</span>
<span class="n">store</span> <span class="n">i32</span> <span class="o">%</span><span class="n">b</span><span class="p">,</span> <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">c</span> <span class="p">;</span> <span class="n">store</span> <span class="o">%</span><span class="n">b</span> <span class="n">contents</span> <span class="n">to</span> <span class="o">%</span><span class="n">c</span> <span class="n">point</span> <span class="n">to</span><span class="p">,</span> <span class="o">%</span><span class="n">b</span> <span class="n">isi32</span> <span class="n">type</span> <span class="k">virtual</span>
            <span class="p">;</span>  <span class="k">register</span><span class="p">,</span> <span class="o">%</span><span class="n">c</span> <span class="n">is</span> <span class="n">pointer</span> <span class="n">type</span> <span class="n">which</span> <span class="n">point</span> <span class="n">to</span> <span class="n">i32</span> <span class="n">value</span><span class="p">.</span>
<span class="o">%</span><span class="n">a1</span> <span class="o">=</span> <span class="n">load</span> <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">a</span>    <span class="p">;</span> <span class="n">load</span> <span class="n">the</span> <span class="n">memory</span> <span class="n">value</span> <span class="n">where</span> <span class="o">%</span><span class="n">a</span> <span class="n">point</span> <span class="n">to</span> <span class="n">and</span> <span class="n">assign</span> <span class="n">the</span>
            <span class="p">;</span>  <span class="n">memory</span> <span class="n">value</span> <span class="n">to</span> <span class="o">%</span><span class="n">a1</span>
<span class="o">%</span><span class="n">a3</span> <span class="o">=</span> <span class="n">add</span> <span class="n">i32</span> <span class="o">%</span><span class="n">a2</span><span class="p">,</span> <span class="mi">1</span>  <span class="p">;</span> <span class="n">add</span> <span class="o">%</span><span class="n">a2</span> <span class="n">and</span> <span class="mi">1</span> <span class="n">and</span> <span class="n">save</span> <span class="n">to</span> <span class="o">%</span><span class="n">a3</span>
</pre></div>
</div>
<p>We explain the code generation process as below.
If you don&#8217;t feel comfortable, please check tricore_llvm.pdf section 4.2 first.
You can read “The LLVM Target-Independent Code Generator” from here <a class="footnote-reference" href="#codegen" id="id18">[11]</a>
and “LLVM Language Reference Manual” from here <a class="footnote-reference" href="#langref" id="id19">[12]</a>
before go ahead, but we think the section
4.2 of tricore_llvm.pdf is enough and suggesting you read the web site
documents as above only when you are still not
quite understand, even if you have read the articles of this section and
next 2 sections for DAG and Instruction Selection.</p>
<ol class="arabic simple">
<li>Instruction Selection</li>
</ol>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="c1">// In this stage, transfer the llvm opcode into machine opcode, but the operand</span>
<span class="c1">//  still is llvm virtual operand.</span>
    <span class="n">store</span> <span class="n">i16</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i16</span><span class="o">*</span> <span class="o">%</span><span class="n">a</span> <span class="c1">// store 0 of i16 type to where virtual register %a</span>
                         <span class="c1">//  point to.</span>
<span class="o">=&gt;</span>  <span class="n">st</span> <span class="n">i16</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">a</span>    <span class="c1">// Use Cpu0 backend instruction st instead of IR store.</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li>Scheduling and Formation</li>
</ol>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="c1">// In this stage, reorder the instructions sequence for optimization in</span>
<span class="c1">//  instructions cycle or in register pressure.</span>
    <span class="n">st</span> <span class="n">i32</span> <span class="o">%</span><span class="n">a</span><span class="p">,</span> <span class="n">i16</span><span class="o">*</span> <span class="o">%</span><span class="n">b</span><span class="p">,</span>  <span class="n">i16</span> <span class="mi">5</span> <span class="c1">// st %a to *(%b+5)</span>
    <span class="n">st</span> <span class="o">%</span><span class="n">b</span><span class="p">,</span> <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">c</span><span class="p">,</span> <span class="n">i16</span> <span class="mi">0</span>
    <span class="o">%</span><span class="n">d</span> <span class="o">=</span> <span class="n">ld</span> <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">c</span>

<span class="c1">// Transfer above instructions order as follows. In RISC CPU of Mips, the ld</span>
<span class="c1">//  %c uses the result of the previous instruction st %c. So it must waits 1</span>
<span class="c1">//  cycle. Meaning the ld cannot follow st immediately.</span>
<span class="o">=&gt;</span>  <span class="n">st</span> <span class="o">%</span><span class="n">b</span><span class="p">,</span> <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">c</span><span class="p">,</span> <span class="n">i16</span> <span class="mi">0</span>
    <span class="n">st</span> <span class="n">i32</span> <span class="o">%</span><span class="n">a</span><span class="p">,</span> <span class="n">i16</span><span class="o">*</span> <span class="o">%</span><span class="n">b</span><span class="p">,</span>  <span class="n">i16</span> <span class="mi">5</span>
    <span class="o">%</span><span class="n">d</span> <span class="o">=</span> <span class="n">ld</span> <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">c</span><span class="p">,</span> <span class="n">i16</span> <span class="mi">0</span>
<span class="c1">// If without reorder instructions, a instruction nop which do nothing must be</span>
<span class="c1">//  filled, contribute one instruction cycle more than optimization. (Actually,</span>
<span class="c1">//  Mips is scheduled with hardware dynamically and will insert nop between st</span>
<span class="c1">//  and ld instructions if compiler didn&#39;t insert nop.)</span>
    <span class="n">st</span> <span class="n">i32</span> <span class="o">%</span><span class="n">a</span><span class="p">,</span> <span class="n">i16</span><span class="o">*</span> <span class="o">%</span><span class="n">b</span><span class="p">,</span>  <span class="n">i16</span> <span class="mi">5</span>
    <span class="n">st</span> <span class="o">%</span><span class="n">b</span><span class="p">,</span> <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">c</span><span class="p">,</span> <span class="n">i16</span> <span class="mi">0</span>
    <span class="n">nop</span>
    <span class="o">%</span><span class="n">d</span> <span class="o">=</span> <span class="n">ld</span> <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">c</span><span class="p">,</span> <span class="n">i16</span> <span class="mi">0</span>

<span class="c1">// Minimum register pressure</span>
<span class="c1">//  Suppose %c is alive after the instructions basic block (meaning %c will be</span>
<span class="c1">//  used after the basic block), %a and %b are not alive after that.</span>
<span class="c1">// The following no-reorder-version need 3 registers at least</span>
    <span class="o">%</span><span class="n">a</span> <span class="o">=</span> <span class="n">add</span> <span class="n">i32</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i32</span> <span class="mi">0</span>
    <span class="o">%</span><span class="n">b</span> <span class="o">=</span> <span class="n">add</span> <span class="n">i32</span> <span class="mi">2</span><span class="p">,</span> <span class="n">i32</span> <span class="mi">0</span>
    <span class="n">st</span> <span class="o">%</span><span class="n">a</span><span class="p">,</span>  <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">c</span><span class="p">,</span> <span class="mi">1</span>
    <span class="n">st</span> <span class="o">%</span><span class="n">b</span><span class="p">,</span>  <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">c</span><span class="p">,</span> <span class="mi">2</span>

<span class="c1">// The reorder version needs 2 registers only (by allocate %a and %b in the same</span>
<span class="c1">//  register)</span>
<span class="o">=&gt;</span> <span class="o">%</span><span class="n">a</span> <span class="o">=</span> <span class="n">add</span> <span class="n">i32</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i32</span> <span class="mi">0</span>
    <span class="n">st</span> <span class="o">%</span><span class="n">a</span><span class="p">,</span>  <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">c</span><span class="p">,</span> <span class="mi">1</span>
    <span class="o">%</span><span class="n">b</span> <span class="o">=</span> <span class="n">add</span> <span class="n">i32</span> <span class="mi">2</span><span class="p">,</span> <span class="n">i32</span> <span class="mi">0</span>
    <span class="n">st</span> <span class="o">%</span><span class="n">b</span><span class="p">,</span>  <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">c</span><span class="p">,</span> <span class="mi">2</span>
</pre></div>
</div>
<ol class="arabic" start="3">
<li><p class="first">SSA-based Machine Code Optimization</p>
<p>For example, common expression remove, shown in next section DAG.</p>
</li>
<li><p class="first">Register Allocation</p>
<p>Allocate real register for virtual register.</p>
</li>
<li><p class="first">Prologue/Epilogue Code Insertion</p>
<p>Explain in section Add Prologue/Epilogue functions</p>
</li>
<li><p class="first">Late Machine Code Optimizations</p>
<p>Any “last-minute” peephole optimizations of the final machine code can be
applied during this phase.
For example, replace x = x * 2 by x = x &lt; 1 for integer operand.</p>
</li>
<li><p class="first">Code Emission</p>
<p>Finally, the completed machine code is emitted. For static compilation,
the end result is an assembly code file; for JIT compilation, the opcodes
of the machine instructions are written into memory.</p>
</li>
</ol>
<p>The llvm code generation sequence also can be obtained by
<code class="docutils literal"><span class="pre">llc</span> <span class="pre">-debug-pass=Structure</span></code> as the following. The first 4 code generation
sequences from <a class="reference internal" href="#llvmstructure-f9"><span class="std std-numref">Fig. 8</span></a> are in the
<strong>&#8216;DAG-&gt;DAG Pattern Instruction Selection&#8217;</strong> of the <code class="docutils literal"><span class="pre">llc</span> <span class="pre">-debug-pass=Structure</span></code>
displayed. The order of Peephole Optimizations and Prologue/Epilogue Insertion
is inconsistent between <a class="reference internal" href="#llvmstructure-f9"><span class="std std-numref">Fig. 8</span></a> and
<code class="docutils literal"><span class="pre">llc</span> <span class="pre">-debug-pass=Structure</span></code> (please check the * in the following).
No need to be bothered with this since the the LLVM is under development and
changed from time to time.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>118-165-79-200:input Jonathan$ llc --help-hidden
OVERVIEW: llvm system compiler

USAGE: llc <span class="o">[</span>options<span class="o">]</span> &lt;input bitcode&gt;

OPTIONS:
...
  -debug-pass                             - Print PassManager debugging <span class="nv">information</span>
    <span class="o">=</span>None                                 -   disable debug <span class="nv">output</span>
    <span class="o">=</span>Arguments                            -   print pass arguments to pass to <span class="s1">&#39;opt&#39;</span>
    <span class="o">=</span>Structure                            -   print pass structure before run<span class="o">()</span>
    <span class="o">=</span>Executions                           -   print pass name before it is <span class="nv">executed</span>
    <span class="o">=</span>Details                              -   print pass details when it is executed

118-165-79-200:input Jonathan$ llc -march<span class="o">=</span>mips -debug-pass<span class="o">=</span>Structure ch3.bc
...
Target Library Information
Target Transform Info
Data Layout
Target Pass Configuration
No Alias Analysis <span class="o">(</span>always returns <span class="s1">&#39;may&#39;</span> <span class="nb">alias</span><span class="o">)</span>
Type-Based Alias Analysis
Basic Alias Analysis <span class="o">(</span>stateless AA impl<span class="o">)</span>
Create Garbage Collector Module Metadata
Machine Module Information
Machine Branch Probability Analysis
  ModulePass Manager
    FunctionPass Manager
      Preliminary module verification
      Dominator Tree Construction
      Module Verifier
      Natural Loop Information
      Loop Pass Manager
        Canonicalize natural loops
      Scalar Evolution Analysis
      Loop Pass Manager
        Canonicalize natural loops
        Induction Variable Users
        Loop Strength Reduction
      Lower Garbage Collection Instructions
      Remove unreachable blocks from the CFG
      Exception handling preparation
      Optimize <span class="k">for</span> code generation
      Insert stack protectors
      Preliminary module verification
      Dominator Tree Construction
      Module Verifier
      Machine Function Analysis
      Natural Loop Information
      Branch Probability Analysis
    * MIPS DAG-&gt;DAG Pattern Instruction Selection
      Expand ISel Pseudo-instructions
      Tail Duplication
      Optimize machine instruction PHIs
      MachineDominator Tree Construction
      Slot index numbering
      Merge disjoint stack slots
      Local Stack Slot Allocation
      Remove dead machine instructions
      MachineDominator Tree Construction
      Machine Natural Loop Construction
      Machine Loop Invariant Code Motion
      Machine Common Subexpression Elimination
      Machine code sinking
    * Peephole Optimizations
      Process Implicit Definitions
      Remove unreachable machine basic blocks
      Live Variable Analysis
      Eliminate PHI nodes <span class="k">for</span> register allocation
      Two-Address instruction pass
      Slot index numbering
      Live Interval Analysis
      Debug Variable Analysis
      Simple Register Coalescing
      Live Stack Slot Analysis
      Calculate spill weights
      Virtual Register Map
      Live Register Matrix
      Bundle Machine CFG Edges
      Spill Code Placement Analysis
    * Greedy Register Allocator
      Virtual Register Rewriter
      Stack Slot Coloring
      Machine Loop Invariant Code Motion
    * Prologue/Epilogue Insertion <span class="p">&amp;</span> Frame Finalization
      Control Flow Optimizer
      Tail Duplication
      Machine Copy Propagation Pass
    * Post-RA pseudo instruction expansion pass
      MachineDominator Tree Construction
      Machine Natural Loop Construction
      Post RA top-down list latency scheduler
      Analyze Machine Code For Garbage Collection
      Machine Block Frequency Analysis
      Branch Probability Basic Block Placement
      Mips Delay Slot Filler
      Mips Long Branch
      MachineDominator Tree Construction
      Machine Natural Loop Construction
    * Mips Assembly Printer
      Delete Garbage Collector Information
</pre></div>
</div>
</div>
<div class="section" id="ssa-form">
<h3><a class="toc-backref" href="#id64">SSA form</a><a class="headerlink" href="#ssa-form" title="Permalink to this headline">¶</a></h3>
<p>SSA form says that each variable is assigned exactly once.
LLVM IR is SSA form which has unbounded virtual registers (each variable is
assigned exactly once and is keeped in different virtual register).
As the result, the optimization steps used in code generation sequence which
include stages of <strong>Instruction Selection</strong>, <strong>Scheduling and Formation</strong> and
<strong>Register Allocation</strong>, won&#8217;t loss any optimization opportunity.
For example, if using limited virtual registers to generate the following code,</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span>  <span class="o">%</span><span class="n">a</span> <span class="o">=</span> <span class="n">add</span> <span class="n">nsw</span> <span class="n">i32</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i32</span> <span class="mi">0</span>
  <span class="n">store</span> <span class="n">i32</span> <span class="o">%</span><span class="n">a</span><span class="p">,</span> <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">c</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
  <span class="o">%</span><span class="n">a</span> <span class="o">=</span> <span class="n">add</span> <span class="n">nsw</span> <span class="n">i32</span> <span class="mi">2</span><span class="p">,</span> <span class="n">i32</span> <span class="mi">0</span>
  <span class="n">store</span> <span class="n">i32</span> <span class="o">%</span><span class="n">a</span><span class="p">,</span> <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">c</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>

<span class="o">=&gt;</span> <span class="o">%</span><span class="n">a</span> <span class="o">=</span> <span class="n">add</span> <span class="n">i32</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i32</span> <span class="mi">0</span>
    <span class="n">st</span> <span class="o">%</span><span class="n">a</span><span class="p">,</span>  <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">c</span><span class="p">,</span> <span class="mi">1</span>
    <span class="o">%</span><span class="n">a</span> <span class="o">=</span> <span class="n">add</span> <span class="n">i32</span> <span class="mi">2</span><span class="p">,</span> <span class="n">i32</span> <span class="mi">0</span>
    <span class="n">st</span> <span class="o">%</span><span class="n">a</span><span class="p">,</span>  <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">c</span><span class="p">,</span> <span class="mi">2</span>
</pre></div>
</div>
<p>Above code have to run in sequence. On the other hand, the SSA form as the
following can be reodered and run in parallel with the following different
version <a class="footnote-reference" href="#dragonbooks-10-2-3" id="id20">[13]</a>.</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span>  <span class="o">%</span><span class="n">a</span> <span class="o">=</span> <span class="n">add</span> <span class="n">nsw</span> <span class="n">i32</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i32</span> <span class="mi">0</span>
  <span class="n">store</span> <span class="n">i32</span> <span class="o">%</span><span class="n">a</span><span class="p">,</span> <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">c</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>
  <span class="o">%</span><span class="n">b</span> <span class="o">=</span> <span class="n">add</span> <span class="n">nsw</span> <span class="n">i32</span> <span class="mi">2</span><span class="p">,</span> <span class="n">i32</span> <span class="mi">0</span>
  <span class="n">store</span> <span class="n">i32</span> <span class="o">%</span><span class="n">b</span><span class="p">,</span> <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">d</span><span class="p">,</span> <span class="n">align</span> <span class="mi">4</span>

<span class="c1">// version 1</span>
<span class="o">=&gt;</span> <span class="o">%</span><span class="n">a</span> <span class="o">=</span> <span class="n">add</span> <span class="n">i32</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i32</span> <span class="mi">0</span>
    <span class="n">st</span> <span class="o">%</span><span class="n">a</span><span class="p">,</span>  <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">c</span><span class="p">,</span> <span class="mi">0</span>
    <span class="o">%</span><span class="n">b</span> <span class="o">=</span> <span class="n">add</span> <span class="n">i32</span> <span class="mi">2</span><span class="p">,</span> <span class="n">i32</span> <span class="mi">0</span>
    <span class="n">st</span> <span class="o">%</span><span class="n">b</span><span class="p">,</span>  <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">d</span><span class="p">,</span> <span class="mi">0</span>

<span class="c1">// version 2</span>
<span class="o">=&gt;</span> <span class="o">%</span><span class="n">a</span> <span class="o">=</span> <span class="n">add</span> <span class="n">i32</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i32</span> <span class="mi">0</span>
    <span class="o">%</span><span class="n">b</span> <span class="o">=</span> <span class="n">add</span> <span class="n">i32</span> <span class="mi">2</span><span class="p">,</span> <span class="n">i32</span> <span class="mi">0</span>
    <span class="n">st</span> <span class="o">%</span><span class="n">a</span><span class="p">,</span>  <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">c</span><span class="p">,</span> <span class="mi">0</span>
    <span class="n">st</span> <span class="o">%</span><span class="n">b</span><span class="p">,</span>  <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">d</span><span class="p">,</span> <span class="mi">0</span>

<span class="c1">// version 3</span>
<span class="o">=&gt;</span> <span class="o">%</span><span class="n">b</span> <span class="o">=</span> <span class="n">add</span> <span class="n">i32</span> <span class="mi">2</span><span class="p">,</span> <span class="n">i32</span> <span class="mi">0</span>
    <span class="n">st</span> <span class="o">%</span><span class="n">b</span><span class="p">,</span>  <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">d</span><span class="p">,</span> <span class="mi">0</span>
    <span class="o">%</span><span class="n">a</span> <span class="o">=</span> <span class="n">add</span> <span class="n">i32</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i32</span> <span class="mi">0</span>
    <span class="n">st</span> <span class="o">%</span><span class="n">a</span><span class="p">,</span>  <span class="n">i32</span><span class="o">*</span> <span class="o">%</span><span class="n">c</span><span class="p">,</span> <span class="mi">0</span>
</pre></div>
</div>
</div>
<div class="section" id="dag-directed-acyclic-graph">
<h3><a class="toc-backref" href="#id65">DAG (Directed Acyclic Graph)</a><a class="headerlink" href="#dag-directed-acyclic-graph" title="Permalink to this headline">¶</a></h3>
<p>Many important techniques for local optimization begin by transforming a basic
block into DAG <a class="footnote-reference" href="#dragonbooks-8-5" id="id21">[14]</a>.
For example, the basic block code and it&#8217;s corresponding DAG as
<a class="reference internal" href="#llvmstructure-f10"><span class="std std-numref">Fig. 9</span></a>.</p>
<div class="figure align-center" id="id46">
<span id="llvmstructure-f10"></span><a class="reference internal image-reference" href="_images/103.png"><img alt="_images/103.png" src="_images/103.png" style="width: 379.2px; height: 142.4px;" /></a>
<p class="caption"><span class="caption-number">Fig. 9 </span><span class="caption-text">DAG example</span></p>
</div>
<p>If b is not live on exit from the block, then we can do &#8220;common expression
remove&#8221; as the following table.</p>
<table border="1" class="docutils" id="id47">
<caption><span class="caption-number">Table 7 </span><span class="caption-text">common expression remove process</span><a class="headerlink" href="#id47" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="35%" />
<col width="65%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Replace node b with node d</th>
<th class="head">Replace b<sub>0</sub>, c<sub>0</sub>, d<sub>0</sub> with b, c, d</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>a = b<sub>0</sub> + c<sub>0</sub></td>
<td>a = b + c</td>
</tr>
<tr class="row-odd"><td>d = a – d<sub>0</sub></td>
<td>d = a – d</td>
</tr>
<tr class="row-even"><td>c = d + c</td>
<td>c = d + c</td>
</tr>
</tbody>
</table>
<p>After removing b and traversing the DAGs from bottom to top (traverse binary
tree by Depth-first In-order search) , the first column of above table to get.</p>
<p>As you can imagine, the &#8220;common expression remove&#8221; can apply both in IR or
machine code.</p>
<p>DAG likes a tree which opcode is the node and operand (register and
const/immediate/offset) is leaf.
It can also be represented by list as prefix order in tree.
For example, (+ b, c), (+ b, 1) is IR DAG representation.</p>
<p>In addition to DAG optimization, the &#8220;kill&#8221; register has also mentioned in
section 8.5.5 of the compiler book <a class="footnote-reference" href="#dragonbooks-8-5" id="id22">[14]</a>. This concept also
used in llvm implementation.</p>
</div>
<div class="section" id="instruction-selection">
<h3><a class="toc-backref" href="#id66">Instruction Selection</a><a class="headerlink" href="#instruction-selection" title="Permalink to this headline">¶</a></h3>
<p>The major function of backend is translating IR code into machine code at
stage of Instruction Selection as <a class="reference internal" href="#llvmstructure-f11"><span class="std std-numref">Fig. 10</span></a>.</p>
<div class="figure align-center" id="id48">
<span id="llvmstructure-f11"></span><a class="reference internal image-reference" href="_images/112.png"><img alt="_images/112.png" src="_images/112.png" style="width: 346.5px; height: 81.2px;" /></a>
<p class="caption"><span class="caption-number">Fig. 10 </span><span class="caption-text">IR and it&#8217;s corresponding machine instruction</span></p>
</div>
<p>For machine instruction selection, the best solution is representing IR and
machine instruction by DAG.
To simplify in view, the register leaf is skipped in
<a class="reference internal" href="#llvmstructure-f12"><span class="std std-numref">Fig. 11</span></a>.
The r<sub>j</sub> + r<sub>k</sub> is IR DAG representation (for symbol
notation, not llvm SSA form).
ADD is machine instruction.</p>
<div class="figure align-center" id="id49">
<span id="llvmstructure-f12"></span><a class="reference internal image-reference" href="_images/122.png"><img alt="_images/122.png" src="_images/122.png" style="width: 690.2px; height: 426.3px;" /></a>
<p class="caption"><span class="caption-number">Fig. 11 </span><span class="caption-text">Instruction DAG representation</span></p>
</div>
<p>The IR DAG and machine instruction DAG can also represented as list.
For example, (+ r<sub>i</sub>, r<sub>j</sub>j) and (- r<sub>i</sub>, 1) are
lists for IR DAG; (ADD r<sub>i</sub>, r<sub>j</sub>) and
(SUBI r<sub>i</sub>, 1) are lists for machine instruction DAG.</p>
<p>Now, let&#8217;s check the ADDiu instruction defined in Cpu0InstrInfo.td as follows,</p>
<p class="rubric">lbdex/chapters/Chapter2/Cpu0InstrFormats.td</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span> <span class="n">Format</span> <span class="n">L</span> <span class="n">instruction</span> <span class="k">class</span> <span class="nc">in</span> <span class="n">Cpu0</span> <span class="p">:</span> <span class="o">&lt;|</span><span class="n">opcode</span><span class="o">|</span><span class="n">ra</span><span class="o">|</span><span class="n">rb</span><span class="o">|</span><span class="n">cx</span><span class="o">|&gt;</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="k">class</span> <span class="nc">FL</span><span class="o">&lt;</span><span class="n">bits</span><span class="o">&lt;</span><span class="mi">8</span><span class="o">&gt;</span> <span class="n">op</span><span class="p">,</span> <span class="n">dag</span> <span class="n">outs</span><span class="p">,</span> <span class="n">dag</span> <span class="n">ins</span><span class="p">,</span> <span class="n">string</span> <span class="n">asmstr</span><span class="p">,</span> <span class="nb">list</span><span class="o">&lt;</span><span class="n">dag</span><span class="o">&gt;</span> <span class="n">pattern</span><span class="p">,</span>
         <span class="n">InstrItinClass</span> <span class="n">itin</span><span class="o">&gt;</span><span class="p">:</span> <span class="n">Cpu0Inst</span><span class="o">&lt;</span><span class="n">outs</span><span class="p">,</span> <span class="n">ins</span><span class="p">,</span> <span class="n">asmstr</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">itin</span><span class="p">,</span> <span class="n">FrmL</span><span class="o">&gt;</span>
<span class="p">{</span>
  <span class="n">bits</span><span class="o">&lt;</span><span class="mi">4</span><span class="o">&gt;</span>  <span class="n">ra</span><span class="p">;</span>
  <span class="n">bits</span><span class="o">&lt;</span><span class="mi">4</span><span class="o">&gt;</span>  <span class="n">rb</span><span class="p">;</span>
  <span class="n">bits</span><span class="o">&lt;</span><span class="mi">16</span><span class="o">&gt;</span> <span class="n">imm16</span><span class="p">;</span>

  <span class="n">let</span> <span class="n">Opcode</span> <span class="o">=</span> <span class="n">op</span><span class="p">;</span>

  <span class="n">let</span> <span class="n">Inst</span><span class="p">{</span><span class="mi">23</span><span class="o">-</span><span class="mi">20</span><span class="p">}</span> <span class="o">=</span> <span class="n">ra</span><span class="p">;</span>
  <span class="n">let</span> <span class="n">Inst</span><span class="p">{</span><span class="mi">19</span><span class="o">-</span><span class="mi">16</span><span class="p">}</span> <span class="o">=</span> <span class="n">rb</span><span class="p">;</span>
  <span class="n">let</span> <span class="n">Inst</span><span class="p">{</span><span class="mi">15</span><span class="o">-</span><span class="mi">0</span><span class="p">}</span>  <span class="o">=</span> <span class="n">imm16</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter2/Cpu0InstrInfo.td</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Node</span> <span class="n">immediate</span> <span class="n">fits</span> <span class="k">as</span> <span class="mi">16</span><span class="o">-</span><span class="n">bit</span> <span class="n">sign</span> <span class="n">extended</span> <span class="n">on</span> <span class="n">target</span> <span class="n">immediate</span><span class="o">.</span>
<span class="o">//</span> <span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="o">.</span> <span class="n">addi</span><span class="p">,</span> <span class="n">andi</span>
<span class="k">def</span> <span class="nf">immSExt16</span>  <span class="p">:</span> <span class="n">PatLeaf</span><span class="o">&lt;</span><span class="p">(</span><span class="n">imm</span><span class="p">),</span> <span class="p">[{</span> <span class="k">return</span> <span class="n">isInt</span><span class="o">&lt;</span><span class="mi">16</span><span class="o">&gt;</span><span class="p">(</span><span class="n">N</span><span class="o">-&gt;</span><span class="n">getSExtValue</span><span class="p">());</span> <span class="p">}]</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span>// Arithmetic and logical instructions with 2 register operands.
class ArithLogicI&lt;bits&lt;8&gt; op, string instr_asm, SDNode OpNode,
                  Operand Od, PatLeaf imm_type, RegisterClass RC&gt; :
  FL&lt;op, (outs GPROut:$ra), (ins RC:$rb, Od:$imm16),
     !strconcat(instr_asm, &quot;\t$ra, $rb, $imm16&quot;),
     [(set GPROut:$ra, (OpNode RC:$rb, imm_type:$imm16))], IIAlu&gt; {
  let isReMaterializable = 1;
}
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">IR</span> <span class="s2">&quot;add&quot;</span> <span class="n">defined</span> <span class="ow">in</span> <span class="n">include</span><span class="o">/</span><span class="n">llvm</span><span class="o">/</span><span class="n">Target</span><span class="o">/</span><span class="n">TargetSelectionDAG</span><span class="o">.</span><span class="n">td</span><span class="p">,</span> <span class="n">line</span> <span class="mi">315</span> <span class="p">(</span><span class="k">def</span> <span class="nf">add</span><span class="p">)</span><span class="o">.</span>
<span class="k">def</span> <span class="nf">ADDiu</span>   <span class="p">:</span> <span class="n">ArithLogicI</span><span class="o">&lt;</span><span class="mh">0x09</span><span class="p">,</span> <span class="s2">&quot;addiu&quot;</span><span class="p">,</span> <span class="n">add</span><span class="p">,</span> <span class="n">simm16</span><span class="p">,</span> <span class="n">immSExt16</span><span class="p">,</span> <span class="n">CPURegs</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<p><a class="reference internal" href="#llvmstructure-f13"><span class="std std-numref">Fig. 12</span></a> shows how the pattern match work in the IR
node <strong>add</strong> and instruction <strong>ADDiu</strong> both defined in Cpu0InstrInfo.td. In
this example, IR node &#8220;add %a, 5&#8221; will be translated to &#8220;addiu $r1, 5&#8221; after %a
is allcated to register $r1 in regiter allocation stage since the IR
pattern[(set RC:$ra, (OpNode RC:$rb, imm_type:$imm16))] is set in ADDiu and the
2nd operand is signed immediate which matched &#8220;%a, 5&#8221;. In addition to pattern
match, the .td also set assembly string &#8220;addiu&#8221; and op code 0x09.
With this information, the LLVM TableGen will generate instruction both in
assembly and binary automatically (the binary instruction issued in obj file of
ELF format which will be explained at later chapter).
Similarly, the machine instruction DAG nodes LD and ST can be translated from IR
DAG nodes <strong>load</strong> and <strong>store</strong>. Notice that the $r1 in this case is virtual
register name (not machine register).</p>
<div class="figure align-center" id="id50">
<span id="llvmstructure-f13"></span><a class="reference internal image-reference" href="_images/132.png"><img alt="_images/132.png" src="_images/132.png" style="width: 562.8px; height: 411.6px;" /></a>
<p class="caption"><span class="caption-number">Fig. 12 </span><span class="caption-text">Pattern match for ADDiu instruction and IR node add</span></p>
</div>
<p>From DAG instruction selection we mentioned, the leaf node must be a Data Node.
ADDiu is format L type which the last operand must fits in 16 bits range.
So, Cpu0InstrInfo.td define a PatLeaf type of immSExt16 to let llvm system know
the PatLeaf range. If the imm16 value is out of this range,
<strong>&#8220;isInt&lt;16&gt;(N-&gt;getSExtValue())&#8221;</strong> will return false and this pattern won&#8217;t use
ADDiu in instruction selection stage.</p>
<p>Some cpu/fpu (floating point processor) has multiply-and-add floating point
instruction, fmadd.
It can be represented by DAG list (fadd (fmul ra, rc), rb).
For this implementation, we can assign fmadd DAG pattern to instruction td as
follows,</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span>def FMADDS : AForm_1&lt;59, 29,
          (ops F4RC:$FRT, F4RC:$FRA, F4RC:$FRC, F4RC:$FRB),
          &quot;fmadds $FRT, $FRA, $FRC, $FRB&quot;,
          [(set F4RC:$FRT, (fadd (fmul F4RC:$FRA, F4RC:$FRC),
                       F4RC:$FRB))]&gt;;
</pre></div>
</div>
<p>Similar with ADDiu, [(set F4RC:$FRT, (fadd (fmul F4RC:$FRA, F4RC:$FRC),
F4RC:$FRB))] is the pattern which include nodes <strong>fmul</strong> and <strong>fadd</strong>.</p>
<p>Now, for the following basic block notation IR and llvm SSA IR code,</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="n">d</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="n">c</span>
<span class="n">e</span> <span class="o">=</span> <span class="n">d</span> <span class="o">+</span> <span class="n">b</span>
<span class="p">...</span>

<span class="o">%</span><span class="n">d</span> <span class="o">=</span> <span class="n">fmul</span> <span class="o">%</span><span class="n">a</span><span class="p">,</span> <span class="o">%</span><span class="n">c</span>
<span class="o">%</span><span class="n">e</span> <span class="o">=</span> <span class="n">fadd</span> <span class="o">%</span><span class="n">d</span><span class="p">,</span> <span class="o">%</span><span class="n">b</span>
<span class="p">...</span>
</pre></div>
</div>
<p>the Instruction Selection Process will translate this two IR DAG node
(fmul %a, %c) (fadd %d, %b) into one machine instruction DAG node (<strong>fmadd</strong>
%a, %c, %b), rather than translate them into two machine instruction nodes
<strong>fmul</strong> and <strong>fadd</strong> if the FMADDS is appear before FMUL and FADD in your td
file.</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="o">%</span><span class="n">e</span> <span class="o">=</span> <span class="n">fmadd</span> <span class="o">%</span><span class="n">a</span><span class="p">,</span> <span class="o">%</span><span class="n">c</span><span class="p">,</span> <span class="o">%</span><span class="n">b</span>
<span class="p">...</span>
</pre></div>
</div>
<p>As you can see, the IR notation representation is easier to read than llvm SSA
IR form.
So, this notation form is used in this book sometimes.</p>
<p>For the following basic block code,</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span>a = b + c   // in notation IR form
d = a – d
%e = fmadd %a, %c, %b // in llvm SSA IR form
</pre></div>
</div>
<p>We can apply <a class="reference internal" href="#llvmstructure-f8"><span class="std std-numref">Fig. 7</span></a> Instruction Tree Patterns to get the
following machine code,</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="n">load</span>  <span class="n">rb</span><span class="p">,</span> <span class="n">M</span><span class="p">(</span><span class="n">sp</span><span class="o">+</span><span class="mi">8</span><span class="p">);</span> <span class="c1">// assume b allocate in sp+8, sp is stack point register</span>
<span class="n">load</span>  <span class="n">rc</span><span class="p">,</span> <span class="n">M</span><span class="p">(</span><span class="n">sp</span><span class="o">+</span><span class="mi">16</span><span class="p">);</span>
<span class="n">add</span> <span class="n">ra</span><span class="p">,</span> <span class="n">rb</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>
<span class="n">load</span>  <span class="n">rd</span><span class="p">,</span> <span class="n">M</span><span class="p">(</span><span class="n">sp</span><span class="o">+</span><span class="mi">24</span><span class="p">);</span>
<span class="n">sub</span> <span class="n">rd</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">rd</span><span class="p">;</span>
<span class="n">fmadd</span> <span class="n">re</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">rb</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="caller-and-callee-saved-registers">
<h3><a class="toc-backref" href="#id67">Caller and callee saved registers</a><a class="headerlink" href="#caller-and-callee-saved-registers" title="Permalink to this headline">¶</a></h3>
<p class="rubric">lbdex/input/ch9_caller_callee_save_registers.cpp</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">extern</span> <span class="nb">int</span> <span class="n">add1</span><span class="p">(</span><span class="nb">int</span> <span class="n">x</span><span class="p">);</span>

<span class="nb">int</span> <span class="n">caller</span><span class="p">()</span>
<span class="p">{</span> 
  <span class="nb">int</span> <span class="n">t1</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
  <span class="nb">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">add1</span><span class="p">(</span><span class="n">t1</span><span class="p">);</span>  
  <span class="n">result</span> <span class="o">=</span> <span class="n">result</span> <span class="o">-</span> <span class="n">t1</span><span class="p">;</span>
  
  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Run Mips backend with above input will get the following result.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>JonathantekiiMac:input Jonathan$ ~/llvm/release/cmake_debug_build/Debug/bin/llc
-O0 -march<span class="o">=</span>mips -relocation-model<span class="o">=</span>static -filetype<span class="o">=</span>asm
ch9_caller_callee_save_registers.bc -o -
      .text
      .abicalls
      .option pic0
      .section        .mdebug.abi32,<span class="s2">&quot;&quot;</span>,@progbits
      .nan    legacy
      .file   <span class="s2">&quot;ch9_caller_callee_save_registers.bc&quot;</span>
      .text
      .globl  _Z6callerv
      .align  2
      .type   _Z6callerv,@function
      .set    nomicromips
      .set    nomips16
      .ent    _Z6callerv
_Z6callerv:                             <span class="c1"># @_Z6callerv</span>
      .cfi_startproc
      .frame  <span class="nv">$fp</span>,32,<span class="nv">$ra</span>
      .mask   0xc0000000,-4
      .fmask  0x00000000,0
      .set    noreorder
      .set    nomacro
      .set    noat
<span class="c1"># BB#0:</span>
      addiu   <span class="nv">$sp</span>, <span class="nv">$sp</span>, -32
<span class="nv">$tmp0</span>:
      .cfi_def_cfa_offset 32
      sw      <span class="nv">$ra</span>, 28<span class="o">(</span><span class="nv">$sp</span><span class="o">)</span>            <span class="c1"># 4-byte Folded Spill</span>
      sw      <span class="nv">$fp</span>, 24<span class="o">(</span><span class="nv">$sp</span><span class="o">)</span>            <span class="c1"># 4-byte Folded Spill</span>
<span class="nv">$tmp1</span>:
      .cfi_offset 31, -4
<span class="nv">$tmp2</span>:
      .cfi_offset 30, -8
      move     <span class="nv">$fp</span>, <span class="nv">$sp</span>
<span class="nv">$tmp3</span>:
      .cfi_def_cfa_register 30
      addiu   <span class="nv">$1</span>, <span class="nv">$zero</span>, 3
      sw      <span class="nv">$1</span>, 20<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>   <span class="c1"># store t1 to 20($fp)</span>
      move     <span class="nv">$4</span>, <span class="nv">$1</span>
      jal     _Z4add1i
      nop
      sw      <span class="nv">$2</span>, 16<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>   <span class="c1"># $2 : the return vaule for fuction add1()</span>
      lw      <span class="nv">$1</span>, 20<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>   <span class="c1"># load t1 from 20($fp)</span>
      subu    <span class="nv">$1</span>, <span class="nv">$2</span>, <span class="nv">$1</span>
      sw      <span class="nv">$1</span>, 16<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
      move     <span class="nv">$2</span>, <span class="nv">$1</span>     <span class="c1"># move result to return register $2</span>
      move     <span class="nv">$sp</span>, <span class="nv">$fp</span>
      lw      <span class="nv">$fp</span>, 24<span class="o">(</span><span class="nv">$sp</span><span class="o">)</span>            <span class="c1"># 4-byte Folded Reload</span>
      lw      <span class="nv">$ra</span>, 28<span class="o">(</span><span class="nv">$sp</span><span class="o">)</span>            <span class="c1"># 4-byte Folded Reload</span>
      addiu   <span class="nv">$sp</span>, <span class="nv">$sp</span>, 32
      jr      <span class="nv">$ra</span>
      nop
      .set    at
      .set    macro
      .set    reorder
      .end    _Z6callerv
<span class="nv">$func_end0</span>:
      .size   _Z6callerv, <span class="o">(</span><span class="nv">$func_end0</span><span class="o">)</span>-_Z6callerv
      .cfi_endproc
</pre></div>
</div>
<p>As above assembly output, Mips allocates t1 variable to register $1 and no need
to spill $1 since $1 is caller saved register.
On the other hand, $ra is callee saved register, so it spills at beginning of
the assembly output since jal uses $ra register.
Cpu0 $lr is the same register as Mips $ra, so it calls setAliasRegs(MF,
SavedRegs, Cpu0::LR) in determineCalleeSaves() of Cpu0SEFrameLowering.cpp when
the function has called another function.</p>
</div>
<div class="section" id="live-in-and-live-out-register">
<h3><a class="toc-backref" href="#id68">Live in and live out register</a><a class="headerlink" href="#live-in-and-live-out-register" title="Permalink to this headline">¶</a></h3>
<p>As the example of last sub-section. The $ra is &#8220;live in&#8221; register since the
return address is decided by caller. The $2 is &#8220;live out&#8221; register since the
return value of the function is saved in this register, and caller can get the
result by read it directly as the comment in above example.
Through mark &#8220;live in&#8221; and &#8220;live out&#8221; registers, backend provides
llvm middle layer information to remove useless instructions in variables
access.
Of course, llvm applies the DAG analysis mentioned in the previous sub-section
to finish it.
Since C supports seperate compilation for different functions, the &#8220;live in&#8221;
and &#8220;out&#8221; information from backend provides the optimization opportunity to
llvm.
LLVM provides function addLiveIn() to mark &#8220;live in&#8221; register but no function
addLiveOut() provided.
For the &#8220;live out&#8221; register, Mips backend marks it by
DAG=DAG.getCopyToReg(..., $2, ...) and return DAG instead, since all local
varaiables are not exist after function exit.</p>
</div>
</div>
<div class="section" id="create-cpu0-backend">
<h2><a class="toc-backref" href="#id69">Create Cpu0 backend</a><a class="headerlink" href="#create-cpu0-backend" title="Permalink to this headline">¶</a></h2>
<p>From now on, the Cpu0 backend will be created from scratch step by step.
To make readers easily understanding the backend structure, Cpu0
example code can be generated with chapter by chapter through command here
<a class="footnote-reference" href="#chapters-ex" id="id23">[10]</a>.
Cpu0 example code, lbdex, can be found at near left bottom of this web site. Or
here <a class="reference external" href="http://jonathan2251.github.io/lbd/lbdex.tar.gz">http://jonathan2251.github.io/lbd/lbdex.tar.gz</a>.</p>
<div class="section" id="cpu0-backend-machine-id-and-relocation-records">
<h3><a class="toc-backref" href="#id70">Cpu0 backend machine ID and relocation records</a><a class="headerlink" href="#cpu0-backend-machine-id-and-relocation-records" title="Permalink to this headline">¶</a></h3>
<p>To create a new backend, there are some files in &lt;&lt;llvm root dir&gt;&gt; need to be
modified. The added information include both the ID and name of machine, and
relocation records. Chapter &#8220;ELF Support&#8221; include the relocation records
introduction. The following files are modified to add Cpu0 backend as follows,</p>
<p class="rubric">lbdex/src/modify/src/config-ix.cmake</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="p">...</span>
<span class="n">elseif</span> <span class="p">(</span><span class="n">LLVM_NATIVE_ARCH</span> <span class="n">MATCHES</span> <span class="s">&quot;cpu0&quot;</span><span class="p">)</span>
  <span class="n">set</span><span class="p">(</span><span class="n">LLVM_NATIVE_ARCH</span> <span class="n">Cpu0</span><span class="p">)</span>
<span class="p">...</span>
</pre></div>
</div>
<p class="rubric">lbdex/src/modify/src/CMakeLists.txt</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="n">set</span><span class="p">(</span><span class="n">LLVM_ALL_TARGETS</span>
  <span class="p">...</span>
  <span class="n">Cpu0</span>
  <span class="p">...</span>
  <span class="p">)</span>
</pre></div>
</div>
<p class="rubric">lbdex/src/modify/src/include/llvm/ADT/Triple.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="p">...</span>
<span class="cp">#undef mips</span>
<span class="cp">#undef cpu0</span>
<span class="p">...</span>
<span class="k">class</span> <span class="nc">Triple</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="k">enum</span> <span class="n">ArchType</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="n">cpu0</span><span class="p">,</span>       <span class="c1">// For Tutorial Backend Cpu0</span>
    <span class="n">cpu0el</span><span class="p">,</span>
    <span class="p">...</span>
  <span class="p">};</span>
  <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/src/modify/src/include/llvm/MC/MCExpr.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MCSymbolRefExpr</span> <span class="o">:</span> <span class="k">public</span> <span class="n">MCExpr</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="k">enum</span> <span class="n">VariantKind</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="n">VK_Cpu0_GPREL</span><span class="p">,</span>
    <span class="n">VK_Cpu0_GOT_CALL</span><span class="p">,</span>
    <span class="n">VK_Cpu0_GOT16</span><span class="p">,</span>
    <span class="n">VK_Cpu0_GOT</span><span class="p">,</span>
    <span class="n">VK_Cpu0_ABS_HI</span><span class="p">,</span>
    <span class="n">VK_Cpu0_ABS_LO</span><span class="p">,</span>
    <span class="n">VK_Cpu0_TLSGD</span><span class="p">,</span>
    <span class="n">VK_Cpu0_TLSLDM</span><span class="p">,</span>
    <span class="n">VK_Cpu0_DTP_HI</span><span class="p">,</span>
    <span class="n">VK_Cpu0_DTP_LO</span><span class="p">,</span>
    <span class="n">VK_Cpu0_GOTTPREL</span><span class="p">,</span>
    <span class="n">VK_Cpu0_TP_HI</span><span class="p">,</span>
    <span class="n">VK_Cpu0_TP_LO</span><span class="p">,</span>
    <span class="n">VK_Cpu0_GPOFF_HI</span><span class="p">,</span>
    <span class="n">VK_Cpu0_GPOFF_LO</span><span class="p">,</span>
    <span class="n">VK_Cpu0_GOT_DISP</span><span class="p">,</span>
    <span class="n">VK_Cpu0_GOT_PAGE</span><span class="p">,</span>
    <span class="n">VK_Cpu0_GOT_OFST</span><span class="p">,</span>
    <span class="n">VK_Cpu0_HIGHER</span><span class="p">,</span>
    <span class="n">VK_Cpu0_HIGHEST</span><span class="p">,</span>
    <span class="n">VK_Cpu0_GOT_HI16</span><span class="p">,</span>
    <span class="n">VK_Cpu0_GOT_LO16</span><span class="p">,</span>
    <span class="n">VK_Cpu0_CALL_HI16</span><span class="p">,</span>
    <span class="n">VK_Cpu0_CALL_LO16</span><span class="p">,</span>
    <span class="p">...</span>
  <span class="p">};</span>
  <span class="p">...</span>
<span class="p">};</span>
</pre></div>
</div>
<p class="rubric">lbdex/src/modify/src/include/llvm/Object/ELFObjectFile.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="p">...</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">ELFT</span><span class="o">&gt;</span>
<span class="n">StringRef</span> <span class="n">ELFObjectFile</span><span class="o">&lt;</span><span class="n">ELFT</span><span class="o">&gt;::</span><span class="n">getFileFormatName</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">EF</span><span class="p">.</span><span class="n">getHeader</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">e_ident</span><span class="p">[</span><span class="n">ELF</span><span class="o">::</span><span class="n">EI_CLASS</span><span class="p">])</span> <span class="p">{</span>
  <span class="k">case</span> <span class="n">ELF</span><span class="o">::</span><span class="nl">ELFCLASS32</span><span class="p">:</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">EF</span><span class="p">.</span><span class="n">getHeader</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">e_machine</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="k">case</span> <span class="n">ELF</span><span class="o">::</span><span class="nl">EM_CPU0</span><span class="p">:</span>        <span class="c1">// llvm-objdump -t -r</span>
      <span class="k">return</span> <span class="s">&quot;ELF32-cpu0&quot;</span><span class="p">;</span>
    <span class="p">...</span>
  <span class="p">}</span>
  <span class="p">...</span>
<span class="p">}</span>
<span class="p">...</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">ELFT</span><span class="o">&gt;</span>
<span class="kt">unsigned</span> <span class="n">ELFObjectFile</span><span class="o">&lt;</span><span class="n">ELFT</span><span class="o">&gt;::</span><span class="n">getArch</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
  <span class="kt">bool</span> <span class="n">IsLittleEndian</span> <span class="o">=</span> <span class="n">ELFT</span><span class="o">::</span><span class="n">TargetEndianness</span> <span class="o">==</span> <span class="n">support</span><span class="o">::</span><span class="n">little</span><span class="p">;</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">EF</span><span class="p">.</span><span class="n">getHeader</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">e_machine</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="k">case</span> <span class="n">ELF</span><span class="o">::</span><span class="nl">EM_CPU0</span><span class="p">:</span>  <span class="c1">// llvm-objdump -t -r</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">EF</span><span class="p">.</span><span class="n">getHeader</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">e_ident</span><span class="p">[</span><span class="n">ELF</span><span class="o">::</span><span class="n">EI_CLASS</span><span class="p">])</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">ELF</span><span class="o">::</span><span class="nl">ELFCLASS32</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">IsLittleEndian</span> <span class="o">?</span> <span class="n">Triple</span><span class="o">::</span><span class="nl">cpu0el</span> <span class="p">:</span> <span class="n">Triple</span><span class="o">::</span><span class="n">cpu0</span><span class="p">;</span>
    <span class="k">default</span><span class="o">:</span>
      <span class="n">report_fatal_error</span><span class="p">(</span><span class="s">&quot;Invalid ELFCLASS!&quot;</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">...</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/src/modify/src/include/llvm/Support/ELF.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="k">enum</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="n">EM_CPU0</span>          <span class="o">=</span> <span class="mi">999</span>  <span class="c1">// Document LLVM Backend Tutorial Cpu0</span>
<span class="p">};</span>
<span class="p">...</span>
<span class="c1">// Cpu0 Specific e_flags</span>
<span class="k">enum</span> <span class="p">{</span>
  <span class="n">EF_CPU0_NOREORDER</span> <span class="o">=</span> <span class="mh">0x00000001</span><span class="p">,</span> <span class="c1">// Don&#39;t reorder instructions</span>
  <span class="n">EF_CPU0_PIC</span>       <span class="o">=</span> <span class="mh">0x00000002</span><span class="p">,</span> <span class="c1">// Position independent code</span>
  <span class="n">EF_CPU0_ARCH_32</span>   <span class="o">=</span> <span class="mh">0x50000000</span><span class="p">,</span> <span class="c1">// CPU032 instruction set per linux not elf.h</span>
  <span class="n">EF_CPU0_ARCH</span>      <span class="o">=</span> <span class="mh">0xf0000000</span>  <span class="c1">// Mask for applying EF_CPU0_ARCH_ variant</span>
<span class="p">};</span>

<span class="c1">// ELF Relocation types for Mips</span>
<span class="k">enum</span> <span class="p">{</span>
<span class="cp">#include</span> <span class="cpf">&quot;ELFRelocs/Cpu0.def&quot;</span><span class="cp"></span>
<span class="p">};</span>
<span class="p">...</span>
</pre></div>
</div>
<p class="rubric">lbdex/src/modify/src/lib/MC/MCELFStreamer.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="n">MCELFStreamer</span><span class="o">::</span><span class="n">fixSymbolsInTLSFixups</span><span class="p">(</span><span class="k">const</span> <span class="n">MCExpr</span> <span class="o">*</span><span class="n">expr</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">...</span>
    <span class="k">case</span> <span class="n">MCSymbolRefExpr</span><span class="o">::</span><span class="nl">VK_Cpu0_TLSGD</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">MCSymbolRefExpr</span><span class="o">::</span><span class="nl">VK_Cpu0_GOTTPREL</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">MCSymbolRefExpr</span><span class="o">::</span><span class="nl">VK_Cpu0_TP_HI</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">MCSymbolRefExpr</span><span class="o">::</span><span class="nl">VK_Cpu0_TP_LO</span><span class="p">:</span>
  <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/src/modify/src/lib/MC/MCExpr.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="n">StringRef</span> <span class="n">MCSymbolRefExpr</span><span class="o">::</span><span class="n">getVariantKindName</span><span class="p">(</span><span class="n">VariantKind</span> <span class="n">Kind</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">Kind</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="k">case</span> <span class="nl">VK_Cpu0_GPREL</span><span class="p">:</span> <span class="k">return</span> <span class="s">&quot;GPREL&quot;</span><span class="p">;</span>
  <span class="k">case</span> <span class="nl">VK_Cpu0_GOT_CALL</span><span class="p">:</span> <span class="k">return</span> <span class="s">&quot;GOT_CALL&quot;</span><span class="p">;</span>
  <span class="k">case</span> <span class="nl">VK_Cpu0_GOT16</span><span class="p">:</span> <span class="k">return</span> <span class="s">&quot;GOT16&quot;</span><span class="p">;</span>
  <span class="k">case</span> <span class="nl">VK_Cpu0_GOT</span><span class="p">:</span> <span class="k">return</span> <span class="s">&quot;GOT&quot;</span><span class="p">;</span>
  <span class="k">case</span> <span class="nl">VK_Cpu0_ABS_HI</span><span class="p">:</span> <span class="k">return</span> <span class="s">&quot;ABS_HI&quot;</span><span class="p">;</span>
  <span class="k">case</span> <span class="nl">VK_Cpu0_ABS_LO</span><span class="p">:</span> <span class="k">return</span> <span class="s">&quot;ABS_LO&quot;</span><span class="p">;</span>
  <span class="k">case</span> <span class="nl">VK_Cpu0_TLSGD</span><span class="p">:</span> <span class="k">return</span> <span class="s">&quot;TLSGD&quot;</span><span class="p">;</span>
  <span class="k">case</span> <span class="nl">VK_Cpu0_TLSLDM</span><span class="p">:</span> <span class="k">return</span> <span class="s">&quot;TLSLDM&quot;</span><span class="p">;</span>
  <span class="k">case</span> <span class="nl">VK_Cpu0_DTP_HI</span><span class="p">:</span> <span class="k">return</span> <span class="s">&quot;DTP_HI&quot;</span><span class="p">;</span>
  <span class="k">case</span> <span class="nl">VK_Cpu0_DTP_LO</span><span class="p">:</span> <span class="k">return</span> <span class="s">&quot;DTP_LO&quot;</span><span class="p">;</span>
  <span class="k">case</span> <span class="nl">VK_Cpu0_GOTTPREL</span><span class="p">:</span> <span class="k">return</span> <span class="s">&quot;GOTTPREL&quot;</span><span class="p">;</span>
  <span class="k">case</span> <span class="nl">VK_Cpu0_TP_HI</span><span class="p">:</span> <span class="k">return</span> <span class="s">&quot;TP_HI&quot;</span><span class="p">;</span>
  <span class="k">case</span> <span class="nl">VK_Cpu0_TP_LO</span><span class="p">:</span> <span class="k">return</span> <span class="s">&quot;TP_LO&quot;</span><span class="p">;</span>
  <span class="k">case</span> <span class="nl">VK_Cpu0_GPOFF_HI</span><span class="p">:</span> <span class="k">return</span> <span class="s">&quot;GPOFF_HI&quot;</span><span class="p">;</span>
  <span class="k">case</span> <span class="nl">VK_Cpu0_GPOFF_LO</span><span class="p">:</span> <span class="k">return</span> <span class="s">&quot;GPOFF_LO&quot;</span><span class="p">;</span>
  <span class="k">case</span> <span class="nl">VK_Cpu0_GOT_DISP</span><span class="p">:</span> <span class="k">return</span> <span class="s">&quot;GOT_DISP&quot;</span><span class="p">;</span>
  <span class="k">case</span> <span class="nl">VK_Cpu0_GOT_PAGE</span><span class="p">:</span> <span class="k">return</span> <span class="s">&quot;GOT_PAGE&quot;</span><span class="p">;</span>
  <span class="k">case</span> <span class="nl">VK_Cpu0_GOT_OFST</span><span class="p">:</span> <span class="k">return</span> <span class="s">&quot;GOT_OFST&quot;</span><span class="p">;</span>
  <span class="k">case</span> <span class="nl">VK_Cpu0_HIGHER</span><span class="p">:</span>   <span class="k">return</span> <span class="s">&quot;HIGHER&quot;</span><span class="p">;</span>
  <span class="k">case</span> <span class="nl">VK_Cpu0_HIGHEST</span><span class="p">:</span>  <span class="k">return</span> <span class="s">&quot;HIGHEST&quot;</span><span class="p">;</span>
  <span class="k">case</span> <span class="nl">VK_Cpu0_GOT_HI16</span><span class="p">:</span> <span class="k">return</span> <span class="s">&quot;GOT_HI16&quot;</span><span class="p">;</span>
  <span class="k">case</span> <span class="nl">VK_Cpu0_GOT_LO16</span><span class="p">:</span> <span class="k">return</span> <span class="s">&quot;GOT_LO16&quot;</span><span class="p">;</span>
  <span class="k">case</span> <span class="nl">VK_Cpu0_CALL_HI16</span><span class="p">:</span> <span class="k">return</span> <span class="s">&quot;CALL_HI16&quot;</span><span class="p">;</span>
  <span class="k">case</span> <span class="nl">VK_Cpu0_CALL_LO16</span><span class="p">:</span> <span class="k">return</span> <span class="s">&quot;CALL_LO16&quot;</span><span class="p">;</span>
  <span class="p">...</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/src/modify/src/lib/MC/MCSubtargetInfo.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="kt">bool</span> <span class="n">Cpu0DisableUnreconginizedMessage</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

<span class="kt">void</span> <span class="n">MCSubtargetInfo</span><span class="o">::</span><span class="n">InitMCProcessorInfo</span><span class="p">(</span><span class="n">StringRef</span> <span class="n">CPU</span><span class="p">,</span> <span class="n">StringRef</span> <span class="n">FS</span><span class="p">)</span> <span class="p">{</span>
  <span class="cp">#if 1 </span><span class="c1">// Disable reconginized processor message. For Cpu0</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">TargetTriple</span><span class="p">.</span><span class="n">getArch</span><span class="p">()</span> <span class="o">==</span> <span class="n">llvm</span><span class="o">::</span><span class="n">Triple</span><span class="o">::</span><span class="n">cpu0</span> <span class="o">||</span>
      <span class="n">TargetTriple</span><span class="p">.</span><span class="n">getArch</span><span class="p">()</span> <span class="o">==</span> <span class="n">llvm</span><span class="o">::</span><span class="n">Triple</span><span class="o">::</span><span class="n">cpu0el</span><span class="p">)</span>
    <span class="n">Cpu0DisableUnreconginizedMessage</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="cp">#endif</span>
  <span class="p">...</span>
<span class="p">}</span>
<span class="p">...</span>
<span class="k">const</span> <span class="n">MCSchedModel</span> <span class="o">&amp;</span><span class="n">MCSubtargetInfo</span><span class="o">::</span><span class="n">getSchedModelForCPU</span><span class="p">(</span><span class="n">StringRef</span> <span class="n">CPU</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="p">...</span>
    <span class="cp">#if 1 </span><span class="c1">// Disable reconginized processor message. For Cpu0</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">TargetTriple</span><span class="p">.</span><span class="n">getArch</span><span class="p">()</span> <span class="o">!=</span> <span class="n">llvm</span><span class="o">::</span><span class="n">Triple</span><span class="o">::</span><span class="n">cpu0</span> <span class="o">&amp;&amp;</span>
        <span class="n">TargetTriple</span><span class="p">.</span><span class="n">getArch</span><span class="p">()</span> <span class="o">!=</span> <span class="n">llvm</span><span class="o">::</span><span class="n">Triple</span><span class="o">::</span><span class="n">cpu0el</span><span class="p">)</span>
    <span class="cp">#endif</span>
  <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/src/modify/src/lib/MC/SubtargetFeature.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="k">extern</span> <span class="kt">bool</span> <span class="n">Cpu0DisableUnreconginizedMessage</span><span class="p">;</span> <span class="c1">// For Cpu0</span>
<span class="p">...</span>
<span class="n">FeatureBitset</span>
<span class="n">SubtargetFeatures</span><span class="o">::</span><span class="n">ToggleFeature</span><span class="p">(</span><span class="n">FeatureBitset</span> <span class="n">Bits</span><span class="p">,</span> <span class="n">StringRef</span> <span class="n">Feature</span><span class="p">,</span>
                                 <span class="n">ArrayRef</span><span class="o">&lt;</span><span class="n">SubtargetFeatureKV</span><span class="o">&gt;</span> <span class="n">FeatureTable</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">...</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Cpu0DisableUnreconginizedMessage</span><span class="p">)</span> <span class="c1">// For Cpu0</span>
  <span class="p">...</span>
<span class="p">}</span>

<span class="n">FeatureBitset</span>
<span class="n">SubtargetFeatures</span><span class="o">::</span><span class="n">ApplyFeatureFlag</span><span class="p">(</span><span class="n">FeatureBitset</span> <span class="n">Bits</span><span class="p">,</span> <span class="n">StringRef</span> <span class="n">Feature</span><span class="p">,</span>
                                    <span class="n">ArrayRef</span><span class="o">&lt;</span><span class="n">SubtargetFeatureKV</span><span class="o">&gt;</span> <span class="n">FeatureTable</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">...</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Cpu0DisableUnreconginizedMessage</span><span class="p">)</span> <span class="c1">// For Cpu0</span>
  <span class="p">...</span>
<span class="p">}</span>

<span class="n">FeatureBitset</span>
<span class="n">SubtargetFeatures</span><span class="o">::</span><span class="n">getFeatureBits</span><span class="p">(</span><span class="n">StringRef</span> <span class="n">CPU</span><span class="p">,</span>
                                  <span class="n">ArrayRef</span><span class="o">&lt;</span><span class="n">SubtargetFeatureKV</span><span class="o">&gt;</span> <span class="n">CPUTable</span><span class="p">,</span>
                                  <span class="n">ArrayRef</span><span class="o">&lt;</span><span class="n">SubtargetFeatureKV</span><span class="o">&gt;</span> <span class="n">FeatureTable</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">...</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Cpu0DisableUnreconginizedMessage</span><span class="p">)</span> <span class="c1">// For Cpu0</span>
  <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lib/object/ELF.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="p">...</span>

<span class="n">StringRef</span> <span class="n">getELFRelocationTypeName</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">Machine</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">Type</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">Machine</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="k">case</span> <span class="n">ELF</span><span class="o">::</span><span class="nl">EM_CPU0</span><span class="p">:</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">Type</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#include</span> <span class="cpf">&quot;llvm/Support/ELFRelocs/Cpu0.def&quot;</span><span class="cp"></span>
    <span class="k">default</span><span class="o">:</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="p">...</span>
  <span class="p">}</span>
</pre></div>
</div>
<p class="rubric">include/llvm/Support/ELFRelocs/Cpu0.def</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>
<span class="c1">#ifndef ELF_RELOC</span>
<span class="c1">#error &quot;ELF_RELOC must be defined&quot;</span>
<span class="c1">#endif</span>

<span class="n">ELF_RELOC</span><span class="p">(</span><span class="n">R_CPU0_NONE</span><span class="p">,</span>                <span class="mi">0</span><span class="p">)</span>
<span class="n">ELF_RELOC</span><span class="p">(</span><span class="n">R_CPU0_32</span><span class="p">,</span>                  <span class="mi">2</span><span class="p">)</span>
<span class="n">ELF_RELOC</span><span class="p">(</span><span class="n">R_CPU0_HI16</span><span class="p">,</span>                <span class="mi">5</span><span class="p">)</span>
<span class="n">ELF_RELOC</span><span class="p">(</span><span class="n">R_CPU0_LO16</span><span class="p">,</span>                <span class="mi">6</span><span class="p">)</span>
<span class="n">ELF_RELOC</span><span class="p">(</span><span class="n">R_CPU0_GPREL16</span><span class="p">,</span>             <span class="mi">7</span><span class="p">)</span>
<span class="n">ELF_RELOC</span><span class="p">(</span><span class="n">R_CPU0_LITERAL</span><span class="p">,</span>             <span class="mi">8</span><span class="p">)</span>
<span class="n">ELF_RELOC</span><span class="p">(</span><span class="n">R_CPU0_GOT16</span><span class="p">,</span>               <span class="mi">9</span><span class="p">)</span>
<span class="n">ELF_RELOC</span><span class="p">(</span><span class="n">R_CPU0_PC16</span><span class="p">,</span>               <span class="mi">10</span><span class="p">)</span>
<span class="n">ELF_RELOC</span><span class="p">(</span><span class="n">R_CPU0_CALL16</span><span class="p">,</span>             <span class="mi">11</span><span class="p">)</span>
<span class="n">ELF_RELOC</span><span class="p">(</span><span class="n">R_CPU0_GPREL32</span><span class="p">,</span>            <span class="mi">12</span><span class="p">)</span>
<span class="n">ELF_RELOC</span><span class="p">(</span><span class="n">R_CPU0_PC24</span><span class="p">,</span>               <span class="mi">13</span><span class="p">)</span>
<span class="n">ELF_RELOC</span><span class="p">(</span><span class="n">R_CPU0_GOT_HI16</span><span class="p">,</span>           <span class="mi">22</span><span class="p">)</span>
<span class="n">ELF_RELOC</span><span class="p">(</span><span class="n">R_CPU0_GOT_LO16</span><span class="p">,</span>           <span class="mi">23</span><span class="p">)</span>
<span class="n">ELF_RELOC</span><span class="p">(</span><span class="n">R_CPU0_RELGOT</span><span class="p">,</span>             <span class="mi">36</span><span class="p">)</span>
<span class="n">ELF_RELOC</span><span class="p">(</span><span class="n">R_CPU0_TLS_GD</span><span class="p">,</span>             <span class="mi">42</span><span class="p">)</span>
<span class="n">ELF_RELOC</span><span class="p">(</span><span class="n">R_CPU0_TLS_LDM</span><span class="p">,</span>            <span class="mi">43</span><span class="p">)</span>
<span class="n">ELF_RELOC</span><span class="p">(</span><span class="n">R_CPU0_TLS_DTP_HI16</span><span class="p">,</span>       <span class="mi">44</span><span class="p">)</span>
<span class="n">ELF_RELOC</span><span class="p">(</span><span class="n">R_CPU0_TLS_DTP_LO16</span><span class="p">,</span>       <span class="mi">45</span><span class="p">)</span>
<span class="n">ELF_RELOC</span><span class="p">(</span><span class="n">R_CPU0_TLS_GOTTPREL</span><span class="p">,</span>       <span class="mi">46</span><span class="p">)</span>
<span class="n">ELF_RELOC</span><span class="p">(</span><span class="n">R_CPU0_TLS_TPREL32</span><span class="p">,</span>        <span class="mi">47</span><span class="p">)</span>
<span class="n">ELF_RELOC</span><span class="p">(</span><span class="n">R_CPU0_TLS_TP_HI16</span><span class="p">,</span>        <span class="mi">49</span><span class="p">)</span>
<span class="n">ELF_RELOC</span><span class="p">(</span><span class="n">R_CPU0_TLS_TP_LO16</span><span class="p">,</span>        <span class="mi">50</span><span class="p">)</span>
<span class="n">ELF_RELOC</span><span class="p">(</span><span class="n">R_CPU0_GLOB_DAT</span><span class="p">,</span>           <span class="mi">51</span><span class="p">)</span>
<span class="n">ELF_RELOC</span><span class="p">(</span><span class="n">R_CPU0_JUMP_SLOT</span><span class="p">,</span>          <span class="mi">127</span><span class="p">)</span>
</pre></div>
</div>
<p class="rubric">lbdex/src/modify/src/lib/Support/Triple.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">Triple</span><span class="o">::</span><span class="n">getArchTypeName</span><span class="p">(</span><span class="n">ArchType</span> <span class="n">Kind</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">Kind</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="k">case</span> <span class="nl">cpu0</span><span class="p">:</span>        <span class="k">return</span> <span class="s">&quot;cpu0&quot;</span><span class="p">;</span>
  <span class="k">case</span> <span class="nl">cpu0el</span><span class="p">:</span>      <span class="k">return</span> <span class="s">&quot;cpu0el&quot;</span><span class="p">;</span>
  <span class="p">...</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="p">...</span>
<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">Triple</span><span class="o">::</span><span class="n">getArchTypePrefix</span><span class="p">(</span><span class="n">ArchType</span> <span class="n">Kind</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">Kind</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="k">case</span> <span class="nl">cpu0</span><span class="p">:</span>
  <span class="k">case</span> <span class="nl">cpu0el</span><span class="p">:</span>      <span class="k">return</span> <span class="s">&quot;cpu0&quot;</span><span class="p">;</span>
  <span class="p">...</span>
<span class="p">}</span>
<span class="p">...</span>
<span class="n">Triple</span><span class="o">::</span><span class="n">ArchType</span> <span class="n">Triple</span><span class="o">::</span><span class="n">getArchTypeForLLVMName</span><span class="p">(</span><span class="n">StringRef</span> <span class="n">Name</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">StringSwitch</span><span class="o">&lt;</span><span class="n">Triple</span><span class="o">::</span><span class="n">ArchType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Name</span><span class="p">)</span>
    <span class="p">...</span>
    <span class="p">.</span><span class="n">Case</span><span class="p">(</span><span class="s">&quot;cpu0&quot;</span><span class="p">,</span> <span class="n">cpu0</span><span class="p">)</span>
    <span class="p">.</span><span class="n">Case</span><span class="p">(</span><span class="s">&quot;cpu0el&quot;</span><span class="p">,</span> <span class="n">cpu0el</span><span class="p">)</span>
    <span class="p">...</span>
<span class="p">}</span>
<span class="p">...</span>
<span class="k">static</span> <span class="n">Triple</span><span class="o">::</span><span class="n">ArchType</span> <span class="n">parseArch</span><span class="p">(</span><span class="n">StringRef</span> <span class="n">ArchName</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">StringSwitch</span><span class="o">&lt;</span><span class="n">Triple</span><span class="o">::</span><span class="n">ArchType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ArchName</span><span class="p">)</span>
    <span class="p">...</span>
    <span class="p">.</span><span class="n">Cases</span><span class="p">(</span><span class="s">&quot;cpu0&quot;</span><span class="p">,</span> <span class="s">&quot;cpu0eb&quot;</span><span class="p">,</span> <span class="s">&quot;cpu0allegrex&quot;</span><span class="p">,</span> <span class="n">Triple</span><span class="o">::</span><span class="n">cpu0</span><span class="p">)</span>
    <span class="p">.</span><span class="n">Cases</span><span class="p">(</span><span class="s">&quot;cpu0el&quot;</span><span class="p">,</span> <span class="s">&quot;cpu0allegrexel&quot;</span><span class="p">,</span> <span class="n">Triple</span><span class="o">::</span><span class="n">cpu0el</span><span class="p">)</span>
    <span class="p">...</span>
<span class="p">}</span>
<span class="p">...</span>
<span class="k">static</span> <span class="n">Triple</span><span class="o">::</span><span class="n">ObjectFormatType</span> <span class="n">getDefaultFormat</span><span class="p">(</span><span class="k">const</span> <span class="n">Triple</span> <span class="o">&amp;</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="k">case</span> <span class="n">Triple</span><span class="o">::</span><span class="nl">cpu0</span><span class="p">:</span>
  <span class="k">case</span> <span class="n">Triple</span><span class="o">::</span><span class="nl">cpu0el</span><span class="p">:</span>
  <span class="p">...</span>
<span class="p">}</span>
<span class="p">...</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="n">getArchPointerBitWidth</span><span class="p">(</span><span class="n">llvm</span><span class="o">::</span><span class="n">Triple</span><span class="o">::</span><span class="n">ArchType</span> <span class="n">Arch</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">Arch</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="k">case</span> <span class="n">llvm</span><span class="o">::</span><span class="n">Triple</span><span class="o">::</span><span class="nl">cpu0</span><span class="p">:</span>
  <span class="k">case</span> <span class="n">llvm</span><span class="o">::</span><span class="n">Triple</span><span class="o">::</span><span class="nl">cpu0el</span><span class="p">:</span>
  <span class="p">...</span>
    <span class="k">return</span> <span class="mi">32</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="p">...</span>
<span class="n">Triple</span> <span class="n">Triple</span><span class="o">::</span><span class="n">get32BitArchVariant</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
  <span class="n">Triple</span> <span class="n">T</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">getArch</span><span class="p">())</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="k">case</span> <span class="n">Triple</span><span class="o">::</span><span class="nl">cpu0</span><span class="p">:</span>
  <span class="k">case</span> <span class="n">Triple</span><span class="o">::</span><span class="nl">cpu0el</span><span class="p">:</span>
  <span class="p">...</span>
    <span class="c1">// Already 32-bit.</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">T</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="creating-the-initial-cpu0-td-files">
<h3><a class="toc-backref" href="#id71">Creating the Initial Cpu0 .td Files</a><a class="headerlink" href="#creating-the-initial-cpu0-td-files" title="Permalink to this headline">¶</a></h3>
<p>As it has been discussed in the previous section, LLVM uses target description
files (which uses the .td file extension) to describe various components of a
target&#8217;s backend.
For example, these .td files may describe a target&#8217;s register set, instruction
set, scheduling information for instructions, and calling conventions.
When your backend is being compiled, the tablegen tool that ships with LLVM
will translate these .td files into C++ source code written to files that have
a .inc extension.
Please refer to <a class="footnote-reference" href="#tblgen" id="id24">[20]</a> for more information regarding how to use tablegen.</p>
<p>Every backend has a .td which defines some target information, which including
what other .td files are used by the backend.
These files have a similar syntax to C++. For Cpu0, the target description file
is called Cpu0Other.td, which is shown below:</p>
<p class="rubric">lbdex/chapters/Chapter2/Cpu0Other.td</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">//===--</span> <span class="n">Cpu0Other</span><span class="o">.</span><span class="n">td</span> <span class="o">-</span> <span class="n">Describe</span> <span class="n">the</span> <span class="n">Cpu0</span> <span class="n">Target</span> <span class="n">Machine</span> <span class="o">----*-</span> <span class="n">tablegen</span> <span class="o">-*-===//</span>
<span class="o">//</span>
<span class="o">//</span>                     <span class="n">The</span> <span class="n">LLVM</span> <span class="n">Compiler</span> <span class="n">Infrastructure</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="ow">is</span> <span class="n">distributed</span> <span class="n">under</span> <span class="n">the</span> <span class="n">University</span> <span class="n">of</span> <span class="n">Illinois</span> <span class="n">Open</span> <span class="n">Source</span>
<span class="o">//</span> <span class="n">License</span><span class="o">.</span> <span class="n">See</span> <span class="n">LICENSE</span><span class="o">.</span><span class="n">TXT</span> <span class="k">for</span> <span class="n">details</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span> <span class="n">This</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">top</span> <span class="n">level</span> <span class="n">entry</span> <span class="n">point</span> <span class="k">for</span> <span class="n">the</span> <span class="n">Cpu0</span> <span class="n">target</span><span class="o">.</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span> <span class="n">Target</span><span class="o">-</span><span class="n">independent</span> <span class="n">interfaces</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="n">include</span> <span class="s2">&quot;llvm/Target/Target.td&quot;</span>

<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span> <span class="n">Target</span><span class="o">-</span><span class="n">dependent</span> <span class="n">interfaces</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="n">include</span> <span class="s2">&quot;Cpu0RegisterInfo.td&quot;</span>
<span class="n">include</span> <span class="s2">&quot;Cpu0RegisterInfoGPROutForOther.td&quot;</span> <span class="o">//</span> <span class="k">except</span> <span class="n">AsmParser</span>
<span class="n">include</span> <span class="s2">&quot;Cpu0.td&quot;</span>

</pre></div>
</div>
<p>Cpu0Other.td and Cpu0.td includes a few other .td files.
Cpu0RegisterInfo.td (shown below) describes the Cpu0&#8217;s set of registers.
In this file, we see that registers have been given names, i.e. <strong>&#8220;def PC&#8221;</strong>
indicates that there is a register called PC.  Beside of registers, it also
define register classes.
You may have multiple register classes such as CPURegs, SR, C0Regs and GPROut.
GPROut defined in Cpu0RegisterInfoGPROutForOther.td which include CPURegs
except SW, so SW won&#8217;t be allocated as the output registers in register
allocation stage.</p>
<p class="rubric">lbdex/chapters/Chapter2/Cpu0RegisterInfo.td</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">//===--</span> <span class="n">Cpu0RegisterInfo</span><span class="o">.</span><span class="n">td</span> <span class="o">-</span> <span class="n">Cpu0</span> <span class="n">Register</span> <span class="n">defs</span> <span class="o">-----------*-</span> <span class="n">tablegen</span> <span class="o">-*-===//</span>
<span class="o">//</span>
<span class="o">//</span>                     <span class="n">The</span> <span class="n">LLVM</span> <span class="n">Compiler</span> <span class="n">Infrastructure</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="ow">is</span> <span class="n">distributed</span> <span class="n">under</span> <span class="n">the</span> <span class="n">University</span> <span class="n">of</span> <span class="n">Illinois</span> <span class="n">Open</span> <span class="n">Source</span>
<span class="o">//</span> <span class="n">License</span><span class="o">.</span> <span class="n">See</span> <span class="n">LICENSE</span><span class="o">.</span><span class="n">TXT</span> <span class="k">for</span> <span class="n">details</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span>  <span class="n">Declarations</span> <span class="n">that</span> <span class="n">describe</span> <span class="n">the</span> <span class="n">CPU0</span> <span class="n">register</span> <span class="n">file</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="o">//</span> <span class="n">We</span> <span class="n">have</span> <span class="n">banks</span> <span class="n">of</span> <span class="mi">16</span> <span class="n">registers</span> <span class="n">each</span><span class="o">.</span>
<span class="k">class</span> <span class="nc">Cpu0Reg</span><span class="o">&lt;</span><span class="n">bits</span><span class="o">&lt;</span><span class="mi">16</span><span class="o">&gt;</span> <span class="n">Enc</span><span class="p">,</span> <span class="n">string</span> <span class="n">n</span><span class="o">&gt;</span> <span class="p">:</span> <span class="n">Register</span><span class="o">&lt;</span><span class="n">n</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="n">let</span> <span class="n">HWEncoding</span> <span class="o">=</span> <span class="n">Enc</span><span class="p">;</span>
  <span class="n">let</span> <span class="n">Namespace</span> <span class="o">=</span> <span class="s2">&quot;Cpu0&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">//</span> <span class="n">Cpu0</span> <span class="n">CPU</span> <span class="n">Registers</span>
<span class="k">class</span> <span class="nc">Cpu0GPRReg</span><span class="o">&lt;</span><span class="n">bits</span><span class="o">&lt;</span><span class="mi">16</span><span class="o">&gt;</span> <span class="n">Enc</span><span class="p">,</span> <span class="n">string</span> <span class="n">n</span><span class="o">&gt;</span> <span class="p">:</span> <span class="n">Cpu0Reg</span><span class="o">&lt;</span><span class="n">Enc</span><span class="p">,</span> <span class="n">n</span><span class="o">&gt;</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Co</span><span class="o">-</span><span class="n">processor</span> <span class="mi">0</span> <span class="n">Registers</span>
<span class="k">class</span> <span class="nc">Cpu0C0Reg</span><span class="o">&lt;</span><span class="n">bits</span><span class="o">&lt;</span><span class="mi">16</span><span class="o">&gt;</span> <span class="n">Enc</span><span class="p">,</span> <span class="n">string</span> <span class="n">n</span><span class="o">&gt;</span> <span class="p">:</span> <span class="n">Cpu0Reg</span><span class="o">&lt;</span><span class="n">Enc</span><span class="p">,</span> <span class="n">n</span><span class="o">&gt;</span><span class="p">;</span>

<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span><span class="nd">@Registers</span>
<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span> <span class="n">The</span> <span class="n">register</span> <span class="n">string</span><span class="p">,</span> <span class="n">such</span> <span class="k">as</span> <span class="s2">&quot;9&quot;</span> <span class="ow">or</span> <span class="s2">&quot;gp&quot;</span> <span class="n">will</span> <span class="n">show</span> <span class="n">on</span> <span class="s2">&quot;llvm-objdump -d&quot;</span>
<span class="o">//@</span> <span class="n">All</span> <span class="n">registers</span> <span class="n">definition</span>
<span class="n">let</span> <span class="n">Namespace</span> <span class="o">=</span> <span class="s2">&quot;Cpu0&quot;</span> <span class="ow">in</span> <span class="p">{</span>
  <span class="o">//@</span> <span class="n">General</span> <span class="n">Purpose</span> <span class="n">Registers</span>
  <span class="k">def</span> <span class="nf">ZERO</span> <span class="p">:</span> <span class="n">Cpu0GPRReg</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">,</span>  <span class="s2">&quot;zero&quot;</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">DwarfRegNum</span><span class="o">&lt;</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="k">def</span> <span class="nf">AT</span>   <span class="p">:</span> <span class="n">Cpu0GPRReg</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span>  <span class="s2">&quot;1&quot;</span><span class="o">&gt;</span><span class="p">,</span>    <span class="n">DwarfRegNum</span><span class="o">&lt;</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="k">def</span> <span class="nf">V0</span>   <span class="p">:</span> <span class="n">Cpu0GPRReg</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">,</span>  <span class="s2">&quot;2&quot;</span><span class="o">&gt;</span><span class="p">,</span>    <span class="n">DwarfRegNum</span><span class="o">&lt;</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="k">def</span> <span class="nf">V1</span>   <span class="p">:</span> <span class="n">Cpu0GPRReg</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">,</span>  <span class="s2">&quot;3&quot;</span><span class="o">&gt;</span><span class="p">,</span>    <span class="n">DwarfRegNum</span><span class="o">&lt;</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="k">def</span> <span class="nf">A0</span>   <span class="p">:</span> <span class="n">Cpu0GPRReg</span><span class="o">&lt;</span><span class="mi">4</span><span class="p">,</span>  <span class="s2">&quot;4&quot;</span><span class="o">&gt;</span><span class="p">,</span>    <span class="n">DwarfRegNum</span><span class="o">&lt;</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="k">def</span> <span class="nf">A1</span>   <span class="p">:</span> <span class="n">Cpu0GPRReg</span><span class="o">&lt;</span><span class="mi">5</span><span class="p">,</span>  <span class="s2">&quot;5&quot;</span><span class="o">&gt;</span><span class="p">,</span>    <span class="n">DwarfRegNum</span><span class="o">&lt;</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="k">def</span> <span class="nf">T9</span>   <span class="p">:</span> <span class="n">Cpu0GPRReg</span><span class="o">&lt;</span><span class="mi">6</span><span class="p">,</span>  <span class="s2">&quot;t9&quot;</span><span class="o">&gt;</span><span class="p">,</span>   <span class="n">DwarfRegNum</span><span class="o">&lt;</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="k">def</span> <span class="nf">T0</span>   <span class="p">:</span> <span class="n">Cpu0GPRReg</span><span class="o">&lt;</span><span class="mi">7</span><span class="p">,</span>  <span class="s2">&quot;7&quot;</span><span class="o">&gt;</span><span class="p">,</span>    <span class="n">DwarfRegNum</span><span class="o">&lt;</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="k">def</span> <span class="nf">T1</span>   <span class="p">:</span> <span class="n">Cpu0GPRReg</span><span class="o">&lt;</span><span class="mi">8</span><span class="p">,</span>  <span class="s2">&quot;8&quot;</span><span class="o">&gt;</span><span class="p">,</span>    <span class="n">DwarfRegNum</span><span class="o">&lt;</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="k">def</span> <span class="nf">S0</span>   <span class="p">:</span> <span class="n">Cpu0GPRReg</span><span class="o">&lt;</span><span class="mi">9</span><span class="p">,</span>  <span class="s2">&quot;9&quot;</span><span class="o">&gt;</span><span class="p">,</span>    <span class="n">DwarfRegNum</span><span class="o">&lt;</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="k">def</span> <span class="nf">S1</span>   <span class="p">:</span> <span class="n">Cpu0GPRReg</span><span class="o">&lt;</span><span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;10&quot;</span><span class="o">&gt;</span><span class="p">,</span>   <span class="n">DwarfRegNum</span><span class="o">&lt;</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="k">def</span> <span class="nf">GP</span>   <span class="p">:</span> <span class="n">Cpu0GPRReg</span><span class="o">&lt;</span><span class="mi">11</span><span class="p">,</span> <span class="s2">&quot;gp&quot;</span><span class="o">&gt;</span><span class="p">,</span>   <span class="n">DwarfRegNum</span><span class="o">&lt;</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="k">def</span> <span class="nf">FP</span>   <span class="p">:</span> <span class="n">Cpu0GPRReg</span><span class="o">&lt;</span><span class="mi">12</span><span class="p">,</span> <span class="s2">&quot;fp&quot;</span><span class="o">&gt;</span><span class="p">,</span>   <span class="n">DwarfRegNum</span><span class="o">&lt;</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="k">def</span> <span class="nf">SP</span>   <span class="p">:</span> <span class="n">Cpu0GPRReg</span><span class="o">&lt;</span><span class="mi">13</span><span class="p">,</span> <span class="s2">&quot;sp&quot;</span><span class="o">&gt;</span><span class="p">,</span>   <span class="n">DwarfRegNum</span><span class="o">&lt;</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="k">def</span> <span class="nf">LR</span>   <span class="p">:</span> <span class="n">Cpu0GPRReg</span><span class="o">&lt;</span><span class="mi">14</span><span class="p">,</span> <span class="s2">&quot;lr&quot;</span><span class="o">&gt;</span><span class="p">,</span>   <span class="n">DwarfRegNum</span><span class="o">&lt;</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="k">def</span> <span class="nf">SW</span>   <span class="p">:</span> <span class="n">Cpu0GPRReg</span><span class="o">&lt;</span><span class="mi">15</span><span class="p">,</span> <span class="s2">&quot;sw&quot;</span><span class="o">&gt;</span><span class="p">,</span>   <span class="n">DwarfRegNum</span><span class="o">&lt;</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
<span class="o">//</span>  <span class="k">def</span> <span class="nf">MAR</span>  <span class="p">:</span> <span class="n">Register</span><span class="o">&lt;</span> <span class="mi">16</span><span class="p">,</span> <span class="s2">&quot;mar&quot;</span><span class="o">&gt;</span><span class="p">,</span>  <span class="n">DwarfRegNum</span><span class="o">&lt;</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
<span class="o">//</span>  <span class="k">def</span> <span class="nf">MDR</span>  <span class="p">:</span> <span class="n">Register</span><span class="o">&lt;</span> <span class="mi">17</span><span class="p">,</span> <span class="s2">&quot;mdr&quot;</span><span class="o">&gt;</span><span class="p">,</span>  <span class="n">DwarfRegNum</span><span class="o">&lt;</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>

  <span class="k">def</span> <span class="nf">PC</span>   <span class="p">:</span> <span class="n">Cpu0C0Reg</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;pc&quot;</span><span class="o">&gt;</span><span class="p">,</span>  <span class="n">DwarfRegNum</span><span class="o">&lt;</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="k">def</span> <span class="nf">EPC</span>  <span class="p">:</span> <span class="n">Cpu0C0Reg</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;epc&quot;</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">DwarfRegNum</span><span class="o">&lt;</span><span class="p">[</span><span class="mi">21</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span><span class="nd">@Register</span> <span class="n">Classes</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="k">def</span> <span class="nf">CPURegs</span> <span class="p">:</span> <span class="n">RegisterClass</span><span class="o">&lt;</span><span class="s2">&quot;Cpu0&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">i32</span><span class="p">],</span> <span class="mi">32</span><span class="p">,</span> <span class="p">(</span><span class="n">add</span>
  <span class="o">//</span> <span class="n">Reserved</span>
  <span class="n">ZERO</span><span class="p">,</span> <span class="n">AT</span><span class="p">,</span> 
  <span class="o">//</span> <span class="n">Return</span> <span class="n">Values</span> <span class="ow">and</span> <span class="n">Arguments</span>
  <span class="n">V0</span><span class="p">,</span> <span class="n">V1</span><span class="p">,</span> <span class="n">A0</span><span class="p">,</span> <span class="n">A1</span><span class="p">,</span> 
  <span class="o">//</span> <span class="n">Not</span> <span class="n">preserved</span> <span class="n">across</span> <span class="n">procedure</span> <span class="n">calls</span>
  <span class="n">T9</span><span class="p">,</span> <span class="n">T0</span><span class="p">,</span> <span class="n">T1</span><span class="p">,</span>
  <span class="o">//</span> <span class="n">Callee</span> <span class="n">save</span>
  <span class="n">S0</span><span class="p">,</span> <span class="n">S1</span><span class="p">,</span>
  <span class="o">//</span> <span class="n">Reserved</span>
  <span class="n">GP</span><span class="p">,</span> <span class="n">FP</span><span class="p">,</span> 
  <span class="n">SP</span><span class="p">,</span> <span class="n">LR</span><span class="p">,</span> <span class="n">SW</span><span class="p">)</span><span class="o">&gt;</span><span class="p">;</span>

<span class="o">//</span><span class="nd">@Status</span> <span class="n">Registers</span> <span class="k">class</span>
<span class="nc">def</span> <span class="n">SR</span>     <span class="p">:</span> <span class="n">RegisterClass</span><span class="o">&lt;</span><span class="s2">&quot;Cpu0&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">i32</span><span class="p">],</span> <span class="mi">32</span><span class="p">,</span> <span class="p">(</span><span class="n">add</span> <span class="n">SW</span><span class="p">)</span><span class="o">&gt;</span><span class="p">;</span>

<span class="o">//</span><span class="nd">@Co</span><span class="o">-</span><span class="n">processor</span> <span class="mi">0</span> <span class="n">Registers</span> <span class="k">class</span>
<span class="nc">def</span> <span class="n">C0Regs</span> <span class="p">:</span> <span class="n">RegisterClass</span><span class="o">&lt;</span><span class="s2">&quot;Cpu0&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">i32</span><span class="p">],</span> <span class="mi">32</span><span class="p">,</span> <span class="p">(</span><span class="n">add</span> <span class="n">PC</span><span class="p">,</span> <span class="n">EPC</span><span class="p">)</span><span class="o">&gt;</span><span class="p">;</span>

</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter2/Cpu0RegisterInfoGPROutForOther.td</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>
<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span> <span class="n">Register</span> <span class="n">Classes</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="k">def</span> <span class="nf">GPROut</span> <span class="p">:</span> <span class="n">RegisterClass</span><span class="o">&lt;</span><span class="s2">&quot;Cpu0&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">i32</span><span class="p">],</span> <span class="mi">32</span><span class="p">,</span> <span class="p">(</span><span class="n">add</span> <span class="p">(</span><span class="n">sub</span> <span class="n">CPURegs</span><span class="p">,</span> <span class="n">SW</span><span class="p">))</span><span class="o">&gt;</span><span class="p">;</span>

</pre></div>
</div>
<p>In C++, class typically provides a structure to lay out some data and functions,
while definitions are used to allocate memory for specific instances of a class.
For example:</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Date</span> <span class="p">{</span>  <span class="c1">// declare Date</span>
  <span class="kt">int</span> <span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">;</span>
<span class="p">};</span>
<span class="n">Date</span> <span class="n">birthday</span><span class="p">;</span>  <span class="c1">// define birthday, an instance of Date</span>
</pre></div>
</div>
<p>The class <strong>Date</strong> has the members <strong>year</strong>, <strong>month</strong>, and <strong>day</strong>, however
these do not yet belong to an actual object.
By defining an instance of <strong>Date</strong> called <strong>birthday</strong>, you have allocated
memory for a specific object, and can set the <strong>year</strong>, <strong>month</strong>, and
<strong>day</strong> of this instance of the class.</p>
<p>In .td files, class describes the structure of how data is laid out, while
definitions act as the specific instances of the class.
If we look back at the Cpu0RegisterInfo.td file, we see a class called
<strong>Cpu0Reg</strong> which is derived from the <strong>Register</strong> class provided
by LLVM.  <strong>Cpu0Reg</strong> inherits all the fields that exist
in the <strong>Register</strong> class. The &#8220;let HWEncoding = Enc&#8221; which meaning assign field
HWEncoding from parameter Enc. Since Cpu0 reserve 4 bits for 16 registers in
instruction format, the assigned value range is from 0 to 15. Assign the 0 to 15
to HWEncoding, then the backend register number can be gotten from the function
of llvm register class since TableGen will set this number correctly.</p>
<p>The <strong>def</strong> keyword is used to create instances of class.
In the following line, the ZERO register is defined as a member of the
<strong>Cpu0GPRReg</strong> class:</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="n">def</span> <span class="nl">ZERO</span> <span class="p">:</span> <span class="n">Cpu0GPRReg</span><span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;ZERO&quot;</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">DwarfRegNum</span><span class="o">&lt;</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<p>The <strong>def ZERO</strong> indicates the name of this register.  <strong>&lt;0, &#8220;ZERO&#8221;&gt;</strong> are the
parameters used when creating this specific instance of the <strong>Cpu0GPRReg</strong>
class, thus the field <strong>Enc</strong> is set to 0, and the string <strong>n</strong> is set
to <strong>ZERO</strong>.</p>
<p>As the register lives in the <strong>Cpu0</strong> namespace, you can refer to the ZERO
register in C++ code in a backend using <strong>Cpu0::ZERO</strong>.</p>
<p>Notice the use of the <strong>let</strong> expressions: these allow you to override values
that are initially defined in a superclass.
For example, <strong>let Namespace = “Cpu0”</strong> in the <strong>Cpu0Reg</strong> class will override
the default namespace declared in <strong>Register</strong> class.
The Cpu0RegisterInfo.td also defines that <strong>CPURegs</strong> is an instance of the
class <strong>RegisterClass</strong>, which is an built-in LLVM class.
A <strong>RegisterClass</strong> is a set of <strong>Register</strong> instances, thus <strong>CPURegs</strong> can be
described as a set of registers.</p>
<p>The Cpu0 instructions td is named to Cpu0InstrInfo.td which contents as follows,</p>
<p class="rubric">lbdex/chapters/Chapter2/Cpu0InstrInfo.td</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>//===- Cpu0InstrInfo.td - Target Description for Cpu0 Target -*- tablegen -*-=//
//
//                     The LLVM Compiler Infrastructure
//
// This file is distributed under the University of Illinois Open Source
// License. See LICENSE.TXT for details.
//
//===----------------------------------------------------------------------===//
//
// This file contains the Cpu0 implementation of the TargetInstrInfo class.
//
//===----------------------------------------------------------------------===//

//===----------------------------------------------------------------------===//
// Cpu0 profiles and nodes
//===----------------------------------------------------------------------===//

def SDT_Cpu0Ret          : SDTypeProfile&lt;0, 1, [SDTCisInt&lt;0&gt;]&gt;;

// Return
def Cpu0Ret : SDNode&lt;&quot;Cpu0ISD::Ret&quot;, SDTNone,
                     [SDNPHasChain, SDNPOptInGlue, SDNPVariadic]&gt;;

//===----------------------------------------------------------------------===//
// Instruction format superclass
//===----------------------------------------------------------------------===//

include &quot;Cpu0InstrFormats.td&quot;

//===----------------------------------------------------------------------===//
// Cpu0 Operand, Complex Patterns and Transformations Definitions.
//===----------------------------------------------------------------------===//
// Instruction operand types

// Signed Operand
def simm16      : Operand&lt;i32&gt; {
  let DecoderMethod= &quot;DecodeSimm16&quot;;
}

// Address operand
def mem : Operand&lt;iPTR&gt; {
  let PrintMethod = &quot;printMemOperand&quot;;
  let MIOperandInfo = (ops CPURegs, simm16);
  let EncoderMethod = &quot;getMemEncoding&quot;;
}

// Node immediate fits as 16-bit sign extended on target immediate.
// e.g. addi, andi
def immSExt16  : PatLeaf&lt;(imm), [{ return isInt&lt;16&gt;(N-&gt;getSExtValue()); }]&gt;;

// Cpu0 Address Mode! SDNode frameindex could possibily be a match
// since load and store instructions from stack used it.
def addr : 
  ComplexPattern&lt;iPTR, 2, &quot;SelectAddr&quot;, [frameindex], [SDNPWantParent]&gt;;

//===----------------------------------------------------------------------===//
// Pattern fragment for load/store
//===----------------------------------------------------------------------===//

class AlignedLoad&lt;PatFrag Node&gt; :
  PatFrag&lt;(ops node:$ptr), (Node node:$ptr), [{
  LoadSDNode *LD = cast&lt;LoadSDNode&gt;(N);
  return LD-&gt;getMemoryVT().getSizeInBits()/8 &lt;= LD-&gt;getAlignment();
}]&gt;;

class AlignedStore&lt;PatFrag Node&gt; :
  PatFrag&lt;(ops node:$val, node:$ptr), (Node node:$val, node:$ptr), [{
  StoreSDNode *SD = cast&lt;StoreSDNode&gt;(N);
  return SD-&gt;getMemoryVT().getSizeInBits()/8 &lt;= SD-&gt;getAlignment();
}]&gt;;

// Load/Store PatFrags.
def load_a          : AlignedLoad&lt;load&gt;;
def store_a         : AlignedStore&lt;store&gt;;

//===----------------------------------------------------------------------===//
// Instructions specific format
//===----------------------------------------------------------------------===//

// Arithmetic and logical instructions with 2 register operands.
class ArithLogicI&lt;bits&lt;8&gt; op, string instr_asm, SDNode OpNode,
                  Operand Od, PatLeaf imm_type, RegisterClass RC&gt; :
  FL&lt;op, (outs GPROut:$ra), (ins RC:$rb, Od:$imm16),
     !strconcat(instr_asm, &quot;\t$ra, $rb, $imm16&quot;),
     [(set GPROut:$ra, (OpNode RC:$rb, imm_type:$imm16))], IIAlu&gt; {
  let isReMaterializable = 1;
}

class FMem&lt;bits&lt;8&gt; op, dag outs, dag ins, string asmstr, list&lt;dag&gt; pattern,
          InstrItinClass itin&gt;: FL&lt;op, outs, ins, asmstr, pattern, itin&gt; {
  bits&lt;20&gt; addr;
  let Inst{19-16} = addr{19-16};
  let Inst{15-0}  = addr{15-0};
  let DecoderMethod = &quot;DecodeMem&quot;;
}

// Memory Load/Store
let canFoldAsLoad = 1 in
class LoadM&lt;bits&lt;8&gt; op, string instr_asm, PatFrag OpNode, RegisterClass RC,
            Operand MemOpnd, bit Pseudo&gt;:
  FMem&lt;op, (outs RC:$ra), (ins MemOpnd:$addr),
     !strconcat(instr_asm, &quot;\t$ra, $addr&quot;),
     [(set RC:$ra, (OpNode addr:$addr))], IILoad&gt; {
  let isPseudo = Pseudo;
}

class StoreM&lt;bits&lt;8&gt; op, string instr_asm, PatFrag OpNode, RegisterClass RC,
             Operand MemOpnd, bit Pseudo&gt;:
  FMem&lt;op, (outs), (ins RC:$ra, MemOpnd:$addr),
     !strconcat(instr_asm, &quot;\t$ra, $addr&quot;),
     [(OpNode RC:$ra, addr:$addr)], IIStore&gt; {
  let isPseudo = Pseudo;
}

//@ 32-bit load.
multiclass LoadM32&lt;bits&lt;8&gt; op, string instr_asm, PatFrag OpNode,
                   bit Pseudo = 0&gt; {
  def #NAME# : LoadM&lt;op, instr_asm, OpNode, GPROut, mem, Pseudo&gt;;
}

// 32-bit store.
multiclass StoreM32&lt;bits&lt;8&gt; op, string instr_asm, PatFrag OpNode,
                    bit Pseudo = 0&gt; {
  def #NAME# : StoreM&lt;op, instr_asm, OpNode, CPURegs, mem, Pseudo&gt;;
}

//@JumpFR {
let isBranch=1, isTerminator=1, isBarrier=1, imm16=0, hasDelaySlot = 1,
    isIndirectBranch = 1 in
class JumpFR&lt;bits&lt;8&gt; op, string instr_asm, RegisterClass RC&gt;:
  FL&lt;op, (outs), (ins RC:$ra),
     !strconcat(instr_asm, &quot;\t$ra&quot;), [(brind RC:$ra)], IIBranch&gt; {
  let rb = 0;
  let imm16 = 0;
}
//@JumpFR }

// Return instruction
class RetBase&lt;RegisterClass RC&gt;: JumpFR&lt;0x3c, &quot;ret&quot;, RC&gt; {
  let isReturn = 1;
  let isCodeGenOnly = 1;
  let hasCtrlDep = 1;
  let hasExtraSrcRegAllocReq = 1;
}

  
//===----------------------------------------------------------------------===//
// Instruction definition
//===----------------------------------------------------------------------===//

//===----------------------------------------------------------------------===//
// Cpu0 Instructions
//===----------------------------------------------------------------------===//

/// Load and Store Instructions
///  aligned
defm LD     : LoadM32&lt;0x01,  &quot;ld&quot;,  load_a&gt;;
defm ST     : StoreM32&lt;0x02, &quot;st&quot;,  store_a&gt;;

/// Arithmetic Instructions (ALU Immediate)
// IR &quot;add&quot; defined in include/llvm/Target/TargetSelectionDAG.td, line 315 (def add).
def ADDiu   : ArithLogicI&lt;0x09, &quot;addiu&quot;, add, simm16, immSExt16, CPURegs&gt;;

/// Arithmetic Instructions (3-Operand, R-Type)

/// Shift Instructions

def JR      : JumpFR&lt;0x3c, &quot;jr&quot;, GPROut&gt;;

def RET     : RetBase&lt;GPROut&gt;;

/// No operation
let addr=0 in
  def NOP   : FJ&lt;0, (outs), (ins), &quot;nop&quot;, [], IIAlu&gt;;

//===----------------------------------------------------------------------===//
//  Arbitrary patterns that map to one or more instructions
//===----------------------------------------------------------------------===//

// Small immediates
def : Pat&lt;(i32 immSExt16:$in),
          (ADDiu ZERO, imm:$in)&gt;;

</pre></div>
</div>
<p>The Cpu0InstrFormats.td is included by Cpu0InstInfo.td as follows,</p>
<p class="rubric">lbdex/chapters/Chapter2/Cpu0InstrFormats.td</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">//===--</span> <span class="n">Cpu0InstrFormats</span><span class="o">.</span><span class="n">td</span> <span class="o">-</span> <span class="n">Cpu0</span> <span class="n">Instruction</span> <span class="n">Formats</span> <span class="o">-----*-</span> <span class="n">tablegen</span> <span class="o">-*-===//</span>
<span class="o">//</span>
<span class="o">//</span>                     <span class="n">The</span> <span class="n">LLVM</span> <span class="n">Compiler</span> <span class="n">Infrastructure</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="ow">is</span> <span class="n">distributed</span> <span class="n">under</span> <span class="n">the</span> <span class="n">University</span> <span class="n">of</span> <span class="n">Illinois</span> <span class="n">Open</span> <span class="n">Source</span>
<span class="o">//</span> <span class="n">License</span><span class="o">.</span> <span class="n">See</span> <span class="n">LICENSE</span><span class="o">.</span><span class="n">TXT</span> <span class="k">for</span> <span class="n">details</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span>  <span class="n">Describe</span> <span class="n">CPU0</span> <span class="n">instructions</span> <span class="nb">format</span>
<span class="o">//</span>
<span class="o">//</span>  <span class="n">CPU</span> <span class="n">INSTRUCTION</span> <span class="n">FORMATS</span>
<span class="o">//</span>
<span class="o">//</span>  <span class="n">opcode</span>  <span class="o">-</span> <span class="n">operation</span> <span class="n">code</span><span class="o">.</span>
<span class="o">//</span>  <span class="n">ra</span>      <span class="o">-</span> <span class="n">dst</span> <span class="n">reg</span><span class="p">,</span> <span class="n">only</span> <span class="n">used</span> <span class="n">on</span> <span class="mi">3</span> <span class="n">regs</span> <span class="n">instr</span><span class="o">.</span>
<span class="o">//</span>  <span class="n">rb</span>      <span class="o">-</span> <span class="n">src</span> <span class="n">reg</span><span class="o">.</span>
<span class="o">//</span>  <span class="n">rc</span>      <span class="o">-</span> <span class="n">src</span> <span class="n">reg</span> <span class="p">(</span><span class="n">on</span> <span class="n">a</span> <span class="mi">3</span> <span class="n">reg</span> <span class="n">instr</span><span class="p">)</span><span class="o">.</span>
<span class="o">//</span>  <span class="n">cx</span>      <span class="o">-</span> <span class="n">immediate</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="o">//</span> <span class="n">Format</span> <span class="n">specifies</span> <span class="n">the</span> <span class="n">encoding</span> <span class="n">used</span> <span class="n">by</span> <span class="n">the</span> <span class="n">instruction</span><span class="o">.</span>  <span class="n">This</span> <span class="ow">is</span> <span class="n">part</span> <span class="n">of</span> <span class="n">the</span>
<span class="o">//</span> <span class="n">ad</span><span class="o">-</span><span class="n">hoc</span> <span class="n">solution</span> <span class="n">used</span> <span class="n">to</span> <span class="n">emit</span> <span class="n">machine</span> <span class="n">instruction</span> <span class="n">encodings</span> <span class="n">by</span> <span class="n">our</span> <span class="n">machine</span>
<span class="o">//</span> <span class="n">code</span> <span class="n">emitter</span><span class="o">.</span>
<span class="k">class</span> <span class="nc">Format</span><span class="o">&lt;</span><span class="n">bits</span><span class="o">&lt;</span><span class="mi">4</span><span class="o">&gt;</span> <span class="n">val</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="n">bits</span><span class="o">&lt;</span><span class="mi">4</span><span class="o">&gt;</span> <span class="n">Value</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">def</span> <span class="nf">Pseudo</span>    <span class="p">:</span> <span class="n">Format</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">FrmA</span>      <span class="p">:</span> <span class="n">Format</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">FrmL</span>      <span class="p">:</span> <span class="n">Format</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">FrmJ</span>      <span class="p">:</span> <span class="n">Format</span><span class="o">&lt;</span><span class="mi">3</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">FrmOther</span>  <span class="p">:</span> <span class="n">Format</span><span class="o">&lt;</span><span class="mi">4</span><span class="o">&gt;</span><span class="p">;</span> <span class="o">//</span> <span class="n">Instruction</span> <span class="n">w</span><span class="o">/</span> <span class="n">a</span> <span class="n">custom</span> <span class="nb">format</span>

<span class="o">//</span> <span class="n">Generic</span> <span class="n">Cpu0</span> <span class="n">Format</span>
<span class="k">class</span> <span class="nc">Cpu0Inst</span><span class="o">&lt;</span><span class="n">dag</span> <span class="n">outs</span><span class="p">,</span> <span class="n">dag</span> <span class="n">ins</span><span class="p">,</span> <span class="n">string</span> <span class="n">asmstr</span><span class="p">,</span> <span class="nb">list</span><span class="o">&lt;</span><span class="n">dag</span><span class="o">&gt;</span> <span class="n">pattern</span><span class="p">,</span>
               <span class="n">InstrItinClass</span> <span class="n">itin</span><span class="p">,</span> <span class="n">Format</span> <span class="n">f</span><span class="o">&gt;</span><span class="p">:</span> <span class="n">Instruction</span>
<span class="p">{</span>
  <span class="n">field</span> <span class="n">bits</span><span class="o">&lt;</span><span class="mi">32</span><span class="o">&gt;</span> <span class="n">Inst</span><span class="p">;</span>
  <span class="n">Format</span> <span class="n">Form</span> <span class="o">=</span> <span class="n">f</span><span class="p">;</span>

  <span class="n">let</span> <span class="n">Namespace</span> <span class="o">=</span> <span class="s2">&quot;Cpu0&quot;</span><span class="p">;</span>

  <span class="n">let</span> <span class="n">Size</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

  <span class="n">bits</span><span class="o">&lt;</span><span class="mi">8</span><span class="o">&gt;</span> <span class="n">Opcode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="o">//</span> <span class="n">Top</span> <span class="mi">8</span> <span class="n">bits</span> <span class="n">are</span> <span class="n">the</span> <span class="s1">&#39;opcode&#39;</span> <span class="n">field</span>
  <span class="n">let</span> <span class="n">Inst</span><span class="p">{</span><span class="mi">31</span><span class="o">-</span><span class="mi">24</span><span class="p">}</span> <span class="o">=</span> <span class="n">Opcode</span><span class="p">;</span>

  <span class="n">let</span> <span class="n">OutOperandList</span> <span class="o">=</span> <span class="n">outs</span><span class="p">;</span>
  <span class="n">let</span> <span class="n">InOperandList</span>  <span class="o">=</span> <span class="n">ins</span><span class="p">;</span>

  <span class="n">let</span> <span class="n">AsmString</span>   <span class="o">=</span> <span class="n">asmstr</span><span class="p">;</span>
  <span class="n">let</span> <span class="n">Pattern</span>     <span class="o">=</span> <span class="n">pattern</span><span class="p">;</span>
  <span class="n">let</span> <span class="n">Itinerary</span>   <span class="o">=</span> <span class="n">itin</span><span class="p">;</span>

  <span class="o">//</span>
  <span class="o">//</span> <span class="n">Attributes</span> <span class="n">specific</span> <span class="n">to</span> <span class="n">Cpu0</span> <span class="n">instructions</span><span class="o">...</span>
  <span class="o">//</span>
  <span class="n">bits</span><span class="o">&lt;</span><span class="mi">4</span><span class="o">&gt;</span> <span class="n">FormBits</span> <span class="o">=</span> <span class="n">Form</span><span class="o">.</span><span class="n">Value</span><span class="p">;</span>

  <span class="o">//</span> <span class="n">TSFlags</span> <span class="n">layout</span> <span class="n">should</span> <span class="n">be</span> <span class="n">kept</span> <span class="ow">in</span> <span class="n">sync</span> <span class="k">with</span> <span class="n">Cpu0InstrInfo</span><span class="o">.</span><span class="n">h</span><span class="o">.</span>
  <span class="n">let</span> <span class="n">TSFlags</span><span class="p">{</span><span class="mi">3</span><span class="o">-</span><span class="mi">0</span><span class="p">}</span>   <span class="o">=</span> <span class="n">FormBits</span><span class="p">;</span>

  <span class="n">let</span> <span class="n">DecoderNamespace</span> <span class="o">=</span> <span class="s2">&quot;Cpu0&quot;</span><span class="p">;</span>

  <span class="n">field</span> <span class="n">bits</span><span class="o">&lt;</span><span class="mi">32</span><span class="o">&gt;</span> <span class="n">SoftFail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span> <span class="n">Format</span> <span class="n">A</span> <span class="n">instruction</span> <span class="k">class</span> <span class="nc">in</span> <span class="n">Cpu0</span> <span class="p">:</span> <span class="o">&lt;|</span><span class="n">opcode</span><span class="o">|</span><span class="n">ra</span><span class="o">|</span><span class="n">rb</span><span class="o">|</span><span class="n">rc</span><span class="o">|</span><span class="n">cx</span><span class="o">|&gt;</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="k">class</span> <span class="nc">FA</span><span class="o">&lt;</span><span class="n">bits</span><span class="o">&lt;</span><span class="mi">8</span><span class="o">&gt;</span> <span class="n">op</span><span class="p">,</span> <span class="n">dag</span> <span class="n">outs</span><span class="p">,</span> <span class="n">dag</span> <span class="n">ins</span><span class="p">,</span> <span class="n">string</span> <span class="n">asmstr</span><span class="p">,</span>
         <span class="nb">list</span><span class="o">&lt;</span><span class="n">dag</span><span class="o">&gt;</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">InstrItinClass</span> <span class="n">itin</span><span class="o">&gt;</span><span class="p">:</span>
      <span class="n">Cpu0Inst</span><span class="o">&lt;</span><span class="n">outs</span><span class="p">,</span> <span class="n">ins</span><span class="p">,</span> <span class="n">asmstr</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">itin</span><span class="p">,</span> <span class="n">FrmA</span><span class="o">&gt;</span>
<span class="p">{</span>
  <span class="n">bits</span><span class="o">&lt;</span><span class="mi">4</span><span class="o">&gt;</span>  <span class="n">ra</span><span class="p">;</span>
  <span class="n">bits</span><span class="o">&lt;</span><span class="mi">4</span><span class="o">&gt;</span>  <span class="n">rb</span><span class="p">;</span>
  <span class="n">bits</span><span class="o">&lt;</span><span class="mi">4</span><span class="o">&gt;</span>  <span class="n">rc</span><span class="p">;</span>
  <span class="n">bits</span><span class="o">&lt;</span><span class="mi">12</span><span class="o">&gt;</span> <span class="n">shamt</span><span class="p">;</span>

  <span class="n">let</span> <span class="n">Opcode</span> <span class="o">=</span> <span class="n">op</span><span class="p">;</span>

  <span class="n">let</span> <span class="n">Inst</span><span class="p">{</span><span class="mi">23</span><span class="o">-</span><span class="mi">20</span><span class="p">}</span> <span class="o">=</span> <span class="n">ra</span><span class="p">;</span>
  <span class="n">let</span> <span class="n">Inst</span><span class="p">{</span><span class="mi">19</span><span class="o">-</span><span class="mi">16</span><span class="p">}</span> <span class="o">=</span> <span class="n">rb</span><span class="p">;</span>
  <span class="n">let</span> <span class="n">Inst</span><span class="p">{</span><span class="mi">15</span><span class="o">-</span><span class="mi">12</span><span class="p">}</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>
  <span class="n">let</span> <span class="n">Inst</span><span class="p">{</span><span class="mi">11</span><span class="o">-</span><span class="mi">0</span><span class="p">}</span>  <span class="o">=</span> <span class="n">shamt</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">//</span><span class="nd">@class</span> <span class="n">FL</span> <span class="p">{</span>
<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span> <span class="n">Format</span> <span class="n">L</span> <span class="n">instruction</span> <span class="k">class</span> <span class="nc">in</span> <span class="n">Cpu0</span> <span class="p">:</span> <span class="o">&lt;|</span><span class="n">opcode</span><span class="o">|</span><span class="n">ra</span><span class="o">|</span><span class="n">rb</span><span class="o">|</span><span class="n">cx</span><span class="o">|&gt;</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="k">class</span> <span class="nc">FL</span><span class="o">&lt;</span><span class="n">bits</span><span class="o">&lt;</span><span class="mi">8</span><span class="o">&gt;</span> <span class="n">op</span><span class="p">,</span> <span class="n">dag</span> <span class="n">outs</span><span class="p">,</span> <span class="n">dag</span> <span class="n">ins</span><span class="p">,</span> <span class="n">string</span> <span class="n">asmstr</span><span class="p">,</span> <span class="nb">list</span><span class="o">&lt;</span><span class="n">dag</span><span class="o">&gt;</span> <span class="n">pattern</span><span class="p">,</span>
         <span class="n">InstrItinClass</span> <span class="n">itin</span><span class="o">&gt;</span><span class="p">:</span> <span class="n">Cpu0Inst</span><span class="o">&lt;</span><span class="n">outs</span><span class="p">,</span> <span class="n">ins</span><span class="p">,</span> <span class="n">asmstr</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">itin</span><span class="p">,</span> <span class="n">FrmL</span><span class="o">&gt;</span>
<span class="p">{</span>
  <span class="n">bits</span><span class="o">&lt;</span><span class="mi">4</span><span class="o">&gt;</span>  <span class="n">ra</span><span class="p">;</span>
  <span class="n">bits</span><span class="o">&lt;</span><span class="mi">4</span><span class="o">&gt;</span>  <span class="n">rb</span><span class="p">;</span>
  <span class="n">bits</span><span class="o">&lt;</span><span class="mi">16</span><span class="o">&gt;</span> <span class="n">imm16</span><span class="p">;</span>

  <span class="n">let</span> <span class="n">Opcode</span> <span class="o">=</span> <span class="n">op</span><span class="p">;</span>

  <span class="n">let</span> <span class="n">Inst</span><span class="p">{</span><span class="mi">23</span><span class="o">-</span><span class="mi">20</span><span class="p">}</span> <span class="o">=</span> <span class="n">ra</span><span class="p">;</span>
  <span class="n">let</span> <span class="n">Inst</span><span class="p">{</span><span class="mi">19</span><span class="o">-</span><span class="mi">16</span><span class="p">}</span> <span class="o">=</span> <span class="n">rb</span><span class="p">;</span>
  <span class="n">let</span> <span class="n">Inst</span><span class="p">{</span><span class="mi">15</span><span class="o">-</span><span class="mi">0</span><span class="p">}</span>  <span class="o">=</span> <span class="n">imm16</span><span class="p">;</span>
<span class="p">}</span>
<span class="o">//</span><span class="nd">@class</span> <span class="n">FL</span> <span class="p">}</span>

<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span> <span class="n">Format</span> <span class="n">J</span> <span class="n">instruction</span> <span class="k">class</span> <span class="nc">in</span> <span class="n">Cpu0</span> <span class="p">:</span> <span class="o">&lt;|</span><span class="n">opcode</span><span class="o">|</span><span class="n">address</span><span class="o">|&gt;</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="k">class</span> <span class="nc">FJ</span><span class="o">&lt;</span><span class="n">bits</span><span class="o">&lt;</span><span class="mi">8</span><span class="o">&gt;</span> <span class="n">op</span><span class="p">,</span> <span class="n">dag</span> <span class="n">outs</span><span class="p">,</span> <span class="n">dag</span> <span class="n">ins</span><span class="p">,</span> <span class="n">string</span> <span class="n">asmstr</span><span class="p">,</span> <span class="nb">list</span><span class="o">&lt;</span><span class="n">dag</span><span class="o">&gt;</span> <span class="n">pattern</span><span class="p">,</span>
         <span class="n">InstrItinClass</span> <span class="n">itin</span><span class="o">&gt;</span><span class="p">:</span> <span class="n">Cpu0Inst</span><span class="o">&lt;</span><span class="n">outs</span><span class="p">,</span> <span class="n">ins</span><span class="p">,</span> <span class="n">asmstr</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">itin</span><span class="p">,</span> <span class="n">FrmJ</span><span class="o">&gt;</span>
<span class="p">{</span>
  <span class="n">bits</span><span class="o">&lt;</span><span class="mi">24</span><span class="o">&gt;</span> <span class="n">addr</span><span class="p">;</span>

  <span class="n">let</span> <span class="n">Opcode</span> <span class="o">=</span> <span class="n">op</span><span class="p">;</span>

  <span class="n">let</span> <span class="n">Inst</span><span class="p">{</span><span class="mi">23</span><span class="o">-</span><span class="mi">0</span><span class="p">}</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
<span class="p">}</span>

</pre></div>
</div>
<p>ADDiu is a instance of class ArithLogicI which inherited from FL, and can be
expanded and get member value further as follows,</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span>def ADDiu   : ArithLogicI&lt;0x09, &quot;addiu&quot;, add, simm16, immSExt16, CPURegs&gt;;

/// Arithmetic and logical instructions with 2 register operands.
class ArithLogicI&lt;bits&lt;8&gt; op, string instr_asm, SDNode OpNode,
          Operand Od, PatLeaf imm_type, RegisterClass RC&gt; :
  FL&lt;op, (outs GPROut:$ra), (ins RC:$rb, Od:$imm16),
   !strconcat(instr_asm, &quot;\t$ra, $rb, $imm16&quot;),
   [(set GPROut:$ra, (OpNode RC:$rb, imm_type:$imm16))], IIAlu&gt; {
  let isReMaterializable = 1;
}
</pre></div>
</div>
<p>So,</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span>op = 0x09
instr_asm = “addiu”
OpNode = add
Od = simm16
imm_type = immSExt16
RC = CPURegs
</pre></div>
</div>
<p>To expand the td, some principles are:</p>
<ul>
<li><p class="first">let: meaning override the existed field from parent class.</p>
<p>For instance: let isReMaterializable = 1; override the isReMaterializable
from class instruction of Target.td.</p>
</li>
<li><p class="first">declaration: meaning declare a new field for this class.</p>
<p>For instance: bits&lt;4&gt;  ra; declare ra field for class FL.</p>
</li>
</ul>
<p>The details of expanding as the following table:</p>
<table border="1" class="docutils" id="id51">
<caption><span class="caption-number">Table 8 </span><span class="caption-text">ADDiu expand part I</span><a class="headerlink" href="#id51" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="25%" />
<col width="64%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">ADDiu</th>
<th class="head">ArithLogicI</th>
<th class="head">FL</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>0x09</td>
<td>op = 0x09</td>
<td>Opcode = 0x09;</td>
</tr>
<tr class="row-odd"><td>addiu</td>
<td>instr_asm = “addiu”</td>
<td>(outs GPROut:$ra);
!strconcat(&#8220;addiu&#8221;, &#8220;t$ra, $rb, $imm16&#8221;);</td>
</tr>
<tr class="row-even"><td>add</td>
<td>OpNode = add</td>
<td>[(set GPROut:$ra, (add CPURegs:$rb, immSExt16:$imm16))]</td>
</tr>
<tr class="row-odd"><td>simm16</td>
<td>Od = simm16</td>
<td>(ins CPURegs:$rb, simm16:$imm16);</td>
</tr>
<tr class="row-even"><td>immSExt16</td>
<td>imm_type = immSExt16</td>
<td>Inst{15-0} = imm16;</td>
</tr>
<tr class="row-odd"><td>CPURegs</td>
<td>RC = CPURegs
isReMaterializable=1;</td>
<td>Inst{23-20} = ra;
Inst{19-16} = rb;</td>
</tr>
</tbody>
</table>
<table border="1" class="docutils" id="id52">
<caption><span class="caption-number">Table 9 </span><span class="caption-text">ADDiu expand part II</span><a class="headerlink" href="#id52" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="74%" />
<col width="26%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Cpu0Inst</th>
<th class="head">instruction</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Namespace = &#8220;Cpu0&#8221;</td>
<td>Uses = []; ...</td>
</tr>
<tr class="row-odd"><td>Inst{31-24} = 0x09;</td>
<td>Size = 0; ...</td>
</tr>
<tr class="row-even"><td>OutOperandList = GPROut:$ra;</td>
<td>&nbsp;</td>
</tr>
<tr class="row-odd"><td>InOperandList  = CPURegs:$rb,simm16:$imm16;</td>
<td>&nbsp;</td>
</tr>
<tr class="row-even"><td>AsmString = &#8220;addiut$ra, $rb, $imm16&#8221;</td>
<td>&nbsp;</td>
</tr>
<tr class="row-odd"><td>pattern = [(set GPROut:$ra, (add RC:$rb, immSExt16:$imm16))]</td>
<td>&nbsp;</td>
</tr>
<tr class="row-even"><td>Itinerary = IIAlu</td>
<td>&nbsp;</td>
</tr>
<tr class="row-odd"><td>TSFlags{3-0} = FrmL.value</td>
<td>&nbsp;</td>
</tr>
<tr class="row-even"><td>DecoderNamespace = &#8220;Cpu0&#8221;</td>
<td>&nbsp;</td>
</tr>
</tbody>
</table>
<p>The td expanding is a lousy process.
Similarly, LD and ST instruction definition can be expanded in this way.
Please notice the Pattern =
[(set GPROut:$ra, (add RC:$rb, immSExt16:$imm16))] which include keyword
<strong>“add”</strong>.
The ADDiu with <strong>“add”</strong> is used in sub-section Instruction Selection of last
section.</p>
<p>File Cpu0Schedule.td include the function units and pipeline stages information
as follows,</p>
<p class="rubric">lbdex/chapters/Chapter2/Cpu0Schedule.td</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">//===--</span> <span class="n">Cpu0Schedule</span><span class="o">.</span><span class="n">td</span> <span class="o">-</span> <span class="n">Cpu0</span> <span class="n">Scheduling</span> <span class="n">Definitions</span> <span class="o">------*-</span> <span class="n">tablegen</span> <span class="o">-*-===//</span>
<span class="o">//</span>
<span class="o">//</span>                     <span class="n">The</span> <span class="n">LLVM</span> <span class="n">Compiler</span> <span class="n">Infrastructure</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="ow">is</span> <span class="n">distributed</span> <span class="n">under</span> <span class="n">the</span> <span class="n">University</span> <span class="n">of</span> <span class="n">Illinois</span> <span class="n">Open</span> <span class="n">Source</span>
<span class="o">//</span> <span class="n">License</span><span class="o">.</span> <span class="n">See</span> <span class="n">LICENSE</span><span class="o">.</span><span class="n">TXT</span> <span class="k">for</span> <span class="n">details</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span> <span class="n">Functional</span> <span class="n">units</span> <span class="n">across</span> <span class="n">Cpu0</span> <span class="n">chips</span> <span class="n">sets</span><span class="o">.</span> <span class="n">Based</span> <span class="n">on</span> <span class="n">GCC</span><span class="o">/</span><span class="n">Cpu0</span> <span class="n">backend</span> <span class="n">files</span><span class="o">.</span>
<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="k">def</span> <span class="nf">ALU</span>     <span class="p">:</span> <span class="n">FuncUnit</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">IMULDIV</span> <span class="p">:</span> <span class="n">FuncUnit</span><span class="p">;</span>

<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span> <span class="n">Instruction</span> <span class="n">Itinerary</span> <span class="n">classes</span> <span class="n">used</span> <span class="k">for</span> <span class="n">Cpu0</span>
<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="k">def</span> <span class="nf">IIAlu</span>              <span class="p">:</span> <span class="n">InstrItinClass</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">II_CLO</span>             <span class="p">:</span> <span class="n">InstrItinClass</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">II_CLZ</span>             <span class="p">:</span> <span class="n">InstrItinClass</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">IILoad</span>             <span class="p">:</span> <span class="n">InstrItinClass</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">IIStore</span>            <span class="p">:</span> <span class="n">InstrItinClass</span><span class="p">;</span>
<span class="k">def</span> <span class="nf">IIBranch</span>           <span class="p">:</span> <span class="n">InstrItinClass</span><span class="p">;</span>

<span class="k">def</span> <span class="nf">IIPseudo</span>           <span class="p">:</span> <span class="n">InstrItinClass</span><span class="p">;</span>

<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span> <span class="n">Cpu0</span> <span class="n">Generic</span> <span class="n">instruction</span> <span class="n">itineraries</span><span class="o">.</span>
<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//@</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">llvm</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">docs</span><span class="o">/</span><span class="n">doxygen</span><span class="o">/</span><span class="n">html</span><span class="o">/</span><span class="n">structllvm_1_1InstrStage</span><span class="o">.</span><span class="n">html</span>
<span class="k">def</span> <span class="nf">Cpu0GenericItineraries</span> <span class="p">:</span> <span class="n">ProcessorItineraries</span><span class="o">&lt;</span><span class="p">[</span><span class="n">ALU</span><span class="p">,</span> <span class="n">IMULDIV</span><span class="p">],</span> <span class="p">[],</span> <span class="p">[</span>
<span class="o">//</span><span class="nd">@2</span>
  <span class="n">InstrItinData</span><span class="o">&lt;</span><span class="n">IIAlu</span>              <span class="p">,</span> <span class="p">[</span><span class="n">InstrStage</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span>  <span class="p">[</span><span class="n">ALU</span><span class="p">]</span><span class="o">&gt;</span><span class="p">]</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="n">InstrItinData</span><span class="o">&lt;</span><span class="n">II_CLO</span>             <span class="p">,</span> <span class="p">[</span><span class="n">InstrStage</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span>  <span class="p">[</span><span class="n">ALU</span><span class="p">]</span><span class="o">&gt;</span><span class="p">]</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="n">InstrItinData</span><span class="o">&lt;</span><span class="n">II_CLZ</span>             <span class="p">,</span> <span class="p">[</span><span class="n">InstrStage</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span>  <span class="p">[</span><span class="n">ALU</span><span class="p">]</span><span class="o">&gt;</span><span class="p">]</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="n">InstrItinData</span><span class="o">&lt;</span><span class="n">IILoad</span>             <span class="p">,</span> <span class="p">[</span><span class="n">InstrStage</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">,</span>  <span class="p">[</span><span class="n">ALU</span><span class="p">]</span><span class="o">&gt;</span><span class="p">]</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="n">InstrItinData</span><span class="o">&lt;</span><span class="n">IIStore</span>            <span class="p">,</span> <span class="p">[</span><span class="n">InstrStage</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span>  <span class="p">[</span><span class="n">ALU</span><span class="p">]</span><span class="o">&gt;</span><span class="p">]</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="n">InstrItinData</span><span class="o">&lt;</span><span class="n">IIBranch</span>           <span class="p">,</span> <span class="p">[</span><span class="n">InstrStage</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span>  <span class="p">[</span><span class="n">ALU</span><span class="p">]</span><span class="o">&gt;</span><span class="p">]</span><span class="o">&gt;</span>
<span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>

</pre></div>
</div>
</div>
<div class="section" id="write-cmake-file">
<h3><a class="toc-backref" href="#id72">Write cmake file</a><a class="headerlink" href="#write-cmake-file" title="Permalink to this headline">¶</a></h3>
<p>Target/Cpu0 directory has two files CMakeLists.txt and LLVMBuild.txt,
contents as follows,</p>
<p class="rubric">lbdex/chapters/Chapter2/CMakeLists.txt</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>
<span class="nb">set</span><span class="p">(</span><span class="n">LLVM_TARGET_DEFINITIONS</span> <span class="n">Cpu0Other</span><span class="o">.</span><span class="n">td</span><span class="p">)</span>

<span class="c1"># Generate Cpu0GenRegisterInfo.inc and Cpu0GenInstrInfo.inc which included by </span>
<span class="c1">#  your hand code C++ files. </span>
<span class="c1"># Cpu0GenRegisterInfo.inc came from Cpu0RegisterInfo.td, Cpu0GenInstrInfo.inc </span>
<span class="c1">#  came from Cpu0InstrInfo.td.</span>
<span class="n">tablegen</span><span class="p">(</span><span class="n">LLVM</span> <span class="n">Cpu0GenRegisterInfo</span><span class="o">.</span><span class="n">inc</span> <span class="o">-</span><span class="n">gen</span><span class="o">-</span><span class="n">register</span><span class="o">-</span><span class="n">info</span><span class="p">)</span>
<span class="n">tablegen</span><span class="p">(</span><span class="n">LLVM</span> <span class="n">Cpu0GenInstrInfo</span><span class="o">.</span><span class="n">inc</span> <span class="o">-</span><span class="n">gen</span><span class="o">-</span><span class="n">instr</span><span class="o">-</span><span class="n">info</span><span class="p">)</span>
<span class="n">tablegen</span><span class="p">(</span><span class="n">LLVM</span> <span class="n">Cpu0GenSubtargetInfo</span><span class="o">.</span><span class="n">inc</span> <span class="o">-</span><span class="n">gen</span><span class="o">-</span><span class="n">subtarget</span><span class="p">)</span>
<span class="n">tablegen</span><span class="p">(</span><span class="n">LLVM</span> <span class="n">Cpu0GenMCPseudoLowering</span><span class="o">.</span><span class="n">inc</span> <span class="o">-</span><span class="n">gen</span><span class="o">-</span><span class="n">pseudo</span><span class="o">-</span><span class="n">lowering</span><span class="p">)</span>

<span class="c1"># Cpu0CommonTableGen must be defined</span>
<span class="n">add_public_tablegen_target</span><span class="p">(</span><span class="n">Cpu0CommonTableGen</span><span class="p">)</span>

<span class="c1"># Cpu0CodeGen should match with LLVMBuild.txt Cpu0CodeGen</span>
<span class="n">add_llvm_target</span><span class="p">(</span><span class="n">Cpu0CodeGen</span>
  <span class="n">Cpu0TargetMachine</span><span class="o">.</span><span class="n">cpp</span>
  <span class="p">)</span>

<span class="c1"># Should match with &quot;subdirectories =  MCTargetDesc TargetInfo&quot; in LLVMBuild.txt</span>
<span class="n">add_subdirectory</span><span class="p">(</span><span class="n">TargetInfo</span><span class="p">)</span>
<span class="n">add_subdirectory</span><span class="p">(</span><span class="n">MCTargetDesc</span><span class="p">)</span>

</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter2/LLVMBuild.txt</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">;</span><span class="o">===-</span> <span class="o">./</span><span class="n">lib</span><span class="o">/</span><span class="n">Target</span><span class="o">/</span><span class="n">Cpu0</span><span class="o">/</span><span class="n">LLVMBuild</span><span class="o">.</span><span class="n">txt</span> <span class="o">--------------------------*-</span> <span class="n">Conf</span> <span class="o">-*--===</span><span class="p">;</span>
<span class="p">;</span>
<span class="p">;</span>                     <span class="n">The</span> <span class="n">LLVM</span> <span class="n">Compiler</span> <span class="n">Infrastructure</span>
<span class="p">;</span>
<span class="p">;</span> <span class="n">This</span> <span class="n">file</span> <span class="ow">is</span> <span class="n">distributed</span> <span class="n">under</span> <span class="n">the</span> <span class="n">University</span> <span class="n">of</span> <span class="n">Illinois</span> <span class="n">Open</span> <span class="n">Source</span>
<span class="p">;</span> <span class="n">License</span><span class="o">.</span> <span class="n">See</span> <span class="n">LICENSE</span><span class="o">.</span><span class="n">TXT</span> <span class="k">for</span> <span class="n">details</span><span class="o">.</span>
<span class="p">;</span>
<span class="p">;</span><span class="o">===------------------------------------------------------------------------===</span><span class="p">;</span>
<span class="p">;</span>
<span class="p">;</span> <span class="n">This</span> <span class="ow">is</span> <span class="n">an</span> <span class="n">LLVMBuild</span> <span class="n">description</span> <span class="n">file</span> <span class="k">for</span> <span class="n">the</span> <span class="n">components</span> <span class="ow">in</span> <span class="n">this</span> <span class="n">subdirectory</span><span class="o">.</span>
<span class="p">;</span>
<span class="p">;</span> <span class="n">For</span> <span class="n">more</span> <span class="n">information</span> <span class="n">on</span> <span class="n">the</span> <span class="n">LLVMBuild</span> <span class="n">system</span><span class="p">,</span> <span class="n">please</span> <span class="n">see</span><span class="p">:</span>
<span class="p">;</span>
<span class="p">;</span>   <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">llvm</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">docs</span><span class="o">/</span><span class="n">LLVMBuild</span><span class="o">.</span><span class="n">html</span>
<span class="p">;</span>
<span class="p">;</span><span class="o">===------------------------------------------------------------------------===</span><span class="p">;</span>

<span class="c1"># Following comments extracted from http://llvm.org/docs/LLVMBuild.html</span>

<span class="p">[</span><span class="n">common</span><span class="p">]</span>
<span class="n">subdirectories</span> <span class="o">=</span> 
  <span class="n">MCTargetDesc</span> <span class="n">TargetInfo</span>

<span class="p">[</span><span class="n">component_0</span><span class="p">]</span>
<span class="c1"># TargetGroup components are an extension of LibraryGroups, specifically for </span>
<span class="c1">#  defining LLVM targets (which are handled specially in a few places).</span>
<span class="nb">type</span> <span class="o">=</span> <span class="n">TargetGroup</span>
<span class="c1"># The name of the component should always be the name of the target. (should </span>
<span class="c1">#  match &quot;def Cpu0 : Target&quot; in Cpu0.td)</span>
<span class="n">name</span> <span class="o">=</span> <span class="n">Cpu0</span>
<span class="c1"># Cpu0 component is located in directory Target/</span>
<span class="n">parent</span> <span class="o">=</span> <span class="n">Target</span>
<span class="c1"># Whether this target defines an assembly parser, assembly printer, disassembler</span>
<span class="c1">#  , and supports JIT compilation. They are optional.</span>

<span class="p">[</span><span class="n">component_1</span><span class="p">]</span>
<span class="c1"># component_1 is a Library type and name is Cpu0CodeGen. After build it will </span>
<span class="c1">#  in lib/libLLVMCpu0CodeGen.a of your build command directory.</span>
<span class="nb">type</span> <span class="o">=</span> <span class="n">Library</span>
<span class="n">name</span> <span class="o">=</span> <span class="n">Cpu0CodeGen</span>
<span class="c1"># Cpu0CodeGen component(Library) is located in directory Cpu0/</span>
<span class="n">parent</span> <span class="o">=</span> <span class="n">Cpu0</span>
<span class="c1"># If given, a list of the names of Library or LibraryGroup components which </span>
<span class="c1">#  must also be linked in whenever this library is used. That is, the link time </span>
<span class="c1">#  dependencies for this component. When tools are built, the build system will </span>
<span class="c1">#  include the transitive closure of all required_libraries for the components </span>
<span class="c1">#  the tool needs.</span>
<span class="n">required_libraries</span> <span class="o">=</span>
                     <span class="n">CodeGen</span> <span class="n">Core</span> <span class="n">MC</span> 
                     <span class="n">Cpu0Desc</span> 
                     <span class="n">Cpu0Info</span> 
                     <span class="n">SelectionDAG</span> 
                     <span class="n">Support</span> 
                     <span class="n">Target</span>
<span class="c1"># end of required_libraries</span>

<span class="c1"># All LLVMBuild.txt in Target/Cpu0 and subdirectory use &#39;add_to_library_groups </span>
<span class="c1">#  = Cpu0&#39;</span>
<span class="n">add_to_library_groups</span> <span class="o">=</span> <span class="n">Cpu0</span>

</pre></div>
</div>
<p>CMakeLists.txt is the make information for cmake and # is comment.
File LLVMBuild.txt is written in a simple variant of the INI or configuration
file format.
Comments are prefixed by <strong>#</strong> in both files.
We explain the setting for these two files in comments.
Please read it.
The &#8220;tablegen(&#8221; in above CMakeLists.txt is defined in
cmake/modules/TableGen.cmake as below,</p>
<p class="rubric">src/cmake/modules/TableGen.cmake</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span>function(tablegen project ofn)
  ...
  add_custom_command(OUTPUT ${CMAKE_CURRENT_BINARY_DIR}/${ofn}.tmp
    # Generate tablegen output in a temporary file.
    COMMAND ${${project}_TABLEGEN_EXE} ${ARGN} -I ${CMAKE_CURRENT_SOURCE_DIR}
  ...
endfunction()
...
macro(add_tablegen target project)
  ...
  if(LLVM_USE_HOST_TOOLS)
    if( ${${project}_TABLEGEN} STREQUAL &quot;${target}&quot; )
      if (NOT CMAKE_CONFIGURATION_TYPES)
        set(${project}_TABLEGEN_EXE &quot;${LLVM_NATIVE_BUILD}/bin/${target}&quot;)
      else()
        set(${project}_TABLEGEN_EXE &quot;${LLVM_NATIVE_BUILD}/Release/bin/${target}&quot;)
      endif()
  ...
endmacro()
</pre></div>
</div>
<p class="rubric">src/utils/TableGen/CMakeLists.txt</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="n">add_tablegen</span><span class="p">(</span><span class="n">llvm</span><span class="o">-</span><span class="n">tblgen</span> <span class="n">LLVM</span>
  <span class="p">...</span>
<span class="p">)</span>
</pre></div>
</div>
<p>Above &#8220;add_tablegen&#8221; in src/utils/TableGen/CMakeLists.txt makes the
&#8220;tablegen(&#8221; written in Cpu0 CMakeLists.txt an alias of llvm-tblgen.
The &#8220;tablegen(&#8221;, &#8220;add_public_tablegen_target(Cpu0CommonTableGen)&#8221; in
lbdex/chapters/Chapter2/CMakeLists.txt and the following code define a target
&#8220;Cpu0CommonTableGen&#8221; with it&#8217;s output files &#8220;Cpu0Gen*.inc&#8221; as follows,</p>
<p class="rubric">src/cmake/modules/TableGen.cmake</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span>function(tablegen project ofn)
  ...
  set(TABLEGEN_OUTPUT ${TABLEGEN_OUTPUT} ${CMAKE_CURRENT_BINARY_DIR}/${ofn} PARENT_SCOPE)
  ...
endfunction()

# Creates a target for publicly exporting tablegen dependencies.
function(add_public_tablegen_target target)
  ...
  add_custom_target(${target}
    DEPENDS ${TABLEGEN_OUTPUT})
  ...
endfunction()
</pre></div>
</div>
<p>Since execution file llvm-tblgen is built before compiling any llvm backend
source code during building llvm, the llvm-tblgen is always ready for backend&#8217;s
TableGen reguest.</p>
<p>This book breaks the whole backend source code by function, add code chapter
by chapter and even section by section.
Don&#8217;t try to understand everything in the text of book, the code added in each
chapter is a reading material too.
To understand the computer related knowledge in concept, you can ignore source
code, but implementing based on an existed open software cannot.
In programming, documentation cannot replace the source code totally.
Reading source code is a big opportunity in the open source development.</p>
<p>Both CMakeLists.txt and LLVMBuild.txt coexist in sub-directories
<strong>MCTargetDesc</strong> and <strong>TargetInfo</strong>.
Their contents indicate they will generate Cpu0Desc and Cpu0Info libraries.
After building, you will find three libraries: <strong>libLLVMCpu0CodeGen.a</strong>,
<strong>libLLVMCpu0Desc.a</strong> and <strong>libLLVMCpu0Info.a</strong> in lib/ of your build
directory.
For more details please see &#8220;Building LLVM with CMake&#8221; <a class="footnote-reference" href="#cmake" id="id25">[15]</a> and
&#8220;LLVMBuild Guide&#8221; <a class="footnote-reference" href="#llvmbuild" id="id26">[16]</a>.</p>
</div>
<div class="section" id="target-registration">
<h3><a class="toc-backref" href="#id73">Target Registration</a><a class="headerlink" href="#target-registration" title="Permalink to this headline">¶</a></h3>
<p>You must also register your target with the TargetRegistry. After registration,
llvm tools are able to lookup and use your target at runtime.
The TargetRegistry can be used directly, but for most targets there are helper
templates which should take care of the work for you.</p>
<p>All targets should declare a global Target object which is used to represent
the target during registration.
Then, in the target&#8217;s TargetInfo library, the target should define that object
and use the RegisterTarget template to register the target.
For example, the file TargetInfo/Cpu0TargetInfo.cpp register TheCpu0Target for
big endian and TheCpu0elTarget for little endian, as follows.</p>
<p class="rubric">lbdex/chapters/Chapter2/Cpu0.h</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">//===--</span> <span class="n">Cpu0</span><span class="o">.</span><span class="n">h</span> <span class="o">-</span> <span class="n">Top</span><span class="o">-</span><span class="n">level</span> <span class="n">interface</span> <span class="k">for</span> <span class="n">Cpu0</span> <span class="n">representation</span> <span class="o">----*-</span> <span class="n">C</span><span class="o">++</span> <span class="o">-*-===//</span>
<span class="o">//</span>
<span class="o">//</span>                     <span class="n">The</span> <span class="n">LLVM</span> <span class="n">Compiler</span> <span class="n">Infrastructure</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="ow">is</span> <span class="n">distributed</span> <span class="n">under</span> <span class="n">the</span> <span class="n">University</span> <span class="n">of</span> <span class="n">Illinois</span> <span class="n">Open</span> <span class="n">Source</span>
<span class="o">//</span> <span class="n">License</span><span class="o">.</span> <span class="n">See</span> <span class="n">LICENSE</span><span class="o">.</span><span class="n">TXT</span> <span class="k">for</span> <span class="n">details</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="n">contains</span> <span class="n">the</span> <span class="n">entry</span> <span class="n">points</span> <span class="k">for</span> <span class="k">global</span> <span class="n">functions</span> <span class="n">defined</span> <span class="ow">in</span>
<span class="o">//</span> <span class="n">the</span> <span class="n">LLVM</span> <span class="n">Cpu0</span> <span class="n">back</span><span class="o">-</span><span class="n">end</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="c1">#ifndef LLVM_LIB_TARGET_CPU0_CPU0_H</span>
<span class="c1">#define LLVM_LIB_TARGET_CPU0_CPU0_H</span>

<span class="c1">#include &quot;Cpu0Config.h&quot;</span>
<span class="c1">#include &quot;MCTargetDesc/Cpu0MCTargetDesc.h&quot;</span>
<span class="c1">#include &quot;llvm/Target/TargetMachine.h&quot;</span>

<span class="n">namespace</span> <span class="n">llvm</span> <span class="p">{</span>
  <span class="k">class</span> <span class="nc">Cpu0TargetMachine</span><span class="p">;</span>
  <span class="k">class</span> <span class="nc">FunctionPass</span><span class="p">;</span>

<span class="p">}</span> <span class="o">//</span> <span class="n">end</span> <span class="n">namespace</span> <span class="n">llvm</span><span class="p">;</span>

<span class="c1">#endif</span>

</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter2/TargetInfo/Cpu0TargetInfo.cpp</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">//===--</span> <span class="n">Cpu0TargetInfo</span><span class="o">.</span><span class="n">cpp</span> <span class="o">-</span> <span class="n">Cpu0</span> <span class="n">Target</span> <span class="n">Implementation</span> <span class="o">-------------------===//</span>
<span class="o">//</span>
<span class="o">//</span>                     <span class="n">The</span> <span class="n">LLVM</span> <span class="n">Compiler</span> <span class="n">Infrastructure</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="ow">is</span> <span class="n">distributed</span> <span class="n">under</span> <span class="n">the</span> <span class="n">University</span> <span class="n">of</span> <span class="n">Illinois</span> <span class="n">Open</span> <span class="n">Source</span>
<span class="o">//</span> <span class="n">License</span><span class="o">.</span> <span class="n">See</span> <span class="n">LICENSE</span><span class="o">.</span><span class="n">TXT</span> <span class="k">for</span> <span class="n">details</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="c1">#include &quot;Cpu0.h&quot;</span>
<span class="c1">#include &quot;llvm/IR/Module.h&quot;</span>
<span class="c1">#include &quot;llvm/Support/TargetRegistry.h&quot;</span>
<span class="n">using</span> <span class="n">namespace</span> <span class="n">llvm</span><span class="p">;</span>

<span class="n">Target</span> <span class="n">llvm</span><span class="p">::</span><span class="n">TheCpu0Target</span><span class="p">,</span> <span class="n">llvm</span><span class="p">::</span><span class="n">TheCpu0elTarget</span><span class="p">;</span>

<span class="n">extern</span> <span class="s2">&quot;C&quot;</span> <span class="n">void</span> <span class="n">LLVMInitializeCpu0TargetInfo</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">RegisterTarget</span><span class="o">&lt;</span><span class="n">Triple</span><span class="p">::</span><span class="n">cpu0</span><span class="p">,</span>
        <span class="o">/*</span><span class="n">HasJIT</span><span class="o">=*/</span><span class="n">true</span><span class="o">&gt;</span> <span class="n">X</span><span class="p">(</span><span class="n">TheCpu0Target</span><span class="p">,</span> <span class="s2">&quot;cpu0&quot;</span><span class="p">,</span> <span class="s2">&quot;Cpu0&quot;</span><span class="p">);</span>

  <span class="n">RegisterTarget</span><span class="o">&lt;</span><span class="n">Triple</span><span class="p">::</span><span class="n">cpu0el</span><span class="p">,</span>
        <span class="o">/*</span><span class="n">HasJIT</span><span class="o">=*/</span><span class="n">true</span><span class="o">&gt;</span> <span class="n">Y</span><span class="p">(</span><span class="n">TheCpu0elTarget</span><span class="p">,</span> <span class="s2">&quot;cpu0el&quot;</span><span class="p">,</span> <span class="s2">&quot;Cpu0el&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter2/TargetInfo/CMakeLists.txt</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">add_llvm_library</span><span class="p">(</span><span class="n">LLVMCpu0Info</span>
  <span class="n">Cpu0TargetInfo</span><span class="o">.</span><span class="n">cpp</span>
  <span class="p">)</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter2/TargetInfo/LLVMBuild.txt</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">;</span><span class="o">===-</span> <span class="o">./</span><span class="n">lib</span><span class="o">/</span><span class="n">Target</span><span class="o">/</span><span class="n">Cpu0</span><span class="o">/</span><span class="n">TargetInfo</span><span class="o">/</span><span class="n">LLVMBuild</span><span class="o">.</span><span class="n">txt</span> <span class="o">---------------*-</span> <span class="n">Conf</span> <span class="o">-*--===</span><span class="p">;</span>
<span class="p">;</span>
<span class="p">;</span>                     <span class="n">The</span> <span class="n">LLVM</span> <span class="n">Compiler</span> <span class="n">Infrastructure</span>
<span class="p">;</span>
<span class="p">;</span> <span class="n">This</span> <span class="n">file</span> <span class="ow">is</span> <span class="n">distributed</span> <span class="n">under</span> <span class="n">the</span> <span class="n">University</span> <span class="n">of</span> <span class="n">Illinois</span> <span class="n">Open</span> <span class="n">Source</span>
<span class="p">;</span> <span class="n">License</span><span class="o">.</span> <span class="n">See</span> <span class="n">LICENSE</span><span class="o">.</span><span class="n">TXT</span> <span class="k">for</span> <span class="n">details</span><span class="o">.</span>
<span class="p">;</span>
<span class="p">;</span><span class="o">===------------------------------------------------------------------------===</span><span class="p">;</span>
<span class="p">;</span>
<span class="p">;</span> <span class="n">This</span> <span class="ow">is</span> <span class="n">an</span> <span class="n">LLVMBuild</span> <span class="n">description</span> <span class="n">file</span> <span class="k">for</span> <span class="n">the</span> <span class="n">components</span> <span class="ow">in</span> <span class="n">this</span> <span class="n">subdirectory</span><span class="o">.</span>
<span class="p">;</span>
<span class="p">;</span> <span class="n">For</span> <span class="n">more</span> <span class="n">information</span> <span class="n">on</span> <span class="n">the</span> <span class="n">LLVMBuild</span> <span class="n">system</span><span class="p">,</span> <span class="n">please</span> <span class="n">see</span><span class="p">:</span>
<span class="p">;</span>
<span class="p">;</span>   <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">llvm</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">docs</span><span class="o">/</span><span class="n">LLVMBuild</span><span class="o">.</span><span class="n">html</span>
<span class="p">;</span>
<span class="p">;</span><span class="o">===------------------------------------------------------------------------===</span><span class="p">;</span>

<span class="p">[</span><span class="n">component_0</span><span class="p">]</span>
<span class="nb">type</span> <span class="o">=</span> <span class="n">Library</span>
<span class="n">name</span> <span class="o">=</span> <span class="n">Cpu0Info</span>
<span class="n">parent</span> <span class="o">=</span> <span class="n">Cpu0</span>
<span class="n">required_libraries</span> <span class="o">=</span> <span class="n">Support</span>
<span class="n">add_to_library_groups</span> <span class="o">=</span> <span class="n">Cpu0</span>
</pre></div>
</div>
<p>Files Cpu0TargetMachine.cpp and MCTargetDesc/Cpu0MCTargetDesc.cpp just define
the empty initialize function since we register nothing for this moment.</p>
<p class="rubric">lbdex/chapters/Chapter2/Cpu0TargetMachine.cpp</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">//===--</span> <span class="n">Cpu0TargetMachine</span><span class="o">.</span><span class="n">cpp</span> <span class="o">-</span> <span class="n">Define</span> <span class="n">TargetMachine</span> <span class="k">for</span> <span class="n">Cpu0</span> <span class="o">-------------===//</span>
<span class="o">//</span>
<span class="o">//</span>                     <span class="n">The</span> <span class="n">LLVM</span> <span class="n">Compiler</span> <span class="n">Infrastructure</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="ow">is</span> <span class="n">distributed</span> <span class="n">under</span> <span class="n">the</span> <span class="n">University</span> <span class="n">of</span> <span class="n">Illinois</span> <span class="n">Open</span> <span class="n">Source</span>
<span class="o">//</span> <span class="n">License</span><span class="o">.</span> <span class="n">See</span> <span class="n">LICENSE</span><span class="o">.</span><span class="n">TXT</span> <span class="k">for</span> <span class="n">details</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">Implements</span> <span class="n">the</span> <span class="n">info</span> <span class="n">about</span> <span class="n">Cpu0</span> <span class="n">target</span> <span class="n">spec</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="c1">#include &quot;Cpu0TargetMachine.h&quot;</span>
<span class="c1">#include &quot;Cpu0.h&quot;</span>

<span class="c1">#include &quot;llvm/IR/LegacyPassManager.h&quot;</span>
<span class="c1">#include &quot;llvm/CodeGen/Passes.h&quot;</span>
<span class="c1">#include &quot;llvm/Support/TargetRegistry.h&quot;</span>
<span class="n">using</span> <span class="n">namespace</span> <span class="n">llvm</span><span class="p">;</span>

<span class="c1">#define DEBUG_TYPE &quot;cpu0&quot;</span>

<span class="n">extern</span> <span class="s2">&quot;C&quot;</span> <span class="n">void</span> <span class="n">LLVMInitializeCpu0Target</span><span class="p">()</span> <span class="p">{</span>
<span class="p">}</span>

</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter2/MCTargetDesc/Cpu0MCTargetDesc.h</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">//===--</span> <span class="n">Cpu0MCTargetDesc</span><span class="o">.</span><span class="n">h</span> <span class="o">-</span> <span class="n">Cpu0</span> <span class="n">Target</span> <span class="n">Descriptions</span> <span class="o">-----------*-</span> <span class="n">C</span><span class="o">++</span> <span class="o">-*-===//</span>
<span class="o">//</span>
<span class="o">//</span>                     <span class="n">The</span> <span class="n">LLVM</span> <span class="n">Compiler</span> <span class="n">Infrastructure</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="ow">is</span> <span class="n">distributed</span> <span class="n">under</span> <span class="n">the</span> <span class="n">University</span> <span class="n">of</span> <span class="n">Illinois</span> <span class="n">Open</span> <span class="n">Source</span>
<span class="o">//</span> <span class="n">License</span><span class="o">.</span> <span class="n">See</span> <span class="n">LICENSE</span><span class="o">.</span><span class="n">TXT</span> <span class="k">for</span> <span class="n">details</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="n">provides</span> <span class="n">Cpu0</span> <span class="n">specific</span> <span class="n">target</span> <span class="n">descriptions</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="c1">#ifndef LLVM_LIB_TARGET_CPU0_MCTARGETDESC_CPU0MCTARGETDESC_H</span>
<span class="c1">#define LLVM_LIB_TARGET_CPU0_MCTARGETDESC_CPU0MCTARGETDESC_H</span>

<span class="c1">#include &quot;Cpu0Config.h&quot;</span>
<span class="c1">#include &quot;llvm/Support/DataTypes.h&quot;</span>

<span class="n">namespace</span> <span class="n">llvm</span> <span class="p">{</span>
<span class="k">class</span> <span class="nc">Target</span><span class="p">;</span>
<span class="k">class</span> <span class="nc">Triple</span><span class="p">;</span>

<span class="n">extern</span> <span class="n">Target</span> <span class="n">TheCpu0Target</span><span class="p">;</span>
<span class="n">extern</span> <span class="n">Target</span> <span class="n">TheCpu0elTarget</span><span class="p">;</span>

<span class="p">}</span> <span class="o">//</span> <span class="n">End</span> <span class="n">llvm</span> <span class="n">namespace</span>

<span class="o">//</span> <span class="n">Defines</span> <span class="n">symbolic</span> <span class="n">names</span> <span class="k">for</span> <span class="n">Cpu0</span> <span class="n">registers</span><span class="o">.</span>  <span class="n">This</span> <span class="n">defines</span> <span class="n">a</span> <span class="n">mapping</span> <span class="kn">from</span>
<span class="o">//</span> <span class="n">register</span> <span class="n">name</span> <span class="n">to</span> <span class="n">register</span> <span class="n">number</span><span class="o">.</span>
<span class="c1">#define GET_REGINFO_ENUM</span>
<span class="c1">#include &quot;Cpu0GenRegisterInfo.inc&quot;</span>

<span class="o">//</span> <span class="n">Defines</span> <span class="n">symbolic</span> <span class="n">names</span> <span class="k">for</span> <span class="n">the</span> <span class="n">Cpu0</span> <span class="n">instructions</span><span class="o">.</span>
<span class="c1">#define GET_INSTRINFO_ENUM</span>
<span class="c1">#include &quot;Cpu0GenInstrInfo.inc&quot;</span>

<span class="c1">#define GET_SUBTARGETINFO_ENUM</span>
<span class="c1">#include &quot;Cpu0GenSubtargetInfo.inc&quot;</span>

<span class="c1">#endif</span>

</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter2/MCTargetDesc/Cpu0MCTargetDesc.cpp</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">//===--</span> <span class="n">Cpu0MCTargetDesc</span><span class="o">.</span><span class="n">cpp</span> <span class="o">-</span> <span class="n">Cpu0</span> <span class="n">Target</span> <span class="n">Descriptions</span> <span class="o">-------------------===//</span>
<span class="o">//</span>
<span class="o">//</span>                     <span class="n">The</span> <span class="n">LLVM</span> <span class="n">Compiler</span> <span class="n">Infrastructure</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="ow">is</span> <span class="n">distributed</span> <span class="n">under</span> <span class="n">the</span> <span class="n">University</span> <span class="n">of</span> <span class="n">Illinois</span> <span class="n">Open</span> <span class="n">Source</span>
<span class="o">//</span> <span class="n">License</span><span class="o">.</span> <span class="n">See</span> <span class="n">LICENSE</span><span class="o">.</span><span class="n">TXT</span> <span class="k">for</span> <span class="n">details</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>
<span class="o">//</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">file</span> <span class="n">provides</span> <span class="n">Cpu0</span> <span class="n">specific</span> <span class="n">target</span> <span class="n">descriptions</span><span class="o">.</span>
<span class="o">//</span>
<span class="o">//===----------------------------------------------------------------------===//</span>

<span class="c1">#include &quot;Cpu0MCTargetDesc.h&quot;</span>
<span class="c1">#include &quot;llvm/MC/MachineLocation.h&quot;</span>
<span class="c1">#include &quot;llvm/MC/MCCodeGenInfo.h&quot;</span>
<span class="c1">#include &quot;llvm/MC/MCELFStreamer.h&quot;</span>
<span class="c1">#include &quot;llvm/MC/MCInstPrinter.h&quot;</span>
<span class="c1">#include &quot;llvm/MC/MCInstrInfo.h&quot;</span>
<span class="c1">#include &quot;llvm/MC/MCRegisterInfo.h&quot;</span>
<span class="c1">#include &quot;llvm/MC/MCSubtargetInfo.h&quot;</span>
<span class="c1">#include &quot;llvm/MC/MCSymbol.h&quot;</span>
<span class="c1">#include &quot;llvm/Support/CommandLine.h&quot;</span>
<span class="c1">#include &quot;llvm/Support/ErrorHandling.h&quot;</span>
<span class="c1">#include &quot;llvm/Support/FormattedStream.h&quot;</span>
<span class="c1">#include &quot;llvm/Support/TargetRegistry.h&quot;</span>

<span class="n">using</span> <span class="n">namespace</span> <span class="n">llvm</span><span class="p">;</span>

<span class="c1">#define GET_INSTRINFO_MC_DESC</span>
<span class="c1">#include &quot;Cpu0GenInstrInfo.inc&quot;</span>

<span class="c1">#define GET_SUBTARGETINFO_MC_DESC</span>
<span class="c1">#include &quot;Cpu0GenSubtargetInfo.inc&quot;</span>

<span class="c1">#define GET_REGINFO_MC_DESC</span>
<span class="c1">#include &quot;Cpu0GenRegisterInfo.inc&quot;</span>

<span class="o">//</span><span class="nd">@2</span> <span class="p">{</span>
<span class="n">extern</span> <span class="s2">&quot;C&quot;</span> <span class="n">void</span> <span class="n">LLVMInitializeCpu0TargetMC</span><span class="p">()</span> <span class="p">{</span>

<span class="p">}</span>
<span class="o">//</span><span class="nd">@2</span> <span class="p">}</span>

</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter2/MCTargetDesc/CMakeLists.txt</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># MCTargetDesc/CMakeLists.txt</span>
<span class="n">add_llvm_library</span><span class="p">(</span><span class="n">LLVMCpu0Desc</span>
  <span class="n">Cpu0MCTargetDesc</span><span class="o">.</span><span class="n">cpp</span>
  <span class="p">)</span>

</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter2/MCTargetDesc/LLVMBuild.txt</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">;</span><span class="o">===-</span> <span class="o">./</span><span class="n">lib</span><span class="o">/</span><span class="n">Target</span><span class="o">/</span><span class="n">Cpu0</span><span class="o">/</span><span class="n">MCTargetDesc</span><span class="o">/</span><span class="n">LLVMBuild</span><span class="o">.</span><span class="n">txt</span> <span class="o">-------------*-</span> <span class="n">Conf</span> <span class="o">-*--===</span><span class="p">;</span>
<span class="p">;</span>
<span class="p">;</span>                     <span class="n">The</span> <span class="n">LLVM</span> <span class="n">Compiler</span> <span class="n">Infrastructure</span>
<span class="p">;</span>
<span class="p">;</span> <span class="n">This</span> <span class="n">file</span> <span class="ow">is</span> <span class="n">distributed</span> <span class="n">under</span> <span class="n">the</span> <span class="n">University</span> <span class="n">of</span> <span class="n">Illinois</span> <span class="n">Open</span> <span class="n">Source</span>
<span class="p">;</span> <span class="n">License</span><span class="o">.</span> <span class="n">See</span> <span class="n">LICENSE</span><span class="o">.</span><span class="n">TXT</span> <span class="k">for</span> <span class="n">details</span><span class="o">.</span>
<span class="p">;</span>
<span class="p">;</span><span class="o">===------------------------------------------------------------------------===</span><span class="p">;</span>
<span class="p">;</span>
<span class="p">;</span> <span class="n">This</span> <span class="ow">is</span> <span class="n">an</span> <span class="n">LLVMBuild</span> <span class="n">description</span> <span class="n">file</span> <span class="k">for</span> <span class="n">the</span> <span class="n">components</span> <span class="ow">in</span> <span class="n">this</span> <span class="n">subdirectory</span><span class="o">.</span>
<span class="p">;</span>
<span class="p">;</span> <span class="n">For</span> <span class="n">more</span> <span class="n">information</span> <span class="n">on</span> <span class="n">the</span> <span class="n">LLVMBuild</span> <span class="n">system</span><span class="p">,</span> <span class="n">please</span> <span class="n">see</span><span class="p">:</span>
<span class="p">;</span>
<span class="p">;</span>   <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">llvm</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">docs</span><span class="o">/</span><span class="n">LLVMBuild</span><span class="o">.</span><span class="n">html</span>
<span class="p">;</span>
<span class="p">;</span><span class="o">===------------------------------------------------------------------------===</span><span class="p">;</span>

<span class="p">[</span><span class="n">component_0</span><span class="p">]</span>
<span class="nb">type</span> <span class="o">=</span> <span class="n">Library</span>
<span class="n">name</span> <span class="o">=</span> <span class="n">Cpu0Desc</span>
<span class="n">parent</span> <span class="o">=</span> <span class="n">Cpu0</span>
<span class="n">required_libraries</span> <span class="o">=</span> <span class="n">MC</span> 
                     <span class="n">Cpu0Info</span> 
                     <span class="n">Support</span>
<span class="n">add_to_library_groups</span> <span class="o">=</span> <span class="n">Cpu0</span>

</pre></div>
</div>
<p>Please see &#8220;Target Registration&#8221; <a class="footnote-reference" href="#target-reg" id="id27">[17]</a> for reference.</p>
</div>
<div class="section" id="build-libraries-and-td">
<h3><a class="toc-backref" href="#id74">Build libraries and td</a><a class="headerlink" href="#build-libraries-and-td" title="Permalink to this headline">¶</a></h3>
<p>We set llvm source code in /Users/Jonathan/llvm/release/src and have llvm
release-build in /Users/Jonathan/llvm/release/cmake_release_build.
About how to build llvm, please refer here <a class="footnote-reference" href="#clang" id="id28">[18]</a>.
In appendix A, we made a copy from /Users/Jonathan/llvm/release/src to
/Users/Jonathan/llvm/test/src for working with my Cpu0 target backend.
Sub-directories src is for source code and cmake_debug_build is for debug
build directory.</p>
<p>Beside directory src/lib/Target/Cpu0, there are a couple of files modified to
support cpu0 new Target, which includes both the ID and name of machine and
relocation records listed in the early sub-section.
You can update your llvm working copy and find the modified files by
commands, cp -rf lbdex/src/modify/src/* &lt;yourllvm/workingcopy/sourcedir&gt;/.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>118-165-78-230:test Jonathan$ <span class="nb">pwd</span>
/Users/Jonathan/test
118-165-78-230:test Jonathan$ cp -rf lbdex/src/modify/src/* ~/llvm/test/src/.
118-165-78-230:test Jonathan$ grep -R <span class="s2">&quot;cpu0&quot;</span> ~/llvm/test/src/include
src/cmake/config-ix.cmake:elseif <span class="o">(</span>LLVM_NATIVE_ARCH MATCHES <span class="s2">&quot;cpu0&quot;</span><span class="o">)</span>
src/include/llvm/ADT/Triple.h:#undef cpu0
src/include/llvm/ADT/Triple.h:    cpu0,       // For Tutorial Backend Cpu0
src/include/llvm/ADT/Triple.h:    cpu0el,
src/include/llvm/Support/ELF.h:  <span class="nv">EF_CPU0_ARCH_32R2</span> <span class="o">=</span> 0x70000000, // cpu032r2
src/include/llvm/Support/ELF.h:  <span class="nv">EF_CPU0_ARCH_64R2</span> <span class="o">=</span> 0x80000000, // cpu064r2
...
</pre></div>
</div>
<p>Next configure the Cpu0 example code to chapter2 as follows,</p>
<p class="rubric">~/llvm/test/src/lib/Target/Cpu0/Cpu0SetChapter.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="cp">#define CH       CH2</span>
</pre></div>
</div>
<p>Now, run the <code class="docutils literal"><span class="pre">cmake</span></code> command and Xcode to build td (the following cmake
command is for my setting),</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>118-165-78-230:cmake_debug_build Jonathan$ cmake -DCMAKE_CXX_COMPILER<span class="o">=</span>clang++
-DCMAKE_C_COMPILER<span class="o">=</span>clang -DCMAKE_BUILD_TYPE<span class="o">=</span>Debug -G <span class="s2">&quot;Xcode&quot;</span> ../src/

-- Targeting Cpu0
...
-- Targeting XCore
-- Configuring <span class="k">done</span>
-- Generating <span class="k">done</span>
-- Build files have been written to: /Users/Jonathan/llvm/test/cmake_debug_build

118-165-78-230:cmake_debug_build Jonathan$
</pre></div>
</div>
<p>After build, you can type command <code class="docutils literal"><span class="pre">llc</span> <span class="pre">–version</span></code> to find the cpu0 backend,</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>118-165-78-230:cmake_debug_build Jonathan$ /Users/Jonathan/llvm/test/
cmake_debug_build/Debug/bin/llc --version
LLVM <span class="o">(</span>http://llvm.org/<span class="o">)</span>:
...
  Registered Targets:
  arm      - ARM
  ...
  cpp      - C++ backend
  cpu0     - Cpu0
  cpu0el   - Cpu0el
...
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">llc</span> <span class="pre">-version</span></code> can display Registered Targets <strong>“cpu0”</strong> and <strong>“cpu0el”</strong>,
because the code in file TargetInfo/Cpu0TargetInfo.cpp we made in last
sub-section &#8220;Target Registration&#8221; <a class="footnote-reference" href="#asadasd" id="id29">[19]</a>.</p>
<p>Let&#8217;s build lbdex/chapters/Chapter2 code as follows,</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>118-165-75-57:test Jonathan$ <span class="nb">pwd</span>
/Users/Jonathan/test
118-165-75-57:test Jonathan$ cp -rf lbdex/Cpu0 ~/llvm/test/src/lib/Target/.

118-165-75-57:test Jonathan$ <span class="nb">cd</span> ~/llvm/test/cmake_debug_build
118-165-75-57:cmake_debug_build Jonathan$ <span class="nb">pwd</span>
/Users/Jonathan/llvm/test/cmake_debug_build
118-165-75-57:cmake_debug_build Jonathan$ rm -rf *
118-165-75-57:cmake_debug_build Jonathan$ cmake -DCMAKE_CXX_COMPILER<span class="o">=</span>clang++
-DCMAKE_C_COMPILER<span class="o">=</span>clang -DCMAKE_BUILD_TYPE<span class="o">=</span>Debug -DLLVM_TARGETS_TO_BUILD<span class="o">=</span>Cpu0
-G <span class="s2">&quot;Xcode&quot;</span> ../src/
...
-- Targeting Cpu0
...
-- Configuring <span class="k">done</span>
-- Generating <span class="k">done</span>
-- Build files have been written to: /Users/Jonathan/llvm/test/cmake_debug_build
</pre></div>
</div>
<p>To save time, we build Cpu0 target only by option -DLLVM_TARGETS_TO_BUILD=Cpu0.
After cmake, please open Xcode and build the Xcode project file as appendix A,
or refer appendix A to build it on linux if you work on unix/linux platform.
After that, you can find the *.inc files in directory
/Users/Jonathan/llvm/test/cmake_debug_build/lib/Target/Cpu0 as follows,</p>
<p class="rubric">cmake_debug_build/lib/Target/Cpu0/Cpu0GenRegisterInfo.inc</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span><span class="k">namespace</span> <span class="n">Cpu0</span> <span class="p">{</span>
<span class="k">enum</span> <span class="p">{</span>
  <span class="n">NoRegister</span><span class="p">,</span>
  <span class="n">AT</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
  <span class="n">EPC</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
  <span class="n">FP</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
  <span class="n">GP</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
  <span class="n">HI</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
  <span class="n">LO</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
  <span class="n">LR</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
  <span class="n">PC</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
  <span class="n">SP</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span>
  <span class="n">SW</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
  <span class="n">ZERO</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span>
  <span class="n">A0</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
  <span class="n">A1</span> <span class="o">=</span> <span class="mi">13</span><span class="p">,</span>
  <span class="n">S0</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,</span>
  <span class="n">S1</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span>
  <span class="n">T0</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
  <span class="n">T1</span> <span class="o">=</span> <span class="mi">17</span><span class="p">,</span>
  <span class="n">T9</span> <span class="o">=</span> <span class="mi">18</span><span class="p">,</span>
  <span class="n">V0</span> <span class="o">=</span> <span class="mi">19</span><span class="p">,</span>
  <span class="n">V1</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
  <span class="n">NUM_TARGET_REGS</span>     <span class="c1">// 21</span>
<span class="p">};</span>
<span class="p">}</span>
<span class="p">...</span>
</pre></div>
</div>
<p>These *.inc are created by llvm-tblgen from directory
cmake_debug_build/lib/Target/Cpu0 where input files are the Cpu0 backend *.td
files.
The llvm-tblgen is invoked by <strong>tablegen</strong> of
/Users/Jonathan/llvm/test/src/lib/Target/Cpu0/CMakeLists.txt.
These *.inc files will be included by Cpu0 backend *.cpp or *.h files and
compile into *.o further.
TableGen is the important tool illustrated in the early sub-section
&#8221;.td: LLVM’s Target Description Files&#8221; of this chapter as follows,</p>
<p>&#8220;The “mix and match” approach allows target authors to choose what makes sense
for their architecture and permits a large amount of code reuse across
different targets&#8221;.</p>
<p>Details about TableGen are here <a class="footnote-reference" href="#tblgen" id="id30">[20]</a> <a class="footnote-reference" href="#tblgen-langintro" id="id31">[21]</a>
<a class="footnote-reference" href="#tblgen-langref" id="id32">[22]</a>.</p>
<p>Now try to run  command <code class="docutils literal"><span class="pre">llc</span></code> to compile input file ch3.cpp as follows,</p>
<p class="rubric">lbdex/input/ch3.cpp</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">main</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div>
</div>
<p>First step, compile it with clang and get output ch3.bc as follows,</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>118-165-78-230:input Jonathan$ <span class="nb">pwd</span>
/Users/Jonathan/llvm/test/lbdex/input
118-165-78-230:input Jonathan$ clang -target mips-unknown-linux-gnu -c
ch3.cpp -emit-llvm -o ch3.bc
</pre></div>
</div>
<p>As above, compile C to .bc by <code class="docutils literal"><span class="pre">clang</span> <span class="pre">-target</span> <span class="pre">mips-unknown-linux-gnu</span></code> because
Cpu0 borrows the ABI from Mips.
Next step, transfer bitcode .bc to human readable text format as follows,</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>118-165-78-230:test Jonathan$ llvm-dis ch3.bc -o -

// ch3.ll
<span class="p">;</span> <span class="nv">ModuleID</span> <span class="o">=</span> <span class="s1">&#39;ch3.bc&#39;</span>
target <span class="nv">datalayout</span> <span class="o">=</span> <span class="s2">&quot;e-p:64:64:64-i1:8:8-i8:8:8-i16:16:16-i32:32:32-i64:64:64-f3</span>
<span class="s2">2:32:32-f64:64:64-v64:64:64-v128:128:128-a0:0:64-s0:64:64-f80:128:128-n8:16:32:6</span>
<span class="s2">4-S128&quot;</span>
target <span class="nv">triple</span> <span class="o">=</span> <span class="s2">&quot;mips-unknown-linux-gnu&quot;</span>

define i32 @main<span class="o">()</span> nounwind uwtable <span class="o">{</span>
  %1 <span class="o">=</span> alloca i32, align 4
  store i32 0, i32* %1
  ret i32 0
<span class="o">}</span>
</pre></div>
</div>
<p>Now, when compiling ch3.bc will get the error message as follows,</p>
<div class="highlight-c++"><div class="highlight"><pre><span></span>118-165-78-230:input Jonathan$ /Users/Jonathan/llvm/test/cmake_debug_build/
Debug/bin/llc -march=cpu0 -relocation-model=pic -filetype=asm ch3.bc -o
ch3.cpu0.s
...
... Assertion `target.get() &amp;&amp; &quot;Could not allocate target machine!&quot;&#39; failed
...
</pre></div>
</div>
<p>At this point, we finish the Target Registration for Cpu0 backend.
The backend compiler command <code class="docutils literal"><span class="pre">llc</span></code> can recognize Cpu0 backend now.
Currently we just define target td files (Cpu0.td, Cpu0Other.td,
Cpu0RegisterInfo.td, ...).
According to LLVM structure, we need to define our target machine and include
those td related files.
The error message says we didn&#8217;t define our target machine.
This book is a step-by-step backend delvelopment.
You can review the houndreds lines of Chapter2 example code to see how to do
the Target Registration.</p>
<table class="docutils footnote" frame="void" id="cpu0-chinese" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[1]</a></td><td>Original Cpu0 architecture and ISA details (Chinese). <a class="reference external" href="http://ccckmit.wikidot.com/ocs:cpu0">http://ccckmit.wikidot.com/ocs:cpu0</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="cpu0-english" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[2]</a></td><td>English translation of Cpu0 description. <a class="reference external" href="http://translate.google.com.tw/translate?js=n&amp;prev=_t&amp;hl=zh-TW&amp;ie=UTF-8&amp;layout=2&amp;eotf=1&amp;sl=zh-CN&amp;tl=en&amp;u=http://ccckmit.wikidot.com/ocs:cpu0">http://translate.google.com.tw/translate?js=n&amp;prev=_t&amp;hl=zh-TW&amp;ie=UTF-8&amp;layout=2&amp;eotf=1&amp;sl=zh-CN&amp;tl=en&amp;u=http://ccckmit.wikidot.com/ocs:cpu0</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="lb-note" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[3]</td><td><em>(<a class="fn-backref" href="#id4">1</a>, <a class="fn-backref" href="#id5">2</a>, <a class="fn-backref" href="#id6">3</a>, <a class="fn-backref" href="#id7">4</a>)</em> The difference between LB and LBu is signed and unsigned byte value expand to a word size. For example, After LB Ra, [Rb+Cx], Ra is 0xffffff80(= -128) if byte [Rb+Cx] is 0x80; Ra is 0x0000007f(= 127) if byte [Rb+Cx] is 0x7f. After LBu Ra, [Rb+Cx], Ra is 0x00000080(= 128) if byte [Rb+Cx] is 0x80; Ra is 0x0000007f(= 127) if byte [Rb+Cx] is 0x7f. Difference between LH and LHu is similar.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="u-note" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[4]</td><td><em>(<a class="fn-backref" href="#id9">1</a>, <a class="fn-backref" href="#id10">2</a>, <a class="fn-backref" href="#id11">3</a>, <a class="fn-backref" href="#id12">4</a>)</em> The only difference between ADDu instruction and the ADD instruction is that the ADDU instruction never causes an Integer Overflow exception. SUBu and SUB is similar.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="cond-note" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id8">[5]</a></td><td>Conditions include the following comparisons: &gt;, &gt;=, ==, !=, &lt;=, &lt;. SW is actually set by the subtraction of the two register operands, and the flags indicate which conditions are present.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="sra-note" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[6]</td><td><em>(<a class="fn-backref" href="#id13">1</a>, <a class="fn-backref" href="#id14">2</a>)</em> Rb &#8216;&gt;&gt; Cx, Rb &#8216;&gt;&gt; Rc: Shift with signed bit remain. It&#8217;s equal to ((Rb&amp;&#8217;h80000000)|Rb&gt;&gt;Cx) or ((Rb&amp;&#8217;h80000000)|Rb&gt;&gt;Rc).</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="call-note" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id15">[7]</a></td><td>jsub cx is direct call for 24 bits value of cx while jalr $rb is indirect call for 32 bits value of register $rb.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="jr-note" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id16">[8]</a></td><td>Both JR and RET has same opcode (actually they are the same instruction for Cpu0 hardware). When user writes &#8220;jr $t9&#8221; meaning it jumps to address of register $t9; when user writes &#8220;jr $lr&#8221; meaning it jump back to the caller function (since $lr is the return address). For user read ability, Cpu0 prints &#8220;ret $lr&#8221; instead of &#8220;jr $lr&#8221;.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="aosa-book" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[9]</td><td><em>(<a class="fn-backref" href="#id1">1</a>, <a class="fn-backref" href="#id17">2</a>)</em> Chris Lattner, <strong>LLVM</strong>. Published in The Architecture of Open Source Applications. <a class="reference external" href="http://www.aosabook.org/en/llvm.html">http://www.aosabook.org/en/llvm.html</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="chapters-ex" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id23">[10]</a></td><td><a class="reference external" href="http://jonathan2251.github.io/lbd/doc.html#generate-cpu0-document">http://jonathan2251.github.io/lbd/doc.html#generate-cpu0-document</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="codegen" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id18">[11]</a></td><td><a class="reference external" href="http://llvm.org/docs/CodeGenerator.html">http://llvm.org/docs/CodeGenerator.html</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="langref" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id19">[12]</a></td><td><a class="reference external" href="http://llvm.org/docs/LangRef.html">http://llvm.org/docs/LangRef.html</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="dragonbooks-10-2-3" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id20">[13]</a></td><td>Refer section 10.2.3 of book Compilers: Principles,
Techniques, and Tools (2nd Edition)</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="dragonbooks-8-5" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[14]</td><td><em>(<a class="fn-backref" href="#id21">1</a>, <a class="fn-backref" href="#id22">2</a>)</em> Refer section 8.5 of book Compilers: Principles,
Techniques, and Tools (2nd Edition)</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="cmake" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id25">[15]</a></td><td><a class="reference external" href="http://llvm.org/docs/CMake.html">http://llvm.org/docs/CMake.html</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="llvmbuild" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id26">[16]</a></td><td><a class="reference external" href="http://llvm.org/docs/LLVMBuild.html">http://llvm.org/docs/LLVMBuild.html</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="target-reg" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id27">[17]</a></td><td><a class="reference external" href="http://llvm.org/docs/WritingAnLLVMBackend.html#target-registration">http://llvm.org/docs/WritingAnLLVMBackend.html#target-registration</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="clang" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id28">[18]</a></td><td><a class="reference external" href="http://clang.llvm.org/get_started.html">http://clang.llvm.org/get_started.html</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="asadasd" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id29">[19]</a></td><td><a class="reference external" href="http://jonathan2251.github.io/lbd/llvmstructure.html#target-registration">http://jonathan2251.github.io/lbd/llvmstructure.html#target-registration</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="tblgen" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[20]</td><td><em>(<a class="fn-backref" href="#id24">1</a>, <a class="fn-backref" href="#id30">2</a>)</em> <a class="reference external" href="http://llvm.org/docs/TableGen/index.html">http://llvm.org/docs/TableGen/index.html</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="tblgen-langintro" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id31">[21]</a></td><td><a class="reference external" href="http://llvm.org/docs/TableGen/LangIntro.html">http://llvm.org/docs/TableGen/LangIntro.html</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="tblgen-langref" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id32">[22]</a></td><td><a class="reference external" href="http://llvm.org/docs/TableGen/LangRef.html">http://llvm.org/docs/TableGen/LangRef.html</a></td></tr>
</tbody>
</table>
</div>
</div>
</div>


      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
        <p>
        «&#160;&#160;<a href="about.html">About</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="backendstructure.html">Backend structure</a>&#160;&#160;»
        </p>

      </div>

    <div class="footer" role="contentinfo">
        &copy; Copyright 2016, Chen Chung-Shu.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.4.
    </div>
  </body>
</html>