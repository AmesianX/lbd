<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Backend structure &mdash; Tutorial: Creating an LLVM Backend for the Cpu0 Architecture</title>
    
    <link rel="stylesheet" href="_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '3.7.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="author" title="About these documents" href="about.html" />
    <link rel="top" title="Tutorial: Creating an LLVM Backend for the Cpu0 Architecture" href="index.html" />
    <link rel="next" title="Arithmetic and logic instructions" href="otherinst.html" />
    <link rel="prev" title="Cpu0 architecture and LLVM structure" href="llvmstructure.html" /> 
  </head>
  <body>
      <div class="header"><h1 class="heading"><a href="index.html">
          <span>Tutorial: Creating an LLVM Backend for the Cpu0 Architecture</span></a></h1>
        <h2 class="heading"><span>Backend structure</span></h2>
      </div>
      <div class="topnav">
      
        <p>
        «&#160;&#160;<a href="llvmstructure.html">Cpu0 architecture and LLVM structure</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="otherinst.html">Arithmetic and logic instructions</a>&#160;&#160;»
        </p>

      </div>
      <div class="content">
        
        
  <div class="section" id="backend-structure">
<span id="sec-backendstructure"></span><h1>Backend structure<a class="headerlink" href="#backend-structure" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#targetmachine-structure" id="id5">TargetMachine structure</a></li>
<li><a class="reference internal" href="#add-asmprinter" id="id6">Add AsmPrinter</a></li>
<li><a class="reference internal" href="#add-cpu0dagtodagisel-class" id="id7">Add Cpu0DAGToDAGISel class</a></li>
<li><a class="reference internal" href="#handle-return-register-lr" id="id8">Handle return register lr</a></li>
<li><a class="reference internal" href="#add-prologue-epilogue-functions" id="id9">Add Prologue/Epilogue functions</a></li>
<li><a class="reference internal" href="#data-operands-dags" id="id10">Data operands DAGs</a></li>
<li><a class="reference internal" href="#summary-of-this-chapter" id="id11">Summary of this Chapter</a></li>
</ul>
</div>
<p>This chapter introduces the back end class inheritance tree and class members
first.
Next, following the back end structure, adding individual class implementation
in each section.
At the end of this chapter, we will have a back end to compile llvm
intermediate code into cpu0 assembly code.</p>
<p>Many code are added in this chapter. They almost are common in every back end
except the back end name (cpu0 or mips ...). Actually, we copy almost all the
code from mips and replace the name with cpu0. In addition to knowing the DAGs
pattern match in theoretic compiler and realistic llvm code generation phase,
please focus on the classes relationship in this backend structure.
Once knowing the structure, you can
create your backend structure as quickly as we did, even though there are 3100
lines of code in this chapter.</p>
<div class="section" id="targetmachine-structure">
<h2><a class="toc-backref" href="#id5">TargetMachine structure</a><a class="headerlink" href="#targetmachine-structure" title="Permalink to this headline">¶</a></h2>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0TargetObjectFile.h</p>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0TargetObjectFile.cpp</p>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0TargetMachine.h</p>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0TargetMachine.cpp</p>
<p class="rubric">include/llvm/Target/TargetInstInfo.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="k">class</span> <span class="nc">TargetInstrInfo</span> <span class="o">:</span> <span class="k">public</span> <span class="n">MCInstrInfo</span> <span class="p">{</span>
  <span class="n">TargetInstrInfo</span><span class="p">(</span><span class="k">const</span> <span class="n">TargetInstrInfo</span> <span class="o">&amp;</span><span class="p">)</span> <span class="o">=</span> <span class="k">delete</span><span class="p">;</span>
  <span class="kt">void</span> <span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="k">const</span> <span class="n">TargetInstrInfo</span> <span class="o">&amp;</span><span class="p">)</span> <span class="o">=</span> <span class="k">delete</span><span class="p">;</span>
<span class="nl">public:</span>
  <span class="p">...</span>
<span class="p">}</span>
<span class="p">...</span>
<span class="k">class</span> <span class="nc">TargetInstrInfoImpl</span> <span class="o">:</span> <span class="k">public</span> <span class="n">TargetInstrInfo</span> <span class="p">{</span>
<span class="nl">protected:</span>
  <span class="n">TargetInstrInfoImpl</span><span class="p">(</span><span class="kt">int</span> <span class="n">CallFrameSetupOpcode</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
            <span class="kt">int</span> <span class="n">CallFrameDestroyOpcode</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
  <span class="o">:</span> <span class="n">TargetInstrInfo</span><span class="p">(</span><span class="n">CallFrameSetupOpcode</span><span class="p">,</span> <span class="n">CallFrameDestroyOpcode</span><span class="p">)</span> <span class="p">{}</span>
<span class="nl">public:</span>
  <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0.td</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">include</span> <span class="s">&quot;Cpu0CallingConv.td&quot;</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">// Without this will have error: &#39;cpu032I&#39; is not a recognized processor for </span>
<span class="c1">//  this target (ignoring processor)</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="c1">// Cpu0 Subtarget features                                                    //</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>


<span class="n">def</span> <span class="n">FeatureChapter3_1</span>  <span class="o">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s">&quot;ch3_1&quot;</span><span class="p">,</span> <span class="s">&quot;HasChapterDummy&quot;</span><span class="p">,</span> <span class="s">&quot;true&quot;</span><span class="p">,</span>
                                <span class="s">&quot;Enable Chapter instructions.&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">FeatureChapter3_2</span>  <span class="o">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s">&quot;ch3_2&quot;</span><span class="p">,</span> <span class="s">&quot;HasChapterDummy&quot;</span><span class="p">,</span> <span class="s">&quot;true&quot;</span><span class="p">,</span>
                                <span class="s">&quot;Enable Chapter instructions.&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">FeatureChapter3_3</span>  <span class="o">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s">&quot;ch3_3&quot;</span><span class="p">,</span> <span class="s">&quot;HasChapterDummy&quot;</span><span class="p">,</span> <span class="s">&quot;true&quot;</span><span class="p">,</span>
                                <span class="s">&quot;Enable Chapter instructions.&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">FeatureChapter3_4</span>  <span class="o">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s">&quot;ch3_4&quot;</span><span class="p">,</span> <span class="s">&quot;HasChapterDummy&quot;</span><span class="p">,</span> <span class="s">&quot;true&quot;</span><span class="p">,</span>
                                <span class="s">&quot;Enable Chapter instructions.&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">FeatureChapter3_5</span>  <span class="o">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s">&quot;ch3_5&quot;</span><span class="p">,</span> <span class="s">&quot;HasChapterDummy&quot;</span><span class="p">,</span> <span class="s">&quot;true&quot;</span><span class="p">,</span>
                                <span class="s">&quot;Enable Chapter instructions.&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">FeatureChapter4_1</span>  <span class="o">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s">&quot;ch4_1&quot;</span><span class="p">,</span> <span class="s">&quot;HasChapterDummy&quot;</span><span class="p">,</span> <span class="s">&quot;true&quot;</span><span class="p">,</span>
                                <span class="s">&quot;Enable Chapter instructions.&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">FeatureChapter4_2</span>  <span class="o">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s">&quot;ch4_2&quot;</span><span class="p">,</span> <span class="s">&quot;HasChapterDummy&quot;</span><span class="p">,</span> <span class="s">&quot;true&quot;</span><span class="p">,</span>
                                <span class="s">&quot;Enable Chapter instructions.&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">FeatureChapter5_1</span>  <span class="o">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s">&quot;ch5_1&quot;</span><span class="p">,</span> <span class="s">&quot;HasChapterDummy&quot;</span><span class="p">,</span> <span class="s">&quot;true&quot;</span><span class="p">,</span>
                                <span class="s">&quot;Enable Chapter instructions.&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">FeatureChapter6_1</span>  <span class="o">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s">&quot;ch6_1&quot;</span><span class="p">,</span> <span class="s">&quot;HasChapterDummy&quot;</span><span class="p">,</span> <span class="s">&quot;true&quot;</span><span class="p">,</span>
                                <span class="s">&quot;Enable Chapter instructions.&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">FeatureChapter7_1</span>  <span class="o">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s">&quot;ch7_1&quot;</span><span class="p">,</span> <span class="s">&quot;HasChapterDummy&quot;</span><span class="p">,</span> <span class="s">&quot;true&quot;</span><span class="p">,</span>
                                <span class="s">&quot;Enable Chapter instructions.&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">FeatureChapter8_1</span>  <span class="o">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s">&quot;ch8_1&quot;</span><span class="p">,</span> <span class="s">&quot;HasChapterDummy&quot;</span><span class="p">,</span> <span class="s">&quot;true&quot;</span><span class="p">,</span>
                                <span class="s">&quot;Enable Chapter instructions.&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">FeatureChapter8_2</span>  <span class="o">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s">&quot;ch8_2&quot;</span><span class="p">,</span> <span class="s">&quot;HasChapterDummy&quot;</span><span class="p">,</span> <span class="s">&quot;true&quot;</span><span class="p">,</span>
                                <span class="s">&quot;Enable Chapter instructions.&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">FeatureChapter9_1</span>  <span class="o">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s">&quot;ch9_1&quot;</span><span class="p">,</span> <span class="s">&quot;HasChapterDummy&quot;</span><span class="p">,</span> <span class="s">&quot;true&quot;</span><span class="p">,</span>
                                <span class="s">&quot;Enable Chapter instructions.&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">FeatureChapter9_2</span>  <span class="o">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s">&quot;ch9_2&quot;</span><span class="p">,</span> <span class="s">&quot;HasChapterDummy&quot;</span><span class="p">,</span> <span class="s">&quot;true&quot;</span><span class="p">,</span>
                                <span class="s">&quot;Enable Chapter instructions.&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">FeatureChapter9_3</span>  <span class="o">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s">&quot;ch9_3&quot;</span><span class="p">,</span> <span class="s">&quot;HasChapterDummy&quot;</span><span class="p">,</span> <span class="s">&quot;true&quot;</span><span class="p">,</span>
                                <span class="s">&quot;Enable Chapter instructions.&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">FeatureChapter10_1</span> <span class="o">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s">&quot;ch10_1&quot;</span><span class="p">,</span> <span class="s">&quot;HasChapterDummy&quot;</span><span class="p">,</span> <span class="s">&quot;true&quot;</span><span class="p">,</span>
                                <span class="s">&quot;Enable Chapter instructions.&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">FeatureChapter11_1</span> <span class="o">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s">&quot;ch11_1&quot;</span><span class="p">,</span> <span class="s">&quot;HasChapterDummy&quot;</span><span class="p">,</span> <span class="s">&quot;true&quot;</span><span class="p">,</span>
                                <span class="s">&quot;Enable Chapter instructions.&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">FeatureChapter11_2</span> <span class="o">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s">&quot;ch11_2&quot;</span><span class="p">,</span> <span class="s">&quot;HasChapterDummy&quot;</span><span class="p">,</span> <span class="s">&quot;true&quot;</span><span class="p">,</span>
                                <span class="s">&quot;Enable Chapter instructions.&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">FeatureChapter12_1</span> <span class="o">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s">&quot;ch12_1&quot;</span><span class="p">,</span> <span class="s">&quot;HasChapterDummy&quot;</span><span class="p">,</span> <span class="s">&quot;true&quot;</span><span class="p">,</span>
                                <span class="s">&quot;Enable Chapter instructions.&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">FeatureChapterAll</span>  <span class="o">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s">&quot;chall&quot;</span><span class="p">,</span> <span class="s">&quot;HasChapterDummy&quot;</span><span class="p">,</span> <span class="s">&quot;true&quot;</span><span class="p">,</span>
                                <span class="s">&quot;Enable Chapter instructions.&quot;</span><span class="p">,</span>
                                <span class="p">[</span><span class="n">FeatureChapter3_1</span><span class="p">,</span> <span class="n">FeatureChapter3_2</span><span class="p">,</span> 
                                 <span class="n">FeatureChapter3_3</span><span class="p">,</span> <span class="n">FeatureChapter3_4</span><span class="p">,</span> 
                                 <span class="n">FeatureChapter3_5</span><span class="p">,</span> 
                                 <span class="n">FeatureChapter4_1</span><span class="p">,</span> <span class="n">FeatureChapter4_2</span><span class="p">,</span> 
                                 <span class="n">FeatureChapter5_1</span><span class="p">,</span> <span class="n">FeatureChapter6_1</span><span class="p">,</span> 
                                 <span class="n">FeatureChapter7_1</span><span class="p">,</span> <span class="n">FeatureChapter8_1</span><span class="p">,</span> 
                                 <span class="n">FeatureChapter8_2</span><span class="p">,</span> <span class="n">FeatureChapter9_1</span><span class="p">,</span> 
                                 <span class="n">FeatureChapter9_2</span><span class="p">,</span> <span class="n">FeatureChapter9_3</span><span class="p">,</span> 
                                 <span class="n">FeatureChapter10_1</span><span class="p">,</span> 
                                 <span class="n">FeatureChapter11_1</span><span class="p">,</span> <span class="n">FeatureChapter11_2</span><span class="p">,</span> 
                                 <span class="n">FeatureChapter12_1</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>


<span class="n">def</span> <span class="n">FeatureCmp</span>         <span class="o">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s">&quot;cmp&quot;</span><span class="p">,</span> <span class="s">&quot;HasCmp&quot;</span><span class="p">,</span> <span class="s">&quot;true&quot;</span><span class="p">,</span>
                                <span class="s">&quot;Enable &#39;cmp&#39; instructions.&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">FeatureSlt</span>         <span class="o">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s">&quot;slt&quot;</span><span class="p">,</span> <span class="s">&quot;HasSlt&quot;</span><span class="p">,</span> <span class="s">&quot;true&quot;</span><span class="p">,</span>
                                <span class="s">&quot;Enable &#39;slt&#39; instructions.&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">FeatureCpu032I</span>     <span class="o">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s">&quot;cpu032I&quot;</span><span class="p">,</span> <span class="s">&quot;Cpu0ArchVersion&quot;</span><span class="p">,</span> 
                                <span class="s">&quot;Cpu032I&quot;</span><span class="p">,</span> <span class="s">&quot;Cpu032I ISA Support&quot;</span><span class="p">,</span>
                                <span class="p">[</span><span class="n">FeatureCmp</span><span class="p">,</span> <span class="n">FeatureChapterAll</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">FeatureCpu032II</span>    <span class="o">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s">&quot;cpu032II&quot;</span><span class="p">,</span> <span class="s">&quot;Cpu0ArchVersion&quot;</span><span class="p">,</span>                      
                               <span class="s">&quot;Cpu032II&quot;</span><span class="p">,</span> <span class="s">&quot;Cpu032II ISA Support (slt)&quot;</span><span class="p">,</span>
                                <span class="p">[</span><span class="n">FeatureCmp</span><span class="p">,</span> <span class="n">FeatureSlt</span><span class="p">,</span> <span class="n">FeatureChapterAll</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>

<span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="c1">// Cpu0 processors supported.</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>

<span class="k">class</span> <span class="nc">Proc</span><span class="o">&lt;</span><span class="n">string</span> <span class="n">Name</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">SubtargetFeature</span><span class="o">&gt;</span> <span class="n">Features</span><span class="o">&gt;</span>
 <span class="o">:</span> <span class="n">Processor</span><span class="o">&lt;</span><span class="n">Name</span><span class="p">,</span> <span class="n">Cpu0GenericItineraries</span><span class="p">,</span> <span class="n">Features</span><span class="o">&gt;</span><span class="p">;</span>

<span class="n">def</span> <span class="o">:</span> <span class="n">Proc</span><span class="o">&lt;</span><span class="s">&quot;cpu032I&quot;</span><span class="p">,</span>  <span class="p">[</span><span class="n">FeatureCpu032I</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="o">:</span> <span class="n">Proc</span><span class="o">&lt;</span><span class="s">&quot;cpu032II&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">FeatureCpu032II</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
<span class="c1">// Above make Cpu0GenSubtargetInfo.inc set feature bit as the following order</span>
<span class="c1">// enum {</span>
<span class="c1">//   FeatureCmp =  1ULL &lt;&lt; 0,</span>
<span class="c1">//   FeatureCpu032I =  1ULL &lt;&lt; 1,</span>
<span class="c1">//   FeatureCpu032II =  1ULL &lt;&lt; 2,</span>
<span class="c1">//   FeatureSlt =  1ULL &lt;&lt; 3</span>
<span class="c1">// };</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0CallingConv.td</p>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0FrameLowering.h</p>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0FrameLowering.cpp</p>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0SEFrameLowering.h</p>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0SEFrameLowering.cpp</p>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0InstrInfo.h</p>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0InstrInfo.cpp</p>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0InstrInfo.td</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="c1">// Cpu0 Instruction Predicate Definitions.</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>

<span class="n">def</span> <span class="n">Ch3_1</span>       <span class="o">:</span>     <span class="n">Predicate</span><span class="o">&lt;</span><span class="s">&quot;Subtarget-&gt;hasChapter3_1()&quot;</span><span class="o">&gt;</span><span class="p">,</span>
                      <span class="n">AssemblerPredicate</span><span class="o">&lt;</span><span class="s">&quot;FeatureChapter3_1&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">Ch3_2</span>       <span class="o">:</span>     <span class="n">Predicate</span><span class="o">&lt;</span><span class="s">&quot;Subtarget-&gt;hasChapter3_2()&quot;</span><span class="o">&gt;</span><span class="p">,</span>
                      <span class="n">AssemblerPredicate</span><span class="o">&lt;</span><span class="s">&quot;FeatureChapter3_2&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">Ch3_3</span>       <span class="o">:</span>     <span class="n">Predicate</span><span class="o">&lt;</span><span class="s">&quot;Subtarget-&gt;hasChapter3_3()&quot;</span><span class="o">&gt;</span><span class="p">,</span>
                      <span class="n">AssemblerPredicate</span><span class="o">&lt;</span><span class="s">&quot;FeatureChapter3_3&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">Ch3_4</span>       <span class="o">:</span>     <span class="n">Predicate</span><span class="o">&lt;</span><span class="s">&quot;Subtarget-&gt;hasChapter3_4()&quot;</span><span class="o">&gt;</span><span class="p">,</span>
                      <span class="n">AssemblerPredicate</span><span class="o">&lt;</span><span class="s">&quot;FeatureChapter3_4&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">Ch3_5</span>       <span class="o">:</span>     <span class="n">Predicate</span><span class="o">&lt;</span><span class="s">&quot;Subtarget-&gt;hasChapter3_5()&quot;</span><span class="o">&gt;</span><span class="p">,</span>
                      <span class="n">AssemblerPredicate</span><span class="o">&lt;</span><span class="s">&quot;FeatureChapter3_5&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">Ch4_1</span>       <span class="o">:</span>     <span class="n">Predicate</span><span class="o">&lt;</span><span class="s">&quot;Subtarget-&gt;hasChapter4_1()&quot;</span><span class="o">&gt;</span><span class="p">,</span>
                      <span class="n">AssemblerPredicate</span><span class="o">&lt;</span><span class="s">&quot;FeatureChapter4_1&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">Ch4_2</span>       <span class="o">:</span>     <span class="n">Predicate</span><span class="o">&lt;</span><span class="s">&quot;Subtarget-&gt;hasChapter4_2()&quot;</span><span class="o">&gt;</span><span class="p">,</span>
                      <span class="n">AssemblerPredicate</span><span class="o">&lt;</span><span class="s">&quot;FeatureChapter4_2&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">Ch5_1</span>       <span class="o">:</span>     <span class="n">Predicate</span><span class="o">&lt;</span><span class="s">&quot;Subtarget-&gt;hasChapter5_1()&quot;</span><span class="o">&gt;</span><span class="p">,</span>
                      <span class="n">AssemblerPredicate</span><span class="o">&lt;</span><span class="s">&quot;FeatureChapter5_1&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">Ch6_1</span>       <span class="o">:</span>     <span class="n">Predicate</span><span class="o">&lt;</span><span class="s">&quot;Subtarget-&gt;hasChapter6_1()&quot;</span><span class="o">&gt;</span><span class="p">,</span>
                      <span class="n">AssemblerPredicate</span><span class="o">&lt;</span><span class="s">&quot;FeatureChapter6_1&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">Ch7_1</span>       <span class="o">:</span>     <span class="n">Predicate</span><span class="o">&lt;</span><span class="s">&quot;Subtarget-&gt;hasChapter7_1()&quot;</span><span class="o">&gt;</span><span class="p">,</span>
                      <span class="n">AssemblerPredicate</span><span class="o">&lt;</span><span class="s">&quot;FeatureChapter7_1&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">Ch8_1</span>       <span class="o">:</span>     <span class="n">Predicate</span><span class="o">&lt;</span><span class="s">&quot;Subtarget-&gt;hasChapter8_1()&quot;</span><span class="o">&gt;</span><span class="p">,</span>
                      <span class="n">AssemblerPredicate</span><span class="o">&lt;</span><span class="s">&quot;FeatureChapter8_1&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">Ch8_2</span>       <span class="o">:</span>     <span class="n">Predicate</span><span class="o">&lt;</span><span class="s">&quot;Subtarget-&gt;hasChapter8_2()&quot;</span><span class="o">&gt;</span><span class="p">,</span>
                      <span class="n">AssemblerPredicate</span><span class="o">&lt;</span><span class="s">&quot;FeatureChapter8_2&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">Ch9_1</span>       <span class="o">:</span>     <span class="n">Predicate</span><span class="o">&lt;</span><span class="s">&quot;Subtarget-&gt;hasChapter9_1()&quot;</span><span class="o">&gt;</span><span class="p">,</span>
                      <span class="n">AssemblerPredicate</span><span class="o">&lt;</span><span class="s">&quot;FeatureChapter9_1&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">Ch9_2</span>       <span class="o">:</span>     <span class="n">Predicate</span><span class="o">&lt;</span><span class="s">&quot;Subtarget-&gt;hasChapter9_2()&quot;</span><span class="o">&gt;</span><span class="p">,</span>
                      <span class="n">AssemblerPredicate</span><span class="o">&lt;</span><span class="s">&quot;FeatureChapter9_2&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">Ch9_3</span>       <span class="o">:</span>     <span class="n">Predicate</span><span class="o">&lt;</span><span class="s">&quot;Subtarget-&gt;hasChapter9_3()&quot;</span><span class="o">&gt;</span><span class="p">,</span>
                      <span class="n">AssemblerPredicate</span><span class="o">&lt;</span><span class="s">&quot;FeatureChapter9_3&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">Ch10_1</span>      <span class="o">:</span>     <span class="n">Predicate</span><span class="o">&lt;</span><span class="s">&quot;Subtarget-&gt;hasChapter10_1()&quot;</span><span class="o">&gt;</span><span class="p">,</span>
                      <span class="n">AssemblerPredicate</span><span class="o">&lt;</span><span class="s">&quot;FeatureChapter10_1&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">Ch11_1</span>      <span class="o">:</span>     <span class="n">Predicate</span><span class="o">&lt;</span><span class="s">&quot;Subtarget-&gt;hasChapter11_1()&quot;</span><span class="o">&gt;</span><span class="p">,</span>
                      <span class="n">AssemblerPredicate</span><span class="o">&lt;</span><span class="s">&quot;FeatureChapter11_1&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">Ch11_2</span>      <span class="o">:</span>     <span class="n">Predicate</span><span class="o">&lt;</span><span class="s">&quot;Subtarget-&gt;hasChapter11_2()&quot;</span><span class="o">&gt;</span><span class="p">,</span>
                      <span class="n">AssemblerPredicate</span><span class="o">&lt;</span><span class="s">&quot;FeatureChapter11_2&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">Ch12_1</span>      <span class="o">:</span>     <span class="n">Predicate</span><span class="o">&lt;</span><span class="s">&quot;Subtarget-&gt;hasChapter12_1()&quot;</span><span class="o">&gt;</span><span class="p">,</span>
                      <span class="n">AssemblerPredicate</span><span class="o">&lt;</span><span class="s">&quot;FeatureChapter12_1&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">Ch_all</span>      <span class="o">:</span>     <span class="n">Predicate</span><span class="o">&lt;</span><span class="s">&quot;Subtarget-&gt;hasChapterAll()&quot;</span><span class="o">&gt;</span><span class="p">,</span>
                      <span class="n">AssemblerPredicate</span><span class="o">&lt;</span><span class="s">&quot;FeatureChapterAll&quot;</span><span class="o">&gt;</span><span class="p">;</span>

<span class="n">def</span> <span class="n">EnableOverflow</span>  <span class="o">:</span> <span class="n">Predicate</span><span class="o">&lt;</span><span class="s">&quot;Subtarget-&gt;enableOverflow()&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">DisableOverflow</span> <span class="o">:</span> <span class="n">Predicate</span><span class="o">&lt;</span><span class="s">&quot;Subtarget-&gt;disableOverflow()&quot;</span><span class="o">&gt;</span><span class="p">;</span>

<span class="n">def</span> <span class="n">HasCmp</span>      <span class="o">:</span>     <span class="n">Predicate</span><span class="o">&lt;</span><span class="s">&quot;Subtarget-&gt;hasCmp()&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">HasSlt</span>      <span class="o">:</span>     <span class="n">Predicate</span><span class="o">&lt;</span><span class="s">&quot;Subtarget-&gt;hasSlt()&quot;</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0ISelLowering.h</p>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0ISelLowering.cpp</p>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0SEISelLowering.h</p>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0SEISelLowering.cpp</p>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0MachineFunction.h</p>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0MachineFunction.cpp</p>
<p class="rubric">lbdex/chapters/Chapter3_1/MCTargetDesc/Cpu0ABIInfo.h</p>
<p class="rubric">lbdex/chapters/Chapter3_1/MCTargetDesc/Cpu0ABIInfo.cpp</p>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0Subtarget.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="cp">#include &quot;Cpu0FrameLowering.h&quot;</span>
<span class="cp">#include &quot;Cpu0ISelLowering.h&quot;</span>
<span class="cp">#include &quot;Cpu0InstrInfo.h&quot;</span>
<span class="cp">#include &quot;llvm/IR/DataLayout.h&quot;</span>
<span class="cp">#include &quot;llvm/MC/MCInstrItineraries.h&quot;</span>
<span class="cp">#include &quot;llvm/Target/TargetSelectionDAGInfo.h&quot;</span>
<span class="cp">#include &quot;llvm/Target/TargetSubtargetInfo.h&quot;</span>
<span class="cp">#include &lt;string&gt;</span>

<span class="cp">#define GET_SUBTARGETINFO_HEADER</span>
<span class="cp">#include &quot;Cpu0GenSubtargetInfo.inc&quot;</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="k">namespace</span> <span class="n">llvm</span> <span class="p">{</span>
<span class="k">class</span> <span class="nc">StringRef</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Cpu0TargetMachine</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Cpu0Subtarget</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Cpu0GenSubtargetInfo</span> <span class="p">{</span>
  <span class="k">virtual</span> <span class="kt">void</span> <span class="n">anchor</span><span class="p">();</span>

<span class="nl">public:</span>

  <span class="kt">bool</span> <span class="n">HasChapterDummy</span><span class="p">;</span>
  <span class="kt">bool</span> <span class="n">HasChapterAll</span><span class="p">;</span>

  <span class="kt">bool</span> <span class="n">hasChapter3_1</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
<span class="cp">#if CH &gt;= CH3_1</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="cp">#else</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="cp">#endif</span>
  <span class="p">}</span>

  <span class="kt">bool</span> <span class="n">hasChapter3_2</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
<span class="cp">#if CH &gt;= CH3_2</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="cp">#else</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="cp">#endif</span>
  <span class="p">}</span>

  <span class="kt">bool</span> <span class="n">hasChapter3_3</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
<span class="cp">#if CH &gt;= CH3_3</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="cp">#else</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="cp">#endif</span>
  <span class="p">}</span>

  <span class="kt">bool</span> <span class="n">hasChapter3_4</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
<span class="cp">#if CH &gt;= CH3_4</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="cp">#else</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="cp">#endif</span>
  <span class="p">}</span>

  <span class="kt">bool</span> <span class="n">hasChapter3_5</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
<span class="cp">#if CH &gt;= CH3_5</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="cp">#else</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="cp">#endif</span>
  <span class="p">}</span>

  <span class="kt">bool</span> <span class="n">hasChapter4_1</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
<span class="cp">#if CH &gt;= CH4_1</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="cp">#else</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="cp">#endif</span>
  <span class="p">}</span>

  <span class="kt">bool</span> <span class="n">hasChapter4_2</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
<span class="cp">#if CH &gt;= CH4_2</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="cp">#else</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="cp">#endif</span>
  <span class="p">}</span>

  <span class="kt">bool</span> <span class="n">hasChapter5_1</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
<span class="cp">#if CH &gt;= CH5_1</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="cp">#else</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="cp">#endif</span>
  <span class="p">}</span>

  <span class="kt">bool</span> <span class="n">hasChapter6_1</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
<span class="cp">#if CH &gt;= CH6_1</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="cp">#else</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="cp">#endif</span>
  <span class="p">}</span>

  <span class="kt">bool</span> <span class="n">hasChapter7_1</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
<span class="cp">#if CH &gt;= CH7_1</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="cp">#else</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="cp">#endif</span>
  <span class="p">}</span>

  <span class="kt">bool</span> <span class="n">hasChapter8_1</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
<span class="cp">#if CH &gt;= CH8_1</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="cp">#else</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="cp">#endif</span>
  <span class="p">}</span>

  <span class="kt">bool</span> <span class="n">hasChapter8_2</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
<span class="cp">#if CH &gt;= CH8_2</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="cp">#else</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="cp">#endif</span>
  <span class="p">}</span>
  
  <span class="kt">bool</span> <span class="n">hasChapter9_1</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
<span class="cp">#if CH &gt;= CH9_1</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="cp">#else</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="cp">#endif</span>
  <span class="p">}</span>

  <span class="kt">bool</span> <span class="n">hasChapter9_2</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
<span class="cp">#if CH &gt;= CH9_2</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="cp">#else</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="cp">#endif</span>
  <span class="p">}</span>

  <span class="kt">bool</span> <span class="n">hasChapter9_3</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
<span class="cp">#if CH &gt;= CH9_3</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="cp">#else</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="cp">#endif</span>
  <span class="p">}</span>

  <span class="kt">bool</span> <span class="n">hasChapter10_1</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
<span class="cp">#if CH &gt;= CH10_1</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="cp">#else</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="cp">#endif</span>
  <span class="p">}</span>

  <span class="kt">bool</span> <span class="n">hasChapter11_1</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
<span class="cp">#if CH &gt;= CH11_1</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="cp">#else</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="cp">#endif</span>
  <span class="p">}</span>

  <span class="kt">bool</span> <span class="n">hasChapter11_2</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
<span class="cp">#if CH &gt;= CH11_2</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="cp">#else</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="cp">#endif</span>
  <span class="p">}</span>

  <span class="kt">bool</span> <span class="n">hasChapter12_1</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
<span class="cp">#if CH &gt;= CH12_1</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="cp">#else</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="cp">#endif</span>
  <span class="p">}</span>

<span class="nl">protected:</span>
  <span class="k">enum</span> <span class="n">Cpu0ArchEnum</span> <span class="p">{</span>
    <span class="n">Cpu032I</span><span class="p">,</span>
    <span class="n">Cpu032II</span>
  <span class="p">};</span>

  <span class="c1">// Cpu0 architecture version</span>
  <span class="n">Cpu0ArchEnum</span> <span class="n">Cpu0ArchVersion</span><span class="p">;</span>

  <span class="c1">// IsLittle - The target is Little Endian</span>
  <span class="kt">bool</span> <span class="n">IsLittle</span><span class="p">;</span>

  <span class="kt">bool</span> <span class="n">EnableOverflow</span><span class="p">;</span>

  <span class="c1">// HasCmp - cmp instructions.</span>
  <span class="kt">bool</span> <span class="n">HasCmp</span><span class="p">;</span>

  <span class="c1">// HasSlt - slt instructions.</span>
  <span class="kt">bool</span> <span class="n">HasSlt</span><span class="p">;</span>

  <span class="n">InstrItineraryData</span> <span class="n">InstrItins</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="k">const</span> <span class="n">Cpu0TargetMachine</span> <span class="o">&amp;</span><span class="n">TM</span><span class="p">;</span>

  <span class="n">Triple</span> <span class="n">TargetTriple</span><span class="p">;</span>

  <span class="k">const</span> <span class="n">TargetSelectionDAGInfo</span> <span class="n">TSInfo</span><span class="p">;</span>

  <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">Cpu0InstrInfo</span><span class="o">&gt;</span> <span class="n">InstrInfo</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">Cpu0FrameLowering</span><span class="o">&gt;</span> <span class="n">FrameLowering</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">Cpu0TargetLowering</span><span class="o">&gt;</span> <span class="n">TLInfo</span><span class="p">;</span>

<span class="nl">public:</span>
  <span class="c1">/// This constructor initializes the data members to match that</span>
  <span class="c1">/// of the specified triple.</span>
  <span class="n">Cpu0Subtarget</span><span class="p">(</span><span class="k">const</span> <span class="n">Triple</span> <span class="o">&amp;</span><span class="n">TT</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">CPU</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">FS</span><span class="p">,</span>
                <span class="kt">bool</span> <span class="n">little</span><span class="p">,</span> <span class="k">const</span> <span class="n">Cpu0TargetMachine</span> <span class="o">&amp;</span><span class="n">_TM</span><span class="p">);</span>

<span class="c1">//- Vitual function, must have</span>
  <span class="c1">/// ParseSubtargetFeatures - Parses features string setting specified</span>
  <span class="c1">/// subtarget options.  Definition of function is auto generated by tblgen.</span>
  <span class="kt">void</span> <span class="nf">ParseSubtargetFeatures</span><span class="p">(</span><span class="n">StringRef</span> <span class="n">CPU</span><span class="p">,</span> <span class="n">StringRef</span> <span class="n">FS</span><span class="p">);</span>

  <span class="kt">bool</span> <span class="n">isLittle</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">IsLittle</span><span class="p">;</span> <span class="p">}</span>
  <span class="kt">bool</span> <span class="n">hasCpu032I</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">Cpu0ArchVersion</span> <span class="o">&gt;=</span> <span class="n">Cpu032I</span><span class="p">;</span> <span class="p">}</span>
  <span class="kt">bool</span> <span class="n">isCpu032I</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">Cpu0ArchVersion</span> <span class="o">==</span> <span class="n">Cpu032I</span><span class="p">;</span> <span class="p">}</span>
  <span class="kt">bool</span> <span class="n">hasCpu032II</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">Cpu0ArchVersion</span> <span class="o">&gt;=</span> <span class="n">Cpu032II</span><span class="p">;</span> <span class="p">}</span>
  <span class="kt">bool</span> <span class="n">isCpu032II</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">Cpu0ArchVersion</span> <span class="o">==</span> <span class="n">Cpu032II</span><span class="p">;</span> <span class="p">}</span>

  <span class="c1">/// Features related to the presence of specific instructions.</span>
  <span class="kt">bool</span> <span class="n">enableOverflow</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">EnableOverflow</span><span class="p">;</span> <span class="p">}</span>
  <span class="kt">bool</span> <span class="n">disableOverflow</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="o">!</span><span class="n">EnableOverflow</span><span class="p">;</span> <span class="p">}</span>
  <span class="kt">bool</span> <span class="n">hasCmp</span><span class="p">()</span>   <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">HasCmp</span><span class="p">;</span> <span class="p">}</span>
  <span class="kt">bool</span> <span class="n">hasSlt</span><span class="p">()</span>   <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">HasSlt</span><span class="p">;</span> <span class="p">}</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="kt">bool</span> <span class="n">abiUsesSoftFloat</span><span class="p">()</span> <span class="k">const</span><span class="p">;</span>

  <span class="k">const</span> <span class="n">InstrItineraryData</span> <span class="o">*</span><span class="n">getInstrItineraryData</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="o">&amp;</span><span class="n">InstrItins</span><span class="p">;</span> <span class="p">}</span>

  <span class="kt">unsigned</span> <span class="n">stackAlignment</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">8</span><span class="p">;</span> <span class="p">}</span>

  <span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">initializeSubtargetDependencies</span><span class="p">(</span><span class="n">StringRef</span> <span class="n">CPU</span><span class="p">,</span> <span class="n">StringRef</span> <span class="n">FS</span><span class="p">,</span>
                                                 <span class="k">const</span> <span class="n">TargetMachine</span> <span class="o">&amp;</span><span class="n">TM</span><span class="p">);</span>

  <span class="k">const</span> <span class="n">Cpu0InstrInfo</span> <span class="o">*</span><span class="nf">getInstrInfo</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">InstrInfo</span><span class="p">.</span><span class="n">get</span><span class="p">();</span> <span class="p">}</span>
  <span class="k">const</span> <span class="n">TargetFrameLowering</span> <span class="o">*</span><span class="n">getFrameLowering</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">FrameLowering</span><span class="p">.</span><span class="n">get</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="k">const</span> <span class="n">Cpu0RegisterInfo</span> <span class="o">*</span><span class="n">getRegisterInfo</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="n">InstrInfo</span><span class="o">-&gt;</span><span class="n">getRegisterInfo</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="k">const</span> <span class="n">Cpu0TargetLowering</span> <span class="o">*</span><span class="n">getTargetLowering</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">TLInfo</span><span class="p">.</span><span class="n">get</span><span class="p">();</span> <span class="p">}</span>
<span class="p">};</span>
<span class="p">}</span> <span class="c1">// End llvm namespace</span>


<span class="cp">#endif</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0Subtarget.cpp</p>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0RegisterInfo.h</p>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0RegisterInfo.cpp</p>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0SERegisterInfo.h</p>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0SERegisterInfo.cpp</p>
<p class="rubric">cmake_debug_build/lib/Target/Cpu0/Cpu0GenInstInfo.inc</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">//- Cpu0GenInstInfo.inc which generate from Cpu0InstrInfo.td</span>
<span class="cp">#ifdef GET_INSTRINFO_HEADER</span>
<span class="cp">#undef GET_INSTRINFO_HEADER</span>
<span class="k">namespace</span> <span class="n">llvm</span> <span class="p">{</span>
<span class="k">struct</span> <span class="n">Cpu0GenInstrInfo</span> <span class="o">:</span> <span class="k">public</span> <span class="n">TargetInstrInfoImpl</span> <span class="p">{</span>
  <span class="k">explicit</span> <span class="n">Cpu0GenInstrInfo</span><span class="p">(</span><span class="kt">int</span> <span class="n">SO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">DO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="p">};</span>
<span class="p">}</span> <span class="c1">// End llvm namespace</span>
<span class="cp">#endif </span><span class="c1">// GET_INSTRINFO_HEADER</span>

<span class="cp">#define GET_INSTRINFO_HEADER</span>
<span class="cp">#include &quot;Cpu0GenInstrInfo.inc&quot;</span>
<span class="c1">//- Cpu0InstInfo.h</span>
<span class="k">class</span> <span class="nc">Cpu0InstrInfo</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Cpu0GenInstrInfo</span> <span class="p">{</span>
  <span class="n">Cpu0TargetMachine</span> <span class="o">&amp;</span><span class="n">TM</span><span class="p">;</span>
<span class="nl">public:</span>
  <span class="k">explicit</span> <span class="nf">Cpu0InstrInfo</span><span class="p">(</span><span class="n">Cpu0TargetMachine</span> <span class="o">&amp;</span><span class="n">TM</span><span class="p">);</span>
<span class="p">};</span>
</pre></div>
</div>
<div class="figure align-center" id="backendstructure-f1">
<img alt="_images/11.png" src="_images/11.png" />
<p class="caption">Figure 1: Cpu0 backend class access link</p>
</div>
<p>Chapter3_1 add most Cpu0 backend classes. The code of Chapter3_1 can be
summaried as <a class="pageref" href="#backendstructure-f1">Figure  1</a>.
Class Cpu0Subtarget supply the interface getInstrInfo(), getFrameLowering(),
..., to get other Cpu0 classes.
Most classes (like Cpu0InstrInfo, Cpu0RegisterInfo, ...) have Subtarget
reference member to allow them access other classes through the Cpu0Subtarget
interface list in <a class="pageref" href="#backendstructure-f1">Figure  1</a>.
Classes (maybe added at later chapters) can access Subtarget class
through Cpu0TargetMachine (usually use TM as symbol) by TM.getSubtargetImpl().
Once get Subtarget class, the backend code can accesss other classes through it.
For those classes name of Cpu0SExx, they mean the standard 32 bits class.
This arrangement follows llvm 3.5 Mips backend style. In Mips backend, it uses
Mips16, MipsSE and Mips64 files/class name to define class function for 16,
32 and 64 bits architecture, respectively.
Since Cpu0Subtarget creates Cpu0InstrInfo, Cpu0RegisterInfo, ..., at constuctor
function, it can supply the class reference through the interfaces shown in
<a class="pageref" href="#backendstructure-f1">Figure  1</a>.</p>
<p>Below <a class="pageref" href="#backendstructure-f2">Figure  2</a> shows Cpu0 TableGen inheritance
relationship.
Last chapter mentioned llvm TableGen (llvm-tblgen) is used in code generation
process.
Backend class can choose the TableGen generated classes and inherited from it.
There are more TableGen generated classes, and they all exist in
cmake_debug_build/lib/Target/Cpu0/*.inc. Through C++ inheritance mechanism,
TableGen provides backend programmer a fexible way to use its generated
code. Programmer has chance to override this function if it need to.</p>
<div class="figure align-center" id="backendstructure-f2">
<img alt="_images/2.png" src="_images/2.png" />
<p class="caption">Figure 2: Cpu0 classes inherited from TableGen generated files</p>
</div>
<p>Since llvm has deep inheritance tree, they are not digged here.
Benefit from the inheritance tree structure, there are not too much code need
to be implemented in classes of instruction, frame/stack and select DAG, since
many code are implemented by their parent class.
The llvm-tblgen generate Cpu0GenInstrInfo.inc from Cpu0InstrInfo.td.
Cpu0InstrInfo.h extract those code it needs from Cpu0GenInstrInfo.inc by define
“#define GET_INSTRINFO_HEADER”.
With TabelGen, the code size in backend is reduced again through the pattern
match theory of compiler developemnt. This is explained in sections
of DAG and Instruction Selection in last chapter.
Following is the code fragment from Cpu0GenInstrInfo.inc.
Code between &#8220;#if def  GET_INSTRINFO_HEADER&#8221; and
&#8220;#endif // GET_INSTRINFO_HEADER”&#8221; will be extracted to Cpu0InstrInfo.h.</p>
<p class="rubric">cmake_debug_build/lib/Target/Cpu0/Cpu0GenInstInfo.inc</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">//- Cpu0GenInstInfo.inc which generate from Cpu0InstrInfo.td</span>
<span class="cp">#ifdef GET_INSTRINFO_HEADER</span>
<span class="cp">#undef GET_INSTRINFO_HEADER</span>
<span class="k">namespace</span> <span class="n">llvm</span> <span class="p">{</span>
<span class="k">struct</span> <span class="n">Cpu0GenInstrInfo</span> <span class="o">:</span> <span class="k">public</span> <span class="n">TargetInstrInfoImpl</span> <span class="p">{</span>
  <span class="k">explicit</span> <span class="n">Cpu0GenInstrInfo</span><span class="p">(</span><span class="kt">int</span> <span class="n">SO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">DO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="p">};</span>
<span class="p">}</span> <span class="c1">// End llvm namespace</span>
<span class="cp">#endif </span><span class="c1">// GET_INSTRINFO_HEADER</span>
</pre></div>
</div>
<p>Reference &#8220;Write An LLVM Backend&#8221; web site <a class="footnote-reference" href="#id3" id="id1">[1]</a>.</p>
<p>Chapter3_1/CMakeLists.txt  modified with these new added *.cpp as follows,</p>
<p class="rubric">lbdex/chapters/Chapter3_1/CMakeLists.txt</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">tablegen</span><span class="p">(</span><span class="n">LLVM</span> <span class="n">Cpu0GenDAGISel</span><span class="p">.</span><span class="n">inc</span> <span class="o">-</span><span class="n">gen</span><span class="o">-</span><span class="n">dag</span><span class="o">-</span><span class="n">isel</span><span class="p">)</span>
<span class="n">tablegen</span><span class="p">(</span><span class="n">LLVM</span> <span class="n">Cpu0GenCallingConv</span><span class="p">.</span><span class="n">inc</span> <span class="o">-</span><span class="n">gen</span><span class="o">-</span><span class="n">callingconv</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="n">Cpu0FrameLowering</span><span class="p">.</span><span class="n">cpp</span>
  <span class="n">Cpu0InstrInfo</span><span class="p">.</span><span class="n">cpp</span>
  <span class="n">Cpu0ISelLowering</span><span class="p">.</span><span class="n">cpp</span>
  <span class="n">Cpu0MachineFunction</span><span class="p">.</span><span class="n">cpp</span>
  <span class="n">Cpu0RegisterInfo</span><span class="p">.</span><span class="n">cpp</span>
  <span class="n">Cpu0SEFrameLowering</span><span class="p">.</span><span class="n">cpp</span>
  <span class="n">Cpu0SEInstrInfo</span><span class="p">.</span><span class="n">cpp</span>
  <span class="n">Cpu0SEISelLowering</span><span class="p">.</span><span class="n">cpp</span>
  <span class="n">Cpu0SERegisterInfo</span><span class="p">.</span><span class="n">cpp</span>
  <span class="n">Cpu0Subtarget</span><span class="p">.</span><span class="n">cpp</span>
  <span class="n">Cpu0TargetObjectFile</span><span class="p">.</span><span class="n">cpp</span>
</pre></div>
</div>
<p>Please take a look for Chapter3_1 code.
After that, building Chapter3_1 by <strong>&#8220;#define CH  CH2&#8221;</strong> in Cpu0Config.h as
follows, and do building with Xcode on iMac or make on linux again.</p>
<p class="rubric">~/llvm/test/src/lib/Target/Cpu0SetChapter.h</p>
<div class="highlight-c++"><div class="highlight"><pre>#define CH       CH3_1

118-165-78-230:input Jonathan$ /Users/Jonathan/llvm/test/cmake_debug_build/
Debug/bin/llc -march=cpu0 -relocation-model=pic -filetype=asm ch3.bc -o
ch3.cpu0.s
... Assertion `AsmInfo &amp;&amp; &quot;MCAsmInfo not initialized. &quot;
...
</pre></div>
</div>
<p>With Chapter3_1 implementation, the Chapter2 error message
&#8220;Could not allocate target machine!&#8221; has gone.
The new errors say that we have not Target AsmPrinter.
We will add it in next section.</p>
<p>Chapter3_1 create FeatureCpu032I and FeatureCpu032II for CPU cpu032I and
cpu032II, repectively.
Beyond that, it defines two more features, FeatureCmp and FeatureSlt.
In order to demostrate the &#8220;instruction set design choice&#8221; to readers, this book
create two CPU. Readers will realize why Mips CPU uses instruction SLT instead of
CMP when they go to later Chapter &#8220;Control flow statement&#8221;.
With the added code of supporting cpu032I and cpu32II in Cpu0.td and
Cpu0InstrInfo.td of Chapter3_1, the command <tt class="docutils literal"><span class="pre">llc</span> <span class="pre">-march=cpu0</span> <span class="pre">-mcpu=help</span></tt> can
display messages as follows,</p>
<div class="highlight-bash"><div class="highlight"><pre>JonathantekiiMac:input Jonathan<span class="nv">$ </span>/Users/Jonathan/llvm/test/
cmake_debug_build/Debug/bin/llc -march<span class="o">=</span>cpu0 -mcpu<span class="o">=</span><span class="nb">help</span>
Available CPUs <span class="k">for </span>this target:

  cpu032I  - Select the cpu032I processor.
  cpu032II - Select the cpu032II processor.

Available features <span class="k">for </span>this target:

  ch10_1   - Enable Chapter instructions..
  ch11_1   - Enable Chapter instructions..
  ch11_2   - Enable Chapter instructions..
  ch14_1   - Enable Chapter instructions..
  ch3_1    - Enable Chapter instructions..
  ch3_2    - Enable Chapter instructions..
  ch3_3    - Enable Chapter instructions..
  ch3_4    - Enable Chapter instructions..
  ch3_5    - Enable Chapter instructions..
  ch4_1    - Enable Chapter instructions..
  ch4_2    - Enable Chapter instructions..
  ch5_1    - Enable Chapter instructions..
  ch6_1    - Enable Chapter instructions..
  ch7_1    - Enable Chapter instructions..
  ch8_1    - Enable Chapter instructions..
  ch8_2    - Enable Chapter instructions..
  ch9_1    - Enable Chapter instructions..
  ch9_2    - Enable Chapter instructions..
  ch9_3    - Enable Chapter instructions..
  chall    - Enable Chapter instructions..
  cmp      - Enable <span class="s1">&#39;cmp&#39;</span> instructions..
  cpu032I  - Cpu032I ISA Support.
  cpu032II - Cpu032II ISA Support <span class="o">(</span>slt<span class="o">)</span>.
  o32      - Enable o32 ABI.
  s32      - Enable s32 ABI.
  slt      - Enable <span class="s1">&#39;slt&#39;</span> instructions..

Use +feature to <span class="nb">enable </span>a feature, or -feature to disable it.
For example, llc -mcpu<span class="o">=</span>mycpu -mattr<span class="o">=</span>+feature1,-feature2
...
</pre></div>
</div>
<p>When user input <tt class="docutils literal"><span class="pre">-mcpu=cpu032I</span></tt>, the variable IsCpu032I from Cpu0InstrInfo.td
will be true since the function isCpu032I() defined in Cpu0Subtarget.h is true
by checking variable CPU in constructor function (the variable CPU is &#8220;cpu032I&#8221;
when user input -mcpu=cpu032I).
Please notice variable Cpu0ArchVersion must be initialized in
Cpu0Subtarget.cpp, otherwise variable Cpu0ArchVersion can be any value and
functions isCpu032I() and isCpu032II() which support <tt class="docutils literal"><span class="pre">llc</span> <span class="pre">-mcpu=cpu032I</span></tt> and
<tt class="docutils literal"><span class="pre">llc</span> <span class="pre">-mcpu=cpu032II</span></tt>, repectively, will have trouble.
The value of variables HasCmp and HasSlt are set depend on Cpu0ArchVersion.
Instructions slt and beq, ... are supported only in case of HasSlt is true, and
furthmore, HasSlt is true only when Cpu0ArchVersion is Cpu032II.
Similiarly, Ch4_1, Ch4_2, ..., are used in controlling the enable or disable of
instruction definition. Through <strong>Subtarget-&gt;hasChapter4_1()</strong> which exists
both in Cpu0.td and Cpu0Subtarget.h, the Predicate, such as Ch4_1, defined in
Cpu0InstrInfo.td can be enabled or disabled. For example, the shift-rotate
instructions can be enabled by define CH to greater than or equal to CH4_1 as
follows,</p>
<p class="rubric">lbdex/Cpu0/Cpu0InstrInfo.td</p>
<div class="highlight-c++"><div class="highlight"><pre>let Predicates = [Ch4_1] in {
class shift_rotate_reg&lt;bits&lt;8&gt; op, bits&lt;4&gt; isRotate, string instr_asm,
                       SDNode OpNode, RegisterClass RC&gt;:
  FA&lt;op, (outs GPROut:$ra), (ins RC:$rb, RC:$rc),
     !strconcat(instr_asm, &quot;\t$ra, $rb, $rc&quot;),
     [(set GPROut:$ra, (OpNode RC:$rb, RC:$rc))], IIAlu&gt; {
  let shamt = 0;
}
}
</pre></div>
</div>
<p class="rubric">~/llvm/test/src/lib/Target/Cpu0SetChapter.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="cp">#define CH       CH4_1</span>
</pre></div>
</div>
<p>On the contrary, it can be disabled by define it to less than CH4_1, such as
CH3_5, as follows,</p>
<p class="rubric">~/llvm/test/src/lib/Target/Cpu0SetChapter.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="cp">#define CH       CH3_5</span>
</pre></div>
</div>
</div>
<div class="section" id="add-asmprinter">
<h2><a class="toc-backref" href="#id6">Add AsmPrinter</a><a class="headerlink" href="#add-asmprinter" title="Permalink to this headline">¶</a></h2>
<p>Chapter3_2/ contains the Cpu0AsmPrinter definition.</p>
<p class="rubric">lbdex/chapters/Chapter2/Cpu0.td</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">def</span> <span class="n">Cpu0InstrInfo</span> <span class="o">:</span> <span class="n">InstrInfo</span><span class="p">;</span>

<span class="c1">// Will generate Cpu0GenAsmWrite.inc included by Cpu0InstPrinter.cpp, contents</span>
<span class="c1">//  as follows,</span>
<span class="c1">// void Cpu0InstPrinter::printInstruction(const MCInst *MI, raw_ostream &amp;O) {...}</span>
<span class="c1">// const char *Cpu0InstPrinter::getRegisterName(unsigned RegNo) {...}</span>
<span class="n">def</span> <span class="n">Cpu0</span> <span class="o">:</span> <span class="n">Target</span> <span class="p">{</span>
<span class="c1">// def Cpu0InstrInfo : InstrInfo as before.</span>
  <span class="n">let</span> <span class="n">InstructionSet</span> <span class="o">=</span> <span class="n">Cpu0InstrInfo</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>As above comments of Chapter2/Cpu0.td indicate, it will generate
Cpu0GenAsmWrite.inc which is included by Cpu0InstPrinter.cpp as follows,</p>
<p class="rubric">lbdex/chapters/Chapter3_2/InstPrinter/Cpu0InstPrinter.h</p>
<p class="rubric">lbdex/chapters/Chapter3_2/InstPrinter/Cpu0InstPrinter.cpp</p>
<p class="rubric">lbdex/chapters/Chapter3_2/InstPrinter/CMakeLists.txt</p>
<p class="rubric">lbdex/chapters/Chapter3_2/InstPrinter/LLVMBuild.txt</p>
<p>Cpu0GenAsmWrite.inc has the implementations of
Cpu0InstPrinter::printInstruction() and Cpu0InstPrinter::getRegisterName().
Both of these functions can be auto-generated from the information we defined
in Cpu0InstrInfo.td and Cpu0RegisterInfo.td.
To let these two functions work in our code, the only thing needed is adding a
class Cpu0InstPrinter and include them as did in Chapter3_1.</p>
<p>File Chapter3_2/Cpu0/InstPrinter/Cpu0InstPrinter.cpp include Cpu0GenAsmWrite.inc
and call the auto-generated functions from TableGen.</p>
<p>Function Cpu0InstPrinter::printMemOperand() defined in Chapter3_2/InstPrinter/
Cpu0InstPrinter.cpp as above. It will be triggered since Cpu0InstrInfo.td
defined <strong>&#8216;let PrintMethod = &#8220;printMemOperand&#8221;;&#8217;</strong> as follows,</p>
<p class="rubric">lbdex/chapters/Chapter2/Cpu0InstrInfo.td</p>
<div class="highlight-c++"><div class="highlight"><pre>// Address operand
def mem : Operand&lt;i32&gt; {
  let PrintMethod = &quot;printMemOperand&quot;;
  let MIOperandInfo = (ops CPURegs, simm16);
  let EncoderMethod = &quot;getMemEncoding&quot;;
//#if CH &gt;= CH11_1
  let ParserMatchClass = Cpu0MemAsmOperand;
//#endif
}
...
// 32-bit load.
multiclass LoadM32&lt;bits&lt;8&gt; op, string instr_asm, PatFrag OpNode,
                   bit Pseudo = 0&gt; {
  def #NAME# : LoadM&lt;op, instr_asm, OpNode, GPROut, mem, Pseudo&gt;;
}

// 32-bit store.
multiclass StoreM32&lt;bits&lt;8&gt; op, string instr_asm, PatFrag OpNode,
                    bit Pseudo = 0&gt; {
  def #NAME# : StoreM&lt;op, instr_asm, OpNode, CPURegs, mem, Pseudo&gt;;
}

defm LD     : LoadM32&lt;0x01,  &quot;ld&quot;,  load_a&gt;;
defm ST     : StoreM32&lt;0x02, &quot;st&quot;,  store_a&gt;;
</pre></div>
</div>
<p>Cpu0InstPrinter::printMemOperand() will print backend operands for &#8220;local
variable access&#8221;, which like the following,</p>
<div class="highlight-bash"><div class="highlight"><pre>ld    <span class="nv">$2</span>, 16<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
st    <span class="nv">$2</span>, 8<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
</pre></div>
</div>
<p>Next, add Cpu0MCInstLower (Cpu0MCInstLower.h, Cpu0MCInstLower.cpp) as well as
Cpu0BaseInfo.h,
Cpu0FixupKinds.h and Cpu0MCAsmInfo (Cpu0MCAsmInfo.h, Cpu0MCAsmInfo.cpp) in
sub-directory MCTargetDesc as follows,</p>
<p class="rubric">lbdex/chapters/Chapter3_2/Cpu0MCInstLower.h</p>
<p class="rubric">lbdex/chapters/Chapter3_2/Cpu0MCInstLower.cpp</p>
<p class="rubric">lbdex/chapters/Chapter3_2/MCTargetDesc/Cpu0BaseInfo.h</p>
<p class="rubric">lbdex/chapters/Chapter3_2/Cpu0MCAsmInfo.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">//===-- Cpu0MCAsmInfo.h - Cpu0 Asm Info ------------------------*- C++ -*--===//</span>
<span class="c1">//</span>
<span class="c1">//                     The LLVM Compiler Infrastructure</span>
<span class="c1">//</span>
<span class="c1">// This file is distributed under the University of Illinois Open Source</span>
<span class="c1">// License. See LICENSE.TXT for details.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="c1">//</span>
<span class="c1">// This file contains the declaration of the Cpu0MCAsmInfo class.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>

<span class="cp">#ifndef CPU0TARGETASMINFO_H</span>
<span class="cp">#define CPU0TARGETASMINFO_H</span>

<span class="cp">#include &quot;Cpu0Config.h&quot;</span>
<span class="cp">#if CH &gt;= CH3_2</span>

<span class="cp">#include &quot;llvm/MC/MCAsmInfo.h&quot;</span>

<span class="k">namespace</span> <span class="n">llvm</span> <span class="p">{</span>
  <span class="k">class</span> <span class="nc">Triple</span><span class="p">;</span>
  <span class="k">class</span> <span class="nc">Target</span><span class="p">;</span>

  <span class="k">class</span> <span class="nc">Cpu0MCAsmInfo</span> <span class="o">:</span> <span class="k">public</span> <span class="n">MCAsmInfo</span> <span class="p">{</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">anchor</span><span class="p">();</span>
  <span class="nl">public:</span>
    <span class="k">explicit</span> <span class="nf">Cpu0MCAsmInfo</span><span class="p">(</span><span class="k">const</span> <span class="n">Triple</span> <span class="o">&amp;</span><span class="n">TheTriple</span><span class="p">);</span>
  <span class="p">};</span>

<span class="p">}</span> <span class="c1">// namespace llvm</span>

<span class="cp">#endif </span><span class="c1">// #if CH &gt;= CH3_2</span>

<span class="cp">#endif</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_2/Cpu0MCAsmInfo.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">//===-- Cpu0MCAsmInfo.cpp - Cpu0 Asm Properties ---------------------------===//</span>
<span class="c1">//</span>
<span class="c1">//                     The LLVM Compiler Infrastructure</span>
<span class="c1">//</span>
<span class="c1">// This file is distributed under the University of Illinois Open Source</span>
<span class="c1">// License. See LICENSE.TXT for details.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="c1">//</span>
<span class="c1">// This file contains the declarations of the Cpu0MCAsmInfo properties.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>

<span class="cp">#include &quot;Cpu0MCAsmInfo.h&quot;</span>
<span class="cp">#if CH &gt;= CH3_2</span>

<span class="cp">#include &quot;llvm/ADT/Triple.h&quot;</span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">llvm</span><span class="p">;</span>

<span class="kt">void</span> <span class="n">Cpu0MCAsmInfo</span><span class="o">::</span><span class="n">anchor</span><span class="p">()</span> <span class="p">{</span> <span class="p">}</span>

<span class="n">Cpu0MCAsmInfo</span><span class="o">::</span><span class="n">Cpu0MCAsmInfo</span><span class="p">(</span><span class="k">const</span> <span class="n">Triple</span> <span class="o">&amp;</span><span class="n">TheTriple</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">((</span><span class="n">TheTriple</span><span class="p">.</span><span class="n">getArch</span><span class="p">()</span> <span class="o">==</span> <span class="n">Triple</span><span class="o">::</span><span class="n">cpu0</span><span class="p">))</span>
    <span class="n">IsLittleEndian</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

  <span class="n">AlignmentIsInBytes</span>          <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
  <span class="n">Data16bitsDirective</span>         <span class="o">=</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">.2byte</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">;</span>
  <span class="n">Data32bitsDirective</span>         <span class="o">=</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">.4byte</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">;</span>
  <span class="n">Data64bitsDirective</span>         <span class="o">=</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">.8byte</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">;</span>
  <span class="n">PrivateGlobalPrefix</span>         <span class="o">=</span> <span class="s">&quot;$&quot;</span><span class="p">;</span>
  <span class="n">CommentString</span>               <span class="o">=</span> <span class="s">&quot;#&quot;</span><span class="p">;</span>
  <span class="n">ZeroDirective</span>               <span class="o">=</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">.space</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">;</span>
  <span class="n">GPRel32Directive</span>            <span class="o">=</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">.gpword</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">;</span>
  <span class="n">GPRel64Directive</span>            <span class="o">=</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">.gpdword</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">;</span>
  <span class="n">WeakRefDirective</span>            <span class="o">=</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">.weak</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">;</span>
  <span class="n">UseAssignmentForEHBegin</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

  <span class="n">SupportsDebugInformation</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="n">ExceptionsType</span> <span class="o">=</span> <span class="n">ExceptionHandling</span><span class="o">::</span><span class="n">DwarfCFI</span><span class="p">;</span>
  <span class="n">DwarfRegNumForCFI</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="c1">// #if CH &gt;= CH3_2</span>
</pre></div>
</div>
<p>Finally, add code in Cpu0MCTargetDesc.cpp to register Cpu0InstPrinter as
below. By the way, it register other classes (register, instruction and
subtarget) defined in Chapter3_1 at this point.</p>
<p class="rubric">lbdex/chapters/Chapter3_2/MCTargetDesc/Cpu0MCTargetDesc.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="k">namespace</span> <span class="n">llvm</span> <span class="p">{</span>
<span class="k">class</span> <span class="nc">MCAsmBackend</span><span class="p">;</span>
<span class="k">class</span> <span class="nc">MCCodeEmitter</span><span class="p">;</span>
<span class="k">class</span> <span class="nc">MCContext</span><span class="p">;</span>
<span class="k">class</span> <span class="nc">MCInstrInfo</span><span class="p">;</span>
<span class="k">class</span> <span class="nc">MCObjectWriter</span><span class="p">;</span>
<span class="k">class</span> <span class="nc">MCRegisterInfo</span><span class="p">;</span>
<span class="k">class</span> <span class="nc">MCSubtargetInfo</span><span class="p">;</span>
<span class="k">class</span> <span class="nc">StringRef</span><span class="p">;</span>
<span class="p">...</span>
<span class="k">class</span> <span class="nc">raw_ostream</span><span class="p">;</span>
<span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_2/MCTargetDesc/Cpu0MCTargetDesc.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="cp">#include &quot;InstPrinter/Cpu0InstPrinter.h&quot;</span>
<span class="cp">#include &quot;Cpu0MCAsmInfo.h&quot;</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_2/MCTargetDesc/CMakeLists.txt</p>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="n">Cpu0MCAsmInfo</span><span class="p">.</span><span class="n">cpp</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_2/MCTargetDesc/LLVMBuild.txt</p>
<div class="highlight-c++"><div class="highlight"><pre>                     <span class="n">Cpu0AsmPrinter</span> 
</pre></div>
</div>
<p>To make the registration clearly, list it in <a class="pageref" href="#backendstructure-f3">Figure  3</a>,
<a class="pageref" href="#backendstructure-f4">Figure  4</a> and <a class="pageref" href="#backendstructure-f5">Figure  5</a>.</p>
<div class="figure align-center" id="backendstructure-f3">
<a class="reference internal image-reference" href="_images/3.png"><img alt="_images/3.png" src="_images/3.png" style="width: 852.0px; height: 391.2px;" /></a>
<p class="caption">Figure 3: Cpu0 InstrInfo, RegisterInfo and SubtargetInfo register function</p>
</div>
<div class="figure align-center" id="backendstructure-f4">
<a class="reference internal image-reference" href="_images/4.png"><img alt="_images/4.png" src="_images/4.png" style="width: 573.6px; height: 422.4px;" /></a>
<p class="caption">Figure 4: Cpu0MCAsmInfo and Cpu0InstPrinter register function</p>
</div>
<div class="figure align-center" id="backendstructure-f5">
<a class="reference internal image-reference" href="_images/5.png"><img alt="_images/5.png" src="_images/5.png" style="width: 487.2px; height: 381.6px;" /></a>
<p class="caption">Figure 5: LLVMInitializeCpu0TargetMC() dynamic register</p>
</div>
<p>According &#8220;section Target Registration&#8221; <a class="footnote-reference" href="#id4" id="id2">[2]</a>, we can register Cpu0 backend
classes at LLVMInitializeCpu0TargetMC() on demand by the dynamic register
mechanism as the above function, LLVMInitializeCpu0TargetMC().
In the last section of later chapter &#8220;Generating object files&#8221;, we will
review this part and explain some of them more clearly with Figure display.
The whole registration functions will be reivewed and explained at later chapter
&#8220;Generating object files&#8221;.</p>
<p>Now, it&#8217;s time to work with AsmPrinter as follows,</p>
<p class="rubric">lbdex/chapters/Chapter3_2/Cpu0AsmPrinter.h</p>
<p class="rubric">lbdex/chapters/Chapter3_2/Cpu0AsmPrinter.cpp</p>
<p>When instruction is ready to print, function Cpu0AsmPrinter::EmitInstruction()
will be triggered first. And then it will call OutStreamer.EmitInstruction() to
print OP code and register according the information from Cpu0GenInstrInfo.inc
and Cpu0GenRegisterInfo.inc both registered at dynamic register function,
LLVMInitializeCpu0TargetMC(), as <a class="pageref" href="#backendstructure-f5">Figure  5</a> and
<a class="pageref" href="#backendstructure-f3">Figure  3</a>.
Notice, file Cpu0InstPrinter.cpp only print operand while the OP code
information come from Cpu0InstrInfo.td.</p>
<p>Add the following code to Cpu0ISelLowering.cpp.</p>
<p class="rubric">lbdex/chapters/Chapter3_2/Cpu0ISelLowering.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">Cpu0TargetLowering</span><span class="o">::</span>
<span class="n">Cpu0TargetLowering</span><span class="p">(</span><span class="n">Cpu0TargetMachine</span> <span class="o">&amp;</span><span class="n">TM</span><span class="p">)</span>
  <span class="o">:</span> <span class="n">TargetLowering</span><span class="p">(</span><span class="n">TM</span><span class="p">,</span> <span class="k">new</span> <span class="n">Cpu0TargetObjectFile</span><span class="p">()),</span>
    <span class="n">Subtarget</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TM</span><span class="p">.</span><span class="n">getSubtarget</span><span class="o">&lt;</span><span class="n">Cpu0Subtarget</span><span class="o">&gt;</span><span class="p">())</span> <span class="p">{</span>

  <span class="c1">// Set up the register classes</span>
  <span class="n">addRegisterClass</span><span class="p">(</span><span class="n">MVT</span><span class="o">::</span><span class="n">i32</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">CPURegsRegClass</span><span class="p">);</span>

<span class="c1">//- Set .align 2</span>
<span class="c1">// It will emit .align 2 later</span>
  <span class="n">setMinFunctionAlignment</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

<span class="c1">// must, computeRegisterProperties - Once all of the register classes are</span>
<span class="c1">//  added, this allows us to compute derived properties we expose.</span>
  <span class="n">computeRegisterProperties</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Add the following code to Cpu0MachineFunction.h since the Cpu0AsmPrinter.cpp
will call getEmitNOAT().</p>
<p class="rubric">lbdex/chapters/Chapter3_2/Cpu0MachineFunction.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Cpu0FunctionInfo</span> <span class="o">:</span> <span class="k">public</span> <span class="n">MachineFunctionInfo</span> <span class="p">{</span>
<span class="nl">public:</span>
  <span class="n">Cpu0FunctionInfo</span><span class="p">(</span><span class="n">MachineFunction</span><span class="o">&amp;</span> <span class="n">MF</span><span class="p">)</span>
  <span class="o">:</span> <span class="p">...</span>
    <span class="p">,</span> <span class="n">EmitNOAT</span><span class="p">(</span><span class="nb">false</span><span class="p">)</span>
    <span class="p">{}</span>

  <span class="p">...</span>
  <span class="kt">bool</span> <span class="n">getEmitNOAT</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">EmitNOAT</span><span class="p">;</span> <span class="p">}</span>
  <span class="kt">void</span> <span class="n">setEmitNOAT</span><span class="p">()</span> <span class="p">{</span> <span class="n">EmitNOAT</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span> <span class="p">}</span>
<span class="nl">private:</span>
  <span class="p">...</span>
  <span class="kt">bool</span> <span class="n">EmitNOAT</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Beyond adding these new .cpp files to CMakeLists.txt, please remember to add
subdirectory InstPrinter, enable asmprinter, adding libraries AsmPrinter and
Cpu0AsmPrinter to LLVMBuild.txt as follows,</p>
<p class="rubric">lbdex/chapters/Chapter3_2/CMakeLists.txt</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">tablegen</span><span class="p">(</span><span class="n">LLVM</span> <span class="n">Cpu0GenCodeEmitter</span><span class="p">.</span><span class="n">inc</span> <span class="o">-</span><span class="n">gen</span><span class="o">-</span><span class="n">emitter</span><span class="p">)</span>
<span class="n">tablegen</span><span class="p">(</span><span class="n">LLVM</span> <span class="n">Cpu0GenMCCodeEmitter</span><span class="p">.</span><span class="n">inc</span> <span class="o">-</span><span class="n">gen</span><span class="o">-</span><span class="n">emitter</span><span class="p">)</span>

<span class="n">tablegen</span><span class="p">(</span><span class="n">LLVM</span> <span class="n">Cpu0GenAsmWriter</span><span class="p">.</span><span class="n">inc</span> <span class="o">-</span><span class="n">gen</span><span class="o">-</span><span class="k">asm</span><span class="o">-</span><span class="n">writer</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="p">...</span>
<span class="n">add_llvm_target</span><span class="p">(</span><span class="n">Cpu0CodeGen</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="n">Cpu0AsmPrinter</span><span class="p">.</span><span class="n">cpp</span>
  <span class="n">Cpu0MCInstLower</span><span class="p">.</span><span class="n">cpp</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="p">...</span>
  <span class="p">)</span>
<span class="p">...</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">add_subdirectory</span><span class="p">(</span><span class="n">InstPrinter</span><span class="p">)</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_2/LLVMBuild.txt</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">//  LLVMBuild.txt</span>
<span class="p">[</span><span class="n">common</span><span class="p">]</span>
<span class="n">subdirectories</span> <span class="o">=</span>
  <span class="n">InstPrinter</span>
  <span class="p">...</span>

<span class="p">[</span><span class="n">component_0</span><span class="p">]</span>
<span class="p">...</span>
<span class="cp"># Please enable asmprinter</span>
<span class="n">has_asmprinter</span> <span class="o">=</span> <span class="mi">1</span>
<span class="p">...</span>

<span class="p">[</span><span class="n">component_1</span><span class="p">]</span>
<span class="n">required_libraries</span> <span class="o">=</span>
                     <span class="n">AsmPrinter</span>
                     <span class="p">...</span>
                     <span class="n">Cpu0AsmPrinter</span>
                     <span class="p">...</span>
</pre></div>
</div>
<p>Now, run Chapter3_2/Cpu0 for AsmPrinter support, will get new error message as
follows,</p>
<div class="highlight-bash"><div class="highlight"><pre>118-165-78-230:input Jonathan<span class="nv">$ </span>/Users/Jonathan/llvm/test/cmake_debug_build/
Debug/bin/llc -march<span class="o">=</span>cpu0 -relocation-model<span class="o">=</span>pic -filetype<span class="o">=</span>asm ch3.bc -o
ch3.cpu0.s
/Users/Jonathan/llvm/test/cmake_debug_build/Debug/bin/llc: target does not
support generation of this file <span class="nb">type</span>!
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">llc</span></tt> fails to compile IR code into machine code since we don&#8217;t implement
class Cpu0DAGToDAGISel.</p>
</div>
<div class="section" id="add-cpu0dagtodagisel-class">
<h2><a class="toc-backref" href="#id7">Add Cpu0DAGToDAGISel class</a><a class="headerlink" href="#add-cpu0dagtodagisel-class" title="Permalink to this headline">¶</a></h2>
<p>The IR DAG to machine instruction DAG transformation is introduced in the
previous chapter.
Now, let&#8217;s check what IR DAG nodes the file ch3.bc has. List ch3.ll as follows,</p>
<div class="highlight-c++"><div class="highlight"><pre>// ch3.ll
define i32 @main() nounwind uwtable {
%1 = alloca i32, align 4
store i32 0, i32* %1
ret i32 0
}
</pre></div>
</div>
<p>As above, ch3.ll uses the IR DAG node <strong>store</strong>, <strong>ret</strong>.
So, the definitions in Cpu0InstrInfo.td as below is enough.
The ADDiu used for stack adjustment which will need in later section
&#8220;Add Prologue/Epilogue functions&#8221; of this chapter.
IR DAG is defined in file  include/llvm/Target/TargetSelectionDAG.td.</p>
<p class="rubric">lbdex/chapters/Chapter2/Cpu0InstrInfo.td</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">//===----------------------------------------------------------------------===//</span>

<span class="c1">/// Load and Store Instructions</span>
<span class="c1">///  aligned</span>
<span class="n">defm</span> <span class="n">LD</span>     <span class="o">:</span> <span class="n">LoadM32</span><span class="o">&lt;</span><span class="mh">0x01</span><span class="p">,</span>  <span class="s">&quot;ld&quot;</span><span class="p">,</span>  <span class="n">load_a</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">defm</span> <span class="n">ST</span>     <span class="o">:</span> <span class="n">StoreM32</span><span class="o">&lt;</span><span class="mh">0x02</span><span class="p">,</span> <span class="s">&quot;st&quot;</span><span class="p">,</span>  <span class="n">store_a</span><span class="o">&gt;</span><span class="p">;</span>

<span class="c1">/// Arithmetic Instructions (ALU Immediate)</span>
<span class="c1">// IR &quot;add&quot; defined in include/llvm/Target/TargetSelectionDAG.td, line 315 (def add).</span>
<span class="n">def</span> <span class="n">ADDiu</span>   <span class="o">:</span> <span class="n">ArithLogicI</span><span class="o">&lt;</span><span class="mh">0x09</span><span class="p">,</span> <span class="s">&quot;addiu&quot;</span><span class="p">,</span> <span class="n">add</span><span class="p">,</span> <span class="n">simm16</span><span class="p">,</span> <span class="n">immSExt16</span><span class="p">,</span> <span class="n">CPURegs</span><span class="o">&gt;</span><span class="p">;</span>

<span class="n">let</span> <span class="n">isReturn</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">isTerminator</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">hasDelaySlot</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">isBarrier</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">hasCtrlDep</span><span class="o">=</span><span class="mi">1</span> <span class="n">in</span>
<span class="n">def</span> <span class="n">RetLR</span> <span class="o">:</span> <span class="n">Cpu0Pseudo</span><span class="o">&lt;</span><span class="p">(</span><span class="n">outs</span><span class="p">),</span> <span class="p">(</span><span class="n">ins</span><span class="p">),</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="p">[(</span><span class="n">Cpu0Ret</span><span class="p">)]</span><span class="o">&gt;</span><span class="p">;</span>

<span class="n">def</span> <span class="n">RET</span>     <span class="o">:</span> <span class="n">RetBase</span><span class="o">&lt;</span><span class="n">GPROut</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<p>Add class Cpu0DAGToDAGISel (Cpu0ISelDAGToDAG.cpp) to CMakeLists.txt, and add
the following fragment to Cpu0TargetMachine.cpp,</p>
<p class="rubric">lbdex/chapters/Chapter3_3/CMakeLists.txt</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">add_llvm_target</span><span class="p">(</span>
  <span class="p">...</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="n">Cpu0ISelDAGToDAG</span><span class="p">.</span><span class="n">cpp</span>
  <span class="n">Cpu0SEISelDAGToDAG</span><span class="p">.</span><span class="n">cpp</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="p">...</span>
<span class="p">)</span>
</pre></div>
</div>
<p>The following code in Cpu0TargetMachine.cpp will create a pass in instruction
selection stage.</p>
<p class="rubric">lbdex/chapters/Chapter3_3/Cpu0TargetMachine.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Cpu0PassConfig</span> <span class="o">:</span> <span class="k">public</span> <span class="n">TargetPassConfig</span> <span class="p">{</span>
<span class="nl">public:</span>
  <span class="p">...</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="kt">bool</span> <span class="n">addInstSelector</span><span class="p">()</span> <span class="n">override</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="p">};</span>
<span class="p">...</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">// Install an instruction selector pass using</span>
<span class="c1">// the ISelDag to gen Cpu0 code.</span>
<span class="kt">bool</span> <span class="n">Cpu0PassConfig</span><span class="o">::</span><span class="n">addInstSelector</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">addPass</span><span class="p">(</span><span class="n">createCpu0ISelDag</span><span class="p">(</span><span class="n">getCpu0TargetMachine</span><span class="p">()));</span>
  <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_3/Cpu0ISelDAGToDAG.h</p>
<p class="rubric">lbdex/chapters/Chapter3_3/Cpu0ISelDAGToDAG.cpp</p>
<p class="rubric">lbdex/chapters/Chapter3_3/Cpu0SEISelDAGToDAG.h</p>
<p class="rubric">lbdex/chapters/Chapter3_3/Cpu0ISelDAGToDAG.cpp</p>
<p>Function Cpu0DAGToDAGISel::Select() of Cpu0ISelDAGToDAG.cpp is for the s
election of &#8220;OP code DAG node&#8221; while Cpu0DAGToDAGISel::SelectAddr() is for the
selection of &#8220;DATA DAG node with <strong>addr</strong> type&#8221; which defined in
Chapter2/Cpu0InstrInfo.td. This method name corresponding to
Chapter2/Cpu0InstrInfo.td as follows,</p>
<p class="rubric">lbdex/chapters/Chapter2/Cpu0InstrInfo.td</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">def</span> <span class="n">addr</span> <span class="o">:</span> <span class="n">ComplexPattern</span><span class="o">&lt;</span><span class="n">iPTR</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;SelectAddr&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">frameindex</span><span class="p">],</span> <span class="p">[</span><span class="n">SDNPWantParent</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<p>The iPTR, ComplexPattern, frameindex and SDNPWantParent defined as follows,</p>
<p class="rubric">src/include/llvm/Target/TargetSelection.td</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">def</span> <span class="n">SDNPWantParent</span>  <span class="o">:</span> <span class="n">SDNodeProperty</span><span class="p">;</span>   <span class="c1">// ComplexPattern gets the parent</span>
<span class="p">...</span>
<span class="n">def</span> <span class="n">frameindex</span>  <span class="o">:</span> <span class="n">SDNode</span><span class="o">&lt;</span><span class="s">&quot;ISD::FrameIndex&quot;</span><span class="p">,</span>           <span class="n">SDTPtrLeaf</span><span class="p">,</span> <span class="p">[],</span>
                         <span class="s">&quot;FrameIndexSDNode&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">...</span>
<span class="c1">// Complex patterns, e.g. X86 addressing mode, requires pattern matching code</span>
<span class="c1">// in C++. NumOperands is the number of operands returned by the select function;</span>
<span class="c1">// SelectFunc is the name of the function used to pattern match the max. pattern;</span>
<span class="c1">// RootNodes are the list of possible root nodes of the sub-dags to match.</span>
<span class="c1">// e.g. X86 addressing mode - def addr : ComplexPattern&lt;4, &quot;SelectAddr&quot;, [add]&gt;;</span>
<span class="c1">//</span>
<span class="k">class</span> <span class="nc">ComplexPattern</span><span class="o">&lt;</span><span class="n">ValueType</span> <span class="n">ty</span><span class="p">,</span> <span class="kt">int</span> <span class="n">numops</span><span class="p">,</span> <span class="n">string</span> <span class="n">fn</span><span class="p">,</span>
                     <span class="n">list</span><span class="o">&lt;</span><span class="n">SDNode</span><span class="o">&gt;</span> <span class="n">roots</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">SDNodeProperty</span><span class="o">&gt;</span> <span class="n">props</span> <span class="o">=</span> <span class="p">[]</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="n">ValueType</span> <span class="n">Ty</span> <span class="o">=</span> <span class="n">ty</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">NumOperands</span> <span class="o">=</span> <span class="n">numops</span><span class="p">;</span>
  <span class="n">string</span> <span class="n">SelectFunc</span> <span class="o">=</span> <span class="n">fn</span><span class="p">;</span>
  <span class="n">list</span><span class="o">&lt;</span><span class="n">SDNode</span><span class="o">&gt;</span> <span class="n">RootNodes</span> <span class="o">=</span> <span class="n">roots</span><span class="p">;</span>
  <span class="n">list</span><span class="o">&lt;</span><span class="n">SDNodeProperty</span><span class="o">&gt;</span> <span class="n">Properties</span> <span class="o">=</span> <span class="n">props</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">src/include/llvm/CodeGen/ValueTypes.td</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">// Pseudo valuetype mapped to the current pointer size.</span>
<span class="n">def</span> <span class="n">iPTR</span>   <span class="o">:</span> <span class="n">ValueType</span><span class="o">&lt;</span><span class="mi">0</span>  <span class="p">,</span> <span class="mi">255</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<p>Chapter3_3 adding the following code in Cpu0InstInfo.cpp to enable debug
information which called by llvm at proper time.</p>
<p class="rubric">lbdex/chapters/Chapter3_3/Cpu0InstrInfo.h</p>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="k">virtual</span> <span class="n">MachineInstr</span><span class="o">*</span> <span class="n">emitFrameIndexDebugValue</span><span class="p">(</span><span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">MF</span><span class="p">,</span>
                                                 <span class="kt">int</span> <span class="n">FrameIx</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">Offset</span><span class="p">,</span>
                                                 <span class="k">const</span> <span class="n">MDNode</span> <span class="o">*</span><span class="n">MDPtr</span><span class="p">,</span>
                                                 <span class="n">DebugLoc</span> <span class="n">DL</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_3/Cpu0InstrInfo.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">MachineInstr</span><span class="o">*</span>
<span class="n">Cpu0InstrInfo</span><span class="o">::</span><span class="n">emitFrameIndexDebugValue</span><span class="p">(</span><span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">MF</span><span class="p">,</span> <span class="kt">int</span> <span class="n">FrameIx</span><span class="p">,</span>
                                        <span class="kt">uint64_t</span> <span class="n">Offset</span><span class="p">,</span> <span class="k">const</span> <span class="n">MDNode</span> <span class="o">*</span><span class="n">MDPtr</span><span class="p">,</span>
                                        <span class="n">DebugLoc</span> <span class="n">DL</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="n">MachineInstrBuilder</span> <span class="n">MIB</span> <span class="o">=</span> <span class="n">BuildMI</span><span class="p">(</span><span class="n">MF</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">get</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">DBG_VALUE</span><span class="p">))</span>
    <span class="p">.</span><span class="n">addFrameIndex</span><span class="p">(</span><span class="n">FrameIx</span><span class="p">).</span><span class="n">addImm</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">addImm</span><span class="p">(</span><span class="n">Offset</span><span class="p">).</span><span class="n">addMetadata</span><span class="p">(</span><span class="n">MDPtr</span><span class="p">);</span>
  <span class="k">return</span> <span class="o">&amp;*</span><span class="n">MIB</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Build Chapter3_3 and run with it, finding the error message of Chapter3_2 is
gone. The new error message for Chapter3_3 as follows,</p>
<div class="highlight-bash"><div class="highlight"><pre>118-165-78-230:input Jonathan<span class="nv">$ </span>/Users/Jonathan/llvm/test/cmake_debug_build/
Debug/bin/llc -march<span class="o">=</span>cpu0 -relocation-model<span class="o">=</span>pic -filetype<span class="o">=</span>asm ch3.bc -o
ch3.cpu0.s
...
LLVM ERROR: Cannot <span class="k">select</span>: 0x24834b8: <span class="nv">ch</span> <span class="o">=</span> Cpu0ISD::Ret 0x24832a8, 0x24833b0 <span class="o">[</span><span class="nv">ORD</span><span class="o">=</span>4<span class="o">]</span> <span class="o">[</span><span class="nv">ID</span><span class="o">=</span>6<span class="o">]</span>
  0x24833b0: <span class="nv">i32</span> <span class="o">=</span> Register %LR <span class="o">[</span><span class="nv">ID</span><span class="o">=</span>4<span class="o">]</span>
...
  0x7f80f182d210: <span class="nv">i32</span> <span class="o">=</span> Register %LR <span class="o">[</span><span class="nv">ID</span><span class="o">=</span>4<span class="o">]</span>
</pre></div>
</div>
<p>Above can display the error message DAG node &#8220;Cpu0ISD::Ret&#8221; because the following
code added in Chapter3_1/Cpu0ISelLowering.cpp.</p>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0ISelLowering.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">Cpu0TargetLowering</span><span class="o">::</span><span class="n">getTargetNodeName</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">Opcode</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">Opcode</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">case</span> <span class="n">Cpu0ISD</span>:<span class="o">:</span><span class="n">JmpLink</span><span class="o">:</span>           <span class="k">return</span> <span class="s">&quot;Cpu0ISD::JmpLink&quot;</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">Cpu0ISD</span>:<span class="o">:</span><span class="n">TailCall</span><span class="o">:</span>          <span class="k">return</span> <span class="s">&quot;Cpu0ISD::TailCall&quot;</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">Cpu0ISD</span>:<span class="o">:</span><span class="n">Hi</span><span class="o">:</span>                <span class="k">return</span> <span class="s">&quot;Cpu0ISD::Hi&quot;</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">Cpu0ISD</span>:<span class="o">:</span><span class="n">Lo</span><span class="o">:</span>                <span class="k">return</span> <span class="s">&quot;Cpu0ISD::Lo&quot;</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">Cpu0ISD</span>:<span class="o">:</span><span class="n">GPRel</span><span class="o">:</span>             <span class="k">return</span> <span class="s">&quot;Cpu0ISD::GPRel&quot;</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">Cpu0ISD</span>:<span class="o">:</span><span class="n">Ret</span><span class="o">:</span>               <span class="k">return</span> <span class="s">&quot;Cpu0ISD::Ret&quot;</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">Cpu0ISD</span>:<span class="o">:</span><span class="n">DivRem</span><span class="o">:</span>            <span class="k">return</span> <span class="s">&quot;Cpu0ISD::DivRem&quot;</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">Cpu0ISD</span>:<span class="o">:</span><span class="n">DivRemU</span><span class="o">:</span>           <span class="k">return</span> <span class="s">&quot;Cpu0ISD::DivRemU&quot;</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">Cpu0ISD</span>:<span class="o">:</span><span class="n">Wrapper</span><span class="o">:</span>           <span class="k">return</span> <span class="s">&quot;Cpu0ISD::Wrapper&quot;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="nl">default:</span>                         <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="handle-return-register-lr">
<h2><a class="toc-backref" href="#id8">Handle return register lr</a><a class="headerlink" href="#handle-return-register-lr" title="Permalink to this headline">¶</a></h2>
<p class="rubric">lbdex/chapters/Chapter3_4/CMakeLists.txt</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">add_llvm_target</span><span class="p">(</span>
  <span class="p">...</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="n">Cpu0AnalyzeImmediate</span><span class="p">.</span><span class="n">cpp</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="p">...</span>
<span class="p">)</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_4/Cpu0AnalyzeImmediate.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">//===-- Cpu0AnalyzeImmediate.h - Analyze Immediates ------------*- C++ -*--===//</span>
<span class="c1">//</span>
<span class="c1">//                     The LLVM Compiler Infrastructure</span>
<span class="c1">//</span>
<span class="c1">// This file is distributed under the University of Illinois Open Source</span>
<span class="c1">// License. See LICENSE.TXT for details.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="cp">#ifndef CPU0_ANALYZE_IMMEDIATE_H</span>
<span class="cp">#define CPU0_ANALYZE_IMMEDIATE_H</span>

<span class="cp">#include &quot;Cpu0Config.h&quot;</span>
<span class="cp">#if CH &gt;= CH3_4</span>

<span class="cp">#include &quot;llvm/ADT/SmallVector.h&quot;</span>
<span class="cp">#include &quot;llvm/Support/DataTypes.h&quot;</span>

<span class="k">namespace</span> <span class="n">llvm</span> <span class="p">{</span>

  <span class="k">class</span> <span class="nc">Cpu0AnalyzeImmediate</span> <span class="p">{</span>
  <span class="nl">public:</span>
    <span class="k">struct</span> <span class="n">Inst</span> <span class="p">{</span>
      <span class="kt">unsigned</span> <span class="n">Opc</span><span class="p">,</span> <span class="n">ImmOpnd</span><span class="p">;</span>
      <span class="n">Inst</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">Opc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">ImmOpnd</span><span class="p">);</span>
    <span class="p">};</span>
    <span class="k">typedef</span> <span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Inst</span><span class="p">,</span> <span class="mi">7</span> <span class="o">&gt;</span> <span class="n">InstSeq</span><span class="p">;</span>

    <span class="c1">/// Analyze - Get an instrucion sequence to load immediate Imm. The last</span>
    <span class="c1">/// instruction in the sequence must be an ADDiu if LastInstrIsADDiu is</span>
    <span class="c1">/// true;</span>
    <span class="k">const</span> <span class="n">InstSeq</span> <span class="o">&amp;</span><span class="n">Analyze</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">Imm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">Size</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">LastInstrIsADDiu</span><span class="p">);</span>
  <span class="nl">private:</span>
    <span class="k">typedef</span> <span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">InstSeq</span><span class="p">,</span> <span class="mi">5</span><span class="o">&gt;</span> <span class="n">InstSeqLs</span><span class="p">;</span>

    <span class="c1">/// AddInstr - Add I to all instruction sequences in SeqLs.</span>
    <span class="kt">void</span> <span class="nf">AddInstr</span><span class="p">(</span><span class="n">InstSeqLs</span> <span class="o">&amp;</span><span class="n">SeqLs</span><span class="p">,</span> <span class="k">const</span> <span class="n">Inst</span> <span class="o">&amp;</span><span class="n">I</span><span class="p">);</span>

    <span class="c1">/// GetInstSeqLsADDiu - Get instrucion sequences which end with an ADDiu to</span>
    <span class="c1">/// load immediate Imm</span>
    <span class="kt">void</span> <span class="nf">GetInstSeqLsADDiu</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">Imm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">RemSize</span><span class="p">,</span> <span class="n">InstSeqLs</span> <span class="o">&amp;</span><span class="n">SeqLs</span><span class="p">);</span>

    <span class="c1">/// GetInstSeqLsORi - Get instrucion sequences which end with an ORi to</span>
    <span class="c1">/// load immediate Imm</span>
    <span class="kt">void</span> <span class="nf">GetInstSeqLsORi</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">Imm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">RemSize</span><span class="p">,</span> <span class="n">InstSeqLs</span> <span class="o">&amp;</span><span class="n">SeqLs</span><span class="p">);</span>

    <span class="c1">/// GetInstSeqLsSHL - Get instrucion sequences which end with a SHL to</span>
    <span class="c1">/// load immediate Imm</span>
    <span class="kt">void</span> <span class="nf">GetInstSeqLsSHL</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">Imm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">RemSize</span><span class="p">,</span> <span class="n">InstSeqLs</span> <span class="o">&amp;</span><span class="n">SeqLs</span><span class="p">);</span>

    <span class="c1">/// GetInstSeqLs - Get instrucion sequences to load immediate Imm.</span>
    <span class="kt">void</span> <span class="nf">GetInstSeqLs</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">Imm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">RemSize</span><span class="p">,</span> <span class="n">InstSeqLs</span> <span class="o">&amp;</span><span class="n">SeqLs</span><span class="p">);</span>

    <span class="c1">/// ReplaceADDiuSHLWithLUi - Replace an ADDiu &amp; SHL pair with a LUi.</span>
    <span class="kt">void</span> <span class="nf">ReplaceADDiuSHLWithLUi</span><span class="p">(</span><span class="n">InstSeq</span> <span class="o">&amp;</span><span class="n">Seq</span><span class="p">);</span>

    <span class="c1">/// GetShortestSeq - Find the shortest instruction sequence in SeqLs and</span>
    <span class="c1">/// return it in Insts.</span>
    <span class="kt">void</span> <span class="nf">GetShortestSeq</span><span class="p">(</span><span class="n">InstSeqLs</span> <span class="o">&amp;</span><span class="n">SeqLs</span><span class="p">,</span> <span class="n">InstSeq</span> <span class="o">&amp;</span><span class="n">Insts</span><span class="p">);</span>

    <span class="kt">unsigned</span> <span class="n">Size</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="n">ADDiu</span><span class="p">,</span> <span class="n">ORi</span><span class="p">,</span> <span class="n">SHL</span><span class="p">,</span> <span class="n">LUi</span><span class="p">;</span>
    <span class="n">InstSeq</span> <span class="n">Insts</span><span class="p">;</span>
  <span class="p">};</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="c1">// #if CH &gt;= CH3_4</span>

<span class="cp">#endif</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_4/Cpu0AnalyzeImmediate.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">//===-- Cpu0AnalyzeImmediate.cpp - Analyze Immediates ---------------------===//</span>
<span class="c1">//</span>
<span class="c1">//                     The LLVM Compiler Infrastructure</span>
<span class="c1">//</span>
<span class="c1">// This file is distributed under the University of Illinois Open Source</span>
<span class="c1">// License. See LICENSE.TXT for details.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="cp">#include &quot;Cpu0AnalyzeImmediate.h&quot;</span>
<span class="cp">#include &quot;Cpu0.h&quot;</span>
<span class="cp">#if CH &gt;= CH3_4</span>

<span class="cp">#include &quot;llvm/Support/MathExtras.h&quot;</span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">llvm</span><span class="p">;</span>

<span class="n">Cpu0AnalyzeImmediate</span><span class="o">::</span><span class="n">Inst</span><span class="o">::</span><span class="n">Inst</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">O</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">I</span><span class="p">)</span> <span class="o">:</span> <span class="n">Opc</span><span class="p">(</span><span class="n">O</span><span class="p">),</span> <span class="n">ImmOpnd</span><span class="p">(</span><span class="n">I</span><span class="p">)</span> <span class="p">{}</span>

<span class="c1">// Add I to the instruction sequences.</span>
<span class="kt">void</span> <span class="n">Cpu0AnalyzeImmediate</span><span class="o">::</span><span class="n">AddInstr</span><span class="p">(</span><span class="n">InstSeqLs</span> <span class="o">&amp;</span><span class="n">SeqLs</span><span class="p">,</span> <span class="k">const</span> <span class="n">Inst</span> <span class="o">&amp;</span><span class="n">I</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Add an instruction seqeunce consisting of just I.</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">SeqLs</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">SeqLs</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">InstSeq</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">I</span><span class="p">));</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">for</span> <span class="p">(</span><span class="n">InstSeqLs</span><span class="o">::</span><span class="n">iterator</span> <span class="n">Iter</span> <span class="o">=</span> <span class="n">SeqLs</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span> <span class="n">Iter</span> <span class="o">!=</span> <span class="n">SeqLs</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="o">++</span><span class="n">Iter</span><span class="p">)</span>
    <span class="n">Iter</span><span class="o">-&gt;</span><span class="n">push_back</span><span class="p">(</span><span class="n">I</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Cpu0AnalyzeImmediate</span><span class="o">::</span><span class="n">GetInstSeqLsADDiu</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">Imm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">RemSize</span><span class="p">,</span>
                                             <span class="n">InstSeqLs</span> <span class="o">&amp;</span><span class="n">SeqLs</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">GetInstSeqLs</span><span class="p">((</span><span class="n">Imm</span> <span class="o">+</span> <span class="mh">0x8000ULL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffffffff0000ULL</span><span class="p">,</span> <span class="n">RemSize</span><span class="p">,</span> <span class="n">SeqLs</span><span class="p">);</span>
  <span class="n">AddInstr</span><span class="p">(</span><span class="n">SeqLs</span><span class="p">,</span> <span class="n">Inst</span><span class="p">(</span><span class="n">ADDiu</span><span class="p">,</span> <span class="n">Imm</span> <span class="o">&amp;</span> <span class="mh">0xffffULL</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Cpu0AnalyzeImmediate</span><span class="o">::</span><span class="n">GetInstSeqLsORi</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">Imm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">RemSize</span><span class="p">,</span>
                                           <span class="n">InstSeqLs</span> <span class="o">&amp;</span><span class="n">SeqLs</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">GetInstSeqLs</span><span class="p">(</span><span class="n">Imm</span> <span class="o">&amp;</span> <span class="mh">0xffffffffffff0000ULL</span><span class="p">,</span> <span class="n">RemSize</span><span class="p">,</span> <span class="n">SeqLs</span><span class="p">);</span>
  <span class="n">AddInstr</span><span class="p">(</span><span class="n">SeqLs</span><span class="p">,</span> <span class="n">Inst</span><span class="p">(</span><span class="n">ORi</span><span class="p">,</span> <span class="n">Imm</span> <span class="o">&amp;</span> <span class="mh">0xffffULL</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Cpu0AnalyzeImmediate</span><span class="o">::</span><span class="n">GetInstSeqLsSHL</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">Imm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">RemSize</span><span class="p">,</span>
                                           <span class="n">InstSeqLs</span> <span class="o">&amp;</span><span class="n">SeqLs</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">unsigned</span> <span class="n">Shamt</span> <span class="o">=</span> <span class="n">countTrailingZeros</span><span class="p">(</span><span class="n">Imm</span><span class="p">);</span>
  <span class="n">GetInstSeqLs</span><span class="p">(</span><span class="n">Imm</span> <span class="o">&gt;&gt;</span> <span class="n">Shamt</span><span class="p">,</span> <span class="n">RemSize</span> <span class="o">-</span> <span class="n">Shamt</span><span class="p">,</span> <span class="n">SeqLs</span><span class="p">);</span>
  <span class="n">AddInstr</span><span class="p">(</span><span class="n">SeqLs</span><span class="p">,</span> <span class="n">Inst</span><span class="p">(</span><span class="n">SHL</span><span class="p">,</span> <span class="n">Shamt</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Cpu0AnalyzeImmediate</span><span class="o">::</span><span class="n">GetInstSeqLs</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">Imm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">RemSize</span><span class="p">,</span>
                                        <span class="n">InstSeqLs</span> <span class="o">&amp;</span><span class="n">SeqLs</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">uint64_t</span> <span class="n">MaskedImm</span> <span class="o">=</span> <span class="n">Imm</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0xffffffffffffffffULL</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">64</span> <span class="o">-</span> <span class="n">Size</span><span class="p">));</span>

  <span class="c1">// Do nothing if Imm is 0.</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">MaskedImm</span><span class="p">)</span>
    <span class="k">return</span><span class="p">;</span>

  <span class="c1">// A single ADDiu will do if RemSize &lt;= 16.</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">RemSize</span> <span class="o">&lt;=</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">AddInstr</span><span class="p">(</span><span class="n">SeqLs</span><span class="p">,</span> <span class="n">Inst</span><span class="p">(</span><span class="n">ADDiu</span><span class="p">,</span> <span class="n">MaskedImm</span><span class="p">));</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// Shift if the lower 16-bit is cleared.</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">Imm</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">GetInstSeqLsSHL</span><span class="p">(</span><span class="n">Imm</span><span class="p">,</span> <span class="n">RemSize</span><span class="p">,</span> <span class="n">SeqLs</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">GetInstSeqLsADDiu</span><span class="p">(</span><span class="n">Imm</span><span class="p">,</span> <span class="n">RemSize</span><span class="p">,</span> <span class="n">SeqLs</span><span class="p">);</span>

  <span class="c1">// If bit 15 is cleared, it doesn&#39;t make a difference whether the last</span>
  <span class="c1">// instruction is an ADDiu or ORi. In that case, do not call GetInstSeqLsORi.</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Imm</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">InstSeqLs</span> <span class="n">SeqLsORi</span><span class="p">;</span>
    <span class="n">GetInstSeqLsORi</span><span class="p">(</span><span class="n">Imm</span><span class="p">,</span> <span class="n">RemSize</span><span class="p">,</span> <span class="n">SeqLsORi</span><span class="p">);</span>
    <span class="n">SeqLs</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">SeqLs</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">SeqLsORi</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">SeqLsORi</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Replace a ADDiu &amp; SHL pair with a LUi.</span>
<span class="c1">// e.g. the following two instructions</span>
<span class="c1">//  ADDiu 0x0111</span>
<span class="c1">//  SHL 18</span>
<span class="c1">// are replaced with</span>
<span class="c1">//  LUi 0x444</span>
<span class="kt">void</span> <span class="n">Cpu0AnalyzeImmediate</span><span class="o">::</span><span class="n">ReplaceADDiuSHLWithLUi</span><span class="p">(</span><span class="n">InstSeq</span> <span class="o">&amp;</span><span class="n">Seq</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Check if the first two instructions are ADDiu and SHL and the shift amount</span>
  <span class="c1">// is at least 16.</span>
  <span class="k">if</span> <span class="p">((</span><span class="n">Seq</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">Seq</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">Opc</span> <span class="o">!=</span> <span class="n">ADDiu</span><span class="p">)</span> <span class="o">||</span>
      <span class="p">(</span><span class="n">Seq</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">Opc</span> <span class="o">!=</span> <span class="n">SHL</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">Seq</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">ImmOpnd</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">))</span>
    <span class="k">return</span><span class="p">;</span>

  <span class="c1">// Sign-extend and shift operand of ADDiu and see if it still fits in 16-bit.</span>
  <span class="kt">int64_t</span> <span class="n">Imm</span> <span class="o">=</span> <span class="n">SignExtend64</span><span class="o">&lt;</span><span class="mi">16</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Seq</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ImmOpnd</span><span class="p">);</span>
  <span class="kt">int64_t</span> <span class="n">ShiftedImm</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">Imm</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">Seq</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">ImmOpnd</span> <span class="o">-</span> <span class="mi">16</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isInt</span><span class="o">&lt;</span><span class="mi">16</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ShiftedImm</span><span class="p">))</span>
    <span class="k">return</span><span class="p">;</span>

  <span class="c1">// Replace the first instruction and erase the second.</span>
  <span class="n">Seq</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">Opc</span> <span class="o">=</span> <span class="n">LUi</span><span class="p">;</span>
  <span class="n">Seq</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ImmOpnd</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)(</span><span class="n">ShiftedImm</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
  <span class="n">Seq</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">Seq</span><span class="p">.</span><span class="n">begin</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Cpu0AnalyzeImmediate</span><span class="o">::</span><span class="n">GetShortestSeq</span><span class="p">(</span><span class="n">InstSeqLs</span> <span class="o">&amp;</span><span class="n">SeqLs</span><span class="p">,</span> <span class="n">InstSeq</span> <span class="o">&amp;</span><span class="n">Insts</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">InstSeqLs</span><span class="o">::</span><span class="n">iterator</span> <span class="n">ShortestSeq</span> <span class="o">=</span> <span class="n">SeqLs</span><span class="p">.</span><span class="n">end</span><span class="p">();</span>
  <span class="c1">// The length of an instruction sequence is at most 7.</span>
  <span class="kt">unsigned</span> <span class="n">ShortestLength</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>

  <span class="k">for</span> <span class="p">(</span><span class="n">InstSeqLs</span><span class="o">::</span><span class="n">iterator</span> <span class="n">S</span> <span class="o">=</span> <span class="n">SeqLs</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span> <span class="n">S</span> <span class="o">!=</span> <span class="n">SeqLs</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="o">++</span><span class="n">S</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ReplaceADDiuSHLWithLUi</span><span class="p">(</span><span class="o">*</span><span class="n">S</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">S</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mi">7</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">S</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">ShortestLength</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">ShortestSeq</span> <span class="o">=</span> <span class="n">S</span><span class="p">;</span>
      <span class="n">ShortestLength</span> <span class="o">=</span> <span class="n">S</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="n">Insts</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
  <span class="n">Insts</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">ShortestSeq</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">(),</span> <span class="n">ShortestSeq</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">());</span>
<span class="p">}</span>

<span class="k">const</span> <span class="n">Cpu0AnalyzeImmediate</span><span class="o">::</span><span class="n">InstSeq</span>
<span class="o">&amp;</span><span class="n">Cpu0AnalyzeImmediate</span><span class="o">::</span><span class="n">Analyze</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">Imm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">Size</span><span class="p">,</span>
                               <span class="kt">bool</span> <span class="n">LastInstrIsADDiu</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="o">-&gt;</span><span class="n">Size</span> <span class="o">=</span> <span class="n">Size</span><span class="p">;</span>

  <span class="n">ADDiu</span> <span class="o">=</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">ADDiu</span><span class="p">;</span>
  <span class="n">ORi</span> <span class="o">=</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">ORi</span><span class="p">;</span>
  <span class="n">SHL</span> <span class="o">=</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">SHL</span><span class="p">;</span>
  <span class="n">LUi</span> <span class="o">=</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">LUi</span><span class="p">;</span>

  <span class="n">InstSeqLs</span> <span class="n">SeqLs</span><span class="p">;</span>

  <span class="c1">// Get the list of instruction sequences.</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">LastInstrIsADDiu</span> <span class="o">|</span> <span class="o">!</span><span class="n">Imm</span><span class="p">)</span>
    <span class="n">GetInstSeqLsADDiu</span><span class="p">(</span><span class="n">Imm</span><span class="p">,</span> <span class="n">Size</span><span class="p">,</span> <span class="n">SeqLs</span><span class="p">);</span>
  <span class="k">else</span>
    <span class="nf">GetInstSeqLs</span><span class="p">(</span><span class="n">Imm</span><span class="p">,</span> <span class="n">Size</span><span class="p">,</span> <span class="n">SeqLs</span><span class="p">);</span>

  <span class="c1">// Set Insts to the shortest instruction sequence.</span>
  <span class="n">GetShortestSeq</span><span class="p">(</span><span class="n">SeqLs</span><span class="p">,</span> <span class="n">Insts</span><span class="p">);</span>

  <span class="k">return</span> <span class="n">Insts</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_4/Cpu0CallingConv.td</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">def</span> <span class="n">RetCC_Cpu0EABI</span> <span class="o">:</span> <span class="n">CallingConv</span><span class="o">&lt;</span><span class="p">[</span>
  <span class="c1">// i32 are returned in registers V0, V1, A0, A1</span>
  <span class="n">CCIfType</span><span class="o">&lt;</span><span class="p">[</span><span class="n">i32</span><span class="p">],</span> <span class="n">CCAssignToReg</span><span class="o">&lt;</span><span class="p">[</span><span class="n">V0</span><span class="p">,</span> <span class="n">V1</span><span class="p">,</span> <span class="n">A0</span><span class="p">,</span> <span class="n">A1</span><span class="p">]</span><span class="o">&gt;&gt;</span>
<span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">def</span> <span class="n">RetCC_Cpu0</span> <span class="o">:</span> <span class="n">CallingConv</span><span class="o">&lt;</span><span class="p">[</span>
  <span class="n">CCDelegateTo</span><span class="o">&lt;</span><span class="n">RetCC_Cpu0EABI</span><span class="o">&gt;</span>
<span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_4/Cpu0FrameLowering.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="nl">protected:</span>
  <span class="kt">uint64_t</span> <span class="n">estimateStackSize</span><span class="p">(</span><span class="k">const</span> <span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">MF</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_4/Cpu0FrameLowering.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="cp">#include &quot;Cpu0AnalyzeImmediate.h&quot;</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="kt">uint64_t</span> <span class="n">Cpu0FrameLowering</span><span class="o">::</span><span class="n">estimateStackSize</span><span class="p">(</span><span class="k">const</span> <span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">MF</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="k">const</span> <span class="n">MachineFrameInfo</span> <span class="o">*</span><span class="n">MFI</span> <span class="o">=</span> <span class="n">MF</span><span class="p">.</span><span class="n">getFrameInfo</span><span class="p">();</span>
  <span class="k">const</span> <span class="n">TargetRegisterInfo</span> <span class="o">&amp;</span><span class="n">TRI</span> <span class="o">=</span> <span class="o">*</span><span class="n">MF</span><span class="p">.</span><span class="n">getSubtarget</span><span class="p">().</span><span class="n">getRegisterInfo</span><span class="p">();</span>

  <span class="kt">int64_t</span> <span class="n">Offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="c1">// Iterate over fixed sized objects.</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">I</span> <span class="o">=</span> <span class="n">MFI</span><span class="o">-&gt;</span><span class="n">getObjectIndexBegin</span><span class="p">();</span> <span class="n">I</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">++</span><span class="n">I</span><span class="p">)</span>
    <span class="n">Offset</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="n">Offset</span><span class="p">,</span> <span class="o">-</span><span class="n">MFI</span><span class="o">-&gt;</span><span class="n">getObjectOffset</span><span class="p">(</span><span class="n">I</span><span class="p">));</span>

  <span class="c1">// Conservatively assume all callee-saved registers will be saved.</span>
  <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="n">MCPhysReg</span> <span class="o">*</span><span class="n">R</span> <span class="o">=</span> <span class="n">TRI</span><span class="p">.</span><span class="n">getCalleeSavedRegs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">MF</span><span class="p">);</span> <span class="o">*</span><span class="n">R</span><span class="p">;</span> <span class="o">++</span><span class="n">R</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="n">Size</span> <span class="o">=</span> <span class="n">TRI</span><span class="p">.</span><span class="n">getMinimalPhysRegClass</span><span class="p">(</span><span class="o">*</span><span class="n">R</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">getSize</span><span class="p">();</span>
    <span class="n">Offset</span> <span class="o">=</span> <span class="n">RoundUpToAlignment</span><span class="p">(</span><span class="n">Offset</span> <span class="o">+</span> <span class="n">Size</span><span class="p">,</span> <span class="n">Size</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kt">unsigned</span> <span class="n">MaxAlign</span> <span class="o">=</span> <span class="n">MFI</span><span class="o">-&gt;</span><span class="n">getMaxAlignment</span><span class="p">();</span>

  <span class="c1">// Check that MaxAlign is not zero if there is a stack object that is not a</span>
  <span class="c1">// callee-saved spill.</span>
  <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">MFI</span><span class="o">-&gt;</span><span class="n">getObjectIndexEnd</span><span class="p">()</span> <span class="o">||</span> <span class="n">MaxAlign</span><span class="p">);</span>

  <span class="c1">// Iterate over other objects.</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="n">I</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">E</span> <span class="o">=</span> <span class="n">MFI</span><span class="o">-&gt;</span><span class="n">getObjectIndexEnd</span><span class="p">();</span> <span class="n">I</span> <span class="o">!=</span> <span class="n">E</span><span class="p">;</span> <span class="o">++</span><span class="n">I</span><span class="p">)</span>
    <span class="n">Offset</span> <span class="o">=</span> <span class="n">RoundUpToAlignment</span><span class="p">(</span><span class="n">Offset</span> <span class="o">+</span> <span class="n">MFI</span><span class="o">-&gt;</span><span class="n">getObjectSize</span><span class="p">(</span><span class="n">I</span><span class="p">),</span> <span class="n">MaxAlign</span><span class="p">);</span>

  <span class="c1">// Call frame.</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">MFI</span><span class="o">-&gt;</span><span class="n">adjustsStack</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">hasReservedCallFrame</span><span class="p">(</span><span class="n">MF</span><span class="p">))</span>
    <span class="n">Offset</span> <span class="o">=</span> <span class="n">RoundUpToAlignment</span><span class="p">(</span><span class="n">Offset</span> <span class="o">+</span> <span class="n">MFI</span><span class="o">-&gt;</span><span class="n">getMaxCallFrameSize</span><span class="p">(),</span>
                                <span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="n">MaxAlign</span><span class="p">,</span> <span class="n">getStackAlignment</span><span class="p">()));</span>

  <span class="k">return</span> <span class="nf">RoundUpToAlignment</span><span class="p">(</span><span class="n">Offset</span><span class="p">,</span> <span class="n">getStackAlignment</span><span class="p">());</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_4/Cpu0SEFrameLowering.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="cp">#include &quot;Cpu0AnalyzeImmediate.h&quot;</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_4/Cpu0InstrFormats.td</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">// Cpu0 Pseudo Instructions Format</span>
<span class="k">class</span> <span class="nc">Cpu0Pseudo</span><span class="o">&lt;</span><span class="n">dag</span> <span class="n">outs</span><span class="p">,</span> <span class="n">dag</span> <span class="n">ins</span><span class="p">,</span> <span class="n">string</span> <span class="n">asmstr</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">dag</span><span class="o">&gt;</span> <span class="n">pattern</span><span class="o">&gt;:</span>
      <span class="n">Cpu0Inst</span><span class="o">&lt;</span><span class="n">outs</span><span class="p">,</span> <span class="n">ins</span><span class="p">,</span> <span class="n">asmstr</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">IIPseudo</span><span class="p">,</span> <span class="n">Pseudo</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="n">let</span> <span class="n">isCodeGenOnly</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">let</span> <span class="n">isPseudo</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_4/Cpu0InstrInfo.td</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Cpu0InstAlias</span><span class="o">&lt;</span><span class="n">string</span> <span class="n">Asm</span><span class="p">,</span> <span class="n">dag</span> <span class="n">Result</span><span class="p">,</span> <span class="n">bit</span> <span class="n">Emit</span> <span class="o">=</span> <span class="mi">0</span><span class="n">b1</span><span class="o">&gt;</span> <span class="o">:</span>
  <span class="n">InstAlias</span><span class="o">&lt;</span><span class="n">Asm</span><span class="p">,</span> <span class="n">Result</span><span class="p">,</span> <span class="n">Emit</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">def</span> <span class="n">shamt</span>       <span class="o">:</span> <span class="n">Operand</span><span class="o">&lt;</span><span class="n">i32</span><span class="o">&gt;</span><span class="p">;</span>

<span class="c1">// Unsigned Operand</span>
<span class="n">def</span> <span class="n">uimm16</span>      <span class="o">:</span> <span class="n">Operand</span><span class="o">&lt;</span><span class="n">i32</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="n">let</span> <span class="n">PrintMethod</span> <span class="o">=</span> <span class="s">&quot;printUnsignedImm&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">// Transformation Function - get the lower 16 bits.</span>
<span class="n">def</span> <span class="n">LO16</span> <span class="o">:</span> <span class="n">SDNodeXForm</span><span class="o">&lt;</span><span class="n">imm</span><span class="p">,</span> <span class="p">[{</span>
  <span class="k">return</span> <span class="n">getImm</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="o">-&gt;</span><span class="n">getZExtValue</span><span class="p">()</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
<span class="p">}]</span><span class="o">&gt;</span><span class="p">;</span>

<span class="c1">// Transformation Function - get the higher 16 bits.</span>
<span class="n">def</span> <span class="n">HI16</span> <span class="o">:</span> <span class="n">SDNodeXForm</span><span class="o">&lt;</span><span class="n">imm</span><span class="p">,</span> <span class="p">[{</span>
  <span class="k">return</span> <span class="n">getImm</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="p">(</span><span class="n">N</span><span class="o">-&gt;</span><span class="n">getZExtValue</span><span class="p">()</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
<span class="p">}]</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">// Node immediate fits as 16-bit zero extended on target immediate.</span>
<span class="c1">// The LO16 param means that only the lower 16 bits of the node</span>
<span class="c1">// immediate are caught.</span>
<span class="c1">// e.g. addiu, sltiu</span>
<span class="n">def</span> <span class="n">immZExt16</span>  <span class="o">:</span> <span class="n">PatLeaf</span><span class="o">&lt;</span><span class="p">(</span><span class="n">imm</span><span class="p">),</span> <span class="p">[{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">N</span><span class="o">-&gt;</span><span class="n">getValueType</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">MVT</span><span class="o">::</span><span class="n">i32</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">N</span><span class="o">-&gt;</span><span class="n">getZExtValue</span><span class="p">()</span> <span class="o">==</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">N</span><span class="o">-&gt;</span><span class="n">getZExtValue</span><span class="p">();</span>
  <span class="k">else</span>
    <span class="nf">return</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">N</span><span class="o">-&gt;</span><span class="n">getZExtValue</span><span class="p">()</span> <span class="o">==</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">N</span><span class="o">-&gt;</span><span class="n">getZExtValue</span><span class="p">();</span>
<span class="p">}],</span> <span class="n">LO16</span><span class="o">&gt;</span><span class="p">;</span>

<span class="c1">// Immediate can be loaded with LUi (32-bit int with lower 16-bit cleared).</span>
<span class="n">def</span> <span class="n">immLow16Zero</span> <span class="o">:</span> <span class="n">PatLeaf</span><span class="o">&lt;</span><span class="p">(</span><span class="n">imm</span><span class="p">),</span> <span class="p">[{</span>
  <span class="kt">int64_t</span> <span class="n">Val</span> <span class="o">=</span> <span class="n">N</span><span class="o">-&gt;</span><span class="n">getSExtValue</span><span class="p">();</span>
  <span class="k">return</span> <span class="n">isInt</span><span class="o">&lt;</span><span class="mi">32</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Val</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">Val</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
<span class="p">}]</span><span class="o">&gt;</span><span class="p">;</span>

<span class="c1">// shamt field must fit in 5 bits.</span>
<span class="n">def</span> <span class="n">immZExt5</span> <span class="o">:</span> <span class="n">ImmLeaf</span><span class="o">&lt;</span><span class="n">i32</span><span class="p">,</span> <span class="p">[{</span><span class="k">return</span> <span class="n">Imm</span> <span class="o">==</span> <span class="p">(</span><span class="n">Imm</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">);}]</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>let Predicates = [Ch3_4] in {
// Arithmetic and logical instructions with 3 register operands.
class ArithLogicR&lt;bits&lt;8&gt; op, string instr_asm, SDNode OpNode,
                  InstrItinClass itin, RegisterClass RC, bit isComm = 0&gt;:
  FA&lt;op, (outs GPROut:$ra), (ins RC:$rb, RC:$rc),
     !strconcat(instr_asm, &quot;\t$ra, $rb, $rc&quot;),
     [(set GPROut:$ra, (OpNode RC:$rb, RC:$rc))], itin&gt; {
  let shamt = 0;
  let isCommutable = isComm;	// e.g. add rb rc =  add rc rb
  let isReMaterializable = 1;
}
}
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>let Predicates = [Ch3_4] in {
// Shifts
class shift_rotate_imm&lt;bits&lt;8&gt; op, bits&lt;4&gt; isRotate, string instr_asm,
                       SDNode OpNode, PatFrag PF, Operand ImmOpnd,
                       RegisterClass RC&gt;:
  FA&lt;op, (outs GPROut:$ra), (ins RC:$rb, ImmOpnd:$shamt),
     !strconcat(instr_asm, &quot;\t$ra, $rb, $shamt&quot;),
     [(set GPROut:$ra, (OpNode RC:$rb, PF:$shamt))], IIAlu&gt; {
  let rc = 0;
  let shamt = shamt;
}

// 32-bit shift instructions.
class shift_rotate_imm32&lt;bits&lt;8&gt; op, bits&lt;4&gt; isRotate, string instr_asm,
                         SDNode OpNode&gt;:
  shift_rotate_imm&lt;op, isRotate, instr_asm, OpNode, immZExt5, shamt, CPURegs&gt;;
}
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>let Predicates = [Ch3_4] in {
// Load Upper Imediate
class LoadUpper&lt;bits&lt;8&gt; op, string instr_asm, RegisterClass RC, Operand Imm&gt;:
  FL&lt;op, (outs RC:$ra), (ins Imm:$imm16),
     !strconcat(instr_asm, &quot;\t$ra, $imm16&quot;), [], IIAlu&gt; {
  let rb = 0;
  let isReMaterializable = 1;
}
}
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">let</span> <span class="n">Predicates</span> <span class="o">=</span> <span class="p">[</span><span class="n">Ch3_4</span><span class="p">]</span> <span class="n">in</span> <span class="p">{</span>
<span class="n">def</span> <span class="n">ORi</span>     <span class="o">:</span> <span class="n">ArithLogicI</span><span class="o">&lt;</span><span class="mh">0x0d</span><span class="p">,</span> <span class="s">&quot;ori&quot;</span><span class="p">,</span> <span class="n">or</span><span class="p">,</span> <span class="n">uimm16</span><span class="p">,</span> <span class="n">immZExt16</span><span class="p">,</span> <span class="n">CPURegs</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">let</span> <span class="n">Predicates</span> <span class="o">=</span> <span class="p">[</span><span class="n">Ch3_4</span><span class="p">]</span> <span class="n">in</span> <span class="p">{</span>
<span class="n">def</span> <span class="n">LUi</span>     <span class="o">:</span> <span class="n">LoadUpper</span><span class="o">&lt;</span><span class="mh">0x0f</span><span class="p">,</span> <span class="s">&quot;lui&quot;</span><span class="p">,</span> <span class="n">GPROut</span><span class="p">,</span> <span class="n">uimm16</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">let</span> <span class="n">Predicates</span> <span class="o">=</span> <span class="p">[</span><span class="n">Ch3_4</span><span class="p">]</span> <span class="n">in</span> <span class="p">{</span>
<span class="n">let</span> <span class="n">Predicates</span> <span class="o">=</span> <span class="p">[</span><span class="n">DisableOverflow</span><span class="p">]</span> <span class="n">in</span> <span class="p">{</span>
<span class="n">def</span> <span class="n">ADDu</span>    <span class="o">:</span> <span class="n">ArithLogicR</span><span class="o">&lt;</span><span class="mh">0x11</span><span class="p">,</span> <span class="s">&quot;addu&quot;</span><span class="p">,</span> <span class="n">add</span><span class="p">,</span> <span class="n">IIAlu</span><span class="p">,</span> <span class="n">CPURegs</span><span class="p">,</span> <span class="mi">1</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">let</span> <span class="n">Predicates</span> <span class="o">=</span> <span class="p">[</span><span class="n">Ch3_4</span><span class="p">]</span> <span class="n">in</span> <span class="p">{</span>
<span class="n">def</span> <span class="n">SHL</span>     <span class="o">:</span> <span class="n">shift_rotate_imm32</span><span class="o">&lt;</span><span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="s">&quot;shl&quot;</span><span class="p">,</span> <span class="n">shl</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">let</span> <span class="n">Predicates</span> <span class="o">=</span> <span class="p">[</span><span class="n">Ch3_4</span><span class="p">]</span> <span class="n">in</span> <span class="p">{</span>
<span class="n">let</span> <span class="n">isReturn</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">isTerminator</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">hasDelaySlot</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">isBarrier</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">hasCtrlDep</span><span class="o">=</span><span class="mi">1</span> <span class="n">in</span>
  <span class="n">def</span> <span class="n">RetLR</span> <span class="o">:</span> <span class="n">Cpu0Pseudo</span><span class="o">&lt;</span><span class="p">(</span><span class="n">outs</span><span class="p">),</span> <span class="p">(</span><span class="n">ins</span><span class="p">),</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="p">[(</span><span class="n">Cpu0Ret</span><span class="p">)]</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>let Predicates = [Ch3_4] in {
//===----------------------------------------------------------------------===//
// Instruction aliases
//===----------------------------------------------------------------------===//
def : Cpu0InstAlias&lt;&quot;move $dst, $src&quot;,
                    (ADDu GPROut:$dst, GPROut:$src,ZERO), 1&gt;;
}
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>let Predicates = [Ch3_4] in {
def : Pat&lt;(i32 immZExt16:$in),
          (ORi ZERO, imm:$in)&gt;;
def : Pat&lt;(i32 immLow16Zero:$in),
          (LUi (HI16 imm:$in))&gt;;

// Arbitrary immediates
def : Pat&lt;(i32 imm:$imm),
          (ORi (LUi (HI16 imm:$imm)), (LO16 imm:$imm))&gt;;
} // let Predicates = [Ch3_4]
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_4/Cpu0InstrInfo.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="cp">#include &quot;Cpu0AnalyzeImmediate.h&quot;</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="kt">void</span> <span class="nf">storeRegToStackSlot</span><span class="p">(</span><span class="n">MachineBasicBlock</span> <span class="o">&amp;</span><span class="n">MBB</span><span class="p">,</span>
                           <span class="n">MachineBasicBlock</span><span class="o">::</span><span class="n">iterator</span> <span class="n">MBBI</span><span class="p">,</span>
                           <span class="kt">unsigned</span> <span class="n">SrcReg</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">isKill</span><span class="p">,</span> <span class="kt">int</span> <span class="n">FrameIndex</span><span class="p">,</span>
                           <span class="k">const</span> <span class="n">TargetRegisterClass</span> <span class="o">*</span><span class="n">RC</span><span class="p">,</span>
                           <span class="k">const</span> <span class="n">TargetRegisterInfo</span> <span class="o">*</span><span class="n">TRI</span><span class="p">)</span> <span class="k">const</span> <span class="n">override</span> <span class="p">{</span>
    <span class="n">storeRegToStack</span><span class="p">(</span><span class="n">MBB</span><span class="p">,</span> <span class="n">MBBI</span><span class="p">,</span> <span class="n">SrcReg</span><span class="p">,</span> <span class="n">isKill</span><span class="p">,</span> <span class="n">FrameIndex</span><span class="p">,</span> <span class="n">RC</span><span class="p">,</span> <span class="n">TRI</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="n">loadRegFromStackSlot</span><span class="p">(</span><span class="n">MachineBasicBlock</span> <span class="o">&amp;</span><span class="n">MBB</span><span class="p">,</span>
                            <span class="n">MachineBasicBlock</span><span class="o">::</span><span class="n">iterator</span> <span class="n">MBBI</span><span class="p">,</span>
                            <span class="kt">unsigned</span> <span class="n">DestReg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">FrameIndex</span><span class="p">,</span>
                            <span class="k">const</span> <span class="n">TargetRegisterClass</span> <span class="o">*</span><span class="n">RC</span><span class="p">,</span>
                            <span class="k">const</span> <span class="n">TargetRegisterInfo</span> <span class="o">*</span><span class="n">TRI</span><span class="p">)</span> <span class="k">const</span> <span class="n">override</span> <span class="p">{</span>
    <span class="n">loadRegFromStack</span><span class="p">(</span><span class="n">MBB</span><span class="p">,</span> <span class="n">MBBI</span><span class="p">,</span> <span class="n">DestReg</span><span class="p">,</span> <span class="n">FrameIndex</span><span class="p">,</span> <span class="n">RC</span><span class="p">,</span> <span class="n">TRI</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">virtual</span> <span class="kt">void</span> <span class="n">storeRegToStack</span><span class="p">(</span><span class="n">MachineBasicBlock</span> <span class="o">&amp;</span><span class="n">MBB</span><span class="p">,</span>
                               <span class="n">MachineBasicBlock</span><span class="o">::</span><span class="n">iterator</span> <span class="n">MI</span><span class="p">,</span>
                               <span class="kt">unsigned</span> <span class="n">SrcReg</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">isKill</span><span class="p">,</span> <span class="kt">int</span> <span class="n">FrameIndex</span><span class="p">,</span>
                               <span class="k">const</span> <span class="n">TargetRegisterClass</span> <span class="o">*</span><span class="n">RC</span><span class="p">,</span>
                               <span class="k">const</span> <span class="n">TargetRegisterInfo</span> <span class="o">*</span><span class="n">TRI</span><span class="p">,</span>
                               <span class="kt">int64_t</span> <span class="n">Offset</span><span class="p">)</span> <span class="k">const</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="k">virtual</span> <span class="kt">void</span> <span class="n">loadRegFromStack</span><span class="p">(</span><span class="n">MachineBasicBlock</span> <span class="o">&amp;</span><span class="n">MBB</span><span class="p">,</span>
                                <span class="n">MachineBasicBlock</span><span class="o">::</span><span class="n">iterator</span> <span class="n">MI</span><span class="p">,</span>
                                <span class="kt">unsigned</span> <span class="n">DestReg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">FrameIndex</span><span class="p">,</span>
                                <span class="k">const</span> <span class="n">TargetRegisterClass</span> <span class="o">*</span><span class="n">RC</span><span class="p">,</span>
                                <span class="k">const</span> <span class="n">TargetRegisterInfo</span> <span class="o">*</span><span class="n">TRI</span><span class="p">,</span>
                                <span class="kt">int64_t</span> <span class="n">Offset</span><span class="p">)</span> <span class="k">const</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_4/Cpu0SEInstrInfo.h</p>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="kt">void</span> <span class="n">storeRegToStack</span><span class="p">(</span><span class="n">MachineBasicBlock</span> <span class="o">&amp;</span><span class="n">MBB</span><span class="p">,</span>
                       <span class="n">MachineBasicBlock</span><span class="o">::</span><span class="n">iterator</span> <span class="n">MI</span><span class="p">,</span>
                       <span class="kt">unsigned</span> <span class="n">SrcReg</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">isKill</span><span class="p">,</span> <span class="kt">int</span> <span class="n">FrameIndex</span><span class="p">,</span>
                       <span class="k">const</span> <span class="n">TargetRegisterClass</span> <span class="o">*</span><span class="n">RC</span><span class="p">,</span>
                       <span class="k">const</span> <span class="n">TargetRegisterInfo</span> <span class="o">*</span><span class="n">TRI</span><span class="p">,</span>
                       <span class="kt">int64_t</span> <span class="n">Offset</span><span class="p">)</span> <span class="k">const</span> <span class="n">override</span><span class="p">;</span>

  <span class="kt">void</span> <span class="n">loadRegFromStack</span><span class="p">(</span><span class="n">MachineBasicBlock</span> <span class="o">&amp;</span><span class="n">MBB</span><span class="p">,</span>
                        <span class="n">MachineBasicBlock</span><span class="o">::</span><span class="n">iterator</span> <span class="n">MI</span><span class="p">,</span>
                        <span class="kt">unsigned</span> <span class="n">DestReg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">FrameIndex</span><span class="p">,</span>
                        <span class="k">const</span> <span class="n">TargetRegisterClass</span> <span class="o">*</span><span class="n">RC</span><span class="p">,</span>
                        <span class="k">const</span> <span class="n">TargetRegisterInfo</span> <span class="o">*</span><span class="n">TRI</span><span class="p">,</span>
                        <span class="kt">int64_t</span> <span class="n">Offset</span><span class="p">)</span> <span class="k">const</span> <span class="n">override</span><span class="p">;</span>

  <span class="kt">bool</span> <span class="n">expandPostRAPseudo</span><span class="p">(</span><span class="n">MachineBasicBlock</span><span class="o">::</span><span class="n">iterator</span> <span class="n">MI</span><span class="p">)</span> <span class="k">const</span> <span class="n">override</span><span class="p">;</span>

  <span class="c1">/// Adjust SP by Amount bytes.</span>
  <span class="kt">void</span> <span class="n">adjustStackPtr</span><span class="p">(</span><span class="n">Cpu0FunctionInfo</span> <span class="o">*</span><span class="n">Cpu0FI</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">SP</span><span class="p">,</span> <span class="kt">int64_t</span> <span class="n">Amount</span><span class="p">,</span>
                      <span class="n">MachineBasicBlock</span> <span class="o">&amp;</span><span class="n">MBB</span><span class="p">,</span> <span class="n">MachineBasicBlock</span><span class="o">::</span><span class="n">iterator</span> <span class="n">I</span><span class="p">)</span> 
                      <span class="k">const</span><span class="p">;</span>

  <span class="c1">/// Emit a series of instructions to load an immediate. If NewImm is a</span>
  <span class="c1">/// non-NULL parameter, the last instruction is not emitted, but instead</span>
  <span class="c1">/// its immediate operand is returned in NewImm.</span>
  <span class="kt">unsigned</span> <span class="n">loadImmediate</span><span class="p">(</span><span class="kt">int64_t</span> <span class="n">Imm</span><span class="p">,</span> <span class="n">MachineBasicBlock</span> <span class="o">&amp;</span><span class="n">MBB</span><span class="p">,</span>
                         <span class="n">MachineBasicBlock</span><span class="o">::</span><span class="n">iterator</span> <span class="n">II</span><span class="p">,</span> <span class="n">DebugLoc</span> <span class="n">DL</span><span class="p">,</span>
                         <span class="kt">unsigned</span> <span class="o">*</span><span class="n">NewImm</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>
<span class="nl">private:</span>
  <span class="kt">void</span> <span class="n">ExpandRetLR</span><span class="p">(</span><span class="n">MachineBasicBlock</span> <span class="o">&amp;</span><span class="n">MBB</span><span class="p">,</span> <span class="n">MachineBasicBlock</span><span class="o">::</span><span class="n">iterator</span> <span class="n">I</span><span class="p">,</span>
                   <span class="kt">unsigned</span> <span class="n">Opc</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_4/Cpu0SEInstrInfo.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="k">static</span> <span class="n">MachineMemOperand</span><span class="o">*</span> <span class="nf">GetMemOperand</span><span class="p">(</span><span class="n">MachineBasicBlock</span> <span class="o">&amp;</span><span class="n">MBB</span><span class="p">,</span> <span class="kt">int</span> <span class="n">FI</span><span class="p">,</span>
                                        <span class="kt">unsigned</span> <span class="n">Flag</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">MF</span> <span class="o">=</span> <span class="o">*</span><span class="n">MBB</span><span class="p">.</span><span class="n">getParent</span><span class="p">();</span>
  <span class="n">MachineFrameInfo</span> <span class="o">&amp;</span><span class="n">MFI</span> <span class="o">=</span> <span class="o">*</span><span class="n">MF</span><span class="p">.</span><span class="n">getFrameInfo</span><span class="p">();</span>
  <span class="kt">unsigned</span> <span class="n">Align</span> <span class="o">=</span> <span class="n">MFI</span><span class="p">.</span><span class="n">getObjectAlignment</span><span class="p">(</span><span class="n">FI</span><span class="p">);</span>

  <span class="k">return</span> <span class="n">MF</span><span class="p">.</span><span class="n">getMachineMemOperand</span><span class="p">(</span><span class="n">MachinePointerInfo</span><span class="o">::</span><span class="n">getFixedStack</span><span class="p">(</span><span class="n">FI</span><span class="p">),</span> <span class="n">Flag</span><span class="p">,</span>
                                 <span class="n">MFI</span><span class="p">.</span><span class="n">getObjectSize</span><span class="p">(</span><span class="n">FI</span><span class="p">),</span> <span class="n">Align</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="kt">void</span> <span class="n">Cpu0SEInstrInfo</span><span class="o">::</span>
<span class="n">storeRegToStack</span><span class="p">(</span><span class="n">MachineBasicBlock</span> <span class="o">&amp;</span><span class="n">MBB</span><span class="p">,</span> <span class="n">MachineBasicBlock</span><span class="o">::</span><span class="n">iterator</span> <span class="n">I</span><span class="p">,</span>
                <span class="kt">unsigned</span> <span class="n">SrcReg</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">isKill</span><span class="p">,</span> <span class="kt">int</span> <span class="n">FI</span><span class="p">,</span>
                <span class="k">const</span> <span class="n">TargetRegisterClass</span> <span class="o">*</span><span class="n">RC</span><span class="p">,</span> <span class="k">const</span> <span class="n">TargetRegisterInfo</span> <span class="o">*</span><span class="n">TRI</span><span class="p">,</span>
                <span class="kt">int64_t</span> <span class="n">Offset</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="n">DebugLoc</span> <span class="n">DL</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">I</span> <span class="o">!=</span> <span class="n">MBB</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="n">DL</span> <span class="o">=</span> <span class="n">I</span><span class="o">-&gt;</span><span class="n">getDebugLoc</span><span class="p">();</span>
  <span class="n">MachineMemOperand</span> <span class="o">*</span><span class="n">MMO</span> <span class="o">=</span> <span class="n">GetMemOperand</span><span class="p">(</span><span class="n">MBB</span><span class="p">,</span> <span class="n">FI</span><span class="p">,</span> <span class="n">MachineMemOperand</span><span class="o">::</span><span class="n">MOStore</span><span class="p">);</span>

  <span class="kt">unsigned</span> <span class="n">Opc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="n">Opc</span> <span class="o">=</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">ST</span><span class="p">;</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">Opc</span> <span class="o">&amp;&amp;</span> <span class="s">&quot;Register class not handled!&quot;</span><span class="p">);</span>
  <span class="n">BuildMI</span><span class="p">(</span><span class="n">MBB</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">get</span><span class="p">(</span><span class="n">Opc</span><span class="p">)).</span><span class="n">addReg</span><span class="p">(</span><span class="n">SrcReg</span><span class="p">,</span> <span class="n">getKillRegState</span><span class="p">(</span><span class="n">isKill</span><span class="p">))</span>
    <span class="p">.</span><span class="n">addFrameIndex</span><span class="p">(</span><span class="n">FI</span><span class="p">).</span><span class="n">addImm</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">addMemOperand</span><span class="p">(</span><span class="n">MMO</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Cpu0SEInstrInfo</span><span class="o">::</span>
<span class="n">loadRegFromStack</span><span class="p">(</span><span class="n">MachineBasicBlock</span> <span class="o">&amp;</span><span class="n">MBB</span><span class="p">,</span> <span class="n">MachineBasicBlock</span><span class="o">::</span><span class="n">iterator</span> <span class="n">I</span><span class="p">,</span>
                 <span class="kt">unsigned</span> <span class="n">DestReg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">FI</span><span class="p">,</span> <span class="k">const</span> <span class="n">TargetRegisterClass</span> <span class="o">*</span><span class="n">RC</span><span class="p">,</span>
                 <span class="k">const</span> <span class="n">TargetRegisterInfo</span> <span class="o">*</span><span class="n">TRI</span><span class="p">,</span> <span class="kt">int64_t</span> <span class="n">Offset</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="n">DebugLoc</span> <span class="n">DL</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">I</span> <span class="o">!=</span> <span class="n">MBB</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="n">DL</span> <span class="o">=</span> <span class="n">I</span><span class="o">-&gt;</span><span class="n">getDebugLoc</span><span class="p">();</span>
  <span class="n">MachineMemOperand</span> <span class="o">*</span><span class="n">MMO</span> <span class="o">=</span> <span class="n">GetMemOperand</span><span class="p">(</span><span class="n">MBB</span><span class="p">,</span> <span class="n">FI</span><span class="p">,</span> <span class="n">MachineMemOperand</span><span class="o">::</span><span class="n">MOLoad</span><span class="p">);</span>
  <span class="kt">unsigned</span> <span class="n">Opc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="n">Opc</span> <span class="o">=</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">LD</span><span class="p">;</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">Opc</span> <span class="o">&amp;&amp;</span> <span class="s">&quot;Register class not handled!&quot;</span><span class="p">);</span>
  <span class="n">BuildMI</span><span class="p">(</span><span class="n">MBB</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">get</span><span class="p">(</span><span class="n">Opc</span><span class="p">),</span> <span class="n">DestReg</span><span class="p">).</span><span class="n">addFrameIndex</span><span class="p">(</span><span class="n">FI</span><span class="p">).</span><span class="n">addImm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">.</span><span class="n">addMemOperand</span><span class="p">(</span><span class="n">MMO</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Cpu0SEInstrInfo::expandPostRAPseudo</span>
<span class="c1">/// Expand Pseudo instructions into real backend instructions</span>
<span class="kt">bool</span> <span class="n">Cpu0SEInstrInfo</span><span class="o">::</span><span class="n">expandPostRAPseudo</span><span class="p">(</span><span class="n">MachineBasicBlock</span><span class="o">::</span><span class="n">iterator</span> <span class="n">MI</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="n">MachineBasicBlock</span> <span class="o">&amp;</span><span class="n">MBB</span> <span class="o">=</span> <span class="o">*</span><span class="n">MI</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">();</span>

  <span class="k">switch</span><span class="p">(</span><span class="n">MI</span><span class="o">-&gt;</span><span class="n">getDesc</span><span class="p">().</span><span class="n">getOpcode</span><span class="p">())</span> <span class="p">{</span>
  <span class="nl">default:</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">Cpu0</span>:<span class="o">:</span><span class="n">RetLR</span><span class="o">:</span>
    <span class="n">ExpandRetLR</span><span class="p">(</span><span class="n">MBB</span><span class="p">,</span> <span class="n">MI</span><span class="p">,</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">RET</span><span class="p">);</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">MBB</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">MI</span><span class="p">);</span>
  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">/// Adjust SP by Amount bytes.</span>
<span class="kt">void</span> <span class="n">Cpu0SEInstrInfo</span><span class="o">::</span><span class="n">adjustStackPtr</span><span class="p">(</span><span class="n">Cpu0FunctionInfo</span> <span class="o">*</span><span class="n">Cpu0FI</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">SP</span><span class="p">,</span> 
                                     <span class="kt">int64_t</span> <span class="n">Amount</span><span class="p">,</span> <span class="n">MachineBasicBlock</span> <span class="o">&amp;</span><span class="n">MBB</span><span class="p">,</span>
                                     <span class="n">MachineBasicBlock</span><span class="o">::</span><span class="n">iterator</span> <span class="n">I</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="n">DebugLoc</span> <span class="n">DL</span> <span class="o">=</span> <span class="n">I</span> <span class="o">!=</span> <span class="n">MBB</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="o">?</span> <span class="n">I</span><span class="o">-&gt;</span><span class="n">getDebugLoc</span><span class="p">()</span> <span class="o">:</span> <span class="n">DebugLoc</span><span class="p">();</span>
  <span class="kt">unsigned</span> <span class="n">ADDu</span> <span class="o">=</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">ADDu</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="n">ADDiu</span> <span class="o">=</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">ADDiu</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">isInt</span><span class="o">&lt;</span><span class="mi">16</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Amount</span><span class="p">))</span><span class="c1">// addiu sp, sp, amount</span>
    <span class="n">BuildMI</span><span class="p">(</span><span class="n">MBB</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">get</span><span class="p">(</span><span class="n">ADDiu</span><span class="p">),</span> <span class="n">SP</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">SP</span><span class="p">).</span><span class="n">addImm</span><span class="p">(</span><span class="n">Amount</span><span class="p">);</span>
  <span class="k">else</span> <span class="p">{</span> <span class="c1">// Expand immediate that doesn&#39;t fit in 16-bit.</span>
    <span class="n">Cpu0FI</span><span class="o">-&gt;</span><span class="n">setEmitNOAT</span><span class="p">();</span>
    <span class="kt">unsigned</span> <span class="n">Reg</span> <span class="o">=</span> <span class="n">loadImmediate</span><span class="p">(</span><span class="n">Amount</span><span class="p">,</span> <span class="n">MBB</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">nullptr</span><span class="p">);</span>
    <span class="n">BuildMI</span><span class="p">(</span><span class="n">MBB</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">get</span><span class="p">(</span><span class="n">ADDu</span><span class="p">),</span> <span class="n">SP</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">SP</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">Reg</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">/// This function generates the sequence of instructions needed to get the</span>
<span class="c1">/// result of adding register REG and immediate IMM.</span>
<span class="kt">unsigned</span>
<span class="n">Cpu0SEInstrInfo</span><span class="o">::</span><span class="n">loadImmediate</span><span class="p">(</span><span class="kt">int64_t</span> <span class="n">Imm</span><span class="p">,</span> <span class="n">MachineBasicBlock</span> <span class="o">&amp;</span><span class="n">MBB</span><span class="p">,</span>
                               <span class="n">MachineBasicBlock</span><span class="o">::</span><span class="n">iterator</span> <span class="n">II</span><span class="p">,</span> <span class="n">DebugLoc</span> <span class="n">DL</span><span class="p">,</span>
                               <span class="kt">unsigned</span> <span class="o">*</span><span class="n">NewImm</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="n">Cpu0AnalyzeImmediate</span> <span class="n">AnalyzeImm</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="n">Size</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="n">LUi</span> <span class="o">=</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">LUi</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="n">ZEROReg</span> <span class="o">=</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">ZERO</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="n">ATReg</span> <span class="o">=</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">AT</span><span class="p">;</span>
  <span class="kt">bool</span> <span class="n">LastInstrIsADDiu</span> <span class="o">=</span> <span class="n">NewImm</span><span class="p">;</span>

  <span class="k">const</span> <span class="n">Cpu0AnalyzeImmediate</span><span class="o">::</span><span class="n">InstSeq</span> <span class="o">&amp;</span><span class="n">Seq</span> <span class="o">=</span>
    <span class="n">AnalyzeImm</span><span class="p">.</span><span class="n">Analyze</span><span class="p">(</span><span class="n">Imm</span><span class="p">,</span> <span class="n">Size</span><span class="p">,</span> <span class="n">LastInstrIsADDiu</span><span class="p">);</span>
  <span class="n">Cpu0AnalyzeImmediate</span><span class="o">::</span><span class="n">InstSeq</span><span class="o">::</span><span class="n">const_iterator</span> <span class="n">Inst</span> <span class="o">=</span> <span class="n">Seq</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>

  <span class="n">assert</span><span class="p">(</span><span class="n">Seq</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">LastInstrIsADDiu</span> <span class="o">||</span> <span class="p">(</span><span class="n">Seq</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)));</span>

  <span class="c1">// The first instruction can be a LUi, which is different from other</span>
  <span class="c1">// instructions (ADDiu, ORI and SLL) in that it does not have a register</span>
  <span class="c1">// operand.</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Inst</span><span class="o">-&gt;</span><span class="n">Opc</span> <span class="o">==</span> <span class="n">LUi</span><span class="p">)</span>
    <span class="n">BuildMI</span><span class="p">(</span><span class="n">MBB</span><span class="p">,</span> <span class="n">II</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">get</span><span class="p">(</span><span class="n">LUi</span><span class="p">),</span> <span class="n">ATReg</span><span class="p">).</span><span class="n">addImm</span><span class="p">(</span><span class="n">SignExtend64</span><span class="o">&lt;</span><span class="mi">16</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Inst</span><span class="o">-&gt;</span><span class="n">ImmOpnd</span><span class="p">));</span>
  <span class="k">else</span>
    <span class="nf">BuildMI</span><span class="p">(</span><span class="n">MBB</span><span class="p">,</span> <span class="n">II</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">get</span><span class="p">(</span><span class="n">Inst</span><span class="o">-&gt;</span><span class="n">Opc</span><span class="p">),</span> <span class="n">ATReg</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">ZEROReg</span><span class="p">)</span>
      <span class="p">.</span><span class="n">addImm</span><span class="p">(</span><span class="n">SignExtend64</span><span class="o">&lt;</span><span class="mi">16</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Inst</span><span class="o">-&gt;</span><span class="n">ImmOpnd</span><span class="p">));</span>

  <span class="c1">// Build the remaining instructions in Seq.</span>
  <span class="k">for</span> <span class="p">(</span><span class="o">++</span><span class="n">Inst</span><span class="p">;</span> <span class="n">Inst</span> <span class="o">!=</span> <span class="n">Seq</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="o">-</span> <span class="n">LastInstrIsADDiu</span><span class="p">;</span> <span class="o">++</span><span class="n">Inst</span><span class="p">)</span>
    <span class="n">BuildMI</span><span class="p">(</span><span class="n">MBB</span><span class="p">,</span> <span class="n">II</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">get</span><span class="p">(</span><span class="n">Inst</span><span class="o">-&gt;</span><span class="n">Opc</span><span class="p">),</span> <span class="n">ATReg</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">ATReg</span><span class="p">)</span>
      <span class="p">.</span><span class="n">addImm</span><span class="p">(</span><span class="n">SignExtend64</span><span class="o">&lt;</span><span class="mi">16</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Inst</span><span class="o">-&gt;</span><span class="n">ImmOpnd</span><span class="p">));</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">LastInstrIsADDiu</span><span class="p">)</span>
    <span class="o">*</span><span class="n">NewImm</span> <span class="o">=</span> <span class="n">Inst</span><span class="o">-&gt;</span><span class="n">ImmOpnd</span><span class="p">;</span>

  <span class="k">return</span> <span class="n">ATReg</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Cpu0SEInstrInfo</span><span class="o">::</span><span class="n">ExpandRetLR</span><span class="p">(</span><span class="n">MachineBasicBlock</span> <span class="o">&amp;</span><span class="n">MBB</span><span class="p">,</span>
                                <span class="n">MachineBasicBlock</span><span class="o">::</span><span class="n">iterator</span> <span class="n">I</span><span class="p">,</span>
                                <span class="kt">unsigned</span> <span class="n">Opc</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="n">BuildMI</span><span class="p">(</span><span class="n">MBB</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">I</span><span class="o">-&gt;</span><span class="n">getDebugLoc</span><span class="p">(),</span> <span class="n">get</span><span class="p">(</span><span class="n">Opc</span><span class="p">)).</span><span class="n">addReg</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">LR</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_4/Cpu0ISelLowering.h</p>
<p class="rubric">lbdex/chapters/Chapter3_4/Cpu0ISelLowering.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">SDValue</span>
<span class="n">Cpu0TargetLowering</span><span class="o">::</span><span class="n">LowerReturn</span><span class="p">(</span><span class="n">SDValue</span> <span class="n">Chain</span><span class="p">,</span>
                                <span class="n">CallingConv</span><span class="o">::</span><span class="n">ID</span> <span class="n">CallConv</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">IsVarArg</span><span class="p">,</span>
                                <span class="k">const</span> <span class="n">SmallVectorImpl</span><span class="o">&lt;</span><span class="n">ISD</span><span class="o">::</span><span class="n">OutputArg</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">Outs</span><span class="p">,</span>
                                <span class="k">const</span> <span class="n">SmallVectorImpl</span><span class="o">&lt;</span><span class="n">SDValue</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">OutVals</span><span class="p">,</span>
                                <span class="n">SDLoc</span> <span class="n">DL</span><span class="p">,</span> <span class="n">SelectionDAG</span> <span class="o">&amp;</span><span class="n">DAG</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="c1">// CCValAssign - represent the assignment of</span>
  <span class="c1">// the return value to a location</span>
  <span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">CCValAssign</span><span class="p">,</span> <span class="mi">16</span><span class="o">&gt;</span> <span class="n">RVLocs</span><span class="p">;</span>
  <span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">MF</span> <span class="o">=</span> <span class="n">DAG</span><span class="p">.</span><span class="n">getMachineFunction</span><span class="p">();</span>

  <span class="c1">// CCState - Info about the registers and stack slot.</span>
  <span class="n">CCState</span> <span class="nf">CCInfo</span><span class="p">(</span><span class="n">CallConv</span><span class="p">,</span> <span class="n">IsVarArg</span><span class="p">,</span> <span class="n">MF</span><span class="p">,</span> <span class="n">RVLocs</span><span class="p">,</span>
                 <span class="o">*</span><span class="n">DAG</span><span class="p">.</span><span class="n">getContext</span><span class="p">());</span>
  <span class="n">Cpu0CC</span> <span class="nf">Cpu0CCInfo</span><span class="p">(</span><span class="n">CallConv</span><span class="p">,</span> <span class="n">ABI</span><span class="p">.</span><span class="n">IsO32</span><span class="p">(),</span> 
                    <span class="n">CCInfo</span><span class="p">);</span>

  <span class="c1">// Analyze return values.</span>
  <span class="n">Cpu0CCInfo</span><span class="p">.</span><span class="n">analyzeReturn</span><span class="p">(</span><span class="n">Outs</span><span class="p">,</span> <span class="n">Subtarget</span><span class="p">.</span><span class="n">abiUsesSoftFloat</span><span class="p">(),</span>
                           <span class="n">MF</span><span class="p">.</span><span class="n">getFunction</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getReturnType</span><span class="p">());</span>

  <span class="n">SDValue</span> <span class="n">Flag</span><span class="p">;</span>
  <span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">SDValue</span><span class="p">,</span> <span class="mi">4</span><span class="o">&gt;</span> <span class="n">RetOps</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">Chain</span><span class="p">);</span>

  <span class="c1">// Copy the result values into the output registers.</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">RVLocs</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">SDValue</span> <span class="n">Val</span> <span class="o">=</span> <span class="n">OutVals</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="n">CCValAssign</span> <span class="o">&amp;</span><span class="n">VA</span> <span class="o">=</span> <span class="n">RVLocs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">VA</span><span class="p">.</span><span class="n">isRegLoc</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="s">&quot;Can only return in registers!&quot;</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">RVLocs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getValVT</span><span class="p">()</span> <span class="o">!=</span> <span class="n">RVLocs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getLocVT</span><span class="p">())</span>
      <span class="n">Val</span> <span class="o">=</span> <span class="n">DAG</span><span class="p">.</span><span class="n">getNode</span><span class="p">(</span><span class="n">ISD</span><span class="o">::</span><span class="n">BITCAST</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">RVLocs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getLocVT</span><span class="p">(),</span> <span class="n">Val</span><span class="p">);</span>

    <span class="n">Chain</span> <span class="o">=</span> <span class="n">DAG</span><span class="p">.</span><span class="n">getCopyToReg</span><span class="p">(</span><span class="n">Chain</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">VA</span><span class="p">.</span><span class="n">getLocReg</span><span class="p">(),</span> <span class="n">Val</span><span class="p">,</span> <span class="n">Flag</span><span class="p">);</span>

    <span class="c1">// Guarantee that all emitted copies are stuck together with flags.</span>
    <span class="n">Flag</span> <span class="o">=</span> <span class="n">Chain</span><span class="p">.</span><span class="n">getValue</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">RetOps</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">DAG</span><span class="p">.</span><span class="n">getRegister</span><span class="p">(</span><span class="n">VA</span><span class="p">.</span><span class="n">getLocReg</span><span class="p">(),</span> <span class="n">VA</span><span class="p">.</span><span class="n">getLocVT</span><span class="p">()));</span>
  <span class="p">}</span>

<span class="c1">//@Ordinary struct type: 2 {</span>
  <span class="c1">// The cpu0 ABIs for returning structs by value requires that we copy</span>
  <span class="c1">// the sret argument into $v0 for the return. We saved the argument into</span>
  <span class="c1">// a virtual register in the entry block, so now we copy the value out</span>
  <span class="c1">// and into $v0.</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">MF</span><span class="p">.</span><span class="n">getFunction</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">hasStructRetAttr</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">Cpu0FunctionInfo</span> <span class="o">*</span><span class="n">Cpu0FI</span> <span class="o">=</span> <span class="n">MF</span><span class="p">.</span><span class="n">getInfo</span><span class="o">&lt;</span><span class="n">Cpu0FunctionInfo</span><span class="o">&gt;</span><span class="p">();</span>
    <span class="kt">unsigned</span> <span class="n">Reg</span> <span class="o">=</span> <span class="n">Cpu0FI</span><span class="o">-&gt;</span><span class="n">getSRetReturnReg</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Reg</span><span class="p">)</span>
      <span class="n">llvm_unreachable</span><span class="p">(</span><span class="s">&quot;sret virtual register not created in the entry block&quot;</span><span class="p">);</span>
    <span class="n">SDValue</span> <span class="n">Val</span> <span class="o">=</span>
        <span class="n">DAG</span><span class="p">.</span><span class="n">getCopyFromReg</span><span class="p">(</span><span class="n">Chain</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">Reg</span><span class="p">,</span> <span class="n">getPointerTy</span><span class="p">(</span><span class="n">DAG</span><span class="p">.</span><span class="n">getDataLayout</span><span class="p">()));</span>
    <span class="kt">unsigned</span> <span class="n">V0</span> <span class="o">=</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">V0</span><span class="p">;</span>

    <span class="n">Chain</span> <span class="o">=</span> <span class="n">DAG</span><span class="p">.</span><span class="n">getCopyToReg</span><span class="p">(</span><span class="n">Chain</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">V0</span><span class="p">,</span> <span class="n">Val</span><span class="p">,</span> <span class="n">Flag</span><span class="p">);</span>
    <span class="n">Flag</span> <span class="o">=</span> <span class="n">Chain</span><span class="p">.</span><span class="n">getValue</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">RetOps</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">DAG</span><span class="p">.</span><span class="n">getRegister</span><span class="p">(</span><span class="n">V0</span><span class="p">,</span> <span class="n">getPointerTy</span><span class="p">(</span><span class="n">DAG</span><span class="p">.</span><span class="n">getDataLayout</span><span class="p">())));</span>
  <span class="p">}</span>
<span class="c1">//@Ordinary struct type: 2 }</span>

  <span class="n">RetOps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Chain</span><span class="p">;</span>  <span class="c1">// Update chain.</span>

  <span class="c1">// Add the flag if we have it.</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Flag</span><span class="p">.</span><span class="n">getNode</span><span class="p">())</span>
    <span class="n">RetOps</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">Flag</span><span class="p">);</span>

  <span class="c1">// Return on Cpu0 is always a &quot;ret $lr&quot;</span>
  <span class="k">return</span> <span class="n">DAG</span><span class="p">.</span><span class="n">getNode</span><span class="p">(</span><span class="n">Cpu0ISD</span><span class="o">::</span><span class="n">Ret</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">MVT</span><span class="o">::</span><span class="n">Other</span><span class="p">,</span> <span class="n">RetOps</span><span class="p">);</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="p">}</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Ty</span><span class="o">&gt;</span>
<span class="kt">void</span> <span class="n">Cpu0TargetLowering</span><span class="o">::</span><span class="n">Cpu0CC</span><span class="o">::</span>
<span class="n">analyzeReturn</span><span class="p">(</span><span class="k">const</span> <span class="n">SmallVectorImpl</span><span class="o">&lt;</span><span class="n">Ty</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">RetVals</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">IsSoftFloat</span><span class="p">,</span>
              <span class="k">const</span> <span class="n">SDNode</span> <span class="o">*</span><span class="n">CallNode</span><span class="p">,</span> <span class="k">const</span> <span class="n">Type</span> <span class="o">*</span><span class="n">RetTy</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="n">CCAssignFn</span> <span class="o">*</span><span class="n">Fn</span><span class="p">;</span>

  <span class="n">Fn</span> <span class="o">=</span> <span class="n">RetCC_Cpu0</span><span class="p">;</span>

  <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="n">I</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">E</span> <span class="o">=</span> <span class="n">RetVals</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">I</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">;</span> <span class="o">++</span><span class="n">I</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">MVT</span> <span class="n">VT</span> <span class="o">=</span> <span class="n">RetVals</span><span class="p">[</span><span class="n">I</span><span class="p">].</span><span class="n">VT</span><span class="p">;</span>
    <span class="n">ISD</span><span class="o">::</span><span class="n">ArgFlagsTy</span> <span class="n">Flags</span> <span class="o">=</span> <span class="n">RetVals</span><span class="p">[</span><span class="n">I</span><span class="p">].</span><span class="n">Flags</span><span class="p">;</span>
    <span class="n">MVT</span> <span class="n">RegVT</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">getRegVT</span><span class="p">(</span><span class="n">VT</span><span class="p">,</span> <span class="n">RetTy</span><span class="p">,</span> <span class="n">CallNode</span><span class="p">,</span> <span class="n">IsSoftFloat</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">Fn</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">VT</span><span class="p">,</span> <span class="n">RegVT</span><span class="p">,</span> <span class="n">CCValAssign</span><span class="o">::</span><span class="n">Full</span><span class="p">,</span> <span class="n">Flags</span><span class="p">,</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">CCInfo</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifndef NDEBUG</span>
      <span class="n">dbgs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Call result #&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">I</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; has unhandled type &quot;</span>
             <span class="o">&lt;&lt;</span> <span class="n">EVT</span><span class="p">(</span><span class="n">VT</span><span class="p">).</span><span class="n">getEVTString</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
<span class="cp">#endif</span>
      <span class="n">llvm_unreachable</span><span class="p">(</span><span class="n">nullptr</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Cpu0TargetLowering</span><span class="o">::</span><span class="n">Cpu0CC</span><span class="o">::</span>
<span class="n">analyzeCallResult</span><span class="p">(</span><span class="k">const</span> <span class="n">SmallVectorImpl</span><span class="o">&lt;</span><span class="n">ISD</span><span class="o">::</span><span class="n">InputArg</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">Ins</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">IsSoftFloat</span><span class="p">,</span>
                  <span class="k">const</span> <span class="n">SDNode</span> <span class="o">*</span><span class="n">CallNode</span><span class="p">,</span> <span class="k">const</span> <span class="n">Type</span> <span class="o">*</span><span class="n">RetTy</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="n">analyzeReturn</span><span class="p">(</span><span class="n">Ins</span><span class="p">,</span> <span class="n">IsSoftFloat</span><span class="p">,</span> <span class="n">CallNode</span><span class="p">,</span> <span class="n">RetTy</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Cpu0TargetLowering</span><span class="o">::</span><span class="n">Cpu0CC</span><span class="o">::</span>
<span class="n">analyzeReturn</span><span class="p">(</span><span class="k">const</span> <span class="n">SmallVectorImpl</span><span class="o">&lt;</span><span class="n">ISD</span><span class="o">::</span><span class="n">OutputArg</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">Outs</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">IsSoftFloat</span><span class="p">,</span>
              <span class="k">const</span> <span class="n">Type</span> <span class="o">*</span><span class="n">RetTy</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="n">analyzeReturn</span><span class="p">(</span><span class="n">Outs</span><span class="p">,</span> <span class="n">IsSoftFloat</span><span class="p">,</span> <span class="n">nullptr</span><span class="p">,</span> <span class="n">RetTy</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="kt">unsigned</span> <span class="n">Cpu0TargetLowering</span><span class="o">::</span><span class="n">Cpu0CC</span><span class="o">::</span><span class="n">reservedArgArea</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">IsO32</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">CallConv</span> <span class="o">!=</span> <span class="n">CallingConv</span><span class="o">::</span><span class="n">Fast</span><span class="p">))</span> <span class="o">?</span> <span class="mi">8</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">MVT</span> <span class="n">Cpu0TargetLowering</span><span class="o">::</span><span class="n">Cpu0CC</span><span class="o">::</span><span class="n">getRegVT</span><span class="p">(</span><span class="n">MVT</span> <span class="n">VT</span><span class="p">,</span> <span class="k">const</span> <span class="n">Type</span> <span class="o">*</span><span class="n">OrigTy</span><span class="p">,</span>
                                         <span class="k">const</span> <span class="n">SDNode</span> <span class="o">*</span><span class="n">CallNode</span><span class="p">,</span>
                                         <span class="kt">bool</span> <span class="n">IsSoftFloat</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">IsSoftFloat</span> <span class="o">||</span> <span class="n">IsO32</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">VT</span><span class="p">;</span>

  <span class="k">return</span> <span class="n">VT</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_4/Cpu0MachineFunction.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">/// Cpu0FunctionInfo - This class is derived from MachineFunction private</span>
<span class="c1">/// Cpu0 target-specific information for each MachineFunction.</span>
<span class="k">class</span> <span class="nc">Cpu0FunctionInfo</span> <span class="o">:</span> <span class="k">public</span> <span class="n">MachineFunctionInfo</span> <span class="p">{</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>    <span class="n">SRetReturnReg</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">CallsEhReturn</span><span class="p">(</span><span class="nb">false</span><span class="p">),</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="kt">unsigned</span> <span class="n">getSRetReturnReg</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">SRetReturnReg</span><span class="p">;</span> <span class="p">}</span>
  <span class="kt">void</span> <span class="n">setSRetReturnReg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">Reg</span><span class="p">)</span> <span class="p">{</span> <span class="n">SRetReturnReg</span> <span class="o">=</span> <span class="n">Reg</span><span class="p">;</span> <span class="p">}</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="kt">bool</span> <span class="n">hasByvalArg</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">HasByvalArg</span><span class="p">;</span> <span class="p">}</span>
  <span class="kt">void</span> <span class="n">setFormalArgInfo</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">Size</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">HasByval</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">IncomingArgSize</span> <span class="o">=</span> <span class="n">Size</span><span class="p">;</span>
    <span class="n">HasByvalArg</span> <span class="o">=</span> <span class="n">HasByval</span><span class="p">;</span>
  <span class="p">}</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="c1">/// SRetReturnReg - Some subtargets require that sret lowering includes</span>
  <span class="c1">/// returning the value of the returned struct in a register. This field</span>
  <span class="c1">/// holds the virtual register into which the sret argument is passed.</span>
  <span class="kt">unsigned</span> <span class="n">SRetReturnReg</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="c1">/// True if function has a byval argument.</span>
  <span class="kt">bool</span> <span class="n">HasByvalArg</span><span class="p">;</span>

  <span class="c1">/// Size of incoming argument area.</span>
  <span class="kt">unsigned</span> <span class="n">IncomingArgSize</span><span class="p">;</span>

  <span class="c1">/// CallsEhReturn - Whether the function calls llvm.eh.return.</span>
  <span class="kt">bool</span> <span class="n">CallsEhReturn</span><span class="p">;</span>

  <span class="c1">/// Frame objects for spilling eh data registers.</span>
  <span class="kt">int</span> <span class="n">EhDataRegFI</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_4/Cpu0RegisterInfo.cpp</p>
<p class="rubric">lbdex/chapters/Chapter3_4/Cpu0SEISelDAGToDAG.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="cp">#include &quot;Cpu0AnalyzeImmediate.h&quot;</span>
</pre></div>
</div>
<p>To handle IR ret, these code in Cpu0InstrInfo.td do things as below.</p>
<p>1. Declare a pseudo node Cpu0::RetLR to takes care the IR Cpu0ISD::Ret by the
following code,</p>
<p class="rubric">lbdex/chapters/Chapter3_4/Cpu0InstrInfo.td</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">// Return</span>
<span class="n">def</span> <span class="n">Cpu0Ret</span> <span class="o">:</span> <span class="n">SDNode</span><span class="o">&lt;</span><span class="s">&quot;Cpu0ISD::Ret&quot;</span><span class="p">,</span> <span class="n">SDTNone</span><span class="p">,</span>
                     <span class="p">[</span><span class="n">SDNPHasChain</span><span class="p">,</span> <span class="n">SDNPOptInGlue</span><span class="p">,</span> <span class="n">SDNPVariadic</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">let</span> <span class="n">Predicates</span> <span class="o">=</span> <span class="p">[</span><span class="n">Ch3_4</span><span class="p">]</span> <span class="n">in</span> <span class="p">{</span>
<span class="n">let</span> <span class="n">isReturn</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">isTerminator</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">hasDelaySlot</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">isBarrier</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">hasCtrlDep</span><span class="o">=</span><span class="mi">1</span> <span class="n">in</span>
  <span class="n">def</span> <span class="n">RetLR</span> <span class="o">:</span> <span class="n">Cpu0Pseudo</span><span class="o">&lt;</span><span class="p">(</span><span class="n">outs</span><span class="p">),</span> <span class="p">(</span><span class="n">ins</span><span class="p">),</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="p">[(</span><span class="n">Cpu0Ret</span><span class="p">)]</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li>Create Cpu0ISD::Ret node in LowerReturn() of Cpu0ISelLowering.cpp, which is
called when meets keyword of return in C.</li>
<li>After instruction selection, the Cpu0ISD::Ret is replaced by Cpu0::RetLR
as below. This effect come from &#8220;def RetLR&#8221; as step 1.</li>
</ol>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">=====</span> Instruction selection begins: BB#0 <span class="s1">&#39;entry&#39;</span>
Selecting: 0x1ea4050: <span class="nv">ch</span> <span class="o">=</span> Cpu0ISD::Ret 0x1ea3f50, 0x1ea3e50,
0x1ea3f50:1 <span class="o">[</span><span class="nv">ID</span><span class="o">=</span>27<span class="o">]</span>

ISEL: Starting pattern match on root node: 0x1ea4050: <span class="nv">ch</span> <span class="o">=</span> Cpu0ISD::Ret
0x1ea3f50, 0x1ea3e50, 0x1ea3f50:1 <span class="o">[</span><span class="nv">ID</span><span class="o">=</span>27<span class="o">]</span>

  Morphed node: 0x1ea4050: <span class="nv">ch</span> <span class="o">=</span> RetLR 0x1ea3e50, 0x1ea3f50, 0x1ea3f50:1
...
ISEL: Match <span class="nb">complete</span>!
<span class="o">=</span>&gt; 0x1ea4050: <span class="nv">ch</span> <span class="o">=</span> RetLR 0x1ea3e50, 0x1ea3f50, 0x1ea3f50:1
...
<span class="o">=====</span> Instruction selection ends:
Selected selection DAG: BB#0 <span class="s1">&#39;main:entry&#39;</span>
SelectionDAG has 28 nodes:
...
    0x1ea3e50: &lt;multiple use&gt;
    0x1ea3f50: &lt;multiple use&gt;
    0x1ea3f50: &lt;multiple use&gt;
  0x1ea4050: <span class="nv">ch</span> <span class="o">=</span> RetLR 0x1ea3e50, 0x1ea3f50, 0x1ea3f50:1
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li>Expand the Cpu0ISD::RetLR into instruction Cpu0::RET $lr in &#8220;Post-RA pseudo
instruction expansion pass&#8221; stage by the code in Chapter3_4/Cpu0SEInstrInfo.cpp
as above. This stage come after the register allocation, so we can replace the
V0 ($r2) by LR ($lr) without any side effect.</li>
<li>Print assembly or obj according the information (those *.inc generated by
TableGen from *.td) generated by the following code at &#8220;Cpu0 Assembly
Printer&#8221; stage.</li>
</ol>
<p class="rubric">lbdex/chapters/Chapter2/Cpu0InstrInfo.td</p>
<div class="highlight-c++"><div class="highlight"><pre>let isBranch=1, isTerminator=1, isBarrier=1, imm16=0, hasDelaySlot = 1,
    isIndirectBranch = 1 in
class JumpFR&lt;bits&lt;8&gt; op, string instr_asm, RegisterClass RC&gt;:
  FL&lt;op, (outs), (ins RC:$ra),
     !strconcat(instr_asm, &quot;\t$ra&quot;), [(brind RC:$ra)], IIBranch&gt; {
  let rb = 0;
  let imm16 = 0;
}

// Return instruction
class RetBase&lt;RegisterClass RC&gt;: JumpFR&lt;0x3c, &quot;ret&quot;, RC&gt; {
  let isReturn = 1;
  let isCodeGenOnly = 1;
  let hasCtrlDep = 1;
  let hasExtraSrcRegAllocReq = 1;
}
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">def</span> <span class="n">RET</span>     <span class="o">:</span> <span class="n">RetBase</span><span class="o">&lt;</span><span class="n">GPROut</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<caption>Handle return register lr</caption>
<colgroup>
<col width="56%" />
<col width="44%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Stage</th>
<th class="head">Function</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Write Code</td>
<td>Declare a pseudo node Cpu0::RetLR</td>
</tr>
<tr class="row-odd"><td><ul class="first last simple">
<li></li>
</ul>
</td>
<td>for IR Cpu0::Ret;</td>
</tr>
<tr class="row-even"><td>Before CPU0 DAG-&gt;DAG Pattern Instruction Selection</td>
<td>Create Cpu0ISD::Ret DAG</td>
</tr>
<tr class="row-odd"><td>Instruction selection</td>
<td>Cpu0::Ret is replaced by Cpu0::RetLR</td>
</tr>
<tr class="row-even"><td>Post-RA pseudo instruction expansion pass</td>
<td>Cpu0::RetLR -&gt; Cpu0::RET $lr</td>
</tr>
<tr class="row-odd"><td>Cpu0 Assembly Printer</td>
<td>Print according &#8220;def RET&#8221;</td>
</tr>
</tbody>
</table>
<p>Function LowerReturn() of Cpu0ISelLowering.cpp handle return variable correctly.
Chapter3_4/Cpu0ISelLowering.cpp create Cpu0ISD::Ret node in LowerReturn() which
is called by llvm system when it meets C&#8217;s keyword of return.
More specificly, it creates DAGs (Cpu0ISD::Ret (CopyToReg %X, %V0, %Y), %V0,
Flag). Since the the
V0 register is assigned in CopyToReg and Cpu0ISD::Ret use V0, the CopyToReg
with V0 register will live out and won&#8217;t be removed at any later optimization
steps. Remember, if use &#8220;return DAG.getNode(Cpu0ISD::Ret, DL, MVT::Other,
Chain, DAG.getRegister(Cpu0::LR, MVT::i32));&#8221; instead of &#8220;return DAG.getNode
(Cpu0ISD::Ret, DL, MVT::Other, &amp;RetOps[0], RetOps.size());&#8221; then the V0 register
won&#8217;t be live out, and the previous DAG (CopyToReg %X, %V0, %Y) will be removed
at later optimization steps. It ending with the return value is error.</p>
<p>Function storeRegToStack() and loadRegFromStack() of Cpu0SEInstrInfo.cpp,
storeRegToStackSlot() and loadRegFromStackSlot() of Cpu0InstrInfo.cpp are for
handling the registers spill during register allocation process.</p>
<p>Build Chapter3_4 and run with it, finding the error message in Chapter3_3 is
gone. The compile result as follows,</p>
<div class="highlight-bash"><div class="highlight"><pre>118-165-78-230:input Jonathan<span class="nv">$ </span>/Users/Jonathan/llvm/test/cmake_debug_build/
Debug/bin/llc -march<span class="o">=</span>cpu0 -relocation-model<span class="o">=</span>pic -filetype<span class="o">=</span>asm ch3.bc -o -
        .text
        .section .mdebug.abi32
        .previous
        .file <span class="s2">&quot;ch3.bc&quot;</span>
        .globl        main
        .align        2
        .type main,@function
        .ent  main                    <span class="c"># @main</span>
main:
        .frame        <span class="nv">$fp</span>,8,<span class="nv">$lr</span>
        .mask         0x00000000,0
        .set  noreorder
        .set  nomacro
<span class="c"># BB#0:</span>
        addiu <span class="nv">$2</span>, <span class="nv">$zero</span>, 0
        st    <span class="nv">$2</span>, 4<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        ret   <span class="nv">$lr</span>
        .set  macro
        .set  reorder
        .end  main
<span class="nv">$tmp0</span>:
        .size main, <span class="o">(</span><span class="nv">$tmp0</span><span class="o">)</span>-main
</pre></div>
</div>
<p>Although Chapter3_4 can generated asm for ch3.cpp, you will find the
** st $2, 4($fp) ** instruction will has trouble since the stack pointer
(stack frame) has not addjustment. This problem will be fixed at Chapter3_5.</p>
</div>
<div class="section" id="add-prologue-epilogue-functions">
<h2><a class="toc-backref" href="#id9">Add Prologue/Epilogue functions</a><a class="headerlink" href="#add-prologue-epilogue-functions" title="Permalink to this headline">¶</a></h2>
<p>Following come from tricore_llvm.pdf section “4.4.2 Non-static Register
Information ”.</p>
<p>For some target architectures, some aspects of the target architecture’s
register set are dependent upon variable factors and have to be determined at
runtime.
As a consequence, they cannot be generated statically from a TableGen
description – although that would be possible for the bulk of them in the case
of the TriCore backend.
Among them are the following points:</p>
<ul class="simple">
<li>Callee-saved registers. Normally, the ABI specifies a set of registers that a
function must save on entry and restore on return if their contents are
possibly modified during execution.</li>
<li>Reserved registers. Although the set of unavailable registers is already
defined in the TableGen file, TriCoreRegisterInfo contains a method that marks
all non-allocatable register numbers in a bit vector.</li>
</ul>
<p>The following methods are implemented:</p>
<ul class="simple">
<li>emitPrologue() inserts prologue code at the beginning of a function. Thanks
to TriCore’s context model, this is a trivial task as it is not required to
save any registers manually. The only thing that has to be done is reserving
space for the function’s stack frame by decrementing the stack pointer.
In addition, if the function needs a frame pointer, the frame register %a14 is
set to the old value of the stack pointer beforehand.</li>
<li>emitEpilogue() is intended to emit instructions to destroy the stack frame
and restore all previously saved registers before returning from a function.
However, as %a10 (stack pointer), %a11 (return address), and %a14 (frame
pointer, if any) are all part of the upper context, no epilogue code is needed
at all. All cleanup operations are performed implicitly by the ret instruction.</li>
<li>eliminateFrameIndex() is called for each instruction that references a word
of data in a stack slot. All previous passes of the code generator have been
addressing stack slots through an abstract frame index and an immediate offset.
The purpose of this function is to translate such a reference into a
register–offset pair. Depending on whether the machine function that contains
the instruction has a fixed or a variable stack frame, either the stack pointer
%a10 or the frame pointer %a14 is used as the base register.
The offset is computed accordingly.
<a class="pageref" href="#backendstructure-f10">Figure  6</a> demonstrates for both cases how a stack slot
is addressed.</li>
</ul>
<p>If the addressing mode of the affected instruction cannot handle the address
because the offset is too large (the offset field has 10 bits for the BO
addressing mode and 16 bits for the BOL mode), a sequence of instructions is
emitted that explicitly computes the effective address.
Interim results are put into an unused address register.
If none is available, an already occupied address register is scavenged.
For this purpose, LLVM’s framework offers a class named RegScavenger that
takes care of all the details.</p>
<div class="figure align-center" id="backendstructure-f10">
<img alt="_images/10.png" src="_images/10.png" />
<p class="caption">Figure 6: Addressing of a variable a located on the stack.
If the stack frame has a variable size, slot must be addressed relative to
the frame pointer</p>
</div>
<p>We will explain the Prologue and Epilogue further by example code.</p>
<p>For the following llvm IR code of ch3.cpp, Cpu0 backend will emit the
corresponding machine instructions as follows,</p>
<div class="highlight-bash"><div class="highlight"><pre>define i32 @main<span class="o">()</span> nounwind uwtable <span class="o">{</span>
  %1 <span class="o">=</span> alloca i32, align 4
  store i32 0, i32* %1
  ret i32 0
<span class="o">}</span>

  .section .mdebug.abi32
  .previous
  .file <span class="s2">&quot;ch3.bc&quot;</span>
  .text
  .globl  main//static void expandLargeImm<span class="se">\\</span>n
  .align  2
  .type main,@function
  .ent  main                    <span class="c"># @main</span>
main:
  .cfi_startproc
  .frame  <span class="nv">$sp</span>,8,<span class="nv">$lr</span>
  .mask   0x00000000,0
  .set  noreorder
  .set  nomacro
<span class="c"># BB#0:</span>
  addiu <span class="nv">$sp</span>, <span class="nv">$sp</span>, -8
<span class="nv">$tmp1</span>:
  .cfi_def_cfa_offset 8
  addiu <span class="nv">$2</span>, <span class="nv">$zero</span>, 0
  st  <span class="nv">$2</span>, 4<span class="o">(</span><span class="nv">$sp</span><span class="o">)</span>
  addiu <span class="nv">$sp</span>, <span class="nv">$sp</span>, 8
  ret <span class="nv">$lr</span>
  .set  macro
  .set  reorder
  .end  main
<span class="nv">$tmp2</span>:
  .size main, <span class="o">(</span><span class="nv">$tmp2</span><span class="o">)</span>-main
  .cfi_endproc
</pre></div>
</div>
<p>LLVM get the stack size by parsing IRs and counting how many virtual registers
is assigned to local variables. After that, it calls emitPrologue().
This function will emit machine instructions to adjust sp (stack pointer
register) for local variables.
For our example, it will emit the instructions,</p>
<div class="highlight-c++"><div class="highlight"><pre>addiu $sp, $sp, -8
</pre></div>
</div>
<p>The  emitEpilogue will emit “addiu  $sp, $sp, 8”, where 8 is the stack size.</p>
<p>Since Instruction Selection and Register Allocation occurs before
Prologue/Epilogue Code Insertion, eliminateFrameIndex() is called after
instruction selection and register allocated.
It translates the frame index of local variable (%1 and %2 in the following
example) into stack offset according the frame index order upward (stack grow
up downward from high address to low address, 0($sp) is the top, 52($sp) is the
bottom) as follows,</p>
<div class="highlight-bash"><div class="highlight"><pre>define i32 @main<span class="o">()</span> nounwind uwtable <span class="o">{</span>
     %1 <span class="o">=</span> alloca i32, align 4
     %2 <span class="o">=</span> alloca i32, align 4
    ...
    store i32 0, i32* %1
    store i32 5, i32* %2, align 4
    ...
    ret i32 <span class="nv">0</span>

<span class="o">=</span>&gt; <span class="c"># BB#0:</span>
  addiu <span class="nv">$sp</span>, <span class="nv">$sp</span>, -56
<span class="nv">$tmp1</span>:
  addiu <span class="nv">$3</span>, <span class="nv">$zero</span>, 0
  st  <span class="nv">$3</span>, 52<span class="o">(</span><span class="nv">$sp</span><span class="o">)</span>   // %1 is the first frame index <span class="nb">local </span>variable, so allocate
                    // in 52<span class="o">(</span><span class="nv">$sp</span><span class="o">)</span>
  addiu <span class="nv">$2</span>, <span class="nv">$zero</span>, 5
  st  <span class="nv">$2</span>, 48<span class="o">(</span><span class="nv">$sp</span><span class="o">)</span>   // %2 is the second frame index <span class="nb">local </span>variable, so
                    // allocate in 48<span class="o">(</span><span class="nv">$sp</span><span class="o">)</span>
  ...
  ret <span class="nv">$lr</span>
</pre></div>
</div>
<p>The Prologue and Epilogue functions as follows,</p>
<p class="rubric">lbdex/chapters/Chapter3_5/Cpu0SEFrameLowering.h</p>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="kt">bool</span> <span class="n">hasReservedCallFrame</span><span class="p">(</span><span class="k">const</span> <span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">MF</span><span class="p">)</span> <span class="k">const</span> <span class="n">override</span><span class="p">;</span>

  <span class="kt">void</span> <span class="n">determineCalleeSaves</span><span class="p">(</span><span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">MF</span><span class="p">,</span> <span class="n">BitVector</span> <span class="o">&amp;</span><span class="n">SavedRegs</span><span class="p">,</span>
                            <span class="n">RegScavenger</span> <span class="o">*</span><span class="n">RS</span><span class="p">)</span> <span class="k">const</span> <span class="n">override</span><span class="p">;</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_5/Cpu0SEFrameLowering.cpp</p>
<p class="rubric">lbdex/chapters/Chapter3_5/Cpu0MachineFunction.h</p>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="kt">unsigned</span> <span class="n">getIncomingArgSize</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">IncomingArgSize</span><span class="p">;</span> <span class="p">}</span>

  <span class="kt">bool</span> <span class="n">callsEhReturn</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">CallsEhReturn</span><span class="p">;</span> <span class="p">}</span>

  <span class="kt">void</span> <span class="n">createEhDataRegsFI</span><span class="p">();</span>

  <span class="kt">unsigned</span> <span class="n">getMaxCallFrameSize</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">MaxCallFrameSize</span><span class="p">;</span> <span class="p">}</span>
  <span class="kt">void</span> <span class="n">setMaxCallFrameSize</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">S</span><span class="p">)</span> <span class="p">{</span> <span class="n">MaxCallFrameSize</span> <span class="o">=</span> <span class="n">S</span><span class="p">;</span> <span class="p">}</span>
</pre></div>
</div>
<p>After adding these Prologue and Epilogue functions, and build with Chapter3_5/.
Now we are ready to compile our example code ch3.bc and ouput cpu0 assembly as
follows,</p>
<div class="highlight-bash"><div class="highlight"><pre>118-165-78-12:input Jonathan<span class="nv">$ </span>/Users/Jonathan/llvm/test/cmake_debug_build/
Debug/bin/llc -march<span class="o">=</span>cpu0 -relocation-model<span class="o">=</span>pic -filetype<span class="o">=</span>asm -debug ch3.bc -o -
  ...
  .section .mdebug.abi32
  .previous
  .file <span class="s2">&quot;ch3.bc&quot;</span>
  .text
  .globl  main
  .align  2
  .type main,@function
  .ent  main                    <span class="c"># @main</span>
main:
  .cfi_startproc
  .frame  <span class="nv">$sp</span>,8,<span class="nv">$lr</span>
  .mask   0x00000000,0
  .set  noreorder
  .set  nomacro
<span class="c"># BB#0:</span>
  addiu <span class="nv">$sp</span>, <span class="nv">$sp</span>, -8
<span class="nv">$tmp1</span>:
  .cfi_def_cfa_offset 8
  addiu <span class="nv">$2</span>, <span class="nv">$zero</span>, 0
  st  <span class="nv">$2</span>, 4<span class="o">(</span><span class="nv">$sp</span><span class="o">)</span>
  addiu <span class="nv">$sp</span>, <span class="nv">$sp</span>, 8
  ret <span class="nv">$lr</span>
  .set  macro
  .set  reorder
  .end  main
<span class="nv">$tmp2</span>:
  .size main, <span class="o">(</span><span class="nv">$tmp2</span><span class="o">)</span>-main
  .cfi_endproc
</pre></div>
</div>
<p>To see how the <strong>&#8216;DAG-&gt;DAG Pattern Instruction Selection&#8217;</strong> work in llc, let&#8217;s
compile with <tt class="docutils literal"><span class="pre">llc</span> <span class="pre">-debug</span></tt> option and get the following result.
The DAGs which before and after instruction selection stage are shown as follows,</p>
<div class="highlight-bash"><div class="highlight"><pre>118-165-78-12:input Jonathan<span class="nv">$ </span>/Users/Jonathan/llvm/test/cmake_debug_build/
Debug/bin/llc -march<span class="o">=</span>cpu0 -relocation-model<span class="o">=</span>pic -filetype<span class="o">=</span>asm -debug ch3.bc -o -
Args: /Users/Jonathan/llvm/test/cmake_debug_build/Debug/bin/llc -march<span class="o">=</span>cpu0
-relocation-model<span class="o">=</span>pic -filetype<span class="o">=</span>asm -debug ch3.bc -o -
...
Optimized legalized selection DAG: BB#0 <span class="s1">&#39;main:&#39;</span>
SelectionDAG has 8 nodes:
  0x7fbe4082d010: <span class="nv">i32</span> <span class="o">=</span> Constant&lt;0&gt; <span class="o">[</span><span class="nv">ORD</span><span class="o">=</span>1<span class="o">]</span> <span class="o">[</span><span class="nv">ID</span><span class="o">=</span>1<span class="o">]</span>

  0x7fbe4082d410: <span class="nv">i32</span> <span class="o">=</span> Register %V0 <span class="o">[</span><span class="nv">ID</span><span class="o">=</span>4<span class="o">]</span>

      0x7fbe40410668: <span class="nv">ch</span> <span class="o">=</span> EntryToken <span class="o">[</span><span class="nv">ORD</span><span class="o">=</span>1<span class="o">]</span> <span class="o">[</span><span class="nv">ID</span><span class="o">=</span>0<span class="o">]</span>

      0x7fbe4082d010: &lt;multiple use&gt;
      0x7fbe4082d110: <span class="nv">i32</span> <span class="o">=</span> FrameIndex&lt;0&gt; <span class="o">[</span><span class="nv">ORD</span><span class="o">=</span>1<span class="o">]</span> <span class="o">[</span><span class="nv">ID</span><span class="o">=</span>2<span class="o">]</span>

      0x7fbe4082d210: <span class="nv">i32</span> <span class="o">=</span> undef <span class="o">[</span><span class="nv">ORD</span><span class="o">=</span>1<span class="o">]</span> <span class="o">[</span><span class="nv">ID</span><span class="o">=</span>3<span class="o">]</span>

    0x7fbe4082d310: <span class="nv">ch</span> <span class="o">=</span> store 0x7fbe40410668, 0x7fbe4082d010, 0x7fbe4082d110,
    0x7fbe4082d210&lt;ST4<span class="o">[</span>%1<span class="o">]</span>&gt; <span class="o">[</span><span class="nv">ORD</span><span class="o">=</span>1<span class="o">]</span> <span class="o">[</span><span class="nv">ID</span><span class="o">=</span>5<span class="o">]</span>

    0x7fbe4082d410: &lt;multiple use&gt;
    0x7fbe4082d010: &lt;multiple use&gt;
  0x7fbe4082d510: ch,glue <span class="o">=</span> CopyToReg 0x7fbe4082d310, 0x7fbe4082d410,
  0x7fbe4082d010 <span class="o">[</span><span class="nv">ID</span><span class="o">=</span>6<span class="o">]</span>

    0x7fbe4082d510: &lt;multiple use&gt;
    0x7fbe4082d410: &lt;multiple use&gt;
    0x7fbe4082d510: &lt;multiple use&gt;
  0x7fbe4082d610: <span class="nv">ch</span> <span class="o">=</span> Cpu0ISD::Ret 0x7fbe4082d510, 0x7fbe4082d410,
  0x7fbe4082d510:1 <span class="o">[</span><span class="nv">ID</span><span class="o">=</span>7<span class="o">]</span>


<span class="o">=====</span> Instruction selection begins: BB#0 <span class="s1">&#39;&#39;</span>
Selecting: 0x7fbe4082d610: <span class="nv">ch</span> <span class="o">=</span> Cpu0ISD::Ret 0x7fbe4082d510, 0x7fbe4082d410,
0x7fbe4082d510:1 <span class="o">[</span><span class="nv">ID</span><span class="o">=</span>7<span class="o">]</span>

ISEL: Starting pattern match on root node: 0x7fbe4082d610: <span class="nv">ch</span> <span class="o">=</span> Cpu0ISD::Ret
0x7fbe4082d510, 0x7fbe4082d410, 0x7fbe4082d510:1 <span class="o">[</span><span class="nv">ID</span><span class="o">=</span>7<span class="o">]</span>

  Morphed node: 0x7fbe4082d610: <span class="nv">ch</span> <span class="o">=</span> RET 0x7fbe4082d410, 0x7fbe4082d510,
  0x7fbe4082d510:1

ISEL: Match <span class="nb">complete</span>!
<span class="o">=</span>&gt; 0x7fbe4082d610: <span class="nv">ch</span> <span class="o">=</span> RET 0x7fbe4082d410, 0x7fbe4082d510, 0x7fbe4082d510:1

Selecting: 0x7fbe4082d510: ch,glue <span class="o">=</span> CopyToReg 0x7fbe4082d310, 0x7fbe4082d410,
0x7fbe4082d010 <span class="o">[</span><span class="nv">ID</span><span class="o">=</span>6<span class="o">]</span>

<span class="o">=</span>&gt; 0x7fbe4082d510: ch,glue <span class="o">=</span> CopyToReg 0x7fbe4082d310, 0x7fbe4082d410,
0x7fbe4082d010

Selecting: 0x7fbe4082d310: <span class="nv">ch</span> <span class="o">=</span> store 0x7fbe40410668, 0x7fbe4082d010,
0x7fbe4082d110, 0x7fbe4082d210&lt;ST4<span class="o">[</span>%1<span class="o">]</span>&gt; <span class="o">[</span><span class="nv">ORD</span><span class="o">=</span>1<span class="o">]</span> <span class="o">[</span><span class="nv">ID</span><span class="o">=</span>5<span class="o">]</span>

ISEL: Starting pattern match on root node: 0x7fbe4082d310: <span class="nv">ch</span> <span class="o">=</span> store 0x7fbe40410668,
0x7fbe4082d010, 0x7fbe4082d110, 0x7fbe4082d210&lt;ST4<span class="o">[</span>%1<span class="o">]</span>&gt; <span class="o">[</span><span class="nv">ORD</span><span class="o">=</span>1<span class="o">]</span> <span class="o">[</span><span class="nv">ID</span><span class="o">=</span>5<span class="o">]</span>

  Initial Opcode index to 166
  Morphed node: 0x7fbe4082d310: <span class="nv">ch</span> <span class="o">=</span> ST 0x7fbe4082d010, 0x7fbe4082d710,
  0x7fbe4082d810, 0x7fbe40410668&lt;Mem:ST4<span class="o">[</span>%1<span class="o">]</span>&gt; <span class="o">[</span><span class="nv">ORD</span><span class="o">=</span>1<span class="o">]</span>

ISEL: Match <span class="nb">complete</span>!
<span class="o">=</span>&gt; 0x7fbe4082d310: <span class="nv">ch</span> <span class="o">=</span> ST 0x7fbe4082d010, 0x7fbe4082d710, 0x7fbe4082d810,
0x7fbe40410668&lt;Mem:ST4<span class="o">[</span>%1<span class="o">]</span>&gt; <span class="o">[</span><span class="nv">ORD</span><span class="o">=</span>1<span class="o">]</span>

Selecting: 0x7fbe4082d410: <span class="nv">i32</span> <span class="o">=</span> Register %V0 <span class="o">[</span><span class="nv">ID</span><span class="o">=</span>4<span class="o">]</span>

<span class="o">=</span>&gt; 0x7fbe4082d410: <span class="nv">i32</span> <span class="o">=</span> Register %V0

Selecting: 0x7fbe4082d010: <span class="nv">i32</span> <span class="o">=</span> Constant&lt;0&gt; <span class="o">[</span><span class="nv">ORD</span><span class="o">=</span>1<span class="o">]</span> <span class="o">[</span><span class="nv">ID</span><span class="o">=</span>1<span class="o">]</span>

ISEL: Starting pattern match on root node: 0x7fbe4082d010: <span class="nv">i32</span> <span class="o">=</span>
Constant&lt;0&gt; <span class="o">[</span><span class="nv">ORD</span><span class="o">=</span>1<span class="o">]</span> <span class="o">[</span><span class="nv">ID</span><span class="o">=</span>1<span class="o">]</span>

  Initial Opcode index to 1201
  Morphed node: 0x7fbe4082d010: <span class="nv">i32</span> <span class="o">=</span> ADDiu 0x7fbe4082d110, 0x7fbe4082d810 <span class="o">[</span><span class="nv">ORD</span><span class="o">=</span>1<span class="o">]</span>

ISEL: Match <span class="nb">complete</span>!
<span class="o">=</span>&gt; 0x7fbe4082d010: <span class="nv">i32</span> <span class="o">=</span> ADDiu 0x7fbe4082d110, 0x7fbe4082d810 <span class="o">[</span><span class="nv">ORD</span><span class="o">=</span>1<span class="o">]</span>

Selecting: 0x7fbe40410668: <span class="nv">ch</span> <span class="o">=</span> EntryToken <span class="o">[</span><span class="nv">ORD</span><span class="o">=</span>1<span class="o">]</span> <span class="o">[</span><span class="nv">ID</span><span class="o">=</span>0<span class="o">]</span>

<span class="o">=</span>&gt; 0x7fbe40410668: <span class="nv">ch</span> <span class="o">=</span> EntryToken <span class="o">[</span><span class="nv">ORD</span><span class="o">=</span>1<span class="o">]</span>

<span class="o">=====</span> Instruction selection ends:
</pre></div>
</div>
<p>Summary above translation into Table: Chapter 3 .bc IR instructions.</p>
<table border="1" class="docutils">
<caption>Chapter 3 .bc IR instructions</caption>
<colgroup>
<col width="40%" />
<col width="47%" />
<col width="14%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">.bc</th>
<th class="head">Optimized legalized selection DAG</th>
<th class="head">Cpu0</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>constant 0</td>
<td>constant 0</td>
<td>addiu</td>
</tr>
<tr class="row-odd"><td>store</td>
<td>store</td>
<td>st</td>
</tr>
<tr class="row-even"><td>ret</td>
<td>Cpu0ISD::Ret</td>
<td>ret</td>
</tr>
</tbody>
</table>
<p>From above <tt class="docutils literal"><span class="pre">llc</span> <span class="pre">-debug</span></tt> display, we see the <strong>store</strong> and <strong>ret</strong> are
translated into <strong>store</strong> and <strong>Cpu0ISD::Ret</strong> in stage Optimized legalized
selection DAG, and then translated into Cpu0 instructions <strong>st</strong> and <strong>ret</strong>
finally.
Since store use <strong>constant 0</strong> (<strong>store i32 0, i32* %1</strong> in this example), the
constant 0 will be translated into <strong>&#8220;addiu $2, $zero, 0&#8221;</strong> via the following
pattern defined in Cpu0InstrInfo.td.</p>
<p class="rubric">lbdex/chapters/Chapter2/Cpu0InstrInfo.td</p>
<div class="highlight-c++"><div class="highlight"><pre>// Small immediates
def : Pat&lt;(i32 immSExt16:$in),
          (ADDiu ZERO, imm:$in)&gt;;
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_4/Cpu0InstrInfo.td</p>
<div class="highlight-c++"><div class="highlight"><pre>let Predicates = [Ch3_4] in {
def : Pat&lt;(i32 immZExt16:$in),
          (ORi ZERO, imm:$in)&gt;;
def : Pat&lt;(i32 immLow16Zero:$in),
          (LUi (HI16 imm:$in))&gt;;

// Arbitrary immediates
def : Pat&lt;(i32 imm:$imm),
          (ORi (LUi (HI16 imm:$imm)), (LO16 imm:$imm))&gt;;
} // let Predicates = [Ch3_4]
</pre></div>
</div>
<p>The ADDiu defined before ORi, so it takes the priority. Of course, if the ORi
is defined first, the it will translate into &#8220;ori&#8221; intruction.</p>
<p>At this point, we have translated the very simple main() function with
&#8220;return 0;&#8221; single instruction.
The Cpu0AnalyzeImmediate.cpp and the Cpu0InstrInfo.td instructions defined in
Chapter3_4, which take care the 32 bits stack size adjustments.</p>
<p>The Cpu0AnalyzeImmediate.cpp written in recursive with a little complicate in
logic. Anyway, the recursive
skills is used in the front end compile book, you should fimiliar with it.
Instead tracking the code, listing the stack size and the instructions
generated in &#8220;Table: Cpu0 stack adjustment instructions before replace addiu and
shl with lui instruction&#8221; as follows and &#8220;Table: Cpu0 stack adjustment
instructions after replace addiu and shl with lui instruction&#8221; at next,</p>
<table border="1" class="docutils">
<caption>Cpu0 stack adjustment instructions before replace addiu and shl with lui instruction</caption>
<colgroup>
<col width="19%" />
<col width="15%" />
<col width="33%" />
<col width="33%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">stack size range</th>
<th class="head">ex. stack size</th>
<th class="head">Cpu0 Prologue instructions</th>
<th class="head">Cpu0 Epilogue instructions</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>0 ~ 0x7ff8</td>
<td><ul class="first last simple">
<li>0x7ff8</li>
</ul>
</td>
<td><ul class="first last simple">
<li>addiu $sp, $sp, -32760;</li>
</ul>
</td>
<td><ul class="first last simple">
<li>addiu $sp, $sp, 32760;</li>
</ul>
</td>
</tr>
<tr class="row-odd"><td>0x8000 ~ 0xfff8</td>
<td><ul class="first last simple">
<li>0x8000</li>
</ul>
</td>
<td><ul class="first last simple">
<li>addiu $sp, $sp, -32768;</li>
</ul>
</td>
<td><ul class="first last simple">
<li>addiu $1, $zero, 1;</li>
<li>shl $1, $1, 16;</li>
<li>addiu $1, $1, -32768;</li>
<li>addu $sp, $sp, $1;</li>
</ul>
</td>
</tr>
<tr class="row-even"><td>x10000 ~ 0xfffffff8</td>
<td><ul class="first last simple">
<li>0x7ffffff8</li>
</ul>
</td>
<td><ul class="first last simple">
<li>addiu $1, $zero, 8;</li>
<li>shl $1, $1, 28;</li>
<li>addiu $1, $1, 8;</li>
<li>addu $sp, $sp, $1;</li>
</ul>
</td>
<td><ul class="first last simple">
<li>addiu $1, $zero, 8;</li>
<li>shl $1, $1, 28;</li>
<li>addiu $1, $1, -8;</li>
<li>addu $sp, $sp, $1;</li>
</ul>
</td>
</tr>
<tr class="row-odd"><td>x10000 ~ 0xfffffff8</td>
<td><ul class="first last simple">
<li>0x90008000</li>
</ul>
</td>
<td><ul class="first last simple">
<li>addiu $1, $zero, -9;</li>
<li>shl $1, $1, 28;</li>
<li>addiu $1, $1, -32768;</li>
<li>addu $sp, $sp, $1;</li>
</ul>
</td>
<td><ul class="first last simple">
<li>addiu $1, $zero, -28671;</li>
<li>shl $1, $1, 16</li>
<li>addiu $1, $1, -32768;</li>
<li>addu $sp, $sp, $1;</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>Since the Cpu0 stack is 8 bytes alignment, the 0x7ff9 to 0x7fff is impossible
existing.</p>
<p>Assume sp = 0xa0008000 and stack size = 0x90008000, then (0xa0008000 -
0x90008000) =&gt; 0x10000000. Verify with the Cpu0 Prologue instructions as
follows,</p>
<ol class="arabic simple">
<li>&#8220;addiu       $1, $zero, -9&#8221; =&gt; ($1 = 0 + 0xfffffff7) =&gt; $1 = 0xfffffff7.</li>
<li>&#8220;shl $1, $1, 28;&#8221; =&gt; $1 = 0x70000000.</li>
<li>&#8220;addiu       $1, $1, -32768&#8221; =&gt; $1 = (0x70000000 + 0xffff8000) =&gt; $1 = 0x6fff8000.</li>
<li>&#8220;addu        $sp, $sp, $1&#8221; =&gt; $sp = (0xa0008000 + 0x6fff8000) =&gt; $sp = 0x10000000.</li>
</ol>
<p>Verify with the Cpu0 Epilogue instructions with sp = 0x10000000 and stack size =
0x90008000 as follows,</p>
<ol class="arabic simple">
<li>&#8220;addiu       $1, $zero, -28671&#8221; =&gt; ($1 = 0 + 0xffff9001) =&gt; $1 = 0xffff9001.</li>
<li>&#8220;shl $1, $1, 16;&#8221; =&gt; $1 = 0x90010000.</li>
<li>&#8220;addiu       $1, $1, -32768&#8221; =&gt; $1 = (0x90010000 + 0xffff8000) =&gt; $1 = 0x90008000.</li>
<li>&#8220;addu        $sp, $sp, $1&#8221; =&gt; $sp = (0x10000000 + 0x90008000) =&gt; $sp = 0xa0008000.</li>
</ol>
<p>The Cpu0AnalyzeImmediate::GetShortestSeq() will call Cpu0AnalyzeImmediate::
ReplaceADDiuSHLWithLUi() to replace addiu and shl with single instruction lui
only. The effect as the following table.</p>
<table border="1" class="docutils">
<caption>Cpu0 stack adjustment instructions after replace addiu and shl with lui instruction</caption>
<colgroup>
<col width="19%" />
<col width="15%" />
<col width="33%" />
<col width="33%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">stack size range</th>
<th class="head">ex. stack size</th>
<th class="head">Cpu0 Prologue instructions</th>
<th class="head">Cpu0 Epilogue instructions</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>0x8000 ~ 0xfff8</td>
<td><ul class="first last simple">
<li>0x8000</li>
</ul>
</td>
<td><ul class="first last simple">
<li>addiu $sp, $sp, -32768;</li>
</ul>
</td>
<td><ul class="first last simple">
<li>ori     $1, $zero, 32768;</li>
<li>addu $sp, $sp, $1;</li>
</ul>
</td>
</tr>
<tr class="row-odd"><td>x10000 ~ 0xfffffff8</td>
<td><ul class="first last simple">
<li>0x7ffffff8</li>
</ul>
</td>
<td><ul class="first last simple">
<li>lui $1, 32768;</li>
<li>addiu $1, $1, 8;</li>
<li>addu $sp, $sp, $1;</li>
</ul>
</td>
<td><ul class="first last simple">
<li>lui     $1, 32767;</li>
<li>ori     $1, $1, 65528</li>
<li>addu $sp, $sp, $1;</li>
</ul>
</td>
</tr>
<tr class="row-even"><td>x10000 ~ 0xfffffff8</td>
<td><ul class="first last simple">
<li>0x90008000</li>
</ul>
</td>
<td><ul class="first last simple">
<li>lui $1, 28671;</li>
<li>ori $1, $1, 32768;</li>
<li>addu $sp, $sp, $1;</li>
</ul>
</td>
<td><ul class="first last simple">
<li>lui $1, 36865;</li>
<li>addiu $1, $1, -32768;</li>
<li>addu $sp, $sp, $1;</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>Assume sp = 0xa0008000 and stack size = 0x90008000, then (0xa0008000 -
0x90008000) =&gt; 0x10000000. Verify with the Cpu0 Prologue instructions as
follows,</p>
<ol class="arabic simple">
<li>&#8220;lui $1, 28671&#8221; =&gt; $1 = 0x6fff0000.</li>
<li>&#8220;ori $1, $1, 32768&#8221; =&gt; $1 = (0x6fff0000 + 0x00008000) =&gt; $1 = 0x6fff8000.</li>
<li>&#8220;addu        $sp, $sp, $1&#8221; =&gt; $sp = (0xa0008000 + 0x6fff8000) =&gt; $sp = 0x10000000.</li>
</ol>
<p>Verify with the Cpu0 Epilogue instructions with sp = 0x10000000 and stack size =
0x90008000 as follows,</p>
<ol class="arabic simple">
<li>&#8220;lui $1, 36865&#8221; =&gt; $1 = 0x90010000.</li>
<li>&#8220;addiu $1, $1, -32768&#8221; =&gt; $1 = (0x90010000 + 0xffff8000) =&gt; $1 = 0x90008000.</li>
<li>&#8220;addu $sp, $sp, $1&#8221; =&gt; $sp = (0x10000000 + 0x90008000) =&gt; $sp = 0xa0008000.</li>
</ol>
<p>File ch3-proepilog.ll include the large frame test.</p>
<p>Run Chapter3_5 with ch3_2.cpp will get the following result.</p>
<div class="highlight-bash"><div class="highlight"><pre>118-165-78-12:input Jonathan<span class="nv">$ </span>/Users/Jonathan/llvm/test/cmake_debug_build/
Debug/bin/llc -march<span class="o">=</span>cpu0 -relocation-model<span class="o">=</span>pic -filetype<span class="o">=</span>asm -debug ch3_2.bc
-o -
  ...
        .section .mdebug.abi32
        .previous
        .file <span class="s2">&quot;ch3_2.bc&quot;</span>
        .text
        .globl        main
        .align        2
        .type main,@function
        .ent  main                    <span class="c"># @main</span>
main:
        .frame        <span class="nv">$fp</span>,24,<span class="nv">$lr</span>
        .mask         0x00000000,0
        .set  noreorder
        .set  nomacro
<span class="c"># BB#0:</span>
        addiu <span class="nv">$sp</span>, <span class="nv">$sp</span>, -24
        addiu <span class="nv">$2</span>, <span class="nv">$zero</span>, 0
        st    <span class="nv">$2</span>, 20<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        addiu <span class="nv">$2</span>, <span class="nv">$zero</span>, 5
        st    <span class="nv">$2</span>, 16<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        addiu <span class="nv">$2</span>, <span class="nv">$zero</span>, 2
        st    <span class="nv">$2</span>, 12<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        ld    <span class="nv">$2</span>, 16<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        addiu <span class="nv">$2</span>, <span class="nv">$2</span>, 2
        st    <span class="nv">$2</span>, 8<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        ld    <span class="nv">$2</span>, 12<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
        addiu <span class="nv">$2</span>, <span class="nv">$2</span>, 1
        st    <span class="nv">$2</span>, 4<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span> // <span class="nv">$2</span> <span class="o">=</span> 3
        ld    <span class="nv">$3</span>, 8<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span> // <span class="nv">$3</span> <span class="o">=</span> 7
        addu  <span class="nv">$2</span>, <span class="nv">$3</span>, <span class="nv">$2</span> // <span class="nv">$2</span> <span class="o">=</span> 7+3
        addiu <span class="nv">$sp</span>, <span class="nv">$sp</span>, 24
        ret   <span class="nv">$lr</span>
        .set  macro
        .set  reorder
        .end  main
<span class="nv">$tmp1</span>:
        .size main, <span class="o">(</span><span class="nv">$tmp1</span><span class="o">)</span>-main
</pre></div>
</div>
</div>
<div class="section" id="data-operands-dags">
<h2><a class="toc-backref" href="#id10">Data operands DAGs</a><a class="headerlink" href="#data-operands-dags" title="Permalink to this headline">¶</a></h2>
<p>From above or compiler book, you can see all the OP code are the internal nodes
in DAGs graph, and operands are the leaf of DAGs.
To develop your backend, you can copy the
related data operands DAGs node from other backend since the IR data nodes are
take cared by all the backend.
About the data DAGs nodes, you can understand some of them through the
Cpu0InstrInfo.td and find it by grep -R &#8220;&lt;datadag&gt;&#8221;  `find src/include/llvm`
with spending a little more time to think or guess about it.
Some data DAGs we know more, some we know a little and some remains unknown but
it&#8217;s OK for us.
List some of data DAGs we understand and occured until now as follows,</p>
<p class="rubric">include/llvm/Target/TargetSelectionDAG.td</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">// PatLeaf&#39;s are pattern fragments that have no operands.  This is just a helper</span>
<span class="c1">// to define immediates and other common things concisely.</span>
<span class="k">class</span> <span class="nc">PatLeaf</span><span class="o">&lt;</span><span class="n">dag</span> <span class="n">frag</span><span class="p">,</span> <span class="n">code</span> <span class="n">pred</span> <span class="o">=</span> <span class="p">[{}],</span> <span class="n">SDNodeXForm</span> <span class="n">xform</span> <span class="o">=</span> <span class="n">NOOP_SDNodeXForm</span><span class="o">&gt;</span>
 <span class="o">:</span> <span class="n">PatFrag</span><span class="o">&lt;</span><span class="p">(</span><span class="n">ops</span><span class="p">),</span> <span class="n">frag</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">xform</span><span class="o">&gt;</span><span class="p">;</span>

<span class="c1">// ImmLeaf is a pattern fragment with a constraint on the immediate.  The</span>
<span class="c1">// constraint is a function that is run on the immediate (always with the value</span>
<span class="c1">// sign extended out to an int64_t) as Imm.  For example:</span>
<span class="c1">//</span>
<span class="c1">//  def immSExt8 : ImmLeaf&lt;i16, [{ return (char)Imm == Imm; }]&gt;;</span>
<span class="c1">//</span>
<span class="c1">// this is a more convenient form to match &#39;imm&#39; nodes in than PatLeaf and also</span>
<span class="c1">// is preferred over using PatLeaf because it allows the code generator to</span>
<span class="c1">// reason more about the constraint.</span>
<span class="c1">//</span>
<span class="c1">// If FastIsel should ignore all instructions that have an operand of this type,</span>
<span class="c1">// the FastIselShouldIgnore flag can be set.  This is an optimization to reduce</span>
<span class="c1">// the code size of the generated fast instruction selector.</span>
<span class="k">class</span> <span class="nc">ImmLeaf</span><span class="o">&lt;</span><span class="n">ValueType</span> <span class="n">vt</span><span class="p">,</span> <span class="n">code</span> <span class="n">pred</span><span class="p">,</span> <span class="n">SDNodeXForm</span> <span class="n">xform</span> <span class="o">=</span> <span class="n">NOOP_SDNodeXForm</span><span class="o">&gt;</span>
  <span class="o">:</span> <span class="n">PatFrag</span><span class="o">&lt;</span><span class="p">(</span><span class="n">ops</span><span class="p">),</span> <span class="p">(</span><span class="n">vt</span> <span class="n">imm</span><span class="p">),</span> <span class="p">[{}],</span> <span class="n">xform</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="n">let</span> <span class="n">ImmediateCode</span> <span class="o">=</span> <span class="n">pred</span><span class="p">;</span>
  <span class="n">bit</span> <span class="n">FastIselShouldIgnore</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_5/Cpu0InstrInfo.td</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">// Signed Operand</span>
<span class="n">def</span> <span class="n">simm16</span>      <span class="o">:</span> <span class="n">Operand</span><span class="o">&lt;</span><span class="n">i32</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="n">let</span> <span class="n">DecoderMethod</span><span class="o">=</span> <span class="s">&quot;DecodeSimm16&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">def</span> <span class="n">shamt</span>       <span class="o">:</span> <span class="n">Operand</span><span class="o">&lt;</span><span class="n">i32</span><span class="o">&gt;</span><span class="p">;</span>

<span class="c1">// Unsigned Operand</span>
<span class="n">def</span> <span class="n">uimm16</span>      <span class="o">:</span> <span class="n">Operand</span><span class="o">&lt;</span><span class="n">i32</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="n">let</span> <span class="n">PrintMethod</span> <span class="o">=</span> <span class="s">&quot;printUnsignedImm&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">// Address operand</span>
<span class="n">def</span> <span class="n">mem</span> <span class="o">:</span> <span class="n">Operand</span><span class="o">&lt;</span><span class="n">i32</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="n">let</span> <span class="n">PrintMethod</span> <span class="o">=</span> <span class="s">&quot;printMemOperand&quot;</span><span class="p">;</span>
  <span class="n">let</span> <span class="n">MIOperandInfo</span> <span class="o">=</span> <span class="p">(</span><span class="n">ops</span> <span class="n">CPURegs</span><span class="p">,</span> <span class="n">simm16</span><span class="p">);</span>
  <span class="n">let</span> <span class="n">EncoderMethod</span> <span class="o">=</span> <span class="s">&quot;getMemEncoding&quot;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="p">}</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">// Transformation Function - get the lower 16 bits.</span>
<span class="n">def</span> <span class="n">LO16</span> <span class="o">:</span> <span class="n">SDNodeXForm</span><span class="o">&lt;</span><span class="n">imm</span><span class="p">,</span> <span class="p">[{</span>
  <span class="k">return</span> <span class="n">getImm</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="o">-&gt;</span><span class="n">getZExtValue</span><span class="p">()</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
<span class="p">}]</span><span class="o">&gt;</span><span class="p">;</span>

<span class="c1">// Transformation Function - get the higher 16 bits.</span>
<span class="n">def</span> <span class="n">HI16</span> <span class="o">:</span> <span class="n">SDNodeXForm</span><span class="o">&lt;</span><span class="n">imm</span><span class="p">,</span> <span class="p">[{</span>
  <span class="k">return</span> <span class="n">getImm</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="p">(</span><span class="n">N</span><span class="o">-&gt;</span><span class="n">getZExtValue</span><span class="p">()</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
<span class="p">}]</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">// Node immediate fits as 16-bit sign extended on target immediate.</span>
<span class="c1">// e.g. addi, andi</span>
<span class="n">def</span> <span class="n">immSExt16</span>  <span class="o">:</span> <span class="n">PatLeaf</span><span class="o">&lt;</span><span class="p">(</span><span class="n">imm</span><span class="p">),</span> <span class="p">[{</span> <span class="k">return</span> <span class="n">isInt</span><span class="o">&lt;</span><span class="mi">16</span><span class="o">&gt;</span><span class="p">(</span><span class="n">N</span><span class="o">-&gt;</span><span class="n">getSExtValue</span><span class="p">());</span> <span class="p">}]</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">// Node immediate fits as 16-bit zero extended on target immediate.</span>
<span class="c1">// The LO16 param means that only the lower 16 bits of the node</span>
<span class="c1">// immediate are caught.</span>
<span class="c1">// e.g. addiu, sltiu</span>
<span class="n">def</span> <span class="n">immZExt16</span>  <span class="o">:</span> <span class="n">PatLeaf</span><span class="o">&lt;</span><span class="p">(</span><span class="n">imm</span><span class="p">),</span> <span class="p">[{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">N</span><span class="o">-&gt;</span><span class="n">getValueType</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">MVT</span><span class="o">::</span><span class="n">i32</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">N</span><span class="o">-&gt;</span><span class="n">getZExtValue</span><span class="p">()</span> <span class="o">==</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">N</span><span class="o">-&gt;</span><span class="n">getZExtValue</span><span class="p">();</span>
  <span class="k">else</span>
    <span class="nf">return</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">N</span><span class="o">-&gt;</span><span class="n">getZExtValue</span><span class="p">()</span> <span class="o">==</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">N</span><span class="o">-&gt;</span><span class="n">getZExtValue</span><span class="p">();</span>
<span class="p">}],</span> <span class="n">LO16</span><span class="o">&gt;</span><span class="p">;</span>

<span class="c1">// Immediate can be loaded with LUi (32-bit int with lower 16-bit cleared).</span>
<span class="n">def</span> <span class="n">immLow16Zero</span> <span class="o">:</span> <span class="n">PatLeaf</span><span class="o">&lt;</span><span class="p">(</span><span class="n">imm</span><span class="p">),</span> <span class="p">[{</span>
  <span class="kt">int64_t</span> <span class="n">Val</span> <span class="o">=</span> <span class="n">N</span><span class="o">-&gt;</span><span class="n">getSExtValue</span><span class="p">();</span>
  <span class="k">return</span> <span class="n">isInt</span><span class="o">&lt;</span><span class="mi">32</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Val</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">Val</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
<span class="p">}]</span><span class="o">&gt;</span><span class="p">;</span>

<span class="c1">// shamt field must fit in 5 bits.</span>
<span class="n">def</span> <span class="n">immZExt5</span> <span class="o">:</span> <span class="n">ImmLeaf</span><span class="o">&lt;</span><span class="n">i32</span><span class="p">,</span> <span class="p">[{</span><span class="k">return</span> <span class="n">Imm</span> <span class="o">==</span> <span class="p">(</span><span class="n">Imm</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">);}]</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>// Cpu0 Address Mode! SDNode frameindex could possibily be a match
// since load and store instructions from stack used it.
def addr : ComplexPattern&lt;iPTR, 2, &quot;SelectAddr&quot;, [frameindex], [SDNPWantParent]&gt;;

//===----------------------------------------------------------------------===//
// Pattern fragment for load/store
//===----------------------------------------------------------------------===//

class AlignedLoad&lt;PatFrag Node&gt; :
  PatFrag&lt;(ops node:$ptr), (Node node:$ptr), [{
  LoadSDNode *LD = cast&lt;LoadSDNode&gt;(N);
  return LD-&gt;getMemoryVT().getSizeInBits()/8 &lt;= LD-&gt;getAlignment();
}]&gt;;

class AlignedStore&lt;PatFrag Node&gt; :
  PatFrag&lt;(ops node:$val, node:$ptr), (Node node:$val, node:$ptr), [{
  StoreSDNode *SD = cast&lt;StoreSDNode&gt;(N);
  return SD-&gt;getMemoryVT().getSizeInBits()/8 &lt;= SD-&gt;getAlignment();
}]&gt;;
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">def</span> <span class="n">load_a</span>          <span class="o">:</span> <span class="n">AlignedLoad</span><span class="o">&lt;</span><span class="n">load</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">def</span> <span class="n">store_a</span>         <span class="o">:</span> <span class="n">AlignedStore</span><span class="o">&lt;</span><span class="n">store</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<p>As mentioned in sub-section &#8220;instruction selection&#8221; of last chapter,
immSExt16 is a data leaf DAG node and it will return true if its value is
in the range of signed 16 bits integer. The load_a, store_a and others are
similar but they check with alignment.</p>
<p>The mem is explained in chapter3_2 for print operand; addr is explained in
chapter3_3 for data DAG selection.
The simm16, ...,  inherited from Operand&lt;i32&gt; because Cpu0 is 32 bits.
It may over 16 bits, so immSExt16 pattern leaf is used to control it as example
ADDiu mention in last chapter.
PatLeaf immZExt16, immLow16Zero and ImmLeaf immZExt5 are similar to immSExt16.</p>
</div>
<div class="section" id="summary-of-this-chapter">
<h2><a class="toc-backref" href="#id11">Summary of this Chapter</a><a class="headerlink" href="#summary-of-this-chapter" title="Permalink to this headline">¶</a></h2>
<p>Summary the functions for llvm backend stages as the following table.</p>
<div class="highlight-bash"><div class="highlight"><pre>118-165-79-200:input Jonathan<span class="nv">$ </span>/Users/Jonathan/llvm/test/cmake_debug_build/
Debug/bin/llc -march<span class="o">=</span>cpu0 -relocation-model<span class="o">=</span>pic -filetype<span class="o">=</span>asm ch3.bc
-debug-pass<span class="o">=</span>Structure -o -
...
Machine Branch Probability Analysis
  ModulePass Manager
    FunctionPass Manager
      ...
      CPU0 DAG-&gt;DAG Pattern Instruction Selection
        Initial selection DAG
        Optimized lowered selection DAG
        Type-legalized selection DAG
        Optimized <span class="nb">type</span>-legalized selection DAG
        Legalized selection DAG
        Optimized legalized selection DAG
        Instruction selection
        Selected selection DAG
        Scheduling
      ...
      Greedy Register Allocator
      ...
      Post-RA pseudo instruction expansion pass
      ...
      Cpu0 Assembly Printer
</pre></div>
</div>
<table border="1" class="docutils">
<caption>Functions for llvm backend stage</caption>
<colgroup>
<col width="54%" />
<col width="46%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Stage</th>
<th class="head">Function</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Before CPU0 DAG-&gt;DAG Pattern Instruction Selection</td>
<td><ul class="first last simple">
<li>Cpu0TargetLowering::LowerFormalArguments</li>
<li>Cpu0TargetLowering::LowerReturn</li>
</ul>
</td>
</tr>
<tr class="row-odd"><td>Instruction selection</td>
<td><ul class="first last simple">
<li>Cpu0DAGToDAGISel::Select</li>
</ul>
</td>
</tr>
<tr class="row-even"><td>Prologue/Epilogue Insertion &amp; Frame Finalization</td>
<td><ul class="first last simple">
<li>Cpu0FrameLowering.cpp</li>
<li>Cpu0RegisterInfo::eliminateFrameIndex()</li>
</ul>
</td>
</tr>
<tr class="row-odd"><td>Cpu0 Assembly Printer</td>
<td><ul class="first last simple">
<li>Cpu0AsmPrinter.cpp, Cpu0MCInstLower.cpp</li>
<li>Cpu0InstPrinter.cpp</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>We add a pass in Instruction Section stage in section &#8220;Add Cpu0DAGToDAGISel
class&#8221;. You can embed your code into other pass like that. Please check
CodeGen/Passes.h for the information. Remember the pass is called according
the function unit as the <tt class="docutils literal"><span class="pre">llc</span> <span class="pre">-debug-pass=Structure</span></tt> indicated.</p>
<p>We have finished a simple assembler for cpu0 which only support <strong>ld</strong>,
<strong>st</strong>, <strong>addiu</strong>, <strong>ori</strong>, <strong>lui</strong>, <strong>addu</strong>, <strong>shl</strong> and <strong>ret</strong> 8
instructions.</p>
<p>We are satisfied with this result.
But you may think “After so many codes we program, and just get these 8
instructions!”.
The point is we have created a frame work for cpu0 target machine (please
look back the llvm back end structure class inheritance tree early in this
chapter).
Until now, we have over 3000 lines of source code with comments which include
files *.cpp, *.h, *.td, CMakeLists.txt and LLVMBuild.txt.
It can be counted by command <tt class="docutils literal"><span class="pre">wc</span> <span class="pre">`find</span> <span class="pre">dir</span> <span class="pre">-name</span> <span class="pre">*.cpp`</span></tt> for files *.cpp,
*.h, *.td, *.txt.
LLVM front end tutorial have 700 lines of source code without comments in total.
Don&#8217;t feel down with this result.
In reality, writing a back end is warm up slowly but run fastly.
Clang has over 500,000 lines of source code with comments in clang/lib
directory which include C++ and Obj C support.
Mips back end of llvm 3.1 has only 15,000 lines with comments.
Even the complicate X86 CPU which CISC outside and RISC inside (micro
instruction), has only 45,000 lines in llvm 3.1 with comments.
In next chapter, we will show you that add a new instruction support is as easy
as 123.</p>
<table class="docutils footnote" frame="void" id="id3" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td><a class="reference external" href="http://llvm.org/docs/WritingAnLLVMBackend.html#target-machine">http://llvm.org/docs/WritingAnLLVMBackend.html#target-machine</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id4" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td><a class="reference external" href="http://jonathan2251.github.io/lbd/llvmstructure.html#target-registration">http://jonathan2251.github.io/lbd/llvmstructure.html#target-registration</a></td></tr>
</tbody>
</table>
</div>
</div>


      </div>
      <div class="bottomnav">
      
        <p>
        «&#160;&#160;<a href="llvmstructure.html">Cpu0 architecture and LLVM structure</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="otherinst.html">Arithmetic and logic instructions</a>&#160;&#160;»
        </p>

      </div>

    <div class="footer">
        &copy; Copyright 2013, LLVM.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>