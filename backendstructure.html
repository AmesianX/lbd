<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Backend structure &mdash; Tutorial: Creating an LLVM Backend for the Cpu0 Architecture</title>
    
    <link rel="stylesheet" href="_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/print.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '3.7.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="_static/theme_extras.js"></script>
    <link rel="author" title="About these documents" href="about.html" />
    <link rel="top" title="Tutorial: Creating an LLVM Backend for the Cpu0 Architecture" href="index.html" />
    <link rel="next" title="Arithmetic and logic instructions" href="otherinst.html" />
    <link rel="prev" title="Cpu0 architecture and LLVM structure" href="llvmstructure.html" /> 
  </head>
  <body>
      <div class="header"><h1 class="heading"><a href="index.html">
          <span>Tutorial: Creating an LLVM Backend for the Cpu0 Architecture</span></a></h1>
        <h2 class="heading"><span>Backend structure</span></h2>
      </div>
      <div class="topnav">
      
        <p>
        «&#160;&#160;<a href="llvmstructure.html">Cpu0 architecture and LLVM structure</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="otherinst.html">Arithmetic and logic instructions</a>&#160;&#160;»
        </p>

      </div>
      <div class="content">
        
        
  <div class="section" id="backend-structure">
<span id="sec-backendstructure"></span><h1>Backend structure<a class="headerlink" href="#backend-structure" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#targetmachine-structure" id="id4">TargetMachine structure</a></li>
<li><a class="reference internal" href="#add-asmprinter" id="id5">Add AsmPrinter</a></li>
<li><a class="reference internal" href="#add-cpu0dagtodagisel-class" id="id6">Add Cpu0DAGToDAGISel class</a></li>
<li><a class="reference internal" href="#handle-return-register-lr" id="id7">Handle return register $lr</a></li>
<li><a class="reference internal" href="#add-prologue-epilogue-functions" id="id8">Add Prologue/Epilogue functions</a><ul>
<li><a class="reference internal" href="#concept" id="id9">Concept</a></li>
<li><a class="reference internal" href="#prologue-and-epilogue-functions" id="id10">Prologue and Epilogue functions</a></li>
<li><a class="reference internal" href="#handle-stack-slot-for-local-variables" id="id11">Handle stack slot for local variables</a></li>
<li><a class="reference internal" href="#large-stack" id="id12">Large stack</a></li>
</ul>
</li>
<li><a class="reference internal" href="#data-operands-dags" id="id13">Data operands DAGs</a></li>
<li><a class="reference internal" href="#summary-of-this-chapter" id="id14">Summary of this Chapter</a></li>
</ul>
</div>
<p>This chapter introduces the back end class inheritance tree and class members
first.
Next, following the back end structure, adding individual class implementation
in each section.
At the end of this chapter, we will have a back end to compile llvm
intermediate code into cpu0 assembly code.</p>
<p>Many code are added in this chapter. They almost are common in every back end
except the back end name (cpu0 or mips ...). Actually, we copy almost all the
code from mips and replace the name with cpu0. In addition to knowing the DAGs
pattern match in theoretic compiler and realistic llvm code generation phase,
please focus on the classes relationship in this backend structure.
Once knowing the structure, you can
create your backend structure as quickly as we did, even though there are 5000
lines of code around in this chapter.</p>
<div class="section" id="targetmachine-structure">
<h2><a class="toc-backref" href="#id4">TargetMachine structure</a><a class="headerlink" href="#targetmachine-structure" title="Permalink to this headline">¶</a></h2>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0TargetObjectFile.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">//===-- llvm/Target/Cpu0TargetObjectFile.h - Cpu0 Object Info ---*- C++ -*-===//</span>
<span class="c1">//</span>
<span class="c1">//                     The LLVM Compiler Infrastructure</span>
<span class="c1">//</span>
<span class="c1">// This file is distributed under the University of Illinois Open Source</span>
<span class="c1">// License. See LICENSE.TXT for details.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>

<span class="cp">#ifndef LLVM_LIB_TARGET_CPU0_CPU0TARGETOBJECTFILE_H</span>
<span class="cp">#define LLVM_LIB_TARGET_CPU0_CPU0TARGETOBJECTFILE_H</span>

<span class="cp">#include &quot;Cpu0Config.h&quot;</span>

<span class="cp">#include &quot;Cpu0TargetMachine.h&quot;</span>
<span class="cp">#include &quot;llvm/CodeGen/TargetLoweringObjectFileImpl.h&quot;</span>

<span class="k">namespace</span> <span class="n">llvm</span> <span class="p">{</span>
<span class="k">class</span> <span class="nc">Cpu0TargetMachine</span><span class="p">;</span>
  <span class="k">class</span> <span class="nc">Cpu0TargetObjectFile</span> <span class="o">:</span> <span class="k">public</span> <span class="n">TargetLoweringObjectFileELF</span> <span class="p">{</span>
    <span class="n">MCSection</span> <span class="o">*</span><span class="n">SmallDataSection</span><span class="p">;</span>
    <span class="n">MCSection</span> <span class="o">*</span><span class="n">SmallBSSSection</span><span class="p">;</span>
    <span class="k">const</span> <span class="n">Cpu0TargetMachine</span> <span class="o">*</span><span class="n">TM</span><span class="p">;</span>
  <span class="nl">public:</span>

    <span class="kt">void</span> <span class="n">Initialize</span><span class="p">(</span><span class="n">MCContext</span> <span class="o">&amp;</span><span class="n">Ctx</span><span class="p">,</span> <span class="k">const</span> <span class="n">TargetMachine</span> <span class="o">&amp;</span><span class="n">TM</span><span class="p">)</span> <span class="n">override</span><span class="p">;</span>

  <span class="p">};</span>
<span class="p">}</span> <span class="c1">// end namespace llvm</span>

<span class="cp">#endif</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0TargetObjectFile.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">//===-- Cpu0TargetObjectFile.cpp - Cpu0 Object Files ----------------------===//</span>
<span class="c1">//</span>
<span class="c1">//                     The LLVM Compiler Infrastructure</span>
<span class="c1">//</span>
<span class="c1">// This file is distributed under the University of Illinois Open Source</span>
<span class="c1">// License. See LICENSE.TXT for details.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>

<span class="cp">#include &quot;Cpu0TargetObjectFile.h&quot;</span>

<span class="cp">#include &quot;Cpu0Subtarget.h&quot;</span>
<span class="cp">#include &quot;Cpu0TargetMachine.h&quot;</span>
<span class="cp">#include &quot;llvm/IR/DataLayout.h&quot;</span>
<span class="cp">#include &quot;llvm/IR/DerivedTypes.h&quot;</span>
<span class="cp">#include &quot;llvm/IR/GlobalVariable.h&quot;</span>
<span class="cp">#include &quot;llvm/MC/MCContext.h&quot;</span>
<span class="cp">#include &quot;llvm/MC/MCSectionELF.h&quot;</span>
<span class="cp">#include &quot;llvm/Support/CommandLine.h&quot;</span>
<span class="cp">#include &quot;llvm/Support/ELF.h&quot;</span>
<span class="cp">#include &quot;llvm/Target/TargetMachine.h&quot;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">llvm</span><span class="p">;</span>

<span class="k">static</span> <span class="n">cl</span><span class="o">::</span><span class="n">opt</span><span class="o">&lt;</span><span class="kt">unsigned</span><span class="o">&gt;</span>
<span class="n">SSThreshold</span><span class="p">(</span><span class="s">&quot;cpu0-ssection-threshold&quot;</span><span class="p">,</span> <span class="n">cl</span><span class="o">::</span><span class="n">Hidden</span><span class="p">,</span>
            <span class="n">cl</span><span class="o">::</span><span class="n">desc</span><span class="p">(</span><span class="s">&quot;Small data and bss section threshold size (default=8)&quot;</span><span class="p">),</span>
            <span class="n">cl</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="mi">8</span><span class="p">));</span>

<span class="kt">void</span> <span class="n">Cpu0TargetObjectFile</span><span class="o">::</span><span class="n">Initialize</span><span class="p">(</span><span class="n">MCContext</span> <span class="o">&amp;</span><span class="n">Ctx</span><span class="p">,</span> <span class="k">const</span> <span class="n">TargetMachine</span> <span class="o">&amp;</span><span class="n">TM</span><span class="p">){</span>
  <span class="n">TargetLoweringObjectFileELF</span><span class="o">::</span><span class="n">Initialize</span><span class="p">(</span><span class="n">Ctx</span><span class="p">,</span> <span class="n">TM</span><span class="p">);</span>
  <span class="n">InitializeELF</span><span class="p">(</span><span class="n">TM</span><span class="p">.</span><span class="n">Options</span><span class="p">.</span><span class="n">UseInitArray</span><span class="p">);</span>

  <span class="n">SmallDataSection</span> <span class="o">=</span> <span class="n">getContext</span><span class="p">().</span><span class="n">getELFSection</span><span class="p">(</span>
      <span class="s">&quot;.sdata&quot;</span><span class="p">,</span> <span class="n">ELF</span><span class="o">::</span><span class="n">SHT_PROGBITS</span><span class="p">,</span> <span class="n">ELF</span><span class="o">::</span><span class="n">SHF_WRITE</span> <span class="o">|</span> <span class="n">ELF</span><span class="o">::</span><span class="n">SHF_ALLOC</span><span class="p">);</span>

  <span class="n">SmallBSSSection</span> <span class="o">=</span> <span class="n">getContext</span><span class="p">().</span><span class="n">getELFSection</span><span class="p">(</span><span class="s">&quot;.sbss&quot;</span><span class="p">,</span> <span class="n">ELF</span><span class="o">::</span><span class="n">SHT_NOBITS</span><span class="p">,</span>
                                               <span class="n">ELF</span><span class="o">::</span><span class="n">SHF_WRITE</span> <span class="o">|</span> <span class="n">ELF</span><span class="o">::</span><span class="n">SHF_ALLOC</span><span class="p">);</span>
  <span class="k">this</span><span class="o">-&gt;</span><span class="n">TM</span> <span class="o">=</span> <span class="o">&amp;</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">Cpu0TargetMachine</span> <span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">TM</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0TargetMachine.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">//===-- Cpu0TargetMachine.h - Define TargetMachine for Cpu0 -----*- C++ -*-===//</span>
<span class="c1">//</span>
<span class="c1">//                     The LLVM Compiler Infrastructure</span>
<span class="c1">//</span>
<span class="c1">// This file is distributed under the University of Illinois Open Source</span>
<span class="c1">// License. See LICENSE.TXT for details.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="c1">//</span>
<span class="c1">// This file declares the Cpu0 specific subclass of TargetMachine.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>

<span class="cp">#ifndef LLVM_LIB_TARGET_CPU0_CPU0TARGETMACHINE_H</span>
<span class="cp">#define LLVM_LIB_TARGET_CPU0_CPU0TARGETMACHINE_H</span>

<span class="cp">#include &quot;Cpu0Config.h&quot;</span>

<span class="cp">#include &quot;MCTargetDesc/Cpu0ABIInfo.h&quot;</span>
<span class="cp">#include &quot;Cpu0Subtarget.h&quot;</span>
<span class="cp">#include &quot;llvm/CodeGen/Passes.h&quot;</span>
<span class="cp">#include &quot;llvm/CodeGen/SelectionDAGISel.h&quot;</span>
<span class="cp">#include &quot;llvm/Target/TargetFrameLowering.h&quot;</span>
<span class="cp">#include &quot;llvm/Target/TargetMachine.h&quot;</span>

<span class="k">namespace</span> <span class="n">llvm</span> <span class="p">{</span>
<span class="k">class</span> <span class="nc">formatted_raw_ostream</span><span class="p">;</span>
<span class="k">class</span> <span class="nc">Cpu0RegisterInfo</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Cpu0TargetMachine</span> <span class="o">:</span> <span class="k">public</span> <span class="n">LLVMTargetMachine</span> <span class="p">{</span>
  <span class="kt">bool</span> <span class="n">isLittle</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">TargetLoweringObjectFile</span><span class="o">&gt;</span> <span class="n">TLOF</span><span class="p">;</span>
  <span class="c1">// Selected ABI</span>
  <span class="n">Cpu0ABIInfo</span> <span class="n">ABI</span><span class="p">;</span>
  <span class="n">Cpu0Subtarget</span> <span class="n">DefaultSubtarget</span><span class="p">;</span>

  <span class="k">mutable</span> <span class="n">StringMap</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">Cpu0Subtarget</span><span class="o">&gt;&gt;</span> <span class="n">SubtargetMap</span><span class="p">;</span>
<span class="nl">public:</span>
  <span class="n">Cpu0TargetMachine</span><span class="p">(</span><span class="k">const</span> <span class="n">Target</span> <span class="o">&amp;</span><span class="n">T</span><span class="p">,</span> <span class="k">const</span> <span class="n">Triple</span> <span class="o">&amp;</span><span class="n">TT</span><span class="p">,</span> <span class="n">StringRef</span> <span class="n">CPU</span><span class="p">,</span>
                    <span class="n">StringRef</span> <span class="n">FS</span><span class="p">,</span> <span class="k">const</span> <span class="n">TargetOptions</span> <span class="o">&amp;</span><span class="n">Options</span><span class="p">,</span> <span class="n">Reloc</span><span class="o">::</span><span class="n">Model</span> <span class="n">RM</span><span class="p">,</span>
                    <span class="n">CodeModel</span><span class="o">::</span><span class="n">Model</span> <span class="n">CM</span><span class="p">,</span> <span class="n">CodeGenOpt</span><span class="o">::</span><span class="n">Level</span> <span class="n">OL</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">isLittle</span><span class="p">);</span>
  <span class="o">~</span><span class="n">Cpu0TargetMachine</span><span class="p">()</span> <span class="n">override</span><span class="p">;</span>

  <span class="k">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">*</span><span class="n">getSubtargetImpl</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="n">DefaultSubtarget</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">*</span><span class="n">getSubtargetImpl</span><span class="p">(</span><span class="k">const</span> <span class="n">Function</span> <span class="o">&amp;</span><span class="n">F</span><span class="p">)</span> <span class="k">const</span> <span class="n">override</span><span class="p">;</span>

  <span class="c1">// Pass Pipeline Configuration</span>
  <span class="n">TargetPassConfig</span> <span class="o">*</span><span class="n">createPassConfig</span><span class="p">(</span><span class="n">PassManagerBase</span> <span class="o">&amp;</span><span class="n">PM</span><span class="p">)</span> <span class="n">override</span><span class="p">;</span>

  <span class="n">TargetLoweringObjectFile</span> <span class="o">*</span><span class="nf">getObjFileLowering</span><span class="p">()</span> <span class="k">const</span> <span class="n">override</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">TLOF</span><span class="p">.</span><span class="n">get</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="kt">bool</span> <span class="n">isLittleEndian</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">isLittle</span><span class="p">;</span> <span class="p">}</span>
  <span class="k">const</span> <span class="n">Cpu0ABIInfo</span> <span class="o">&amp;</span><span class="n">getABI</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">ABI</span><span class="p">;</span> <span class="p">}</span>
<span class="p">};</span>

<span class="c1">/// Cpu0ebTargetMachine - Cpu032 big endian target machine.</span>
<span class="c1">///</span>
<span class="k">class</span> <span class="nc">Cpu0ebTargetMachine</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Cpu0TargetMachine</span> <span class="p">{</span>
  <span class="k">virtual</span> <span class="kt">void</span> <span class="n">anchor</span><span class="p">();</span>
<span class="nl">public:</span>
  <span class="n">Cpu0ebTargetMachine</span><span class="p">(</span><span class="k">const</span> <span class="n">Target</span> <span class="o">&amp;</span><span class="n">T</span><span class="p">,</span> <span class="k">const</span> <span class="n">Triple</span> <span class="o">&amp;</span><span class="n">TT</span><span class="p">,</span> <span class="n">StringRef</span> <span class="n">CPU</span><span class="p">,</span>
                      <span class="n">StringRef</span> <span class="n">FS</span><span class="p">,</span> <span class="k">const</span> <span class="n">TargetOptions</span> <span class="o">&amp;</span><span class="n">Options</span><span class="p">,</span>
                      <span class="n">Reloc</span><span class="o">::</span><span class="n">Model</span> <span class="n">RM</span><span class="p">,</span> <span class="n">CodeModel</span><span class="o">::</span><span class="n">Model</span> <span class="n">CM</span><span class="p">,</span>
                      <span class="n">CodeGenOpt</span><span class="o">::</span><span class="n">Level</span> <span class="n">OL</span><span class="p">);</span>
<span class="p">};</span>

<span class="c1">/// Cpu0elTargetMachine - Cpu032 little endian target machine.</span>
<span class="c1">///</span>
<span class="k">class</span> <span class="nc">Cpu0elTargetMachine</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Cpu0TargetMachine</span> <span class="p">{</span>
  <span class="k">virtual</span> <span class="kt">void</span> <span class="n">anchor</span><span class="p">();</span>
<span class="nl">public:</span>
  <span class="n">Cpu0elTargetMachine</span><span class="p">(</span><span class="k">const</span> <span class="n">Target</span> <span class="o">&amp;</span><span class="n">T</span><span class="p">,</span> <span class="k">const</span> <span class="n">Triple</span> <span class="o">&amp;</span><span class="n">TT</span><span class="p">,</span> <span class="n">StringRef</span> <span class="n">CPU</span><span class="p">,</span>
                      <span class="n">StringRef</span> <span class="n">FS</span><span class="p">,</span> <span class="k">const</span> <span class="n">TargetOptions</span> <span class="o">&amp;</span><span class="n">Options</span><span class="p">,</span>
                      <span class="n">Reloc</span><span class="o">::</span><span class="n">Model</span> <span class="n">RM</span><span class="p">,</span> <span class="n">CodeModel</span><span class="o">::</span><span class="n">Model</span> <span class="n">CM</span><span class="p">,</span>
                      <span class="n">CodeGenOpt</span><span class="o">::</span><span class="n">Level</span> <span class="n">OL</span><span class="p">);</span>
<span class="p">};</span>
<span class="p">}</span> <span class="c1">// End llvm namespace</span>

<span class="cp">#endif</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0TargetMachine.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">//===-- Cpu0TargetMachine.cpp - Define TargetMachine for Cpu0 -------------===//</span>
<span class="c1">//</span>
<span class="c1">//                     The LLVM Compiler Infrastructure</span>
<span class="c1">//</span>
<span class="c1">// This file is distributed under the University of Illinois Open Source</span>
<span class="c1">// License. See LICENSE.TXT for details.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="c1">//</span>
<span class="c1">// Implements the info about Cpu0 target spec.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>

<span class="cp">#include &quot;Cpu0TargetMachine.h&quot;</span>
<span class="cp">#include &quot;Cpu0.h&quot;</span>

<span class="cp">#include &quot;Cpu0Subtarget.h&quot;</span>
<span class="cp">#include &quot;Cpu0TargetObjectFile.h&quot;</span>
<span class="cp">#include &quot;llvm/IR/LegacyPassManager.h&quot;</span>
<span class="cp">#include &quot;llvm/CodeGen/Passes.h&quot;</span>
<span class="cp">#include &quot;llvm/Support/TargetRegistry.h&quot;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">llvm</span><span class="p">;</span>

<span class="cp">#define DEBUG_TYPE &quot;cpu0&quot;</span>

<span class="k">extern</span> <span class="s">&quot;C&quot;</span> <span class="kt">void</span> <span class="n">LLVMInitializeCpu0Target</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// Register the target.</span>
  <span class="c1">//- Big endian Target Machine</span>
  <span class="n">RegisterTargetMachine</span><span class="o">&lt;</span><span class="n">Cpu0ebTargetMachine</span><span class="o">&gt;</span> <span class="n">X</span><span class="p">(</span><span class="n">TheCpu0Target</span><span class="p">);</span>
  <span class="c1">//- Little endian Target Machine</span>
  <span class="n">RegisterTargetMachine</span><span class="o">&lt;</span><span class="n">Cpu0elTargetMachine</span><span class="o">&gt;</span> <span class="n">Y</span><span class="p">(</span><span class="n">TheCpu0elTarget</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">computeDataLayout</span><span class="p">(</span><span class="k">const</span> <span class="n">Triple</span> <span class="o">&amp;</span><span class="n">TT</span><span class="p">,</span> <span class="n">StringRef</span> <span class="n">CPU</span><span class="p">,</span>
                                     <span class="k">const</span> <span class="n">TargetOptions</span> <span class="o">&amp;</span><span class="n">Options</span><span class="p">,</span>
                                     <span class="kt">bool</span> <span class="n">isLittle</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">Ret</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
  <span class="c1">// There are both little and big endian cpu0.</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">isLittle</span><span class="p">)</span>
    <span class="n">Ret</span> <span class="o">+=</span> <span class="s">&quot;e&quot;</span><span class="p">;</span>
  <span class="k">else</span>
    <span class="n">Ret</span> <span class="o">+=</span> <span class="s">&quot;E&quot;</span><span class="p">;</span>

  <span class="n">Ret</span> <span class="o">+=</span> <span class="s">&quot;-m:m&quot;</span><span class="p">;</span>

  <span class="c1">// Pointers are 32 bit on some ABIs.</span>
  <span class="n">Ret</span> <span class="o">+=</span> <span class="s">&quot;-p:32:32&quot;</span><span class="p">;</span>

  <span class="c1">// 8 and 16 bit integers only need to have natural alignment, but try to</span>
  <span class="c1">// align them to 32 bits. 64 bit integers have natural alignment.</span>
  <span class="n">Ret</span> <span class="o">+=</span> <span class="s">&quot;-i8:8:32-i16:16:32-i64:64&quot;</span><span class="p">;</span>

  <span class="c1">// 32 bit registers are always available and the stack is at least 64 bit</span>
  <span class="c1">// aligned.</span>
  <span class="n">Ret</span> <span class="o">+=</span> <span class="s">&quot;-n32-S64&quot;</span><span class="p">;</span>

  <span class="k">return</span> <span class="n">Ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// DataLayout --&gt; Big-endian, 32-bit pointer/ABI/alignment</span>
<span class="c1">// The stack is always 8 byte aligned</span>
<span class="c1">// On function prologue, the stack is created by decrementing</span>
<span class="c1">// its pointer. Once decremented, all references are done with positive</span>
<span class="c1">// offset from the stack/frame pointer, using StackGrowsUp enables</span>
<span class="c1">// an easier handling.</span>
<span class="c1">// Using CodeModel::Large enables different CALL behavior.</span>
<span class="n">Cpu0TargetMachine</span><span class="o">::</span><span class="n">Cpu0TargetMachine</span><span class="p">(</span><span class="k">const</span> <span class="n">Target</span> <span class="o">&amp;</span><span class="n">T</span><span class="p">,</span> <span class="k">const</span> <span class="n">Triple</span> <span class="o">&amp;</span><span class="n">TT</span><span class="p">,</span>
                                     <span class="n">StringRef</span> <span class="n">CPU</span><span class="p">,</span> <span class="n">StringRef</span> <span class="n">FS</span><span class="p">,</span>
                                     <span class="k">const</span> <span class="n">TargetOptions</span> <span class="o">&amp;</span><span class="n">Options</span><span class="p">,</span>
                                     <span class="n">Reloc</span><span class="o">::</span><span class="n">Model</span> <span class="n">RM</span><span class="p">,</span> <span class="n">CodeModel</span><span class="o">::</span><span class="n">Model</span> <span class="n">CM</span><span class="p">,</span>
                                     <span class="n">CodeGenOpt</span><span class="o">::</span><span class="n">Level</span> <span class="n">OL</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">isLittle</span><span class="p">)</span>
  <span class="c1">//- Default is big endian</span>
    <span class="o">:</span> <span class="n">LLVMTargetMachine</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">computeDataLayout</span><span class="p">(</span><span class="n">TT</span><span class="p">,</span> <span class="n">CPU</span><span class="p">,</span> <span class="n">Options</span><span class="p">,</span> <span class="n">isLittle</span><span class="p">),</span> <span class="n">TT</span><span class="p">,</span>
                        <span class="n">CPU</span><span class="p">,</span> <span class="n">FS</span><span class="p">,</span> <span class="n">Options</span><span class="p">,</span> <span class="n">RM</span><span class="p">,</span> <span class="n">CM</span><span class="p">,</span> <span class="n">OL</span><span class="p">),</span>
      <span class="n">isLittle</span><span class="p">(</span><span class="n">isLittle</span><span class="p">),</span> <span class="n">TLOF</span><span class="p">(</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">Cpu0TargetObjectFile</span><span class="o">&gt;</span><span class="p">()),</span>
      <span class="n">ABI</span><span class="p">(</span><span class="n">Cpu0ABIInfo</span><span class="o">::</span><span class="n">computeTargetABI</span><span class="p">()),</span>
      <span class="n">DefaultSubtarget</span><span class="p">(</span><span class="n">TT</span><span class="p">,</span> <span class="n">CPU</span><span class="p">,</span> <span class="n">FS</span><span class="p">,</span> <span class="n">isLittle</span><span class="p">,</span> <span class="o">*</span><span class="k">this</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// initAsmInfo will display features by llc -march=cpu0 -mcpu=help on 3.7 but</span>
  <span class="c1">// not on 3.6</span>
  <span class="n">initAsmInfo</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">Cpu0TargetMachine</span><span class="o">::~</span><span class="n">Cpu0TargetMachine</span><span class="p">()</span> <span class="p">{}</span>

<span class="kt">void</span> <span class="n">Cpu0ebTargetMachine</span><span class="o">::</span><span class="n">anchor</span><span class="p">()</span> <span class="p">{</span> <span class="p">}</span>

<span class="n">Cpu0ebTargetMachine</span><span class="o">::</span><span class="n">Cpu0ebTargetMachine</span><span class="p">(</span><span class="k">const</span> <span class="n">Target</span> <span class="o">&amp;</span><span class="n">T</span><span class="p">,</span> <span class="k">const</span> <span class="n">Triple</span> <span class="o">&amp;</span><span class="n">TT</span><span class="p">,</span>
                                         <span class="n">StringRef</span> <span class="n">CPU</span><span class="p">,</span> <span class="n">StringRef</span> <span class="n">FS</span><span class="p">,</span>
                                         <span class="k">const</span> <span class="n">TargetOptions</span> <span class="o">&amp;</span><span class="n">Options</span><span class="p">,</span>
                                         <span class="n">Reloc</span><span class="o">::</span><span class="n">Model</span> <span class="n">RM</span><span class="p">,</span> <span class="n">CodeModel</span><span class="o">::</span><span class="n">Model</span> <span class="n">CM</span><span class="p">,</span>
                                         <span class="n">CodeGenOpt</span><span class="o">::</span><span class="n">Level</span> <span class="n">OL</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">Cpu0TargetMachine</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">TT</span><span class="p">,</span> <span class="n">CPU</span><span class="p">,</span> <span class="n">FS</span><span class="p">,</span> <span class="n">Options</span><span class="p">,</span> <span class="n">RM</span><span class="p">,</span> <span class="n">CM</span><span class="p">,</span> <span class="n">OL</span><span class="p">,</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{}</span>

<span class="kt">void</span> <span class="n">Cpu0elTargetMachine</span><span class="o">::</span><span class="n">anchor</span><span class="p">()</span> <span class="p">{</span> <span class="p">}</span>

<span class="n">Cpu0elTargetMachine</span><span class="o">::</span><span class="n">Cpu0elTargetMachine</span><span class="p">(</span><span class="k">const</span> <span class="n">Target</span> <span class="o">&amp;</span><span class="n">T</span><span class="p">,</span> <span class="k">const</span> <span class="n">Triple</span> <span class="o">&amp;</span><span class="n">TT</span><span class="p">,</span>
                                         <span class="n">StringRef</span> <span class="n">CPU</span><span class="p">,</span> <span class="n">StringRef</span> <span class="n">FS</span><span class="p">,</span>
                                         <span class="k">const</span> <span class="n">TargetOptions</span> <span class="o">&amp;</span><span class="n">Options</span><span class="p">,</span>
                                         <span class="n">Reloc</span><span class="o">::</span><span class="n">Model</span> <span class="n">RM</span><span class="p">,</span> <span class="n">CodeModel</span><span class="o">::</span><span class="n">Model</span> <span class="n">CM</span><span class="p">,</span>
                                         <span class="n">CodeGenOpt</span><span class="o">::</span><span class="n">Level</span> <span class="n">OL</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">Cpu0TargetMachine</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">TT</span><span class="p">,</span> <span class="n">CPU</span><span class="p">,</span> <span class="n">FS</span><span class="p">,</span> <span class="n">Options</span><span class="p">,</span> <span class="n">RM</span><span class="p">,</span> <span class="n">CM</span><span class="p">,</span> <span class="n">OL</span><span class="p">,</span> <span class="nb">true</span><span class="p">)</span> <span class="p">{}</span>

<span class="k">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">*</span>
<span class="n">Cpu0TargetMachine</span><span class="o">::</span><span class="n">getSubtargetImpl</span><span class="p">(</span><span class="k">const</span> <span class="n">Function</span> <span class="o">&amp;</span><span class="n">F</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="n">Attribute</span> <span class="n">CPUAttr</span> <span class="o">=</span> <span class="n">F</span><span class="p">.</span><span class="n">getFnAttribute</span><span class="p">(</span><span class="s">&quot;target-cpu&quot;</span><span class="p">);</span>
  <span class="n">Attribute</span> <span class="n">FSAttr</span> <span class="o">=</span> <span class="n">F</span><span class="p">.</span><span class="n">getFnAttribute</span><span class="p">(</span><span class="s">&quot;target-features&quot;</span><span class="p">);</span>

  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">CPU</span> <span class="o">=</span> <span class="o">!</span><span class="n">CPUAttr</span><span class="p">.</span><span class="n">hasAttribute</span><span class="p">(</span><span class="n">Attribute</span><span class="o">::</span><span class="n">None</span><span class="p">)</span>
                        <span class="o">?</span> <span class="n">CPUAttr</span><span class="p">.</span><span class="n">getValueAsString</span><span class="p">().</span><span class="n">str</span><span class="p">()</span>
                        <span class="o">:</span> <span class="n">TargetCPU</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">FS</span> <span class="o">=</span> <span class="o">!</span><span class="n">FSAttr</span><span class="p">.</span><span class="n">hasAttribute</span><span class="p">(</span><span class="n">Attribute</span><span class="o">::</span><span class="n">None</span><span class="p">)</span>
                       <span class="o">?</span> <span class="n">FSAttr</span><span class="p">.</span><span class="n">getValueAsString</span><span class="p">().</span><span class="n">str</span><span class="p">()</span>
                       <span class="o">:</span> <span class="n">TargetFS</span><span class="p">;</span>

  <span class="k">auto</span> <span class="o">&amp;</span><span class="n">I</span> <span class="o">=</span> <span class="n">SubtargetMap</span><span class="p">[</span><span class="n">CPU</span> <span class="o">+</span> <span class="n">FS</span><span class="p">];</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">I</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// This needs to be done before we create a new subtarget since any</span>
    <span class="c1">// creation will depend on the TM and the code generation flags on the</span>
    <span class="c1">// function that reside in TargetOptions.</span>
    <span class="n">resetTargetOptions</span><span class="p">(</span><span class="n">F</span><span class="p">);</span>
    <span class="n">I</span> <span class="o">=</span> <span class="n">llvm</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">Cpu0Subtarget</span><span class="o">&gt;</span><span class="p">(</span><span class="n">TargetTriple</span><span class="p">,</span> <span class="n">CPU</span><span class="p">,</span> <span class="n">FS</span><span class="p">,</span> <span class="n">isLittle</span><span class="p">,</span>
                                         <span class="o">*</span><span class="k">this</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">I</span><span class="p">.</span><span class="n">get</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">namespace</span> <span class="p">{</span>
<span class="c1">//@Cpu0PassConfig {</span>
<span class="c1">/// Cpu0 Code Generator Pass Configuration Options.</span>
<span class="k">class</span> <span class="nc">Cpu0PassConfig</span> <span class="o">:</span> <span class="k">public</span> <span class="n">TargetPassConfig</span> <span class="p">{</span>
<span class="nl">public:</span>
  <span class="n">Cpu0PassConfig</span><span class="p">(</span><span class="n">Cpu0TargetMachine</span> <span class="o">*</span><span class="n">TM</span><span class="p">,</span> <span class="n">PassManagerBase</span> <span class="o">&amp;</span><span class="n">PM</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">TargetPassConfig</span><span class="p">(</span><span class="n">TM</span><span class="p">,</span> <span class="n">PM</span><span class="p">)</span> <span class="p">{}</span>

  <span class="n">Cpu0TargetMachine</span> <span class="o">&amp;</span><span class="n">getCpu0TargetMachine</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">getTM</span><span class="o">&lt;</span><span class="n">Cpu0TargetMachine</span><span class="o">&gt;</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">getCpu0Subtarget</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">*</span><span class="n">getCpu0TargetMachine</span><span class="p">().</span><span class="n">getSubtargetImpl</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">};</span>
<span class="p">}</span> <span class="c1">// namespace</span>

<span class="n">TargetPassConfig</span> <span class="o">*</span><span class="n">Cpu0TargetMachine</span><span class="o">::</span><span class="n">createPassConfig</span><span class="p">(</span><span class="n">PassManagerBase</span> <span class="o">&amp;</span><span class="n">PM</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="n">Cpu0PassConfig</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">PM</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">include/llvm/Target/TargetInstInfo.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="k">class</span> <span class="nc">TargetInstrInfo</span> <span class="o">:</span> <span class="k">public</span> <span class="n">MCInstrInfo</span> <span class="p">{</span>
  <span class="n">TargetInstrInfo</span><span class="p">(</span><span class="k">const</span> <span class="n">TargetInstrInfo</span> <span class="o">&amp;</span><span class="p">)</span> <span class="o">=</span> <span class="k">delete</span><span class="p">;</span>
  <span class="kt">void</span> <span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="k">const</span> <span class="n">TargetInstrInfo</span> <span class="o">&amp;</span><span class="p">)</span> <span class="o">=</span> <span class="k">delete</span><span class="p">;</span>
<span class="nl">public:</span>
  <span class="p">...</span>
<span class="p">}</span>
<span class="p">...</span>
<span class="k">class</span> <span class="nc">TargetInstrInfoImpl</span> <span class="o">:</span> <span class="k">public</span> <span class="n">TargetInstrInfo</span> <span class="p">{</span>
<span class="nl">protected:</span>
  <span class="n">TargetInstrInfoImpl</span><span class="p">(</span><span class="kt">int</span> <span class="n">CallFrameSetupOpcode</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
            <span class="kt">int</span> <span class="n">CallFrameDestroyOpcode</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
  <span class="o">:</span> <span class="n">TargetInstrInfo</span><span class="p">(</span><span class="n">CallFrameSetupOpcode</span><span class="p">,</span> <span class="n">CallFrameDestroyOpcode</span><span class="p">)</span> <span class="p">{}</span>
<span class="nl">public:</span>
  <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0.td</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">include</span> <span class="s">&quot;Cpu0CallingConv.td&quot;</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">// Without this will have error: &#39;cpu032I&#39; is not a recognized processor for </span>
<span class="c1">//  this target (ignoring processor)</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="c1">// Cpu0 Subtarget features                                                    //</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>


<span class="n">def</span> <span class="n">FeatureChapter3_1</span>  <span class="o">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s">&quot;ch3_1&quot;</span><span class="p">,</span> <span class="s">&quot;HasChapterDummy&quot;</span><span class="p">,</span> <span class="s">&quot;true&quot;</span><span class="p">,</span>
                                <span class="s">&quot;Enable Chapter instructions.&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">FeatureChapter3_2</span>  <span class="o">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s">&quot;ch3_2&quot;</span><span class="p">,</span> <span class="s">&quot;HasChapterDummy&quot;</span><span class="p">,</span> <span class="s">&quot;true&quot;</span><span class="p">,</span>
                                <span class="s">&quot;Enable Chapter instructions.&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">FeatureChapter3_3</span>  <span class="o">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s">&quot;ch3_3&quot;</span><span class="p">,</span> <span class="s">&quot;HasChapterDummy&quot;</span><span class="p">,</span> <span class="s">&quot;true&quot;</span><span class="p">,</span>
                                <span class="s">&quot;Enable Chapter instructions.&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">FeatureChapter3_4</span>  <span class="o">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s">&quot;ch3_4&quot;</span><span class="p">,</span> <span class="s">&quot;HasChapterDummy&quot;</span><span class="p">,</span> <span class="s">&quot;true&quot;</span><span class="p">,</span>
                                <span class="s">&quot;Enable Chapter instructions.&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">FeatureChapter3_5</span>  <span class="o">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s">&quot;ch3_5&quot;</span><span class="p">,</span> <span class="s">&quot;HasChapterDummy&quot;</span><span class="p">,</span> <span class="s">&quot;true&quot;</span><span class="p">,</span>
                                <span class="s">&quot;Enable Chapter instructions.&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">FeatureChapter4_1</span>  <span class="o">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s">&quot;ch4_1&quot;</span><span class="p">,</span> <span class="s">&quot;HasChapterDummy&quot;</span><span class="p">,</span> <span class="s">&quot;true&quot;</span><span class="p">,</span>
                                <span class="s">&quot;Enable Chapter instructions.&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">FeatureChapter4_2</span>  <span class="o">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s">&quot;ch4_2&quot;</span><span class="p">,</span> <span class="s">&quot;HasChapterDummy&quot;</span><span class="p">,</span> <span class="s">&quot;true&quot;</span><span class="p">,</span>
                                <span class="s">&quot;Enable Chapter instructions.&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">FeatureChapter5_1</span>  <span class="o">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s">&quot;ch5_1&quot;</span><span class="p">,</span> <span class="s">&quot;HasChapterDummy&quot;</span><span class="p">,</span> <span class="s">&quot;true&quot;</span><span class="p">,</span>
                                <span class="s">&quot;Enable Chapter instructions.&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">FeatureChapter6_1</span>  <span class="o">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s">&quot;ch6_1&quot;</span><span class="p">,</span> <span class="s">&quot;HasChapterDummy&quot;</span><span class="p">,</span> <span class="s">&quot;true&quot;</span><span class="p">,</span>
                                <span class="s">&quot;Enable Chapter instructions.&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">FeatureChapter7_1</span>  <span class="o">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s">&quot;ch7_1&quot;</span><span class="p">,</span> <span class="s">&quot;HasChapterDummy&quot;</span><span class="p">,</span> <span class="s">&quot;true&quot;</span><span class="p">,</span>
                                <span class="s">&quot;Enable Chapter instructions.&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">FeatureChapter8_1</span>  <span class="o">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s">&quot;ch8_1&quot;</span><span class="p">,</span> <span class="s">&quot;HasChapterDummy&quot;</span><span class="p">,</span> <span class="s">&quot;true&quot;</span><span class="p">,</span>
                                <span class="s">&quot;Enable Chapter instructions.&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">FeatureChapter8_2</span>  <span class="o">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s">&quot;ch8_2&quot;</span><span class="p">,</span> <span class="s">&quot;HasChapterDummy&quot;</span><span class="p">,</span> <span class="s">&quot;true&quot;</span><span class="p">,</span>
                                <span class="s">&quot;Enable Chapter instructions.&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">FeatureChapter9_1</span>  <span class="o">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s">&quot;ch9_1&quot;</span><span class="p">,</span> <span class="s">&quot;HasChapterDummy&quot;</span><span class="p">,</span> <span class="s">&quot;true&quot;</span><span class="p">,</span>
                                <span class="s">&quot;Enable Chapter instructions.&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">FeatureChapter9_2</span>  <span class="o">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s">&quot;ch9_2&quot;</span><span class="p">,</span> <span class="s">&quot;HasChapterDummy&quot;</span><span class="p">,</span> <span class="s">&quot;true&quot;</span><span class="p">,</span>
                                <span class="s">&quot;Enable Chapter instructions.&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">FeatureChapter9_3</span>  <span class="o">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s">&quot;ch9_3&quot;</span><span class="p">,</span> <span class="s">&quot;HasChapterDummy&quot;</span><span class="p">,</span> <span class="s">&quot;true&quot;</span><span class="p">,</span>
                                <span class="s">&quot;Enable Chapter instructions.&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">FeatureChapter10_1</span> <span class="o">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s">&quot;ch10_1&quot;</span><span class="p">,</span> <span class="s">&quot;HasChapterDummy&quot;</span><span class="p">,</span> <span class="s">&quot;true&quot;</span><span class="p">,</span>
                                <span class="s">&quot;Enable Chapter instructions.&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">FeatureChapter11_1</span> <span class="o">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s">&quot;ch11_1&quot;</span><span class="p">,</span> <span class="s">&quot;HasChapterDummy&quot;</span><span class="p">,</span> <span class="s">&quot;true&quot;</span><span class="p">,</span>
                                <span class="s">&quot;Enable Chapter instructions.&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">FeatureChapter11_2</span> <span class="o">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s">&quot;ch11_2&quot;</span><span class="p">,</span> <span class="s">&quot;HasChapterDummy&quot;</span><span class="p">,</span> <span class="s">&quot;true&quot;</span><span class="p">,</span>
                                <span class="s">&quot;Enable Chapter instructions.&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">FeatureChapter12_1</span> <span class="o">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s">&quot;ch12_1&quot;</span><span class="p">,</span> <span class="s">&quot;HasChapterDummy&quot;</span><span class="p">,</span> <span class="s">&quot;true&quot;</span><span class="p">,</span>
                                <span class="s">&quot;Enable Chapter instructions.&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">FeatureChapterAll</span>  <span class="o">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s">&quot;chall&quot;</span><span class="p">,</span> <span class="s">&quot;HasChapterDummy&quot;</span><span class="p">,</span> <span class="s">&quot;true&quot;</span><span class="p">,</span>
                                <span class="s">&quot;Enable Chapter instructions.&quot;</span><span class="p">,</span>
                                <span class="p">[</span><span class="n">FeatureChapter3_1</span><span class="p">,</span> <span class="n">FeatureChapter3_2</span><span class="p">,</span> 
                                 <span class="n">FeatureChapter3_3</span><span class="p">,</span> <span class="n">FeatureChapter3_4</span><span class="p">,</span> 
                                 <span class="n">FeatureChapter3_5</span><span class="p">,</span> 
                                 <span class="n">FeatureChapter4_1</span><span class="p">,</span> <span class="n">FeatureChapter4_2</span><span class="p">,</span> 
                                 <span class="n">FeatureChapter5_1</span><span class="p">,</span> <span class="n">FeatureChapter6_1</span><span class="p">,</span> 
                                 <span class="n">FeatureChapter7_1</span><span class="p">,</span> <span class="n">FeatureChapter8_1</span><span class="p">,</span> 
                                 <span class="n">FeatureChapter8_2</span><span class="p">,</span> <span class="n">FeatureChapter9_1</span><span class="p">,</span> 
                                 <span class="n">FeatureChapter9_2</span><span class="p">,</span> <span class="n">FeatureChapter9_3</span><span class="p">,</span> 
                                 <span class="n">FeatureChapter10_1</span><span class="p">,</span> 
                                 <span class="n">FeatureChapter11_1</span><span class="p">,</span> <span class="n">FeatureChapter11_2</span><span class="p">,</span> 
                                 <span class="n">FeatureChapter12_1</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>


<span class="n">def</span> <span class="n">FeatureCmp</span>         <span class="o">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s">&quot;cmp&quot;</span><span class="p">,</span> <span class="s">&quot;HasCmp&quot;</span><span class="p">,</span> <span class="s">&quot;true&quot;</span><span class="p">,</span>
                                <span class="s">&quot;Enable &#39;cmp&#39; instructions.&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">FeatureSlt</span>         <span class="o">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s">&quot;slt&quot;</span><span class="p">,</span> <span class="s">&quot;HasSlt&quot;</span><span class="p">,</span> <span class="s">&quot;true&quot;</span><span class="p">,</span>
                                <span class="s">&quot;Enable &#39;slt&#39; instructions.&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">FeatureCpu032I</span>     <span class="o">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s">&quot;cpu032I&quot;</span><span class="p">,</span> <span class="s">&quot;Cpu0ArchVersion&quot;</span><span class="p">,</span> 
                                <span class="s">&quot;Cpu032I&quot;</span><span class="p">,</span> <span class="s">&quot;Cpu032I ISA Support&quot;</span><span class="p">,</span>
                                <span class="p">[</span><span class="n">FeatureCmp</span><span class="p">,</span> <span class="n">FeatureChapterAll</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">FeatureCpu032II</span>    <span class="o">:</span> <span class="n">SubtargetFeature</span><span class="o">&lt;</span><span class="s">&quot;cpu032II&quot;</span><span class="p">,</span> <span class="s">&quot;Cpu0ArchVersion&quot;</span><span class="p">,</span>                      
                               <span class="s">&quot;Cpu032II&quot;</span><span class="p">,</span> <span class="s">&quot;Cpu032II ISA Support (slt)&quot;</span><span class="p">,</span>
                                <span class="p">[</span><span class="n">FeatureCmp</span><span class="p">,</span> <span class="n">FeatureSlt</span><span class="p">,</span> <span class="n">FeatureChapterAll</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>

<span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="c1">// Cpu0 processors supported.</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>

<span class="k">class</span> <span class="nc">Proc</span><span class="o">&lt;</span><span class="n">string</span> <span class="n">Name</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">SubtargetFeature</span><span class="o">&gt;</span> <span class="n">Features</span><span class="o">&gt;</span>
 <span class="o">:</span> <span class="n">Processor</span><span class="o">&lt;</span><span class="n">Name</span><span class="p">,</span> <span class="n">Cpu0GenericItineraries</span><span class="p">,</span> <span class="n">Features</span><span class="o">&gt;</span><span class="p">;</span>

<span class="n">def</span> <span class="o">:</span> <span class="n">Proc</span><span class="o">&lt;</span><span class="s">&quot;cpu032I&quot;</span><span class="p">,</span>  <span class="p">[</span><span class="n">FeatureCpu032I</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="o">:</span> <span class="n">Proc</span><span class="o">&lt;</span><span class="s">&quot;cpu032II&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">FeatureCpu032II</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
<span class="c1">// Above make Cpu0GenSubtargetInfo.inc set feature bit as the following order</span>
<span class="c1">// enum {</span>
<span class="c1">//   FeatureCmp =  1ULL &lt;&lt; 0,</span>
<span class="c1">//   FeatureCpu032I =  1ULL &lt;&lt; 1,</span>
<span class="c1">//   FeatureCpu032II =  1ULL &lt;&lt; 2,</span>
<span class="c1">//   FeatureSlt =  1ULL &lt;&lt; 3</span>
<span class="c1">// };</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0CallingConv.td</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">//===-- Cpu0CallingConv.td - Calling Conventions for Cpu0 --*- tablegen -*-===//</span>
<span class="c1">//</span>
<span class="c1">//                     The LLVM Compiler Infrastructure</span>
<span class="c1">//</span>
<span class="c1">// This file is distributed under the University of Illinois Open Source</span>
<span class="c1">// License. See LICENSE.TXT for details.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="c1">// This describes the calling conventions for Cpu0 architecture.</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>

<span class="c1">/// CCIfSubtarget - Match if the current subtarget has a feature F.</span>
<span class="k">class</span> <span class="nc">CCIfSubtarget</span><span class="o">&lt;</span><span class="n">string</span> <span class="n">F</span><span class="p">,</span> <span class="n">CCAction</span> <span class="n">A</span><span class="o">&gt;:</span>
  <span class="n">CCIf</span><span class="o">&lt;!</span><span class="n">strconcat</span><span class="p">(</span><span class="s">&quot;State.getTarget().getSubtarget&lt;Cpu0Subtarget&gt;().&quot;</span><span class="p">,</span> <span class="n">F</span><span class="p">),</span> <span class="n">A</span><span class="o">&gt;</span><span class="p">;</span>

<span class="n">def</span> <span class="n">CSR_O32</span> <span class="o">:</span> <span class="n">CalleeSavedRegs</span><span class="o">&lt;</span><span class="p">(</span><span class="n">add</span> <span class="n">LR</span><span class="p">,</span> <span class="n">FP</span><span class="p">,</span>
                                   <span class="p">(</span><span class="n">sequence</span> <span class="s">&quot;S%u&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0FrameLowering.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">//===-- Cpu0FrameLowering.h - Define frame lowering for Cpu0 ----*- C++ -*-===//</span>
<span class="c1">//</span>
<span class="c1">//                     The LLVM Compiler Infrastructure</span>
<span class="c1">//</span>
<span class="c1">// This file is distributed under the University of Illinois Open Source</span>
<span class="c1">// License. See LICENSE.TXT for details.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="c1">//</span>
<span class="c1">//</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="cp">#ifndef LLVM_LIB_TARGET_CPU0_CPU0FRAMELOWERING_H</span>
<span class="cp">#define LLVM_LIB_TARGET_CPU0_CPU0FRAMELOWERING_H</span>

<span class="cp">#include &quot;Cpu0Config.h&quot;</span>

<span class="cp">#include &quot;Cpu0.h&quot;</span>
<span class="cp">#include &quot;llvm/Target/TargetFrameLowering.h&quot;</span>

<span class="k">namespace</span> <span class="n">llvm</span> <span class="p">{</span>
  <span class="k">class</span> <span class="nc">Cpu0Subtarget</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Cpu0FrameLowering</span> <span class="o">:</span> <span class="k">public</span> <span class="n">TargetFrameLowering</span> <span class="p">{</span>
<span class="nl">protected:</span>
  <span class="k">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">STI</span><span class="p">;</span>

<span class="nl">public:</span>
  <span class="k">explicit</span> <span class="nf">Cpu0FrameLowering</span><span class="p">(</span><span class="k">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">sti</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">Alignment</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">TargetFrameLowering</span><span class="p">(</span><span class="n">StackGrowsDown</span><span class="p">,</span> <span class="n">Alignment</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">Alignment</span><span class="p">),</span>
      <span class="n">STI</span><span class="p">(</span><span class="n">sti</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">}</span>

  <span class="k">static</span> <span class="k">const</span> <span class="n">Cpu0FrameLowering</span> <span class="o">*</span><span class="nf">create</span><span class="p">(</span><span class="k">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">ST</span><span class="p">);</span>

  <span class="kt">bool</span> <span class="n">hasFP</span><span class="p">(</span><span class="k">const</span> <span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">MF</span><span class="p">)</span> <span class="k">const</span> <span class="n">override</span><span class="p">;</span>

<span class="p">};</span>

<span class="c1">/// Create Cpu0FrameLowering objects.</span>
<span class="k">const</span> <span class="n">Cpu0FrameLowering</span> <span class="o">*</span><span class="nf">createCpu0SEFrameLowering</span><span class="p">(</span><span class="k">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">ST</span><span class="p">);</span>

<span class="p">}</span> <span class="c1">// End llvm namespace</span>

<span class="cp">#endif</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0FrameLowering.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">//===-- Cpu0FrameLowering.cpp - Cpu0 Frame Information --------------------===//</span>
<span class="c1">//</span>
<span class="c1">//                     The LLVM Compiler Infrastructure</span>
<span class="c1">//</span>
<span class="c1">// This file is distributed under the University of Illinois Open Source</span>
<span class="c1">// License. See LICENSE.TXT for details.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="c1">//</span>
<span class="c1">// This file contains the Cpu0 implementation of TargetFrameLowering class.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>

<span class="cp">#include &quot;Cpu0FrameLowering.h&quot;</span>

<span class="cp">#include &quot;Cpu0InstrInfo.h&quot;</span>
<span class="cp">#include &quot;Cpu0MachineFunction.h&quot;</span>
<span class="cp">#include &quot;Cpu0Subtarget.h&quot;</span>
<span class="cp">#include &quot;llvm/CodeGen/MachineFrameInfo.h&quot;</span>
<span class="cp">#include &quot;llvm/CodeGen/MachineFunction.h&quot;</span>
<span class="cp">#include &quot;llvm/CodeGen/MachineInstrBuilder.h&quot;</span>
<span class="cp">#include &quot;llvm/CodeGen/MachineModuleInfo.h&quot;</span>
<span class="cp">#include &quot;llvm/CodeGen/MachineRegisterInfo.h&quot;</span>
<span class="cp">#include &quot;llvm/IR/DataLayout.h&quot;</span>
<span class="cp">#include &quot;llvm/IR/Function.h&quot;</span>
<span class="cp">#include &quot;llvm/Support/CommandLine.h&quot;</span>
<span class="cp">#include &quot;llvm/Target/TargetOptions.h&quot;</span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">llvm</span><span class="p">;</span>

<span class="c1">//- emitPrologue() and emitEpilogue must exist for main(). </span>

<span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="c1">//</span>
<span class="c1">// Stack Frame Processing methods</span>
<span class="c1">// +----------------------------+</span>
<span class="c1">//</span>
<span class="c1">// The stack is allocated decrementing the stack pointer on</span>
<span class="c1">// the first instruction of a function prologue. Once decremented,</span>
<span class="c1">// all stack references are done thought a positive offset</span>
<span class="c1">// from the stack/frame pointer, so the stack is considering</span>
<span class="c1">// to grow up! Otherwise terrible hacks would have to be made</span>
<span class="c1">// to get this stack ABI compliant :)</span>
<span class="c1">//</span>
<span class="c1">//  The stack frame required by the ABI (after call):</span>
<span class="c1">//  Offset</span>
<span class="c1">//</span>
<span class="c1">//  0                 ----------</span>
<span class="c1">//  4                 Args to pass</span>
<span class="c1">//  .                 saved $GP  (used in PIC)</span>
<span class="c1">//  .                 Alloca allocations</span>
<span class="c1">//  .                 Local Area</span>
<span class="c1">//  .                 CPU &quot;Callee Saved&quot; Registers</span>
<span class="c1">//  .                 saved FP</span>
<span class="c1">//  .                 saved RA</span>
<span class="c1">//  .                 FPU &quot;Callee Saved&quot; Registers</span>
<span class="c1">//  StackSize         -----------</span>
<span class="c1">//</span>
<span class="c1">// Offset - offset from sp after stack allocation on function prologue</span>
<span class="c1">//</span>
<span class="c1">// The sp is the stack pointer subtracted/added from the stack size</span>
<span class="c1">// at the Prologue/Epilogue</span>
<span class="c1">//</span>
<span class="c1">// References to the previous stack (to obtain arguments) are done</span>
<span class="c1">// with offsets that exceeds the stack size: (stacksize+(4*(num_arg-1))</span>
<span class="c1">//</span>
<span class="c1">// Examples:</span>
<span class="c1">// - reference to the actual stack frame</span>
<span class="c1">//   for any local area var there is smt like : FI &gt;= 0, StackOffset: 4</span>
<span class="c1">//     st REGX, 4(SP)</span>
<span class="c1">//</span>
<span class="c1">// - reference to previous stack frame</span>
<span class="c1">//   suppose there&#39;s a load to the 5th arguments : FI &lt; 0, StackOffset: 16.</span>
<span class="c1">//   The emitted instruction will be something like:</span>
<span class="c1">//     ld REGX, 16+StackSize(SP)</span>
<span class="c1">//</span>
<span class="c1">// Since the total stack size is unknown on LowerFormalArguments, all</span>
<span class="c1">// stack references (ObjectOffset) created to reference the function</span>
<span class="c1">// arguments, are negative numbers. This way, on eliminateFrameIndex it&#39;s</span>
<span class="c1">// possible to detect those references and the offsets are adjusted to</span>
<span class="c1">// their real location.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>

<span class="k">const</span> <span class="n">Cpu0FrameLowering</span> <span class="o">*</span><span class="n">Cpu0FrameLowering</span><span class="o">::</span><span class="n">create</span><span class="p">(</span><span class="k">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">ST</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">llvm</span><span class="o">::</span><span class="n">createCpu0SEFrameLowering</span><span class="p">(</span><span class="n">ST</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// hasFP - Return true if the specified function should have a dedicated frame</span>
<span class="c1">// pointer register.  This is true if the function has variable sized allocas,</span>
<span class="c1">// if it needs dynamic stack realignment, if frame pointer elimination is</span>
<span class="c1">// disabled, or if the frame address is taken.</span>
<span class="kt">bool</span> <span class="n">Cpu0FrameLowering</span><span class="o">::</span><span class="n">hasFP</span><span class="p">(</span><span class="k">const</span> <span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">MF</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="k">const</span> <span class="n">MachineFrameInfo</span> <span class="o">*</span><span class="n">MFI</span> <span class="o">=</span> <span class="n">MF</span><span class="p">.</span><span class="n">getFrameInfo</span><span class="p">();</span>
  <span class="k">const</span> <span class="n">TargetRegisterInfo</span> <span class="o">*</span><span class="n">TRI</span> <span class="o">=</span> <span class="n">STI</span><span class="p">.</span><span class="n">getRegisterInfo</span><span class="p">();</span>

  <span class="k">return</span> <span class="n">MF</span><span class="p">.</span><span class="n">getTarget</span><span class="p">().</span><span class="n">Options</span><span class="p">.</span><span class="n">DisableFramePointerElim</span><span class="p">(</span><span class="n">MF</span><span class="p">)</span> <span class="o">||</span>
      <span class="n">MFI</span><span class="o">-&gt;</span><span class="n">hasVarSizedObjects</span><span class="p">()</span> <span class="o">||</span> <span class="n">MFI</span><span class="o">-&gt;</span><span class="n">isFrameAddressTaken</span><span class="p">()</span> <span class="o">||</span>
      <span class="n">TRI</span><span class="o">-&gt;</span><span class="n">needsStackRealignment</span><span class="p">(</span><span class="n">MF</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0SEFrameLowering.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">//===-- Cpu0SEFrameLowering.h - Cpu032/64 frame lowering --------*- C++ -*-===//</span>
<span class="c1">//</span>
<span class="c1">//                     The LLVM Compiler Infrastructure</span>
<span class="c1">//</span>
<span class="c1">// This file is distributed under the University of Illinois Open Source</span>
<span class="c1">// License. See LICENSE.TXT for details.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="c1">//</span>
<span class="c1">//</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>

<span class="cp">#ifndef LLVM_LIB_TARGET_CPU0_CPU0SEFRAMELOWERING_H</span>
<span class="cp">#define LLVM_LIB_TARGET_CPU0_CPU0SEFRAMELOWERING_H</span>

<span class="cp">#include &quot;Cpu0Config.h&quot;</span>

<span class="cp">#include &quot;Cpu0FrameLowering.h&quot;</span>

<span class="k">namespace</span> <span class="n">llvm</span> <span class="p">{</span>

<span class="k">class</span> <span class="nc">Cpu0SEFrameLowering</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Cpu0FrameLowering</span> <span class="p">{</span>
<span class="nl">public:</span>
  <span class="k">explicit</span> <span class="n">Cpu0SEFrameLowering</span><span class="p">(</span><span class="k">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">STI</span><span class="p">);</span>

  <span class="c1">/// emitProlog/emitEpilog - These methods insert prolog and epilog code into</span>
  <span class="c1">/// the function.</span>
  <span class="kt">void</span> <span class="n">emitPrologue</span><span class="p">(</span><span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">MF</span><span class="p">,</span> <span class="n">MachineBasicBlock</span> <span class="o">&amp;</span><span class="n">MBB</span><span class="p">)</span> <span class="k">const</span> <span class="n">override</span><span class="p">;</span>
  <span class="kt">void</span> <span class="n">emitEpilogue</span><span class="p">(</span><span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">MF</span><span class="p">,</span> <span class="n">MachineBasicBlock</span> <span class="o">&amp;</span><span class="n">MBB</span><span class="p">)</span> <span class="k">const</span> <span class="n">override</span><span class="p">;</span>

<span class="p">};</span>

<span class="p">}</span> <span class="c1">// End llvm namespace</span>

<span class="cp">#endif</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0SEFrameLowering.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">//===-- Cpu0SEFrameLowering.cpp - Cpu0 Frame Information ------------------===//</span>
<span class="c1">//</span>
<span class="c1">//                     The LLVM Compiler Infrastructure</span>
<span class="c1">//</span>
<span class="c1">// This file is distributed under the University of Illinois Open Source</span>
<span class="c1">// License. See LICENSE.TXT for details.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="c1">//</span>
<span class="c1">// This file contains the Cpu0 implementation of TargetFrameLowering class.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>

<span class="cp">#include &quot;Cpu0SEFrameLowering.h&quot;</span>

<span class="cp">#include &quot;Cpu0MachineFunction.h&quot;</span>
<span class="cp">#include &quot;Cpu0SEInstrInfo.h&quot;</span>
<span class="cp">#include &quot;Cpu0Subtarget.h&quot;</span>
<span class="cp">#include &quot;llvm/CodeGen/MachineFrameInfo.h&quot;</span>
<span class="cp">#include &quot;llvm/CodeGen/MachineFunction.h&quot;</span>
<span class="cp">#include &quot;llvm/CodeGen/MachineInstrBuilder.h&quot;</span>
<span class="cp">#include &quot;llvm/CodeGen/MachineModuleInfo.h&quot;</span>
<span class="cp">#include &quot;llvm/CodeGen/MachineRegisterInfo.h&quot;</span>
<span class="cp">#include &quot;llvm/CodeGen/RegisterScavenging.h&quot;</span>
<span class="cp">#include &quot;llvm/IR/DataLayout.h&quot;</span>
<span class="cp">#include &quot;llvm/IR/Function.h&quot;</span>
<span class="cp">#include &quot;llvm/Support/CommandLine.h&quot;</span>
<span class="cp">#include &quot;llvm/Target/TargetOptions.h&quot;</span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">llvm</span><span class="p">;</span>

<span class="n">Cpu0SEFrameLowering</span><span class="o">::</span><span class="n">Cpu0SEFrameLowering</span><span class="p">(</span><span class="k">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">STI</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">Cpu0FrameLowering</span><span class="p">(</span><span class="n">STI</span><span class="p">,</span> <span class="n">STI</span><span class="p">.</span><span class="n">stackAlignment</span><span class="p">())</span> <span class="p">{}</span>

<span class="c1">//@emitPrologue {</span>
<span class="kt">void</span> <span class="n">Cpu0SEFrameLowering</span><span class="o">::</span><span class="n">emitPrologue</span><span class="p">(</span><span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">MF</span><span class="p">,</span>
                                       <span class="n">MachineBasicBlock</span> <span class="o">&amp;</span><span class="n">MBB</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
<span class="p">}</span>
<span class="c1">//}</span>

<span class="c1">//@emitEpilogue {</span>
<span class="kt">void</span> <span class="n">Cpu0SEFrameLowering</span><span class="o">::</span><span class="n">emitEpilogue</span><span class="p">(</span><span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">MF</span><span class="p">,</span>
                                 <span class="n">MachineBasicBlock</span> <span class="o">&amp;</span><span class="n">MBB</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
<span class="p">}</span>
<span class="c1">//}</span>

<span class="k">const</span> <span class="n">Cpu0FrameLowering</span> <span class="o">*</span>
<span class="n">llvm</span><span class="o">::</span><span class="n">createCpu0SEFrameLowering</span><span class="p">(</span><span class="k">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">ST</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="n">Cpu0SEFrameLowering</span><span class="p">(</span><span class="n">ST</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0InstrInfo.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">//===-- Cpu0InstrInfo.h - Cpu0 Instruction Information ----------*- C++ -*-===//</span>
<span class="c1">//</span>
<span class="c1">//                     The LLVM Compiler Infrastructure</span>
<span class="c1">//</span>
<span class="c1">// This file is distributed under the University of Illinois Open Source</span>
<span class="c1">// License. See LICENSE.TXT for details.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="c1">//</span>
<span class="c1">// This file contains the Cpu0 implementation of the TargetInstrInfo class.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>

<span class="cp">#ifndef LLVM_LIB_TARGET_CPU0_CPU0INSTRINFO_H</span>
<span class="cp">#define LLVM_LIB_TARGET_CPU0_CPU0INSTRINFO_H</span>

<span class="cp">#include &quot;Cpu0Config.h&quot;</span>

<span class="cp">#include &quot;Cpu0.h&quot;</span>
<span class="cp">#include &quot;Cpu0RegisterInfo.h&quot;</span>
<span class="cp">#include &quot;llvm/CodeGen/MachineInstrBuilder.h&quot;</span>
<span class="cp">#include &quot;llvm/Target/TargetInstrInfo.h&quot;</span>

<span class="cp">#define GET_INSTRINFO_HEADER</span>
<span class="cp">#include &quot;Cpu0GenInstrInfo.inc&quot;</span>

<span class="k">namespace</span> <span class="n">llvm</span> <span class="p">{</span>

<span class="k">class</span> <span class="nc">Cpu0InstrInfo</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Cpu0GenInstrInfo</span> <span class="p">{</span>
  <span class="k">virtual</span> <span class="kt">void</span> <span class="n">anchor</span><span class="p">();</span>
<span class="nl">protected:</span>
  <span class="k">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">Subtarget</span><span class="p">;</span>
<span class="nl">public:</span>
  <span class="k">explicit</span> <span class="nf">Cpu0InstrInfo</span><span class="p">(</span><span class="k">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">STI</span><span class="p">);</span>

  <span class="k">static</span> <span class="k">const</span> <span class="n">Cpu0InstrInfo</span> <span class="o">*</span><span class="nf">create</span><span class="p">(</span><span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">STI</span><span class="p">);</span>

  <span class="c1">/// getRegisterInfo - TargetInstrInfo is a superset of MRegister info.  As</span>
  <span class="c1">/// such, whenever a client has an instance of instruction info, it should</span>
  <span class="c1">/// always be able to get register info as well (through this method).</span>
  <span class="c1">///</span>
  <span class="k">virtual</span> <span class="k">const</span> <span class="n">Cpu0RegisterInfo</span> <span class="o">&amp;</span><span class="n">getRegisterInfo</span><span class="p">()</span> <span class="k">const</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="c1">/// Return the number of bytes of code the specified instruction may be.</span>
  <span class="kt">unsigned</span> <span class="n">GetInstSizeInBytes</span><span class="p">(</span><span class="k">const</span> <span class="n">MachineInstr</span> <span class="o">*</span><span class="n">MI</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>

  

<span class="nl">protected:</span>
<span class="p">};</span>
<span class="k">const</span> <span class="n">Cpu0InstrInfo</span> <span class="o">*</span><span class="nf">createCpu0SEInstrInfo</span><span class="p">(</span><span class="k">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">STI</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0InstrInfo.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">//===-- Cpu0InstrInfo.cpp - Cpu0 Instruction Information ------------------===//</span>
<span class="c1">//</span>
<span class="c1">//                     The LLVM Compiler Infrastructure</span>
<span class="c1">//</span>
<span class="c1">// This file is distributed under the University of Illinois Open Source</span>
<span class="c1">// License. See LICENSE.TXT for details.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="c1">//</span>
<span class="c1">// This file contains the Cpu0 implementation of the TargetInstrInfo class.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>

<span class="cp">#include &quot;Cpu0InstrInfo.h&quot;</span>

<span class="cp">#include &quot;Cpu0TargetMachine.h&quot;</span>
<span class="cp">#include &quot;Cpu0MachineFunction.h&quot;</span>
<span class="cp">#include &quot;llvm/ADT/STLExtras.h&quot;</span>
<span class="cp">#include &quot;llvm/CodeGen/MachineInstrBuilder.h&quot;</span>
<span class="cp">#include &quot;llvm/Support/ErrorHandling.h&quot;</span>
<span class="cp">#include &quot;llvm/Support/TargetRegistry.h&quot;</span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">llvm</span><span class="p">;</span>

<span class="cp">#define GET_INSTRINFO_CTOR_DTOR</span>
<span class="cp">#include &quot;Cpu0GenInstrInfo.inc&quot;</span>

<span class="c1">// Pin the vtable to this file.</span>
<span class="kt">void</span> <span class="n">Cpu0InstrInfo</span><span class="o">::</span><span class="n">anchor</span><span class="p">()</span> <span class="p">{}</span>

<span class="c1">//@Cpu0InstrInfo {</span>
<span class="n">Cpu0InstrInfo</span><span class="o">::</span><span class="n">Cpu0InstrInfo</span><span class="p">(</span><span class="k">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">STI</span><span class="p">)</span>
    <span class="o">:</span> 
      <span class="n">Subtarget</span><span class="p">(</span><span class="n">STI</span><span class="p">)</span> <span class="p">{}</span>

<span class="k">const</span> <span class="n">Cpu0InstrInfo</span> <span class="o">*</span><span class="n">Cpu0InstrInfo</span><span class="o">::</span><span class="n">create</span><span class="p">(</span><span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">STI</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">llvm</span><span class="o">::</span><span class="n">createCpu0SEInstrInfo</span><span class="p">(</span><span class="n">STI</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0InstrInfo.td</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="c1">// Cpu0 Instruction Predicate Definitions.</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>

<span class="n">def</span> <span class="n">Ch3_1</span>       <span class="o">:</span>     <span class="n">Predicate</span><span class="o">&lt;</span><span class="s">&quot;Subtarget-&gt;hasChapter3_1()&quot;</span><span class="o">&gt;</span><span class="p">,</span>
                      <span class="n">AssemblerPredicate</span><span class="o">&lt;</span><span class="s">&quot;FeatureChapter3_1&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">Ch3_2</span>       <span class="o">:</span>     <span class="n">Predicate</span><span class="o">&lt;</span><span class="s">&quot;Subtarget-&gt;hasChapter3_2()&quot;</span><span class="o">&gt;</span><span class="p">,</span>
                      <span class="n">AssemblerPredicate</span><span class="o">&lt;</span><span class="s">&quot;FeatureChapter3_2&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">Ch3_3</span>       <span class="o">:</span>     <span class="n">Predicate</span><span class="o">&lt;</span><span class="s">&quot;Subtarget-&gt;hasChapter3_3()&quot;</span><span class="o">&gt;</span><span class="p">,</span>
                      <span class="n">AssemblerPredicate</span><span class="o">&lt;</span><span class="s">&quot;FeatureChapter3_3&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">Ch3_4</span>       <span class="o">:</span>     <span class="n">Predicate</span><span class="o">&lt;</span><span class="s">&quot;Subtarget-&gt;hasChapter3_4()&quot;</span><span class="o">&gt;</span><span class="p">,</span>
                      <span class="n">AssemblerPredicate</span><span class="o">&lt;</span><span class="s">&quot;FeatureChapter3_4&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">Ch3_5</span>       <span class="o">:</span>     <span class="n">Predicate</span><span class="o">&lt;</span><span class="s">&quot;Subtarget-&gt;hasChapter3_5()&quot;</span><span class="o">&gt;</span><span class="p">,</span>
                      <span class="n">AssemblerPredicate</span><span class="o">&lt;</span><span class="s">&quot;FeatureChapter3_5&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">Ch4_1</span>       <span class="o">:</span>     <span class="n">Predicate</span><span class="o">&lt;</span><span class="s">&quot;Subtarget-&gt;hasChapter4_1()&quot;</span><span class="o">&gt;</span><span class="p">,</span>
                      <span class="n">AssemblerPredicate</span><span class="o">&lt;</span><span class="s">&quot;FeatureChapter4_1&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">Ch4_2</span>       <span class="o">:</span>     <span class="n">Predicate</span><span class="o">&lt;</span><span class="s">&quot;Subtarget-&gt;hasChapter4_2()&quot;</span><span class="o">&gt;</span><span class="p">,</span>
                      <span class="n">AssemblerPredicate</span><span class="o">&lt;</span><span class="s">&quot;FeatureChapter4_2&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">Ch5_1</span>       <span class="o">:</span>     <span class="n">Predicate</span><span class="o">&lt;</span><span class="s">&quot;Subtarget-&gt;hasChapter5_1()&quot;</span><span class="o">&gt;</span><span class="p">,</span>
                      <span class="n">AssemblerPredicate</span><span class="o">&lt;</span><span class="s">&quot;FeatureChapter5_1&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">Ch6_1</span>       <span class="o">:</span>     <span class="n">Predicate</span><span class="o">&lt;</span><span class="s">&quot;Subtarget-&gt;hasChapter6_1()&quot;</span><span class="o">&gt;</span><span class="p">,</span>
                      <span class="n">AssemblerPredicate</span><span class="o">&lt;</span><span class="s">&quot;FeatureChapter6_1&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">Ch7_1</span>       <span class="o">:</span>     <span class="n">Predicate</span><span class="o">&lt;</span><span class="s">&quot;Subtarget-&gt;hasChapter7_1()&quot;</span><span class="o">&gt;</span><span class="p">,</span>
                      <span class="n">AssemblerPredicate</span><span class="o">&lt;</span><span class="s">&quot;FeatureChapter7_1&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">Ch8_1</span>       <span class="o">:</span>     <span class="n">Predicate</span><span class="o">&lt;</span><span class="s">&quot;Subtarget-&gt;hasChapter8_1()&quot;</span><span class="o">&gt;</span><span class="p">,</span>
                      <span class="n">AssemblerPredicate</span><span class="o">&lt;</span><span class="s">&quot;FeatureChapter8_1&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">Ch8_2</span>       <span class="o">:</span>     <span class="n">Predicate</span><span class="o">&lt;</span><span class="s">&quot;Subtarget-&gt;hasChapter8_2()&quot;</span><span class="o">&gt;</span><span class="p">,</span>
                      <span class="n">AssemblerPredicate</span><span class="o">&lt;</span><span class="s">&quot;FeatureChapter8_2&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">Ch9_1</span>       <span class="o">:</span>     <span class="n">Predicate</span><span class="o">&lt;</span><span class="s">&quot;Subtarget-&gt;hasChapter9_1()&quot;</span><span class="o">&gt;</span><span class="p">,</span>
                      <span class="n">AssemblerPredicate</span><span class="o">&lt;</span><span class="s">&quot;FeatureChapter9_1&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">Ch9_2</span>       <span class="o">:</span>     <span class="n">Predicate</span><span class="o">&lt;</span><span class="s">&quot;Subtarget-&gt;hasChapter9_2()&quot;</span><span class="o">&gt;</span><span class="p">,</span>
                      <span class="n">AssemblerPredicate</span><span class="o">&lt;</span><span class="s">&quot;FeatureChapter9_2&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">Ch9_3</span>       <span class="o">:</span>     <span class="n">Predicate</span><span class="o">&lt;</span><span class="s">&quot;Subtarget-&gt;hasChapter9_3()&quot;</span><span class="o">&gt;</span><span class="p">,</span>
                      <span class="n">AssemblerPredicate</span><span class="o">&lt;</span><span class="s">&quot;FeatureChapter9_3&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">Ch10_1</span>      <span class="o">:</span>     <span class="n">Predicate</span><span class="o">&lt;</span><span class="s">&quot;Subtarget-&gt;hasChapter10_1()&quot;</span><span class="o">&gt;</span><span class="p">,</span>
                      <span class="n">AssemblerPredicate</span><span class="o">&lt;</span><span class="s">&quot;FeatureChapter10_1&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">Ch11_1</span>      <span class="o">:</span>     <span class="n">Predicate</span><span class="o">&lt;</span><span class="s">&quot;Subtarget-&gt;hasChapter11_1()&quot;</span><span class="o">&gt;</span><span class="p">,</span>
                      <span class="n">AssemblerPredicate</span><span class="o">&lt;</span><span class="s">&quot;FeatureChapter11_1&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">Ch11_2</span>      <span class="o">:</span>     <span class="n">Predicate</span><span class="o">&lt;</span><span class="s">&quot;Subtarget-&gt;hasChapter11_2()&quot;</span><span class="o">&gt;</span><span class="p">,</span>
                      <span class="n">AssemblerPredicate</span><span class="o">&lt;</span><span class="s">&quot;FeatureChapter11_2&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">Ch12_1</span>      <span class="o">:</span>     <span class="n">Predicate</span><span class="o">&lt;</span><span class="s">&quot;Subtarget-&gt;hasChapter12_1()&quot;</span><span class="o">&gt;</span><span class="p">,</span>
                      <span class="n">AssemblerPredicate</span><span class="o">&lt;</span><span class="s">&quot;FeatureChapter12_1&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">Ch_all</span>      <span class="o">:</span>     <span class="n">Predicate</span><span class="o">&lt;</span><span class="s">&quot;Subtarget-&gt;hasChapterAll()&quot;</span><span class="o">&gt;</span><span class="p">,</span>
                      <span class="n">AssemblerPredicate</span><span class="o">&lt;</span><span class="s">&quot;FeatureChapterAll&quot;</span><span class="o">&gt;</span><span class="p">;</span>

<span class="n">def</span> <span class="n">EnableOverflow</span>  <span class="o">:</span> <span class="n">Predicate</span><span class="o">&lt;</span><span class="s">&quot;Subtarget-&gt;enableOverflow()&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">DisableOverflow</span> <span class="o">:</span> <span class="n">Predicate</span><span class="o">&lt;</span><span class="s">&quot;Subtarget-&gt;disableOverflow()&quot;</span><span class="o">&gt;</span><span class="p">;</span>

<span class="n">def</span> <span class="n">HasCmp</span>      <span class="o">:</span>     <span class="n">Predicate</span><span class="o">&lt;</span><span class="s">&quot;Subtarget-&gt;hasCmp()&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">HasSlt</span>      <span class="o">:</span>     <span class="n">Predicate</span><span class="o">&lt;</span><span class="s">&quot;Subtarget-&gt;hasSlt()&quot;</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0ISelLowering.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">//===-- Cpu0ISelLowering.h - Cpu0 DAG Lowering Interface --------*- C++ -*-===//</span>
<span class="c1">//</span>
<span class="c1">//                     The LLVM Compiler Infrastructure</span>
<span class="c1">//</span>
<span class="c1">// This file is distributed under the University of Illinois Open Source</span>
<span class="c1">// License. See LICENSE.TXT for details.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="c1">//</span>
<span class="c1">// This file defines the interfaces that Cpu0 uses to lower LLVM code into a</span>
<span class="c1">// selection DAG.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>

<span class="cp">#ifndef LLVM_LIB_TARGET_CPU0_CPU0ISELLOWERING_H</span>
<span class="cp">#define LLVM_LIB_TARGET_CPU0_CPU0ISELLOWERING_H</span>

<span class="cp">#include &quot;Cpu0Config.h&quot;</span>

<span class="cp">#include &quot;MCTargetDesc/Cpu0ABIInfo.h&quot;</span>
<span class="cp">#include &quot;Cpu0.h&quot;</span>
<span class="cp">#include &quot;llvm/CodeGen/CallingConvLower.h&quot;</span>
<span class="cp">#include &quot;llvm/CodeGen/SelectionDAG.h&quot;</span>
<span class="cp">#include &quot;llvm/IR/Function.h&quot;</span>
<span class="cp">#include &quot;llvm/Target/TargetLowering.h&quot;</span>
<span class="cp">#include &lt;deque&gt;</span>

<span class="k">namespace</span> <span class="n">llvm</span> <span class="p">{</span>
  <span class="k">namespace</span> <span class="n">Cpu0ISD</span> <span class="p">{</span>
    <span class="k">enum</span> <span class="n">NodeType</span> <span class="p">{</span>
      <span class="c1">// Start the numbering from where ISD NodeType finishes.</span>
      <span class="n">FIRST_NUMBER</span> <span class="o">=</span> <span class="n">ISD</span><span class="o">::</span><span class="n">BUILTIN_OP_END</span><span class="p">,</span>

      <span class="c1">// Jump and link (call)</span>
      <span class="n">JmpLink</span><span class="p">,</span>

      <span class="c1">// Tail call</span>
      <span class="n">TailCall</span><span class="p">,</span>

      <span class="c1">// Get the Higher 16 bits from a 32-bit immediate</span>
      <span class="c1">// No relation with Cpu0 Hi register</span>
      <span class="n">Hi</span><span class="p">,</span>
      <span class="c1">// Get the Lower 16 bits from a 32-bit immediate</span>
      <span class="c1">// No relation with Cpu0 Lo register</span>
      <span class="n">Lo</span><span class="p">,</span>

      <span class="c1">// Handle gp_rel (small data/bss sections) relocation.</span>
      <span class="n">GPRel</span><span class="p">,</span>

      <span class="c1">// Thread Pointer</span>
      <span class="n">ThreadPointer</span><span class="p">,</span>

      <span class="c1">// Return</span>
      <span class="n">Ret</span><span class="p">,</span>

      <span class="n">EH_RETURN</span><span class="p">,</span>

      <span class="c1">// DivRem(u)</span>
      <span class="n">DivRem</span><span class="p">,</span>
      <span class="n">DivRemU</span><span class="p">,</span>

      <span class="n">Wrapper</span><span class="p">,</span>
      <span class="n">DynAlloc</span><span class="p">,</span>

      <span class="n">Sync</span>
    <span class="p">};</span>
  <span class="p">}</span>

  <span class="c1">//===--------------------------------------------------------------------===//</span>
  <span class="c1">// TargetLowering Implementation</span>
  <span class="c1">//===--------------------------------------------------------------------===//</span>
  <span class="k">class</span> <span class="nc">Cpu0FunctionInfo</span><span class="p">;</span>
  <span class="k">class</span> <span class="nc">Cpu0Subtarget</span><span class="p">;</span>

  <span class="c1">//@class Cpu0TargetLowering</span>
  <span class="k">class</span> <span class="nc">Cpu0TargetLowering</span> <span class="o">:</span> <span class="k">public</span> <span class="n">TargetLowering</span>  <span class="p">{</span>
  <span class="nl">public:</span>
    <span class="k">explicit</span> <span class="n">Cpu0TargetLowering</span><span class="p">(</span><span class="k">const</span> <span class="n">Cpu0TargetMachine</span> <span class="o">&amp;</span><span class="n">TM</span><span class="p">,</span>
                                <span class="k">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">STI</span><span class="p">);</span>

    <span class="k">static</span> <span class="k">const</span> <span class="n">Cpu0TargetLowering</span> <span class="o">*</span><span class="nf">create</span><span class="p">(</span><span class="k">const</span> <span class="n">Cpu0TargetMachine</span> <span class="o">&amp;</span><span class="n">TM</span><span class="p">,</span>
                                            <span class="k">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">STI</span><span class="p">);</span>

    <span class="c1">/// getTargetNodeName - This method returns the name of a target specific</span>
    <span class="c1">//  DAG node.</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">getTargetNodeName</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">Opcode</span><span class="p">)</span> <span class="k">const</span> <span class="n">override</span><span class="p">;</span>

  <span class="nl">protected:</span>

    <span class="c1">/// ByValArgInfo - Byval argument information.</span>
    <span class="k">struct</span> <span class="n">ByValArgInfo</span> <span class="p">{</span>
      <span class="kt">unsigned</span> <span class="n">FirstIdx</span><span class="p">;</span> <span class="c1">// Index of the first register used.</span>
      <span class="kt">unsigned</span> <span class="n">NumRegs</span><span class="p">;</span>  <span class="c1">// Number of registers used for this argument.</span>
      <span class="kt">unsigned</span> <span class="n">Address</span><span class="p">;</span>  <span class="c1">// Offset of the stack area used to pass this argument.</span>

      <span class="n">ByValArgInfo</span><span class="p">()</span> <span class="o">:</span> <span class="n">FirstIdx</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">NumRegs</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">Address</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{}</span>
    <span class="p">};</span>

  <span class="nl">protected:</span>
    <span class="c1">// Subtarget Info</span>
    <span class="k">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">Subtarget</span><span class="p">;</span>
    <span class="c1">// Cache the ABI from the TargetMachine, we use it everywhere.</span>
    <span class="k">const</span> <span class="n">Cpu0ABIInfo</span> <span class="o">&amp;</span><span class="n">ABI</span><span class="p">;</span>

  <span class="nl">private:</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">    // Create a TargetConstantPool node.</span>
<span class="c">    SDValue getTargetNode(ConstantPoolSDNode *N, EVT Ty, SelectionDAG &amp;DAG,</span>
<span class="c">                          unsigned Flag) const;</span>
<span class="cp">#endif</span>

    <span class="c1">// Lower Operand specifics</span>
    <span class="n">SDValue</span> <span class="n">lowerGlobalAddress</span><span class="p">(</span><span class="n">SDValue</span> <span class="n">Op</span><span class="p">,</span> <span class="n">SelectionDAG</span> <span class="o">&amp;</span><span class="n">DAG</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>

	<span class="c1">//- must be exist even without function all</span>
    <span class="n">SDValue</span>
      <span class="n">LowerFormalArguments</span><span class="p">(</span><span class="n">SDValue</span> <span class="n">Chain</span><span class="p">,</span>
                           <span class="n">CallingConv</span><span class="o">::</span><span class="n">ID</span> <span class="n">CallConv</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">IsVarArg</span><span class="p">,</span>
                           <span class="k">const</span> <span class="n">SmallVectorImpl</span><span class="o">&lt;</span><span class="n">ISD</span><span class="o">::</span><span class="n">InputArg</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">Ins</span><span class="p">,</span>
                           <span class="n">SDLoc</span> <span class="n">dl</span><span class="p">,</span> <span class="n">SelectionDAG</span> <span class="o">&amp;</span><span class="n">DAG</span><span class="p">,</span>
                           <span class="n">SmallVectorImpl</span><span class="o">&lt;</span><span class="n">SDValue</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">InVals</span><span class="p">)</span> <span class="k">const</span> <span class="n">override</span><span class="p">;</span>

    <span class="n">SDValue</span> <span class="n">LowerReturn</span><span class="p">(</span><span class="n">SDValue</span> <span class="n">Chain</span><span class="p">,</span>
                        <span class="n">CallingConv</span><span class="o">::</span><span class="n">ID</span> <span class="n">CallConv</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">IsVarArg</span><span class="p">,</span>
                        <span class="k">const</span> <span class="n">SmallVectorImpl</span><span class="o">&lt;</span><span class="n">ISD</span><span class="o">::</span><span class="n">OutputArg</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">Outs</span><span class="p">,</span>
                        <span class="k">const</span> <span class="n">SmallVectorImpl</span><span class="o">&lt;</span><span class="n">SDValue</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">OutVals</span><span class="p">,</span>
                        <span class="n">SDLoc</span> <span class="n">dl</span><span class="p">,</span> <span class="n">SelectionDAG</span> <span class="o">&amp;</span><span class="n">DAG</span><span class="p">)</span> <span class="k">const</span> <span class="n">override</span><span class="p">;</span>

  <span class="p">};</span>
  <span class="k">const</span> <span class="n">Cpu0TargetLowering</span> <span class="o">*</span>
  <span class="nf">createCpu0SETargetLowering</span><span class="p">(</span><span class="k">const</span> <span class="n">Cpu0TargetMachine</span> <span class="o">&amp;</span><span class="n">TM</span><span class="p">,</span> <span class="k">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">STI</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="c1">// Cpu0ISELLOWERING_H</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0ISelLowering.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">//===-- Cpu0ISelLowering.cpp - Cpu0 DAG Lowering Implementation -----------===//</span>
<span class="c1">//</span>
<span class="c1">//                     The LLVM Compiler Infrastructure</span>
<span class="c1">//</span>
<span class="c1">// This file is distributed under the University of Illinois Open Source</span>
<span class="c1">// License. See LICENSE.TXT for details.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="c1">//</span>
<span class="c1">// This file defines the interfaces that Cpu0 uses to lower LLVM code into a</span>
<span class="c1">// selection DAG.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="cp">#include &quot;Cpu0ISelLowering.h&quot;</span>

<span class="cp">#include &quot;Cpu0MachineFunction.h&quot;</span>
<span class="cp">#include &quot;Cpu0TargetMachine.h&quot;</span>
<span class="cp">#include &quot;Cpu0TargetObjectFile.h&quot;</span>
<span class="cp">#include &quot;Cpu0Subtarget.h&quot;</span>
<span class="cp">#include &quot;llvm/ADT/Statistic.h&quot;</span>
<span class="cp">#include &quot;llvm/CodeGen/CallingConvLower.h&quot;</span>
<span class="cp">#include &quot;llvm/CodeGen/MachineFrameInfo.h&quot;</span>
<span class="cp">#include &quot;llvm/CodeGen/MachineFunction.h&quot;</span>
<span class="cp">#include &quot;llvm/CodeGen/MachineInstrBuilder.h&quot;</span>
<span class="cp">#include &quot;llvm/CodeGen/MachineRegisterInfo.h&quot;</span>
<span class="cp">#include &quot;llvm/CodeGen/SelectionDAG.h&quot;</span>
<span class="cp">#include &quot;llvm/CodeGen/ValueTypes.h&quot;</span>
<span class="cp">#include &quot;llvm/IR/CallingConv.h&quot;</span>
<span class="cp">#include &quot;llvm/IR/DerivedTypes.h&quot;</span>
<span class="cp">#include &quot;llvm/IR/GlobalVariable.h&quot;</span>
<span class="cp">#include &quot;llvm/Support/CommandLine.h&quot;</span>
<span class="cp">#include &quot;llvm/Support/Debug.h&quot;</span>
<span class="cp">#include &quot;llvm/Support/ErrorHandling.h&quot;</span>
<span class="cp">#include &quot;llvm/Support/raw_ostream.h&quot;</span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">llvm</span><span class="p">;</span>

<span class="cp">#define DEBUG_TYPE &quot;cpu0-lower&quot;</span>

<span class="c1">//@3_1 1 {</span>
<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">Cpu0TargetLowering</span><span class="o">::</span><span class="n">getTargetNodeName</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">Opcode</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">Opcode</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">case</span> <span class="n">Cpu0ISD</span>:<span class="o">:</span><span class="n">JmpLink</span><span class="o">:</span>           <span class="k">return</span> <span class="s">&quot;Cpu0ISD::JmpLink&quot;</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">Cpu0ISD</span>:<span class="o">:</span><span class="n">TailCall</span><span class="o">:</span>          <span class="k">return</span> <span class="s">&quot;Cpu0ISD::TailCall&quot;</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">Cpu0ISD</span>:<span class="o">:</span><span class="n">Hi</span><span class="o">:</span>                <span class="k">return</span> <span class="s">&quot;Cpu0ISD::Hi&quot;</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">Cpu0ISD</span>:<span class="o">:</span><span class="n">Lo</span><span class="o">:</span>                <span class="k">return</span> <span class="s">&quot;Cpu0ISD::Lo&quot;</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">Cpu0ISD</span>:<span class="o">:</span><span class="n">GPRel</span><span class="o">:</span>             <span class="k">return</span> <span class="s">&quot;Cpu0ISD::GPRel&quot;</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">Cpu0ISD</span>:<span class="o">:</span><span class="n">Ret</span><span class="o">:</span>               <span class="k">return</span> <span class="s">&quot;Cpu0ISD::Ret&quot;</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">Cpu0ISD</span>:<span class="o">:</span><span class="n">EH_RETURN</span><span class="o">:</span>         <span class="k">return</span> <span class="s">&quot;Cpu0ISD::EH_RETURN&quot;</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">Cpu0ISD</span>:<span class="o">:</span><span class="n">DivRem</span><span class="o">:</span>            <span class="k">return</span> <span class="s">&quot;Cpu0ISD::DivRem&quot;</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">Cpu0ISD</span>:<span class="o">:</span><span class="n">DivRemU</span><span class="o">:</span>           <span class="k">return</span> <span class="s">&quot;Cpu0ISD::DivRemU&quot;</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">Cpu0ISD</span>:<span class="o">:</span><span class="n">Wrapper</span><span class="o">:</span>           <span class="k">return</span> <span class="s">&quot;Cpu0ISD::Wrapper&quot;</span><span class="p">;</span>
  <span class="nl">default:</span>                         <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="c1">//@3_1 1 }</span>

<span class="c1">//@Cpu0TargetLowering {</span>
<span class="n">Cpu0TargetLowering</span><span class="o">::</span><span class="n">Cpu0TargetLowering</span><span class="p">(</span><span class="k">const</span> <span class="n">Cpu0TargetMachine</span> <span class="o">&amp;</span><span class="n">TM</span><span class="p">,</span>
                                       <span class="k">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">STI</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">TargetLowering</span><span class="p">(</span><span class="n">TM</span><span class="p">),</span> <span class="n">Subtarget</span><span class="p">(</span><span class="n">STI</span><span class="p">),</span> <span class="n">ABI</span><span class="p">(</span><span class="n">TM</span><span class="p">.</span><span class="n">getABI</span><span class="p">())</span> <span class="p">{</span>

<span class="p">}</span>

<span class="k">const</span> <span class="n">Cpu0TargetLowering</span> <span class="o">*</span><span class="n">Cpu0TargetLowering</span><span class="o">::</span><span class="n">create</span><span class="p">(</span><span class="k">const</span> <span class="n">Cpu0TargetMachine</span> <span class="o">&amp;</span><span class="n">TM</span><span class="p">,</span>
                                                     <span class="k">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">STI</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">llvm</span><span class="o">::</span><span class="n">createCpu0SETargetLowering</span><span class="p">(</span><span class="n">TM</span><span class="p">,</span> <span class="n">STI</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="c1">//  Lower helper functions</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>

<span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="c1">//  Misc Lower Operation implementation</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>

<span class="cp">#include &quot;Cpu0GenCallingConv.inc&quot;</span>

<span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="c1">//@            Formal Arguments Calling Convention Implementation</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>

<span class="c1">//@LowerFormalArguments {</span>
<span class="c1">/// LowerFormalArguments - transform physical registers into virtual registers</span>
<span class="c1">/// and generate load operations for arguments places on the stack.</span>
<span class="n">SDValue</span>
<span class="n">Cpu0TargetLowering</span><span class="o">::</span><span class="n">LowerFormalArguments</span><span class="p">(</span><span class="n">SDValue</span> <span class="n">Chain</span><span class="p">,</span>
                                         <span class="n">CallingConv</span><span class="o">::</span><span class="n">ID</span> <span class="n">CallConv</span><span class="p">,</span>
                                         <span class="kt">bool</span> <span class="n">IsVarArg</span><span class="p">,</span>
                                      <span class="k">const</span> <span class="n">SmallVectorImpl</span><span class="o">&lt;</span><span class="n">ISD</span><span class="o">::</span><span class="n">InputArg</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">Ins</span><span class="p">,</span>
                                         <span class="n">SDLoc</span> <span class="n">DL</span><span class="p">,</span> <span class="n">SelectionDAG</span> <span class="o">&amp;</span><span class="n">DAG</span><span class="p">,</span>
                                         <span class="n">SmallVectorImpl</span><span class="o">&lt;</span><span class="n">SDValue</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">InVals</span><span class="p">)</span>
                                          <span class="k">const</span> <span class="p">{</span>

  <span class="k">return</span> <span class="n">Chain</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1">// @LowerFormalArguments }</span>

<span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="c1">//@              Return Value Calling Convention Implementation</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>

<span class="n">SDValue</span>
<span class="n">Cpu0TargetLowering</span><span class="o">::</span><span class="n">LowerReturn</span><span class="p">(</span><span class="n">SDValue</span> <span class="n">Chain</span><span class="p">,</span>
                                <span class="n">CallingConv</span><span class="o">::</span><span class="n">ID</span> <span class="n">CallConv</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">IsVarArg</span><span class="p">,</span>
                                <span class="k">const</span> <span class="n">SmallVectorImpl</span><span class="o">&lt;</span><span class="n">ISD</span><span class="o">::</span><span class="n">OutputArg</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">Outs</span><span class="p">,</span>
                                <span class="k">const</span> <span class="n">SmallVectorImpl</span><span class="o">&lt;</span><span class="n">SDValue</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">OutVals</span><span class="p">,</span>
                                <span class="n">SDLoc</span> <span class="n">DL</span><span class="p">,</span> <span class="n">SelectionDAG</span> <span class="o">&amp;</span><span class="n">DAG</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">DAG</span><span class="p">.</span><span class="n">getNode</span><span class="p">(</span><span class="n">Cpu0ISD</span><span class="o">::</span><span class="n">Ret</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">MVT</span><span class="o">::</span><span class="n">Other</span><span class="p">,</span>
                     <span class="n">Chain</span><span class="p">,</span> <span class="n">DAG</span><span class="p">.</span><span class="n">getRegister</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">LR</span><span class="p">,</span> <span class="n">MVT</span><span class="o">::</span><span class="n">i32</span><span class="p">));</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0SEISelLowering.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">//===-- Cpu0ISEISelLowering.h - Cpu0ISE DAG Lowering Interface ----*- C++ -*-===//</span>
<span class="c1">//</span>
<span class="c1">//                     The LLVM Compiler Infrastructure</span>
<span class="c1">//</span>
<span class="c1">// This file is distributed under the University of Illinois Open Source</span>
<span class="c1">// License. See LICENSE.TXT for details.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="c1">//</span>
<span class="c1">// Subclass of Cpu0ITargetLowering specialized for cpu032/64.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>

<span class="cp">#ifndef LLVM_LIB_TARGET_CPU0_CPU0SEISELLOWERING_H</span>
<span class="cp">#define LLVM_LIB_TARGET_CPU0_CPU0SEISELLOWERING_H</span>

<span class="cp">#include &quot;Cpu0Config.h&quot;</span>

<span class="cp">#include &quot;Cpu0ISelLowering.h&quot;</span>
<span class="cp">#include &quot;Cpu0RegisterInfo.h&quot;</span>

<span class="k">namespace</span> <span class="n">llvm</span> <span class="p">{</span>
  <span class="k">class</span> <span class="nc">Cpu0SETargetLowering</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Cpu0TargetLowering</span>  <span class="p">{</span>
  <span class="nl">public:</span>
    <span class="k">explicit</span> <span class="n">Cpu0SETargetLowering</span><span class="p">(</span><span class="k">const</span> <span class="n">Cpu0TargetMachine</span> <span class="o">&amp;</span><span class="n">TM</span><span class="p">,</span>
                                  <span class="k">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">STI</span><span class="p">);</span>

    <span class="n">SDValue</span> <span class="n">LowerOperation</span><span class="p">(</span><span class="n">SDValue</span> <span class="n">Op</span><span class="p">,</span> <span class="n">SelectionDAG</span> <span class="o">&amp;</span><span class="n">DAG</span><span class="p">)</span> <span class="k">const</span> <span class="n">override</span><span class="p">;</span>
  <span class="nl">private:</span>
  <span class="p">};</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="c1">// Cpu0ISEISELLOWERING_H</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0SEISelLowering.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">//===-- Cpu0SEISelLowering.cpp - Cpu0SE DAG Lowering Interface --*- C++ -*-===//</span>
<span class="c1">//</span>
<span class="c1">//                     The LLVM Compiler Infrastructure</span>
<span class="c1">//</span>
<span class="c1">// This file is distributed under the University of Illinois Open Source</span>
<span class="c1">// License. See LICENSE.TXT for details.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="c1">//</span>
<span class="c1">// Subclass of Cpu0TargetLowering specialized for cpu032.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="cp">#include &quot;Cpu0MachineFunction.h&quot;</span>
<span class="cp">#include &quot;Cpu0SEISelLowering.h&quot;</span>

<span class="cp">#include &quot;Cpu0RegisterInfo.h&quot;</span>
<span class="cp">#include &quot;Cpu0TargetMachine.h&quot;</span>
<span class="cp">#include &quot;llvm/CodeGen/MachineInstrBuilder.h&quot;</span>
<span class="cp">#include &quot;llvm/CodeGen/MachineRegisterInfo.h&quot;</span>
<span class="cp">#include &quot;llvm/IR/Intrinsics.h&quot;</span>
<span class="cp">#include &quot;llvm/Support/CommandLine.h&quot;</span>
<span class="cp">#include &quot;llvm/Support/Debug.h&quot;</span>
<span class="cp">#include &quot;llvm/Support/raw_ostream.h&quot;</span>
<span class="cp">#include &quot;llvm/Target/TargetInstrInfo.h&quot;</span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">llvm</span><span class="p">;</span>

<span class="cp">#define DEBUG_TYPE &quot;cpu0-isel&quot;</span>

<span class="k">static</span> <span class="n">cl</span><span class="o">::</span><span class="n">opt</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span>
<span class="n">EnableCpu0TailCalls</span><span class="p">(</span><span class="s">&quot;enable-cpu0-tail-calls&quot;</span><span class="p">,</span> <span class="n">cl</span><span class="o">::</span><span class="n">Hidden</span><span class="p">,</span>
                    <span class="n">cl</span><span class="o">::</span><span class="n">desc</span><span class="p">(</span><span class="s">&quot;CPU0: Enable tail calls.&quot;</span><span class="p">),</span> <span class="n">cl</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="nb">false</span><span class="p">));</span>

<span class="c1">//@Cpu0SETargetLowering {</span>
<span class="n">Cpu0SETargetLowering</span><span class="o">::</span><span class="n">Cpu0SETargetLowering</span><span class="p">(</span><span class="k">const</span> <span class="n">Cpu0TargetMachine</span> <span class="o">&amp;</span><span class="n">TM</span><span class="p">,</span>
                                           <span class="k">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">STI</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">Cpu0TargetLowering</span><span class="p">(</span><span class="n">TM</span><span class="p">,</span> <span class="n">STI</span><span class="p">)</span> <span class="p">{</span>
<span class="c1">//@Cpu0SETargetLowering body {</span>
  <span class="c1">// Set up the register classes</span>
  <span class="n">addRegisterClass</span><span class="p">(</span><span class="n">MVT</span><span class="o">::</span><span class="n">i32</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">CPURegsRegClass</span><span class="p">);</span>

<span class="c1">// must, computeRegisterProperties - Once all of the register classes are </span>
<span class="c1">//  added, this allows us to compute derived properties we expose.</span>
  <span class="n">computeRegisterProperties</span><span class="p">(</span><span class="n">Subtarget</span><span class="p">.</span><span class="n">getRegisterInfo</span><span class="p">());</span>
<span class="p">}</span>

<span class="n">SDValue</span> <span class="n">Cpu0SETargetLowering</span><span class="o">::</span><span class="n">LowerOperation</span><span class="p">(</span><span class="n">SDValue</span> <span class="n">Op</span><span class="p">,</span>
                                             <span class="n">SelectionDAG</span> <span class="o">&amp;</span><span class="n">DAG</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>

  <span class="k">return</span> <span class="n">Cpu0TargetLowering</span><span class="o">::</span><span class="n">LowerOperation</span><span class="p">(</span><span class="n">Op</span><span class="p">,</span> <span class="n">DAG</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">const</span> <span class="n">Cpu0TargetLowering</span> <span class="o">*</span>
<span class="n">llvm</span><span class="o">::</span><span class="n">createCpu0SETargetLowering</span><span class="p">(</span><span class="k">const</span> <span class="n">Cpu0TargetMachine</span> <span class="o">&amp;</span><span class="n">TM</span><span class="p">,</span>
                                 <span class="k">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">STI</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="n">Cpu0SETargetLowering</span><span class="p">(</span><span class="n">TM</span><span class="p">,</span> <span class="n">STI</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0MachineFunction.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">//===-- Cpu0MachineFunctionInfo.h - Private data used for Cpu0 ----*- C++ -*-=//</span>
<span class="c1">//</span>
<span class="c1">//                     The LLVM Compiler Infrastructure</span>
<span class="c1">//</span>
<span class="c1">// This file is distributed under the University of Illinois Open Source</span>
<span class="c1">// License. See LICENSE.TXT for details.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="c1">//</span>
<span class="c1">// This file declares the Cpu0 specific subclass of MachineFunctionInfo.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>

<span class="cp">#ifndef LLVM_LIB_TARGET_CPU0_CPU0MACHINEFUNCTION_H</span>
<span class="cp">#define LLVM_LIB_TARGET_CPU0_CPU0MACHINEFUNCTION_H</span>

<span class="cp">#include &quot;Cpu0Config.h&quot;</span>

<span class="cp">#include &quot;llvm/ADT/StringMap.h&quot;</span>
<span class="cp">#include &quot;llvm/CodeGen/MachineFrameInfo.h&quot;</span>
<span class="cp">#include &quot;llvm/CodeGen/MachineFunction.h&quot;</span>
<span class="cp">#include &quot;llvm/CodeGen/MachineMemOperand.h&quot;</span>
<span class="cp">#include &quot;llvm/CodeGen/PseudoSourceValue.h&quot;</span>
<span class="cp">#include &quot;llvm/IR/GlobalValue.h&quot;</span>
<span class="cp">#include &quot;llvm/IR/ValueMap.h&quot;</span>
<span class="cp">#include &quot;llvm/Target/TargetFrameLowering.h&quot;</span>
<span class="cp">#include &quot;llvm/Target/TargetMachine.h&quot;</span>
<span class="cp">#include &lt;map&gt;</span>
<span class="cp">#include &lt;string&gt;</span>
<span class="cp">#include &lt;utility&gt;</span>

<span class="k">namespace</span> <span class="n">llvm</span> <span class="p">{</span>

<span class="c1">/// \brief A class derived from PseudoSourceValue that represents a GOT entry</span>
<span class="c1">/// resolved by lazy-binding.</span>
<span class="k">class</span> <span class="nc">Cpu0CallEntry</span> <span class="o">:</span> <span class="k">public</span> <span class="n">PseudoSourceValue</span> <span class="p">{</span>
<span class="nl">public:</span>
  <span class="k">explicit</span> <span class="n">Cpu0CallEntry</span><span class="p">(</span><span class="n">StringRef</span> <span class="n">N</span><span class="p">);</span>
  <span class="k">explicit</span> <span class="nf">Cpu0CallEntry</span><span class="p">(</span><span class="k">const</span> <span class="n">GlobalValue</span> <span class="o">*</span><span class="n">V</span><span class="p">);</span>
  <span class="kt">bool</span> <span class="n">isConstant</span><span class="p">(</span><span class="k">const</span> <span class="n">MachineFrameInfo</span> <span class="o">*</span><span class="p">)</span> <span class="k">const</span> <span class="n">override</span><span class="p">;</span>
  <span class="kt">bool</span> <span class="n">isAliased</span><span class="p">(</span><span class="k">const</span> <span class="n">MachineFrameInfo</span> <span class="o">*</span><span class="p">)</span> <span class="k">const</span> <span class="n">override</span><span class="p">;</span>
  <span class="kt">bool</span> <span class="n">mayAlias</span><span class="p">(</span><span class="k">const</span> <span class="n">MachineFrameInfo</span> <span class="o">*</span><span class="p">)</span> <span class="k">const</span> <span class="n">override</span><span class="p">;</span>

<span class="nl">private:</span>
  <span class="kt">void</span> <span class="n">printCustom</span><span class="p">(</span><span class="n">raw_ostream</span> <span class="o">&amp;</span><span class="n">O</span><span class="p">)</span> <span class="k">const</span> <span class="n">override</span><span class="p">;</span>
<span class="cp">#ifndef NDEBUG</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">Name</span><span class="p">;</span>
  <span class="k">const</span> <span class="n">GlobalValue</span> <span class="o">*</span><span class="n">Val</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="c1">//@1 {</span>
<span class="c1">/// Cpu0FunctionInfo - This class is derived from MachineFunction private</span>
<span class="c1">/// Cpu0 target-specific information for each MachineFunction.</span>
<span class="k">class</span> <span class="nc">Cpu0FunctionInfo</span> <span class="o">:</span> <span class="k">public</span> <span class="n">MachineFunctionInfo</span> <span class="p">{</span>
<span class="nl">public:</span>
  <span class="n">Cpu0FunctionInfo</span><span class="p">(</span><span class="n">MachineFunction</span><span class="o">&amp;</span> <span class="n">MF</span><span class="p">)</span>
  <span class="o">:</span> <span class="n">MF</span><span class="p">(</span><span class="n">MF</span><span class="p">),</span> 
    <span class="n">VarArgsFrameIndex</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> 
    <span class="n">MaxCallFrameSize</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">{}</span>

  <span class="o">~</span><span class="n">Cpu0FunctionInfo</span><span class="p">();</span>

  <span class="kt">int</span> <span class="n">getVarArgsFrameIndex</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">VarArgsFrameIndex</span><span class="p">;</span> <span class="p">}</span>
  <span class="kt">void</span> <span class="n">setVarArgsFrameIndex</span><span class="p">(</span><span class="kt">int</span> <span class="n">Index</span><span class="p">)</span> <span class="p">{</span> <span class="n">VarArgsFrameIndex</span> <span class="o">=</span> <span class="n">Index</span><span class="p">;</span> <span class="p">}</span>

<span class="nl">private:</span>
  <span class="k">virtual</span> <span class="kt">void</span> <span class="n">anchor</span><span class="p">();</span>

  <span class="n">MachineFunction</span><span class="o">&amp;</span> <span class="n">MF</span><span class="p">;</span>

    <span class="c1">/// VarArgsFrameIndex - FrameIndex for start of varargs area.</span>
  <span class="kt">int</span> <span class="n">VarArgsFrameIndex</span><span class="p">;</span>

  <span class="kt">unsigned</span> <span class="n">MaxCallFrameSize</span><span class="p">;</span>

  <span class="c1">/// Cpu0CallEntry maps.</span>
  <span class="n">StringMap</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">Cpu0CallEntry</span><span class="o">&gt;&gt;</span> <span class="n">ExternalCallEntries</span><span class="p">;</span>
  <span class="n">ValueMap</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">GlobalValue</span> <span class="o">*</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">Cpu0CallEntry</span><span class="o">&gt;&gt;</span>
      <span class="n">GlobalCallEntries</span><span class="p">;</span>
<span class="p">};</span>
<span class="c1">//@1 }</span>

<span class="p">}</span> <span class="c1">// end of namespace llvm</span>

<span class="cp">#endif </span><span class="c1">// CPU0_MACHINE_FUNCTION_INFO_H</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0MachineFunction.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">//===-- Cpu0MachineFunctionInfo.cpp - Private data used for Cpu0 ----------===//</span>
<span class="c1">//</span>
<span class="c1">//                     The LLVM Compiler Infrastructure</span>
<span class="c1">//</span>
<span class="c1">// This file is distributed under the University of Illinois Open Source</span>
<span class="c1">// License. See LICENSE.TXT for details.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>

<span class="cp">#include &quot;Cpu0MachineFunction.h&quot;</span>

<span class="cp">#include &quot;Cpu0InstrInfo.h&quot;</span>
<span class="cp">#include &quot;Cpu0Subtarget.h&quot;</span>
<span class="cp">#include &quot;llvm/IR/Function.h&quot;</span>
<span class="cp">#include &quot;llvm/CodeGen/MachineInstrBuilder.h&quot;</span>
<span class="cp">#include &quot;llvm/CodeGen/MachineRegisterInfo.h&quot;</span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">llvm</span><span class="p">;</span>

<span class="kt">bool</span> <span class="n">FixGlobalBaseReg</span><span class="p">;</span>

<span class="c1">// class Cpu0CallEntry.</span>
<span class="n">Cpu0CallEntry</span><span class="o">::</span><span class="n">Cpu0CallEntry</span><span class="p">(</span><span class="n">StringRef</span> <span class="n">N</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifndef NDEBUG</span>
  <span class="n">Name</span> <span class="o">=</span> <span class="n">N</span><span class="p">;</span>
  <span class="n">Val</span> <span class="o">=</span> <span class="n">nullptr</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="n">Cpu0CallEntry</span><span class="o">::</span><span class="n">Cpu0CallEntry</span><span class="p">(</span><span class="k">const</span> <span class="n">GlobalValue</span> <span class="o">*</span><span class="n">V</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifndef NDEBUG</span>
  <span class="n">Val</span> <span class="o">=</span> <span class="n">V</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">Cpu0CallEntry</span><span class="o">::</span><span class="n">isConstant</span><span class="p">(</span><span class="k">const</span> <span class="n">MachineFrameInfo</span> <span class="o">*</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">Cpu0CallEntry</span><span class="o">::</span><span class="n">isAliased</span><span class="p">(</span><span class="k">const</span> <span class="n">MachineFrameInfo</span> <span class="o">*</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">Cpu0CallEntry</span><span class="o">::</span><span class="n">mayAlias</span><span class="p">(</span><span class="k">const</span> <span class="n">MachineFrameInfo</span> <span class="o">*</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Cpu0CallEntry</span><span class="o">::</span><span class="n">printCustom</span><span class="p">(</span><span class="n">raw_ostream</span> <span class="o">&amp;</span><span class="n">O</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="n">O</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Cpu0CallEntry: &quot;</span><span class="p">;</span>
<span class="cp">#ifndef NDEBUG</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Val</span><span class="p">)</span>
    <span class="n">O</span> <span class="o">&lt;&lt;</span> <span class="n">Val</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">();</span>
  <span class="k">else</span>
    <span class="n">O</span> <span class="o">&lt;&lt;</span> <span class="n">Name</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="n">Cpu0FunctionInfo</span><span class="o">::~</span><span class="n">Cpu0FunctionInfo</span><span class="p">()</span> <span class="p">{}</span>

<span class="kt">void</span> <span class="n">Cpu0FunctionInfo</span><span class="o">::</span><span class="n">anchor</span><span class="p">()</span> <span class="p">{</span> <span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_1/MCTargetDesc/Cpu0ABIInfo.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">//===---- Cpu0ABIInfo.h - Information about CPU0 ABI&#39;s --------------------===//</span>
<span class="c1">//</span>
<span class="c1">//                     The LLVM Compiler Infrastructure</span>
<span class="c1">//</span>
<span class="c1">// This file is distributed under the University of Illinois Open Source</span>
<span class="c1">// License. See LICENSE.TXT for details.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>

<span class="cp">#ifndef LLVM_LIB_TARGET_CPU0_MCTARGETDESC_CPU0ABIINFO_H</span>
<span class="cp">#define LLVM_LIB_TARGET_CPU0_MCTARGETDESC_CPU0ABIINFO_H</span>

<span class="cp">#include &quot;Cpu0Config.h&quot;</span>

<span class="cp">#include &quot;llvm/ADT/ArrayRef.h&quot;</span>
<span class="cp">#include &quot;llvm/ADT/Triple.h&quot;</span>
<span class="cp">#include &quot;llvm/IR/CallingConv.h&quot;</span>
<span class="cp">#include &quot;llvm/MC/MCRegisterInfo.h&quot;</span>

<span class="k">namespace</span> <span class="n">llvm</span> <span class="p">{</span>

<span class="k">class</span> <span class="nc">MCTargetOptions</span><span class="p">;</span>
<span class="k">class</span> <span class="nc">StringRef</span><span class="p">;</span>
<span class="k">class</span> <span class="nc">TargetRegisterClass</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Cpu0ABIInfo</span> <span class="p">{</span>
<span class="nl">public:</span>
  <span class="k">enum</span> <span class="k">class</span> <span class="nc">ABI</span> <span class="p">{</span> <span class="n">Unknown</span><span class="p">,</span> <span class="n">O32</span><span class="p">,</span> <span class="n">S32</span> <span class="p">};</span>

<span class="nl">protected:</span>
  <span class="n">ABI</span> <span class="n">ThisABI</span><span class="p">;</span>

<span class="nl">public:</span>
  <span class="n">Cpu0ABIInfo</span><span class="p">(</span><span class="n">ABI</span> <span class="n">ThisABI</span><span class="p">)</span> <span class="o">:</span> <span class="n">ThisABI</span><span class="p">(</span><span class="n">ThisABI</span><span class="p">)</span> <span class="p">{}</span>

  <span class="k">static</span> <span class="n">Cpu0ABIInfo</span> <span class="n">Unknown</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">Cpu0ABIInfo</span><span class="p">(</span><span class="n">ABI</span><span class="o">::</span><span class="n">Unknown</span><span class="p">);</span> <span class="p">}</span>
  <span class="k">static</span> <span class="n">Cpu0ABIInfo</span> <span class="n">O32</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">Cpu0ABIInfo</span><span class="p">(</span><span class="n">ABI</span><span class="o">::</span><span class="n">O32</span><span class="p">);</span> <span class="p">}</span>
  <span class="k">static</span> <span class="n">Cpu0ABIInfo</span> <span class="n">S32</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">Cpu0ABIInfo</span><span class="p">(</span><span class="n">ABI</span><span class="o">::</span><span class="n">S32</span><span class="p">);</span> <span class="p">}</span>
  <span class="k">static</span> <span class="n">Cpu0ABIInfo</span> <span class="n">computeTargetABI</span><span class="p">();</span>

  <span class="kt">bool</span> <span class="n">IsKnown</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">ThisABI</span> <span class="o">!=</span> <span class="n">ABI</span><span class="o">::</span><span class="n">Unknown</span><span class="p">;</span> <span class="p">}</span>
  <span class="kt">bool</span> <span class="n">IsO32</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">ThisABI</span> <span class="o">==</span> <span class="n">ABI</span><span class="o">::</span><span class="n">O32</span><span class="p">;</span> <span class="p">}</span>
  <span class="kt">bool</span> <span class="n">IsS32</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">ThisABI</span> <span class="o">==</span> <span class="n">ABI</span><span class="o">::</span><span class="n">S32</span><span class="p">;</span> <span class="p">}</span>
  <span class="n">ABI</span> <span class="n">GetEnumValue</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">ThisABI</span><span class="p">;</span> <span class="p">}</span>

  <span class="c1">/// The registers to use for byval arguments.</span>
  <span class="k">const</span> <span class="n">ArrayRef</span><span class="o">&lt;</span><span class="n">MCPhysReg</span><span class="o">&gt;</span> <span class="n">GetByValArgRegs</span><span class="p">()</span> <span class="k">const</span><span class="p">;</span>

  <span class="c1">/// The registers to use for the variable argument list.</span>
  <span class="k">const</span> <span class="n">ArrayRef</span><span class="o">&lt;</span><span class="n">MCPhysReg</span><span class="o">&gt;</span> <span class="n">GetVarArgRegs</span><span class="p">()</span> <span class="k">const</span><span class="p">;</span>

  <span class="c1">/// Obtain the size of the area allocated by the callee for arguments.</span>
  <span class="c1">/// CallingConv::FastCall affects the value for O32.</span>
  <span class="kt">unsigned</span> <span class="n">GetCalleeAllocdArgSizeInBytes</span><span class="p">(</span><span class="n">CallingConv</span><span class="o">::</span><span class="n">ID</span> <span class="n">CC</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>

  <span class="c1">/// Ordering of ABI&#39;s</span>
  <span class="c1">/// Cpu0GenSubtargetInfo.inc will use this to resolve conflicts when given</span>
  <span class="c1">/// multiple ABI options.</span>
  <span class="kt">bool</span> <span class="k">operator</span><span class="o">&lt;</span><span class="p">(</span><span class="k">const</span> <span class="n">Cpu0ABIInfo</span> <span class="n">Other</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">ThisABI</span> <span class="o">&lt;</span> <span class="n">Other</span><span class="p">.</span><span class="n">GetEnumValue</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="kt">unsigned</span> <span class="n">GetStackPtr</span><span class="p">()</span> <span class="k">const</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="n">GetFramePtr</span><span class="p">()</span> <span class="k">const</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="n">GetNullPtr</span><span class="p">()</span> <span class="k">const</span><span class="p">;</span>

  <span class="kt">unsigned</span> <span class="n">GetEhDataReg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">I</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">EhDataRegSize</span><span class="p">()</span> <span class="k">const</span><span class="p">;</span>
<span class="p">};</span>
<span class="p">}</span>

<span class="cp">#endif</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_1/MCTargetDesc/Cpu0ABIInfo.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">//===---- Cpu0ABIInfo.cpp - Information about CPU0 ABI&#39;s ------------------===//</span>
<span class="c1">//</span>
<span class="c1">//                     The LLVM Compiler Infrastructure</span>
<span class="c1">//</span>
<span class="c1">// This file is distributed under the University of Illinois Open Source</span>
<span class="c1">// License. See LICENSE.TXT for details.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>

<span class="cp">#include &quot;Cpu0Config.h&quot;</span>

<span class="cp">#include &quot;Cpu0ABIInfo.h&quot;</span>
<span class="cp">#include &quot;Cpu0RegisterInfo.h&quot;</span>
<span class="cp">#include &quot;llvm/ADT/StringRef.h&quot;</span>
<span class="cp">#include &quot;llvm/ADT/StringSwitch.h&quot;</span>
<span class="cp">#include &quot;llvm/MC/MCTargetOptions.h&quot;</span>
<span class="cp">#include &quot;llvm/Support/CommandLine.h&quot;</span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">llvm</span><span class="p">;</span>

<span class="k">static</span> <span class="n">cl</span><span class="o">::</span><span class="n">opt</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span>
<span class="n">EnableCpu0S32Calls</span><span class="p">(</span><span class="s">&quot;cpu0-s32-calls&quot;</span><span class="p">,</span> <span class="n">cl</span><span class="o">::</span><span class="n">Hidden</span><span class="p">,</span>
                    <span class="n">cl</span><span class="o">::</span><span class="n">desc</span><span class="p">(</span><span class="s">&quot;CPU0 S32 call: use stack only to pass arguments.\</span>
<span class="s">                    &quot;</span><span class="p">),</span> <span class="n">cl</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="nb">false</span><span class="p">));</span>

<span class="k">namespace</span> <span class="p">{</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">MCPhysReg</span> <span class="n">O32IntRegs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">A0</span><span class="p">,</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">A1</span><span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">MCPhysReg</span> <span class="n">S32IntRegs</span> <span class="o">=</span> <span class="p">{};</span>
<span class="p">}</span>

<span class="k">const</span> <span class="n">ArrayRef</span><span class="o">&lt;</span><span class="n">MCPhysReg</span><span class="o">&gt;</span> <span class="n">Cpu0ABIInfo</span><span class="o">::</span><span class="n">GetByValArgRegs</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">IsO32</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">makeArrayRef</span><span class="p">(</span><span class="n">O32IntRegs</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">IsS32</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">makeArrayRef</span><span class="p">(</span><span class="n">S32IntRegs</span><span class="p">);</span>
  <span class="n">llvm_unreachable</span><span class="p">(</span><span class="s">&quot;Unhandled ABI&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">const</span> <span class="n">ArrayRef</span><span class="o">&lt;</span><span class="n">MCPhysReg</span><span class="o">&gt;</span> <span class="n">Cpu0ABIInfo</span><span class="o">::</span><span class="n">GetVarArgRegs</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">IsO32</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">makeArrayRef</span><span class="p">(</span><span class="n">O32IntRegs</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">IsS32</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">makeArrayRef</span><span class="p">(</span><span class="n">S32IntRegs</span><span class="p">);</span>
  <span class="n">llvm_unreachable</span><span class="p">(</span><span class="s">&quot;Unhandled ABI&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="n">Cpu0ABIInfo</span><span class="o">::</span><span class="n">GetCalleeAllocdArgSizeInBytes</span><span class="p">(</span><span class="n">CallingConv</span><span class="o">::</span><span class="n">ID</span> <span class="n">CC</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">IsO32</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">CC</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">IsS32</span><span class="p">())</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">llvm_unreachable</span><span class="p">(</span><span class="s">&quot;Unhandled ABI&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">Cpu0ABIInfo</span> <span class="n">Cpu0ABIInfo</span><span class="o">::</span><span class="n">computeTargetABI</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">Cpu0ABIInfo</span> <span class="n">abi</span><span class="p">(</span><span class="n">ABI</span><span class="o">::</span><span class="n">Unknown</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">EnableCpu0S32Calls</span><span class="p">)</span>
    <span class="n">abi</span> <span class="o">=</span> <span class="n">ABI</span><span class="o">::</span><span class="n">S32</span><span class="p">;</span>
  <span class="k">else</span>
    <span class="n">abi</span> <span class="o">=</span> <span class="n">ABI</span><span class="o">::</span><span class="n">O32</span><span class="p">;</span>
  <span class="c1">// Assert exactly one ABI was chosen.</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">abi</span><span class="p">.</span><span class="n">ThisABI</span> <span class="o">!=</span> <span class="n">ABI</span><span class="o">::</span><span class="n">Unknown</span><span class="p">);</span>

  <span class="k">return</span> <span class="n">abi</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="n">Cpu0ABIInfo</span><span class="o">::</span><span class="n">GetStackPtr</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">SP</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="n">Cpu0ABIInfo</span><span class="o">::</span><span class="n">GetFramePtr</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">FP</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="n">Cpu0ABIInfo</span><span class="o">::</span><span class="n">GetNullPtr</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">ZERO</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="n">Cpu0ABIInfo</span><span class="o">::</span><span class="n">GetEhDataReg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">I</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="n">EhDataReg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">Cpu0</span><span class="o">::</span><span class="n">A0</span><span class="p">,</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">A1</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="n">EhDataReg</span><span class="p">[</span><span class="n">I</span><span class="p">];</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">Cpu0ABIInfo</span><span class="o">::</span><span class="n">EhDataRegSize</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">ThisABI</span> <span class="o">==</span> <span class="n">ABI</span><span class="o">::</span><span class="n">S32</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">else</span>
    <span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0Subtarget.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="cp">#include &quot;Cpu0FrameLowering.h&quot;</span>
<span class="cp">#include &quot;Cpu0ISelLowering.h&quot;</span>
<span class="cp">#include &quot;Cpu0InstrInfo.h&quot;</span>
<span class="cp">#include &quot;llvm/IR/DataLayout.h&quot;</span>
<span class="cp">#include &quot;llvm/MC/MCInstrItineraries.h&quot;</span>
<span class="cp">#include &quot;llvm/Target/TargetSelectionDAGInfo.h&quot;</span>
<span class="cp">#include &quot;llvm/Target/TargetSubtargetInfo.h&quot;</span>
<span class="cp">#include &lt;string&gt;</span>

<span class="cp">#define GET_SUBTARGETINFO_HEADER</span>
<span class="cp">#include &quot;Cpu0GenSubtargetInfo.inc&quot;</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="k">namespace</span> <span class="n">llvm</span> <span class="p">{</span>
<span class="k">class</span> <span class="nc">StringRef</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Cpu0TargetMachine</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Cpu0Subtarget</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Cpu0GenSubtargetInfo</span> <span class="p">{</span>
  <span class="k">virtual</span> <span class="kt">void</span> <span class="n">anchor</span><span class="p">();</span>

<span class="nl">public:</span>

  <span class="kt">bool</span> <span class="n">HasChapterDummy</span><span class="p">;</span>
  <span class="kt">bool</span> <span class="n">HasChapterAll</span><span class="p">;</span>

  <span class="kt">bool</span> <span class="n">hasChapter3_1</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
<span class="cp">#if CH &gt;= CH3_1</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="cp">#else</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="cp">#endif</span>
  <span class="p">}</span>

  <span class="kt">bool</span> <span class="n">hasChapter3_2</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
<span class="cp">#if CH &gt;= CH3_2</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="cp">#else</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="cp">#endif</span>
  <span class="p">}</span>

  <span class="kt">bool</span> <span class="n">hasChapter3_3</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
<span class="cp">#if CH &gt;= CH3_3</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="cp">#else</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="cp">#endif</span>
  <span class="p">}</span>

  <span class="kt">bool</span> <span class="n">hasChapter3_4</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
<span class="cp">#if CH &gt;= CH3_4</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="cp">#else</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="cp">#endif</span>
  <span class="p">}</span>

  <span class="kt">bool</span> <span class="n">hasChapter3_5</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
<span class="cp">#if CH &gt;= CH3_5</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="cp">#else</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="cp">#endif</span>
  <span class="p">}</span>

  <span class="kt">bool</span> <span class="n">hasChapter4_1</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
<span class="cp">#if CH &gt;= CH4_1</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="cp">#else</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="cp">#endif</span>
  <span class="p">}</span>

  <span class="kt">bool</span> <span class="n">hasChapter4_2</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
<span class="cp">#if CH &gt;= CH4_2</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="cp">#else</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="cp">#endif</span>
  <span class="p">}</span>

  <span class="kt">bool</span> <span class="n">hasChapter5_1</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
<span class="cp">#if CH &gt;= CH5_1</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="cp">#else</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="cp">#endif</span>
  <span class="p">}</span>

  <span class="kt">bool</span> <span class="n">hasChapter6_1</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
<span class="cp">#if CH &gt;= CH6_1</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="cp">#else</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="cp">#endif</span>
  <span class="p">}</span>

  <span class="kt">bool</span> <span class="n">hasChapter7_1</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
<span class="cp">#if CH &gt;= CH7_1</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="cp">#else</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="cp">#endif</span>
  <span class="p">}</span>

  <span class="kt">bool</span> <span class="n">hasChapter8_1</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
<span class="cp">#if CH &gt;= CH8_1</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="cp">#else</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="cp">#endif</span>
  <span class="p">}</span>

  <span class="kt">bool</span> <span class="n">hasChapter8_2</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
<span class="cp">#if CH &gt;= CH8_2</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="cp">#else</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="cp">#endif</span>
  <span class="p">}</span>
  
  <span class="kt">bool</span> <span class="n">hasChapter9_1</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
<span class="cp">#if CH &gt;= CH9_1</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="cp">#else</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="cp">#endif</span>
  <span class="p">}</span>

  <span class="kt">bool</span> <span class="n">hasChapter9_2</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
<span class="cp">#if CH &gt;= CH9_2</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="cp">#else</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="cp">#endif</span>
  <span class="p">}</span>

  <span class="kt">bool</span> <span class="n">hasChapter9_3</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
<span class="cp">#if CH &gt;= CH9_3</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="cp">#else</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="cp">#endif</span>
  <span class="p">}</span>

  <span class="kt">bool</span> <span class="n">hasChapter10_1</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
<span class="cp">#if CH &gt;= CH10_1</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="cp">#else</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="cp">#endif</span>
  <span class="p">}</span>

  <span class="kt">bool</span> <span class="n">hasChapter11_1</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
<span class="cp">#if CH &gt;= CH11_1</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="cp">#else</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="cp">#endif</span>
  <span class="p">}</span>

  <span class="kt">bool</span> <span class="n">hasChapter11_2</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
<span class="cp">#if CH &gt;= CH11_2</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="cp">#else</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="cp">#endif</span>
  <span class="p">}</span>

  <span class="kt">bool</span> <span class="n">hasChapter12_1</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
<span class="cp">#if CH &gt;= CH12_1</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="cp">#else</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="cp">#endif</span>
  <span class="p">}</span>

<span class="nl">protected:</span>
  <span class="k">enum</span> <span class="n">Cpu0ArchEnum</span> <span class="p">{</span>
    <span class="n">Cpu032I</span><span class="p">,</span>
    <span class="n">Cpu032II</span>
  <span class="p">};</span>

  <span class="c1">// Cpu0 architecture version</span>
  <span class="n">Cpu0ArchEnum</span> <span class="n">Cpu0ArchVersion</span><span class="p">;</span>

  <span class="c1">// IsLittle - The target is Little Endian</span>
  <span class="kt">bool</span> <span class="n">IsLittle</span><span class="p">;</span>

  <span class="kt">bool</span> <span class="n">EnableOverflow</span><span class="p">;</span>

  <span class="c1">// HasCmp - cmp instructions.</span>
  <span class="kt">bool</span> <span class="n">HasCmp</span><span class="p">;</span>

  <span class="c1">// HasSlt - slt instructions.</span>
  <span class="kt">bool</span> <span class="n">HasSlt</span><span class="p">;</span>

  <span class="n">InstrItineraryData</span> <span class="n">InstrItins</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="k">const</span> <span class="n">Cpu0TargetMachine</span> <span class="o">&amp;</span><span class="n">TM</span><span class="p">;</span>

  <span class="n">Triple</span> <span class="n">TargetTriple</span><span class="p">;</span>

  <span class="k">const</span> <span class="n">TargetSelectionDAGInfo</span> <span class="n">TSInfo</span><span class="p">;</span>

  <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">Cpu0InstrInfo</span><span class="o">&gt;</span> <span class="n">InstrInfo</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">Cpu0FrameLowering</span><span class="o">&gt;</span> <span class="n">FrameLowering</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">Cpu0TargetLowering</span><span class="o">&gt;</span> <span class="n">TLInfo</span><span class="p">;</span>

<span class="nl">public:</span>
  <span class="k">const</span> <span class="n">Cpu0ABIInfo</span> <span class="o">&amp;</span><span class="n">getABI</span><span class="p">()</span> <span class="k">const</span><span class="p">;</span>

  <span class="c1">/// This constructor initializes the data members to match that</span>
  <span class="c1">/// of the specified triple.</span>
  <span class="n">Cpu0Subtarget</span><span class="p">(</span><span class="k">const</span> <span class="n">Triple</span> <span class="o">&amp;</span><span class="n">TT</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">CPU</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">FS</span><span class="p">,</span>
                <span class="kt">bool</span> <span class="n">little</span><span class="p">,</span> <span class="k">const</span> <span class="n">Cpu0TargetMachine</span> <span class="o">&amp;</span><span class="n">_TM</span><span class="p">);</span>

<span class="c1">//- Vitual function, must have</span>
  <span class="c1">/// ParseSubtargetFeatures - Parses features string setting specified</span>
  <span class="c1">/// subtarget options.  Definition of function is auto generated by tblgen.</span>
  <span class="kt">void</span> <span class="nf">ParseSubtargetFeatures</span><span class="p">(</span><span class="n">StringRef</span> <span class="n">CPU</span><span class="p">,</span> <span class="n">StringRef</span> <span class="n">FS</span><span class="p">);</span>

  <span class="kt">bool</span> <span class="n">isLittle</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">IsLittle</span><span class="p">;</span> <span class="p">}</span>
  <span class="kt">bool</span> <span class="n">hasCpu032I</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">Cpu0ArchVersion</span> <span class="o">&gt;=</span> <span class="n">Cpu032I</span><span class="p">;</span> <span class="p">}</span>
  <span class="kt">bool</span> <span class="n">isCpu032I</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">Cpu0ArchVersion</span> <span class="o">==</span> <span class="n">Cpu032I</span><span class="p">;</span> <span class="p">}</span>
  <span class="kt">bool</span> <span class="n">hasCpu032II</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">Cpu0ArchVersion</span> <span class="o">&gt;=</span> <span class="n">Cpu032II</span><span class="p">;</span> <span class="p">}</span>
  <span class="kt">bool</span> <span class="n">isCpu032II</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">Cpu0ArchVersion</span> <span class="o">==</span> <span class="n">Cpu032II</span><span class="p">;</span> <span class="p">}</span>

  <span class="c1">/// Features related to the presence of specific instructions.</span>
  <span class="kt">bool</span> <span class="n">enableOverflow</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">EnableOverflow</span><span class="p">;</span> <span class="p">}</span>
  <span class="kt">bool</span> <span class="n">disableOverflow</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="o">!</span><span class="n">EnableOverflow</span><span class="p">;</span> <span class="p">}</span>
  <span class="kt">bool</span> <span class="n">hasCmp</span><span class="p">()</span>   <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">HasCmp</span><span class="p">;</span> <span class="p">}</span>
  <span class="kt">bool</span> <span class="n">hasSlt</span><span class="p">()</span>   <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">HasSlt</span><span class="p">;</span> <span class="p">}</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="kt">bool</span> <span class="n">abiUsesSoftFloat</span><span class="p">()</span> <span class="k">const</span><span class="p">;</span>

  <span class="kt">bool</span> <span class="nf">enableLongBranchPass</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">hasCpu032II</span><span class="p">();</span>
  <span class="p">}</span>
  
  <span class="kt">unsigned</span> <span class="n">stackAlignment</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">8</span><span class="p">;</span> <span class="p">}</span>

  <span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">initializeSubtargetDependencies</span><span class="p">(</span><span class="n">StringRef</span> <span class="n">CPU</span><span class="p">,</span> <span class="n">StringRef</span> <span class="n">FS</span><span class="p">,</span>
                                                 <span class="k">const</span> <span class="n">TargetMachine</span> <span class="o">&amp;</span><span class="n">TM</span><span class="p">);</span>

  <span class="k">const</span> <span class="n">TargetSelectionDAGInfo</span> <span class="o">*</span><span class="n">getSelectionDAGInfo</span><span class="p">()</span> <span class="k">const</span> <span class="n">override</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="n">TSInfo</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">const</span> <span class="n">Cpu0InstrInfo</span> <span class="o">*</span><span class="n">getInstrInfo</span><span class="p">()</span> <span class="k">const</span> <span class="n">override</span> <span class="p">{</span> <span class="k">return</span> <span class="n">InstrInfo</span><span class="p">.</span><span class="n">get</span><span class="p">();</span> <span class="p">}</span>
  <span class="k">const</span> <span class="n">TargetFrameLowering</span> <span class="o">*</span><span class="n">getFrameLowering</span><span class="p">()</span> <span class="k">const</span> <span class="n">override</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">FrameLowering</span><span class="p">.</span><span class="n">get</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="k">const</span> <span class="n">Cpu0RegisterInfo</span> <span class="o">*</span><span class="n">getRegisterInfo</span><span class="p">()</span> <span class="k">const</span> <span class="n">override</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="n">InstrInfo</span><span class="o">-&gt;</span><span class="n">getRegisterInfo</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="k">const</span> <span class="n">Cpu0TargetLowering</span> <span class="o">*</span><span class="n">getTargetLowering</span><span class="p">()</span> <span class="k">const</span> <span class="n">override</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">TLInfo</span><span class="p">.</span><span class="n">get</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="k">const</span> <span class="n">InstrItineraryData</span> <span class="o">*</span><span class="n">getInstrItineraryData</span><span class="p">()</span> <span class="k">const</span> <span class="n">override</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="n">InstrItins</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>
<span class="p">}</span> <span class="c1">// End llvm namespace</span>


<span class="cp">#endif</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0Subtarget.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">//===-- Cpu0Subtarget.cpp - Cpu0 Subtarget Information --------------------===//</span>
<span class="c1">//</span>
<span class="c1">//                     The LLVM Compiler Infrastructure</span>
<span class="c1">//</span>
<span class="c1">// This file is distributed under the University of Illinois Open Source</span>
<span class="c1">// License. See LICENSE.TXT for details.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="c1">//</span>
<span class="c1">// This file implements the Cpu0 specific subclass of TargetSubtargetInfo.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>

<span class="cp">#include &quot;Cpu0Subtarget.h&quot;</span>

<span class="cp">#include &quot;Cpu0MachineFunction.h&quot;</span>
<span class="cp">#include &quot;Cpu0.h&quot;</span>
<span class="cp">#include &quot;Cpu0RegisterInfo.h&quot;</span>

<span class="cp">#include &quot;Cpu0TargetMachine.h&quot;</span>
<span class="cp">#include &quot;llvm/IR/Attributes.h&quot;</span>
<span class="cp">#include &quot;llvm/IR/Function.h&quot;</span>
<span class="cp">#include &quot;llvm/Support/CommandLine.h&quot;</span>
<span class="cp">#include &quot;llvm/Support/ErrorHandling.h&quot;</span>
<span class="cp">#include &quot;llvm/Support/TargetRegistry.h&quot;</span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">llvm</span><span class="p">;</span>

<span class="cp">#define DEBUG_TYPE &quot;cpu0-subtarget&quot;</span>

<span class="cp">#define GET_SUBTARGETINFO_TARGET_DESC</span>
<span class="cp">#define GET_SUBTARGETINFO_CTOR</span>
<span class="cp">#include &quot;Cpu0GenSubtargetInfo.inc&quot;</span>

<span class="k">extern</span> <span class="kt">bool</span> <span class="n">FixGlobalBaseReg</span><span class="p">;</span>

<span class="c1">/// Select the Cpu0 CPU for the given triple and cpu name.</span>
<span class="c1">/// FIXME: Merge with the copy in Cpu0MCTargetDesc.cpp</span>
<span class="k">static</span> <span class="n">StringRef</span> <span class="nf">selectCpu0CPU</span><span class="p">(</span><span class="n">Triple</span> <span class="n">TT</span><span class="p">,</span> <span class="n">StringRef</span> <span class="n">CPU</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">CPU</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="o">||</span> <span class="n">CPU</span> <span class="o">==</span> <span class="s">&quot;generic&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">TT</span><span class="p">.</span><span class="n">getArch</span><span class="p">()</span> <span class="o">==</span> <span class="n">Triple</span><span class="o">::</span><span class="n">cpu0</span> <span class="o">||</span> <span class="n">TT</span><span class="p">.</span><span class="n">getArch</span><span class="p">()</span> <span class="o">==</span> <span class="n">Triple</span><span class="o">::</span><span class="n">cpu0el</span><span class="p">)</span>
      <span class="n">CPU</span> <span class="o">=</span> <span class="s">&quot;cpu032II&quot;</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">CPU</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Cpu0Subtarget</span><span class="o">::</span><span class="n">anchor</span><span class="p">()</span> <span class="p">{</span> <span class="p">}</span>

<span class="c1">//@1 {</span>
<span class="n">Cpu0Subtarget</span><span class="o">::</span><span class="n">Cpu0Subtarget</span><span class="p">(</span><span class="k">const</span> <span class="n">Triple</span> <span class="o">&amp;</span><span class="n">TT</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">CPU</span><span class="p">,</span>
                             <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">FS</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">little</span><span class="p">,</span> 
                             <span class="k">const</span> <span class="n">Cpu0TargetMachine</span> <span class="o">&amp;</span><span class="n">_TM</span><span class="p">)</span> <span class="o">:</span>
<span class="c1">//@1 }</span>
  <span class="c1">// Cpu0GenSubtargetInfo will display features by llc -march=cpu0 -mcpu=help</span>
  <span class="n">Cpu0GenSubtargetInfo</span><span class="p">(</span><span class="n">TT</span><span class="p">,</span> <span class="n">CPU</span><span class="p">,</span> <span class="n">FS</span><span class="p">),</span>
  <span class="n">IsLittle</span><span class="p">(</span><span class="n">little</span><span class="p">),</span> <span class="n">TM</span><span class="p">(</span><span class="n">_TM</span><span class="p">),</span> <span class="n">TargetTriple</span><span class="p">(</span><span class="n">TT</span><span class="p">),</span> <span class="n">TSInfo</span><span class="p">(),</span>
      <span class="n">InstrInfo</span><span class="p">(</span>
          <span class="n">Cpu0InstrInfo</span><span class="o">::</span><span class="n">create</span><span class="p">(</span><span class="n">initializeSubtargetDependencies</span><span class="p">(</span><span class="n">CPU</span><span class="p">,</span> <span class="n">FS</span><span class="p">,</span> <span class="n">TM</span><span class="p">))),</span>
      <span class="n">FrameLowering</span><span class="p">(</span><span class="n">Cpu0FrameLowering</span><span class="o">::</span><span class="n">create</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">)),</span>
      <span class="n">TLInfo</span><span class="p">(</span><span class="n">Cpu0TargetLowering</span><span class="o">::</span><span class="n">create</span><span class="p">(</span><span class="n">TM</span><span class="p">,</span> <span class="o">*</span><span class="k">this</span><span class="p">))</span> <span class="p">{</span>

<span class="p">}</span>

<span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span>
<span class="n">Cpu0Subtarget</span><span class="o">::</span><span class="n">initializeSubtargetDependencies</span><span class="p">(</span><span class="n">StringRef</span> <span class="n">CPU</span><span class="p">,</span> <span class="n">StringRef</span> <span class="n">FS</span><span class="p">,</span>
                                               <span class="k">const</span> <span class="n">TargetMachine</span> <span class="o">&amp;</span><span class="n">TM</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">CPUName</span> <span class="o">=</span> <span class="n">selectCpu0CPU</span><span class="p">(</span><span class="n">TargetTriple</span><span class="p">,</span> <span class="n">CPU</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">CPUName</span> <span class="o">==</span> <span class="s">&quot;help&quot;</span><span class="p">)</span>
    <span class="n">CPUName</span> <span class="o">=</span> <span class="s">&quot;cpu032II&quot;</span><span class="p">;</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="n">CPUName</span> <span class="o">==</span> <span class="s">&quot;cpu032I&quot;</span><span class="p">)</span>
    <span class="n">Cpu0ArchVersion</span> <span class="o">=</span> <span class="n">Cpu032I</span><span class="p">;</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CPUName</span> <span class="o">==</span> <span class="s">&quot;cpu032II&quot;</span><span class="p">)</span>
    <span class="n">Cpu0ArchVersion</span> <span class="o">=</span> <span class="n">Cpu032II</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">isCpu032I</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">HasCmp</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="n">HasSlt</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">isCpu032II</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">HasCmp</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="n">HasSlt</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="n">errs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;-mcpu must be empty(default:cpu032II), cpu032I or cpu032II&quot;</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// Parse features string.</span>
  <span class="n">ParseSubtargetFeatures</span><span class="p">(</span><span class="n">CPUName</span><span class="p">,</span> <span class="n">FS</span><span class="p">);</span>
  <span class="c1">// Initialize scheduling itinerary for the specified CPU.</span>
  <span class="n">InstrItins</span> <span class="o">=</span> <span class="n">getInstrItineraryForCPU</span><span class="p">(</span><span class="n">CPUName</span><span class="p">);</span>

  <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">Cpu0Subtarget</span><span class="o">::</span><span class="n">abiUsesSoftFloat</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
<span class="c1">//  return TM-&gt;Options.UseSoftFloat;</span>
  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">const</span> <span class="n">Cpu0ABIInfo</span> <span class="o">&amp;</span><span class="n">Cpu0Subtarget</span><span class="o">::</span><span class="n">getABI</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">TM</span><span class="p">.</span><span class="n">getABI</span><span class="p">();</span> <span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0RegisterInfo.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">//===-- Cpu0RegisterInfo.h - Cpu0 Register Information Impl -----*- C++ -*-===//</span>
<span class="c1">//</span>
<span class="c1">//                     The LLVM Compiler Infrastructure</span>
<span class="c1">//</span>
<span class="c1">// This file is distributed under the University of Illinois Open Source</span>
<span class="c1">// License. See LICENSE.TXT for details.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="c1">//</span>
<span class="c1">// This file contains the Cpu0 implementation of the TargetRegisterInfo class.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>

<span class="cp">#ifndef LLVM_LIB_TARGET_CPU0_CPU0REGISTERINFO_H</span>
<span class="cp">#define LLVM_LIB_TARGET_CPU0_CPU0REGISTERINFO_H</span>

<span class="cp">#include &quot;Cpu0Config.h&quot;</span>

<span class="cp">#include &quot;Cpu0.h&quot;</span>
<span class="cp">#include &quot;llvm/Target/TargetRegisterInfo.h&quot;</span>

<span class="cp">#define GET_REGINFO_HEADER</span>
<span class="cp">#include &quot;Cpu0GenRegisterInfo.inc&quot;</span>

<span class="k">namespace</span> <span class="n">llvm</span> <span class="p">{</span>
<span class="k">class</span> <span class="nc">Cpu0Subtarget</span><span class="p">;</span>
<span class="k">class</span> <span class="nc">TargetInstrInfo</span><span class="p">;</span>
<span class="k">class</span> <span class="nc">Type</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Cpu0RegisterInfo</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Cpu0GenRegisterInfo</span> <span class="p">{</span>
<span class="nl">protected:</span>
  <span class="k">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">Subtarget</span><span class="p">;</span>

<span class="nl">public:</span>
  <span class="n">Cpu0RegisterInfo</span><span class="p">(</span><span class="k">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">Subtarget</span><span class="p">);</span>

  <span class="k">const</span> <span class="n">MCPhysReg</span> <span class="o">*</span><span class="n">getCalleeSavedRegs</span><span class="p">(</span><span class="k">const</span> <span class="n">MachineFunction</span> <span class="o">*</span><span class="n">MF</span><span class="p">)</span> <span class="k">const</span> <span class="n">override</span><span class="p">;</span>

  <span class="k">const</span> <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">getCallPreservedMask</span><span class="p">(</span><span class="k">const</span> <span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">MF</span><span class="p">,</span>
                                       <span class="n">CallingConv</span><span class="o">::</span><span class="n">ID</span><span class="p">)</span> <span class="k">const</span> <span class="n">override</span><span class="p">;</span>

  <span class="n">BitVector</span> <span class="n">getReservedRegs</span><span class="p">(</span><span class="k">const</span> <span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">MF</span><span class="p">)</span> <span class="k">const</span> <span class="n">override</span><span class="p">;</span>

  <span class="kt">bool</span> <span class="n">requiresRegisterScavenging</span><span class="p">(</span><span class="k">const</span> <span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">MF</span><span class="p">)</span> <span class="k">const</span> <span class="n">override</span><span class="p">;</span>

  <span class="kt">bool</span> <span class="n">trackLivenessAfterRegAlloc</span><span class="p">(</span><span class="k">const</span> <span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">MF</span><span class="p">)</span> <span class="k">const</span> <span class="n">override</span><span class="p">;</span>

  <span class="c1">/// Stack Frame Processing Methods</span>
  <span class="kt">void</span> <span class="n">eliminateFrameIndex</span><span class="p">(</span><span class="n">MachineBasicBlock</span><span class="o">::</span><span class="n">iterator</span> <span class="n">II</span><span class="p">,</span>
                           <span class="kt">int</span> <span class="n">SPAdj</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">FIOperandNum</span><span class="p">,</span>
                           <span class="n">RegScavenger</span> <span class="o">*</span><span class="n">RS</span> <span class="o">=</span> <span class="n">nullptr</span><span class="p">)</span> <span class="k">const</span> <span class="n">override</span><span class="p">;</span>

  <span class="c1">/// Debug information queries.</span>
  <span class="kt">unsigned</span> <span class="n">getFrameRegister</span><span class="p">(</span><span class="k">const</span> <span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">MF</span><span class="p">)</span> <span class="k">const</span> <span class="n">override</span><span class="p">;</span>

  <span class="c1">/// \brief Return GPR register class.</span>
  <span class="k">virtual</span> <span class="k">const</span> <span class="n">TargetRegisterClass</span> <span class="o">*</span><span class="n">intRegClass</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">Size</span><span class="p">)</span> <span class="k">const</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">};</span>

<span class="p">}</span> <span class="c1">// end namespace llvm</span>

<span class="cp">#endif</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0RegisterInfo.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">//===-- Cpu0RegisterInfo.cpp - CPU0 Register Information -== --------------===//</span>
<span class="c1">//</span>
<span class="c1">//                     The LLVM Compiler Infrastructure</span>
<span class="c1">//</span>
<span class="c1">// This file is distributed under the University of Illinois Open Source</span>
<span class="c1">// License. See LICENSE.TXT for details.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="c1">//</span>
<span class="c1">// This file contains the CPU0 implementation of the TargetRegisterInfo class.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>

<span class="cp">#define DEBUG_TYPE &quot;cpu0-reg-info&quot;</span>

<span class="cp">#include &quot;Cpu0RegisterInfo.h&quot;</span>

<span class="cp">#include &quot;Cpu0.h&quot;</span>
<span class="cp">#include &quot;Cpu0Subtarget.h&quot;</span>
<span class="cp">#include &quot;Cpu0MachineFunction.h&quot;</span>
<span class="cp">#include &quot;llvm/IR/Function.h&quot;</span>
<span class="cp">#include &quot;llvm/IR/Type.h&quot;</span>
<span class="cp">#include &quot;llvm/Support/CommandLine.h&quot;</span>
<span class="cp">#include &quot;llvm/Support/Debug.h&quot;</span>
<span class="cp">#include &quot;llvm/Support/ErrorHandling.h&quot;</span>
<span class="cp">#include &quot;llvm/Support/raw_ostream.h&quot;</span>

<span class="cp">#define GET_REGINFO_TARGET_DESC</span>
<span class="cp">#include &quot;Cpu0GenRegisterInfo.inc&quot;</span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">llvm</span><span class="p">;</span>

<span class="n">Cpu0RegisterInfo</span><span class="o">::</span><span class="n">Cpu0RegisterInfo</span><span class="p">(</span><span class="k">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">ST</span><span class="p">)</span>
  <span class="o">:</span> <span class="n">Cpu0GenRegisterInfo</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">LR</span><span class="p">),</span> <span class="n">Subtarget</span><span class="p">(</span><span class="n">ST</span><span class="p">)</span> <span class="p">{}</span>

<span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="c1">// Callee Saved Registers methods</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="c1">/// Cpu0 Callee Saved Registers</span>
<span class="c1">// In Cpu0CallConv.td,</span>
<span class="c1">// def CSR_O32 : CalleeSavedRegs&lt;(add LR, FP,</span>
<span class="c1">//                                   (sequence &quot;S%u&quot;, 2, 0))&gt;;</span>
<span class="c1">// llc create CSR_O32_SaveList and CSR_O32_RegMask from above defined.</span>
<span class="k">const</span> <span class="n">MCPhysReg</span> <span class="o">*</span>
<span class="n">Cpu0RegisterInfo</span><span class="o">::</span><span class="n">getCalleeSavedRegs</span><span class="p">(</span><span class="k">const</span> <span class="n">MachineFunction</span> <span class="o">*</span><span class="n">MF</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">CSR_O32_SaveList</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">const</span> <span class="kt">uint32_t</span> <span class="o">*</span>
<span class="n">Cpu0RegisterInfo</span><span class="o">::</span><span class="n">getCallPreservedMask</span><span class="p">(</span><span class="k">const</span> <span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">MF</span><span class="p">,</span>
                                       <span class="n">CallingConv</span><span class="o">::</span><span class="n">ID</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">CSR_O32_RegMask</span><span class="p">;</span> 
<span class="p">}</span>

<span class="c1">// pure virtual method</span>
<span class="c1">//@getReservedRegs {</span>
<span class="n">BitVector</span> <span class="n">Cpu0RegisterInfo</span><span class="o">::</span>
<span class="n">getReservedRegs</span><span class="p">(</span><span class="k">const</span> <span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">MF</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
<span class="c1">//@getReservedRegs body {</span>
  <span class="k">static</span> <span class="k">const</span> <span class="kt">uint16_t</span> <span class="n">ReservedCPURegs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">Cpu0</span><span class="o">::</span><span class="n">ZERO</span><span class="p">,</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">AT</span><span class="p">,</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">SP</span><span class="p">,</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">LR</span><span class="p">,</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">PC</span>
  <span class="p">};</span>
  <span class="n">BitVector</span> <span class="nf">Reserved</span><span class="p">(</span><span class="n">getNumRegs</span><span class="p">());</span>

  <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="n">I</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">I</span> <span class="o">&lt;</span> <span class="n">array_lengthof</span><span class="p">(</span><span class="n">ReservedCPURegs</span><span class="p">);</span> <span class="o">++</span><span class="n">I</span><span class="p">)</span>
    <span class="n">Reserved</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="n">ReservedCPURegs</span><span class="p">[</span><span class="n">I</span><span class="p">]);</span>

  <span class="k">return</span> <span class="n">Reserved</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">//@eliminateFrameIndex {</span>
<span class="c1">//- If no eliminateFrameIndex(), it will hang on run. </span>
<span class="c1">// pure virtual method</span>
<span class="c1">// FrameIndex represent objects inside a abstract stack.</span>
<span class="c1">// We must replace FrameIndex with an stack/frame pointer</span>
<span class="c1">// direct reference.</span>
<span class="kt">void</span> <span class="n">Cpu0RegisterInfo</span><span class="o">::</span>
<span class="n">eliminateFrameIndex</span><span class="p">(</span><span class="n">MachineBasicBlock</span><span class="o">::</span><span class="n">iterator</span> <span class="n">II</span><span class="p">,</span> <span class="kt">int</span> <span class="n">SPAdj</span><span class="p">,</span>
                    <span class="kt">unsigned</span> <span class="n">FIOperandNum</span><span class="p">,</span> <span class="n">RegScavenger</span> <span class="o">*</span><span class="n">RS</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
<span class="p">}</span>
<span class="c1">//}</span>

<span class="kt">bool</span>
<span class="n">Cpu0RegisterInfo</span><span class="o">::</span><span class="n">requiresRegisterScavenging</span><span class="p">(</span><span class="k">const</span> <span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">MF</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span>
<span class="n">Cpu0RegisterInfo</span><span class="o">::</span><span class="n">trackLivenessAfterRegAlloc</span><span class="p">(</span><span class="k">const</span> <span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">MF</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// pure virtual method</span>
<span class="kt">unsigned</span> <span class="n">Cpu0RegisterInfo</span><span class="o">::</span>
<span class="n">getFrameRegister</span><span class="p">(</span><span class="k">const</span> <span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">MF</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="k">const</span> <span class="n">TargetFrameLowering</span> <span class="o">*</span><span class="n">TFI</span> <span class="o">=</span> <span class="n">MF</span><span class="p">.</span><span class="n">getSubtarget</span><span class="p">().</span><span class="n">getFrameLowering</span><span class="p">();</span>
  <span class="k">return</span> <span class="n">TFI</span><span class="o">-&gt;</span><span class="n">hasFP</span><span class="p">(</span><span class="n">MF</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">FP</span><span class="p">)</span> <span class="o">:</span>
                          <span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">SP</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0SERegisterInfo.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">//===-- Cpu0SERegisterInfo.h - Cpu032 Register Information ------*- C++ -*-===//</span>
<span class="c1">//</span>
<span class="c1">//                     The LLVM Compiler Infrastructure</span>
<span class="c1">//</span>
<span class="c1">// This file is distributed under the University of Illinois Open Source</span>
<span class="c1">// License. See LICENSE.TXT for details.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="c1">//</span>
<span class="c1">// This file contains the Cpu032/64 implementation of the TargetRegisterInfo</span>
<span class="c1">// class.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>

<span class="cp">#ifndef LLVM_LIB_TARGET_CPU0_CPU0SEREGISTERINFO_H</span>
<span class="cp">#define LLVM_LIB_TARGET_CPU0_CPU0SEREGISTERINFO_H</span>

<span class="cp">#include &quot;Cpu0Config.h&quot;</span>

<span class="cp">#include &quot;Cpu0RegisterInfo.h&quot;</span>

<span class="k">namespace</span> <span class="n">llvm</span> <span class="p">{</span>
<span class="k">class</span> <span class="nc">Cpu0SEInstrInfo</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Cpu0SERegisterInfo</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Cpu0RegisterInfo</span> <span class="p">{</span>
<span class="nl">public:</span>
  <span class="n">Cpu0SERegisterInfo</span><span class="p">(</span><span class="k">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">Subtarget</span><span class="p">);</span>

  <span class="k">const</span> <span class="n">TargetRegisterClass</span> <span class="o">*</span><span class="n">intRegClass</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">Size</span><span class="p">)</span> <span class="k">const</span> <span class="n">override</span><span class="p">;</span>
<span class="p">};</span>

<span class="p">}</span> <span class="c1">// end namespace llvm</span>

<span class="cp">#endif</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0SERegisterInfo.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">//===-- Cpu0SERegisterInfo.cpp - CPU0 Register Information ------== -------===//</span>
<span class="c1">//</span>
<span class="c1">//                     The LLVM Compiler Infrastructure</span>
<span class="c1">//</span>
<span class="c1">// This file is distributed under the University of Illinois Open Source</span>
<span class="c1">// License. See LICENSE.TXT for details.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="c1">//</span>
<span class="c1">// This file contains the CPU0 implementation of the TargetRegisterInfo</span>
<span class="c1">// class.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>

<span class="cp">#include &quot;Cpu0SERegisterInfo.h&quot;</span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">llvm</span><span class="p">;</span>

<span class="cp">#define DEBUG_TYPE &quot;cpu0-reg-info&quot;</span>

<span class="n">Cpu0SERegisterInfo</span><span class="o">::</span><span class="n">Cpu0SERegisterInfo</span><span class="p">(</span><span class="k">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">ST</span><span class="p">)</span>
  <span class="o">:</span> <span class="n">Cpu0RegisterInfo</span><span class="p">(</span><span class="n">ST</span><span class="p">)</span> <span class="p">{}</span>

<span class="k">const</span> <span class="n">TargetRegisterClass</span> <span class="o">*</span>
<span class="n">Cpu0SERegisterInfo</span><span class="o">::</span><span class="n">intRegClass</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">Size</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="k">return</span> <span class="o">&amp;</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">CPURegsRegClass</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">cmake_debug_build/lib/Target/Cpu0/Cpu0GenInstInfo.inc</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">//- Cpu0GenInstInfo.inc which generate from Cpu0InstrInfo.td</span>
<span class="cp">#ifdef GET_INSTRINFO_HEADER</span>
<span class="cp">#undef GET_INSTRINFO_HEADER</span>
<span class="k">namespace</span> <span class="n">llvm</span> <span class="p">{</span>
<span class="k">struct</span> <span class="n">Cpu0GenInstrInfo</span> <span class="o">:</span> <span class="k">public</span> <span class="n">TargetInstrInfoImpl</span> <span class="p">{</span>
  <span class="k">explicit</span> <span class="n">Cpu0GenInstrInfo</span><span class="p">(</span><span class="kt">int</span> <span class="n">SO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">DO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="p">};</span>
<span class="p">}</span> <span class="c1">// End llvm namespace</span>
<span class="cp">#endif </span><span class="c1">// GET_INSTRINFO_HEADER</span>

<span class="cp">#define GET_INSTRINFO_HEADER</span>
<span class="cp">#include &quot;Cpu0GenInstrInfo.inc&quot;</span>
<span class="c1">//- Cpu0InstInfo.h</span>
<span class="k">class</span> <span class="nc">Cpu0InstrInfo</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Cpu0GenInstrInfo</span> <span class="p">{</span>
  <span class="n">Cpu0TargetMachine</span> <span class="o">&amp;</span><span class="n">TM</span><span class="p">;</span>
<span class="nl">public:</span>
  <span class="k">explicit</span> <span class="nf">Cpu0InstrInfo</span><span class="p">(</span><span class="n">Cpu0TargetMachine</span> <span class="o">&amp;</span><span class="n">TM</span><span class="p">);</span>
<span class="p">};</span>
</pre></div>
</div>
<div class="figure align-center" id="backendstructure-f1">
<img alt="_images/11.png" src="_images/11.png" />
<p class="caption">Figure 1: Cpu0 backend class access link</p>
</div>
<p>Chapter3_1 add most Cpu0 backend classes. The code of Chapter3_1 can be
summaried as <a class="pageref" href="#backendstructure-f1">Figure  1</a>.
Class Cpu0Subtarget supply the interface getInstrInfo(), getFrameLowering(),
..., to get other Cpu0 classes.
Most classes (like Cpu0InstrInfo, Cpu0RegisterInfo, ...) have Subtarget
reference member to allowing them access other classes through the Cpu0Subtarget
interface.
Classes can access Subtarget class through Cpu0TargetMachine (usually use TM as
symbol) by static_cast&lt;Cpu0TargetMachine &amp;&gt;(TM).getSubtargetImpl().
Once getting Subtarget class, the backend code can access other classes through
it.
For those classes name of Cpu0SExx, they mean the standard 32 bits class.
This arrangement follows llvm 3.5 Mips backend style. In Mips backend, it uses
Mips16, MipsSE and Mips64 files/classes name to define classes functions for 16,
32 and 64 bits architecture, respectively.
Since Cpu0Subtarget creates Cpu0InstrInfo, Cpu0RegisterInfo, ..., at constuctor
function, it can provide the class reference through the interfaces shown in
<a class="pageref" href="#backendstructure-f1">Figure  1</a>.</p>
<p>Below <a class="pageref" href="#backendstructure-f2">Figure  2</a> shows Cpu0 TableGen inheritance
relationship.
Last chapter mentioned llvm TableGen (llvm-tblgen) is used in code generation
process.
Backend class can choose the TableGen generated classes and inherited from it.
There are more TableGen generated classes, and they all exist in
cmake_debug_build/lib/Target/Cpu0/*.inc. Through C++ inheritance mechanism,
TableGen provides backend programmers a fexible way to use its generated
code. Programmers have chance to override this function if they need to.</p>
<div class="figure align-center" id="backendstructure-f2">
<img alt="_images/2.png" src="_images/2.png" />
<p class="caption">Figure 2: Cpu0 classes inherited from TableGen generated files</p>
</div>
<p>Since llvm has deep inheritance tree, they are not digged here.
Benefit from the inheritance tree structure, there are not too much code need
to be implemented in classes of instruction, frame/stack and select DAG, since
many code are implemented by their parent class.
The llvm-tblgen generate Cpu0GenInstrInfo.inc based on information from
Cpu0InstrInfo.td.
Cpu0InstrInfo.h extract those code it needs from Cpu0GenInstrInfo.inc by define
“#define GET_INSTRINFO_HEADER”.
With TabelGen, the code size in backend is reduced again through the pattern
match theory of compiler developemnt. This is explained in sections
of DAG and Instruction Selection in last chapter.
Following is the code fragment from Cpu0GenInstrInfo.inc.
Code between &#8220;#if def  GET_INSTRINFO_HEADER&#8221; and
&#8220;#endif // GET_INSTRINFO_HEADER”&#8221; will be extracted to Cpu0InstrInfo.h.</p>
<p class="rubric">cmake_debug_build/lib/Target/Cpu0/Cpu0GenInstInfo.inc</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">//- Cpu0GenInstInfo.inc which generate from Cpu0InstrInfo.td</span>
<span class="cp">#ifdef GET_INSTRINFO_HEADER</span>
<span class="cp">#undef GET_INSTRINFO_HEADER</span>
<span class="k">namespace</span> <span class="n">llvm</span> <span class="p">{</span>
<span class="k">struct</span> <span class="n">Cpu0GenInstrInfo</span> <span class="o">:</span> <span class="k">public</span> <span class="n">TargetInstrInfoImpl</span> <span class="p">{</span>
  <span class="k">explicit</span> <span class="n">Cpu0GenInstrInfo</span><span class="p">(</span><span class="kt">int</span> <span class="n">SO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">DO</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="p">};</span>
<span class="p">}</span> <span class="c1">// End llvm namespace</span>
<span class="cp">#endif </span><span class="c1">// GET_INSTRINFO_HEADER</span>
</pre></div>
</div>
<p>Reference web site here <a class="footnote-reference" href="#targetmachine" id="id1">[1]</a> and here <a class="footnote-reference" href="#datalayout" id="id2">[2]</a>.</p>
<p>Chapter3_1/CMakeLists.txt is modified with these new added *.cpp as follows,</p>
<p class="rubric">lbdex/chapters/Chapter3_1/CMakeLists.txt</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">tablegen</span><span class="p">(</span><span class="n">LLVM</span> <span class="n">Cpu0GenDAGISel</span><span class="p">.</span><span class="n">inc</span> <span class="o">-</span><span class="n">gen</span><span class="o">-</span><span class="n">dag</span><span class="o">-</span><span class="n">isel</span><span class="p">)</span>
<span class="n">tablegen</span><span class="p">(</span><span class="n">LLVM</span> <span class="n">Cpu0GenCallingConv</span><span class="p">.</span><span class="n">inc</span> <span class="o">-</span><span class="n">gen</span><span class="o">-</span><span class="n">callingconv</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="n">Cpu0FrameLowering</span><span class="p">.</span><span class="n">cpp</span>
</pre></div>
</div>
<p>Please take a look for Chapter3_1 code.
After that, building Chapter3_1 by <strong>&#8220;#define CH  CH2&#8221;</strong> in Cpu0Config.h as
follows, and do building with Xcode on iMac or make on linux again.</p>
<p class="rubric">~/llvm/test/src/lib/Target/Cpu0SetChapter.h</p>
<div class="highlight-c++"><pre>#define CH       CH3_1

118-165-78-230:input Jonathan$ /Users/Jonathan/llvm/test/cmake_debug_build/
Debug/bin/llc -march=cpu0 -relocation-model=pic -filetype=asm ch3.bc -o
ch3.cpu0.s
... Assertion `AsmInfo &amp;&amp; "MCAsmInfo not initialized. "
...</pre>
</div>
<p>With Chapter3_1 implementation, the Chapter2 error message
&#8220;Could not allocate target machine!&#8221; has gone.
The new error say that we have not Target AsmPrinter.
We will add it in next section.</p>
<p>Chapter3_1 create FeatureCpu032I and FeatureCpu032II for CPU cpu032I and
cpu032II, repectively.
Beyond that, it defines two more features, FeatureCmp and FeatureSlt.
In order to demostrate the &#8220;instruction set designing choice&#8221; to readers, this
book create two CPU.
Readers will realize why Mips CPU uses instruction SLT instead of
CMP when they go to later Chapter &#8220;Control flow statement&#8221;.
With the added code of supporting cpu032I and cpu32II in Cpu0.td and
Cpu0InstrInfo.td of Chapter3_1, the command <tt class="docutils literal"><span class="pre">llc</span> <span class="pre">-march=cpu0</span> <span class="pre">-mcpu=help</span></tt> can
display messages as follows,</p>
<div class="highlight-bash"><div class="highlight"><pre>JonathantekiiMac:input Jonathan<span class="nv">$ </span>/Users/Jonathan/llvm/test/
cmake_debug_build/Debug/bin/llc -march<span class="o">=</span>cpu0 -mcpu<span class="o">=</span><span class="nb">help</span>
Available CPUs <span class="k">for </span>this target:

  cpu032I  - Select the cpu032I processor.
  cpu032II - Select the cpu032II processor.

Available features <span class="k">for </span>this target:

  ch10_1   - Enable Chapter instructions..
  ch11_1   - Enable Chapter instructions..
  ch11_2   - Enable Chapter instructions..
  ch14_1   - Enable Chapter instructions..
  ch3_1    - Enable Chapter instructions..
  ch3_2    - Enable Chapter instructions..
  ch3_3    - Enable Chapter instructions..
  ch3_4    - Enable Chapter instructions..
  ch3_5    - Enable Chapter instructions..
  ch4_1    - Enable Chapter instructions..
  ch4_2    - Enable Chapter instructions..
  ch5_1    - Enable Chapter instructions..
  ch6_1    - Enable Chapter instructions..
  ch7_1    - Enable Chapter instructions..
  ch8_1    - Enable Chapter instructions..
  ch8_2    - Enable Chapter instructions..
  ch9_1    - Enable Chapter instructions..
  ch9_2    - Enable Chapter instructions..
  ch9_3    - Enable Chapter instructions..
  chall    - Enable Chapter instructions..
  cmp      - Enable <span class="s1">&#39;cmp&#39;</span> instructions..
  cpu032I  - Cpu032I ISA Support.
  cpu032II - Cpu032II ISA Support <span class="o">(</span>slt<span class="o">)</span>.
  o32      - Enable o32 ABI.
  s32      - Enable s32 ABI.
  slt      - Enable <span class="s1">&#39;slt&#39;</span> instructions..

Use +feature to <span class="nb">enable </span>a feature, or -feature to disable it.
For example, llc -mcpu<span class="o">=</span>mycpu -mattr<span class="o">=</span>+feature1,-feature2
...
</pre></div>
</div>
<p>When user input <tt class="docutils literal"><span class="pre">-mcpu=cpu032I</span></tt>, the variable IsCpu032I from Cpu0InstrInfo.td
will be true since the function isCpu032I() defined in Cpu0Subtarget.h will be
true by checking variable CPU in constructor function (the variable CPU is
&#8220;cpu032I&#8221; when user input -mcpu=cpu032I).
Please notice variable Cpu0ArchVersion must be initialized in
Cpu0Subtarget.cpp, otherwise variable Cpu0ArchVersion can be any value and
functions isCpu032I() and isCpu032II() which support <tt class="docutils literal"><span class="pre">llc</span> <span class="pre">-mcpu=cpu032I</span></tt> and
<tt class="docutils literal"><span class="pre">llc</span> <span class="pre">-mcpu=cpu032II</span></tt>, repectively, will have trouble.
The value of variables HasCmp and HasSlt are set depend on Cpu0ArchVersion.
Instructions slt and beq, ... are supported only in case of HasSlt is true, and
furthermore, HasSlt is true only when Cpu0ArchVersion is Cpu032II.
Similiarly, Ch4_1, Ch4_2, ..., are used in controlling the enable or disable of
instruction definition. Through <strong>Subtarget-&gt;hasChapter4_1()</strong> which exists
both in Cpu0.td and Cpu0Subtarget.h, the Predicate, such as Ch4_1, defined in
Cpu0InstrInfo.td can be enabled or disabled. For example, the shift-rotate
instructions can be enabled by define CH to greater than or equal to CH4_1 as
follows,</p>
<p class="rubric">lbdex/Cpu0/Cpu0InstrInfo.td</p>
<div class="highlight-c++"><pre>let Predicates = [Ch4_1] in {
class shift_rotate_reg&lt;bits&lt;8&gt; op, bits&lt;4&gt; isRotate, string instr_asm,
                       SDNode OpNode, RegisterClass RC&gt;:
  FA&lt;op, (outs GPROut:$ra), (ins RC:$rb, RC:$rc),
     !strconcat(instr_asm, "\t$ra, $rb, $rc"),
     [(set GPROut:$ra, (OpNode RC:$rb, RC:$rc))], IIAlu&gt; {
  let shamt = 0;
}
}
</pre>
</div>
<p class="rubric">~/llvm/test/src/lib/Target/Cpu0SetChapter.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="cp">#define CH       CH4_1</span>
</pre></div>
</div>
<p>On the contrary, it can be disabled by define it to less than CH4_1, such as
CH3_5, as follows,</p>
<p class="rubric">~/llvm/test/src/lib/Target/Cpu0SetChapter.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="cp">#define CH       CH3_5</span>
</pre></div>
</div>
</div>
<div class="section" id="add-asmprinter">
<h2><a class="toc-backref" href="#id5">Add AsmPrinter</a><a class="headerlink" href="#add-asmprinter" title="Permalink to this headline">¶</a></h2>
<p>Chapter3_2/ contains the Cpu0AsmPrinter definition.</p>
<p class="rubric">lbdex/chapters/Chapter2/Cpu0.td</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">def</span> <span class="n">Cpu0InstrInfo</span> <span class="o">:</span> <span class="n">InstrInfo</span><span class="p">;</span>

<span class="c1">// Will generate Cpu0GenAsmWrite.inc included by Cpu0InstPrinter.cpp, contents</span>
<span class="c1">//  as follows,</span>
<span class="c1">// void Cpu0InstPrinter::printInstruction(const MCInst *MI, raw_ostream &amp;O) {...}</span>
<span class="c1">// const char *Cpu0InstPrinter::getRegisterName(unsigned RegNo) {...}</span>
<span class="n">def</span> <span class="n">Cpu0</span> <span class="o">:</span> <span class="n">Target</span> <span class="p">{</span>
<span class="c1">// def Cpu0InstrInfo : InstrInfo as before.</span>
  <span class="n">let</span> <span class="n">InstructionSet</span> <span class="o">=</span> <span class="n">Cpu0InstrInfo</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>As above comments of Chapter2/Cpu0.td indicate, it will generate
Cpu0GenAsmWrite.inc which is included by Cpu0InstPrinter.cpp as follows,</p>
<p class="rubric">lbdex/chapters/Chapter3_2/InstPrinter/Cpu0InstPrinter.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">//=== Cpu0InstPrinter.h - Convert Cpu0 MCInst to assembly syntax -*- C++ -*-==//</span>
<span class="c1">//</span>
<span class="c1">//                     The LLVM Compiler Infrastructure</span>
<span class="c1">//</span>
<span class="c1">// This file is distributed under the University of Illinois Open Source</span>
<span class="c1">// License. See LICENSE.TXT for details.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="c1">//</span>
<span class="c1">// This class prints a Cpu0 MCInst to a .s file.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>

<span class="cp">#ifndef LLVM_LIB_TARGET_CPU0_INSTPRINTER_CPU0INSTPRINTER_H</span>
<span class="cp">#define LLVM_LIB_TARGET_CPU0_INSTPRINTER_CPU0INSTPRINTER_H</span>

<span class="cp">#include &quot;Cpu0Config.h&quot;</span>

<span class="cp">#include &quot;llvm/MC/MCInstPrinter.h&quot;</span>

<span class="k">namespace</span> <span class="n">llvm</span> <span class="p">{</span>
<span class="c1">// These enumeration declarations were orignally in Cpu0InstrInfo.h but</span>
<span class="c1">// had to be moved here to avoid circular dependencies between</span>
<span class="c1">// LLVMCpu0CodeGen and LLVMCpu0AsmPrinter.</span>

<span class="k">class</span> <span class="nc">TargetMachine</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Cpu0InstPrinter</span> <span class="o">:</span> <span class="k">public</span> <span class="n">MCInstPrinter</span> <span class="p">{</span>
<span class="nl">public:</span>
  <span class="n">Cpu0InstPrinter</span><span class="p">(</span><span class="k">const</span> <span class="n">MCAsmInfo</span> <span class="o">&amp;</span><span class="n">MAI</span><span class="p">,</span> <span class="k">const</span> <span class="n">MCInstrInfo</span> <span class="o">&amp;</span><span class="n">MII</span><span class="p">,</span>
                  <span class="k">const</span> <span class="n">MCRegisterInfo</span> <span class="o">&amp;</span><span class="n">MRI</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">MCInstPrinter</span><span class="p">(</span><span class="n">MAI</span><span class="p">,</span> <span class="n">MII</span><span class="p">,</span> <span class="n">MRI</span><span class="p">)</span> <span class="p">{}</span>

  <span class="c1">// Autogenerated by tblgen.</span>
  <span class="kt">void</span> <span class="n">printInstruction</span><span class="p">(</span><span class="k">const</span> <span class="n">MCInst</span> <span class="o">*</span><span class="n">MI</span><span class="p">,</span> <span class="n">raw_ostream</span> <span class="o">&amp;</span><span class="n">O</span><span class="p">);</span>
  <span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">getRegisterName</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">RegNo</span><span class="p">);</span>

  <span class="kt">void</span> <span class="n">printRegName</span><span class="p">(</span><span class="n">raw_ostream</span> <span class="o">&amp;</span><span class="n">OS</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">RegNo</span><span class="p">)</span> <span class="k">const</span> <span class="n">override</span><span class="p">;</span>
  <span class="kt">void</span> <span class="n">printInst</span><span class="p">(</span><span class="k">const</span> <span class="n">MCInst</span> <span class="o">*</span><span class="n">MI</span><span class="p">,</span> <span class="n">raw_ostream</span> <span class="o">&amp;</span><span class="n">O</span><span class="p">,</span> <span class="n">StringRef</span> <span class="n">Annot</span><span class="p">,</span>
                 <span class="k">const</span> <span class="n">MCSubtargetInfo</span> <span class="o">&amp;</span><span class="n">STI</span><span class="p">)</span> <span class="n">override</span><span class="p">;</span>

  <span class="kt">bool</span> <span class="nf">printAliasInstr</span><span class="p">(</span><span class="k">const</span> <span class="n">MCInst</span> <span class="o">*</span><span class="n">MI</span><span class="p">,</span> <span class="n">raw_ostream</span> <span class="o">&amp;</span><span class="n">OS</span><span class="p">);</span>
  <span class="kt">void</span> <span class="nf">printCustomAliasOperand</span><span class="p">(</span><span class="k">const</span> <span class="n">MCInst</span> <span class="o">*</span><span class="n">MI</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">OpIdx</span><span class="p">,</span>
                               <span class="kt">unsigned</span> <span class="n">PrintMethodIdx</span><span class="p">,</span> <span class="n">raw_ostream</span> <span class="o">&amp;</span><span class="n">O</span><span class="p">);</span>

<span class="nl">private:</span>
  <span class="kt">void</span> <span class="nf">printOperand</span><span class="p">(</span><span class="k">const</span> <span class="n">MCInst</span> <span class="o">*</span><span class="n">MI</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">OpNo</span><span class="p">,</span> <span class="n">raw_ostream</span> <span class="o">&amp;</span><span class="n">O</span><span class="p">);</span>
  <span class="kt">void</span> <span class="nf">printUnsignedImm</span><span class="p">(</span><span class="k">const</span> <span class="n">MCInst</span> <span class="o">*</span><span class="n">MI</span><span class="p">,</span> <span class="kt">int</span> <span class="n">opNum</span><span class="p">,</span> <span class="n">raw_ostream</span> <span class="o">&amp;</span><span class="n">O</span><span class="p">);</span>
  <span class="kt">void</span> <span class="nf">printMemOperand</span><span class="p">(</span><span class="k">const</span> <span class="n">MCInst</span> <span class="o">*</span><span class="n">MI</span><span class="p">,</span> <span class="kt">int</span> <span class="n">opNum</span><span class="p">,</span> <span class="n">raw_ostream</span> <span class="o">&amp;</span><span class="n">O</span><span class="p">);</span>
<span class="c1">//#if CH &gt;= CH7_1</span>
  <span class="kt">void</span> <span class="nf">printMemOperandEA</span><span class="p">(</span><span class="k">const</span> <span class="n">MCInst</span> <span class="o">*</span><span class="n">MI</span><span class="p">,</span> <span class="kt">int</span> <span class="n">opNum</span><span class="p">,</span> <span class="n">raw_ostream</span> <span class="o">&amp;</span><span class="n">O</span><span class="p">);</span>
<span class="c1">//#endif</span>
<span class="p">};</span>
<span class="p">}</span> <span class="c1">// end namespace llvm</span>

<span class="cp">#endif</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_2/InstPrinter/Cpu0InstPrinter.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">//===-- Cpu0InstPrinter.cpp - Convert Cpu0 MCInst to assembly syntax ------===//</span>
<span class="c1">//</span>
<span class="c1">//                     The LLVM Compiler Infrastructure</span>
<span class="c1">//</span>
<span class="c1">// This file is distributed under the University of Illinois Open Source</span>
<span class="c1">// License. See LICENSE.TXT for details.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="c1">//</span>
<span class="c1">// This class prints an Cpu0 MCInst to a .s file.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>

<span class="cp">#include &quot;Cpu0InstPrinter.h&quot;</span>

<span class="cp">#include &quot;Cpu0InstrInfo.h&quot;</span>
<span class="cp">#include &quot;llvm/ADT/StringExtras.h&quot;</span>
<span class="cp">#include &quot;llvm/MC/MCExpr.h&quot;</span>
<span class="cp">#include &quot;llvm/MC/MCInst.h&quot;</span>
<span class="cp">#include &quot;llvm/MC/MCInstrInfo.h&quot;</span>
<span class="cp">#include &quot;llvm/MC/MCSymbol.h&quot;</span>
<span class="cp">#include &quot;llvm/Support/ErrorHandling.h&quot;</span>
<span class="cp">#include &quot;llvm/Support/raw_ostream.h&quot;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">llvm</span><span class="p">;</span>

<span class="cp">#define DEBUG_TYPE &quot;asm-printer&quot;</span>

<span class="cp">#define PRINT_ALIAS_INSTR</span>
<span class="cp">#include &quot;Cpu0GenAsmWriter.inc&quot;</span>

<span class="kt">void</span> <span class="n">Cpu0InstPrinter</span><span class="o">::</span><span class="n">printRegName</span><span class="p">(</span><span class="n">raw_ostream</span> <span class="o">&amp;</span><span class="n">OS</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">RegNo</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
<span class="c1">//- getRegisterName(RegNo) defined in Cpu0GenAsmWriter.inc which indicate in </span>
<span class="c1">//   Cpu0.td.</span>
  <span class="n">OS</span> <span class="o">&lt;&lt;</span> <span class="sc">&#39;$&#39;</span> <span class="o">&lt;&lt;</span> <span class="n">StringRef</span><span class="p">(</span><span class="n">getRegisterName</span><span class="p">(</span><span class="n">RegNo</span><span class="p">)).</span><span class="n">lower</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">//@1 {</span>
<span class="kt">void</span> <span class="n">Cpu0InstPrinter</span><span class="o">::</span><span class="n">printInst</span><span class="p">(</span><span class="k">const</span> <span class="n">MCInst</span> <span class="o">*</span><span class="n">MI</span><span class="p">,</span> <span class="n">raw_ostream</span> <span class="o">&amp;</span><span class="n">O</span><span class="p">,</span>
                                <span class="n">StringRef</span> <span class="n">Annot</span><span class="p">,</span> <span class="k">const</span> <span class="n">MCSubtargetInfo</span> <span class="o">&amp;</span><span class="n">STI</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Try to print any aliases first.</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">printAliasInstr</span><span class="p">(</span><span class="n">MI</span><span class="p">,</span> <span class="n">O</span><span class="p">))</span>
<span class="c1">//@1 }</span>
    <span class="c1">//- printInstruction(MI, O) defined in Cpu0GenAsmWriter.inc which came from </span>
    <span class="c1">//   Cpu0.td indicate.</span>
    <span class="n">printInstruction</span><span class="p">(</span><span class="n">MI</span><span class="p">,</span> <span class="n">O</span><span class="p">);</span>
  <span class="n">printAnnotation</span><span class="p">(</span><span class="n">O</span><span class="p">,</span> <span class="n">Annot</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">//@printExpr {</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">printExpr</span><span class="p">(</span><span class="k">const</span> <span class="n">MCExpr</span> <span class="o">*</span><span class="n">Expr</span><span class="p">,</span> <span class="k">const</span> <span class="n">MCAsmInfo</span> <span class="o">*</span><span class="n">MAI</span><span class="p">,</span>
                      <span class="n">raw_ostream</span> <span class="o">&amp;</span><span class="n">OS</span><span class="p">)</span> <span class="p">{</span>
<span class="c1">//@printExpr body {</span>
  <span class="kt">int</span> <span class="n">Offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">const</span> <span class="n">MCSymbolRefExpr</span> <span class="o">*</span><span class="n">SRE</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="k">const</span> <span class="n">MCBinaryExpr</span> <span class="o">*</span><span class="n">BE</span> <span class="o">=</span> <span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">MCBinaryExpr</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Expr</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">SRE</span> <span class="o">=</span> <span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">MCSymbolRefExpr</span><span class="o">&gt;</span><span class="p">(</span><span class="n">BE</span><span class="o">-&gt;</span><span class="n">getLHS</span><span class="p">());</span>
    <span class="k">const</span> <span class="n">MCConstantExpr</span> <span class="o">*</span><span class="n">CE</span> <span class="o">=</span> <span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">MCConstantExpr</span><span class="o">&gt;</span><span class="p">(</span><span class="n">BE</span><span class="o">-&gt;</span><span class="n">getRHS</span><span class="p">());</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">SRE</span> <span class="o">&amp;&amp;</span> <span class="n">CE</span> <span class="o">&amp;&amp;</span> <span class="s">&quot;Binary expression must be sym+const.&quot;</span><span class="p">);</span>
    <span class="n">Offset</span> <span class="o">=</span> <span class="n">CE</span><span class="o">-&gt;</span><span class="n">getValue</span><span class="p">();</span>
  <span class="p">}</span> <span class="k">else</span>
    <span class="n">SRE</span> <span class="o">=</span> <span class="n">cast</span><span class="o">&lt;</span><span class="n">MCSymbolRefExpr</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Expr</span><span class="p">);</span>

  <span class="n">MCSymbolRefExpr</span><span class="o">::</span><span class="n">VariantKind</span> <span class="n">Kind</span> <span class="o">=</span> <span class="n">SRE</span><span class="o">-&gt;</span><span class="n">getKind</span><span class="p">();</span>

  <span class="k">switch</span> <span class="p">(</span><span class="n">Kind</span><span class="p">)</span> <span class="p">{</span>
  <span class="nl">default:</span>                                 <span class="n">llvm_unreachable</span><span class="p">(</span><span class="s">&quot;Invalid kind!&quot;</span><span class="p">);</span>
  <span class="k">case</span> <span class="n">MCSymbolRefExpr</span>:<span class="o">:</span><span class="n">VK_None</span><span class="o">:</span>           <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">SRE</span><span class="o">-&gt;</span><span class="n">getSymbol</span><span class="p">().</span><span class="n">print</span><span class="p">(</span><span class="n">OS</span><span class="p">,</span> <span class="n">MAI</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">Offset</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Offset</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
      <span class="n">OS</span> <span class="o">&lt;&lt;</span> <span class="sc">&#39;+&#39;</span><span class="p">;</span>
    <span class="n">OS</span> <span class="o">&lt;&lt;</span> <span class="n">Offset</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">((</span><span class="n">Kind</span> <span class="o">==</span> <span class="n">MCSymbolRefExpr</span><span class="o">::</span><span class="n">VK_Cpu0_GPOFF_HI</span><span class="p">)</span> <span class="o">||</span>
      <span class="p">(</span><span class="n">Kind</span> <span class="o">==</span> <span class="n">MCSymbolRefExpr</span><span class="o">::</span><span class="n">VK_Cpu0_GPOFF_LO</span><span class="p">))</span>
    <span class="n">OS</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;)))&quot;</span><span class="p">;</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">Kind</span> <span class="o">!=</span> <span class="n">MCSymbolRefExpr</span><span class="o">::</span><span class="n">VK_None</span><span class="p">)</span>
    <span class="n">OS</span> <span class="o">&lt;&lt;</span> <span class="sc">&#39;)&#39;</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Cpu0InstPrinter</span><span class="o">::</span><span class="n">printOperand</span><span class="p">(</span><span class="k">const</span> <span class="n">MCInst</span> <span class="o">*</span><span class="n">MI</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">OpNo</span><span class="p">,</span>
                                   <span class="n">raw_ostream</span> <span class="o">&amp;</span><span class="n">O</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">const</span> <span class="n">MCOperand</span> <span class="o">&amp;</span><span class="n">Op</span> <span class="o">=</span> <span class="n">MI</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="n">OpNo</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Op</span><span class="p">.</span><span class="n">isReg</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">printRegName</span><span class="p">(</span><span class="n">O</span><span class="p">,</span> <span class="n">Op</span><span class="p">.</span><span class="n">getReg</span><span class="p">());</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">Op</span><span class="p">.</span><span class="n">isImm</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">O</span> <span class="o">&lt;&lt;</span> <span class="n">Op</span><span class="p">.</span><span class="n">getImm</span><span class="p">();</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">assert</span><span class="p">(</span><span class="n">Op</span><span class="p">.</span><span class="n">isExpr</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="s">&quot;unknown operand kind in printOperand&quot;</span><span class="p">);</span>
  <span class="n">printExpr</span><span class="p">(</span><span class="n">Op</span><span class="p">.</span><span class="n">getExpr</span><span class="p">(),</span> <span class="o">&amp;</span><span class="n">MAI</span><span class="p">,</span> <span class="n">O</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Cpu0InstPrinter</span><span class="o">::</span><span class="n">printUnsignedImm</span><span class="p">(</span><span class="k">const</span> <span class="n">MCInst</span> <span class="o">*</span><span class="n">MI</span><span class="p">,</span> <span class="kt">int</span> <span class="n">opNum</span><span class="p">,</span>
                                       <span class="n">raw_ostream</span> <span class="o">&amp;</span><span class="n">O</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">const</span> <span class="n">MCOperand</span> <span class="o">&amp;</span><span class="n">MO</span> <span class="o">=</span> <span class="n">MI</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="n">opNum</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">MO</span><span class="p">.</span><span class="n">isImm</span><span class="p">())</span>
    <span class="n">O</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="kt">int</span><span class="p">)</span><span class="n">MO</span><span class="p">.</span><span class="n">getImm</span><span class="p">();</span>
  <span class="k">else</span>
    <span class="nf">printOperand</span><span class="p">(</span><span class="n">MI</span><span class="p">,</span> <span class="n">opNum</span><span class="p">,</span> <span class="n">O</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Cpu0InstPrinter</span><span class="o">::</span>
<span class="n">printMemOperand</span><span class="p">(</span><span class="k">const</span> <span class="n">MCInst</span> <span class="o">*</span><span class="n">MI</span><span class="p">,</span> <span class="kt">int</span> <span class="n">opNum</span><span class="p">,</span> <span class="n">raw_ostream</span> <span class="o">&amp;</span><span class="n">O</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Load/Store memory operands -- imm($reg)</span>
  <span class="c1">// If PIC target the target is loaded as the</span>
  <span class="c1">// pattern ld $t9,%call16($gp)</span>
  <span class="n">printOperand</span><span class="p">(</span><span class="n">MI</span><span class="p">,</span> <span class="n">opNum</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">O</span><span class="p">);</span>
  <span class="n">O</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;(&quot;</span><span class="p">;</span>
  <span class="n">printOperand</span><span class="p">(</span><span class="n">MI</span><span class="p">,</span> <span class="n">opNum</span><span class="p">,</span> <span class="n">O</span><span class="p">);</span>
  <span class="n">O</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;)&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">//#if CH &gt;= CH7_1</span>
<span class="c1">// The DAG data node, mem_ea of Cpu0InstrInfo.td, cannot be disabled by</span>
<span class="c1">// ch7_1, only opcode node can be disabled.</span>
<span class="kt">void</span> <span class="n">Cpu0InstPrinter</span><span class="o">::</span>
<span class="n">printMemOperandEA</span><span class="p">(</span><span class="k">const</span> <span class="n">MCInst</span> <span class="o">*</span><span class="n">MI</span><span class="p">,</span> <span class="kt">int</span> <span class="n">opNum</span><span class="p">,</span> <span class="n">raw_ostream</span> <span class="o">&amp;</span><span class="n">O</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// when using stack locations for not load/store instructions</span>
  <span class="c1">// print the same way as all normal 3 operand instructions.</span>
  <span class="n">printOperand</span><span class="p">(</span><span class="n">MI</span><span class="p">,</span> <span class="n">opNum</span><span class="p">,</span> <span class="n">O</span><span class="p">);</span>
  <span class="n">O</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, &quot;</span><span class="p">;</span>
  <span class="n">printOperand</span><span class="p">(</span><span class="n">MI</span><span class="p">,</span> <span class="n">opNum</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">O</span><span class="p">);</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1">//#endif</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_2/InstPrinter/CMakeLists.txt</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">add_llvm_library</span><span class="p">(</span><span class="n">LLVMCpu0AsmPrinter</span>
  <span class="n">Cpu0InstPrinter</span><span class="p">.</span><span class="n">cpp</span>
  <span class="p">)</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_2/InstPrinter/LLVMBuild.txt</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="p">;</span><span class="o">===-</span> <span class="p">.</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">Target</span><span class="o">/</span><span class="n">Cpu0</span><span class="o">/</span><span class="n">InstPrinter</span><span class="o">/</span><span class="n">LLVMBuild</span><span class="p">.</span><span class="n">txt</span> <span class="o">--------------*-</span> <span class="n">Conf</span> <span class="o">-*--===</span><span class="p">;</span>
<span class="p">;</span>
<span class="p">;</span>                     <span class="n">The</span> <span class="n">LLVM</span> <span class="n">Compiler</span> <span class="n">Infrastructure</span>
<span class="p">;</span>
<span class="p">;</span> <span class="n">This</span> <span class="n">file</span> <span class="n">is</span> <span class="n">distributed</span> <span class="n">under</span> <span class="n">the</span> <span class="n">University</span> <span class="n">of</span> <span class="n">Illinois</span> <span class="n">Open</span> <span class="n">Source</span>
<span class="p">;</span> <span class="n">License</span><span class="p">.</span> <span class="n">See</span> <span class="n">LICENSE</span><span class="p">.</span><span class="n">TXT</span> <span class="k">for</span> <span class="n">details</span><span class="p">.</span>
<span class="p">;</span>
<span class="p">;</span><span class="o">===------------------------------------------------------------------------===</span><span class="p">;</span>
<span class="p">;</span>
<span class="p">;</span> <span class="n">This</span> <span class="n">is</span> <span class="n">an</span> <span class="n">LLVMBuild</span> <span class="n">description</span> <span class="n">file</span> <span class="k">for</span> <span class="n">the</span> <span class="n">components</span> <span class="n">in</span> <span class="k">this</span> <span class="n">subdirectory</span><span class="p">.</span>
<span class="p">;</span>
<span class="p">;</span> <span class="n">For</span> <span class="n">more</span> <span class="n">information</span> <span class="n">on</span> <span class="n">the</span> <span class="n">LLVMBuild</span> <span class="n">system</span><span class="p">,</span> <span class="n">please</span> <span class="n">see</span><span class="o">:</span>
<span class="p">;</span>
<span class="p">;</span>   <span class="n">http</span><span class="o">:</span><span class="c1">//llvm.org/docs/LLVMBuild.html</span>
<span class="p">;</span>
<span class="p">;</span><span class="o">===------------------------------------------------------------------------===</span><span class="p">;</span>

<span class="p">[</span><span class="n">component_0</span><span class="p">]</span>
<span class="n">type</span> <span class="o">=</span> <span class="n">Library</span>
<span class="n">name</span> <span class="o">=</span> <span class="n">Cpu0AsmPrinter</span>
<span class="n">parent</span> <span class="o">=</span> <span class="n">Cpu0</span>
<span class="n">required_libraries</span> <span class="o">=</span> <span class="n">MC</span> <span class="n">Support</span>
<span class="n">add_to_library_groups</span> <span class="o">=</span> <span class="n">Cpu0</span>
</pre></div>
</div>
<p>Cpu0GenAsmWrite.inc has the implementations of
Cpu0InstPrinter::printInstruction() and Cpu0InstPrinter::getRegisterName().
Both of these functions can be auto-generated from the information we defined
in Cpu0InstrInfo.td and Cpu0RegisterInfo.td.
To let these two functions work in our code, the only thing needed is adding a
class Cpu0InstPrinter and include them as did in Chapter3_2.</p>
<p>File Chapter3_2/Cpu0/InstPrinter/Cpu0InstPrinter.cpp include Cpu0GenAsmWrite.inc
and call the auto-generated functions from TableGen.</p>
<p>Function Cpu0InstPrinter::printMemOperand() defined in Chapter3_2/InstPrinter/
Cpu0InstPrinter.cpp as above. It will be triggered since Cpu0InstrInfo.td
defined <strong>&#8216;let PrintMethod = &#8220;printMemOperand&#8221;;&#8217;</strong> as follows,</p>
<p class="rubric">lbdex/chapters/Chapter2/Cpu0InstrInfo.td</p>
<div class="highlight-c++"><pre>// Address operand
def mem : Operand&lt;i32&gt; {
  let PrintMethod = "printMemOperand";
  let MIOperandInfo = (ops CPURegs, simm16);
  let EncoderMethod = "getMemEncoding";
//#if CH &gt;= CH11_1
  let ParserMatchClass = Cpu0MemAsmOperand;
//#endif
}
...
// 32-bit load.
multiclass LoadM32&lt;bits&lt;8&gt; op, string instr_asm, PatFrag OpNode,
                   bit Pseudo = 0&gt; {
  def #NAME# : LoadM&lt;op, instr_asm, OpNode, GPROut, mem, Pseudo&gt;;
}

// 32-bit store.
multiclass StoreM32&lt;bits&lt;8&gt; op, string instr_asm, PatFrag OpNode,
                    bit Pseudo = 0&gt; {
  def #NAME# : StoreM&lt;op, instr_asm, OpNode, CPURegs, mem, Pseudo&gt;;
}

defm LD     : LoadM32&lt;0x01,  "ld",  load_a&gt;;
defm ST     : StoreM32&lt;0x02, "st",  store_a&gt;;</pre>
</div>
<p>Cpu0InstPrinter::printMemOperand() will print backend operands for &#8220;local
variable access&#8221;, which like the following,</p>
<div class="highlight-bash"><div class="highlight"><pre>ld    <span class="nv">$2</span>, 16<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
st    <span class="nv">$2</span>, 8<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
</pre></div>
</div>
<p>Next, add Cpu0MCInstLower (Cpu0MCInstLower.h, Cpu0MCInstLower.cpp) as well as
Cpu0BaseInfo.h,
Cpu0FixupKinds.h and Cpu0MCAsmInfo (Cpu0MCAsmInfo.h, Cpu0MCAsmInfo.cpp) in
sub-directory MCTargetDesc as follows,</p>
<p class="rubric">lbdex/chapters/Chapter3_2/Cpu0MCInstLower.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">//===-- Cpu0MCInstLower.h - Lower MachineInstr to MCInst -------*- C++ -*--===//</span>
<span class="c1">//</span>
<span class="c1">//                     The LLVM Compiler Infrastructure</span>
<span class="c1">//</span>
<span class="c1">// This file is distributed under the University of Illinois Open Source</span>
<span class="c1">// License. See LICENSE.TXT for details.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>

<span class="cp">#ifndef LLVM_LIB_TARGET_CPU0_CPU0MCINSTLOWER_H</span>
<span class="cp">#define LLVM_LIB_TARGET_CPU0_CPU0MCINSTLOWER_H</span>

<span class="cp">#include &quot;Cpu0Config.h&quot;</span>

<span class="cp">#include &quot;llvm/ADT/SmallVector.h&quot;</span>
<span class="cp">#include &quot;llvm/CodeGen/MachineOperand.h&quot;</span>
<span class="cp">#include &quot;llvm/Support/Compiler.h&quot;</span>

<span class="k">namespace</span> <span class="n">llvm</span> <span class="p">{</span>
  <span class="k">class</span> <span class="nc">MCContext</span><span class="p">;</span>
  <span class="k">class</span> <span class="nc">MCInst</span><span class="p">;</span>
  <span class="k">class</span> <span class="nc">MCOperand</span><span class="p">;</span>
  <span class="k">class</span> <span class="nc">MachineInstr</span><span class="p">;</span>
  <span class="k">class</span> <span class="nc">MachineFunction</span><span class="p">;</span>
  <span class="k">class</span> <span class="nc">Cpu0AsmPrinter</span><span class="p">;</span>

<span class="c1">//@1 {</span>
<span class="c1">/// This class is used to lower an MachineInstr into an MCInst.</span>
<span class="k">class</span> <span class="nc">LLVM_LIBRARY_VISIBILITY</span> <span class="n">Cpu0MCInstLower</span> <span class="p">{</span>
<span class="c1">//@2</span>
  <span class="k">typedef</span> <span class="n">MachineOperand</span><span class="o">::</span><span class="n">MachineOperandType</span> <span class="n">MachineOperandType</span><span class="p">;</span>
  <span class="n">MCContext</span> <span class="o">*</span><span class="n">Ctx</span><span class="p">;</span>
  <span class="n">Cpu0AsmPrinter</span> <span class="o">&amp;</span><span class="n">AsmPrinter</span><span class="p">;</span>
<span class="nl">public:</span>
  <span class="n">Cpu0MCInstLower</span><span class="p">(</span><span class="n">Cpu0AsmPrinter</span> <span class="o">&amp;</span><span class="n">asmprinter</span><span class="p">);</span>
  <span class="kt">void</span> <span class="nf">Initialize</span><span class="p">(</span><span class="n">MCContext</span><span class="o">*</span> <span class="n">C</span><span class="p">);</span>
  <span class="kt">void</span> <span class="n">Lower</span><span class="p">(</span><span class="k">const</span> <span class="n">MachineInstr</span> <span class="o">*</span><span class="n">MI</span><span class="p">,</span> <span class="n">MCInst</span> <span class="o">&amp;</span><span class="n">OutMI</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>
  <span class="n">MCOperand</span> <span class="n">LowerOperand</span><span class="p">(</span><span class="k">const</span> <span class="n">MachineOperand</span><span class="o">&amp;</span> <span class="n">MO</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>
<span class="p">};</span>
<span class="p">}</span>

<span class="cp">#endif</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_2/Cpu0MCInstLower.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">//===-- Cpu0MCInstLower.cpp - Convert Cpu0 MachineInstr to MCInst ---------===//</span>
<span class="c1">//</span>
<span class="c1">//                     The LLVM Compiler Infrastructure</span>
<span class="c1">//</span>
<span class="c1">// This file is distributed under the University of Illinois Open Source</span>
<span class="c1">// License. See LICENSE.TXT for details.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="c1">//</span>
<span class="c1">// This file contains code to lower Cpu0 MachineInstrs to their corresponding</span>
<span class="c1">// MCInst records.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>

<span class="cp">#include &quot;Cpu0MCInstLower.h&quot;</span>

<span class="cp">#include &quot;Cpu0AsmPrinter.h&quot;</span>
<span class="cp">#include &quot;Cpu0InstrInfo.h&quot;</span>
<span class="cp">#include &quot;MCTargetDesc/Cpu0BaseInfo.h&quot;</span>
<span class="cp">#include &quot;llvm/CodeGen/MachineFunction.h&quot;</span>
<span class="cp">#include &quot;llvm/CodeGen/MachineInstr.h&quot;</span>
<span class="cp">#include &quot;llvm/CodeGen/MachineOperand.h&quot;</span>
<span class="cp">#include &quot;llvm/IR/Mangler.h&quot;</span>
<span class="cp">#include &quot;llvm/MC/MCContext.h&quot;</span>
<span class="cp">#include &quot;llvm/MC/MCExpr.h&quot;</span>
<span class="cp">#include &quot;llvm/MC/MCInst.h&quot;</span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">llvm</span><span class="p">;</span>

<span class="n">Cpu0MCInstLower</span><span class="o">::</span><span class="n">Cpu0MCInstLower</span><span class="p">(</span><span class="n">Cpu0AsmPrinter</span> <span class="o">&amp;</span><span class="n">asmprinter</span><span class="p">)</span>
  <span class="o">:</span> <span class="n">AsmPrinter</span><span class="p">(</span><span class="n">asmprinter</span><span class="p">)</span> <span class="p">{}</span>

<span class="kt">void</span> <span class="n">Cpu0MCInstLower</span><span class="o">::</span><span class="n">Initialize</span><span class="p">(</span><span class="n">MCContext</span><span class="o">*</span> <span class="n">C</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">Ctx</span> <span class="o">=</span> <span class="n">C</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">CreateMCInst</span><span class="p">(</span><span class="n">MCInst</span><span class="o">&amp;</span> <span class="n">Inst</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">Opc</span><span class="p">,</span> <span class="k">const</span> <span class="n">MCOperand</span><span class="o">&amp;</span> <span class="n">Opnd0</span><span class="p">,</span>
                         <span class="k">const</span> <span class="n">MCOperand</span><span class="o">&amp;</span> <span class="n">Opnd1</span><span class="p">,</span>
                         <span class="k">const</span> <span class="n">MCOperand</span><span class="o">&amp;</span> <span class="n">Opnd2</span> <span class="o">=</span> <span class="n">MCOperand</span><span class="p">())</span> <span class="p">{</span>
  <span class="n">Inst</span><span class="p">.</span><span class="n">setOpcode</span><span class="p">(</span><span class="n">Opc</span><span class="p">);</span>
  <span class="n">Inst</span><span class="p">.</span><span class="n">addOperand</span><span class="p">(</span><span class="n">Opnd0</span><span class="p">);</span>
  <span class="n">Inst</span><span class="p">.</span><span class="n">addOperand</span><span class="p">(</span><span class="n">Opnd1</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Opnd2</span><span class="p">.</span><span class="n">isValid</span><span class="p">())</span>
    <span class="n">Inst</span><span class="p">.</span><span class="n">addOperand</span><span class="p">(</span><span class="n">Opnd2</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">//@LowerOperand {</span>
<span class="n">MCOperand</span> <span class="n">Cpu0MCInstLower</span><span class="o">::</span><span class="n">LowerOperand</span><span class="p">(</span><span class="k">const</span> <span class="n">MachineOperand</span><span class="o">&amp;</span> <span class="n">MO</span><span class="p">,</span>
                                        <span class="kt">unsigned</span> <span class="n">offset</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="n">MachineOperandType</span> <span class="n">MOTy</span> <span class="o">=</span> <span class="n">MO</span><span class="p">.</span><span class="n">getType</span><span class="p">();</span>

  <span class="k">switch</span> <span class="p">(</span><span class="n">MOTy</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">//@2</span>
  <span class="nl">default:</span> <span class="n">llvm_unreachable</span><span class="p">(</span><span class="s">&quot;unknown operand type&quot;</span><span class="p">);</span>
  <span class="k">case</span> <span class="n">MachineOperand</span>:<span class="o">:</span><span class="n">MO_Register</span><span class="o">:</span>
    <span class="c1">// Ignore all implicit register operands.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">MO</span><span class="p">.</span><span class="n">isImplicit</span><span class="p">())</span> <span class="k">break</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">MCOperand</span><span class="o">::</span><span class="n">createReg</span><span class="p">(</span><span class="n">MO</span><span class="p">.</span><span class="n">getReg</span><span class="p">());</span>
  <span class="k">case</span> <span class="n">MachineOperand</span>:<span class="o">:</span><span class="n">MO_Immediate</span><span class="o">:</span>
    <span class="k">return</span> <span class="n">MCOperand</span><span class="o">::</span><span class="n">createImm</span><span class="p">(</span><span class="n">MO</span><span class="p">.</span><span class="n">getImm</span><span class="p">()</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
  <span class="k">case</span> <span class="n">MachineOperand</span>:<span class="o">:</span><span class="n">MO_RegisterMask</span><span class="o">:</span>
    <span class="k">break</span><span class="p">;</span>
 <span class="p">}</span>

  <span class="k">return</span> <span class="n">MCOperand</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Cpu0MCInstLower</span><span class="o">::</span><span class="n">Lower</span><span class="p">(</span><span class="k">const</span> <span class="n">MachineInstr</span> <span class="o">*</span><span class="n">MI</span><span class="p">,</span> <span class="n">MCInst</span> <span class="o">&amp;</span><span class="n">OutMI</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="n">OutMI</span><span class="p">.</span><span class="n">setOpcode</span><span class="p">(</span><span class="n">MI</span><span class="o">-&gt;</span><span class="n">getOpcode</span><span class="p">());</span>

  <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">MI</span><span class="o">-&gt;</span><span class="n">getNumOperands</span><span class="p">();</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">e</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">const</span> <span class="n">MachineOperand</span> <span class="o">&amp;</span><span class="n">MO</span> <span class="o">=</span> <span class="n">MI</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
    <span class="n">MCOperand</span> <span class="n">MCOp</span> <span class="o">=</span> <span class="n">LowerOperand</span><span class="p">(</span><span class="n">MO</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">MCOp</span><span class="p">.</span><span class="n">isValid</span><span class="p">())</span>
      <span class="n">OutMI</span><span class="p">.</span><span class="n">addOperand</span><span class="p">(</span><span class="n">MCOp</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_2/MCTargetDesc/Cpu0BaseInfo.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">//===-- Cpu0BaseInfo.h - Top level definitions for CPU0 MC ------*- C++ -*-===//</span>
<span class="c1">//</span>
<span class="c1">//                     The LLVM Compiler Infrastructure</span>
<span class="c1">//</span>
<span class="c1">// This file is distributed under the University of Illinois Open Source</span>
<span class="c1">// License. See LICENSE.TXT for details.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="c1">//</span>
<span class="c1">// This file contains small standalone helper functions and enum definitions for</span>
<span class="c1">// the Cpu0 target useful for the compiler back-end and the MC libraries.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="cp">#ifndef LLVM_LIB_TARGET_CPU0_MCTARGETDESC_CPU0BASEINFO_H</span>
<span class="cp">#define LLVM_LIB_TARGET_CPU0_MCTARGETDESC_CPU0BASEINFO_H</span>

<span class="cp">#include &quot;Cpu0Config.h&quot;</span>

<span class="cp">#include &quot;Cpu0MCTargetDesc.h&quot;</span>
<span class="cp">#include &quot;llvm/MC/MCExpr.h&quot;</span>
<span class="cp">#include &quot;llvm/Support/DataTypes.h&quot;</span>
<span class="cp">#include &quot;llvm/Support/ErrorHandling.h&quot;</span>

<span class="k">namespace</span> <span class="n">llvm</span> <span class="p">{</span>

<span class="c1">/// Cpu0II - This namespace holds all of the target specific flags that</span>
<span class="c1">/// instruction info tracks.</span>
<span class="c1">//@Cpu0II</span>
<span class="k">namespace</span> <span class="n">Cpu0II</span> <span class="p">{</span>
  <span class="c1">/// Target Operand Flag enum.</span>
  <span class="k">enum</span> <span class="n">TOF</span> <span class="p">{</span>
    <span class="c1">//===------------------------------------------------------------------===//</span>
    <span class="c1">// Cpu0 Specific MachineOperand flags.</span>

    <span class="n">MO_NO_FLAG</span><span class="p">,</span>

    <span class="c1">/// MO_GOT_CALL - Represents the offset into the global offset table at</span>
    <span class="c1">/// which the address of a call site relocation entry symbol resides</span>
    <span class="c1">/// during execution. This is different from the above since this flag</span>
    <span class="c1">/// can only be present in call instructions.</span>
    <span class="n">MO_GOT_CALL</span><span class="p">,</span>

    <span class="c1">/// MO_GPREL - Represents the offset from the current gp value to be used</span>
    <span class="c1">/// for the relocatable object file being produced.</span>
    <span class="n">MO_GPREL</span><span class="p">,</span>

    <span class="c1">/// MO_ABS_HI/LO - Represents the hi or low part of an absolute symbol</span>
    <span class="c1">/// address.</span>
    <span class="n">MO_ABS_HI</span><span class="p">,</span>
    <span class="n">MO_ABS_LO</span><span class="p">,</span>

    <span class="n">MO_GOT_DISP</span><span class="p">,</span>
    <span class="n">MO_GOT_PAGE</span><span class="p">,</span>
    <span class="n">MO_GOT_OFST</span><span class="p">,</span>

    <span class="c1">// N32/64 Flags.</span>
    <span class="n">MO_GPOFF_HI</span><span class="p">,</span>
    <span class="n">MO_GPOFF_LO</span><span class="p">,</span>

    <span class="c1">/// MO_GOT_HI16/LO16 - Relocations used for large GOTs.</span>
    <span class="n">MO_GOT_HI16</span><span class="p">,</span>
    <span class="n">MO_GOT_LO16</span>
  <span class="p">};</span> <span class="c1">// enum TOF {</span>

  <span class="k">enum</span> <span class="p">{</span>
    <span class="c1">//===------------------------------------------------------------------===//</span>
    <span class="c1">// Instruction encodings.  These are the standard/most common forms for</span>
    <span class="c1">// Cpu0 instructions.</span>
    <span class="c1">//</span>

    <span class="c1">// Pseudo - This represents an instruction that is a pseudo instruction</span>
    <span class="c1">// or one that has not been implemented yet.  It is illegal to code generate</span>
    <span class="c1">// it, but tolerated for intermediate implementation stages.</span>
    <span class="n">Pseudo</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>

    <span class="c1">/// FrmR - This form is for instructions of the format R.</span>
    <span class="n">FrmR</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="c1">/// FrmI - This form is for instructions of the format I.</span>
    <span class="n">FrmI</span>  <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="c1">/// FrmJ - This form is for instructions of the format J.</span>
    <span class="n">FrmJ</span>  <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="c1">/// FrmOther - This form is for instructions that have no specific format.</span>
    <span class="n">FrmOther</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>

    <span class="n">FormMask</span> <span class="o">=</span> <span class="mi">15</span>
  <span class="p">};</span>
<span class="p">}</span>

<span class="p">}</span>

<span class="cp">#endif</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_2/Cpu0MCAsmInfo.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">//===-- Cpu0MCAsmInfo.h - Cpu0 Asm Info ------------------------*- C++ -*--===//</span>
<span class="c1">//</span>
<span class="c1">//                     The LLVM Compiler Infrastructure</span>
<span class="c1">//</span>
<span class="c1">// This file is distributed under the University of Illinois Open Source</span>
<span class="c1">// License. See LICENSE.TXT for details.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="c1">//</span>
<span class="c1">// This file contains the declaration of the Cpu0MCAsmInfo class.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>

<span class="cp">#ifndef LLVM_LIB_TARGET_CPU0_MCTARGETDESC_CPU0MCASMINFO_H</span>
<span class="cp">#define LLVM_LIB_TARGET_CPU0_MCTARGETDESC_CPU0MCASMINFO_H</span>

<span class="cp">#include &quot;Cpu0Config.h&quot;</span>
<span class="cp">#if CH &gt;= CH3_2</span>

<span class="cp">#include &quot;llvm/MC/MCAsmInfoELF.h&quot;</span>

<span class="k">namespace</span> <span class="n">llvm</span> <span class="p">{</span>
  <span class="k">class</span> <span class="nc">Triple</span><span class="p">;</span>

  <span class="k">class</span> <span class="nc">Cpu0MCAsmInfo</span> <span class="o">:</span> <span class="k">public</span> <span class="n">MCAsmInfoELF</span> <span class="p">{</span>
    <span class="kt">void</span> <span class="n">anchor</span><span class="p">()</span> <span class="n">override</span><span class="p">;</span>
  <span class="nl">public:</span>
    <span class="k">explicit</span> <span class="nf">Cpu0MCAsmInfo</span><span class="p">(</span><span class="k">const</span> <span class="n">Triple</span> <span class="o">&amp;</span><span class="n">TheTriple</span><span class="p">);</span>
  <span class="p">};</span>

<span class="p">}</span> <span class="c1">// namespace llvm</span>

<span class="cp">#endif </span><span class="c1">// #if CH &gt;= CH3_2</span>

<span class="cp">#endif</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_2/Cpu0MCAsmInfo.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">//===-- Cpu0MCAsmInfo.cpp - Cpu0 Asm Properties ---------------------------===//</span>
<span class="c1">//</span>
<span class="c1">//                     The LLVM Compiler Infrastructure</span>
<span class="c1">//</span>
<span class="c1">// This file is distributed under the University of Illinois Open Source</span>
<span class="c1">// License. See LICENSE.TXT for details.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="c1">//</span>
<span class="c1">// This file contains the declarations of the Cpu0MCAsmInfo properties.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>

<span class="cp">#include &quot;Cpu0MCAsmInfo.h&quot;</span>
<span class="cp">#if CH &gt;= CH3_2</span>

<span class="cp">#include &quot;llvm/ADT/Triple.h&quot;</span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">llvm</span><span class="p">;</span>

<span class="kt">void</span> <span class="n">Cpu0MCAsmInfo</span><span class="o">::</span><span class="n">anchor</span><span class="p">()</span> <span class="p">{</span> <span class="p">}</span>

<span class="n">Cpu0MCAsmInfo</span><span class="o">::</span><span class="n">Cpu0MCAsmInfo</span><span class="p">(</span><span class="k">const</span> <span class="n">Triple</span> <span class="o">&amp;</span><span class="n">TheTriple</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">((</span><span class="n">TheTriple</span><span class="p">.</span><span class="n">getArch</span><span class="p">()</span> <span class="o">==</span> <span class="n">Triple</span><span class="o">::</span><span class="n">cpu0</span><span class="p">))</span>
    <span class="n">IsLittleEndian</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span> <span class="c1">// the default of IsLittleEndian is true</span>

  <span class="n">AlignmentIsInBytes</span>          <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
  <span class="n">Data16bitsDirective</span>         <span class="o">=</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">.2byte</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">;</span>
  <span class="n">Data32bitsDirective</span>         <span class="o">=</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">.4byte</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">;</span>
  <span class="n">Data64bitsDirective</span>         <span class="o">=</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">.8byte</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">;</span>
  <span class="n">PrivateGlobalPrefix</span>         <span class="o">=</span> <span class="s">&quot;$&quot;</span><span class="p">;</span>
<span class="c1">// PrivateLabelPrefix: display $BB for the labels of basic block</span>
  <span class="n">PrivateLabelPrefix</span>          <span class="o">=</span> <span class="s">&quot;$&quot;</span><span class="p">;</span>
  <span class="n">CommentString</span>               <span class="o">=</span> <span class="s">&quot;#&quot;</span><span class="p">;</span>
  <span class="n">ZeroDirective</span>               <span class="o">=</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">.space</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">;</span>
  <span class="n">GPRel32Directive</span>            <span class="o">=</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">.gpword</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">;</span>
  <span class="n">GPRel64Directive</span>            <span class="o">=</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">.gpdword</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">;</span>
  <span class="n">WeakRefDirective</span>            <span class="o">=</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">.weak</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">;</span>
  <span class="n">UseAssignmentForEHBegin</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

  <span class="n">SupportsDebugInformation</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="n">ExceptionsType</span> <span class="o">=</span> <span class="n">ExceptionHandling</span><span class="o">::</span><span class="n">DwarfCFI</span><span class="p">;</span>
  <span class="n">DwarfRegNumForCFI</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="c1">// #if CH &gt;= CH3_2</span>
</pre></div>
</div>
<p>Finally, add code in Cpu0MCTargetDesc.cpp to register Cpu0InstPrinter as
below. By the way, it registers other classes (register, instruction and
subtarget) which defined in Chapter3_1 at this point.</p>
<p class="rubric">lbdex/chapters/Chapter3_2/MCTargetDesc/Cpu0MCTargetDesc.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="k">namespace</span> <span class="n">llvm</span> <span class="p">{</span>
<span class="k">class</span> <span class="nc">MCAsmBackend</span><span class="p">;</span>
<span class="k">class</span> <span class="nc">MCCodeEmitter</span><span class="p">;</span>
<span class="k">class</span> <span class="nc">MCContext</span><span class="p">;</span>
<span class="k">class</span> <span class="nc">MCInstrInfo</span><span class="p">;</span>
<span class="k">class</span> <span class="nc">MCObjectWriter</span><span class="p">;</span>
<span class="k">class</span> <span class="nc">MCRegisterInfo</span><span class="p">;</span>
<span class="k">class</span> <span class="nc">MCSubtargetInfo</span><span class="p">;</span>
<span class="k">class</span> <span class="nc">StringRef</span><span class="p">;</span>
<span class="p">...</span>
<span class="k">class</span> <span class="nc">raw_ostream</span><span class="p">;</span>
<span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_2/MCTargetDesc/Cpu0MCTargetDesc.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="cp">#include &quot;InstPrinter/Cpu0InstPrinter.h&quot;</span>
<span class="cp">#include &quot;Cpu0MCAsmInfo.h&quot;</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">/// Select the Cpu0 Architecture Feature for the given triple and cpu name.</span>
<span class="c1">/// The function will be called at command &#39;llvm-objdump -d&#39; for Cpu0 elf input.</span>
<span class="k">static</span> <span class="n">StringRef</span> <span class="nf">selectCpu0ArchFeature</span><span class="p">(</span><span class="k">const</span> <span class="n">Triple</span> <span class="o">&amp;</span><span class="n">TT</span><span class="p">,</span> <span class="n">StringRef</span> <span class="n">CPU</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">Cpu0ArchFeature</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">CPU</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="o">||</span> <span class="n">CPU</span> <span class="o">==</span> <span class="s">&quot;generic&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">TT</span><span class="p">.</span><span class="n">getArch</span><span class="p">()</span> <span class="o">==</span> <span class="n">Triple</span><span class="o">::</span><span class="n">cpu0</span> <span class="o">||</span> <span class="n">TT</span><span class="p">.</span><span class="n">getArch</span><span class="p">()</span> <span class="o">==</span> <span class="n">Triple</span><span class="o">::</span><span class="n">cpu0el</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">CPU</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="o">||</span> <span class="n">CPU</span> <span class="o">==</span> <span class="s">&quot;cpu032II&quot;</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Cpu0ArchFeature</span> <span class="o">=</span> <span class="s">&quot;+cpu032II&quot;</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">CPU</span> <span class="o">==</span> <span class="s">&quot;cpu032I&quot;</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">Cpu0ArchFeature</span> <span class="o">=</span> <span class="s">&quot;+cpu032I&quot;</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">Cpu0ArchFeature</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1">//@1 }</span>

<span class="k">static</span> <span class="n">MCInstrInfo</span> <span class="o">*</span><span class="nf">createCpu0MCInstrInfo</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">MCInstrInfo</span> <span class="o">*</span><span class="n">X</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MCInstrInfo</span><span class="p">();</span>
  <span class="n">InitCpu0MCInstrInfo</span><span class="p">(</span><span class="n">X</span><span class="p">);</span> <span class="c1">// defined in Cpu0GenInstrInfo.inc</span>
  <span class="k">return</span> <span class="n">X</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">MCRegisterInfo</span> <span class="o">*</span><span class="nf">createCpu0MCRegisterInfo</span><span class="p">(</span><span class="k">const</span> <span class="n">Triple</span> <span class="o">&amp;</span><span class="n">TT</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">MCRegisterInfo</span> <span class="o">*</span><span class="n">X</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MCRegisterInfo</span><span class="p">();</span>
  <span class="n">InitCpu0MCRegisterInfo</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">SW</span><span class="p">);</span> <span class="c1">// defined in Cpu0GenRegisterInfo.inc</span>
  <span class="k">return</span> <span class="n">X</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">MCSubtargetInfo</span> <span class="o">*</span><span class="nf">createCpu0MCSubtargetInfo</span><span class="p">(</span><span class="k">const</span> <span class="n">Triple</span> <span class="o">&amp;</span><span class="n">TT</span><span class="p">,</span>
                                                  <span class="n">StringRef</span> <span class="n">CPU</span><span class="p">,</span> <span class="n">StringRef</span> <span class="n">FS</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">ArchFS</span> <span class="o">=</span> <span class="n">selectCpu0ArchFeature</span><span class="p">(</span><span class="n">TT</span><span class="p">,</span><span class="n">CPU</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">FS</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ArchFS</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
      <span class="n">ArchFS</span> <span class="o">=</span> <span class="n">ArchFS</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span> <span class="o">+</span> <span class="n">FS</span><span class="p">.</span><span class="n">str</span><span class="p">();</span>
    <span class="k">else</span>
      <span class="n">ArchFS</span> <span class="o">=</span> <span class="n">FS</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">createCpu0MCSubtargetInfoImpl</span><span class="p">(</span><span class="n">TT</span><span class="p">,</span> <span class="n">CPU</span><span class="p">,</span> <span class="n">ArchFS</span><span class="p">);</span>
<span class="c1">// createCpu0MCSubtargetInfoImpl defined in Cpu0GenSubtargetInfo.inc</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">MCAsmInfo</span> <span class="o">*</span><span class="nf">createCpu0MCAsmInfo</span><span class="p">(</span><span class="k">const</span> <span class="n">MCRegisterInfo</span> <span class="o">&amp;</span><span class="n">MRI</span><span class="p">,</span>
                                      <span class="k">const</span> <span class="n">Triple</span> <span class="o">&amp;</span><span class="n">TT</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">MCAsmInfo</span> <span class="o">*</span><span class="n">MAI</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Cpu0MCAsmInfo</span><span class="p">(</span><span class="n">TT</span><span class="p">);</span>

  <span class="kt">unsigned</span> <span class="n">SP</span> <span class="o">=</span> <span class="n">MRI</span><span class="p">.</span><span class="n">getDwarfRegNum</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">SP</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
  <span class="n">MCCFIInstruction</span> <span class="n">Inst</span> <span class="o">=</span> <span class="n">MCCFIInstruction</span><span class="o">::</span><span class="n">createDefCfa</span><span class="p">(</span><span class="n">nullptr</span><span class="p">,</span> <span class="n">SP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">MAI</span><span class="o">-&gt;</span><span class="n">addInitialFrameState</span><span class="p">(</span><span class="n">Inst</span><span class="p">);</span>

  <span class="k">return</span> <span class="n">MAI</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">MCCodeGenInfo</span> <span class="o">*</span><span class="nf">createCpu0MCCodeGenInfo</span><span class="p">(</span><span class="k">const</span> <span class="n">Triple</span> <span class="o">&amp;</span><span class="n">TT</span><span class="p">,</span> <span class="n">Reloc</span><span class="o">::</span><span class="n">Model</span> <span class="n">RM</span><span class="p">,</span>
                                              <span class="n">CodeModel</span><span class="o">::</span><span class="n">Model</span> <span class="n">CM</span><span class="p">,</span>
                                              <span class="n">CodeGenOpt</span><span class="o">::</span><span class="n">Level</span> <span class="n">OL</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">MCCodeGenInfo</span> <span class="o">*</span><span class="n">X</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MCCodeGenInfo</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">CM</span> <span class="o">==</span> <span class="n">CodeModel</span><span class="o">::</span><span class="n">JITDefault</span><span class="p">)</span>
    <span class="n">RM</span> <span class="o">=</span> <span class="n">Reloc</span><span class="o">::</span><span class="n">Static</span><span class="p">;</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">RM</span> <span class="o">==</span> <span class="n">Reloc</span><span class="o">::</span><span class="n">Default</span><span class="p">)</span>
    <span class="n">RM</span> <span class="o">=</span> <span class="n">Reloc</span><span class="o">::</span><span class="n">PIC_</span><span class="p">;</span>
  <span class="n">X</span><span class="o">-&gt;</span><span class="n">initMCCodeGenInfo</span><span class="p">(</span><span class="n">RM</span><span class="p">,</span> <span class="n">CM</span><span class="p">,</span> <span class="n">OL</span><span class="p">);</span> <span class="c1">// defined in lib/MC/MCCodeGenInfo.cpp</span>
  <span class="k">return</span> <span class="n">X</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">MCInstPrinter</span> <span class="o">*</span><span class="nf">createCpu0MCInstPrinter</span><span class="p">(</span><span class="k">const</span> <span class="n">Triple</span> <span class="o">&amp;</span><span class="n">T</span><span class="p">,</span>
                                              <span class="kt">unsigned</span> <span class="n">SyntaxVariant</span><span class="p">,</span>
                                              <span class="k">const</span> <span class="n">MCAsmInfo</span> <span class="o">&amp;</span><span class="n">MAI</span><span class="p">,</span>
                                              <span class="k">const</span> <span class="n">MCInstrInfo</span> <span class="o">&amp;</span><span class="n">MII</span><span class="p">,</span>
                                              <span class="k">const</span> <span class="n">MCRegisterInfo</span> <span class="o">&amp;</span><span class="n">MRI</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="n">Cpu0InstPrinter</span><span class="p">(</span><span class="n">MAI</span><span class="p">,</span> <span class="n">MII</span><span class="p">,</span> <span class="n">MRI</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">//@2 {</span>
<span class="k">extern</span> <span class="s">&quot;C&quot;</span> <span class="kt">void</span> <span class="n">LLVMInitializeCpu0TargetMC</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">Target</span> <span class="o">*</span><span class="n">T</span> <span class="o">:</span> <span class="p">{</span><span class="o">&amp;</span><span class="n">TheCpu0Target</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">TheCpu0elTarget</span><span class="p">})</span> <span class="p">{</span>
    <span class="c1">// Register the MC asm info.</span>
    <span class="n">RegisterMCAsmInfoFn</span> <span class="n">X</span><span class="p">(</span><span class="o">*</span><span class="n">T</span><span class="p">,</span> <span class="n">createCpu0MCAsmInfo</span><span class="p">);</span>

    <span class="c1">// Register the MC codegen info.</span>
    <span class="n">TargetRegistry</span><span class="o">::</span><span class="n">RegisterMCCodeGenInfo</span><span class="p">(</span><span class="o">*</span><span class="n">T</span><span class="p">,</span>
	                                      <span class="n">createCpu0MCCodeGenInfo</span><span class="p">);</span>

    <span class="c1">// Register the MC instruction info.</span>
    <span class="n">TargetRegistry</span><span class="o">::</span><span class="n">RegisterMCInstrInfo</span><span class="p">(</span><span class="o">*</span><span class="n">T</span><span class="p">,</span> <span class="n">createCpu0MCInstrInfo</span><span class="p">);</span>

    <span class="c1">// Register the MC register info.</span>
    <span class="n">TargetRegistry</span><span class="o">::</span><span class="n">RegisterMCRegInfo</span><span class="p">(</span><span class="o">*</span><span class="n">T</span><span class="p">,</span> <span class="n">createCpu0MCRegisterInfo</span><span class="p">);</span>

    <span class="c1">// Register the MC subtarget info.</span>
    <span class="n">TargetRegistry</span><span class="o">::</span><span class="n">RegisterMCSubtargetInfo</span><span class="p">(</span><span class="o">*</span><span class="n">T</span><span class="p">,</span>
	                                        <span class="n">createCpu0MCSubtargetInfo</span><span class="p">);</span>
    <span class="c1">// Register the MCInstPrinter.</span>
    <span class="n">TargetRegistry</span><span class="o">::</span><span class="n">RegisterMCInstPrinter</span><span class="p">(</span><span class="o">*</span><span class="n">T</span><span class="p">,</span>
	                                      <span class="n">createCpu0MCInstPrinter</span><span class="p">);</span>
  <span class="p">}</span>

<span class="p">}</span>
<span class="c1">//@2 }</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_2/MCTargetDesc/CMakeLists.txt</p>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="n">Cpu0MCAsmInfo</span><span class="p">.</span><span class="n">cpp</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_2/MCTargetDesc/LLVMBuild.txt</p>
<div class="highlight-c++"><div class="highlight"><pre>                     <span class="n">Cpu0AsmPrinter</span> 
</pre></div>
</div>
<p>To make the registration clearly, summary as follows,</p>
<p class="rubric">Register function of MC asm info</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="k">for</span> <span class="p">(</span><span class="n">Target</span> <span class="o">*</span><span class="n">T</span> <span class="o">:</span> <span class="p">{</span><span class="o">&amp;</span><span class="n">TheCpu0Target</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">TheCpu0elTarget</span><span class="p">})</span> <span class="p">{</span>
  <span class="c1">// Register the MC asm info.</span>
  <span class="n">RegisterMCAsmInfoFn</span> <span class="n">X</span><span class="p">(</span><span class="o">*</span><span class="n">T</span><span class="p">,</span> <span class="n">createCpu0MCAsmInfo</span><span class="p">);</span>


    <span class="k">static</span> <span class="n">MCAsmInfo</span> <span class="o">*</span><span class="nf">createCpu0MCAsmInfo</span><span class="p">(</span><span class="k">const</span>
    <span class="n">MCRegisterInfo</span> <span class="o">&amp;</span><span class="n">MRI</span><span class="p">,</span> <span class="n">StringRef</span> <span class="n">TT</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">MCAsmInfo</span> <span class="o">*</span><span class="n">MAI</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Cpu0MCAsmInfo</span><span class="p">(</span><span class="n">TT</span><span class="p">);</span>

      <span class="kt">unsigned</span> <span class="n">SP</span> <span class="o">=</span> <span class="n">MRI</span><span class="p">.</span><span class="n">getDwarfRegNum</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">SP</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
      <span class="n">MCCFIInstruction</span> <span class="n">Inst</span> <span class="o">=</span> <span class="n">MCCFIInstruction</span><span class="o">::</span>
    <span class="n">createDefCfa</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">SP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
      <span class="n">MAI</span><span class="o">-&gt;</span><span class="n">addInitialFrameState</span><span class="p">(</span><span class="n">Inst</span><span class="p">);</span>

      <span class="k">return</span> <span class="n">MAI</span><span class="p">;</span>
    <span class="p">}</span>
</pre></div>
</div>
<p>Above registering the object of class Cpu0MCAsmInfo for
target TheCpu0Target and TheCpu0elTarget.
TheCpu0Target is for big endian and TheCpu0elTarget is for little endian.
Cpu0MCAsmInfo is derived from MCAsmInfo which is an llvm built-in class.
Most code is implemented in it&#8217;s parent, back end reuses those code by
inheritance.</p>
<p class="rubric">Register function of MC codegen info</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">// Register the MC codegen info.</span>
<span class="n">TargetRegistry</span><span class="o">::</span><span class="n">RegisterMCCodeGenInfo</span><span class="p">(</span><span class="o">*</span><span class="n">T</span><span class="p">,</span>
                                            <span class="n">createCpu0MCCodeGenInfo</span><span class="p">);</span>


    <span class="k">static</span> <span class="n">MCCodeGenInfo</span> <span class="o">*</span><span class="nf">createCpu0MCCodeGenInfo</span><span class="p">(</span>
                                          <span class="n">StringRef</span> <span class="n">TT</span><span class="p">,</span> <span class="n">Reloc</span><span class="o">::</span><span class="n">Model</span> <span class="n">RM</span><span class="p">,</span>
                                                  <span class="n">CodeModel</span><span class="o">::</span><span class="n">Model</span> <span class="n">CM</span><span class="p">,</span>
                                                  <span class="n">CodeGenOpt</span><span class="o">::</span><span class="n">Level</span> <span class="n">OL</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">MCCodeGenInfo</span> <span class="o">*</span><span class="n">X</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MCCodeGenInfo</span><span class="p">();</span>
      <span class="p">...</span>
     <span class="c1">// defined in lib/MC/MCCodeGenInfo.cpp</span>
      <span class="n">X</span><span class="o">-&gt;</span><span class="n">InitMCCodeGenInfo</span><span class="p">(</span><span class="n">RM</span><span class="p">,</span> <span class="n">CM</span><span class="p">,</span> <span class="n">OL</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">X</span><span class="p">;</span>
    <span class="p">}</span>
</pre></div>
</div>
<p>Above instancing MCCodeGenInfo, and initialize it by
pass RM=Roloc::PIC when user compiling with position-independent code mode
through command <tt class="docutils literal"><span class="pre">llc</span> <span class="pre">-relocation-model=pic</span></tt> or <tt class="docutils literal"><span class="pre">llc</span></tt> (default relocation
mode is pic).
Recall there are two addressing mode in system program book, one is PIC
mode, the other is absolute addressing mode.
MC stands for Machine Code.</p>
<p class="rubric">Register function of MC instruction info</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">// Register the MC instruction info.</span>
<span class="n">TargetRegistry</span><span class="o">::</span><span class="n">RegisterMCInstrInfo</span><span class="p">(</span><span class="o">*</span><span class="n">T</span><span class="p">,</span> <span class="n">createCpu0MCInstrInfo</span><span class="p">);</span>


   <span class="k">static</span> <span class="n">MCInstrInfo</span> <span class="o">*</span><span class="nf">createCpu0MCInstrInfo</span><span class="p">()</span> <span class="p">{</span>
   <span class="n">MCInstrInfo</span> <span class="o">*</span><span class="n">X</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MCInstrInfo</span><span class="p">();</span>
   <span class="c1">// defined in Cpu0GenInstrInfo.inc</span>
<span class="o">|---</span> <span class="n">InitCpu0MCInstrInfo</span><span class="p">(</span><span class="n">X</span><span class="p">);</span>
<span class="o">|</span>    <span class="k">return</span> <span class="n">X</span><span class="p">;</span>
<span class="o">|</span>  <span class="p">}</span>
<span class="o">|</span>      <span class="c1">// Cpu0GenInstrInfo.inc</span>
<span class="o">|</span>      <span class="k">extern</span> <span class="k">const</span> <span class="n">MCInstrDesc</span> <span class="n">Cpu0Insts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="o">|</span>      <span class="c1">// Info generated from Cpu0InstrInfo.td</span>
<span class="o">|</span>      <span class="p">}</span>
<span class="o">|---&gt;</span>  <span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">InitCpu0MCInstrInfo</span><span class="p">(</span>
                             <span class="n">MCInstrInfo</span> <span class="o">*</span><span class="n">II</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">II</span><span class="o">-&gt;</span><span class="n">InitMCInstrInfo</span><span class="p">(</span><span class="n">Cpu0Insts</span><span class="p">,</span> <span class="p">...);</span>
       <span class="p">}</span>
</pre></div>
</div>
<p>Above instancing MCInstrInfo object X, and initialize it
by InitCpu0MCInstrInfo(X).
Since InitCpu0MCInstrInfo(X) is defined in Cpu0GenInstrInfo.inc, this function
will add the information from Cpu0InstrInfo.td we specified.</p>
<p class="rubric">Register function of MCInstPrinter</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">// Register the MC instruction info.</span>
<span class="n">TargetRegistry</span><span class="o">::</span><span class="n">RegisterMCInstrInfo</span><span class="p">(</span><span class="o">*</span><span class="n">T</span><span class="p">,</span> <span class="n">createCpu0MCInstrInfo</span><span class="p">);</span>


    <span class="k">static</span> <span class="n">MCInstPrinter</span> <span class="o">*</span><span class="nf">createCpu0MCInstPrinter</span><span class="p">(</span>
                                                 <span class="k">const</span> <span class="n">Target</span> <span class="o">&amp;</span><span class="n">T</span><span class="p">,</span>
                                                  <span class="kt">unsigned</span> <span class="n">SyntaxVariant</span><span class="p">,</span>
                                                  <span class="k">const</span> <span class="n">MCAsmInfo</span> <span class="o">&amp;</span><span class="n">MAI</span><span class="p">,</span>
                                                  <span class="k">const</span> <span class="n">MCInstrInfo</span> <span class="o">&amp;</span><span class="n">MII</span><span class="p">,</span>
                                                  <span class="k">const</span> <span class="n">MCRegisterInfo</span> <span class="o">&amp;</span><span class="n">MRI</span><span class="p">,</span>
                                                  <span class="k">const</span> <span class="n">MCSubtargetInfo</span> <span class="o">&amp;</span><span class="n">STI</span><span class="p">)</span>
    <span class="p">{</span>
  <span class="o">|---</span> <span class="k">return</span> <span class="k">new</span> <span class="n">Cpu0InstPrinter</span><span class="p">(</span><span class="n">MAI</span><span class="p">,</span> <span class="n">MII</span><span class="p">,</span> <span class="n">MRI</span><span class="p">);</span>
  <span class="o">|</span>  <span class="p">}</span>
  <span class="o">|</span>
  <span class="o">|</span>      <span class="c1">// Cpu0InstPrinter.h</span>
  <span class="o">|---&gt;</span>  <span class="n">Cpu0InstPrinter</span><span class="p">(</span><span class="k">const</span> <span class="n">MCAsmInfo</span> <span class="o">&amp;</span><span class="n">MAI</span><span class="p">,</span>
                         <span class="k">const</span> <span class="n">MCInstrInfo</span> <span class="o">&amp;</span><span class="n">MII</span><span class="p">,</span>
                          <span class="k">const</span> <span class="n">MCRegisterInfo</span> <span class="o">&amp;</span><span class="n">MRI</span><span class="p">)</span>
            <span class="o">:</span> <span class="n">MCInstPrinter</span><span class="p">(</span><span class="n">MAI</span><span class="p">,</span> <span class="n">MII</span><span class="p">,</span> <span class="n">MRI</span><span class="p">)</span> <span class="p">{}</span>
</pre></div>
</div>
<p>Above instancing Cpu0InstPrinter to take care printing
function for instructions.</p>
<p class="rubric">Register function of RegisterInfo</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">// Register the MC register info.</span>
<span class="n">TargetRegistry</span><span class="o">::</span><span class="n">RegisterMCRegInfo</span><span class="p">(</span><span class="o">*</span><span class="n">T</span><span class="p">,</span> <span class="n">createCpu0MCRegisterInfo</span><span class="p">);</span>


   <span class="k">static</span> <span class="n">MCRegisterInfo</span> <span class="o">*</span><span class="nf">createCpu0MCRegisterInfo</span><span class="p">(</span>
   <span class="n">StringRef</span> <span class="n">TT</span><span class="p">)</span> <span class="p">{</span>
   <span class="n">MCRegisterInfo</span> <span class="o">*</span><span class="n">X</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MCRegisterInfo</span><span class="p">();</span>
   <span class="c1">// defined in Cpu0GenRegisterInfo.inc</span>
<span class="o">|---</span> <span class="n">InitCpu0MCRegisterInfo</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">LR</span><span class="p">);</span>
<span class="o">|</span>    <span class="k">return</span> <span class="n">X</span><span class="p">;</span>
<span class="o">|</span>  <span class="p">}</span>
<span class="o">|</span>
<span class="o">|</span>      <span class="c1">// Cpu0GenRegisterInfo.inc</span>
<span class="o">|---&gt;</span>  <span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">InitCpu0MCRegisterInfo</span><span class="p">(</span>
       <span class="n">MCRegisterInfo</span> <span class="o">*</span><span class="n">RI</span><span class="p">,</span> <span class="p">...)</span> <span class="p">{</span>
         <span class="n">RI</span><span class="o">-&gt;</span><span class="n">InitMCRegisterInfo</span><span class="p">(</span><span class="n">Cpu0RegDesc</span><span class="p">,</span> <span class="p">...)</span>
       <span class="p">}</span>
</pre></div>
</div>
<p>Above is similar to &#8220;Register function of MC instruction info&#8221;, but it
initialize the register information specified in Cpu0RegisterInfo.td.
They share some values from instruction/register td description.
No need to specify them again in Initilize routine if they are consistant with
td description files.</p>
<p class="rubric">Register function of SubtargetInfo</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">// Register the MC subtarget info.</span>
<span class="n">TargetRegistry</span><span class="o">::</span><span class="n">RegisterMCSubtargetInfo</span><span class="p">(</span><span class="o">*</span><span class="n">T</span><span class="p">,</span>
                                     <span class="n">createCpu0MCSubtargetInfo</span><span class="p">);</span>


   <span class="k">static</span> <span class="n">MCSubtargetInfo</span> <span class="o">*</span><span class="nf">createCpu0MCSubtargetInfo</span><span class="p">(</span>
              <span class="n">StringRef</span> <span class="n">TT</span><span class="p">,</span> <span class="n">StringRef</span> <span class="n">CPU</span><span class="p">,</span>  <span class="n">StringRef</span> <span class="n">FS</span><span class="p">)</span> <span class="p">{</span>
     <span class="p">...</span>
     <span class="n">MCSubtargetInfo</span> <span class="o">*</span><span class="n">X</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MCSubtargetInfo</span><span class="p">();</span>
     <span class="c1">// defined in Cpu0GenSubtargetInfo.inc</span>
<span class="o">|---</span> <span class="n">InitCpu0MCSubtargetInfo</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">TT</span><span class="p">,</span> <span class="n">CPU</span><span class="p">,</span> <span class="n">ArchFS</span><span class="p">);</span>
<span class="o">|</span>    <span class="k">return</span> <span class="n">X</span><span class="p">;</span>
<span class="o">|</span>  <span class="p">}</span>
<span class="o">|</span>      <span class="c1">// Cpu0GenSubtargetInfo.inc</span>
<span class="o">|---&gt;</span>  <span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">InitCpu0MCSubtargetInfo</span><span class="p">(</span>
       <span class="n">MCSubtargetInfo</span> <span class="o">*</span><span class="n">II</span><span class="p">,</span> <span class="n">StringRef</span> <span class="n">TT</span><span class="p">,</span>
       <span class="n">StringRef</span> <span class="n">CPU</span><span class="p">,</span> <span class="n">StringRef</span> <span class="n">FS</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">II</span><span class="o">-&gt;</span><span class="n">InitMCSubtargetInfo</span><span class="p">(</span><span class="n">TT</span><span class="p">,</span> <span class="n">CPU</span><span class="p">,</span> <span class="n">FS</span><span class="p">,</span>
              <span class="n">Cpu0FeatureKV</span><span class="p">,</span> <span class="p">...);</span>
       <span class="p">}</span>
</pre></div>
</div>
<p>Above instancing MCSubtargetInfo object and initialize with
Cpu0.td information.</p>
<p>According &#8220;section Target Registration&#8221; <a class="footnote-reference" href="#registration" id="id3">[3]</a>, we can register Cpu0
backend classes at LLVMInitializeCpu0TargetMC() on demand by the dynamic
register mechanism as the above function, LLVMInitializeCpu0TargetMC().</p>
<p>Now, it&#8217;s time to work with AsmPrinter as follows,</p>
<p class="rubric">lbdex/chapters/Chapter3_2/Cpu0AsmPrinter.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">//===-- Cpu0AsmPrinter.h - Cpu0 LLVM Assembly Printer ----------*- C++ -*--===//</span>
<span class="c1">//</span>
<span class="c1">//                     The LLVM Compiler Infrastructure</span>
<span class="c1">//</span>
<span class="c1">// This file is distributed under the University of Illinois Open Source</span>
<span class="c1">// License. See LICENSE.TXT for details.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="c1">//</span>
<span class="c1">// Cpu0 Assembly printer class.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>

<span class="cp">#ifndef LLVM_LIB_TARGET_CPU0_CPU0ASMPRINTER_H</span>
<span class="cp">#define LLVM_LIB_TARGET_CPU0_CPU0ASMPRINTER_H</span>

<span class="cp">#include &quot;Cpu0Config.h&quot;</span>

<span class="cp">#include &quot;Cpu0MachineFunction.h&quot;</span>
<span class="cp">#include &quot;Cpu0MCInstLower.h&quot;</span>
<span class="cp">#include &quot;Cpu0Subtarget.h&quot;</span>
<span class="cp">#include &quot;Cpu0TargetMachine.h&quot;</span>
<span class="cp">#include &quot;llvm/CodeGen/AsmPrinter.h&quot;</span>
<span class="cp">#include &quot;llvm/MC/MCStreamer.h&quot;</span>
<span class="cp">#include &quot;llvm/Support/Compiler.h&quot;</span>
<span class="cp">#include &quot;llvm/Target/TargetMachine.h&quot;</span>

<span class="k">namespace</span> <span class="n">llvm</span> <span class="p">{</span>
<span class="k">class</span> <span class="nc">MCStreamer</span><span class="p">;</span>
<span class="k">class</span> <span class="nc">MachineInstr</span><span class="p">;</span>
<span class="k">class</span> <span class="nc">MachineBasicBlock</span><span class="p">;</span>
<span class="k">class</span> <span class="nc">Module</span><span class="p">;</span>
<span class="k">class</span> <span class="nc">raw_ostream</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">LLVM_LIBRARY_VISIBILITY</span> <span class="n">Cpu0AsmPrinter</span> <span class="o">:</span> <span class="k">public</span> <span class="n">AsmPrinter</span> <span class="p">{</span>

  <span class="kt">void</span> <span class="n">EmitInstrWithMacroNoAT</span><span class="p">(</span><span class="k">const</span> <span class="n">MachineInstr</span> <span class="o">*</span><span class="n">MI</span><span class="p">);</span>

<span class="nl">private:</span>

  <span class="c1">// lowerOperand - Convert a MachineOperand into the equivalent MCOperand.</span>
  <span class="kt">bool</span> <span class="nf">lowerOperand</span><span class="p">(</span><span class="k">const</span> <span class="n">MachineOperand</span> <span class="o">&amp;</span><span class="n">MO</span><span class="p">,</span> <span class="n">MCOperand</span> <span class="o">&amp;</span><span class="n">MCOp</span><span class="p">);</span>

<span class="nl">public:</span>

  <span class="k">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">*</span><span class="n">Subtarget</span><span class="p">;</span>
  <span class="k">const</span> <span class="n">Cpu0FunctionInfo</span> <span class="o">*</span><span class="n">Cpu0FI</span><span class="p">;</span>
  <span class="n">Cpu0MCInstLower</span> <span class="n">MCInstLowering</span><span class="p">;</span>

  <span class="k">explicit</span> <span class="nf">Cpu0AsmPrinter</span><span class="p">(</span><span class="n">TargetMachine</span> <span class="o">&amp;</span><span class="n">TM</span><span class="p">,</span>
                          <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">MCStreamer</span><span class="o">&gt;</span> <span class="n">Streamer</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">AsmPrinter</span><span class="p">(</span><span class="n">TM</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">Streamer</span><span class="p">)),</span> 
      <span class="n">MCInstLowering</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Subtarget</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Cpu0TargetMachine</span> <span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">TM</span><span class="p">).</span><span class="n">getSubtargetImpl</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">virtual</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">getPassName</span><span class="p">()</span> <span class="k">const</span> <span class="n">override</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s">&quot;Cpu0 Assembly Printer&quot;</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">virtual</span> <span class="kt">bool</span> <span class="n">runOnMachineFunction</span><span class="p">(</span><span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">MF</span><span class="p">)</span> <span class="n">override</span><span class="p">;</span>

<span class="c1">//- EmitInstruction() must exists or will have run time error.</span>
  <span class="kt">void</span> <span class="n">EmitInstruction</span><span class="p">(</span><span class="k">const</span> <span class="n">MachineInstr</span> <span class="o">*</span><span class="n">MI</span><span class="p">)</span> <span class="n">override</span><span class="p">;</span>
  <span class="kt">void</span> <span class="nf">printSavedRegsBitmask</span><span class="p">(</span><span class="n">raw_ostream</span> <span class="o">&amp;</span><span class="n">O</span><span class="p">);</span>
  <span class="kt">void</span> <span class="nf">printHex32</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">Value</span><span class="p">,</span> <span class="n">raw_ostream</span> <span class="o">&amp;</span><span class="n">O</span><span class="p">);</span>
  <span class="kt">void</span> <span class="nf">emitFrameDirective</span><span class="p">();</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">getCurrentABIString</span><span class="p">()</span> <span class="k">const</span><span class="p">;</span>
  <span class="kt">void</span> <span class="n">EmitFunctionEntryLabel</span><span class="p">()</span> <span class="n">override</span><span class="p">;</span>
  <span class="kt">void</span> <span class="n">EmitFunctionBodyStart</span><span class="p">()</span> <span class="n">override</span><span class="p">;</span>
  <span class="kt">void</span> <span class="n">EmitFunctionBodyEnd</span><span class="p">()</span> <span class="n">override</span><span class="p">;</span>
  <span class="kt">void</span> <span class="n">EmitStartOfAsmFile</span><span class="p">(</span><span class="n">Module</span> <span class="o">&amp;</span><span class="n">M</span><span class="p">)</span> <span class="n">override</span><span class="p">;</span>
  <span class="kt">void</span> <span class="nf">PrintDebugValueComment</span><span class="p">(</span><span class="k">const</span> <span class="n">MachineInstr</span> <span class="o">*</span><span class="n">MI</span><span class="p">,</span> <span class="n">raw_ostream</span> <span class="o">&amp;</span><span class="n">OS</span><span class="p">);</span>
<span class="p">};</span>
<span class="p">}</span>

<span class="cp">#endif</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_2/Cpu0AsmPrinter.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">//===-- Cpu0AsmPrinter.cpp - Cpu0 LLVM Assembly Printer -------------------===//</span>
<span class="c1">//</span>
<span class="c1">//                     The LLVM Compiler Infrastructure</span>
<span class="c1">//</span>
<span class="c1">// This file is distributed under the University of Illinois Open Source</span>
<span class="c1">// License. See LICENSE.TXT for details.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="c1">//</span>
<span class="c1">// This file contains a printer that converts from our internal representation</span>
<span class="c1">// of machine-dependent LLVM code to GAS-format CPU0 assembly language.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>

<span class="cp">#include &quot;Cpu0AsmPrinter.h&quot;</span>

<span class="cp">#include &quot;InstPrinter/Cpu0InstPrinter.h&quot;</span>
<span class="cp">#include &quot;MCTargetDesc/Cpu0BaseInfo.h&quot;</span>
<span class="cp">#include &quot;Cpu0.h&quot;</span>
<span class="cp">#include &quot;Cpu0InstrInfo.h&quot;</span>
<span class="cp">#include &quot;llvm/ADT/SmallString.h&quot;</span>
<span class="cp">#include &quot;llvm/ADT/StringExtras.h&quot;</span>
<span class="cp">#include &quot;llvm/ADT/Twine.h&quot;</span>
<span class="cp">#include &quot;llvm/CodeGen/MachineConstantPool.h&quot;</span>
<span class="cp">#include &quot;llvm/CodeGen/MachineFunctionPass.h&quot;</span>
<span class="cp">#include &quot;llvm/CodeGen/MachineFrameInfo.h&quot;</span>
<span class="cp">#include &quot;llvm/CodeGen/MachineInstr.h&quot;</span>
<span class="cp">#include &quot;llvm/CodeGen/MachineMemOperand.h&quot;</span>
<span class="cp">#include &quot;llvm/IR/BasicBlock.h&quot;</span>
<span class="cp">#include &quot;llvm/IR/Instructions.h&quot;</span>
<span class="cp">#include &quot;llvm/IR/Mangler.h&quot;</span>
<span class="cp">#include &quot;llvm/MC/MCAsmInfo.h&quot;</span>
<span class="cp">#include &quot;llvm/MC/MCInst.h&quot;</span>
<span class="cp">#include &quot;llvm/MC/MCStreamer.h&quot;</span>
<span class="cp">#include &quot;llvm/MC/MCSymbol.h&quot;</span>
<span class="cp">#include &quot;llvm/Support/raw_ostream.h&quot;</span>
<span class="cp">#include &quot;llvm/Support/TargetRegistry.h&quot;</span>
<span class="cp">#include &quot;llvm/Target/TargetLoweringObjectFile.h&quot;</span>
<span class="cp">#include &quot;llvm/Target/TargetOptions.h&quot;</span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">llvm</span><span class="p">;</span>

<span class="cp">#define DEBUG_TYPE &quot;cpu0-asm-printer&quot;</span>

<span class="kt">bool</span> <span class="n">Cpu0AsmPrinter</span><span class="o">::</span><span class="n">runOnMachineFunction</span><span class="p">(</span><span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">MF</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">Cpu0FI</span> <span class="o">=</span> <span class="n">MF</span><span class="p">.</span><span class="n">getInfo</span><span class="o">&lt;</span><span class="n">Cpu0FunctionInfo</span><span class="o">&gt;</span><span class="p">();</span>
  <span class="n">AsmPrinter</span><span class="o">::</span><span class="n">runOnMachineFunction</span><span class="p">(</span><span class="n">MF</span><span class="p">);</span>
  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">//@EmitInstruction {</span>
<span class="c1">//- EmitInstruction() must exists or will have run time error.</span>
<span class="kt">void</span> <span class="n">Cpu0AsmPrinter</span><span class="o">::</span><span class="n">EmitInstruction</span><span class="p">(</span><span class="k">const</span> <span class="n">MachineInstr</span> <span class="o">*</span><span class="n">MI</span><span class="p">)</span> <span class="p">{</span>
<span class="c1">//@EmitInstruction body {</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">MI</span><span class="o">-&gt;</span><span class="n">isDebugValue</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">SmallString</span><span class="o">&lt;</span><span class="mi">128</span><span class="o">&gt;</span> <span class="n">Str</span><span class="p">;</span>
    <span class="n">raw_svector_ostream</span> <span class="nf">OS</span><span class="p">(</span><span class="n">Str</span><span class="p">);</span>

    <span class="n">PrintDebugValueComment</span><span class="p">(</span><span class="n">MI</span><span class="p">,</span> <span class="n">OS</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">//@print out instruction:</span>
  <span class="c1">//  Print out both ordinary instruction and boudle instruction</span>
  <span class="n">MachineBasicBlock</span><span class="o">::</span><span class="n">const_instr_iterator</span> <span class="n">I</span> <span class="o">=</span> <span class="n">MI</span><span class="p">;</span>
  <span class="n">MachineBasicBlock</span><span class="o">::</span><span class="n">const_instr_iterator</span> <span class="n">E</span> <span class="o">=</span> <span class="n">MI</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">instr_end</span><span class="p">();</span>

  <span class="k">do</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">I</span><span class="o">-&gt;</span><span class="n">isPseudo</span><span class="p">())</span>
      <span class="n">llvm_unreachable</span><span class="p">(</span><span class="s">&quot;Pseudo opcode found in EmitInstruction()&quot;</span><span class="p">);</span>

    <span class="n">MCInst</span> <span class="n">TmpInst0</span><span class="p">;</span>
    <span class="n">MCInstLowering</span><span class="p">.</span><span class="n">Lower</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">TmpInst0</span><span class="p">);</span>
    <span class="n">OutStreamer</span><span class="o">-&gt;</span><span class="n">EmitInstruction</span><span class="p">(</span><span class="n">TmpInst0</span><span class="p">,</span> <span class="n">getSubtargetInfo</span><span class="p">());</span>
  <span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="o">++</span><span class="n">I</span> <span class="o">!=</span> <span class="n">E</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">I</span><span class="o">-&gt;</span><span class="n">isInsideBundle</span><span class="p">());</span> <span class="c1">// Delay slot check</span>
<span class="p">}</span>
<span class="c1">//@EmitInstruction }</span>

<span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="c1">//</span>
<span class="c1">//  Cpu0 Asm Directives</span>
<span class="c1">//</span>
<span class="c1">//  -- Frame directive &quot;frame Stackpointer, Stacksize, RARegister&quot;</span>
<span class="c1">//  Describe the stack frame.</span>
<span class="c1">//</span>
<span class="c1">//  -- Mask directives &quot;(f)mask  bitmask, offset&quot;</span>
<span class="c1">//  Tells the assembler which registers are saved and where.</span>
<span class="c1">//  bitmask - contain a little endian bitset indicating which registers are</span>
<span class="c1">//            saved on function prologue (e.g. with a 0x80000000 mask, the</span>
<span class="c1">//            assembler knows the register 31 (RA) is saved at prologue.</span>
<span class="c1">//  offset  - the position before stack pointer subtraction indicating where</span>
<span class="c1">//            the first saved register on prologue is located. (e.g. with a</span>
<span class="c1">//</span>
<span class="c1">//  Consider the following function prologue:</span>
<span class="c1">//</span>
<span class="c1">//    .frame  $fp,48,$ra</span>
<span class="c1">//    .mask   0xc0000000,-8</span>
<span class="c1">//       addiu $sp, $sp, -48</span>
<span class="c1">//       st $ra, 40($sp)</span>
<span class="c1">//       st $fp, 36($sp)</span>
<span class="c1">//</span>
<span class="c1">//    With a 0xc0000000 mask, the assembler knows the register 31 (RA) and</span>
<span class="c1">//    30 (FP) are saved at prologue. As the save order on prologue is from</span>
<span class="c1">//    left to right, RA is saved first. A -8 offset means that after the</span>
<span class="c1">//    stack pointer subtration, the first register in the mask (RA) will be</span>
<span class="c1">//    saved at address 48-8=40.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>

<span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="c1">// Mask directives</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="c1">//	.frame	$sp,8,$lr</span>
<span class="c1">//-&gt;	.mask 	0x00000000,0</span>
<span class="c1">//	.set	noreorder</span>
<span class="c1">//	.set	nomacro</span>

<span class="c1">// Create a bitmask with all callee saved registers for CPU or Floating Point</span>
<span class="c1">// registers. For CPU registers consider LR, GP and FP for saving if necessary.</span>
<span class="kt">void</span> <span class="n">Cpu0AsmPrinter</span><span class="o">::</span><span class="n">printSavedRegsBitmask</span><span class="p">(</span><span class="n">raw_ostream</span> <span class="o">&amp;</span><span class="n">O</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// CPU and FPU Saved Registers Bitmasks</span>
  <span class="kt">unsigned</span> <span class="n">CPUBitmask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">CPUTopSavedRegOff</span><span class="p">;</span>

  <span class="c1">// Set the CPU and FPU Bitmasks</span>
  <span class="k">const</span> <span class="n">MachineFrameInfo</span> <span class="o">*</span><span class="n">MFI</span> <span class="o">=</span> <span class="n">MF</span><span class="o">-&gt;</span><span class="n">getFrameInfo</span><span class="p">();</span>
  <span class="k">const</span> <span class="n">TargetRegisterInfo</span> <span class="o">*</span><span class="n">TRI</span> <span class="o">=</span> <span class="n">MF</span><span class="o">-&gt;</span><span class="n">getSubtarget</span><span class="p">().</span><span class="n">getRegisterInfo</span><span class="p">();</span>
  <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">CalleeSavedInfo</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">CSI</span> <span class="o">=</span> <span class="n">MFI</span><span class="o">-&gt;</span><span class="n">getCalleeSavedInfo</span><span class="p">();</span>
  <span class="c1">// size of stack area to which FP callee-saved regs are saved.</span>
  <span class="kt">unsigned</span> <span class="n">CPURegSize</span> <span class="o">=</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">CPURegsRegClass</span><span class="p">.</span><span class="n">getSize</span><span class="p">();</span>
  <span class="kt">unsigned</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">CSI</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>

  <span class="c1">// Set CPU Bitmask.</span>
  <span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">e</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="n">Reg</span> <span class="o">=</span> <span class="n">CSI</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getReg</span><span class="p">();</span>
    <span class="kt">unsigned</span> <span class="n">RegNum</span> <span class="o">=</span> <span class="n">TRI</span><span class="o">-&gt;</span><span class="n">getEncodingValue</span><span class="p">(</span><span class="n">Reg</span><span class="p">);</span>
    <span class="n">CPUBitmask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">RegNum</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">CPUTopSavedRegOff</span> <span class="o">=</span> <span class="n">CPUBitmask</span> <span class="o">?</span> <span class="o">-</span><span class="n">CPURegSize</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

  <span class="c1">// Print CPUBitmask</span>
  <span class="n">O</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">.mask </span><span class="se">\t</span><span class="s">&quot;</span><span class="p">;</span> <span class="n">printHex32</span><span class="p">(</span><span class="n">CPUBitmask</span><span class="p">,</span> <span class="n">O</span><span class="p">);</span>
  <span class="n">O</span> <span class="o">&lt;&lt;</span> <span class="sc">&#39;,&#39;</span> <span class="o">&lt;&lt;</span> <span class="n">CPUTopSavedRegOff</span> <span class="o">&lt;&lt;</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Print a 32 bit hex number with all numbers.</span>
<span class="kt">void</span> <span class="n">Cpu0AsmPrinter</span><span class="o">::</span><span class="n">printHex32</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">Value</span><span class="p">,</span> <span class="n">raw_ostream</span> <span class="o">&amp;</span><span class="n">O</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">O</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;0x&quot;</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
    <span class="n">O</span><span class="p">.</span><span class="n">write_hex</span><span class="p">((</span><span class="n">Value</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0xF</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="p">)))</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="p">));</span>
<span class="p">}</span>

<span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="c1">// Frame and Set directives</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="c1">//-&gt;	.frame	$sp,8,$lr</span>
<span class="c1">//	.mask 	0x00000000,0</span>
<span class="c1">//	.set	noreorder</span>
<span class="c1">//	.set	nomacro</span>
<span class="c1">/// Frame Directive</span>
<span class="kt">void</span> <span class="n">Cpu0AsmPrinter</span><span class="o">::</span><span class="n">emitFrameDirective</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">const</span> <span class="n">TargetRegisterInfo</span> <span class="o">&amp;</span><span class="n">RI</span> <span class="o">=</span> <span class="o">*</span><span class="n">MF</span><span class="o">-&gt;</span><span class="n">getSubtarget</span><span class="p">().</span><span class="n">getRegisterInfo</span><span class="p">();</span>

  <span class="kt">unsigned</span> <span class="n">stackReg</span>  <span class="o">=</span> <span class="n">RI</span><span class="p">.</span><span class="n">getFrameRegister</span><span class="p">(</span><span class="o">*</span><span class="n">MF</span><span class="p">);</span>
  <span class="kt">unsigned</span> <span class="n">returnReg</span> <span class="o">=</span> <span class="n">RI</span><span class="p">.</span><span class="n">getRARegister</span><span class="p">();</span>
  <span class="kt">unsigned</span> <span class="n">stackSize</span> <span class="o">=</span> <span class="n">MF</span><span class="o">-&gt;</span><span class="n">getFrameInfo</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getStackSize</span><span class="p">();</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">OutStreamer</span><span class="o">-&gt;</span><span class="n">hasRawTextSupport</span><span class="p">())</span>
    <span class="n">OutStreamer</span><span class="o">-&gt;</span><span class="n">EmitRawText</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">.frame</span><span class="se">\t</span><span class="s">$&quot;</span> <span class="o">+</span>
           <span class="n">StringRef</span><span class="p">(</span><span class="n">Cpu0InstPrinter</span><span class="o">::</span><span class="n">getRegisterName</span><span class="p">(</span><span class="n">stackReg</span><span class="p">)).</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span>
           <span class="s">&quot;,&quot;</span> <span class="o">+</span> <span class="n">Twine</span><span class="p">(</span><span class="n">stackSize</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;,$&quot;</span> <span class="o">+</span>
           <span class="n">StringRef</span><span class="p">(</span><span class="n">Cpu0InstPrinter</span><span class="o">::</span><span class="n">getRegisterName</span><span class="p">(</span><span class="n">returnReg</span><span class="p">)).</span><span class="n">lower</span><span class="p">());</span>
<span class="p">}</span>

<span class="c1">/// Emit Set directives.</span>
<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">Cpu0AsmPrinter</span><span class="o">::</span><span class="n">getCurrentABIString</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Cpu0TargetMachine</span> <span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">TM</span><span class="p">).</span><span class="n">getABI</span><span class="p">().</span><span class="n">GetEnumValue</span><span class="p">())</span> <span class="p">{</span>
  <span class="k">case</span> <span class="n">Cpu0ABIInfo</span>:<span class="o">:</span><span class="n">ABI</span><span class="o">::</span><span class="n">O32</span><span class="o">:</span>  <span class="k">return</span> <span class="s">&quot;abiO32&quot;</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">Cpu0ABIInfo</span>:<span class="o">:</span><span class="n">ABI</span><span class="o">::</span><span class="n">S32</span><span class="o">:</span>  <span class="k">return</span> <span class="s">&quot;abiS32&quot;</span><span class="p">;</span>
  <span class="nl">default:</span> <span class="n">llvm_unreachable</span><span class="p">(</span><span class="s">&quot;Unknown Cpu0 ABI&quot;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">//		.type	main,@function</span>
<span class="c1">//-&gt;		.ent	main                    # @main</span>
<span class="c1">//	main:</span>
<span class="kt">void</span> <span class="n">Cpu0AsmPrinter</span><span class="o">::</span><span class="n">EmitFunctionEntryLabel</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">OutStreamer</span><span class="o">-&gt;</span><span class="n">hasRawTextSupport</span><span class="p">())</span>
    <span class="n">OutStreamer</span><span class="o">-&gt;</span><span class="n">EmitRawText</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">.ent</span><span class="se">\t</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">Twine</span><span class="p">(</span><span class="n">CurrentFnSym</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()));</span>
  <span class="n">OutStreamer</span><span class="o">-&gt;</span><span class="n">EmitLabel</span><span class="p">(</span><span class="n">CurrentFnSym</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">//  .frame  $sp,8,$pc</span>
<span class="c1">//  .mask   0x00000000,0</span>
<span class="c1">//-&gt;  .set  noreorder</span>
<span class="c1">//@-&gt; .set  nomacro</span>
<span class="c1">/// EmitFunctionBodyStart - Targets can override this to emit stuff before</span>
<span class="c1">/// the first basic block in the function.</span>
<span class="kt">void</span> <span class="n">Cpu0AsmPrinter</span><span class="o">::</span><span class="n">EmitFunctionBodyStart</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">MCInstLowering</span><span class="p">.</span><span class="n">Initialize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">MF</span><span class="o">-&gt;</span><span class="n">getContext</span><span class="p">());</span>

  <span class="n">emitFrameDirective</span><span class="p">();</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">OutStreamer</span><span class="o">-&gt;</span><span class="n">hasRawTextSupport</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">SmallString</span><span class="o">&lt;</span><span class="mi">128</span><span class="o">&gt;</span> <span class="n">Str</span><span class="p">;</span>
    <span class="n">raw_svector_ostream</span> <span class="nf">OS</span><span class="p">(</span><span class="n">Str</span><span class="p">);</span>
    <span class="n">printSavedRegsBitmask</span><span class="p">(</span><span class="n">OS</span><span class="p">);</span>
    <span class="n">OutStreamer</span><span class="o">-&gt;</span><span class="n">EmitRawText</span><span class="p">(</span><span class="n">OS</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
    <span class="n">OutStreamer</span><span class="o">-&gt;</span><span class="n">EmitRawText</span><span class="p">(</span><span class="n">StringRef</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">.set</span><span class="se">\t</span><span class="s">noreorder&quot;</span><span class="p">));</span>
    <span class="n">OutStreamer</span><span class="o">-&gt;</span><span class="n">EmitRawText</span><span class="p">(</span><span class="n">StringRef</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">.set</span><span class="se">\t</span><span class="s">nomacro&quot;</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Cpu0FI</span><span class="o">-&gt;</span><span class="n">getEmitNOAT</span><span class="p">())</span>
      <span class="n">OutStreamer</span><span class="o">-&gt;</span><span class="n">EmitRawText</span><span class="p">(</span><span class="n">StringRef</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">.set</span><span class="se">\t</span><span class="s">noat&quot;</span><span class="p">));</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">//-&gt;	.set	macro</span>
<span class="c1">//-&gt;	.set	reorder</span>
<span class="c1">//-&gt;	.end	main</span>
<span class="c1">/// EmitFunctionBodyEnd - Targets can override this to emit stuff after</span>
<span class="c1">/// the last basic block in the function.</span>
<span class="kt">void</span> <span class="n">Cpu0AsmPrinter</span><span class="o">::</span><span class="n">EmitFunctionBodyEnd</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// There are instruction for this macros, but they must</span>
  <span class="c1">// always be at the function end, and we can&#39;t emit and</span>
  <span class="c1">// break with BB logic.</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">OutStreamer</span><span class="o">-&gt;</span><span class="n">hasRawTextSupport</span><span class="p">())</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Cpu0FI</span><span class="o">-&gt;</span><span class="n">getEmitNOAT</span><span class="p">())</span>
      <span class="n">OutStreamer</span><span class="o">-&gt;</span><span class="n">EmitRawText</span><span class="p">(</span><span class="n">StringRef</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">.set</span><span class="se">\t</span><span class="s">at&quot;</span><span class="p">));</span>
    <span class="n">OutStreamer</span><span class="o">-&gt;</span><span class="n">EmitRawText</span><span class="p">(</span><span class="n">StringRef</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">.set</span><span class="se">\t</span><span class="s">macro&quot;</span><span class="p">));</span>
    <span class="n">OutStreamer</span><span class="o">-&gt;</span><span class="n">EmitRawText</span><span class="p">(</span><span class="n">StringRef</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">.set</span><span class="se">\t</span><span class="s">reorder&quot;</span><span class="p">));</span>
    <span class="n">OutStreamer</span><span class="o">-&gt;</span><span class="n">EmitRawText</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">.end</span><span class="se">\t</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">Twine</span><span class="p">(</span><span class="n">CurrentFnSym</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()));</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">//	.section .mdebug.abi32</span>
<span class="c1">//	.previous</span>
<span class="kt">void</span> <span class="n">Cpu0AsmPrinter</span><span class="o">::</span><span class="n">EmitStartOfAsmFile</span><span class="p">(</span><span class="n">Module</span> <span class="o">&amp;</span><span class="n">M</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// FIXME: Use SwitchSection.</span>

  <span class="c1">// Tell the assembler which ABI we are using</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">OutStreamer</span><span class="o">-&gt;</span><span class="n">hasRawTextSupport</span><span class="p">())</span>
    <span class="n">OutStreamer</span><span class="o">-&gt;</span><span class="n">EmitRawText</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">.section .mdebug.&quot;</span> <span class="o">+</span>
                            <span class="n">Twine</span><span class="p">(</span><span class="n">getCurrentABIString</span><span class="p">()));</span>

  <span class="c1">// return to previous section</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">OutStreamer</span><span class="o">-&gt;</span><span class="n">hasRawTextSupport</span><span class="p">())</span>
    <span class="n">OutStreamer</span><span class="o">-&gt;</span><span class="n">EmitRawText</span><span class="p">(</span><span class="n">StringRef</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">.previous&quot;</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Cpu0AsmPrinter</span><span class="o">::</span><span class="n">PrintDebugValueComment</span><span class="p">(</span><span class="k">const</span> <span class="n">MachineInstr</span> <span class="o">*</span><span class="n">MI</span><span class="p">,</span>
                                           <span class="n">raw_ostream</span> <span class="o">&amp;</span><span class="n">OS</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// TODO: implement</span>
  <span class="n">OS</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;PrintDebugValueComment()&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Force static initialization.</span>
<span class="k">extern</span> <span class="s">&quot;C&quot;</span> <span class="kt">void</span> <span class="n">LLVMInitializeCpu0AsmPrinter</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">RegisterAsmPrinter</span><span class="o">&lt;</span><span class="n">Cpu0AsmPrinter</span><span class="o">&gt;</span> <span class="n">X</span><span class="p">(</span><span class="n">TheCpu0Target</span><span class="p">);</span>
  <span class="n">RegisterAsmPrinter</span><span class="o">&lt;</span><span class="n">Cpu0AsmPrinter</span><span class="o">&gt;</span> <span class="n">Y</span><span class="p">(</span><span class="n">TheCpu0elTarget</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>When instruction is ready to print, function Cpu0AsmPrinter::EmitInstruction()
will be triggered first. And then it will call OutStreamer.EmitInstruction() to
print OP code and register according the information from Cpu0GenInstrInfo.inc
and Cpu0GenRegisterInfo.inc both registered at dynamic register function,
LLVMInitializeCpu0TargetMC().
Notice, file Cpu0InstPrinter.cpp only print operand while the OP code
information come from Cpu0InstrInfo.td.</p>
<p>Add the following code to Cpu0ISelLowering.cpp.</p>
<p class="rubric">lbdex/chapters/Chapter3_2/Cpu0ISelLowering.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">Cpu0TargetLowering</span><span class="o">::</span>
<span class="n">Cpu0TargetLowering</span><span class="p">(</span><span class="n">Cpu0TargetMachine</span> <span class="o">&amp;</span><span class="n">TM</span><span class="p">)</span>
  <span class="o">:</span> <span class="n">TargetLowering</span><span class="p">(</span><span class="n">TM</span><span class="p">,</span> <span class="k">new</span> <span class="n">Cpu0TargetObjectFile</span><span class="p">()),</span>
    <span class="n">Subtarget</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TM</span><span class="p">.</span><span class="n">getSubtarget</span><span class="o">&lt;</span><span class="n">Cpu0Subtarget</span><span class="o">&gt;</span><span class="p">())</span> <span class="p">{</span>

<span class="c1">//- Set .align 2</span>
<span class="c1">// It will emit .align 2 later</span>
  <span class="n">setMinFunctionAlignment</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

<span class="c1">// must, computeRegisterProperties - Once all of the register classes are</span>
<span class="c1">//  added, this allows us to compute derived properties we expose.</span>
  <span class="n">computeRegisterProperties</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Add the following code to Cpu0MachineFunction.h since the Cpu0AsmPrinter.cpp
will call getEmitNOAT().</p>
<p class="rubric">lbdex/chapters/Chapter3_2/Cpu0MachineFunction.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Cpu0FunctionInfo</span> <span class="o">:</span> <span class="k">public</span> <span class="n">MachineFunctionInfo</span> <span class="p">{</span>
<span class="nl">public:</span>
  <span class="n">Cpu0FunctionInfo</span><span class="p">(</span><span class="n">MachineFunction</span><span class="o">&amp;</span> <span class="n">MF</span><span class="p">)</span>
  <span class="o">:</span> <span class="p">...</span>
    <span class="p">,</span> <span class="n">EmitNOAT</span><span class="p">(</span><span class="nb">false</span><span class="p">)</span>
    <span class="p">{}</span>

  <span class="p">...</span>
  <span class="kt">bool</span> <span class="n">getEmitNOAT</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">EmitNOAT</span><span class="p">;</span> <span class="p">}</span>
  <span class="kt">void</span> <span class="n">setEmitNOAT</span><span class="p">()</span> <span class="p">{</span> <span class="n">EmitNOAT</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span> <span class="p">}</span>
<span class="nl">private:</span>
  <span class="p">...</span>
  <span class="kt">bool</span> <span class="n">EmitNOAT</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Beyond adding these new .cpp files to CMakeLists.txt, please remember to add
subdirectory InstPrinter, enable asmprinter, adding libraries AsmPrinter and
Cpu0AsmPrinter to LLVMBuild.txt as follows,</p>
<p class="rubric">lbdex/chapters/Chapter3_2/CMakeLists.txt</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">tablegen</span><span class="p">(</span><span class="n">LLVM</span> <span class="n">Cpu0GenCodeEmitter</span><span class="p">.</span><span class="n">inc</span> <span class="o">-</span><span class="n">gen</span><span class="o">-</span><span class="n">emitter</span><span class="p">)</span>
<span class="n">tablegen</span><span class="p">(</span><span class="n">LLVM</span> <span class="n">Cpu0GenMCCodeEmitter</span><span class="p">.</span><span class="n">inc</span> <span class="o">-</span><span class="n">gen</span><span class="o">-</span><span class="n">emitter</span><span class="p">)</span>

<span class="n">tablegen</span><span class="p">(</span><span class="n">LLVM</span> <span class="n">Cpu0GenAsmWriter</span><span class="p">.</span><span class="n">inc</span> <span class="o">-</span><span class="n">gen</span><span class="o">-</span><span class="k">asm</span><span class="o">-</span><span class="n">writer</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="p">...</span>
<span class="n">add_llvm_target</span><span class="p">(</span><span class="n">Cpu0CodeGen</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="n">Cpu0AsmPrinter</span><span class="p">.</span><span class="n">cpp</span>
  <span class="n">Cpu0MCInstLower</span><span class="p">.</span><span class="n">cpp</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="p">...</span>
  <span class="p">)</span>
<span class="p">...</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">add_subdirectory</span><span class="p">(</span><span class="n">InstPrinter</span><span class="p">)</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_2/LLVMBuild.txt</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">//  LLVMBuild.txt</span>
<span class="p">[</span><span class="n">common</span><span class="p">]</span>
<span class="n">subdirectories</span> <span class="o">=</span>
  <span class="n">InstPrinter</span>
  <span class="p">...</span>

<span class="p">[</span><span class="n">component_0</span><span class="p">]</span>
<span class="p">...</span>
<span class="cp"># Please enable asmprinter</span>
<span class="n">has_asmprinter</span> <span class="o">=</span> <span class="mi">1</span>
<span class="p">...</span>

<span class="p">[</span><span class="n">component_1</span><span class="p">]</span>
<span class="n">required_libraries</span> <span class="o">=</span>
                     <span class="n">AsmPrinter</span>
                     <span class="p">...</span>
                     <span class="n">Cpu0AsmPrinter</span>
                     <span class="p">...</span>
</pre></div>
</div>
<p>Now, run Chapter3_2/Cpu0 for AsmPrinter support, will get new error message as
follows,</p>
<div class="highlight-bash"><div class="highlight"><pre>118-165-78-230:input Jonathan<span class="nv">$ </span>/Users/Jonathan/llvm/test/cmake_debug_build/
Debug/bin/llc -march<span class="o">=</span>cpu0 -relocation-model<span class="o">=</span>pic -filetype<span class="o">=</span>asm ch3.bc -o
ch3.cpu0.s
/Users/Jonathan/llvm/test/cmake_debug_build/Debug/bin/llc: target does not
support generation of this file <span class="nb">type</span>!
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">llc</span></tt> fails to compile IR code into machine code since we don&#8217;t implement
class Cpu0DAGToDAGISel.</p>
</div>
<div class="section" id="add-cpu0dagtodagisel-class">
<h2><a class="toc-backref" href="#id6">Add Cpu0DAGToDAGISel class</a><a class="headerlink" href="#add-cpu0dagtodagisel-class" title="Permalink to this headline">¶</a></h2>
<p>The IR DAG to machine instruction DAG transformation is introduced in the
previous chapter.
Now, let&#8217;s check what IR DAG nodes the file ch3.bc has. List ch3.ll as follows,</p>
<div class="highlight-c++"><pre>// ch3.ll
define i32 @main() nounwind uwtable {
%1 = alloca i32, align 4
store i32 0, i32* %1
ret i32 0
}</pre>
</div>
<p>As above, ch3.ll uses the IR DAG node <strong>store</strong>, <strong>ret</strong>.
So, the definitions in Cpu0InstrInfo.td as below is enough.
The ADDiu used for stack adjustment which will needed in later section
&#8220;Add Prologue/Epilogue functions&#8221; of this chapter.
IR DAG is defined in file  include/llvm/Target/TargetSelectionDAG.td.</p>
<p class="rubric">lbdex/chapters/Chapter2/Cpu0InstrInfo.td</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">//===----------------------------------------------------------------------===//</span>

<span class="c1">/// Load and Store Instructions</span>
<span class="c1">///  aligned</span>
<span class="n">defm</span> <span class="n">LD</span>     <span class="o">:</span> <span class="n">LoadM32</span><span class="o">&lt;</span><span class="mh">0x01</span><span class="p">,</span>  <span class="s">&quot;ld&quot;</span><span class="p">,</span>  <span class="n">load_a</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">defm</span> <span class="n">ST</span>     <span class="o">:</span> <span class="n">StoreM32</span><span class="o">&lt;</span><span class="mh">0x02</span><span class="p">,</span> <span class="s">&quot;st&quot;</span><span class="p">,</span>  <span class="n">store_a</span><span class="o">&gt;</span><span class="p">;</span>

<span class="c1">/// Arithmetic Instructions (ALU Immediate)</span>
<span class="c1">// IR &quot;add&quot; defined in include/llvm/Target/TargetSelectionDAG.td, line 315 (def add).</span>
<span class="n">def</span> <span class="n">ADDiu</span>   <span class="o">:</span> <span class="n">ArithLogicI</span><span class="o">&lt;</span><span class="mh">0x09</span><span class="p">,</span> <span class="s">&quot;addiu&quot;</span><span class="p">,</span> <span class="n">add</span><span class="p">,</span> <span class="n">simm16</span><span class="p">,</span> <span class="n">immSExt16</span><span class="p">,</span> <span class="n">CPURegs</span><span class="o">&gt;</span><span class="p">;</span>

<span class="n">let</span> <span class="n">isReturn</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">isTerminator</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">hasDelaySlot</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">isBarrier</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">hasCtrlDep</span><span class="o">=</span><span class="mi">1</span> <span class="n">in</span>
<span class="n">def</span> <span class="n">RetLR</span> <span class="o">:</span> <span class="n">Cpu0Pseudo</span><span class="o">&lt;</span><span class="p">(</span><span class="n">outs</span><span class="p">),</span> <span class="p">(</span><span class="n">ins</span><span class="p">),</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="p">[(</span><span class="n">Cpu0Ret</span><span class="p">)]</span><span class="o">&gt;</span><span class="p">;</span>

<span class="n">def</span> <span class="n">RET</span>     <span class="o">:</span> <span class="n">RetBase</span><span class="o">&lt;</span><span class="n">GPROut</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<p>Add class Cpu0DAGToDAGISel (Cpu0ISelDAGToDAG.cpp) to CMakeLists.txt, and add
the following fragment to Cpu0TargetMachine.cpp,</p>
<p class="rubric">lbdex/chapters/Chapter3_3/CMakeLists.txt</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">add_llvm_target</span><span class="p">(</span>
  <span class="p">...</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="n">Cpu0ISelDAGToDAG</span><span class="p">.</span><span class="n">cpp</span>
  <span class="n">Cpu0SEISelDAGToDAG</span><span class="p">.</span><span class="n">cpp</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="p">...</span>
<span class="p">)</span>
</pre></div>
</div>
<p>The following code in Cpu0TargetMachine.cpp will create a pass in instruction
selection stage.</p>
<p class="rubric">lbdex/chapters/Chapter3_3/Cpu0TargetMachine.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="cp">#include &quot;Cpu0SEISelDAGToDAG.h&quot;</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="p">...</span>
<span class="k">class</span> <span class="nc">Cpu0PassConfig</span> <span class="o">:</span> <span class="k">public</span> <span class="n">TargetPassConfig</span> <span class="p">{</span>
<span class="nl">public:</span>
  <span class="p">...</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="kt">bool</span> <span class="n">addInstSelector</span><span class="p">()</span> <span class="n">override</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="p">};</span>
<span class="p">...</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">// Install an instruction selector pass using</span>
<span class="c1">// the ISelDag to gen Cpu0 code.</span>
<span class="kt">bool</span> <span class="n">Cpu0PassConfig</span><span class="o">::</span><span class="n">addInstSelector</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">addPass</span><span class="p">(</span><span class="n">createCpu0SEISelDag</span><span class="p">(</span><span class="n">getCpu0TargetMachine</span><span class="p">()));</span>
  <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_3/Cpu0ISelDAGToDAG.h</p>
<div class="highlight-c++"><pre>//===---- Cpu0ISelDAGToDAG.h - A Dag to Dag Inst Selector for Cpu0 --------===//
//
//                     The LLVM Compiler Infrastructure
//
// This file is distributed under the University of Illinois Open Source
// License. See LICENSE.TXT for details.
//
//===----------------------------------------------------------------------===//
//
// This file defines an instruction selector for the CPU0 target.
//
//===----------------------------------------------------------------------===//

#ifndef LLVM_LIB_TARGET_CPU0_CPU0ISELDAGTODAG_H
#define LLVM_LIB_TARGET_CPU0_CPU0ISELDAGTODAG_H

#include "Cpu0Config.h"

#include "Cpu0.h"
#include "Cpu0Subtarget.h"
#include "Cpu0TargetMachine.h"
#include "llvm/CodeGen/SelectionDAGISel.h"
#include "llvm/IR/Type.h"
#include "llvm/Support/Debug.h"

//===----------------------------------------------------------------------===//
// Instruction Selector Implementation
//===----------------------------------------------------------------------===//

//===----------------------------------------------------------------------===//
// Cpu0DAGToDAGISel - CPU0 specific code to select CPU0 machine
// instructions for SelectionDAG operations.
//===----------------------------------------------------------------------===//
namespace llvm {

class Cpu0DAGToDAGISel : public SelectionDAGISel {
public:
  explicit Cpu0DAGToDAGISel(Cpu0TargetMachine &amp;TM)
      : SelectionDAGISel(TM), Subtarget(nullptr) {}

  // Pass Name
  const char *getPassName() const override {
    return "CPU0 DAG-&gt;DAG Pattern Instruction Selection";
  }

  bool runOnMachineFunction(MachineFunction &amp;MF) override;

protected:

  /// Keep a pointer to the Cpu0Subtarget around so that we can make the right
  /// decision when generating code for different targets.
  const Cpu0Subtarget *Subtarget;

private:
  // Include the pieces autogenerated from the target description.
  #include "Cpu0GenDAGISel.inc"

  /// getTargetMachine - Return a reference to the TargetMachine, casted
  /// to the target-specific type.
  const Cpu0TargetMachine &amp;getTargetMachine() {
    return static_cast&lt;const Cpu0TargetMachine &amp;&gt;(TM);
  }

  SDNode *Select(SDNode *N) override;

  virtual std::pair&lt;bool, SDNode*&gt; selectNode(SDNode *Node) = 0;

  // Complex Pattern.
  bool SelectAddr(SDNode *Parent, SDValue N, SDValue &amp;Base, SDValue &amp;Offset);

  // getImm - Return a target constant with the specified value.
  inline SDValue getImm(const SDNode *Node, unsigned Imm) {
    return CurDAG-&gt;getTargetConstant(Imm, SDLoc(Node), Node-&gt;getValueType(0));
  }

  virtual void processFunctionAfterISel(MachineFunction &amp;MF) = 0;

};

}

#endif

</pre>
</div>
<p class="rubric">lbdex/chapters/Chapter3_3/Cpu0ISelDAGToDAG.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">//===-- Cpu0ISelDAGToDAG.cpp - A Dag to Dag Inst Selector for Cpu0 --------===//</span>
<span class="c1">//</span>
<span class="c1">//                     The LLVM Compiler Infrastructure</span>
<span class="c1">//</span>
<span class="c1">// This file is distributed under the University of Illinois Open Source</span>
<span class="c1">// License. See LICENSE.TXT for details.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="c1">//</span>
<span class="c1">// This file defines an instruction selector for the CPU0 target.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>

<span class="cp">#include &quot;Cpu0ISelDAGToDAG.h&quot;</span>
<span class="cp">#include &quot;Cpu0.h&quot;</span>

<span class="cp">#include &quot;Cpu0MachineFunction.h&quot;</span>
<span class="cp">#include &quot;Cpu0RegisterInfo.h&quot;</span>
<span class="cp">#include &quot;Cpu0SEISelDAGToDAG.h&quot;</span>
<span class="cp">#include &quot;Cpu0TargetMachine.h&quot;</span>
<span class="cp">#include &quot;llvm/CodeGen/MachineConstantPool.h&quot;</span>
<span class="cp">#include &quot;llvm/CodeGen/MachineFrameInfo.h&quot;</span>
<span class="cp">#include &quot;llvm/CodeGen/MachineFunction.h&quot;</span>
<span class="cp">#include &quot;llvm/CodeGen/MachineInstrBuilder.h&quot;</span>
<span class="cp">#include &quot;llvm/CodeGen/MachineRegisterInfo.h&quot;</span>
<span class="cp">#include &quot;llvm/CodeGen/SelectionDAGISel.h&quot;</span>
<span class="cp">#include &quot;llvm/CodeGen/SelectionDAGNodes.h&quot;</span>
<span class="cp">#include &quot;llvm/IR/CFG.h&quot;</span>
<span class="cp">#include &quot;llvm/IR/GlobalValue.h&quot;</span>
<span class="cp">#include &quot;llvm/IR/Instructions.h&quot;</span>
<span class="cp">#include &quot;llvm/IR/Intrinsics.h&quot;</span>
<span class="cp">#include &quot;llvm/IR/Type.h&quot;</span>
<span class="cp">#include &quot;llvm/Support/Debug.h&quot;</span>
<span class="cp">#include &quot;llvm/Support/ErrorHandling.h&quot;</span>
<span class="cp">#include &quot;llvm/Support/raw_ostream.h&quot;</span>
<span class="cp">#include &quot;llvm/Target/TargetMachine.h&quot;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">llvm</span><span class="p">;</span>

<span class="cp">#define DEBUG_TYPE &quot;cpu0-isel&quot;</span>

<span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="c1">// Instruction Selector Implementation</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>

<span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="c1">// Cpu0DAGToDAGISel - CPU0 specific code to select CPU0 machine</span>
<span class="c1">// instructions for SelectionDAG operations.</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>

<span class="kt">bool</span> <span class="n">Cpu0DAGToDAGISel</span><span class="o">::</span><span class="n">runOnMachineFunction</span><span class="p">(</span><span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">MF</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">bool</span> <span class="n">Ret</span> <span class="o">=</span> <span class="n">SelectionDAGISel</span><span class="o">::</span><span class="n">runOnMachineFunction</span><span class="p">(</span><span class="n">MF</span><span class="p">);</span>

  <span class="k">return</span> <span class="n">Ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">//@SelectAddr {</span>
<span class="c1">/// ComplexPattern used on Cpu0InstrInfo</span>
<span class="c1">/// Used on Cpu0 Load/Store instructions</span>
<span class="kt">bool</span> <span class="n">Cpu0DAGToDAGISel</span><span class="o">::</span>
<span class="n">SelectAddr</span><span class="p">(</span><span class="n">SDNode</span> <span class="o">*</span><span class="n">Parent</span><span class="p">,</span> <span class="n">SDValue</span> <span class="n">Addr</span><span class="p">,</span> <span class="n">SDValue</span> <span class="o">&amp;</span><span class="n">Base</span><span class="p">,</span> <span class="n">SDValue</span> <span class="o">&amp;</span><span class="n">Offset</span><span class="p">)</span> <span class="p">{</span>
<span class="c1">//@SelectAddr }</span>
  <span class="n">EVT</span> <span class="n">ValTy</span> <span class="o">=</span> <span class="n">Addr</span><span class="p">.</span><span class="n">getValueType</span><span class="p">();</span>
  <span class="n">SDLoc</span> <span class="nf">DL</span><span class="p">(</span><span class="n">Addr</span><span class="p">);</span>

  <span class="c1">// If Parent is an unaligned f32 load or store, select a (base + index)</span>
  <span class="c1">// floating point load/store instruction (luxc1 or suxc1).</span>
  <span class="k">const</span> <span class="n">LSBaseSDNode</span><span class="o">*</span> <span class="n">LS</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">Parent</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">LS</span> <span class="o">=</span> <span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">LSBaseSDNode</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Parent</span><span class="p">)))</span> <span class="p">{</span>
    <span class="n">EVT</span> <span class="n">VT</span> <span class="o">=</span> <span class="n">LS</span><span class="o">-&gt;</span><span class="n">getMemoryVT</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">VT</span><span class="p">.</span><span class="n">getSizeInBits</span><span class="p">()</span> <span class="o">/</span> <span class="mi">8</span> <span class="o">&gt;</span> <span class="n">LS</span><span class="o">-&gt;</span><span class="n">getAlignment</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">assert</span><span class="p">(</span><span class="s">&quot;Unaligned loads/stores not supported for this type.&quot;</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">VT</span> <span class="o">==</span> <span class="n">MVT</span><span class="o">::</span><span class="n">f32</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// if Address is FI, get the TargetFrameIndex.</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">FrameIndexSDNode</span> <span class="o">*</span><span class="n">FIN</span> <span class="o">=</span> <span class="n">dyn_cast</span><span class="o">&lt;</span><span class="n">FrameIndexSDNode</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Addr</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">Base</span>   <span class="o">=</span> <span class="n">CurDAG</span><span class="o">-&gt;</span><span class="n">getTargetFrameIndex</span><span class="p">(</span><span class="n">FIN</span><span class="o">-&gt;</span><span class="n">getIndex</span><span class="p">(),</span> <span class="n">ValTy</span><span class="p">);</span>
    <span class="n">Offset</span> <span class="o">=</span> <span class="n">CurDAG</span><span class="o">-&gt;</span><span class="n">getTargetConstant</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">ValTy</span><span class="p">);</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">Base</span>   <span class="o">=</span> <span class="n">Addr</span><span class="p">;</span>
  <span class="n">Offset</span> <span class="o">=</span> <span class="n">CurDAG</span><span class="o">-&gt;</span><span class="n">getTargetConstant</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">ValTy</span><span class="p">);</span>
  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">//@Select {</span>
<span class="c1">/// Select instructions not customized! Used for</span>
<span class="c1">/// expanded, promoted and normal instructions</span>
<span class="n">SDNode</span><span class="o">*</span> <span class="n">Cpu0DAGToDAGISel</span><span class="o">::</span><span class="n">Select</span><span class="p">(</span><span class="n">SDNode</span> <span class="o">*</span><span class="n">Node</span><span class="p">)</span> <span class="p">{</span>
<span class="c1">//@Select }</span>
  <span class="kt">unsigned</span> <span class="n">Opcode</span> <span class="o">=</span> <span class="n">Node</span><span class="o">-&gt;</span><span class="n">getOpcode</span><span class="p">();</span>

  <span class="c1">// Dump information about the Node being selected</span>
  <span class="n">DEBUG</span><span class="p">(</span><span class="n">errs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Selecting: &quot;</span><span class="p">;</span> <span class="n">Node</span><span class="o">-&gt;</span><span class="n">dump</span><span class="p">(</span><span class="n">CurDAG</span><span class="p">);</span> <span class="n">errs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

  <span class="c1">// If we have a custom node, we already have selected!</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Node</span><span class="o">-&gt;</span><span class="n">isMachineOpcode</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">DEBUG</span><span class="p">(</span><span class="n">errs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;== &quot;</span><span class="p">;</span> <span class="n">Node</span><span class="o">-&gt;</span><span class="n">dump</span><span class="p">(</span><span class="n">CurDAG</span><span class="p">);</span> <span class="n">errs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">Node</span><span class="o">-&gt;</span><span class="n">setNodeId</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">nullptr</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// See if subclasses can handle this node.</span>
  <span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="kt">bool</span><span class="p">,</span> <span class="n">SDNode</span><span class="o">*&gt;</span> <span class="n">Ret</span> <span class="o">=</span> <span class="n">selectNode</span><span class="p">(</span><span class="n">Node</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">Ret</span><span class="p">.</span><span class="n">first</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Ret</span><span class="p">.</span><span class="n">second</span><span class="p">;</span>

  <span class="k">switch</span><span class="p">(</span><span class="n">Opcode</span><span class="p">)</span> <span class="p">{</span>
  <span class="nl">default:</span> <span class="k">break</span><span class="p">;</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">//#ifndef NDEBUG</span>
<span class="c">  case ISD::LOAD:</span>
<span class="c">  case ISD::STORE:</span>
<span class="c">    assert((Subtarget-&gt;systemSupportsUnalignedAccess() ||</span>
<span class="c">            cast&lt;MemSDNode&gt;(Node)-&gt;getMemoryVT().getSizeInBits() / 8 &lt;=</span>
<span class="c">            cast&lt;MemSDNode&gt;(Node)-&gt;getAlignment()) &amp;&amp;</span>
<span class="c">           &quot;Unexpected unaligned loads/stores.&quot;);</span>
<span class="c">    break;</span>
<span class="cp">#endif</span>
  <span class="p">}</span>

  <span class="c1">// Select the default instruction</span>
  <span class="n">SDNode</span> <span class="o">*</span><span class="n">ResNode</span> <span class="o">=</span> <span class="n">SelectCode</span><span class="p">(</span><span class="n">Node</span><span class="p">);</span>

  <span class="n">DEBUG</span><span class="p">(</span><span class="n">errs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;=&gt; &quot;</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">ResNode</span> <span class="o">==</span> <span class="n">nullptr</span> <span class="o">||</span> <span class="n">ResNode</span> <span class="o">==</span> <span class="n">Node</span><span class="p">)</span>
    <span class="n">DEBUG</span><span class="p">(</span><span class="n">Node</span><span class="o">-&gt;</span><span class="n">dump</span><span class="p">(</span><span class="n">CurDAG</span><span class="p">));</span>
  <span class="k">else</span>
    <span class="nf">DEBUG</span><span class="p">(</span><span class="n">ResNode</span><span class="o">-&gt;</span><span class="n">dump</span><span class="p">(</span><span class="n">CurDAG</span><span class="p">));</span>
  <span class="n">DEBUG</span><span class="p">(</span><span class="n">errs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">ResNode</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_3/Cpu0SEISelDAGToDAG.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">//===-- Cpu0SEISelDAGToDAG.h - A Dag to Dag Inst Selector for Cpu0SE -----===//</span>
<span class="c1">//</span>
<span class="c1">//                     The LLVM Compiler Infrastructure</span>
<span class="c1">//</span>
<span class="c1">// This file is distributed under the University of Illinois Open Source</span>
<span class="c1">// License. See LICENSE.TXT for details.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="c1">//</span>
<span class="c1">// Subclass of Cpu0DAGToDAGISel specialized for cpu032.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>

<span class="cp">#ifndef LLVM_LIB_TARGET_CPU0_CPU0SEISELDAGTODAG_H</span>
<span class="cp">#define LLVM_LIB_TARGET_CPU0_CPU0SEISELDAGTODAG_H</span>

<span class="cp">#include &quot;Cpu0Config.h&quot;</span>

<span class="cp">#include &quot;Cpu0ISelDAGToDAG.h&quot;</span>

<span class="k">namespace</span> <span class="n">llvm</span> <span class="p">{</span>

<span class="k">class</span> <span class="nc">Cpu0SEDAGToDAGISel</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Cpu0DAGToDAGISel</span> <span class="p">{</span>

<span class="nl">public:</span>
  <span class="k">explicit</span> <span class="n">Cpu0SEDAGToDAGISel</span><span class="p">(</span><span class="n">Cpu0TargetMachine</span> <span class="o">&amp;</span><span class="n">TM</span><span class="p">)</span> <span class="o">:</span> <span class="n">Cpu0DAGToDAGISel</span><span class="p">(</span><span class="n">TM</span><span class="p">)</span> <span class="p">{}</span>

<span class="nl">private:</span>

  <span class="kt">bool</span> <span class="n">runOnMachineFunction</span><span class="p">(</span><span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">MF</span><span class="p">)</span> <span class="n">override</span><span class="p">;</span>

  <span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="kt">bool</span><span class="p">,</span> <span class="n">SDNode</span><span class="o">*&gt;</span> <span class="n">selectNode</span><span class="p">(</span><span class="n">SDNode</span> <span class="o">*</span><span class="n">Node</span><span class="p">)</span> <span class="n">override</span><span class="p">;</span>

  <span class="kt">void</span> <span class="n">processFunctionAfterISel</span><span class="p">(</span><span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">MF</span><span class="p">)</span> <span class="n">override</span><span class="p">;</span>

  <span class="c1">// Insert instructions to initialize the global base register in the</span>
  <span class="c1">// first MBB of the function.</span>
<span class="c1">//  void initGlobalBaseReg(MachineFunction &amp;MF);</span>

<span class="p">};</span>

<span class="n">FunctionPass</span> <span class="o">*</span><span class="nf">createCpu0SEISelDag</span><span class="p">(</span><span class="n">Cpu0TargetMachine</span> <span class="o">&amp;</span><span class="n">TM</span><span class="p">);</span>

<span class="p">}</span>

<span class="cp">#endif</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_3/Cpu0ISelDAGToDAG.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">//===-- Cpu0SEISelDAGToDAG.cpp - A Dag to Dag Inst Selector for Cpu0SE ----===//</span>
<span class="c1">//</span>
<span class="c1">//                     The LLVM Compiler Infrastructure</span>
<span class="c1">//</span>
<span class="c1">// This file is distributed under the University of Illinois Open Source</span>
<span class="c1">// License. See LICENSE.TXT for details.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="c1">//</span>
<span class="c1">// Subclass of Cpu0DAGToDAGISel specialized for cpu032.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>

<span class="cp">#include &quot;Cpu0SEISelDAGToDAG.h&quot;</span>

<span class="cp">#include &quot;MCTargetDesc/Cpu0BaseInfo.h&quot;</span>
<span class="cp">#include &quot;Cpu0.h&quot;</span>
<span class="cp">#include &quot;Cpu0MachineFunction.h&quot;</span>
<span class="cp">#include &quot;Cpu0RegisterInfo.h&quot;</span>
<span class="cp">#include &quot;llvm/CodeGen/MachineConstantPool.h&quot;</span>
<span class="cp">#include &quot;llvm/CodeGen/MachineFrameInfo.h&quot;</span>
<span class="cp">#include &quot;llvm/CodeGen/MachineFunction.h&quot;</span>
<span class="cp">#include &quot;llvm/CodeGen/MachineInstrBuilder.h&quot;</span>
<span class="cp">#include &quot;llvm/CodeGen/MachineRegisterInfo.h&quot;</span>
<span class="cp">#include &quot;llvm/CodeGen/SelectionDAGNodes.h&quot;</span>
<span class="cp">#include &quot;llvm/IR/CFG.h&quot;</span>
<span class="cp">#include &quot;llvm/IR/GlobalValue.h&quot;</span>
<span class="cp">#include &quot;llvm/IR/Instructions.h&quot;</span>
<span class="cp">#include &quot;llvm/IR/Intrinsics.h&quot;</span>
<span class="cp">#include &quot;llvm/IR/Type.h&quot;</span>
<span class="cp">#include &quot;llvm/Support/Debug.h&quot;</span>
<span class="cp">#include &quot;llvm/Support/ErrorHandling.h&quot;</span>
<span class="cp">#include &quot;llvm/Support/raw_ostream.h&quot;</span>
<span class="cp">#include &quot;llvm/Target/TargetMachine.h&quot;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">llvm</span><span class="p">;</span>

<span class="cp">#define DEBUG_TYPE &quot;cpu0-isel&quot;</span>

<span class="kt">bool</span> <span class="n">Cpu0SEDAGToDAGISel</span><span class="o">::</span><span class="n">runOnMachineFunction</span><span class="p">(</span><span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">MF</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">Subtarget</span> <span class="o">=</span> <span class="o">&amp;</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">MF</span><span class="p">.</span><span class="n">getSubtarget</span><span class="p">());</span>
  <span class="k">return</span> <span class="n">Cpu0DAGToDAGISel</span><span class="o">::</span><span class="n">runOnMachineFunction</span><span class="p">(</span><span class="n">MF</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Cpu0SEDAGToDAGISel</span><span class="o">::</span><span class="n">processFunctionAfterISel</span><span class="p">(</span><span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">MF</span><span class="p">)</span> <span class="p">{</span>
<span class="p">}</span>

<span class="c1">//@selectNode</span>
<span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="kt">bool</span><span class="p">,</span> <span class="n">SDNode</span><span class="o">*&gt;</span> <span class="n">Cpu0SEDAGToDAGISel</span><span class="o">::</span><span class="n">selectNode</span><span class="p">(</span><span class="n">SDNode</span> <span class="o">*</span><span class="n">Node</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">unsigned</span> <span class="n">Opcode</span> <span class="o">=</span> <span class="n">Node</span><span class="o">-&gt;</span><span class="n">getOpcode</span><span class="p">();</span>
  <span class="n">SDLoc</span> <span class="nf">DL</span><span class="p">(</span><span class="n">Node</span><span class="p">);</span>

  <span class="c1">///</span>
  <span class="c1">// Instruction Selection not handled by the auto-generated</span>
  <span class="c1">// tablegen selection should be handled here.</span>
  <span class="c1">///</span>
  <span class="n">SDNode</span> <span class="o">*</span><span class="n">Result</span><span class="p">;</span>

  <span class="c1">///</span>
  <span class="c1">// Instruction Selection not handled by the auto-generated</span>
  <span class="c1">// tablegen selection should be handled here.</span>
  <span class="c1">///</span>
  <span class="n">EVT</span> <span class="n">NodeTy</span> <span class="o">=</span> <span class="n">Node</span><span class="o">-&gt;</span><span class="n">getValueType</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="kt">unsigned</span> <span class="n">MultOpc</span><span class="p">;</span>

  <span class="k">switch</span><span class="p">(</span><span class="n">Opcode</span><span class="p">)</span> <span class="p">{</span>
  <span class="nl">default:</span> <span class="k">break</span><span class="p">;</span>

  <span class="p">}</span>

  <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="nb">false</span><span class="p">,</span> <span class="n">nullptr</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">FunctionPass</span> <span class="o">*</span><span class="n">llvm</span><span class="o">::</span><span class="n">createCpu0SEISelDag</span><span class="p">(</span><span class="n">Cpu0TargetMachine</span> <span class="o">&amp;</span><span class="n">TM</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="n">Cpu0SEDAGToDAGISel</span><span class="p">(</span><span class="n">TM</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Function Cpu0DAGToDAGISel::Select() of Cpu0ISelDAGToDAG.cpp is for the
selection of &#8220;OP code DAG node&#8221; while Cpu0DAGToDAGISel::SelectAddr() is for the
selection of &#8220;DATA DAG node with <strong>addr</strong> type&#8221; which defined in
Chapter2/Cpu0InstrInfo.td. This method name corresponding to
Chapter2/Cpu0InstrInfo.td as follows,</p>
<p class="rubric">lbdex/chapters/Chapter2/Cpu0InstrInfo.td</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">def</span> <span class="n">addr</span> <span class="o">:</span> <span class="n">ComplexPattern</span><span class="o">&lt;</span><span class="n">iPTR</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;SelectAddr&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">frameindex</span><span class="p">],</span> <span class="p">[</span><span class="n">SDNPWantParent</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<p>The iPTR, ComplexPattern, frameindex and SDNPWantParent defined as follows,</p>
<p class="rubric">src/include/llvm/Target/TargetSelection.td</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">def</span> <span class="n">SDNPWantParent</span>  <span class="o">:</span> <span class="n">SDNodeProperty</span><span class="p">;</span>   <span class="c1">// ComplexPattern gets the parent</span>
<span class="p">...</span>
<span class="n">def</span> <span class="n">frameindex</span>  <span class="o">:</span> <span class="n">SDNode</span><span class="o">&lt;</span><span class="s">&quot;ISD::FrameIndex&quot;</span><span class="p">,</span>           <span class="n">SDTPtrLeaf</span><span class="p">,</span> <span class="p">[],</span>
                         <span class="s">&quot;FrameIndexSDNode&quot;</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">...</span>
<span class="c1">// Complex patterns, e.g. X86 addressing mode, requires pattern matching code</span>
<span class="c1">// in C++. NumOperands is the number of operands returned by the select function;</span>
<span class="c1">// SelectFunc is the name of the function used to pattern match the max. pattern;</span>
<span class="c1">// RootNodes are the list of possible root nodes of the sub-dags to match.</span>
<span class="c1">// e.g. X86 addressing mode - def addr : ComplexPattern&lt;4, &quot;SelectAddr&quot;, [add]&gt;;</span>
<span class="c1">//</span>
<span class="k">class</span> <span class="nc">ComplexPattern</span><span class="o">&lt;</span><span class="n">ValueType</span> <span class="n">ty</span><span class="p">,</span> <span class="kt">int</span> <span class="n">numops</span><span class="p">,</span> <span class="n">string</span> <span class="n">fn</span><span class="p">,</span>
                     <span class="n">list</span><span class="o">&lt;</span><span class="n">SDNode</span><span class="o">&gt;</span> <span class="n">roots</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">SDNodeProperty</span><span class="o">&gt;</span> <span class="n">props</span> <span class="o">=</span> <span class="p">[]</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="n">ValueType</span> <span class="n">Ty</span> <span class="o">=</span> <span class="n">ty</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">NumOperands</span> <span class="o">=</span> <span class="n">numops</span><span class="p">;</span>
  <span class="n">string</span> <span class="n">SelectFunc</span> <span class="o">=</span> <span class="n">fn</span><span class="p">;</span>
  <span class="n">list</span><span class="o">&lt;</span><span class="n">SDNode</span><span class="o">&gt;</span> <span class="n">RootNodes</span> <span class="o">=</span> <span class="n">roots</span><span class="p">;</span>
  <span class="n">list</span><span class="o">&lt;</span><span class="n">SDNodeProperty</span><span class="o">&gt;</span> <span class="n">Properties</span> <span class="o">=</span> <span class="n">props</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">src/include/llvm/CodeGen/ValueTypes.td</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">// Pseudo valuetype mapped to the current pointer size.</span>
<span class="n">def</span> <span class="n">iPTR</span>   <span class="o">:</span> <span class="n">ValueType</span><span class="o">&lt;</span><span class="mi">0</span>  <span class="p">,</span> <span class="mi">255</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<p>Chapter3_3 adding the following code in Cpu0InstInfo.cpp to enable debug
information which called by llvm at proper time.</p>
<p class="rubric">lbdex/chapters/Chapter3_3/Cpu0InstrInfo.h</p>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="k">virtual</span> <span class="n">MachineInstr</span><span class="o">*</span> <span class="n">emitFrameIndexDebugValue</span><span class="p">(</span><span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">MF</span><span class="p">,</span>
                                                 <span class="kt">int</span> <span class="n">FrameIx</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">Offset</span><span class="p">,</span>
                                                 <span class="k">const</span> <span class="n">MDNode</span> <span class="o">*</span><span class="n">MDPtr</span><span class="p">,</span>
                                                 <span class="n">DebugLoc</span> <span class="n">DL</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_3/Cpu0InstrInfo.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">MachineInstr</span><span class="o">*</span>
<span class="n">Cpu0InstrInfo</span><span class="o">::</span><span class="n">emitFrameIndexDebugValue</span><span class="p">(</span><span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">MF</span><span class="p">,</span> <span class="kt">int</span> <span class="n">FrameIx</span><span class="p">,</span>
                                        <span class="kt">uint64_t</span> <span class="n">Offset</span><span class="p">,</span> <span class="k">const</span> <span class="n">MDNode</span> <span class="o">*</span><span class="n">MDPtr</span><span class="p">,</span>
                                        <span class="n">DebugLoc</span> <span class="n">DL</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="n">MachineInstrBuilder</span> <span class="n">MIB</span> <span class="o">=</span> <span class="n">BuildMI</span><span class="p">(</span><span class="n">MF</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">get</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">DBG_VALUE</span><span class="p">))</span>
    <span class="p">.</span><span class="n">addFrameIndex</span><span class="p">(</span><span class="n">FrameIx</span><span class="p">).</span><span class="n">addImm</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">addImm</span><span class="p">(</span><span class="n">Offset</span><span class="p">).</span><span class="n">addMetadata</span><span class="p">(</span><span class="n">MDPtr</span><span class="p">);</span>
  <span class="k">return</span> <span class="o">&amp;*</span><span class="n">MIB</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">//@GetInstSizeInBytes {</span>
<span class="c1">/// Return the number of bytes of code the specified instruction may be.</span>
<span class="kt">unsigned</span> <span class="n">Cpu0InstrInfo</span><span class="o">::</span><span class="n">GetInstSizeInBytes</span><span class="p">(</span><span class="k">const</span> <span class="n">MachineInstr</span> <span class="o">*</span><span class="n">MI</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
<span class="c1">//@GetInstSizeInBytes - body</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">MI</span><span class="o">-&gt;</span><span class="n">getOpcode</span><span class="p">())</span> <span class="p">{</span>
  <span class="nl">default:</span>
    <span class="k">return</span> <span class="n">MI</span><span class="o">-&gt;</span><span class="n">getDesc</span><span class="p">().</span><span class="n">getSize</span><span class="p">();</span>
<span class="cp">#if CH &gt;= CH11_2</span>
  <span class="k">case</span>  <span class="n">TargetOpcode</span>:<span class="o">:</span><span class="n">INLINEASM</span><span class="o">:</span> <span class="p">{</span>       <span class="c1">// Inline Asm: Variable size.</span>
    <span class="k">const</span> <span class="n">MachineFunction</span> <span class="o">*</span><span class="n">MF</span> <span class="o">=</span> <span class="n">MI</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">();</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">AsmStr</span> <span class="o">=</span> <span class="n">MI</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">getSymbolName</span><span class="p">();</span>
    <span class="k">return</span> <span class="nf">getInlineAsmLength</span><span class="p">(</span><span class="n">AsmStr</span><span class="p">,</span> <span class="o">*</span><span class="n">MF</span><span class="o">-&gt;</span><span class="n">getTarget</span><span class="p">().</span><span class="n">getMCAsmInfo</span><span class="p">());</span>
  <span class="p">}</span>
</pre></div>
</div>
<p>Build Chapter3_3 and run with it, finding the error message of Chapter3_2 is
gone. The new error message for Chapter3_3 as follows,</p>
<div class="highlight-bash"><div class="highlight"><pre>118-165-78-230:input Jonathan<span class="nv">$ </span>/Users/Jonathan/llvm/test/cmake_debug_build/
Debug/bin/llc -march<span class="o">=</span>cpu0 -relocation-model<span class="o">=</span>pic -filetype<span class="o">=</span>asm ch3.bc -o
ch3.cpu0.s
...
LLVM ERROR: Cannot <span class="k">select</span>: 0x24834b8: <span class="nv">ch</span> <span class="o">=</span> Cpu0ISD::Ret 0x24832a8, 0x24833b0 <span class="o">[</span><span class="nv">ORD</span><span class="o">=</span>4<span class="o">]</span> <span class="o">[</span><span class="nv">ID</span><span class="o">=</span>6<span class="o">]</span>
  0x24833b0: <span class="nv">i32</span> <span class="o">=</span> Register %LR <span class="o">[</span><span class="nv">ID</span><span class="o">=</span>4<span class="o">]</span>
...
  0x7f80f182d210: <span class="nv">i32</span> <span class="o">=</span> Register %LR <span class="o">[</span><span class="nv">ID</span><span class="o">=</span>4<span class="o">]</span>
</pre></div>
</div>
<p>Above can display the error message DAG node &#8220;Cpu0ISD::Ret&#8221; because the following
code added in Chapter3_1/Cpu0ISelLowering.cpp.</p>
<p class="rubric">lbdex/chapters/Chapter3_1/Cpu0ISelLowering.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">Cpu0TargetLowering</span><span class="o">::</span><span class="n">getTargetNodeName</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">Opcode</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">Opcode</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">case</span> <span class="n">Cpu0ISD</span>:<span class="o">:</span><span class="n">JmpLink</span><span class="o">:</span>           <span class="k">return</span> <span class="s">&quot;Cpu0ISD::JmpLink&quot;</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">Cpu0ISD</span>:<span class="o">:</span><span class="n">TailCall</span><span class="o">:</span>          <span class="k">return</span> <span class="s">&quot;Cpu0ISD::TailCall&quot;</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">Cpu0ISD</span>:<span class="o">:</span><span class="n">Hi</span><span class="o">:</span>                <span class="k">return</span> <span class="s">&quot;Cpu0ISD::Hi&quot;</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">Cpu0ISD</span>:<span class="o">:</span><span class="n">Lo</span><span class="o">:</span>                <span class="k">return</span> <span class="s">&quot;Cpu0ISD::Lo&quot;</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">Cpu0ISD</span>:<span class="o">:</span><span class="n">GPRel</span><span class="o">:</span>             <span class="k">return</span> <span class="s">&quot;Cpu0ISD::GPRel&quot;</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">Cpu0ISD</span>:<span class="o">:</span><span class="n">Ret</span><span class="o">:</span>               <span class="k">return</span> <span class="s">&quot;Cpu0ISD::Ret&quot;</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">Cpu0ISD</span>:<span class="o">:</span><span class="n">EH_RETURN</span><span class="o">:</span>         <span class="k">return</span> <span class="s">&quot;Cpu0ISD::EH_RETURN&quot;</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">Cpu0ISD</span>:<span class="o">:</span><span class="n">DivRem</span><span class="o">:</span>            <span class="k">return</span> <span class="s">&quot;Cpu0ISD::DivRem&quot;</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">Cpu0ISD</span>:<span class="o">:</span><span class="n">DivRemU</span><span class="o">:</span>           <span class="k">return</span> <span class="s">&quot;Cpu0ISD::DivRemU&quot;</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">Cpu0ISD</span>:<span class="o">:</span><span class="n">Wrapper</span><span class="o">:</span>           <span class="k">return</span> <span class="s">&quot;Cpu0ISD::Wrapper&quot;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="nl">default:</span>                         <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="handle-return-register-lr">
<h2><a class="toc-backref" href="#id7">Handle return register $lr</a><a class="headerlink" href="#handle-return-register-lr" title="Permalink to this headline">¶</a></h2>
<p>The following code is the result of running Mips backend with ch3.cpp.</p>
<div class="highlight-bash"><div class="highlight"><pre>JonathantekiiMac:input Jonathan<span class="nv">$ </span>~/llvm/release/cmake_debug_build/Debug/bin/llc
-march<span class="o">=</span>mips -relocation-model<span class="o">=</span>pic -filetype<span class="o">=</span>asm ch3.bc -o -
  .text
  .abicalls
  .section  .mdebug.abi32,<span class="s2">&quot;&quot;</span>,@progbits
  .nan  legacy
  .file <span class="s2">&quot;ch3.bc&quot;</span>
  .text
  .globl  main
  .align  2
  .type main,@function
  .set  nomicromips
  .set  nomips16
  .ent  main
main:                                   <span class="c"># @main</span>
  .frame  <span class="nv">$fp</span>,8,<span class="nv">$ra</span>
  .mask   0x40000000,-4
  .fmask  0x00000000,0
  .set  noreorder
  .set  nomacro
  .set  noat
<span class="c"># BB#0:</span>
  addiu <span class="nv">$sp</span>, <span class="nv">$sp</span>, -8
  sw  <span class="nv">$fp</span>, 4<span class="o">(</span><span class="nv">$sp</span><span class="o">)</span>             <span class="c"># 4-byte Folded Spill</span>
  move   <span class="nv">$fp</span>, <span class="nv">$sp</span>
  sw  <span class="nv">$zero</span>, 0<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
  addiu <span class="nv">$2</span>, <span class="nv">$zero</span>, 0
  move   <span class="nv">$sp</span>, <span class="nv">$fp</span>
  lw  <span class="nv">$fp</span>, 4<span class="o">(</span><span class="nv">$sp</span><span class="o">)</span>             <span class="c"># 4-byte Folded Reload</span>
  jr  <span class="nv">$ra</span>
  addiu <span class="nv">$sp</span>, <span class="nv">$sp</span>, 8
  .set  at
  .set  macro
  .set  reorder
  .end  main
<span class="nv">$func_end0</span>:
  .size main, <span class="o">(</span><span class="nv">$func_end0</span><span class="o">)</span>-main
</pre></div>
</div>
<p>As you can see, Mips return to the caller by using &#8220;jr $ra&#8221; where
$ra is a specific register which keeps the caller&#8217;s next instruction address.
And it save the return value in register $2.
If we only create DAGs directly, then will having the following two problems.</p>
<ol class="arabic simple">
<li>LLVM can allocate any register for return value, for instance $3, rather
than keeps it in $2.</li>
<li>LLVM will allocate a register randomly to &#8220;jr&#8221; since jr needs one operand.</li>
</ol>
<p>If Backend uses the &#8220;jal sub-routine&#8221; and &#8220;jr&#8221;, and put the return address in
the specific register $ra, then no the second problem. But in Mips, it allows
programmer uses &#8220;jal $rx, sub-routine&#8221; and &#8220;jr $rx&#8221; whereas $rx is not $ra.
Allowing programmer uses other register but $ra providing more flexibility in
programming of high level language such as C with assembly.
File ch8_2_longbranch.cpp in the following is an example, it uses jr $1 without
spill $ra register. This will save a lot of time if it is in a hot function.</p>
<p class="rubric">lbdex/input/ch8_2_longbranch.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="kt">int</span> <span class="nf">test_longbranch</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">volatile</span> <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
  <span class="k">volatile</span> <span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">&lt;</span> <span class="n">b</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-bash"><div class="highlight"><pre>JonathantekiiMac:input Jonathan<span class="nv">$ </span>clang -target mips-unknown-linux-gnu -c
ch8_2_longbranch.cpp -emit-llvm -o ch8_2_longbranch.bc
JonathantekiiMac:input Jonathan<span class="nv">$ </span>~/llvm/release/cmake_debug_build/Debug/bin/llc
-march<span class="o">=</span>mips -relocation-model<span class="o">=</span>pic -filetype<span class="o">=</span>asm -force-mips-long-branch
ch8_2_longbranch.bc -o -
  ...
  .ent  _Z15test_longbranchv
_Z15test_longbranchv:                   <span class="c"># @_Z15test_longbranchv</span>
  .frame  <span class="nv">$fp</span>,16,<span class="nv">$ra</span>
  .mask   0x40000000,-4
  .fmask  0x00000000,0
  .set  noreorder
  .set  nomacro
  .set  noat
<span class="c"># BB#0:</span>
  addiu <span class="nv">$sp</span>, <span class="nv">$sp</span>, -16
  sw  <span class="nv">$fp</span>, 12<span class="o">(</span><span class="nv">$sp</span><span class="o">)</span>            <span class="c"># 4-byte Folded Spill</span>
  move   <span class="nv">$fp</span>, <span class="nv">$sp</span>
  addiu <span class="nv">$1</span>, <span class="nv">$zero</span>, 2
  sw  <span class="nv">$1</span>, 8<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
  addiu <span class="nv">$2</span>, <span class="nv">$zero</span>, 1
  sw  <span class="nv">$2</span>, 4<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
  sw  <span class="nv">$zero</span>, 0<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
  lw  <span class="nv">$1</span>, 8<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
  lw  <span class="nv">$3</span>, 4<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
  slt <span class="nv">$1</span>, <span class="nv">$1</span>, <span class="nv">$3</span>
  bnez  <span class="nv">$1</span>, <span class="nv">$BB0_3</span>
  nop
<span class="c"># BB#1:</span>
  addiu <span class="nv">$sp</span>, <span class="nv">$sp</span>, -8
  sw  <span class="nv">$ra</span>, 0<span class="o">(</span><span class="nv">$sp</span><span class="o">)</span>
  lui <span class="nv">$1</span>, %hi<span class="o">((</span><span class="nv">$BB0_4</span><span class="o">)</span>-<span class="o">(</span><span class="nv">$BB0_2</span><span class="o">))</span>
  bal <span class="nv">$BB0_2</span>
  addiu <span class="nv">$1</span>, <span class="nv">$1</span>, %lo<span class="o">((</span><span class="nv">$BB0_4</span><span class="o">)</span>-<span class="o">(</span><span class="nv">$BB0_2</span><span class="o">))</span>
<span class="nv">$BB0_2</span>:
  addu  <span class="nv">$1</span>, <span class="nv">$ra</span>, <span class="nv">$1</span>
  lw  <span class="nv">$ra</span>, 0<span class="o">(</span><span class="nv">$sp</span><span class="o">)</span>
  jr  <span class="nv">$1</span>
  addiu <span class="nv">$sp</span>, <span class="nv">$sp</span>, 8
<span class="nv">$BB0_3</span>:
  sw  <span class="nv">$2</span>, 0<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
<span class="nv">$BB0_4</span>:
  lw  <span class="nv">$2</span>, 0<span class="o">(</span><span class="nv">$fp</span><span class="o">)</span>
  move   <span class="nv">$sp</span>, <span class="nv">$fp</span>
  lw  <span class="nv">$fp</span>, 12<span class="o">(</span><span class="nv">$sp</span><span class="o">)</span>            <span class="c"># 4-byte Folded Reload</span>
  jr  <span class="nv">$ra</span>
  addiu <span class="nv">$sp</span>, <span class="nv">$sp</span>, 16
  .set  at
  .set  macro
  .set  reorder
  .end  _Z15test_longbranchv
<span class="nv">$func_end0</span>:
  .size _Z15test_longbranchv, <span class="o">(</span><span class="nv">$func_end0</span><span class="o">)</span>-_Z15test_longbranchv
</pre></div>
</div>
<p>The following code handle the return register $lr.</p>
<p class="rubric">lbdex/chapters/Chapter3_4/Cpu0CallingConv.td</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">def</span> <span class="n">RetCC_Cpu0EABI</span> <span class="o">:</span> <span class="n">CallingConv</span><span class="o">&lt;</span><span class="p">[</span>
  <span class="c1">// i32 are returned in registers V0, V1, A0, A1</span>
  <span class="n">CCIfType</span><span class="o">&lt;</span><span class="p">[</span><span class="n">i32</span><span class="p">],</span> <span class="n">CCAssignToReg</span><span class="o">&lt;</span><span class="p">[</span><span class="n">V0</span><span class="p">,</span> <span class="n">V1</span><span class="p">,</span> <span class="n">A0</span><span class="p">,</span> <span class="n">A1</span><span class="p">]</span><span class="o">&gt;&gt;</span>
<span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">def</span> <span class="n">RetCC_Cpu0</span> <span class="o">:</span> <span class="n">CallingConv</span><span class="o">&lt;</span><span class="p">[</span>
  <span class="n">CCDelegateTo</span><span class="o">&lt;</span><span class="n">RetCC_Cpu0EABI</span><span class="o">&gt;</span>
<span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_4/Cpu0InstrFormats.td</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">// Cpu0 Pseudo Instructions Format</span>
<span class="k">class</span> <span class="nc">Cpu0Pseudo</span><span class="o">&lt;</span><span class="n">dag</span> <span class="n">outs</span><span class="p">,</span> <span class="n">dag</span> <span class="n">ins</span><span class="p">,</span> <span class="n">string</span> <span class="n">asmstr</span><span class="p">,</span> <span class="n">list</span><span class="o">&lt;</span><span class="n">dag</span><span class="o">&gt;</span> <span class="n">pattern</span><span class="o">&gt;:</span>
      <span class="n">Cpu0Inst</span><span class="o">&lt;</span><span class="n">outs</span><span class="p">,</span> <span class="n">ins</span><span class="p">,</span> <span class="n">asmstr</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">IIPseudo</span><span class="p">,</span> <span class="n">Pseudo</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="n">let</span> <span class="n">isCodeGenOnly</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">let</span> <span class="n">isPseudo</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_4/Cpu0InstrInfo.td</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">let</span> <span class="n">Predicates</span> <span class="o">=</span> <span class="p">[</span><span class="n">Ch3_4</span><span class="p">]</span> <span class="n">in</span> <span class="p">{</span>
<span class="n">let</span> <span class="n">isReturn</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">isTerminator</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">hasDelaySlot</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">isBarrier</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">hasCtrlDep</span><span class="o">=</span><span class="mi">1</span> <span class="n">in</span>
  <span class="n">def</span> <span class="n">RetLR</span> <span class="o">:</span> <span class="n">Cpu0Pseudo</span><span class="o">&lt;</span><span class="p">(</span><span class="n">outs</span><span class="p">),</span> <span class="p">(</span><span class="n">ins</span><span class="p">),</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="p">[(</span><span class="n">Cpu0Ret</span><span class="p">)]</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_4/Cpu0ISelLowering.h</p>
<div class="highlight-c++"><div class="highlight"><pre>    <span class="c1">/// Cpu0CC - This class provides methods used to analyze formal and call</span>
    <span class="c1">/// arguments and inquire about calling convention information.</span>
    <span class="k">class</span> <span class="nc">Cpu0CC</span> <span class="p">{</span>
    <span class="nl">public:</span>
      <span class="k">enum</span> <span class="n">SpecialCallingConvType</span> <span class="p">{</span>
        <span class="n">NoSpecialCallingConv</span>
      <span class="p">};</span>

      <span class="n">Cpu0CC</span><span class="p">(</span><span class="n">CallingConv</span><span class="o">::</span><span class="n">ID</span> <span class="n">CallConv</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">IsO32</span><span class="p">,</span> <span class="n">CCState</span> <span class="o">&amp;</span><span class="n">Info</span><span class="p">,</span>
             <span class="n">SpecialCallingConvType</span> <span class="n">SpecialCallingConv</span> <span class="o">=</span> <span class="n">NoSpecialCallingConv</span><span class="p">);</span>

      <span class="kt">void</span> <span class="n">analyzeCallResult</span><span class="p">(</span><span class="k">const</span> <span class="n">SmallVectorImpl</span><span class="o">&lt;</span><span class="n">ISD</span><span class="o">::</span><span class="n">InputArg</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">Ins</span><span class="p">,</span>
                             <span class="kt">bool</span> <span class="n">IsSoftFloat</span><span class="p">,</span> <span class="k">const</span> <span class="n">SDNode</span> <span class="o">*</span><span class="n">CallNode</span><span class="p">,</span>
                             <span class="k">const</span> <span class="n">Type</span> <span class="o">*</span><span class="n">RetTy</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>

      <span class="kt">void</span> <span class="n">analyzeReturn</span><span class="p">(</span><span class="k">const</span> <span class="n">SmallVectorImpl</span><span class="o">&lt;</span><span class="n">ISD</span><span class="o">::</span><span class="n">OutputArg</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">Outs</span><span class="p">,</span>
                         <span class="kt">bool</span> <span class="n">IsSoftFloat</span><span class="p">,</span> <span class="k">const</span> <span class="n">Type</span> <span class="o">*</span><span class="n">RetTy</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>

      <span class="k">const</span> <span class="n">CCState</span> <span class="o">&amp;</span><span class="n">getCCInfo</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">CCInfo</span><span class="p">;</span> <span class="p">}</span>

      <span class="c1">/// hasByValArg - Returns true if function has byval arguments.</span>
      <span class="kt">bool</span> <span class="n">hasByValArg</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="o">!</span><span class="n">ByValArgs</span><span class="p">.</span><span class="n">empty</span><span class="p">();</span> <span class="p">}</span>

      <span class="c1">/// reservedArgArea - The size of the area the caller reserves for</span>
      <span class="c1">/// register arguments. This is 16-byte if ABI is O32.</span>
      <span class="kt">unsigned</span> <span class="n">reservedArgArea</span><span class="p">()</span> <span class="k">const</span><span class="p">;</span>

      <span class="k">typedef</span> <span class="n">SmallVectorImpl</span><span class="o">&lt;</span><span class="n">ByValArgInfo</span><span class="o">&gt;::</span><span class="n">const_iterator</span> <span class="n">byval_iterator</span><span class="p">;</span>
      <span class="n">byval_iterator</span> <span class="nf">byval_begin</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">ByValArgs</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span> <span class="p">}</span>
      <span class="n">byval_iterator</span> <span class="n">byval_end</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">ByValArgs</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="p">}</span>

    <span class="nl">private:</span>

      <span class="c1">/// Return the type of the register which is used to pass an argument or</span>
      <span class="c1">/// return a value. This function returns f64 if the argument is an i64</span>
      <span class="c1">/// value which has been generated as a result of softening an f128 value.</span>
      <span class="c1">/// Otherwise, it just returns VT.</span>
      <span class="n">MVT</span> <span class="n">getRegVT</span><span class="p">(</span><span class="n">MVT</span> <span class="n">VT</span><span class="p">,</span> <span class="k">const</span> <span class="n">Type</span> <span class="o">*</span><span class="n">OrigTy</span><span class="p">,</span> <span class="k">const</span> <span class="n">SDNode</span> <span class="o">*</span><span class="n">CallNode</span><span class="p">,</span>
                   <span class="kt">bool</span> <span class="n">IsSoftFloat</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>

      <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Ty</span><span class="o">&gt;</span>
      <span class="kt">void</span> <span class="n">analyzeReturn</span><span class="p">(</span><span class="k">const</span> <span class="n">SmallVectorImpl</span><span class="o">&lt;</span><span class="n">Ty</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">RetVals</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">IsSoftFloat</span><span class="p">,</span>
                         <span class="k">const</span> <span class="n">SDNode</span> <span class="o">*</span><span class="n">CallNode</span><span class="p">,</span> <span class="k">const</span> <span class="n">Type</span> <span class="o">*</span><span class="n">RetTy</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>

      <span class="n">CCState</span> <span class="o">&amp;</span><span class="n">CCInfo</span><span class="p">;</span>
      <span class="n">CallingConv</span><span class="o">::</span><span class="n">ID</span> <span class="n">CallConv</span><span class="p">;</span>
      <span class="kt">bool</span> <span class="n">IsO32</span><span class="p">;</span>
      <span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">ByValArgInfo</span><span class="p">,</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="n">ByValArgs</span><span class="p">;</span>
    <span class="p">};</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_4/Cpu0ISelLowering.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">SDValue</span>
<span class="n">Cpu0TargetLowering</span><span class="o">::</span><span class="n">LowerReturn</span><span class="p">(</span><span class="n">SDValue</span> <span class="n">Chain</span><span class="p">,</span>
                                <span class="n">CallingConv</span><span class="o">::</span><span class="n">ID</span> <span class="n">CallConv</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">IsVarArg</span><span class="p">,</span>
                                <span class="k">const</span> <span class="n">SmallVectorImpl</span><span class="o">&lt;</span><span class="n">ISD</span><span class="o">::</span><span class="n">OutputArg</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">Outs</span><span class="p">,</span>
                                <span class="k">const</span> <span class="n">SmallVectorImpl</span><span class="o">&lt;</span><span class="n">SDValue</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">OutVals</span><span class="p">,</span>
                                <span class="n">SDLoc</span> <span class="n">DL</span><span class="p">,</span> <span class="n">SelectionDAG</span> <span class="o">&amp;</span><span class="n">DAG</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="c1">// CCValAssign - represent the assignment of</span>
  <span class="c1">// the return value to a location</span>
  <span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">CCValAssign</span><span class="p">,</span> <span class="mi">16</span><span class="o">&gt;</span> <span class="n">RVLocs</span><span class="p">;</span>
  <span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">MF</span> <span class="o">=</span> <span class="n">DAG</span><span class="p">.</span><span class="n">getMachineFunction</span><span class="p">();</span>

  <span class="c1">// CCState - Info about the registers and stack slot.</span>
  <span class="n">CCState</span> <span class="nf">CCInfo</span><span class="p">(</span><span class="n">CallConv</span><span class="p">,</span> <span class="n">IsVarArg</span><span class="p">,</span> <span class="n">MF</span><span class="p">,</span> <span class="n">RVLocs</span><span class="p">,</span>
                 <span class="o">*</span><span class="n">DAG</span><span class="p">.</span><span class="n">getContext</span><span class="p">());</span>
  <span class="n">Cpu0CC</span> <span class="nf">Cpu0CCInfo</span><span class="p">(</span><span class="n">CallConv</span><span class="p">,</span> <span class="n">ABI</span><span class="p">.</span><span class="n">IsO32</span><span class="p">(),</span> 
                    <span class="n">CCInfo</span><span class="p">);</span>

  <span class="c1">// Analyze return values.</span>
  <span class="n">Cpu0CCInfo</span><span class="p">.</span><span class="n">analyzeReturn</span><span class="p">(</span><span class="n">Outs</span><span class="p">,</span> <span class="n">Subtarget</span><span class="p">.</span><span class="n">abiUsesSoftFloat</span><span class="p">(),</span>
                           <span class="n">MF</span><span class="p">.</span><span class="n">getFunction</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getReturnType</span><span class="p">());</span>

  <span class="n">SDValue</span> <span class="n">Flag</span><span class="p">;</span>
  <span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">SDValue</span><span class="p">,</span> <span class="mi">4</span><span class="o">&gt;</span> <span class="n">RetOps</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">Chain</span><span class="p">);</span>

  <span class="c1">// Copy the result values into the output registers.</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">RVLocs</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">SDValue</span> <span class="n">Val</span> <span class="o">=</span> <span class="n">OutVals</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="n">CCValAssign</span> <span class="o">&amp;</span><span class="n">VA</span> <span class="o">=</span> <span class="n">RVLocs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">VA</span><span class="p">.</span><span class="n">isRegLoc</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="s">&quot;Can only return in registers!&quot;</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">RVLocs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getValVT</span><span class="p">()</span> <span class="o">!=</span> <span class="n">RVLocs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getLocVT</span><span class="p">())</span>
      <span class="n">Val</span> <span class="o">=</span> <span class="n">DAG</span><span class="p">.</span><span class="n">getNode</span><span class="p">(</span><span class="n">ISD</span><span class="o">::</span><span class="n">BITCAST</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">RVLocs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getLocVT</span><span class="p">(),</span> <span class="n">Val</span><span class="p">);</span>

    <span class="n">Chain</span> <span class="o">=</span> <span class="n">DAG</span><span class="p">.</span><span class="n">getCopyToReg</span><span class="p">(</span><span class="n">Chain</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">VA</span><span class="p">.</span><span class="n">getLocReg</span><span class="p">(),</span> <span class="n">Val</span><span class="p">,</span> <span class="n">Flag</span><span class="p">);</span>

    <span class="c1">// Guarantee that all emitted copies are stuck together with flags.</span>
    <span class="n">Flag</span> <span class="o">=</span> <span class="n">Chain</span><span class="p">.</span><span class="n">getValue</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">RetOps</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">DAG</span><span class="p">.</span><span class="n">getRegister</span><span class="p">(</span><span class="n">VA</span><span class="p">.</span><span class="n">getLocReg</span><span class="p">(),</span> <span class="n">VA</span><span class="p">.</span><span class="n">getLocVT</span><span class="p">()));</span>
  <span class="p">}</span>

<span class="c1">//@Ordinary struct type: 2 {</span>
  <span class="c1">// The cpu0 ABIs for returning structs by value requires that we copy</span>
  <span class="c1">// the sret argument into $v0 for the return. We saved the argument into</span>
  <span class="c1">// a virtual register in the entry block, so now we copy the value out</span>
  <span class="c1">// and into $v0.</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">MF</span><span class="p">.</span><span class="n">getFunction</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">hasStructRetAttr</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">Cpu0FunctionInfo</span> <span class="o">*</span><span class="n">Cpu0FI</span> <span class="o">=</span> <span class="n">MF</span><span class="p">.</span><span class="n">getInfo</span><span class="o">&lt;</span><span class="n">Cpu0FunctionInfo</span><span class="o">&gt;</span><span class="p">();</span>
    <span class="kt">unsigned</span> <span class="n">Reg</span> <span class="o">=</span> <span class="n">Cpu0FI</span><span class="o">-&gt;</span><span class="n">getSRetReturnReg</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">Reg</span><span class="p">)</span>
      <span class="n">llvm_unreachable</span><span class="p">(</span><span class="s">&quot;sret virtual register not created in the entry block&quot;</span><span class="p">);</span>
    <span class="n">SDValue</span> <span class="n">Val</span> <span class="o">=</span>
        <span class="n">DAG</span><span class="p">.</span><span class="n">getCopyFromReg</span><span class="p">(</span><span class="n">Chain</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">Reg</span><span class="p">,</span> <span class="n">getPointerTy</span><span class="p">(</span><span class="n">DAG</span><span class="p">.</span><span class="n">getDataLayout</span><span class="p">()));</span>
    <span class="kt">unsigned</span> <span class="n">V0</span> <span class="o">=</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">V0</span><span class="p">;</span>

    <span class="n">Chain</span> <span class="o">=</span> <span class="n">DAG</span><span class="p">.</span><span class="n">getCopyToReg</span><span class="p">(</span><span class="n">Chain</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">V0</span><span class="p">,</span> <span class="n">Val</span><span class="p">,</span> <span class="n">Flag</span><span class="p">);</span>
    <span class="n">Flag</span> <span class="o">=</span> <span class="n">Chain</span><span class="p">.</span><span class="n">getValue</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="n">RetOps</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">DAG</span><span class="p">.</span><span class="n">getRegister</span><span class="p">(</span><span class="n">V0</span><span class="p">,</span> <span class="n">getPointerTy</span><span class="p">(</span><span class="n">DAG</span><span class="p">.</span><span class="n">getDataLayout</span><span class="p">())));</span>
  <span class="p">}</span>
<span class="c1">//@Ordinary struct type: 2 }</span>

  <span class="n">RetOps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Chain</span><span class="p">;</span>  <span class="c1">// Update chain.</span>

  <span class="c1">// Add the flag if we have it.</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Flag</span><span class="p">.</span><span class="n">getNode</span><span class="p">())</span>
    <span class="n">RetOps</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">Flag</span><span class="p">);</span>

  <span class="c1">// Return on Cpu0 is always a &quot;ret $lr&quot;</span>
  <span class="k">return</span> <span class="n">DAG</span><span class="p">.</span><span class="n">getNode</span><span class="p">(</span><span class="n">Cpu0ISD</span><span class="o">::</span><span class="n">Ret</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">MVT</span><span class="o">::</span><span class="n">Other</span><span class="p">,</span> <span class="n">RetOps</span><span class="p">);</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="p">}</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Ty</span><span class="o">&gt;</span>
<span class="kt">void</span> <span class="n">Cpu0TargetLowering</span><span class="o">::</span><span class="n">Cpu0CC</span><span class="o">::</span>
<span class="n">analyzeReturn</span><span class="p">(</span><span class="k">const</span> <span class="n">SmallVectorImpl</span><span class="o">&lt;</span><span class="n">Ty</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">RetVals</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">IsSoftFloat</span><span class="p">,</span>
              <span class="k">const</span> <span class="n">SDNode</span> <span class="o">*</span><span class="n">CallNode</span><span class="p">,</span> <span class="k">const</span> <span class="n">Type</span> <span class="o">*</span><span class="n">RetTy</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="n">CCAssignFn</span> <span class="o">*</span><span class="n">Fn</span><span class="p">;</span>

  <span class="n">Fn</span> <span class="o">=</span> <span class="n">RetCC_Cpu0</span><span class="p">;</span>

  <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="n">I</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">E</span> <span class="o">=</span> <span class="n">RetVals</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">I</span> <span class="o">&lt;</span> <span class="n">E</span><span class="p">;</span> <span class="o">++</span><span class="n">I</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">MVT</span> <span class="n">VT</span> <span class="o">=</span> <span class="n">RetVals</span><span class="p">[</span><span class="n">I</span><span class="p">].</span><span class="n">VT</span><span class="p">;</span>
    <span class="n">ISD</span><span class="o">::</span><span class="n">ArgFlagsTy</span> <span class="n">Flags</span> <span class="o">=</span> <span class="n">RetVals</span><span class="p">[</span><span class="n">I</span><span class="p">].</span><span class="n">Flags</span><span class="p">;</span>
    <span class="n">MVT</span> <span class="n">RegVT</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">getRegVT</span><span class="p">(</span><span class="n">VT</span><span class="p">,</span> <span class="n">RetTy</span><span class="p">,</span> <span class="n">CallNode</span><span class="p">,</span> <span class="n">IsSoftFloat</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">Fn</span><span class="p">(</span><span class="n">I</span><span class="p">,</span> <span class="n">VT</span><span class="p">,</span> <span class="n">RegVT</span><span class="p">,</span> <span class="n">CCValAssign</span><span class="o">::</span><span class="n">Full</span><span class="p">,</span> <span class="n">Flags</span><span class="p">,</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">CCInfo</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifndef NDEBUG</span>
      <span class="n">dbgs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Call result #&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">I</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; has unhandled type &quot;</span>
             <span class="o">&lt;&lt;</span> <span class="n">EVT</span><span class="p">(</span><span class="n">VT</span><span class="p">).</span><span class="n">getEVTString</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
<span class="cp">#endif</span>
      <span class="n">llvm_unreachable</span><span class="p">(</span><span class="n">nullptr</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Cpu0TargetLowering</span><span class="o">::</span><span class="n">Cpu0CC</span><span class="o">::</span>
<span class="n">analyzeCallResult</span><span class="p">(</span><span class="k">const</span> <span class="n">SmallVectorImpl</span><span class="o">&lt;</span><span class="n">ISD</span><span class="o">::</span><span class="n">InputArg</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">Ins</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">IsSoftFloat</span><span class="p">,</span>
                  <span class="k">const</span> <span class="n">SDNode</span> <span class="o">*</span><span class="n">CallNode</span><span class="p">,</span> <span class="k">const</span> <span class="n">Type</span> <span class="o">*</span><span class="n">RetTy</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="n">analyzeReturn</span><span class="p">(</span><span class="n">Ins</span><span class="p">,</span> <span class="n">IsSoftFloat</span><span class="p">,</span> <span class="n">CallNode</span><span class="p">,</span> <span class="n">RetTy</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Cpu0TargetLowering</span><span class="o">::</span><span class="n">Cpu0CC</span><span class="o">::</span>
<span class="n">analyzeReturn</span><span class="p">(</span><span class="k">const</span> <span class="n">SmallVectorImpl</span><span class="o">&lt;</span><span class="n">ISD</span><span class="o">::</span><span class="n">OutputArg</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">Outs</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">IsSoftFloat</span><span class="p">,</span>
              <span class="k">const</span> <span class="n">Type</span> <span class="o">*</span><span class="n">RetTy</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="n">analyzeReturn</span><span class="p">(</span><span class="n">Outs</span><span class="p">,</span> <span class="n">IsSoftFloat</span><span class="p">,</span> <span class="n">nullptr</span><span class="p">,</span> <span class="n">RetTy</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="kt">unsigned</span> <span class="n">Cpu0TargetLowering</span><span class="o">::</span><span class="n">Cpu0CC</span><span class="o">::</span><span class="n">reservedArgArea</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">IsO32</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">CallConv</span> <span class="o">!=</span> <span class="n">CallingConv</span><span class="o">::</span><span class="n">Fast</span><span class="p">))</span> <span class="o">?</span> <span class="mi">8</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">MVT</span> <span class="n">Cpu0TargetLowering</span><span class="o">::</span><span class="n">Cpu0CC</span><span class="o">::</span><span class="n">getRegVT</span><span class="p">(</span><span class="n">MVT</span> <span class="n">VT</span><span class="p">,</span> <span class="k">const</span> <span class="n">Type</span> <span class="o">*</span><span class="n">OrigTy</span><span class="p">,</span>
                                         <span class="k">const</span> <span class="n">SDNode</span> <span class="o">*</span><span class="n">CallNode</span><span class="p">,</span>
                                         <span class="kt">bool</span> <span class="n">IsSoftFloat</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">IsSoftFloat</span> <span class="o">||</span> <span class="n">IsO32</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">VT</span><span class="p">;</span>

  <span class="k">return</span> <span class="n">VT</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_4/Cpu0MachineFunction.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">/// Cpu0FunctionInfo - This class is derived from MachineFunction private</span>
<span class="c1">/// Cpu0 target-specific information for each MachineFunction.</span>
<span class="k">class</span> <span class="nc">Cpu0FunctionInfo</span> <span class="o">:</span> <span class="k">public</span> <span class="n">MachineFunctionInfo</span> <span class="p">{</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>    <span class="n">SRetReturnReg</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">CallsEhReturn</span><span class="p">(</span><span class="nb">false</span><span class="p">),</span> <span class="n">CallsEhDwarf</span><span class="p">(</span><span class="nb">false</span><span class="p">),</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="kt">unsigned</span> <span class="n">getSRetReturnReg</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">SRetReturnReg</span><span class="p">;</span> <span class="p">}</span>
  <span class="kt">void</span> <span class="n">setSRetReturnReg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">Reg</span><span class="p">)</span> <span class="p">{</span> <span class="n">SRetReturnReg</span> <span class="o">=</span> <span class="n">Reg</span><span class="p">;</span> <span class="p">}</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="kt">bool</span> <span class="n">hasByvalArg</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">HasByvalArg</span><span class="p">;</span> <span class="p">}</span>
  <span class="kt">void</span> <span class="n">setFormalArgInfo</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">Size</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">HasByval</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">IncomingArgSize</span> <span class="o">=</span> <span class="n">Size</span><span class="p">;</span>
    <span class="n">HasByvalArg</span> <span class="o">=</span> <span class="n">HasByval</span><span class="p">;</span>
  <span class="p">}</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="c1">/// SRetReturnReg - Some subtargets require that sret lowering includes</span>
  <span class="c1">/// returning the value of the returned struct in a register. This field</span>
  <span class="c1">/// holds the virtual register into which the sret argument is passed.</span>
  <span class="kt">unsigned</span> <span class="n">SRetReturnReg</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="c1">/// True if function has a byval argument.</span>
  <span class="kt">bool</span> <span class="n">HasByvalArg</span><span class="p">;</span>

  <span class="c1">/// Size of incoming argument area.</span>
  <span class="kt">unsigned</span> <span class="n">IncomingArgSize</span><span class="p">;</span>

  <span class="c1">/// CallsEhReturn - Whether the function calls llvm.eh.return.</span>
  <span class="kt">bool</span> <span class="n">CallsEhReturn</span><span class="p">;</span>

  <span class="c1">/// CallsEhDwarf - Whether the function calls llvm.eh.dwarf.</span>
  <span class="kt">bool</span> <span class="n">CallsEhDwarf</span><span class="p">;</span>

  <span class="c1">/// Frame objects for spilling eh data registers.</span>
  <span class="kt">int</span> <span class="n">EhDataRegFI</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_4/Cpu0SEInstrInfo.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">//@expandPostRAPseudo</span>
  <span class="kt">bool</span> <span class="n">expandPostRAPseudo</span><span class="p">(</span><span class="n">MachineBasicBlock</span><span class="o">::</span><span class="n">iterator</span> <span class="n">MI</span><span class="p">)</span> <span class="k">const</span> <span class="n">override</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="nl">private:</span>
  <span class="kt">void</span> <span class="n">expandRetLR</span><span class="p">(</span><span class="n">MachineBasicBlock</span> <span class="o">&amp;</span><span class="n">MBB</span><span class="p">,</span> <span class="n">MachineBasicBlock</span><span class="o">::</span><span class="n">iterator</span> <span class="n">I</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_4/Cpu0SEInstrInfo.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">//@expandPostRAPseudo</span>
<span class="c1">/// Expand Pseudo instructions into real backend instructions</span>
<span class="kt">bool</span> <span class="n">Cpu0SEInstrInfo</span><span class="o">::</span><span class="n">expandPostRAPseudo</span><span class="p">(</span><span class="n">MachineBasicBlock</span><span class="o">::</span><span class="n">iterator</span> <span class="n">MI</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
<span class="c1">//@expandPostRAPseudo-body</span>
  <span class="n">MachineBasicBlock</span> <span class="o">&amp;</span><span class="n">MBB</span> <span class="o">=</span> <span class="o">*</span><span class="n">MI</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">();</span>

  <span class="k">switch</span><span class="p">(</span><span class="n">MI</span><span class="o">-&gt;</span><span class="n">getDesc</span><span class="p">().</span><span class="n">getOpcode</span><span class="p">())</span> <span class="p">{</span>
  <span class="nl">default:</span>
    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">Cpu0</span>:<span class="o">:</span><span class="n">RetLR</span><span class="o">:</span>
    <span class="n">expandRetLR</span><span class="p">(</span><span class="n">MBB</span><span class="p">,</span> <span class="n">MI</span><span class="p">);</span>
    <span class="k">break</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="p">}</span>

  <span class="n">MBB</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">MI</span><span class="p">);</span>
  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="kt">void</span> <span class="n">Cpu0SEInstrInfo</span><span class="o">::</span><span class="n">expandRetLR</span><span class="p">(</span><span class="n">MachineBasicBlock</span> <span class="o">&amp;</span><span class="n">MBB</span><span class="p">,</span>
                                <span class="n">MachineBasicBlock</span><span class="o">::</span><span class="n">iterator</span> <span class="n">I</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="n">BuildMI</span><span class="p">(</span><span class="n">MBB</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">I</span><span class="o">-&gt;</span><span class="n">getDebugLoc</span><span class="p">(),</span> <span class="n">get</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">RET</span><span class="p">)).</span><span class="n">addReg</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">LR</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>To handle IR ret, these code in Cpu0InstrInfo.td do things as below.</p>
<ol class="arabic simple">
<li>Declare a pseudo node Cpu0::RetLR to takes care the IR Cpu0ISD::Ret by the
following code,</li>
</ol>
<p class="rubric">lbdex/chapters/Chapter3_4/Cpu0InstrInfo.td</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">// Return</span>
<span class="n">def</span> <span class="n">Cpu0Ret</span> <span class="o">:</span> <span class="n">SDNode</span><span class="o">&lt;</span><span class="s">&quot;Cpu0ISD::Ret&quot;</span><span class="p">,</span> <span class="n">SDTNone</span><span class="p">,</span>
                     <span class="p">[</span><span class="n">SDNPHasChain</span><span class="p">,</span> <span class="n">SDNPOptInGlue</span><span class="p">,</span> <span class="n">SDNPVariadic</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">let</span> <span class="n">Predicates</span> <span class="o">=</span> <span class="p">[</span><span class="n">Ch3_4</span><span class="p">]</span> <span class="n">in</span> <span class="p">{</span>
<span class="n">let</span> <span class="n">isReturn</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">isTerminator</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">hasDelaySlot</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">isBarrier</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">hasCtrlDep</span><span class="o">=</span><span class="mi">1</span> <span class="n">in</span>
  <span class="n">def</span> <span class="n">RetLR</span> <span class="o">:</span> <span class="n">Cpu0Pseudo</span><span class="o">&lt;</span><span class="p">(</span><span class="n">outs</span><span class="p">),</span> <span class="p">(</span><span class="n">ins</span><span class="p">),</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="p">[(</span><span class="n">Cpu0Ret</span><span class="p">)]</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li>Create Cpu0ISD::Ret node in LowerReturn() of Cpu0ISelLowering.cpp, which is
called when meets keyword of return in C. Remind, In LowerReturn() put
return value in register $2 ($v0).</li>
<li>After instruction selection, the Cpu0ISD::Ret is replaced by Cpu0::RetLR
as below. This effect come from &#8220;def RetLR&#8221; as step 1.</li>
</ol>
<div class="highlight-bash"><div class="highlight"><pre><span class="o">=====</span> Instruction selection begins: BB#0 <span class="s1">&#39;entry&#39;</span>
Selecting: 0x1ea4050: <span class="nv">ch</span> <span class="o">=</span> Cpu0ISD::Ret 0x1ea3f50, 0x1ea3e50,
0x1ea3f50:1 <span class="o">[</span><span class="nv">ID</span><span class="o">=</span>27<span class="o">]</span>

ISEL: Starting pattern match on root node: 0x1ea4050: <span class="nv">ch</span> <span class="o">=</span> Cpu0ISD::Ret
0x1ea3f50, 0x1ea3e50, 0x1ea3f50:1 <span class="o">[</span><span class="nv">ID</span><span class="o">=</span>27<span class="o">]</span>

  Morphed node: 0x1ea4050: <span class="nv">ch</span> <span class="o">=</span> RetLR 0x1ea3e50, 0x1ea3f50, 0x1ea3f50:1
...
ISEL: Match <span class="nb">complete</span>!
<span class="o">=</span>&gt; 0x1ea4050: <span class="nv">ch</span> <span class="o">=</span> RetLR 0x1ea3e50, 0x1ea3f50, 0x1ea3f50:1
...
<span class="o">=====</span> Instruction selection ends:
Selected selection DAG: BB#0 <span class="s1">&#39;main:entry&#39;</span>
SelectionDAG has 28 nodes:
...
    0x1ea3e50: &lt;multiple use&gt;
    0x1ea3f50: &lt;multiple use&gt;
    0x1ea3f50: &lt;multiple use&gt;
  0x1ea4050: <span class="nv">ch</span> <span class="o">=</span> RetLR 0x1ea3e50, 0x1ea3f50, 0x1ea3f50:1
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li>Expand the Cpu0ISD::RetLR into instruction Cpu0::RET $lr in &#8220;Post-RA pseudo
instruction expansion pass&#8221; stage by the code in Chapter3_4/Cpu0SEInstrInfo.cpp
as above. This stage come after the register allocation, so we can replace the
V0 ($r2) by LR ($lr) without any side effect.</li>
<li>Print assembly or obj according the information (those *.inc generated by
TableGen from *.td) generated by the following code at &#8220;Cpu0 Assembly
Printer&#8221; stage.</li>
</ol>
<p class="rubric">lbdex/chapters/Chapter2/Cpu0InstrInfo.td</p>
<div class="highlight-c++"><pre>//@JumpFR {
let isBranch=1, isTerminator=1, isBarrier=1, imm16=0, hasDelaySlot = 1,
    isIndirectBranch = 1 in
class JumpFR&lt;bits&lt;8&gt; op, string instr_asm, RegisterClass RC&gt;:
  FL&lt;op, (outs), (ins RC:$ra),
     !strconcat(instr_asm, "\t$ra"), [(brind RC:$ra)], IIBranch&gt; {
  let rb = 0;
  let imm16 = 0;
</pre>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="p">}</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">def</span> <span class="n">RET</span>     <span class="o">:</span> <span class="n">RetBase</span><span class="o">&lt;</span><span class="n">GPROut</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<table border="1" class="docutils">
<caption>Handle return register lr</caption>
<colgroup>
<col width="56%" />
<col width="44%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Stage</th>
<th class="head">Function</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Write Code</td>
<td>Declare a pseudo node Cpu0::RetLR</td>
</tr>
<tr class="row-odd"><td><ul class="first last simple">
<li></li>
</ul>
</td>
<td>for IR Cpu0::Ret;</td>
</tr>
<tr class="row-even"><td>Before CPU0 DAG-&gt;DAG Pattern Instruction Selection</td>
<td>Create Cpu0ISD::Ret DAG</td>
</tr>
<tr class="row-odd"><td>Instruction selection</td>
<td>Cpu0::Ret is replaced by Cpu0::RetLR</td>
</tr>
<tr class="row-even"><td>Post-RA pseudo instruction expansion pass</td>
<td>Cpu0::RetLR -&gt; Cpu0::RET $lr</td>
</tr>
<tr class="row-odd"><td>Cpu0 Assembly Printer</td>
<td>Print according &#8220;def RET&#8221;</td>
</tr>
</tbody>
</table>
<p>Function LowerReturn() of Cpu0ISelLowering.cpp handle return variable correctly.
Chapter3_4/Cpu0ISelLowering.cpp create Cpu0ISD::Ret node in LowerReturn() which
is called by llvm system when it meets C&#8217;s keyword of return.
More specificly, it creates DAGs (Cpu0ISD::Ret (CopyToReg %X, %V0, %Y), %V0,
Flag). Since the the
V0 register is assigned in CopyToReg and Cpu0ISD::Ret use V0, the CopyToReg
with V0 register will live out and won&#8217;t be removed at any later optimization
steps. Remember, if use &#8220;return DAG.getNode(Cpu0ISD::Ret, DL, MVT::Other,
Chain, DAG.getRegister(Cpu0::LR, MVT::i32));&#8221; instead of &#8220;return DAG.getNode
(Cpu0ISD::Ret, DL, MVT::Other, &amp;RetOps[0], RetOps.size());&#8221; then the V0 register
won&#8217;t be live out, and the previous DAG (CopyToReg %X, %V0, %Y) will be removed
at later optimization steps. It ending with the return value is error.</p>
<p>Build Chapter3_4 and run with it, finding the error message in Chapter3_3 is
gone. The compile result will hang on and please press &#8220;ctrl+C&#8221; to escape out
as follows,</p>
<div class="highlight-bash"><div class="highlight"><pre>118-165-78-230:input Jonathan<span class="nv">$ </span>clang -target mips-unknown-linux-gnu -c
ch3.cpp -emit-llvm -o ch3.bc
118-165-78-230:input Jonathan<span class="nv">$ </span>~/llvm/test/cmake_debug_build/Debug/bin/llvm-dis
ch3.bc -o -
...
define i32 @main<span class="o">()</span> <span class="c">#0 {</span>
  %1 <span class="o">=</span> alloca i32, align 4
  store i32 0, i32* %1
  ret i32 0
<span class="o">}</span>

118-165-78-230:input Jonathan<span class="nv">$ </span>/Users/Jonathan/llvm/test/cmake_debug_build/
Debug/bin/llc -march<span class="o">=</span>cpu0 -relocation-model<span class="o">=</span>pic -filetype<span class="o">=</span>asm ch3.bc -o -
  ...
  .text
  .section .mdebug.abiO32
  .previous
  .file <span class="s2">&quot;ch3.bc&quot;</span>
^C
</pre></div>
</div>
<p>It hang on because Cpu0 backend has not handled stack slot for local variables.
Instruction &#8220;store i32 0, i32* %1&#8221; in above IR need Cpu0 allocate a stack slot
and save to the stack slot.
However, the ch3.cpp can be run with option <tt class="docutils literal"><span class="pre">clang</span> <span class="pre">-O2</span></tt> as follows,</p>
<div class="highlight-bash"><div class="highlight"><pre>118-165-78-230:input Jonathan<span class="nv">$ </span>clang -O2 -target mips-unknown-linux-gnu -c
ch3.cpp -emit-llvm -o ch3.bc
118-165-78-230:input Jonathan<span class="nv">$ </span>~/llvm/test/cmake_debug_build/Debug/bin/llvm-dis
ch3.bc -o -
...
define i32 @main<span class="o">()</span> <span class="c">#0 {</span>
  ret i32 0
<span class="o">}</span>

118-165-78-230:input Jonathan<span class="nv">$ </span>/Users/Jonathan/llvm/test/cmake_debug_build/
Debug/bin/llc -march<span class="o">=</span>cpu0 -relocation-model<span class="o">=</span>pic -filetype<span class="o">=</span>asm ch3.bc -o -
  .text
  .section .mdebug.abiO32
  .previous
  .file <span class="s2">&quot;ch3.bc&quot;</span>
  .globl  main
  .align  2
  .type main,@function
  .ent  main                    <span class="c"># @main</span>
main:
  .frame  <span class="nv">$sp</span>,0,<span class="nv">$lr</span>
  .mask   0x00000000,0
  .set  noreorder
  .set  nomacro
<span class="c"># BB#0:</span>
  addiu <span class="nv">$2</span>, <span class="nv">$zero</span>, 0
  ret <span class="nv">$lr</span>
  .set  macro
  .set  reorder
  .end  main
<span class="nv">$func_end0</span>:
  .size main, <span class="o">(</span><span class="nv">$func_end0</span><span class="o">)</span>-main
</pre></div>
</div>
<p>To see how the <strong>&#8216;DAG-&gt;DAG Pattern Instruction Selection&#8217;</strong> work in llc, let&#8217;s
compile with <tt class="docutils literal"><span class="pre">llc</span> <span class="pre">-debug</span></tt> option and get the following result.
The DAGs which before and after instruction selection stage are shown as follows,</p>
<div class="highlight-bash"><div class="highlight"><pre>118-165-78-230:input Jonathan<span class="nv">$ </span>clang -O2 -target mips-unknown-linux-gnu -c
ch3.cpp -emit-llvm -o ch3.bc
118-165-78-12:input Jonathan<span class="nv">$ </span>/Users/Jonathan/llvm/test/cmake_debug_build/
Debug/bin/llc -march<span class="o">=</span>cpu0 -relocation-model<span class="o">=</span>pic -filetype<span class="o">=</span>asm -debug ch3.bc -o -
...
Optimized legalized selection DAG: BB#0 <span class="s1">&#39;main:&#39;</span>
SelectionDAG has 5 nodes:
  0x7fa50b046528: <span class="nv">i32</span> <span class="o">=</span> Register %V0 <span class="o">[</span><span class="nv">ID</span><span class="o">=</span>2<span class="o">]</span>

    0x7fa50ac15de0: <span class="nv">ch</span> <span class="o">=</span> EntryToken <span class="o">[</span><span class="nv">ID</span><span class="o">=</span>0<span class="o">]</span>

    0x7fa50b046528: &lt;multiple use&gt;
    0x7fa50b046400: <span class="nv">i32</span> <span class="o">=</span> Constant&lt;0&gt; <span class="o">[</span><span class="nv">ID</span><span class="o">=</span>1<span class="o">]</span>

  0x7fa50b046650: ch,glue <span class="o">=</span> CopyToReg 0x7fa50ac15de0, 0x7fa50b046528, 0x7fa50b046400
  <span class="o">[</span><span class="nv">ORD</span><span class="o">=</span>2<span class="o">]</span> <span class="o">[</span><span class="nv">ID</span><span class="o">=</span>3<span class="o">]</span>

    0x7fa50b046650: &lt;multiple use&gt;
    0x7fa50b046528: &lt;multiple use&gt;
    0x7fa50b046650: &lt;multiple use&gt;
  0x7fa50b046778: <span class="nv">ch</span> <span class="o">=</span> Cpu0ISD::Ret 0x7fa50b046650, 0x7fa50b046528, 0x7fa50b046650:1
  <span class="o">[</span><span class="nv">ORD</span><span class="o">=</span>2<span class="o">]</span> <span class="o">[</span><span class="nv">ID</span><span class="o">=</span>4<span class="o">]</span>

<span class="o">=====</span> Instruction selection begins: BB#0 <span class="s1">&#39;&#39;</span>
Selecting: 0x7fa50b046778: <span class="nv">ch</span> <span class="o">=</span> Cpu0ISD::Ret 0x7fa50b046650, 0x7fa50b046528,
0x7fa50b046650:1 <span class="o">[</span><span class="nv">ORD</span><span class="o">=</span>2<span class="o">]</span> <span class="o">[</span><span class="nv">ID</span><span class="o">=</span>4<span class="o">]</span>

ISEL: Starting pattern match on root node: 0x7fa50b046778: <span class="nv">ch</span> <span class="o">=</span> Cpu0ISD::Ret
0x7fa50b046650, 0x7fa50b046528, 0x7fa50b046650:1 <span class="o">[</span><span class="nv">ORD</span><span class="o">=</span>2<span class="o">]</span> <span class="o">[</span><span class="nv">ID</span><span class="o">=</span>4<span class="o">]</span>

  Morphed node: 0x7fa50b046778: <span class="nv">ch</span> <span class="o">=</span> RetLR 0x7fa50b046528, 0x7fa50b046650,
  0x7fa50b046650:1 <span class="o">[</span><span class="nv">ORD</span><span class="o">=</span>2<span class="o">]</span>

ISEL: Match <span class="nb">complete</span>!
<span class="o">=</span>&gt; 0x7fa50b046778: <span class="nv">ch</span> <span class="o">=</span> RetLR 0x7fa50b046528, 0x7fa50b046650, 0x7fa50b046650:1
<span class="o">[</span><span class="nv">ORD</span><span class="o">=</span>2<span class="o">]</span>

Selecting: 0x7fa50b046650: ch,glue <span class="o">=</span> CopyToReg 0x7fa50ac15de0, 0x7fa50b046528,
0x7fa50b046400 <span class="o">[</span><span class="nv">ORD</span><span class="o">=</span>2<span class="o">]</span> <span class="o">[</span><span class="nv">ID</span><span class="o">=</span>3<span class="o">]</span>

<span class="o">=</span>&gt; 0x7fa50b046650: ch,glue <span class="o">=</span> CopyToReg 0x7fa50ac15de0, 0x7fa50b046528,
0x7fa50b046400 <span class="o">[</span><span class="nv">ORD</span><span class="o">=</span>2<span class="o">]</span>

Selecting: 0x7fa50b046528: <span class="nv">i32</span> <span class="o">=</span> Register %V0 <span class="o">[</span><span class="nv">ID</span><span class="o">=</span>2<span class="o">]</span>

<span class="o">=</span>&gt; 0x7fa50b046528: <span class="nv">i32</span> <span class="o">=</span> Register %V0

Selecting: 0x7fa50b046400: <span class="nv">i32</span> <span class="o">=</span> Constant&lt;0&gt; <span class="o">[</span><span class="nv">ID</span><span class="o">=</span>1<span class="o">]</span>

ISEL: Starting pattern match on root node: 0x7fa50b046400: <span class="nv">i32</span> <span class="o">=</span> Constant&lt;0&gt; <span class="o">[</span><span class="nv">ID</span><span class="o">=</span>1<span class="o">]</span>

  Initial Opcode index to 3410
  Morphed node: 0x7fa50b046400: <span class="nv">i32</span> <span class="o">=</span> ADDiu 0x7fa50b0468a0, 0x7fa50b0469c8

ISEL: Match <span class="nb">complete</span>!
<span class="o">=</span>&gt; 0x7fa50b046400: <span class="nv">i32</span> <span class="o">=</span> ADDiu 0x7fa50b0468a0, 0x7fa50b0469c8

Selecting: 0x7fa50ac15de0: <span class="nv">ch</span> <span class="o">=</span> EntryToken <span class="o">[</span><span class="nv">ID</span><span class="o">=</span>0<span class="o">]</span>

<span class="o">=</span>&gt; 0x7fa50ac15de0: <span class="nv">ch</span> <span class="o">=</span> <span class="nv">EntryToken</span>

<span class="o">=====</span> Instruction selection ends:
</pre></div>
</div>
<p>Summary above translation into Table: Chapter 3 .bc IR instructions.</p>
<table border="1" class="docutils">
<caption>Chapter 3 .bc IR instructions</caption>
<colgroup>
<col width="40%" />
<col width="47%" />
<col width="14%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">.bc</th>
<th class="head">Optimized legalized selection DAG</th>
<th class="head">Cpu0</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>constant 0</td>
<td>constant 0</td>
<td>addiu</td>
</tr>
<tr class="row-odd"><td>ret</td>
<td>Cpu0ISD::Ret</td>
<td>ret</td>
</tr>
</tbody>
</table>
<p>From above <tt class="docutils literal"><span class="pre">llc</span> <span class="pre">-debug</span></tt> display, we see <strong>ret</strong> is translated into
<strong>Cpu0ISD::Ret</strong> in stage Optimized legalized selection DAG, and then
translated into Cpu0 instructions <strong>ret</strong> finally.
Since ret use <strong>constant 0</strong> (<strong>ret i32 0</strong> in this example), the
constant 0 will be translated into <strong>&#8220;addiu $2, $zero, 0&#8221;</strong> via the following
pattern defined in Cpu0InstrInfo.td.</p>
<p class="rubric">lbdex/chapters/Chapter2/Cpu0InstrInfo.td</p>
<div class="highlight-c++"><pre>// Small immediates
def : Pat&lt;(i32 immSExt16:$in),
          (ADDiu ZERO, imm:$in)&gt;;
</pre>
</div>
</div>
<div class="section" id="add-prologue-epilogue-functions">
<h2><a class="toc-backref" href="#id8">Add Prologue/Epilogue functions</a><a class="headerlink" href="#add-prologue-epilogue-functions" title="Permalink to this headline">¶</a></h2>
<div class="section" id="concept">
<h3><a class="toc-backref" href="#id9">Concept</a><a class="headerlink" href="#concept" title="Permalink to this headline">¶</a></h3>
<p>Following come from tricore_llvm.pdf section “4.4.2 Non-static Register
Information ”.</p>
<p>For some target architectures, some aspects of the target architecture’s
register set are dependent upon variable factors and have to be determined at
runtime.
As a consequence, they cannot be generated statically from a TableGen
description – although that would be possible for the bulk of them in the case
of the TriCore backend.
Among them are the following points:</p>
<ul class="simple">
<li>Callee-saved registers. Normally, the ABI specifies a set of registers that a
function must save on entry and restore on return if their contents are
possibly modified during execution.</li>
<li>Reserved registers. Although the set of unavailable registers is already
defined in the TableGen file, TriCoreRegisterInfo contains a method that marks
all non-allocatable register numbers in a bit vector.</li>
</ul>
<p>The following methods are implemented:</p>
<ul class="simple">
<li>emitPrologue() inserts prologue code at the beginning of a function. Thanks
to TriCore’s context model, this is a trivial task as it is not required to
save any registers manually. The only thing that has to be done is reserving
space for the function’s stack frame by decrementing the stack pointer.
In addition, if the function needs a frame pointer, the frame register %a14 is
set to the old value of the stack pointer beforehand.</li>
<li>emitEpilogue() is intended to emit instructions to destroy the stack frame
and restore all previously saved registers before returning from a function.
However, as %a10 (stack pointer), %a11 (return address), and %a14 (frame
pointer, if any) are all part of the upper context, no epilogue code is needed
at all. All cleanup operations are performed implicitly by the ret instruction.</li>
<li>eliminateFrameIndex() is called for each instruction that references a word
of data in a stack slot. All previous passes of the code generator have been
addressing stack slots through an abstract frame index and an immediate offset.
The purpose of this function is to translate such a reference into a
register–offset pair. Depending on whether the machine function that contains
the instruction has a fixed or a variable stack frame, either the stack pointer
%a10 or the frame pointer %a14 is used as the base register.
The offset is computed accordingly.
<a class="pageref" href="#backendstructure-f10">Figure  3</a> demonstrates for both cases how a stack slot
is addressed.</li>
</ul>
<p>If the addressing mode of the affected instruction cannot handle the address
because the offset is too large (the offset field has 10 bits for the BO
addressing mode and 16 bits for the BOL mode), a sequence of instructions is
emitted that explicitly computes the effective address.
Interim results are put into an unused address register.
If none is available, an already occupied address register is scavenged.
For this purpose, LLVM’s framework offers a class named RegScavenger that
takes care of all the details.</p>
<div class="figure align-center" id="backendstructure-f10">
<img alt="_images/10.png" src="_images/10.png" />
<p class="caption">Figure 3: Addressing of a variable a located on the stack.
If the stack frame has a variable size, slot must be addressed relative to
the frame pointer</p>
</div>
</div>
<div class="section" id="prologue-and-epilogue-functions">
<h3><a class="toc-backref" href="#id10">Prologue and Epilogue functions</a><a class="headerlink" href="#prologue-and-epilogue-functions" title="Permalink to this headline">¶</a></h3>
<p>The Prologue and Epilogue functions as follows,</p>
<p class="rubric">lbdex/chapters/Chapter3_5/Cpu0SEFrameLowering.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="kt">void</span> <span class="n">Cpu0SEFrameLowering</span><span class="o">::</span><span class="n">emitPrologue</span><span class="p">(</span><span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">MF</span><span class="p">,</span>
                                       <span class="n">MachineBasicBlock</span> <span class="o">&amp;</span><span class="n">MBB</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="n">assert</span><span class="p">(</span><span class="o">&amp;</span><span class="n">MF</span><span class="p">.</span><span class="n">front</span><span class="p">()</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">MBB</span> <span class="o">&amp;&amp;</span> <span class="s">&quot;Shrink-wrapping not yet supported&quot;</span><span class="p">);</span>
  <span class="n">MachineFrameInfo</span> <span class="o">*</span><span class="n">MFI</span>    <span class="o">=</span> <span class="n">MF</span><span class="p">.</span><span class="n">getFrameInfo</span><span class="p">();</span>
  <span class="n">Cpu0FunctionInfo</span> <span class="o">*</span><span class="n">Cpu0FI</span> <span class="o">=</span> <span class="n">MF</span><span class="p">.</span><span class="n">getInfo</span><span class="o">&lt;</span><span class="n">Cpu0FunctionInfo</span><span class="o">&gt;</span><span class="p">();</span>

  <span class="k">const</span> <span class="n">Cpu0SEInstrInfo</span> <span class="o">&amp;</span><span class="n">TII</span> <span class="o">=</span>
    <span class="o">*</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">Cpu0SEInstrInfo</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">STI</span><span class="p">.</span><span class="n">getInstrInfo</span><span class="p">());</span>
  <span class="k">const</span> <span class="n">Cpu0RegisterInfo</span> <span class="o">&amp;</span><span class="n">RegInfo</span> <span class="o">=</span>
      <span class="o">*</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">Cpu0RegisterInfo</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">STI</span><span class="p">.</span><span class="n">getRegisterInfo</span><span class="p">());</span>

  <span class="n">MachineBasicBlock</span><span class="o">::</span><span class="n">iterator</span> <span class="n">MBBI</span> <span class="o">=</span> <span class="n">MBB</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
  <span class="n">DebugLoc</span> <span class="n">dl</span> <span class="o">=</span> <span class="n">MBBI</span> <span class="o">!=</span> <span class="n">MBB</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="o">?</span> <span class="n">MBBI</span><span class="o">-&gt;</span><span class="n">getDebugLoc</span><span class="p">()</span> <span class="o">:</span> <span class="n">DebugLoc</span><span class="p">();</span>
  <span class="n">Cpu0ABIInfo</span> <span class="n">ABI</span> <span class="o">=</span> <span class="n">STI</span><span class="p">.</span><span class="n">getABI</span><span class="p">();</span>
  <span class="kt">unsigned</span> <span class="n">SP</span> <span class="o">=</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">SP</span><span class="p">;</span>
  <span class="k">const</span> <span class="n">TargetRegisterClass</span> <span class="o">*</span><span class="n">RC</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">GPROutRegClass</span><span class="p">;</span>

  <span class="c1">// First, compute final stack size.</span>
  <span class="kt">uint64_t</span> <span class="n">StackSize</span> <span class="o">=</span> <span class="n">MFI</span><span class="o">-&gt;</span><span class="n">getStackSize</span><span class="p">();</span>

  <span class="c1">// No need to allocate space on the stack.</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">StackSize</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">MFI</span><span class="o">-&gt;</span><span class="n">adjustsStack</span><span class="p">())</span> <span class="k">return</span><span class="p">;</span>

  <span class="n">MachineModuleInfo</span> <span class="o">&amp;</span><span class="n">MMI</span> <span class="o">=</span> <span class="n">MF</span><span class="p">.</span><span class="n">getMMI</span><span class="p">();</span>
  <span class="k">const</span> <span class="n">MCRegisterInfo</span> <span class="o">*</span><span class="n">MRI</span> <span class="o">=</span> <span class="n">MMI</span><span class="p">.</span><span class="n">getContext</span><span class="p">().</span><span class="n">getRegisterInfo</span><span class="p">();</span>
  <span class="n">MachineLocation</span> <span class="n">DstML</span><span class="p">,</span> <span class="n">SrcML</span><span class="p">;</span>

  <span class="c1">// Adjust stack.</span>
  <span class="n">TII</span><span class="p">.</span><span class="n">adjustStackPtr</span><span class="p">(</span><span class="n">SP</span><span class="p">,</span> <span class="o">-</span><span class="n">StackSize</span><span class="p">,</span> <span class="n">MBB</span><span class="p">,</span> <span class="n">MBBI</span><span class="p">);</span>

  <span class="c1">// emit &quot;.cfi_def_cfa_offset StackSize&quot;</span>
  <span class="kt">unsigned</span> <span class="n">CFIIndex</span> <span class="o">=</span> <span class="n">MMI</span><span class="p">.</span><span class="n">addFrameInst</span><span class="p">(</span>
      <span class="n">MCCFIInstruction</span><span class="o">::</span><span class="n">createDefCfaOffset</span><span class="p">(</span><span class="n">nullptr</span><span class="p">,</span> <span class="o">-</span><span class="n">StackSize</span><span class="p">));</span>
  <span class="n">BuildMI</span><span class="p">(</span><span class="n">MBB</span><span class="p">,</span> <span class="n">MBBI</span><span class="p">,</span> <span class="n">dl</span><span class="p">,</span> <span class="n">TII</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">TargetOpcode</span><span class="o">::</span><span class="n">CFI_INSTRUCTION</span><span class="p">))</span>
      <span class="p">.</span><span class="n">addCFIIndex</span><span class="p">(</span><span class="n">CFIIndex</span><span class="p">);</span>

  <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">CalleeSavedInfo</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">CSI</span> <span class="o">=</span> <span class="n">MFI</span><span class="o">-&gt;</span><span class="n">getCalleeSavedInfo</span><span class="p">();</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">CSI</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="p">{</span>
    <span class="c1">// Find the instruction past the last instruction that saves a callee-saved</span>
    <span class="c1">// register to the stack.</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CSI</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
      <span class="o">++</span><span class="n">MBBI</span><span class="p">;</span>

    <span class="c1">// Iterate over list of callee-saved registers and emit .cfi_offset</span>
    <span class="c1">// directives.</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">CalleeSavedInfo</span><span class="o">&gt;::</span><span class="n">const_iterator</span> <span class="n">I</span> <span class="o">=</span> <span class="n">CSI</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span>
           <span class="n">E</span> <span class="o">=</span> <span class="n">CSI</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="n">I</span> <span class="o">!=</span> <span class="n">E</span><span class="p">;</span> <span class="o">++</span><span class="n">I</span><span class="p">)</span> <span class="p">{</span>
      <span class="kt">int64_t</span> <span class="n">Offset</span> <span class="o">=</span> <span class="n">MFI</span><span class="o">-&gt;</span><span class="n">getObjectOffset</span><span class="p">(</span><span class="n">I</span><span class="o">-&gt;</span><span class="n">getFrameIdx</span><span class="p">());</span>
      <span class="kt">unsigned</span> <span class="n">Reg</span> <span class="o">=</span> <span class="n">I</span><span class="o">-&gt;</span><span class="n">getReg</span><span class="p">();</span>
      <span class="p">{</span>
        <span class="c1">// Reg is in CPURegs.</span>
        <span class="kt">unsigned</span> <span class="n">CFIIndex</span> <span class="o">=</span> <span class="n">MMI</span><span class="p">.</span><span class="n">addFrameInst</span><span class="p">(</span><span class="n">MCCFIInstruction</span><span class="o">::</span><span class="n">createOffset</span><span class="p">(</span>
            <span class="n">nullptr</span><span class="p">,</span> <span class="n">MRI</span><span class="o">-&gt;</span><span class="n">getDwarfRegNum</span><span class="p">(</span><span class="n">Reg</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">Offset</span><span class="p">));</span>
        <span class="n">BuildMI</span><span class="p">(</span><span class="n">MBB</span><span class="p">,</span> <span class="n">MBBI</span><span class="p">,</span> <span class="n">dl</span><span class="p">,</span> <span class="n">TII</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">TargetOpcode</span><span class="o">::</span><span class="n">CFI_INSTRUCTION</span><span class="p">))</span>
            <span class="p">.</span><span class="n">addCFIIndex</span><span class="p">(</span><span class="n">CFIIndex</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="kt">void</span> <span class="n">Cpu0SEFrameLowering</span><span class="o">::</span><span class="n">emitEpilogue</span><span class="p">(</span><span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">MF</span><span class="p">,</span>
                                 <span class="n">MachineBasicBlock</span> <span class="o">&amp;</span><span class="n">MBB</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="n">MachineBasicBlock</span><span class="o">::</span><span class="n">iterator</span> <span class="n">MBBI</span> <span class="o">=</span> <span class="n">MBB</span><span class="p">.</span><span class="n">getLastNonDebugInstr</span><span class="p">();</span>
  <span class="n">MachineFrameInfo</span> <span class="o">*</span><span class="n">MFI</span>            <span class="o">=</span> <span class="n">MF</span><span class="p">.</span><span class="n">getFrameInfo</span><span class="p">();</span>
  <span class="n">Cpu0FunctionInfo</span> <span class="o">*</span><span class="n">Cpu0FI</span> <span class="o">=</span> <span class="n">MF</span><span class="p">.</span><span class="n">getInfo</span><span class="o">&lt;</span><span class="n">Cpu0FunctionInfo</span><span class="o">&gt;</span><span class="p">();</span>

  <span class="k">const</span> <span class="n">Cpu0SEInstrInfo</span> <span class="o">&amp;</span><span class="n">TII</span> <span class="o">=</span>
      <span class="o">*</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">Cpu0SEInstrInfo</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">STI</span><span class="p">.</span><span class="n">getInstrInfo</span><span class="p">());</span>
  <span class="k">const</span> <span class="n">Cpu0RegisterInfo</span> <span class="o">&amp;</span><span class="n">RegInfo</span> <span class="o">=</span>
      <span class="o">*</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">Cpu0RegisterInfo</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">STI</span><span class="p">.</span><span class="n">getRegisterInfo</span><span class="p">());</span>

  <span class="n">DebugLoc</span> <span class="n">dl</span> <span class="o">=</span> <span class="n">MBBI</span><span class="o">-&gt;</span><span class="n">getDebugLoc</span><span class="p">();</span>
  <span class="n">Cpu0ABIInfo</span> <span class="n">ABI</span> <span class="o">=</span> <span class="n">STI</span><span class="p">.</span><span class="n">getABI</span><span class="p">();</span>
  <span class="kt">unsigned</span> <span class="n">SP</span> <span class="o">=</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">SP</span><span class="p">;</span>

  <span class="c1">// Get the number of bytes from FrameInfo</span>
  <span class="kt">uint64_t</span> <span class="n">StackSize</span> <span class="o">=</span> <span class="n">MFI</span><span class="o">-&gt;</span><span class="n">getStackSize</span><span class="p">();</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">StackSize</span><span class="p">)</span>
    <span class="k">return</span><span class="p">;</span>

  <span class="c1">// Adjust stack.</span>
  <span class="n">TII</span><span class="p">.</span><span class="n">adjustStackPtr</span><span class="p">(</span><span class="n">SP</span><span class="p">,</span> <span class="n">StackSize</span><span class="p">,</span> <span class="n">MBB</span><span class="p">,</span> <span class="n">MBBI</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="kt">bool</span>
<span class="n">Cpu0SEFrameLowering</span><span class="o">::</span><span class="n">hasReservedCallFrame</span><span class="p">(</span><span class="k">const</span> <span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">MF</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="k">const</span> <span class="n">MachineFrameInfo</span> <span class="o">*</span><span class="n">MFI</span> <span class="o">=</span> <span class="n">MF</span><span class="p">.</span><span class="n">getFrameInfo</span><span class="p">();</span>

  <span class="c1">// Reserve call frame if the size of the maximum call frame fits into 16-bit</span>
  <span class="c1">// immediate field and there are no variable sized objects on the stack.</span>
  <span class="c1">// Make sure the second register scavenger spill slot can be accessed with one</span>
  <span class="c1">// instruction.</span>
  <span class="k">return</span> <span class="n">isInt</span><span class="o">&lt;</span><span class="mi">16</span><span class="o">&gt;</span><span class="p">(</span><span class="n">MFI</span><span class="o">-&gt;</span><span class="n">getMaxCallFrameSize</span><span class="p">()</span> <span class="o">+</span> <span class="n">getStackAlignment</span><span class="p">())</span> <span class="o">&amp;&amp;</span>
    <span class="o">!</span><span class="n">MFI</span><span class="o">-&gt;</span><span class="n">hasVarSizedObjects</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_5/Cpu0MachineFunction.h</p>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="kt">unsigned</span> <span class="n">getIncomingArgSize</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">IncomingArgSize</span><span class="p">;</span> <span class="p">}</span>

  <span class="kt">bool</span> <span class="n">callsEhReturn</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">CallsEhReturn</span><span class="p">;</span> <span class="p">}</span>
  <span class="kt">void</span> <span class="n">setCallsEhReturn</span><span class="p">()</span> <span class="p">{</span> <span class="n">CallsEhReturn</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span> <span class="p">}</span>

  <span class="kt">bool</span> <span class="n">callsEhDwarf</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">CallsEhDwarf</span><span class="p">;</span> <span class="p">}</span>
  <span class="kt">void</span> <span class="n">setCallsEhDwarf</span><span class="p">()</span> <span class="p">{</span> <span class="n">CallsEhDwarf</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span> <span class="p">}</span>

  <span class="kt">void</span> <span class="n">createEhDataRegsFI</span><span class="p">();</span>
  <span class="kt">int</span> <span class="n">getEhDataRegFI</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">Reg</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">EhDataRegFI</span><span class="p">[</span><span class="n">Reg</span><span class="p">];</span> <span class="p">}</span>

  <span class="kt">unsigned</span> <span class="n">getMaxCallFrameSize</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">MaxCallFrameSize</span><span class="p">;</span> <span class="p">}</span>
  <span class="kt">void</span> <span class="n">setMaxCallFrameSize</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">S</span><span class="p">)</span> <span class="p">{</span> <span class="n">MaxCallFrameSize</span> <span class="o">=</span> <span class="n">S</span><span class="p">;</span> <span class="p">}</span>
</pre></div>
</div>
<p>Now we explain the Prologue and Epilogue further by example code.
For the following llvm IR code of ch3.cpp, Chapter3_5 of Cpu0 backend will emit
the corresponding machine instructions as follows,</p>
<div class="highlight-bash"><div class="highlight"><pre>118-165-78-230:input Jonathan<span class="nv">$ </span>clang -target mips-unknown-linux-gnu -c
ch3.cpp -emit-llvm -o ch3.bc
118-165-78-230:input Jonathan<span class="nv">$ </span>~/llvm/test/cmake_debug_build/Debug/bin/llvm-dis
ch3.bc -o -
...
define i32 @main<span class="o">()</span> <span class="c">#0 {</span>
  %1 <span class="o">=</span> alloca i32, align 4
  store i32 0, i32* %1
  ret i32 0
<span class="o">}</span>

118-165-78-230:input Jonathan<span class="nv">$ </span>/Users/Jonathan/llvm/test/cmake_debug_build/
Debug/bin/llc -march<span class="o">=</span>cpu0 -relocation-model<span class="o">=</span>pic -filetype<span class="o">=</span>asm ch3.bc -o -
  ...
  .section .mdebug.abi32
  .previous
  .file <span class="s2">&quot;ch3.bc&quot;</span>
  .text
  .globl  main//static void expandLargeImm<span class="se">\\</span>n
  .align  2
  .type main,@function
  .ent  main                    <span class="c"># @main</span>
main:
  .cfi_startproc
  .frame  <span class="nv">$sp</span>,8,<span class="nv">$lr</span>
  .mask   0x00000000,0
  .set  noreorder
  .set  nomacro
<span class="c"># BB#0:</span>
  addiu <span class="nv">$sp</span>, <span class="nv">$sp</span>, -8
<span class="nv">$tmp1</span>:
  .cfi_def_cfa_offset 8
  addiu <span class="nv">$2</span>, <span class="nv">$zero</span>, 0
  st  <span class="nv">$2</span>, 4<span class="o">(</span><span class="nv">$sp</span><span class="o">)</span>
  addiu <span class="nv">$sp</span>, <span class="nv">$sp</span>, 8
  ret <span class="nv">$lr</span>
  .set  macro
  .set  reorder
  .end  main
<span class="nv">$tmp2</span>:
  .size main, <span class="o">(</span><span class="nv">$tmp2</span><span class="o">)</span>-main
  .cfi_endproc
</pre></div>
</div>
<p>LLVM get the stack size by counting how many virtual registers is assigned to
local variables.
After that, it calls emitPrologue().</p>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="k">virtual</span> <span class="kt">void</span> <span class="n">adjustStackPtr</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">SP</span><span class="p">,</span> <span class="kt">int64_t</span> <span class="n">Amount</span><span class="p">,</span>
                              <span class="n">MachineBasicBlock</span> <span class="o">&amp;</span><span class="n">MBB</span><span class="p">,</span>
                              <span class="n">MachineBasicBlock</span><span class="o">::</span><span class="n">iterator</span> <span class="n">I</span><span class="p">)</span> <span class="k">const</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_5/Cpu0SEInstrInfo.h</p>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="c1">/// Adjust SP by Amount bytes.</span>
  <span class="kt">void</span> <span class="n">adjustStackPtr</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">SP</span><span class="p">,</span> <span class="kt">int64_t</span> <span class="n">Amount</span><span class="p">,</span> <span class="n">MachineBasicBlock</span> <span class="o">&amp;</span><span class="n">MBB</span><span class="p">,</span>
                      <span class="n">MachineBasicBlock</span><span class="o">::</span><span class="n">iterator</span> <span class="n">I</span><span class="p">)</span> <span class="k">const</span> <span class="n">override</span><span class="p">;</span>

  <span class="c1">/// Emit a series of instructions to load an immediate. If NewImm is a</span>
  <span class="c1">/// non-NULL parameter, the last instruction is not emitted, but instead</span>
  <span class="c1">/// its immediate operand is returned in NewImm.</span>
  <span class="kt">unsigned</span> <span class="n">loadImmediate</span><span class="p">(</span><span class="kt">int64_t</span> <span class="n">Imm</span><span class="p">,</span> <span class="n">MachineBasicBlock</span> <span class="o">&amp;</span><span class="n">MBB</span><span class="p">,</span>
                         <span class="n">MachineBasicBlock</span><span class="o">::</span><span class="n">iterator</span> <span class="n">II</span><span class="p">,</span> <span class="n">DebugLoc</span> <span class="n">DL</span><span class="p">,</span>
                         <span class="kt">unsigned</span> <span class="o">*</span><span class="n">NewImm</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_5/Cpu0SEInstrInfo.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">/// Adjust SP by Amount bytes.</span>
<span class="kt">void</span> <span class="n">Cpu0SEInstrInfo</span><span class="o">::</span><span class="n">adjustStackPtr</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">SP</span><span class="p">,</span> <span class="kt">int64_t</span> <span class="n">Amount</span><span class="p">,</span>
                                     <span class="n">MachineBasicBlock</span> <span class="o">&amp;</span><span class="n">MBB</span><span class="p">,</span>
                                     <span class="n">MachineBasicBlock</span><span class="o">::</span><span class="n">iterator</span> <span class="n">I</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="n">DebugLoc</span> <span class="n">DL</span> <span class="o">=</span> <span class="n">I</span> <span class="o">!=</span> <span class="n">MBB</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="o">?</span> <span class="n">I</span><span class="o">-&gt;</span><span class="n">getDebugLoc</span><span class="p">()</span> <span class="o">:</span> <span class="n">DebugLoc</span><span class="p">();</span>
  <span class="kt">unsigned</span> <span class="n">ADDu</span> <span class="o">=</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">ADDu</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="n">ADDiu</span> <span class="o">=</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">ADDiu</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">isInt</span><span class="o">&lt;</span><span class="mi">16</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Amount</span><span class="p">))</span><span class="c1">// addiu sp, sp, amount</span>
    <span class="n">BuildMI</span><span class="p">(</span><span class="n">MBB</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">get</span><span class="p">(</span><span class="n">ADDiu</span><span class="p">),</span> <span class="n">SP</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">SP</span><span class="p">).</span><span class="n">addImm</span><span class="p">(</span><span class="n">Amount</span><span class="p">);</span>
  <span class="k">else</span> <span class="p">{</span> <span class="c1">// Expand immediate that doesn&#39;t fit in 16-bit.</span>
    <span class="kt">unsigned</span> <span class="n">Reg</span> <span class="o">=</span> <span class="n">loadImmediate</span><span class="p">(</span><span class="n">Amount</span><span class="p">,</span> <span class="n">MBB</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">nullptr</span><span class="p">);</span>
    <span class="n">BuildMI</span><span class="p">(</span><span class="n">MBB</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">get</span><span class="p">(</span><span class="n">ADDu</span><span class="p">),</span> <span class="n">SP</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">SP</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">Reg</span><span class="p">,</span> <span class="n">RegState</span><span class="o">::</span><span class="n">Kill</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">/// This function generates the sequence of instructions needed to get the</span>
<span class="c1">/// result of adding register REG and immediate IMM.</span>
<span class="kt">unsigned</span>
<span class="n">Cpu0SEInstrInfo</span><span class="o">::</span><span class="n">loadImmediate</span><span class="p">(</span><span class="kt">int64_t</span> <span class="n">Imm</span><span class="p">,</span> <span class="n">MachineBasicBlock</span> <span class="o">&amp;</span><span class="n">MBB</span><span class="p">,</span>
                               <span class="n">MachineBasicBlock</span><span class="o">::</span><span class="n">iterator</span> <span class="n">II</span><span class="p">,</span> <span class="n">DebugLoc</span> <span class="n">DL</span><span class="p">,</span>
                               <span class="kt">unsigned</span> <span class="o">*</span><span class="n">NewImm</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="n">Cpu0AnalyzeImmediate</span> <span class="n">AnalyzeImm</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="n">Size</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="n">LUi</span> <span class="o">=</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">LUi</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="n">ZEROReg</span> <span class="o">=</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">ZERO</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="n">ATReg</span> <span class="o">=</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">AT</span><span class="p">;</span>
  <span class="kt">bool</span> <span class="n">LastInstrIsADDiu</span> <span class="o">=</span> <span class="n">NewImm</span><span class="p">;</span>

  <span class="k">const</span> <span class="n">Cpu0AnalyzeImmediate</span><span class="o">::</span><span class="n">InstSeq</span> <span class="o">&amp;</span><span class="n">Seq</span> <span class="o">=</span>
    <span class="n">AnalyzeImm</span><span class="p">.</span><span class="n">Analyze</span><span class="p">(</span><span class="n">Imm</span><span class="p">,</span> <span class="n">Size</span><span class="p">,</span> <span class="n">LastInstrIsADDiu</span><span class="p">);</span>
  <span class="n">Cpu0AnalyzeImmediate</span><span class="o">::</span><span class="n">InstSeq</span><span class="o">::</span><span class="n">const_iterator</span> <span class="n">Inst</span> <span class="o">=</span> <span class="n">Seq</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>

  <span class="n">assert</span><span class="p">(</span><span class="n">Seq</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">LastInstrIsADDiu</span> <span class="o">||</span> <span class="p">(</span><span class="n">Seq</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)));</span>

  <span class="c1">// The first instruction can be a LUi, which is different from other</span>
  <span class="c1">// instructions (ADDiu, ORI and SLL) in that it does not have a register</span>
  <span class="c1">// operand.</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Inst</span><span class="o">-&gt;</span><span class="n">Opc</span> <span class="o">==</span> <span class="n">LUi</span><span class="p">)</span>
    <span class="n">BuildMI</span><span class="p">(</span><span class="n">MBB</span><span class="p">,</span> <span class="n">II</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">get</span><span class="p">(</span><span class="n">LUi</span><span class="p">),</span> <span class="n">ATReg</span><span class="p">).</span><span class="n">addImm</span><span class="p">(</span><span class="n">SignExtend64</span><span class="o">&lt;</span><span class="mi">16</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Inst</span><span class="o">-&gt;</span><span class="n">ImmOpnd</span><span class="p">));</span>
  <span class="k">else</span>
    <span class="nf">BuildMI</span><span class="p">(</span><span class="n">MBB</span><span class="p">,</span> <span class="n">II</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">get</span><span class="p">(</span><span class="n">Inst</span><span class="o">-&gt;</span><span class="n">Opc</span><span class="p">),</span> <span class="n">ATReg</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">ZEROReg</span><span class="p">)</span>
      <span class="p">.</span><span class="n">addImm</span><span class="p">(</span><span class="n">SignExtend64</span><span class="o">&lt;</span><span class="mi">16</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Inst</span><span class="o">-&gt;</span><span class="n">ImmOpnd</span><span class="p">));</span>

  <span class="c1">// Build the remaining instructions in Seq.</span>
  <span class="k">for</span> <span class="p">(</span><span class="o">++</span><span class="n">Inst</span><span class="p">;</span> <span class="n">Inst</span> <span class="o">!=</span> <span class="n">Seq</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="o">-</span> <span class="n">LastInstrIsADDiu</span><span class="p">;</span> <span class="o">++</span><span class="n">Inst</span><span class="p">)</span>
    <span class="n">BuildMI</span><span class="p">(</span><span class="n">MBB</span><span class="p">,</span> <span class="n">II</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">get</span><span class="p">(</span><span class="n">Inst</span><span class="o">-&gt;</span><span class="n">Opc</span><span class="p">),</span> <span class="n">ATReg</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">ATReg</span><span class="p">)</span>
      <span class="p">.</span><span class="n">addImm</span><span class="p">(</span><span class="n">SignExtend64</span><span class="o">&lt;</span><span class="mi">16</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Inst</span><span class="o">-&gt;</span><span class="n">ImmOpnd</span><span class="p">));</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">LastInstrIsADDiu</span><span class="p">)</span>
    <span class="o">*</span><span class="n">NewImm</span> <span class="o">=</span> <span class="n">Inst</span><span class="o">-&gt;</span><span class="n">ImmOpnd</span><span class="p">;</span>

  <span class="k">return</span> <span class="n">ATReg</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In emitPrologue(), it emits machine instructions to adjust sp (stack pointer
register) for local variables.
For our example, it will emit the instruction,</p>
<div class="highlight-c++"><pre>addiu $sp, $sp, -8</pre>
</div>
<p>The emitEpilogue() will emit “addiu  $sp, $sp, 8”, where 8 is the stack size.</p>
<p>In above ch3.cpp assembly output, it generates &#8220;addiu $2, $zero, 0&#8221; rather than
&#8220;ori $2, $zero, 0&#8221; because ADDiu defined before ORi as following, so it takes the
priority. Of course, if the ORi is defined first, the it will translate into
&#8220;ori&#8221; instruction.</p>
<p class="rubric">lbdex/chapters/Chapter2/Cpu0InstrInfo.td</p>
<div class="highlight-c++"><pre>// Small immediates
def : Pat&lt;(i32 immSExt16:$in),
          (ADDiu ZERO, imm:$in)&gt;;
</pre>
</div>
<p class="rubric">lbdex/chapters/Chapter3_5/Cpu0InstrInfo.td</p>
<div class="highlight-c++"><pre>let Predicates = [Ch3_5] in {
def : Pat&lt;(i32 immZExt16:$in),
          (ORi ZERO, imm:$in)&gt;;
def : Pat&lt;(i32 immLow16Zero:$in),
          (LUi (HI16 imm:$in))&gt;;

// Arbitrary immediates
def : Pat&lt;(i32 imm:$imm),
          (ORi (LUi (HI16 imm:$imm)), (LO16 imm:$imm))&gt;;
} // let Predicates = [Ch3_4]
</pre>
</div>
</div>
<div class="section" id="handle-stack-slot-for-local-variables">
<h3><a class="toc-backref" href="#id11">Handle stack slot for local variables</a><a class="headerlink" href="#handle-stack-slot-for-local-variables" title="Permalink to this headline">¶</a></h3>
<p>The following code handle the stack slot for local variables.</p>
<p class="rubric">lbdex/chapters/Chapter3_5/Cpu0RegisterInfo.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">//- If no eliminateFrameIndex(), it will hang on run. </span>
<span class="c1">// pure virtual method</span>
<span class="c1">// FrameIndex represent objects inside a abstract stack.</span>
<span class="c1">// We must replace FrameIndex with an stack/frame pointer</span>
<span class="c1">// direct reference.</span>
<span class="kt">void</span> <span class="n">Cpu0RegisterInfo</span><span class="o">::</span>
<span class="n">eliminateFrameIndex</span><span class="p">(</span><span class="n">MachineBasicBlock</span><span class="o">::</span><span class="n">iterator</span> <span class="n">II</span><span class="p">,</span> <span class="kt">int</span> <span class="n">SPAdj</span><span class="p">,</span>
                    <span class="kt">unsigned</span> <span class="n">FIOperandNum</span><span class="p">,</span> <span class="n">RegScavenger</span> <span class="o">*</span><span class="n">RS</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="n">MachineInstr</span> <span class="o">&amp;</span><span class="n">MI</span> <span class="o">=</span> <span class="o">*</span><span class="n">II</span><span class="p">;</span>
  <span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">MF</span> <span class="o">=</span> <span class="o">*</span><span class="n">MI</span><span class="p">.</span><span class="n">getParent</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">();</span>
  <span class="n">MachineFrameInfo</span> <span class="o">*</span><span class="n">MFI</span> <span class="o">=</span> <span class="n">MF</span><span class="p">.</span><span class="n">getFrameInfo</span><span class="p">();</span>
  <span class="n">Cpu0FunctionInfo</span> <span class="o">*</span><span class="n">Cpu0FI</span> <span class="o">=</span> <span class="n">MF</span><span class="p">.</span><span class="n">getInfo</span><span class="o">&lt;</span><span class="n">Cpu0FunctionInfo</span><span class="o">&gt;</span><span class="p">();</span>

  <span class="kt">unsigned</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">MI</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="n">isFI</span><span class="p">())</span> <span class="p">{</span>
    <span class="o">++</span><span class="n">i</span><span class="p">;</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">MI</span><span class="p">.</span><span class="n">getNumOperands</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
           <span class="s">&quot;Instr doesn&#39;t have FrameIndex operand!&quot;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">DEBUG</span><span class="p">(</span><span class="n">errs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Function : &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">MF</span><span class="p">.</span><span class="n">getFunction</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getName</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
        <span class="n">errs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;&lt;---------&gt;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">MI</span><span class="p">);</span>

  <span class="kt">int</span> <span class="n">FrameIndex</span> <span class="o">=</span> <span class="n">MI</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="n">getIndex</span><span class="p">();</span>
  <span class="kt">uint64_t</span> <span class="n">stackSize</span> <span class="o">=</span> <span class="n">MF</span><span class="p">.</span><span class="n">getFrameInfo</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getStackSize</span><span class="p">();</span>
  <span class="kt">int64_t</span> <span class="n">spOffset</span> <span class="o">=</span> <span class="n">MF</span><span class="p">.</span><span class="n">getFrameInfo</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">getObjectOffset</span><span class="p">(</span><span class="n">FrameIndex</span><span class="p">);</span>

  <span class="n">DEBUG</span><span class="p">(</span><span class="n">errs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;FrameIndex : &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">FrameIndex</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
               <span class="o">&lt;&lt;</span> <span class="s">&quot;spOffset   : &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">spOffset</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
               <span class="o">&lt;&lt;</span> <span class="s">&quot;stackSize  : &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">stackSize</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

  <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">CalleeSavedInfo</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">CSI</span> <span class="o">=</span> <span class="n">MFI</span><span class="o">-&gt;</span><span class="n">getCalleeSavedInfo</span><span class="p">();</span>
  <span class="kt">int</span> <span class="n">MinCSFI</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">MaxCSFI</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">CSI</span><span class="p">.</span><span class="n">size</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">MinCSFI</span> <span class="o">=</span> <span class="n">CSI</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">getFrameIdx</span><span class="p">();</span>
    <span class="n">MaxCSFI</span> <span class="o">=</span> <span class="n">CSI</span><span class="p">[</span><span class="n">CSI</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">getFrameIdx</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="c1">// The following stack frame objects are always referenced relative to $sp:</span>
  <span class="c1">//  1. Outgoing arguments.</span>
  <span class="c1">//  2. Pointer to dynamically allocated stack space.</span>
  <span class="c1">//  3. Locations for callee-saved registers.</span>
  <span class="c1">// Everything else is referenced relative to whatever register</span>
  <span class="c1">// getFrameRegister() returns.</span>
  <span class="kt">unsigned</span> <span class="n">FrameReg</span><span class="p">;</span>

  <span class="n">FrameReg</span> <span class="o">=</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">SP</span><span class="p">;</span>

  <span class="c1">// Calculate final offset.</span>
  <span class="c1">// - There is no need to change the offset if the frame object is one of the</span>
  <span class="c1">//   following: an outgoing argument, pointer to a dynamically allocated</span>
  <span class="c1">//   stack space or a $gp restore location,</span>
  <span class="c1">// - If the frame object is any of the following, its offset must be adjusted</span>
  <span class="c1">//   by adding the size of the stack:</span>
  <span class="c1">//   incoming argument, callee-saved register location or local variable.</span>
  <span class="kt">int64_t</span> <span class="n">Offset</span><span class="p">;</span>
    <span class="n">Offset</span> <span class="o">=</span> <span class="n">spOffset</span> <span class="o">+</span> <span class="p">(</span><span class="kt">int64_t</span><span class="p">)</span><span class="n">stackSize</span><span class="p">;</span>

  <span class="n">Offset</span>    <span class="o">+=</span> <span class="n">MI</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">).</span><span class="n">getImm</span><span class="p">();</span>

  <span class="n">DEBUG</span><span class="p">(</span><span class="n">errs</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Offset     : &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">Offset</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;&lt;---------&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

  <span class="c1">// If MI is not a debug value, make sure Offset fits in the 16-bit immediate</span>
  <span class="c1">// field.</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">MI</span><span class="p">.</span><span class="n">isDebugValue</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">isInt</span><span class="o">&lt;</span><span class="mi">16</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Offset</span><span class="p">))</span> <span class="p">{</span>
	<span class="n">assert</span><span class="p">(</span><span class="s">&quot;(!MI.isDebugValue() &amp;&amp; !isInt&lt;16&gt;(Offset))&quot;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">MI</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="n">ChangeToRegister</span><span class="p">(</span><span class="n">FrameReg</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
  <span class="n">MI</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">).</span><span class="n">ChangeToImmediate</span><span class="p">(</span><span class="n">Offset</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The eliminateFrameIndex() of Cpu0RegisterInfo.cpp is called after stages
&#8220;instruction selection&#8221; and &#8220;registers allocated&#8221;.
It translates frame index to correct offset of stack pointer by
&#8220;spOffset = MF.getFrameInfo()-&gt;getObjectOffset(FrameIndex);&#8221;.</p>
<p class="rubric">lbdex/chapters/Chapter3_5/Cpu0SEFrameLowering.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">// This method is called immediately before PrologEpilogInserter scans the </span>
<span class="c1">//  physical registers used to determine what callee saved registers should be </span>
<span class="c1">//  spilled. This method is optional. </span>
<span class="kt">void</span> <span class="n">Cpu0SEFrameLowering</span><span class="o">::</span><span class="n">determineCalleeSaves</span><span class="p">(</span><span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">MF</span><span class="p">,</span>
                                               <span class="n">BitVector</span> <span class="o">&amp;</span><span class="n">SavedRegs</span><span class="p">,</span>
                                               <span class="n">RegScavenger</span> <span class="o">*</span><span class="n">RS</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
<span class="c1">//@determineCalleeSaves-body</span>
  <span class="n">TargetFrameLowering</span><span class="o">::</span><span class="n">determineCalleeSaves</span><span class="p">(</span><span class="n">MF</span><span class="p">,</span> <span class="n">SavedRegs</span><span class="p">,</span> <span class="n">RS</span><span class="p">);</span>
  <span class="n">Cpu0FunctionInfo</span> <span class="o">*</span><span class="n">Cpu0FI</span> <span class="o">=</span> <span class="n">MF</span><span class="p">.</span><span class="n">getInfo</span><span class="o">&lt;</span><span class="n">Cpu0FunctionInfo</span><span class="o">&gt;</span><span class="p">();</span>
  <span class="n">MachineRegisterInfo</span><span class="o">&amp;</span> <span class="n">MRI</span> <span class="o">=</span> <span class="n">MF</span><span class="p">.</span><span class="n">getRegInfo</span><span class="p">();</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">MF</span><span class="p">.</span><span class="n">getFrameInfo</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">hasCalls</span><span class="p">())</span>
    <span class="n">setAliasRegs</span><span class="p">(</span><span class="n">MF</span><span class="p">,</span> <span class="n">SavedRegs</span><span class="p">,</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">LR</span><span class="p">);</span>

  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The determineCalleeSaves() of Cpu0SEFrameLowering.cpp as above determine the
spill registers. Once the spill registers are determined, the function
eliminateFrameIndex() will save/restore registers to/from stack slots.</p>
</div>
<div class="section" id="large-stack">
<h3><a class="toc-backref" href="#id12">Large stack</a><a class="headerlink" href="#large-stack" title="Permalink to this headline">¶</a></h3>
<p>At this point, we have translated the very simple main() function with
&#8220;return 0;&#8221; single instruction.
The Cpu0AnalyzeImmediate.cpp and the Cpu0InstrInfo.td instructions defined in
Chapter3_5 as the following, which take care the 32 bits stack size adjustments.</p>
<p class="rubric">lbdex/chapters/Chapter3_5/CMakeLists.txt</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">add_llvm_target</span><span class="p">(</span>
  <span class="p">...</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="n">Cpu0AnalyzeImmediate</span><span class="p">.</span><span class="n">cpp</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="p">...</span>
<span class="p">)</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_5/Cpu0AnalyzeImmediate.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">//===-- Cpu0AnalyzeImmediate.h - Analyze Immediates ------------*- C++ -*--===//</span>
<span class="c1">//</span>
<span class="c1">//                     The LLVM Compiler Infrastructure</span>
<span class="c1">//</span>
<span class="c1">// This file is distributed under the University of Illinois Open Source</span>
<span class="c1">// License. See LICENSE.TXT for details.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="cp">#ifndef CPU0_ANALYZE_IMMEDIATE_H</span>
<span class="cp">#define CPU0_ANALYZE_IMMEDIATE_H</span>

<span class="cp">#include &quot;Cpu0Config.h&quot;</span>
<span class="cp">#if CH &gt;= CH3_5</span>

<span class="cp">#include &quot;llvm/ADT/SmallVector.h&quot;</span>
<span class="cp">#include &quot;llvm/Support/DataTypes.h&quot;</span>

<span class="k">namespace</span> <span class="n">llvm</span> <span class="p">{</span>

  <span class="k">class</span> <span class="nc">Cpu0AnalyzeImmediate</span> <span class="p">{</span>
  <span class="nl">public:</span>
    <span class="k">struct</span> <span class="n">Inst</span> <span class="p">{</span>
      <span class="kt">unsigned</span> <span class="n">Opc</span><span class="p">,</span> <span class="n">ImmOpnd</span><span class="p">;</span>
      <span class="n">Inst</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">Opc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">ImmOpnd</span><span class="p">);</span>
    <span class="p">};</span>
    <span class="k">typedef</span> <span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">Inst</span><span class="p">,</span> <span class="mi">7</span> <span class="o">&gt;</span> <span class="n">InstSeq</span><span class="p">;</span>

    <span class="c1">/// Analyze - Get an instruction sequence to load immediate Imm. The last</span>
    <span class="c1">/// instruction in the sequence must be an ADDiu if LastInstrIsADDiu is</span>
    <span class="c1">/// true;</span>
    <span class="k">const</span> <span class="n">InstSeq</span> <span class="o">&amp;</span><span class="n">Analyze</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">Imm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">Size</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">LastInstrIsADDiu</span><span class="p">);</span>
  <span class="nl">private:</span>
    <span class="k">typedef</span> <span class="n">SmallVector</span><span class="o">&lt;</span><span class="n">InstSeq</span><span class="p">,</span> <span class="mi">5</span><span class="o">&gt;</span> <span class="n">InstSeqLs</span><span class="p">;</span>

    <span class="c1">/// AddInstr - Add I to all instruction sequences in SeqLs.</span>
    <span class="kt">void</span> <span class="nf">AddInstr</span><span class="p">(</span><span class="n">InstSeqLs</span> <span class="o">&amp;</span><span class="n">SeqLs</span><span class="p">,</span> <span class="k">const</span> <span class="n">Inst</span> <span class="o">&amp;</span><span class="n">I</span><span class="p">);</span>

    <span class="c1">/// GetInstSeqLsADDiu - Get instruction sequences which end with an ADDiu to</span>
    <span class="c1">/// load immediate Imm</span>
    <span class="kt">void</span> <span class="nf">GetInstSeqLsADDiu</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">Imm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">RemSize</span><span class="p">,</span> <span class="n">InstSeqLs</span> <span class="o">&amp;</span><span class="n">SeqLs</span><span class="p">);</span>

    <span class="c1">/// GetInstSeqLsORi - Get instruction sequences which end with an ORi to</span>
    <span class="c1">/// load immediate Imm</span>
    <span class="kt">void</span> <span class="nf">GetInstSeqLsORi</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">Imm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">RemSize</span><span class="p">,</span> <span class="n">InstSeqLs</span> <span class="o">&amp;</span><span class="n">SeqLs</span><span class="p">);</span>

    <span class="c1">/// GetInstSeqLsSHL - Get instruction sequences which end with a SHL to</span>
    <span class="c1">/// load immediate Imm</span>
    <span class="kt">void</span> <span class="nf">GetInstSeqLsSHL</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">Imm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">RemSize</span><span class="p">,</span> <span class="n">InstSeqLs</span> <span class="o">&amp;</span><span class="n">SeqLs</span><span class="p">);</span>

    <span class="c1">/// GetInstSeqLs - Get instruction sequences to load immediate Imm.</span>
    <span class="kt">void</span> <span class="nf">GetInstSeqLs</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">Imm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">RemSize</span><span class="p">,</span> <span class="n">InstSeqLs</span> <span class="o">&amp;</span><span class="n">SeqLs</span><span class="p">);</span>

    <span class="c1">/// ReplaceADDiuSHLWithLUi - Replace an ADDiu &amp; SHL pair with a LUi.</span>
    <span class="kt">void</span> <span class="nf">ReplaceADDiuSHLWithLUi</span><span class="p">(</span><span class="n">InstSeq</span> <span class="o">&amp;</span><span class="n">Seq</span><span class="p">);</span>

    <span class="c1">/// GetShortestSeq - Find the shortest instruction sequence in SeqLs and</span>
    <span class="c1">/// return it in Insts.</span>
    <span class="kt">void</span> <span class="nf">GetShortestSeq</span><span class="p">(</span><span class="n">InstSeqLs</span> <span class="o">&amp;</span><span class="n">SeqLs</span><span class="p">,</span> <span class="n">InstSeq</span> <span class="o">&amp;</span><span class="n">Insts</span><span class="p">);</span>

    <span class="kt">unsigned</span> <span class="n">Size</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="n">ADDiu</span><span class="p">,</span> <span class="n">ORi</span><span class="p">,</span> <span class="n">SHL</span><span class="p">,</span> <span class="n">LUi</span><span class="p">;</span>
    <span class="n">InstSeq</span> <span class="n">Insts</span><span class="p">;</span>
  <span class="p">};</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="c1">// #if CH &gt;= CH3_5</span>

<span class="cp">#endif</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_5/Cpu0AnalyzeImmediate.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">//===-- Cpu0AnalyzeImmediate.cpp - Analyze Immediates ---------------------===//</span>
<span class="c1">//</span>
<span class="c1">//                     The LLVM Compiler Infrastructure</span>
<span class="c1">//</span>
<span class="c1">// This file is distributed under the University of Illinois Open Source</span>
<span class="c1">// License. See LICENSE.TXT for details.</span>
<span class="c1">//</span>
<span class="c1">//===----------------------------------------------------------------------===//</span>
<span class="cp">#include &quot;Cpu0AnalyzeImmediate.h&quot;</span>
<span class="cp">#include &quot;Cpu0.h&quot;</span>
<span class="cp">#if CH &gt;= CH3_5</span>

<span class="cp">#include &quot;llvm/Support/MathExtras.h&quot;</span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">llvm</span><span class="p">;</span>

<span class="n">Cpu0AnalyzeImmediate</span><span class="o">::</span><span class="n">Inst</span><span class="o">::</span><span class="n">Inst</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">O</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">I</span><span class="p">)</span> <span class="o">:</span> <span class="n">Opc</span><span class="p">(</span><span class="n">O</span><span class="p">),</span> <span class="n">ImmOpnd</span><span class="p">(</span><span class="n">I</span><span class="p">)</span> <span class="p">{}</span>

<span class="c1">// Add I to the instruction sequences.</span>
<span class="kt">void</span> <span class="n">Cpu0AnalyzeImmediate</span><span class="o">::</span><span class="n">AddInstr</span><span class="p">(</span><span class="n">InstSeqLs</span> <span class="o">&amp;</span><span class="n">SeqLs</span><span class="p">,</span> <span class="k">const</span> <span class="n">Inst</span> <span class="o">&amp;</span><span class="n">I</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Add an instruction seqeunce consisting of just I.</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">SeqLs</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">SeqLs</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">InstSeq</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">I</span><span class="p">));</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">for</span> <span class="p">(</span><span class="n">InstSeqLs</span><span class="o">::</span><span class="n">iterator</span> <span class="n">Iter</span> <span class="o">=</span> <span class="n">SeqLs</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span> <span class="n">Iter</span> <span class="o">!=</span> <span class="n">SeqLs</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="o">++</span><span class="n">Iter</span><span class="p">)</span>
    <span class="n">Iter</span><span class="o">-&gt;</span><span class="n">push_back</span><span class="p">(</span><span class="n">I</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Cpu0AnalyzeImmediate</span><span class="o">::</span><span class="n">GetInstSeqLsADDiu</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">Imm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">RemSize</span><span class="p">,</span>
                                             <span class="n">InstSeqLs</span> <span class="o">&amp;</span><span class="n">SeqLs</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">GetInstSeqLs</span><span class="p">((</span><span class="n">Imm</span> <span class="o">+</span> <span class="mh">0x8000ULL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffffffff0000ULL</span><span class="p">,</span> <span class="n">RemSize</span><span class="p">,</span> <span class="n">SeqLs</span><span class="p">);</span>
  <span class="n">AddInstr</span><span class="p">(</span><span class="n">SeqLs</span><span class="p">,</span> <span class="n">Inst</span><span class="p">(</span><span class="n">ADDiu</span><span class="p">,</span> <span class="n">Imm</span> <span class="o">&amp;</span> <span class="mh">0xffffULL</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Cpu0AnalyzeImmediate</span><span class="o">::</span><span class="n">GetInstSeqLsORi</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">Imm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">RemSize</span><span class="p">,</span>
                                           <span class="n">InstSeqLs</span> <span class="o">&amp;</span><span class="n">SeqLs</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">GetInstSeqLs</span><span class="p">(</span><span class="n">Imm</span> <span class="o">&amp;</span> <span class="mh">0xffffffffffff0000ULL</span><span class="p">,</span> <span class="n">RemSize</span><span class="p">,</span> <span class="n">SeqLs</span><span class="p">);</span>
  <span class="n">AddInstr</span><span class="p">(</span><span class="n">SeqLs</span><span class="p">,</span> <span class="n">Inst</span><span class="p">(</span><span class="n">ORi</span><span class="p">,</span> <span class="n">Imm</span> <span class="o">&amp;</span> <span class="mh">0xffffULL</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Cpu0AnalyzeImmediate</span><span class="o">::</span><span class="n">GetInstSeqLsSHL</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">Imm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">RemSize</span><span class="p">,</span>
                                           <span class="n">InstSeqLs</span> <span class="o">&amp;</span><span class="n">SeqLs</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">unsigned</span> <span class="n">Shamt</span> <span class="o">=</span> <span class="n">countTrailingZeros</span><span class="p">(</span><span class="n">Imm</span><span class="p">);</span>
  <span class="n">GetInstSeqLs</span><span class="p">(</span><span class="n">Imm</span> <span class="o">&gt;&gt;</span> <span class="n">Shamt</span><span class="p">,</span> <span class="n">RemSize</span> <span class="o">-</span> <span class="n">Shamt</span><span class="p">,</span> <span class="n">SeqLs</span><span class="p">);</span>
  <span class="n">AddInstr</span><span class="p">(</span><span class="n">SeqLs</span><span class="p">,</span> <span class="n">Inst</span><span class="p">(</span><span class="n">SHL</span><span class="p">,</span> <span class="n">Shamt</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Cpu0AnalyzeImmediate</span><span class="o">::</span><span class="n">GetInstSeqLs</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">Imm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">RemSize</span><span class="p">,</span>
                                        <span class="n">InstSeqLs</span> <span class="o">&amp;</span><span class="n">SeqLs</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">uint64_t</span> <span class="n">MaskedImm</span> <span class="o">=</span> <span class="n">Imm</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mh">0xffffffffffffffffULL</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">64</span> <span class="o">-</span> <span class="n">Size</span><span class="p">));</span>

  <span class="c1">// Do nothing if Imm is 0.</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">MaskedImm</span><span class="p">)</span>
    <span class="k">return</span><span class="p">;</span>

  <span class="c1">// A single ADDiu will do if RemSize &lt;= 16.</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">RemSize</span> <span class="o">&lt;=</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">AddInstr</span><span class="p">(</span><span class="n">SeqLs</span><span class="p">,</span> <span class="n">Inst</span><span class="p">(</span><span class="n">ADDiu</span><span class="p">,</span> <span class="n">MaskedImm</span><span class="p">));</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// Shift if the lower 16-bit is cleared.</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">Imm</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">GetInstSeqLsSHL</span><span class="p">(</span><span class="n">Imm</span><span class="p">,</span> <span class="n">RemSize</span><span class="p">,</span> <span class="n">SeqLs</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">GetInstSeqLsADDiu</span><span class="p">(</span><span class="n">Imm</span><span class="p">,</span> <span class="n">RemSize</span><span class="p">,</span> <span class="n">SeqLs</span><span class="p">);</span>

  <span class="c1">// If bit 15 is cleared, it doesn&#39;t make a difference whether the last</span>
  <span class="c1">// instruction is an ADDiu or ORi. In that case, do not call GetInstSeqLsORi.</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Imm</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">InstSeqLs</span> <span class="n">SeqLsORi</span><span class="p">;</span>
    <span class="n">GetInstSeqLsORi</span><span class="p">(</span><span class="n">Imm</span><span class="p">,</span> <span class="n">RemSize</span><span class="p">,</span> <span class="n">SeqLsORi</span><span class="p">);</span>
    <span class="n">SeqLs</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">SeqLs</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">SeqLsORi</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">SeqLsORi</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Replace a ADDiu &amp; SHL pair with a LUi.</span>
<span class="c1">// e.g. the following two instructions</span>
<span class="c1">//  ADDiu 0x0111</span>
<span class="c1">//  SHL 18</span>
<span class="c1">// are replaced with</span>
<span class="c1">//  LUi 0x444</span>
<span class="kt">void</span> <span class="n">Cpu0AnalyzeImmediate</span><span class="o">::</span><span class="n">ReplaceADDiuSHLWithLUi</span><span class="p">(</span><span class="n">InstSeq</span> <span class="o">&amp;</span><span class="n">Seq</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Check if the first two instructions are ADDiu and SHL and the shift amount</span>
  <span class="c1">// is at least 16.</span>
  <span class="k">if</span> <span class="p">((</span><span class="n">Seq</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">Seq</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">Opc</span> <span class="o">!=</span> <span class="n">ADDiu</span><span class="p">)</span> <span class="o">||</span>
      <span class="p">(</span><span class="n">Seq</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">Opc</span> <span class="o">!=</span> <span class="n">SHL</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">Seq</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">ImmOpnd</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">))</span>
    <span class="k">return</span><span class="p">;</span>

  <span class="c1">// Sign-extend and shift operand of ADDiu and see if it still fits in 16-bit.</span>
  <span class="kt">int64_t</span> <span class="n">Imm</span> <span class="o">=</span> <span class="n">SignExtend64</span><span class="o">&lt;</span><span class="mi">16</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Seq</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ImmOpnd</span><span class="p">);</span>
  <span class="kt">int64_t</span> <span class="n">ShiftedImm</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">Imm</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">Seq</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">ImmOpnd</span> <span class="o">-</span> <span class="mi">16</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isInt</span><span class="o">&lt;</span><span class="mi">16</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ShiftedImm</span><span class="p">))</span>
    <span class="k">return</span><span class="p">;</span>

  <span class="c1">// Replace the first instruction and erase the second.</span>
  <span class="n">Seq</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">Opc</span> <span class="o">=</span> <span class="n">LUi</span><span class="p">;</span>
  <span class="n">Seq</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ImmOpnd</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)(</span><span class="n">ShiftedImm</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
  <span class="n">Seq</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">Seq</span><span class="p">.</span><span class="n">begin</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Cpu0AnalyzeImmediate</span><span class="o">::</span><span class="n">GetShortestSeq</span><span class="p">(</span><span class="n">InstSeqLs</span> <span class="o">&amp;</span><span class="n">SeqLs</span><span class="p">,</span> <span class="n">InstSeq</span> <span class="o">&amp;</span><span class="n">Insts</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">InstSeqLs</span><span class="o">::</span><span class="n">iterator</span> <span class="n">ShortestSeq</span> <span class="o">=</span> <span class="n">SeqLs</span><span class="p">.</span><span class="n">end</span><span class="p">();</span>
  <span class="c1">// The length of an instruction sequence is at most 7.</span>
  <span class="kt">unsigned</span> <span class="n">ShortestLength</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>

  <span class="k">for</span> <span class="p">(</span><span class="n">InstSeqLs</span><span class="o">::</span><span class="n">iterator</span> <span class="n">S</span> <span class="o">=</span> <span class="n">SeqLs</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span> <span class="n">S</span> <span class="o">!=</span> <span class="n">SeqLs</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="o">++</span><span class="n">S</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ReplaceADDiuSHLWithLUi</span><span class="p">(</span><span class="o">*</span><span class="n">S</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">S</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mi">7</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">S</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">ShortestLength</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">ShortestSeq</span> <span class="o">=</span> <span class="n">S</span><span class="p">;</span>
      <span class="n">ShortestLength</span> <span class="o">=</span> <span class="n">S</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="n">Insts</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
  <span class="n">Insts</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">ShortestSeq</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">(),</span> <span class="n">ShortestSeq</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">());</span>
<span class="p">}</span>

<span class="k">const</span> <span class="n">Cpu0AnalyzeImmediate</span><span class="o">::</span><span class="n">InstSeq</span>
<span class="o">&amp;</span><span class="n">Cpu0AnalyzeImmediate</span><span class="o">::</span><span class="n">Analyze</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">Imm</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">Size</span><span class="p">,</span>
                               <span class="kt">bool</span> <span class="n">LastInstrIsADDiu</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="o">-&gt;</span><span class="n">Size</span> <span class="o">=</span> <span class="n">Size</span><span class="p">;</span>

  <span class="n">ADDiu</span> <span class="o">=</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">ADDiu</span><span class="p">;</span>
  <span class="n">ORi</span> <span class="o">=</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">ORi</span><span class="p">;</span>
  <span class="n">SHL</span> <span class="o">=</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">SHL</span><span class="p">;</span>
  <span class="n">LUi</span> <span class="o">=</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">LUi</span><span class="p">;</span>

  <span class="n">InstSeqLs</span> <span class="n">SeqLs</span><span class="p">;</span>

  <span class="c1">// Get the list of instruction sequences.</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">LastInstrIsADDiu</span> <span class="o">|</span> <span class="o">!</span><span class="n">Imm</span><span class="p">)</span>
    <span class="n">GetInstSeqLsADDiu</span><span class="p">(</span><span class="n">Imm</span><span class="p">,</span> <span class="n">Size</span><span class="p">,</span> <span class="n">SeqLs</span><span class="p">);</span>
  <span class="k">else</span>
    <span class="nf">GetInstSeqLs</span><span class="p">(</span><span class="n">Imm</span><span class="p">,</span> <span class="n">Size</span><span class="p">,</span> <span class="n">SeqLs</span><span class="p">);</span>

  <span class="c1">// Set Insts to the shortest instruction sequence.</span>
  <span class="n">GetShortestSeq</span><span class="p">(</span><span class="n">SeqLs</span><span class="p">,</span> <span class="n">Insts</span><span class="p">);</span>

  <span class="k">return</span> <span class="n">Insts</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_5/Cpu0InstrInfo.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="cp">#include &quot;Cpu0AnalyzeImmediate.h&quot;</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_5/Cpu0InstrInfo.td</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Cpu0InstAlias</span><span class="o">&lt;</span><span class="n">string</span> <span class="n">Asm</span><span class="p">,</span> <span class="n">dag</span> <span class="n">Result</span><span class="p">,</span> <span class="n">bit</span> <span class="n">Emit</span> <span class="o">=</span> <span class="mi">0</span><span class="n">b1</span><span class="o">&gt;</span> <span class="o">:</span>
  <span class="n">InstAlias</span><span class="o">&lt;</span><span class="n">Asm</span><span class="p">,</span> <span class="n">Result</span><span class="p">,</span> <span class="n">Emit</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">def</span> <span class="n">shamt</span>       <span class="o">:</span> <span class="n">Operand</span><span class="o">&lt;</span><span class="n">i32</span><span class="o">&gt;</span><span class="p">;</span>

<span class="c1">// Unsigned Operand</span>
<span class="n">def</span> <span class="n">uimm16</span>      <span class="o">:</span> <span class="n">Operand</span><span class="o">&lt;</span><span class="n">i32</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="n">let</span> <span class="n">PrintMethod</span> <span class="o">=</span> <span class="s">&quot;printUnsignedImm&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">// Transformation Function - get the lower 16 bits.</span>
<span class="n">def</span> <span class="n">LO16</span> <span class="o">:</span> <span class="n">SDNodeXForm</span><span class="o">&lt;</span><span class="n">imm</span><span class="p">,</span> <span class="p">[{</span>
  <span class="k">return</span> <span class="n">getImm</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="o">-&gt;</span><span class="n">getZExtValue</span><span class="p">()</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
<span class="p">}]</span><span class="o">&gt;</span><span class="p">;</span>

<span class="c1">// Transformation Function - get the higher 16 bits.</span>
<span class="n">def</span> <span class="n">HI16</span> <span class="o">:</span> <span class="n">SDNodeXForm</span><span class="o">&lt;</span><span class="n">imm</span><span class="p">,</span> <span class="p">[{</span>
  <span class="k">return</span> <span class="n">getImm</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="p">(</span><span class="n">N</span><span class="o">-&gt;</span><span class="n">getZExtValue</span><span class="p">()</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
<span class="p">}]</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">// Node immediate fits as 16-bit zero extended on target immediate.</span>
<span class="c1">// The LO16 param means that only the lower 16 bits of the node</span>
<span class="c1">// immediate are caught.</span>
<span class="c1">// e.g. addiu, sltiu</span>
<span class="n">def</span> <span class="n">immZExt16</span>  <span class="o">:</span> <span class="n">PatLeaf</span><span class="o">&lt;</span><span class="p">(</span><span class="n">imm</span><span class="p">),</span> <span class="p">[{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">N</span><span class="o">-&gt;</span><span class="n">getValueType</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">MVT</span><span class="o">::</span><span class="n">i32</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">N</span><span class="o">-&gt;</span><span class="n">getZExtValue</span><span class="p">()</span> <span class="o">==</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">N</span><span class="o">-&gt;</span><span class="n">getZExtValue</span><span class="p">();</span>
  <span class="k">else</span>
    <span class="nf">return</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">N</span><span class="o">-&gt;</span><span class="n">getZExtValue</span><span class="p">()</span> <span class="o">==</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">N</span><span class="o">-&gt;</span><span class="n">getZExtValue</span><span class="p">();</span>
<span class="p">}],</span> <span class="n">LO16</span><span class="o">&gt;</span><span class="p">;</span>

<span class="c1">// Immediate can be loaded with LUi (32-bit int with lower 16-bit cleared).</span>
<span class="n">def</span> <span class="n">immLow16Zero</span> <span class="o">:</span> <span class="n">PatLeaf</span><span class="o">&lt;</span><span class="p">(</span><span class="n">imm</span><span class="p">),</span> <span class="p">[{</span>
  <span class="kt">int64_t</span> <span class="n">Val</span> <span class="o">=</span> <span class="n">N</span><span class="o">-&gt;</span><span class="n">getSExtValue</span><span class="p">();</span>
  <span class="k">return</span> <span class="n">isInt</span><span class="o">&lt;</span><span class="mi">32</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Val</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">Val</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
<span class="p">}]</span><span class="o">&gt;</span><span class="p">;</span>

<span class="c1">// shamt field must fit in 5 bits.</span>
<span class="n">def</span> <span class="n">immZExt5</span> <span class="o">:</span> <span class="n">ImmLeaf</span><span class="o">&lt;</span><span class="n">i32</span><span class="p">,</span> <span class="p">[{</span><span class="k">return</span> <span class="n">Imm</span> <span class="o">==</span> <span class="p">(</span><span class="n">Imm</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">);}]</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-c++"><pre>let Predicates = [Ch3_5] in {
// Arithmetic and logical instructions with 3 register operands.
class ArithLogicR&lt;bits&lt;8&gt; op, string instr_asm, SDNode OpNode,
                  InstrItinClass itin, RegisterClass RC, bit isComm = 0&gt;:
  FA&lt;op, (outs GPROut:$ra), (ins RC:$rb, RC:$rc),
     !strconcat(instr_asm, "\t$ra, $rb, $rc"),
     [(set GPROut:$ra, (OpNode RC:$rb, RC:$rc))], itin&gt; {
  let shamt = 0;
  let isCommutable = isComm;	// e.g. add rb rc =  add rc rb
  let isReMaterializable = 1;
}
}
</pre>
</div>
<div class="highlight-c++"><pre>let Predicates = [Ch3_5] in {
// Shifts
class shift_rotate_imm&lt;bits&lt;8&gt; op, bits&lt;4&gt; isRotate, string instr_asm,
                       SDNode OpNode, PatFrag PF, Operand ImmOpnd,
                       RegisterClass RC&gt;:
  FA&lt;op, (outs GPROut:$ra), (ins RC:$rb, ImmOpnd:$shamt),
     !strconcat(instr_asm, "\t$ra, $rb, $shamt"),
     [(set GPROut:$ra, (OpNode RC:$rb, PF:$shamt))], IIAlu&gt; {
  let rc = 0;
  let shamt = shamt;
}

// 32-bit shift instructions.
class shift_rotate_imm32&lt;bits&lt;8&gt; op, bits&lt;4&gt; isRotate, string instr_asm,
                         SDNode OpNode&gt;:
  shift_rotate_imm&lt;op, isRotate, instr_asm, OpNode, immZExt5, shamt, CPURegs&gt;;
}
</pre>
</div>
<div class="highlight-c++"><pre>let Predicates = [Ch3_5] in {
// Load Upper Imediate
class LoadUpper&lt;bits&lt;8&gt; op, string instr_asm, RegisterClass RC, Operand Imm&gt;:
  FL&lt;op, (outs RC:$ra), (ins Imm:$imm16),
     !strconcat(instr_asm, "\t$ra, $imm16"), [], IIAlu&gt; {
  let rb = 0;
  let isReMaterializable = 1;
}
}
</pre>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">let</span> <span class="n">Predicates</span> <span class="o">=</span> <span class="p">[</span><span class="n">Ch3_5</span><span class="p">]</span> <span class="n">in</span> <span class="p">{</span>
<span class="n">def</span> <span class="n">ORi</span>     <span class="o">:</span> <span class="n">ArithLogicI</span><span class="o">&lt;</span><span class="mh">0x0d</span><span class="p">,</span> <span class="s">&quot;ori&quot;</span><span class="p">,</span> <span class="n">or</span><span class="p">,</span> <span class="n">uimm16</span><span class="p">,</span> <span class="n">immZExt16</span><span class="p">,</span> <span class="n">CPURegs</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">let</span> <span class="n">Predicates</span> <span class="o">=</span> <span class="p">[</span><span class="n">Ch3_5</span><span class="p">]</span> <span class="n">in</span> <span class="p">{</span>
<span class="n">def</span> <span class="n">LUi</span>     <span class="o">:</span> <span class="n">LoadUpper</span><span class="o">&lt;</span><span class="mh">0x0f</span><span class="p">,</span> <span class="s">&quot;lui&quot;</span><span class="p">,</span> <span class="n">GPROut</span><span class="p">,</span> <span class="n">uimm16</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">let</span> <span class="n">Predicates</span> <span class="o">=</span> <span class="p">[</span><span class="n">Ch3_5</span><span class="p">]</span> <span class="n">in</span> <span class="p">{</span>
<span class="n">let</span> <span class="n">Predicates</span> <span class="o">=</span> <span class="p">[</span><span class="n">DisableOverflow</span><span class="p">]</span> <span class="n">in</span> <span class="p">{</span>
<span class="n">def</span> <span class="n">ADDu</span>    <span class="o">:</span> <span class="n">ArithLogicR</span><span class="o">&lt;</span><span class="mh">0x11</span><span class="p">,</span> <span class="s">&quot;addu&quot;</span><span class="p">,</span> <span class="n">add</span><span class="p">,</span> <span class="n">IIAlu</span><span class="p">,</span> <span class="n">CPURegs</span><span class="p">,</span> <span class="mi">1</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">let</span> <span class="n">Predicates</span> <span class="o">=</span> <span class="p">[</span><span class="n">Ch3_5</span><span class="p">]</span> <span class="n">in</span> <span class="p">{</span>
<span class="n">def</span> <span class="n">SHL</span>     <span class="o">:</span> <span class="n">shift_rotate_imm32</span><span class="o">&lt;</span><span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="s">&quot;shl&quot;</span><span class="p">,</span> <span class="n">shl</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-c++"><pre>let Predicates = [Ch3_5] in {
//===----------------------------------------------------------------------===//
// Instruction aliases
//===----------------------------------------------------------------------===//
def : Cpu0InstAlias&lt;"move $dst, $src",
                    (ADDu GPROut:$dst, GPROut:$src,ZERO), 1&gt;;
}
</pre>
</div>
<div class="highlight-c++"><pre>let Predicates = [Ch3_5] in {
def : Pat&lt;(i32 immZExt16:$in),
          (ORi ZERO, imm:$in)&gt;;
def : Pat&lt;(i32 immLow16Zero:$in),
          (LUi (HI16 imm:$in))&gt;;

// Arbitrary immediates
def : Pat&lt;(i32 imm:$imm),
          (ORi (LUi (HI16 imm:$imm)), (LO16 imm:$imm))&gt;;
} // let Predicates = [Ch3_4]
</pre>
</div>
<p>The Cpu0AnalyzeImmediate.cpp written in recursive with a little complicate in
logic. However, the recursive
skills is used in the front end compile book, you should fimiliar with it.
Instead of tracking the code, listing the stack size and the instructions
generated in &#8220;Table: Cpu0 stack adjustment instructions before replace addiu and
shl with lui instruction&#8221; as follows and &#8220;Table: Cpu0 stack adjustment
instructions after replace addiu and shl with lui instruction&#8221; at next,</p>
<table border="1" class="docutils">
<caption>Cpu0 stack adjustment instructions before replace addiu and shl with lui instruction</caption>
<colgroup>
<col width="19%" />
<col width="15%" />
<col width="33%" />
<col width="33%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">stack size range</th>
<th class="head">ex. stack size</th>
<th class="head">Cpu0 Prologue instructions</th>
<th class="head">Cpu0 Epilogue instructions</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>0 ~ 0x7ff8</td>
<td><ul class="first last simple">
<li>0x7ff8</li>
</ul>
</td>
<td><ul class="first last simple">
<li>addiu $sp, $sp, -32760;</li>
</ul>
</td>
<td><ul class="first last simple">
<li>addiu $sp, $sp, 32760;</li>
</ul>
</td>
</tr>
<tr class="row-odd"><td>0x8000 ~ 0xfff8</td>
<td><ul class="first last simple">
<li>0x8000</li>
</ul>
</td>
<td><ul class="first last simple">
<li>addiu $sp, $sp, -32768;</li>
</ul>
</td>
<td><ul class="first last simple">
<li>addiu $1, $zero, 1;</li>
<li>shl $1, $1, 16;</li>
<li>addiu $1, $1, -32768;</li>
<li>addu $sp, $sp, $1;</li>
</ul>
</td>
</tr>
<tr class="row-even"><td>x10000 ~ 0xfffffff8</td>
<td><ul class="first last simple">
<li>0x7ffffff8</li>
</ul>
</td>
<td><ul class="first last simple">
<li>addiu $1, $zero, 8;</li>
<li>shl $1, $1, 28;</li>
<li>addiu $1, $1, 8;</li>
<li>addu $sp, $sp, $1;</li>
</ul>
</td>
<td><ul class="first last simple">
<li>addiu $1, $zero, 8;</li>
<li>shl $1, $1, 28;</li>
<li>addiu $1, $1, -8;</li>
<li>addu $sp, $sp, $1;</li>
</ul>
</td>
</tr>
<tr class="row-odd"><td>x10000 ~ 0xfffffff8</td>
<td><ul class="first last simple">
<li>0x90008000</li>
</ul>
</td>
<td><ul class="first last simple">
<li>addiu $1, $zero, -9;</li>
<li>shl $1, $1, 28;</li>
<li>addiu $1, $1, -32768;</li>
<li>addu $sp, $sp, $1;</li>
</ul>
</td>
<td><ul class="first last simple">
<li>addiu $1, $zero, -28671;</li>
<li>shl $1, $1, 16</li>
<li>addiu $1, $1, -32768;</li>
<li>addu $sp, $sp, $1;</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>Since the Cpu0 stack is 8 bytes alignment, the 0x7ff9 to 0x7fff is impossible
existing.</p>
<p>Assume sp = 0xa0008000 and stack size = 0x90008000, then (0xa0008000 -
0x90008000) =&gt; 0x10000000. Verify with the Cpu0 Prologue instructions as
follows,</p>
<ol class="arabic simple">
<li>&#8220;addiu       $1, $zero, -9&#8221; =&gt; ($1 = 0 + 0xfffffff7) =&gt; $1 = 0xfffffff7.</li>
<li>&#8220;shl $1, $1, 28;&#8221; =&gt; $1 = 0x70000000.</li>
<li>&#8220;addiu       $1, $1, -32768&#8221; =&gt; $1 = (0x70000000 + 0xffff8000) =&gt; $1 = 0x6fff8000.</li>
<li>&#8220;addu        $sp, $sp, $1&#8221; =&gt; $sp = (0xa0008000 + 0x6fff8000) =&gt; $sp = 0x10000000.</li>
</ol>
<p>Verify with the Cpu0 Epilogue instructions with sp = 0x10000000 and stack size =
0x90008000 as follows,</p>
<ol class="arabic simple">
<li>&#8220;addiu       $1, $zero, -28671&#8221; =&gt; ($1 = 0 + 0xffff9001) =&gt; $1 = 0xffff9001.</li>
<li>&#8220;shl $1, $1, 16;&#8221; =&gt; $1 = 0x90010000.</li>
<li>&#8220;addiu       $1, $1, -32768&#8221; =&gt; $1 = (0x90010000 + 0xffff8000) =&gt; $1 = 0x90008000.</li>
<li>&#8220;addu        $sp, $sp, $1&#8221; =&gt; $sp = (0x10000000 + 0x90008000) =&gt; $sp = 0xa0008000.</li>
</ol>
<p>The Cpu0AnalyzeImmediate::GetShortestSeq() will call Cpu0AnalyzeImmediate::
ReplaceADDiuSHLWithLUi() to replace addiu and shl with single instruction lui
only. The effect as the following table.</p>
<table border="1" class="docutils">
<caption>Cpu0 stack adjustment instructions after replace addiu and shl with lui instruction</caption>
<colgroup>
<col width="19%" />
<col width="15%" />
<col width="33%" />
<col width="33%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">stack size range</th>
<th class="head">ex. stack size</th>
<th class="head">Cpu0 Prologue instructions</th>
<th class="head">Cpu0 Epilogue instructions</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>0x8000 ~ 0xfff8</td>
<td><ul class="first last simple">
<li>0x8000</li>
</ul>
</td>
<td><ul class="first last simple">
<li>addiu $sp, $sp, -32768;</li>
</ul>
</td>
<td><ul class="first last simple">
<li>ori     $1, $zero, 32768;</li>
<li>addu $sp, $sp, $1;</li>
</ul>
</td>
</tr>
<tr class="row-odd"><td>x10000 ~ 0xfffffff8</td>
<td><ul class="first last simple">
<li>0x7ffffff8</li>
</ul>
</td>
<td><ul class="first last simple">
<li>lui $1, 32768;</li>
<li>addiu $1, $1, 8;</li>
<li>addu $sp, $sp, $1;</li>
</ul>
</td>
<td><ul class="first last simple">
<li>lui     $1, 32767;</li>
<li>ori     $1, $1, 65528</li>
<li>addu $sp, $sp, $1;</li>
</ul>
</td>
</tr>
<tr class="row-even"><td>x10000 ~ 0xfffffff8</td>
<td><ul class="first last simple">
<li>0x90008000</li>
</ul>
</td>
<td><ul class="first last simple">
<li>lui $1, 28671;</li>
<li>ori $1, $1, 32768;</li>
<li>addu $sp, $sp, $1;</li>
</ul>
</td>
<td><ul class="first last simple">
<li>lui $1, 36865;</li>
<li>addiu $1, $1, -32768;</li>
<li>addu $sp, $sp, $1;</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>Assume sp = 0xa0008000 and stack size = 0x90008000, then (0xa0008000 -
0x90008000) =&gt; 0x10000000. Verify with the Cpu0 Prologue instructions as
follows,</p>
<ol class="arabic simple">
<li>&#8220;lui $1, 28671&#8221; =&gt; $1 = 0x6fff0000.</li>
<li>&#8220;ori $1, $1, 32768&#8221; =&gt; $1 = (0x6fff0000 + 0x00008000) =&gt; $1 = 0x6fff8000.</li>
<li>&#8220;addu        $sp, $sp, $1&#8221; =&gt; $sp = (0xa0008000 + 0x6fff8000) =&gt; $sp = 0x10000000.</li>
</ol>
<p>Verify with the Cpu0 Epilogue instructions with sp = 0x10000000 and stack size =
0x90008000 as follows,</p>
<ol class="arabic simple">
<li>&#8220;lui $1, 36865&#8221; =&gt; $1 = 0x90010000.</li>
<li>&#8220;addiu $1, $1, -32768&#8221; =&gt; $1 = (0x90010000 + 0xffff8000) =&gt; $1 = 0x90008000.</li>
<li>&#8220;addu $sp, $sp, $1&#8221; =&gt; $sp = (0x10000000 + 0x90008000) =&gt; $sp = 0xa0008000.</li>
</ol>
<p>File ch3_largeframe.cpp include the large frame test.</p>
<p>Run Chapter3_5 with ch3_largeframe.cpp will get the following result.</p>
<p class="rubric">lbdex/input/ch3_largeframe.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="kt">int</span> <span class="nf">test_largegframe</span><span class="p">()</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">a</span><span class="p">[</span><span class="mi">469753856</span><span class="p">];</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-bash"><div class="highlight"><pre>118-165-78-12:input Jonathan<span class="nv">$ </span>clang -target mips-unknown-linux-gnu -c
ch3_largeframe.cpp -emit-llvm -o ch3_largeframe.bc
118-165-78-12:input Jonathan<span class="nv">$ </span>/Users/Jonathan/llvm/test/cmake_debug_build/
Debug/bin/llc -march<span class="o">=</span>cpu0 -relocation-model<span class="o">=</span>pic -filetype<span class="o">=</span>asm
ch3_largeframe.bc.bc -o -
  ...
  .section .mdebug.abiO32
  .previous
  .file <span class="s2">&quot;ch3_largeframe.bc&quot;</span>
  .globl  _Z16test_largegframev
  .align  2
  .type _Z16test_largegframev,@function
  .ent  _Z16test_largegframev   <span class="c"># @_Z16test_largegframev</span>
_Z16test_largegframev:
  .frame  <span class="nv">$fp</span>,1879015424,<span class="nv">$lr</span>
  .mask   0x00000000,0
  .set  noreorder
  .set  nomacro
  .set  noat
<span class="c"># BB#0:</span>
  lui <span class="nv">$1</span>, 36865
  addiu <span class="nv">$1</span>, <span class="nv">$1</span>, -32768
  addu  <span class="nv">$sp</span>, <span class="nv">$sp</span>, <span class="nv">$1</span>
  addiu <span class="nv">$2</span>, <span class="nv">$zero</span>, 0
  lui <span class="nv">$1</span>, 28672
  addiu <span class="nv">$1</span>, <span class="nv">$1</span>, -32768
  addu  <span class="nv">$sp</span>, <span class="nv">$sp</span>, <span class="nv">$1</span>
  ret <span class="nv">$lr</span>
  .set  at
  .set  macro
  .set  reorder
  .end  _Z16test_largegframev
<span class="nv">$func_end0</span>:
  .size _Z16test_largegframev, <span class="o">(</span><span class="nv">$func_end0</span><span class="o">)</span>-_Z16test_largegframev
</pre></div>
</div>
</div>
</div>
<div class="section" id="data-operands-dags">
<h2><a class="toc-backref" href="#id13">Data operands DAGs</a><a class="headerlink" href="#data-operands-dags" title="Permalink to this headline">¶</a></h2>
<p>From above or compiler book, you can see all the OP code are the internal nodes
in DAGs graph, and operands are the leaf of DAGs.
To develop your backend, you can copy the
related data operands DAGs node from other backend since the IR data nodes are
take cared by all the backend.
About the data DAGs nodes, you can understand some of them through the
Cpu0InstrInfo.td and find it by grep -R &#8220;&lt;datadag&gt;&#8221;  `find src/include/llvm`
with spending a little more time to think or guess about it.
Some data DAGs we know more, some we know a little and some remains unknown but
it&#8217;s OK for us.
List some of data DAGs we understand and occured until now as follows,</p>
<p class="rubric">include/llvm/Target/TargetSelectionDAG.td</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">// PatLeaf&#39;s are pattern fragments that have no operands.  This is just a helper</span>
<span class="c1">// to define immediates and other common things concisely.</span>
<span class="k">class</span> <span class="nc">PatLeaf</span><span class="o">&lt;</span><span class="n">dag</span> <span class="n">frag</span><span class="p">,</span> <span class="n">code</span> <span class="n">pred</span> <span class="o">=</span> <span class="p">[{}],</span> <span class="n">SDNodeXForm</span> <span class="n">xform</span> <span class="o">=</span> <span class="n">NOOP_SDNodeXForm</span><span class="o">&gt;</span>
 <span class="o">:</span> <span class="n">PatFrag</span><span class="o">&lt;</span><span class="p">(</span><span class="n">ops</span><span class="p">),</span> <span class="n">frag</span><span class="p">,</span> <span class="n">pred</span><span class="p">,</span> <span class="n">xform</span><span class="o">&gt;</span><span class="p">;</span>

<span class="c1">// ImmLeaf is a pattern fragment with a constraint on the immediate.  The</span>
<span class="c1">// constraint is a function that is run on the immediate (always with the value</span>
<span class="c1">// sign extended out to an int64_t) as Imm.  For example:</span>
<span class="c1">//</span>
<span class="c1">//  def immSExt8 : ImmLeaf&lt;i16, [{ return (char)Imm == Imm; }]&gt;;</span>
<span class="c1">//</span>
<span class="c1">// this is a more convenient form to match &#39;imm&#39; nodes in than PatLeaf and also</span>
<span class="c1">// is preferred over using PatLeaf because it allows the code generator to</span>
<span class="c1">// reason more about the constraint.</span>
<span class="c1">//</span>
<span class="c1">// If FastIsel should ignore all instructions that have an operand of this type,</span>
<span class="c1">// the FastIselShouldIgnore flag can be set.  This is an optimization to reduce</span>
<span class="c1">// the code size of the generated fast instruction selector.</span>
<span class="k">class</span> <span class="nc">ImmLeaf</span><span class="o">&lt;</span><span class="n">ValueType</span> <span class="n">vt</span><span class="p">,</span> <span class="n">code</span> <span class="n">pred</span><span class="p">,</span> <span class="n">SDNodeXForm</span> <span class="n">xform</span> <span class="o">=</span> <span class="n">NOOP_SDNodeXForm</span><span class="o">&gt;</span>
  <span class="o">:</span> <span class="n">PatFrag</span><span class="o">&lt;</span><span class="p">(</span><span class="n">ops</span><span class="p">),</span> <span class="p">(</span><span class="n">vt</span> <span class="n">imm</span><span class="p">),</span> <span class="p">[{}],</span> <span class="n">xform</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="n">let</span> <span class="n">ImmediateCode</span> <span class="o">=</span> <span class="n">pred</span><span class="p">;</span>
  <span class="n">bit</span> <span class="n">FastIselShouldIgnore</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter3_5/Cpu0InstrInfo.td</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">// Signed Operand</span>
<span class="n">def</span> <span class="n">simm16</span>      <span class="o">:</span> <span class="n">Operand</span><span class="o">&lt;</span><span class="n">i32</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="n">let</span> <span class="n">DecoderMethod</span><span class="o">=</span> <span class="s">&quot;DecodeSimm16&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">def</span> <span class="n">shamt</span>       <span class="o">:</span> <span class="n">Operand</span><span class="o">&lt;</span><span class="n">i32</span><span class="o">&gt;</span><span class="p">;</span>

<span class="c1">// Unsigned Operand</span>
<span class="n">def</span> <span class="n">uimm16</span>      <span class="o">:</span> <span class="n">Operand</span><span class="o">&lt;</span><span class="n">i32</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="n">let</span> <span class="n">PrintMethod</span> <span class="o">=</span> <span class="s">&quot;printUnsignedImm&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">// Address operand</span>
<span class="n">def</span> <span class="n">mem</span> <span class="o">:</span> <span class="n">Operand</span><span class="o">&lt;</span><span class="n">iPTR</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="n">let</span> <span class="n">PrintMethod</span> <span class="o">=</span> <span class="s">&quot;printMemOperand&quot;</span><span class="p">;</span>
  <span class="n">let</span> <span class="n">MIOperandInfo</span> <span class="o">=</span> <span class="p">(</span><span class="n">ops</span> <span class="n">CPURegs</span><span class="p">,</span> <span class="n">simm16</span><span class="p">);</span>
  <span class="n">let</span> <span class="n">EncoderMethod</span> <span class="o">=</span> <span class="s">&quot;getMemEncoding&quot;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="p">}</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">// Transformation Function - get the lower 16 bits.</span>
<span class="n">def</span> <span class="n">LO16</span> <span class="o">:</span> <span class="n">SDNodeXForm</span><span class="o">&lt;</span><span class="n">imm</span><span class="p">,</span> <span class="p">[{</span>
  <span class="k">return</span> <span class="n">getImm</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">N</span><span class="o">-&gt;</span><span class="n">getZExtValue</span><span class="p">()</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
<span class="p">}]</span><span class="o">&gt;</span><span class="p">;</span>

<span class="c1">// Transformation Function - get the higher 16 bits.</span>
<span class="n">def</span> <span class="n">HI16</span> <span class="o">:</span> <span class="n">SDNodeXForm</span><span class="o">&lt;</span><span class="n">imm</span><span class="p">,</span> <span class="p">[{</span>
  <span class="k">return</span> <span class="n">getImm</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="p">(</span><span class="n">N</span><span class="o">-&gt;</span><span class="n">getZExtValue</span><span class="p">()</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
<span class="p">}]</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">// Node immediate fits as 16-bit sign extended on target immediate.</span>
<span class="c1">// e.g. addi, andi</span>
<span class="n">def</span> <span class="n">immSExt16</span>  <span class="o">:</span> <span class="n">PatLeaf</span><span class="o">&lt;</span><span class="p">(</span><span class="n">imm</span><span class="p">),</span> <span class="p">[{</span> <span class="k">return</span> <span class="n">isInt</span><span class="o">&lt;</span><span class="mi">16</span><span class="o">&gt;</span><span class="p">(</span><span class="n">N</span><span class="o">-&gt;</span><span class="n">getSExtValue</span><span class="p">());</span> <span class="p">}]</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">// Node immediate fits as 16-bit zero extended on target immediate.</span>
<span class="c1">// The LO16 param means that only the lower 16 bits of the node</span>
<span class="c1">// immediate are caught.</span>
<span class="c1">// e.g. addiu, sltiu</span>
<span class="n">def</span> <span class="n">immZExt16</span>  <span class="o">:</span> <span class="n">PatLeaf</span><span class="o">&lt;</span><span class="p">(</span><span class="n">imm</span><span class="p">),</span> <span class="p">[{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">N</span><span class="o">-&gt;</span><span class="n">getValueType</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="n">MVT</span><span class="o">::</span><span class="n">i32</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">N</span><span class="o">-&gt;</span><span class="n">getZExtValue</span><span class="p">()</span> <span class="o">==</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">N</span><span class="o">-&gt;</span><span class="n">getZExtValue</span><span class="p">();</span>
  <span class="k">else</span>
    <span class="nf">return</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">N</span><span class="o">-&gt;</span><span class="n">getZExtValue</span><span class="p">()</span> <span class="o">==</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">N</span><span class="o">-&gt;</span><span class="n">getZExtValue</span><span class="p">();</span>
<span class="p">}],</span> <span class="n">LO16</span><span class="o">&gt;</span><span class="p">;</span>

<span class="c1">// Immediate can be loaded with LUi (32-bit int with lower 16-bit cleared).</span>
<span class="n">def</span> <span class="n">immLow16Zero</span> <span class="o">:</span> <span class="n">PatLeaf</span><span class="o">&lt;</span><span class="p">(</span><span class="n">imm</span><span class="p">),</span> <span class="p">[{</span>
  <span class="kt">int64_t</span> <span class="n">Val</span> <span class="o">=</span> <span class="n">N</span><span class="o">-&gt;</span><span class="n">getSExtValue</span><span class="p">();</span>
  <span class="k">return</span> <span class="n">isInt</span><span class="o">&lt;</span><span class="mi">32</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Val</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">Val</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
<span class="p">}]</span><span class="o">&gt;</span><span class="p">;</span>

<span class="c1">// shamt field must fit in 5 bits.</span>
<span class="n">def</span> <span class="n">immZExt5</span> <span class="o">:</span> <span class="n">ImmLeaf</span><span class="o">&lt;</span><span class="n">i32</span><span class="p">,</span> <span class="p">[{</span><span class="k">return</span> <span class="n">Imm</span> <span class="o">==</span> <span class="p">(</span><span class="n">Imm</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">);}]</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-c++"><pre>// Cpu0 Address Mode! SDNode frameindex could possibily be a match
// since load and store instructions from stack used it.
def addr : 
  ComplexPattern&lt;iPTR, 2, "SelectAddr", [frameindex], [SDNPWantParent]&gt;;

//===----------------------------------------------------------------------===//
// Pattern fragment for load/store
//===----------------------------------------------------------------------===//

class AlignedLoad&lt;PatFrag Node&gt; :
  PatFrag&lt;(ops node:$ptr), (Node node:$ptr), [{
  LoadSDNode *LD = cast&lt;LoadSDNode&gt;(N);
  return LD-&gt;getMemoryVT().getSizeInBits()/8 &lt;= LD-&gt;getAlignment();
}]&gt;;

class AlignedStore&lt;PatFrag Node&gt; :
  PatFrag&lt;(ops node:$val, node:$ptr), (Node node:$val, node:$ptr), [{
  StoreSDNode *SD = cast&lt;StoreSDNode&gt;(N);
  return SD-&gt;getMemoryVT().getSizeInBits()/8 &lt;= SD-&gt;getAlignment();
}]&gt;;
</pre>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">def</span> <span class="n">load_a</span>          <span class="o">:</span> <span class="n">AlignedLoad</span><span class="o">&lt;</span><span class="n">load</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">def</span> <span class="n">store_a</span>         <span class="o">:</span> <span class="n">AlignedStore</span><span class="o">&lt;</span><span class="n">store</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<p>As mentioned in sub-section &#8220;instruction selection&#8221; of last chapter,
immSExt16 is a data leaf DAG node and it will return true if its value is
in the range of signed 16 bits integer. The load_a, store_a and others are
similar but they check with alignment.</p>
<p>The mem is explained in chapter3_2 for print operand; addr is explained in
chapter3_3 for data DAG selection.
The simm16, ...,  inherited from Operand&lt;i32&gt; because Cpu0 is 32 bits.
It may over 16 bits, so immSExt16 pattern leaf is used to control it as example
ADDiu mention in last chapter.
PatLeaf immZExt16, immLow16Zero and ImmLeaf immZExt5 are similar to immSExt16.</p>
</div>
<div class="section" id="summary-of-this-chapter">
<h2><a class="toc-backref" href="#id14">Summary of this Chapter</a><a class="headerlink" href="#summary-of-this-chapter" title="Permalink to this headline">¶</a></h2>
<p>Summary the functions for llvm backend stages as the following table.</p>
<div class="highlight-bash"><div class="highlight"><pre>118-165-79-200:input Jonathan<span class="nv">$ </span>/Users/Jonathan/llvm/test/cmake_debug_build/
Debug/bin/llc -march<span class="o">=</span>cpu0 -relocation-model<span class="o">=</span>pic -filetype<span class="o">=</span>asm ch3.bc
-debug-pass<span class="o">=</span>Structure -o -
...
Machine Branch Probability Analysis
  ModulePass Manager
    FunctionPass Manager
      ...
      CPU0 DAG-&gt;DAG Pattern Instruction Selection
        Initial selection DAG
        Optimized lowered selection DAG
        Type-legalized selection DAG
        Optimized <span class="nb">type</span>-legalized selection DAG
        Legalized selection DAG
        Optimized legalized selection DAG
        Instruction selection
        Selected selection DAG
        Scheduling
      ...
      Greedy Register Allocator
      ...
      Prologue/Epilogue Insertion &amp; Frame Finalization
      ...
      Post-RA pseudo instruction expansion pass
      ...
      Cpu0 Assembly Printer
</pre></div>
</div>
<table border="1" class="docutils">
<caption>Functions for llvm backend stages</caption>
<colgroup>
<col width="54%" />
<col width="46%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Stage</th>
<th class="head">Function</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Before CPU0 DAG-&gt;DAG Pattern Instruction Selection</td>
<td><ul class="first last simple">
<li>Cpu0TargetLowering::LowerFormalArguments</li>
<li>Cpu0TargetLowering::LowerReturn</li>
</ul>
</td>
</tr>
<tr class="row-odd"><td>Instruction selection</td>
<td><ul class="first last simple">
<li>Cpu0DAGToDAGISel::Select</li>
</ul>
</td>
</tr>
<tr class="row-even"><td>Prologue/Epilogue Insertion &amp; Frame Finalization</td>
<td><ul class="first last simple">
<li>Cpu0SEFrameLowering::emitPrologue</li>
<li>Cpu0SEFrameLowering::emitEpilogue</li>
</ul>
</td>
</tr>
<tr class="row-odd"><td><ul class="first last simple">
<li>Determine spill callee saved registers</li>
</ul>
</td>
<td><ul class="first last simple">
<li>Cpu0SEFrameLowering::determineCalleeSaves</li>
</ul>
</td>
</tr>
<tr class="row-even"><td><ul class="first last simple">
<li>Handle stack slot for local variables</li>
</ul>
</td>
<td><ul class="first last simple">
<li>Cpu0RegisterInfo::eliminateFrameIndex</li>
</ul>
</td>
</tr>
<tr class="row-odd"><td>Post-RA pseudo instruction expansion pass</td>
<td><ul class="first last simple">
<li>Cpu0SEInstrInfo::expandPostRAPseudo</li>
</ul>
</td>
</tr>
<tr class="row-even"><td>Cpu0 Assembly Printer</td>
<td><ul class="first last simple">
<li>Cpu0AsmPrinter.cpp, Cpu0MCInstLower.cpp</li>
<li>Cpu0InstPrinter.cpp</li>
</ul>
</td>
</tr>
</tbody>
</table>
<p>We add a pass in Instruction Section stage in section &#8220;Add Cpu0DAGToDAGISel
class&#8221;. You can embed your code into other pass like that. Please check
CodeGen/Passes.h for the information. Remember the pass is called according
the function unit as the <tt class="docutils literal"><span class="pre">llc</span> <span class="pre">-debug-pass=Structure</span></tt> indicated.</p>
<p>We have finished a simple compiler for cpu0 which only support <strong>ld</strong>,
<strong>st</strong>, <strong>addiu</strong>, <strong>ori</strong>, <strong>lui</strong>, <strong>addu</strong>, <strong>shl</strong> and <strong>ret</strong> 8
instructions.</p>
<p>We are satisfied with this result.
But you may think “After so many codes we program, and just get these 8
instructions!”.
The point is we have created a frame work for cpu0 target machine (please
look back the llvm back end structure class inheritance tree early in this
chapter).
Until now, we have over 3000 lines of source code with comments which include
files *.cpp, *.h, *.td, CMakeLists.txt and LLVMBuild.txt.
It can be counted by command <tt class="docutils literal"><span class="pre">wc</span> <span class="pre">`find</span> <span class="pre">dir</span> <span class="pre">-name</span> <span class="pre">*.cpp`</span></tt> for files *.cpp,
*.h, *.td, *.txt.
LLVM front end tutorial have 700 lines of source code without comments in total.
Don&#8217;t feel down with this result.
In reality, writing a back end is warm up slowly but run fastly.
Clang has over 500,000 lines of source code with comments in clang/lib
directory which include C++ and Obj C support.
Mips back end of llvm 3.1 has only 15,000 lines with comments.
Even the complicate X86 CPU which CISC outside and RISC inside (micro
instruction), has only 45,000 lines in llvm 3.1 with comments.
In next chapter, we will show you that add a new instruction support is as easy
as 123.</p>
<table class="docutils footnote" frame="void" id="targetmachine" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td><a class="reference external" href="http://llvm.org/docs/WritingAnLLVMBackend.html#target-machine">http://llvm.org/docs/WritingAnLLVMBackend.html#target-machine</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="datalayout" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td><a class="reference external" href="http://llvm.org/docs/LangRef.html#data-layout">http://llvm.org/docs/LangRef.html#data-layout</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="registration" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[3]</a></td><td><a class="reference external" href="http://jonathan2251.github.io/lbd/llvmstructure.html#target-registration">http://jonathan2251.github.io/lbd/llvmstructure.html#target-registration</a></td></tr>
</tbody>
</table>
</div>
</div>


      </div>
      <div class="bottomnav">
      
        <p>
        «&#160;&#160;<a href="llvmstructure.html">Cpu0 architecture and LLVM structure</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="otherinst.html">Arithmetic and logic instructions</a>&#160;&#160;»
        </p>

      </div>

    <div class="footer">
        &copy; Copyright 2013, LLVM.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.
    </div>
  </body>
</html>