<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>C++ support &mdash; Tutorial: Creating an LLVM Backend for the Cpu0 Architecture</title>
    
    <link rel="stylesheet" href="_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '3.7.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="author" title="About these documents" href="about.html" />
    <link rel="top" title="Tutorial: Creating an LLVM Backend for the Cpu0 Architecture" href="index.html" />
    <link rel="next" title="Verify backend on verilog simulator" href="verilog.html" />
    <link rel="prev" title="Assembler" href="asm.html" /> 
  </head>
  <body>
      <div class="header"><h1 class="heading"><a href="index.html">
          <span>Tutorial: Creating an LLVM Backend for the Cpu0 Architecture</span></a></h1>
        <h2 class="heading"><span>C++ support</span></h2>
      </div>
      <div class="topnav">
      
        <p>
        «&#160;&#160;<a href="asm.html">Assembler</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="verilog.html">Verify backend on verilog simulator</a>&#160;&#160;»
        </p>

      </div>
      <div class="content">
        
        
  <div class="section" id="c-support">
<span id="sec-c"></span><h1>C++ support<a class="headerlink" href="#c-support" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#exception-handle" id="id8">Exception handle</a></li>
<li><a class="reference internal" href="#thread-variable" id="id9">Thread variable</a></li>
<li><a class="reference internal" href="#atomic" id="id10">Atomic</a></li>
</ul>
</div>
<p>This chapter supports C++ compiler features.</p>
<div class="section" id="exception-handle">
<h2><a class="toc-backref" href="#id8">Exception handle</a><a class="headerlink" href="#exception-handle" title="Permalink to this headline">¶</a></h2>
<p>The Chapter11_2 can be built and run with the C++ polymorphism example code of
ch12_inherit.cpp as follows,</p>
<p class="rubric">lbdex/input/ch12_inherit.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="cp">#ifdef COUT_TEST</span>
<span class="cp">#include &lt;iostream&gt;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="k">extern</span> <span class="s">&quot;C&quot;</span> <span class="kt">int</span> <span class="n">printf</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">format</span><span class="p">,</span> <span class="p">...);</span>
<span class="k">extern</span> <span class="s">&quot;C&quot;</span> <span class="kt">int</span> <span class="n">sprintf</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">out</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">format</span><span class="p">,</span> <span class="p">...);</span>

<span class="k">class</span> <span class="nc">CPolygon</span> <span class="p">{</span> <span class="c1">// _ZTVN10__cxxabiv117__class_type_infoE for parent class</span>
  <span class="nl">protected:</span>
    <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">;</span>
  <span class="nl">public:</span>
    <span class="kt">void</span> <span class="nf">set_values</span> <span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span>
    <span class="p">{</span> <span class="n">width</span><span class="o">=</span><span class="n">a</span><span class="p">;</span> <span class="n">height</span><span class="o">=</span><span class="n">b</span><span class="p">;</span> <span class="p">}</span>
<span class="c1">//    virtual int area (void) =0; // __cxa_pure_virtual</span>
    <span class="k">virtual</span> <span class="kt">int</span> <span class="nf">area</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;};</span>
    <span class="kt">void</span> <span class="n">printarea</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="cp">#ifdef COUT_TEST</span>
 <span class="c1">// generate IR nvoke, landing, resume and unreachable on iMac</span>
    <span class="p">{</span> <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span> <span class="p">}</span>
<span class="cp">#else</span>
    <span class="p">{</span> <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">());</span> <span class="p">}</span>
<span class="cp">#endif</span>
  <span class="p">};</span>

<span class="c1">// _ZTVN10__cxxabiv120__si_class_type_infoE for derived class</span>
<span class="k">class</span> <span class="nc">CRectangle</span><span class="o">:</span> <span class="k">public</span> <span class="n">CPolygon</span> <span class="p">{</span>
  <span class="nl">public:</span>
    <span class="kt">int</span> <span class="n">area</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
    <span class="p">{</span> <span class="k">return</span> <span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="n">height</span><span class="p">);</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">CTriangle</span><span class="o">:</span> <span class="k">public</span> <span class="n">CPolygon</span> <span class="p">{</span>
  <span class="nl">public:</span>
    <span class="kt">int</span> <span class="n">area</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
    <span class="p">{</span> <span class="k">return</span> <span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="n">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">CAngle</span><span class="o">:</span> <span class="k">public</span> <span class="n">CPolygon</span> <span class="p">{</span>
  <span class="nl">public:</span>
    <span class="kt">int</span> <span class="n">area</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
    <span class="p">{</span> <span class="k">return</span> <span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="n">height</span> <span class="o">/</span> <span class="mi">4</span><span class="p">);</span> <span class="p">}</span>
<span class="p">};</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">int test_cpp_polymorphism() {</span>
<span class="c">  CPolygon * ppoly1 = new CRectangle;	// _Znwm</span>
<span class="c">  CPolygon * ppoly2 = new CTriangle;</span>
<span class="c">  ppoly1-&gt;set_values (4,5);</span>
<span class="c">  ppoly2-&gt;set_values (4,5);</span>
<span class="c">  ppoly1-&gt;printarea();</span>
<span class="c">  ppoly2-&gt;printarea();</span>
<span class="c">  delete ppoly1;	// _ZdlPv</span>
<span class="c">  delete ppoly2;</span>
<span class="c">  return 0;</span>
<span class="c">}</span>
<span class="cp">#else</span>
<span class="kt">int</span> <span class="nf">test_cpp_polymorphism</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">CRectangle</span> <span class="n">poly1</span><span class="p">;</span>
  <span class="n">CTriangle</span> <span class="n">poly2</span><span class="p">;</span>
  <span class="n">CAngle</span> <span class="n">poly3</span><span class="p">;</span>
  
  <span class="n">CPolygon</span> <span class="o">*</span> <span class="n">ppoly1</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">poly1</span><span class="p">;</span>
  <span class="n">CPolygon</span> <span class="o">*</span> <span class="n">ppoly2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">poly2</span><span class="p">;</span>
  <span class="n">CPolygon</span> <span class="o">*</span> <span class="n">ppoly3</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">poly3</span><span class="p">;</span>
  
  <span class="n">ppoly1</span><span class="o">-&gt;</span><span class="n">set_values</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">);</span>
  <span class="n">ppoly2</span><span class="o">-&gt;</span><span class="n">set_values</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">);</span>
  <span class="n">ppoly3</span><span class="o">-&gt;</span><span class="n">set_values</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">);</span>
  <span class="n">ppoly1</span><span class="o">-&gt;</span><span class="n">printarea</span><span class="p">();</span>
  <span class="n">ppoly2</span><span class="o">-&gt;</span><span class="n">printarea</span><span class="p">();</span>
  <span class="n">ppoly3</span><span class="o">-&gt;</span><span class="n">printarea</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">ppoly1</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">()</span> <span class="o">==</span> <span class="mi">20</span> <span class="o">&amp;&amp;</span> <span class="n">ppoly2</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">()</span> <span class="o">==</span> <span class="mi">10</span> <span class="o">&amp;&amp;</span> <span class="n">ppoly3</span><span class="o">-&gt;</span><span class="n">area</span><span class="p">()</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>
</pre></div>
</div>
<p>If using cout instead of printf in ch12_inherit.cpp on Linux won&#8217;t generate exception
handler IRs.
But on iMac, ch12_inherit.cpp will generate invoke, landing, resume and unreachable
exception handler IRs.
Example code, ch12_eh.cpp, which supports <strong>try</strong> and <strong>catch</strong> exception handler
as the following will generate these exception handler IRs both on iMac and Linux.</p>
<p class="rubric">lbdex/input/ch12_eh.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Ex1</span> <span class="p">{};</span>
<span class="kt">void</span> <span class="nf">throw_exception</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">Ex1</span> <span class="n">ex1</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">&gt;</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="n">ex1</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">test_try_catch</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">try</span> <span class="p">{</span>
    <span class="n">throw_exception</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">catch</span><span class="p">(...)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-bash"><div class="highlight"><pre>JonathantekiiMac:input Jonathan<span class="nv">$ </span>clang -c ch12_eh.cpp -emit-llvm
-o ch12_eh.bc
JonathantekiiMac:input Jonathan<span class="nv">$ </span>/Users/Jonathan/llvm/test/cmake_debug_build/
Debug/bin/llvm-dis ch12_eh.bc -o -
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>; ModuleID = &#39;ch12_eh.bc&#39;
target datalayout = &quot;E-m:m-p:32:32-i8:8:32-i16:16:32-i64:64-n32-S64&quot;
target triple = &quot;mips-unknown-linux-gnu&quot;

%class.Ex1 = type { i8 }

$_ZTS3Ex1 = comdat any

$_ZTI3Ex1 = comdat any

@_ZTVN10__cxxabiv117__class_type_infoE = external global i8*
@_ZTS3Ex1 = linkonce_odr constant [5 x i8] c&quot;3Ex1\00&quot;, comdat
@_ZTI3Ex1 = linkonce_odr constant { i8*, i8* } { i8* bitcast (i8** getelementptr
 inbounds (i8*, i8** @_ZTVN10__cxxabiv117__class_type_infoE, i32 2) to i8*), i8*
 getelementptr inbounds ([5 x i8], [5 x i8]* @_ZTS3Ex1, i32 0, i32 0) }, comdat

define void @_Z15throw_exceptionii(i32 signext %a, i32 signext %b) #0 {
  %1 = alloca i32, align 4
  %2 = alloca i32, align 4
  %ex1 = alloca %class.Ex1, align 1
  store i32 %a, i32* %1, align 4
  store i32 %b, i32* %2, align 4
  %3 = load i32, i32* %1, align 4
  %4 = load i32, i32* %2, align 4
  %5 = icmp sgt i32 %3, %4
  br i1 %5, label %6, label %9

; &lt;label&gt;:6                                       ; preds = %0
  %7 = call i8* @__cxa_allocate_exception(i32 1) #1
  %8 = bitcast i8* %7 to %class.Ex1*
  call void @__cxa_throw(i8* %7, i8* bitcast ({ i8*, i8* }* @_ZTI3Ex1 to i8*), i
8* null) #2
  unreachable

; &lt;label&gt;:9                                       ; preds = %0
  ret void
}

declare i8* @__cxa_allocate_exception(i32)

declare void @__cxa_throw(i8*, i8*, i8*)

define i32 @_Z14test_try_catchv() #0 personality i8* bitcast (i32 (...)* @__gxx_
personality_v0 to i8*) {
  %1 = alloca i32, align 4
  %2 = alloca i8*
  %3 = alloca i32
  invoke void @_Z15throw_exceptionii(i32 signext 2, i32 signext 1)
          to label %4 unwind label %5

; &lt;label&gt;:4                                       ; preds = %0
  br label %12

; &lt;label&gt;:5                                       ; preds = %0
  %6 = landingpad { i8*, i32 }
          catch i8* null
  %7 = extractvalue { i8*, i32 } %6, 0
  store i8* %7, i8** %2
  %8 = extractvalue { i8*, i32 } %6, 1
  store i32 %8, i32* %3
  br label %9

; &lt;label&gt;:9                                       ; preds = %5
  %10 = load i8*, i8** %2
  %11 = call i8* @__cxa_begin_catch(i8* %10) #1
  store i32 1, i32* %1
  call void @__cxa_end_catch()
  br label %13

; &lt;label&gt;:12                                      ; preds = %4
  store i32 0, i32* %1
  br label %13

; &lt;label&gt;:13                                      ; preds = %12, %9
  %14 = load i32, i32* %1
  ret i32 %14
}

declare i32 @__gxx_personality_v0(...)

declare i8* @__cxa_begin_catch(i8*)

declare void @__cxa_end_catch()

attributes #0 = { &quot;disable-tail-calls&quot;=&quot;false&quot; &quot;less-precise-fpmad&quot;=&quot;false&quot; &quot;no-
frame-pointer-elim&quot;=&quot;true&quot; &quot;no-frame-pointer-elim-non-leaf&quot; &quot;no-infs-fp-math&quot;=&quot;f
alse&quot; &quot;no-nans-fp-math&quot;=&quot;false&quot; &quot;stack-protector-buffer-size&quot;=&quot;8&quot; &quot;target-cpu&quot;=&quot;
mips32r2&quot; &quot;target-features&quot;=&quot;+mips32r2&quot; &quot;unsafe-fp-math&quot;=&quot;false&quot; &quot;use-soft-float
&quot;=&quot;false&quot; }
attributes #1 = { nounwind }
attributes #2 = { noreturn }

!llvm.ident = !{!0}

!0 = !{!&quot;clang version 3.7.0 (tags/RELEASE_370/final)&quot;}
</pre></div>
</div>
<div class="highlight-bash"><div class="highlight"><pre>JonathantekiiMac:input Jonathan$ /Users/Jonathan/llvm/test/cmake_debug_build/
Debug/bin/llc -march=cpu0 -relocation-model=static -filetype=asm ch12_eh.bc -o -
        .section .mdebug.abi32
        .previous
        .file &quot;ch12_eh.bc&quot;
llc: /Users/Jonathan/llvm/test/src/lib/CodeGen/LiveVariables.cpp:133: void llvm::
LiveVariables::HandleVirtRegUse(unsigned int, llvm::MachineBasicBlock *, llvm
::MachineInstr *): Assertion `MRI-&gt;getVRegDef(reg) &amp;&amp; &quot;Register use before
def!&quot;&#39; failed.
</pre></div>
</div>
<p>About the IRs of LLVM exception handling, please reference here <a class="footnote-reference" href="#exception" id="id1">[1]</a>.
Chapter12_1 supports the llvm IRs of corresponding <strong>try</strong> and <strong>catch</strong>
exception C++ keywords. It can compile ch12_eh.bc as follows,</p>
<p class="rubric">lbdex/chapters/Chapter12_1/Cpu0ISelLowering.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">Cpu0TargetLowering</span><span class="o">::</span><span class="n">Cpu0TargetLowering</span><span class="p">(</span><span class="k">const</span> <span class="n">Cpu0TargetMachine</span> <span class="o">&amp;</span><span class="n">TM</span><span class="p">,</span>
                                       <span class="k">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">STI</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">TargetLowering</span><span class="p">(</span><span class="n">TM</span><span class="p">),</span> <span class="n">Subtarget</span><span class="p">(</span><span class="n">STI</span><span class="p">),</span> <span class="n">ABI</span><span class="p">(</span><span class="n">TM</span><span class="p">.</span><span class="n">getABI</span><span class="p">())</span> <span class="p">{</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="n">setExceptionPointerRegister</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">A0</span><span class="p">);</span>
  <span class="n">setExceptionSelectorRegister</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">A1</span><span class="p">);</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="p">}</span>
</pre></div>
</div>
<div class="highlight-bash"><div class="highlight"><pre>JonathantekiiMac:input Jonathan<span class="nv">$ </span>/Users/Jonathan/llvm/test/cmake_debug_build/
Debug/bin/llc -march<span class="o">=</span>cpu0 -relocation-model<span class="o">=</span>static -filetype<span class="o">=</span>asm ch12_eh.bc -o -
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>  .text
  .section .mdebug.abiO32
  .previous
  .file  &quot;ch12_eh.bc&quot;
  .globl  _Z15throw_exceptionii
  .align  2
  .type  _Z15throw_exceptionii,@function
  .ent  _Z15throw_exceptionii   # @_Z15throw_exceptionii
_Z15throw_exceptionii:
  .cfi_startproc
  .frame  $fp,40,$lr
  .mask   0x00005000,-4
  .set  noreorder
  .set  nomacro
# BB#0:
  addiu  $sp, $sp, -40
$tmp0:
  .cfi_def_cfa_offset 40
  st  $lr, 36($sp)            # 4-byte Folded Spill
  st  $fp, 32($sp)            # 4-byte Folded Spill
$tmp1:
  .cfi_offset 14, -4
$tmp2:
  .cfi_offset 12, -8
  move   $fp, $sp
$tmp3:
  .cfi_def_cfa_register 12
  st  $4, 28($fp)
  st  $5, 24($fp)
  ld  $2, 28($fp)
  cmp  $sw, $2, $5
  jle  $sw, LBB0_2
  nop
  jmp  LBB0_1
  nop
LBB0_2:
  move   $sp, $fp
  ld  $fp, 32($sp)            # 4-byte Folded Reload
  ld  $lr, 36($sp)            # 4-byte Folded Reload
  addiu  $sp, $sp, 40
  ret  $lr
  nop
LBB0_1:
  addiu  $4, $zero, 1
  jsub  __cxa_allocate_exception
  nop
  addiu  $3, $zero, 0
  st  $3, 8($sp)
  lui  $3, %hi(_ZTI3Ex1)
  ori  $5, $3, %lo(_ZTI3Ex1)
  addu  $4, $zero, $2
  jsub  __cxa_throw
  nop
  .set  macro
  .set  reorder
  .end  _Z15throw_exceptionii
$func_end0:
  .size  _Z15throw_exceptionii, ($func_end0)-_Z15throw_exceptionii
  .cfi_endproc

  .globl  _Z14test_try_catchv
  .align  2
  .type  _Z14test_try_catchv,@function
  .ent  _Z14test_try_catchv     # @_Z14test_try_catchv
_Z14test_try_catchv:
$tmp7:
$func_begin0 = ($tmp7)
  .cfi_startproc
  .cfi_personality 0, __gxx_personality_v0
  .cfi_lsda 0, $exception0
  .frame  $fp,32,$lr
  .mask   0x00005200,-4
  .set  noreorder
  .set  nomacro
# BB#0:
  addiu  $sp, $sp, -32
$tmp8:
  .cfi_def_cfa_offset 32
  st  $lr, 28($sp)            # 4-byte Folded Spill
  st  $fp, 24($sp)            # 4-byte Folded Spill
  st  $9, 20($sp)             # 4-byte Folded Spill
$tmp9:
  .cfi_offset 14, -4
$tmp10:
  .cfi_offset 12, -8
$tmp11:
  .cfi_offset 9, -12
  move   $fp, $sp
$tmp12:
  .cfi_def_cfa_register 12
$tmp4:
  addiu  $4, $zero, 2
  addiu  $9, $zero, 1
  addu  $5, $zero, $9
  jsub  _Z15throw_exceptionii
  nop
$tmp5:
# BB#2:
  addiu  $2, $zero, 0
  st  $2, 16($fp)
LBB1_3:
  ld  $2, 16($fp)
  move   $sp, $fp
  ld  $9, 20($sp)             # 4-byte Folded Reload
  ld  $fp, 24($sp)            # 4-byte Folded Reload
  ld  $lr, 28($sp)            # 4-byte Folded Reload
  addiu  $sp, $sp, 32
  ret  $lr
  nop
LBB1_1:
$tmp6:
  st  $4, 12($fp)
  st  $5, 8($fp)
  ld  $4, 12($fp)
  jsub  __cxa_begin_catch
  nop
  st  $9, 16($fp)
  jsub  __cxa_end_catch
  nop
  jmp  LBB1_3
  nop
  .set  macro
  .set  reorder
  .end  _Z14test_try_catchv
$func_end1:
  .size  _Z14test_try_catchv, ($func_end1)-_Z14test_try_catchv
  .cfi_endproc
  .section  .gcc_except_table,&quot;a&quot;,@progbits
  .align  2
GCC_except_table1:
$exception0:
  .byte  255                     # @LPStart Encoding = omit
  .byte  0                       # @TType Encoding = absptr
  .asciz  &quot;\242\200\200&quot;          # @TType base offset
  .byte  3                       # Call site Encoding = udata4
  .byte  26                      # Call site table length
  .4byte  ($tmp4)-($func_begin0)  # &gt;&gt; Call Site 1 &lt;&lt;
  .4byte  ($tmp5)-($tmp4)         #   Call between $tmp4 and $tmp5
  .4byte  ($tmp6)-($func_begin0)  #     jumps to $tmp6
  .byte  1                       #   On action: 1
  .4byte  ($tmp5)-($func_begin0)  # &gt;&gt; Call Site 2 &lt;&lt;
  .4byte  ($func_end1)-($tmp5)    #   Call between $tmp5 and $func_end1
  .4byte  0                       #     has no landing pad
  .byte  0                       #   On action: cleanup
  .byte  1                       # &gt;&gt; Action Record 1 &lt;&lt;
                                        #   Catch TypeInfo 1
  .byte  0                       #   No further actions
                                        # &gt;&gt; Catch TypeInfos &lt;&lt;
  .4byte  0                       # TypeInfo 1
  .align  2

  .type  _ZTS3Ex1,@object        # @_ZTS3Ex1
  .section  .rodata._ZTS3Ex1,&quot;aG&quot;,@progbits,_ZTS3Ex1,comdat
  .weak  _ZTS3Ex1
  .align  2
_ZTS3Ex1:
  .asciz  &quot;3Ex1&quot;
  .size  _ZTS3Ex1, 5

  .type  _ZTI3Ex1,@object        # @_ZTI3Ex1
  .section  .rodata._ZTI3Ex1,&quot;aG&quot;,@progbits,_ZTI3Ex1,comdat
  .weak  _ZTI3Ex1
  .align  3
_ZTI3Ex1:
  .4byte  _ZTVN10__cxxabiv117__class_type_infoE+8
  .4byte  _ZTS3Ex1
  .size  _ZTI3Ex1, 8
</pre></div>
</div>
</div>
<div class="section" id="thread-variable">
<h2><a class="toc-backref" href="#id9">Thread variable</a><a class="headerlink" href="#thread-variable" title="Permalink to this headline">¶</a></h2>
<p>C++ include the thread variable as the following file ch12_thread_var.cpp.</p>
<p class="rubric">lbdex/input/ch12_thread_var.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">__thread</span> <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">thread_local</span> <span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// need option -std=c++11</span>
<span class="kt">int</span> <span class="nf">test_thread_var</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">a</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">test_thread_var_2</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">b</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">b</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>While global variable is a single instance shared by all threads in a process,
thread variable has different instances for each different thread in a process.
The same thread share the thread variable but different threads have their own
thread variable with the same name <a class="footnote-reference" href="#thread-wiki" id="id2">[2]</a>.</p>
<p>To support thread variable, the following code added to Chapter12_1.
Most of them are for relocation record handle and display since the thread
variable created by OS or language library which support multi-threads
programming.</p>
<p class="rubric">lbdex/chapters/Chapter12_1/AsmParser/Cpu0AsmParser.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">MCSymbolRefExpr</span><span class="o">::</span><span class="n">VariantKind</span> <span class="n">Cpu0AsmParser</span><span class="o">::</span><span class="n">getVariantKind</span><span class="p">(</span><span class="n">StringRef</span> <span class="n">Symbol</span><span class="p">)</span> <span class="p">{</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>    <span class="p">.</span><span class="n">Case</span><span class="p">(</span><span class="s">&quot;tlsgd&quot;</span><span class="p">,</span>       <span class="n">MCSymbolRefExpr</span><span class="o">::</span><span class="n">VK_Cpu0_TLSGD</span><span class="p">)</span>
    <span class="p">.</span><span class="n">Case</span><span class="p">(</span><span class="s">&quot;tlsldm&quot;</span><span class="p">,</span>      <span class="n">MCSymbolRefExpr</span><span class="o">::</span><span class="n">VK_Cpu0_TLSLDM</span><span class="p">)</span>
    <span class="p">.</span><span class="n">Case</span><span class="p">(</span><span class="s">&quot;dtp_hi&quot;</span><span class="p">,</span>      <span class="n">MCSymbolRefExpr</span><span class="o">::</span><span class="n">VK_Cpu0_DTP_HI</span><span class="p">)</span>
    <span class="p">.</span><span class="n">Case</span><span class="p">(</span><span class="s">&quot;dtp_lo&quot;</span><span class="p">,</span>      <span class="n">MCSymbolRefExpr</span><span class="o">::</span><span class="n">VK_Cpu0_DTP_LO</span><span class="p">)</span>
    <span class="p">.</span><span class="n">Case</span><span class="p">(</span><span class="s">&quot;gottp&quot;</span><span class="p">,</span>       <span class="n">MCSymbolRefExpr</span><span class="o">::</span><span class="n">VK_Cpu0_GOTTPREL</span><span class="p">)</span>
    <span class="p">.</span><span class="n">Case</span><span class="p">(</span><span class="s">&quot;tp_hi&quot;</span><span class="p">,</span>       <span class="n">MCSymbolRefExpr</span><span class="o">::</span><span class="n">VK_Cpu0_TP_HI</span><span class="p">)</span>
    <span class="p">.</span><span class="n">Case</span><span class="p">(</span><span class="s">&quot;tp_lo&quot;</span><span class="p">,</span>       <span class="n">MCSymbolRefExpr</span><span class="o">::</span><span class="n">VK_Cpu0_TP_LO</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>    <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter12_1/InstPrinter/Cpu0InstPrinter.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">printExpr</span><span class="p">(</span><span class="k">const</span> <span class="n">MCExpr</span> <span class="o">*</span><span class="n">Expr</span><span class="p">,</span> <span class="n">raw_ostream</span> <span class="o">&amp;</span><span class="n">OS</span><span class="p">)</span> <span class="p">{</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="k">case</span> <span class="n">MCSymbolRefExpr</span>:<span class="o">:</span><span class="n">VK_Cpu0_TLSGD</span><span class="o">:</span>     <span class="n">OS</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;%tlsgd(&quot;</span><span class="p">;</span>  <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">MCSymbolRefExpr</span>:<span class="o">:</span><span class="n">VK_Cpu0_TLSLDM</span><span class="o">:</span>    <span class="n">OS</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;%tlsldm(&quot;</span><span class="p">;</span>  <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">MCSymbolRefExpr</span>:<span class="o">:</span><span class="n">VK_Cpu0_DTP_HI</span><span class="o">:</span>    <span class="n">OS</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;%dtp_hi(&quot;</span><span class="p">;</span>  <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">MCSymbolRefExpr</span>:<span class="o">:</span><span class="n">VK_Cpu0_DTP_LO</span><span class="o">:</span>    <span class="n">OS</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;%dtp_lo(&quot;</span><span class="p">;</span>  <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">MCSymbolRefExpr</span>:<span class="o">:</span><span class="n">VK_Cpu0_GOTTPREL</span><span class="o">:</span>  <span class="n">OS</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;%gottprel(&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">MCSymbolRefExpr</span>:<span class="o">:</span><span class="n">VK_Cpu0_TP_HI</span><span class="o">:</span>     <span class="n">OS</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;%tp_hi(&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">MCSymbolRefExpr</span>:<span class="o">:</span><span class="n">VK_Cpu0_TP_LO</span><span class="o">:</span>     <span class="n">OS</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;%tp_lo(&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter12_1/MCTargetDesc/Cpu0AsmBackend.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="k">const</span> <span class="n">MCFixupKindInfo</span> <span class="o">&amp;</span><span class="n">Cpu0AsmBackend</span><span class="o">::</span>
<span class="n">getFixupKindInfo</span><span class="p">(</span><span class="n">MCFixupKind</span> <span class="n">Kind</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="k">const</span> <span class="k">static</span> <span class="n">MCFixupKindInfo</span> <span class="n">Infos</span><span class="p">[</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">NumTargetFixupKinds</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1">// This table *must* be in same the order of fixup_* kinds in</span>
    <span class="c1">// Cpu0FixupKinds.h.</span>
    <span class="c1">//</span>
    <span class="c1">// name                        offset  bits  flags</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>    <span class="p">{</span> <span class="s">&quot;fixup_Cpu0_TLSGD&quot;</span><span class="p">,</span>          <span class="mi">0</span><span class="p">,</span>     <span class="mi">16</span><span class="p">,</span>   <span class="mi">0</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">&quot;fixup_Cpu0_GOTTP&quot;</span><span class="p">,</span>          <span class="mi">0</span><span class="p">,</span>     <span class="mi">16</span><span class="p">,</span>   <span class="mi">0</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">&quot;fixup_Cpu0_TP_HI&quot;</span><span class="p">,</span>          <span class="mi">0</span><span class="p">,</span>     <span class="mi">16</span><span class="p">,</span>   <span class="mi">0</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">&quot;fixup_Cpu0_TP_LO&quot;</span><span class="p">,</span>          <span class="mi">0</span><span class="p">,</span>     <span class="mi">16</span><span class="p">,</span>   <span class="mi">0</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">&quot;fixup_Cpu0_TLSLDM&quot;</span><span class="p">,</span>         <span class="mi">0</span><span class="p">,</span>     <span class="mi">16</span><span class="p">,</span>   <span class="mi">0</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">&quot;fixup_Cpu0_DTP_HI&quot;</span><span class="p">,</span>         <span class="mi">0</span><span class="p">,</span>     <span class="mi">16</span><span class="p">,</span>   <span class="mi">0</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">&quot;fixup_Cpu0_DTP_LO&quot;</span><span class="p">,</span>         <span class="mi">0</span><span class="p">,</span>     <span class="mi">16</span><span class="p">,</span>   <span class="mi">0</span> <span class="p">},</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>    <span class="p">...</span>
  <span class="p">};</span>
  <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter12_1/MCTargetDesc/Cpu0BaseInfo.h</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="k">namespace</span> <span class="n">Cpu0II</span> <span class="p">{</span>
  <span class="c1">/// Target Operand Flag enum.</span>
  <span class="k">enum</span> <span class="n">TOF</span> <span class="p">{</span>
    <span class="c1">//===------------------------------------------------------------------===//</span>
    <span class="c1">// Cpu0 Specific MachineOperand flags.</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>    <span class="c1">/// MO_TLSGD - Represents the offset into the global offset table at which</span>
    <span class="c1">// the module ID and TSL block offset reside during execution (General</span>
    <span class="c1">// Dynamic TLS).</span>
    <span class="n">MO_TLSGD</span><span class="p">,</span>

    <span class="c1">/// MO_TLSLDM - Represents the offset into the global offset table at which</span>
    <span class="c1">// the module ID and TSL block offset reside during execution (Local</span>
    <span class="c1">// Dynamic TLS).</span>
    <span class="n">MO_TLSLDM</span><span class="p">,</span>
    <span class="n">MO_DTP_HI</span><span class="p">,</span>
    <span class="n">MO_DTP_LO</span><span class="p">,</span>

    <span class="c1">/// MO_GOTTPREL - Represents the offset from the thread pointer (Initial</span>
    <span class="c1">// Exec TLS).</span>
    <span class="n">MO_GOTTPREL</span><span class="p">,</span>

    <span class="c1">/// MO_TPREL_HI/LO - Represents the hi and low part of the offset from</span>
    <span class="c1">// the thread pointer (Local Exec TLS).</span>
    <span class="n">MO_TP_HI</span><span class="p">,</span>
    <span class="n">MO_TP_LO</span><span class="p">,</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>    <span class="p">...</span>
  <span class="p">};</span>
  <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter12_1/MCTargetDesc/Cpu0ELFObjectWriter.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="kt">unsigned</span> <span class="n">Cpu0ELFObjectWriter</span><span class="o">::</span><span class="n">GetRelocType</span><span class="p">(</span><span class="k">const</span> <span class="n">MCValue</span> <span class="o">&amp;</span><span class="n">Target</span><span class="p">,</span>
                                           <span class="k">const</span> <span class="n">MCFixup</span> <span class="o">&amp;</span><span class="n">Fixup</span><span class="p">,</span>
                                           <span class="kt">bool</span> <span class="n">IsPCRel</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="c1">// determine the type of the relocation</span>
  <span class="kt">unsigned</span> <span class="n">Type</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">ELF</span><span class="o">::</span><span class="n">R_CPU0_NONE</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="n">Kind</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">Fixup</span><span class="p">.</span><span class="n">getKind</span><span class="p">();</span>

  <span class="k">switch</span> <span class="p">(</span><span class="n">Kind</span><span class="p">)</span> <span class="p">{</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="k">case</span> <span class="n">Cpu0</span>:<span class="o">:</span><span class="n">fixup_Cpu0_TLSGD</span><span class="o">:</span>
    <span class="n">Type</span> <span class="o">=</span> <span class="n">ELF</span><span class="o">::</span><span class="n">R_CPU0_TLS_GD</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">Cpu0</span>:<span class="o">:</span><span class="n">fixup_Cpu0_GOTTPREL</span><span class="o">:</span>
    <span class="n">Type</span> <span class="o">=</span> <span class="n">ELF</span><span class="o">::</span><span class="n">R_CPU0_TLS_GOTTPREL</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter12_1/MCTargetDesc/Cpu0FixupKinds.h</p>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="k">enum</span> <span class="n">Fixups</span> <span class="p">{</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>    <span class="c1">// resulting in - R_CPU0_TLS_GD.</span>
    <span class="n">fixup_Cpu0_TLSGD</span><span class="p">,</span>

    <span class="c1">// resulting in - R_CPU0_TLS_GOTTPREL.</span>
    <span class="n">fixup_Cpu0_GOTTPREL</span><span class="p">,</span>

    <span class="c1">// resulting in - R_CPU0_TLS_TPREL_HI16.</span>
    <span class="n">fixup_Cpu0_TP_HI</span><span class="p">,</span>

    <span class="c1">// resulting in - R_CPU0_TLS_TPREL_LO16.</span>
    <span class="n">fixup_Cpu0_TP_LO</span><span class="p">,</span>

    <span class="c1">// resulting in - R_CPU0_TLS_LDM.</span>
    <span class="n">fixup_Cpu0_TLSLDM</span><span class="p">,</span>

    <span class="c1">// resulting in - R_CPU0_TLS_DTP_HI16.</span>
    <span class="n">fixup_Cpu0_DTP_HI</span><span class="p">,</span>

    <span class="c1">// resulting in - R_CPU0_TLS_DTP_LO16.</span>
    <span class="n">fixup_Cpu0_DTP_LO</span><span class="p">,</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="p">...</span>
<span class="p">};</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter12_1/MCTargetDesc/Cpu0MCCodeEmitter.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="kt">unsigned</span> <span class="n">Cpu0MCCodeEmitter</span><span class="o">::</span>
<span class="n">getExprOpValue</span><span class="p">(</span><span class="k">const</span> <span class="n">MCExpr</span> <span class="o">*</span><span class="n">Expr</span><span class="p">,</span><span class="n">SmallVectorImpl</span><span class="o">&lt;</span><span class="n">MCFixup</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">Fixups</span><span class="p">,</span>
               <span class="k">const</span> <span class="n">MCSubtargetInfo</span> <span class="o">&amp;</span><span class="n">STI</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="k">case</span> <span class="n">MCSymbolRefExpr</span>:<span class="o">:</span><span class="n">VK_Cpu0_TLSGD</span><span class="o">:</span>
    <span class="n">FixupKind</span> <span class="o">=</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">fixup_Cpu0_TLSGD</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">MCSymbolRefExpr</span>:<span class="o">:</span><span class="n">VK_Cpu0_TLSLDM</span><span class="o">:</span>
    <span class="n">FixupKind</span> <span class="o">=</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">fixup_Cpu0_TLSLDM</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">MCSymbolRefExpr</span>:<span class="o">:</span><span class="n">VK_Cpu0_DTP_HI</span><span class="o">:</span>
    <span class="n">FixupKind</span> <span class="o">=</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">fixup_Cpu0_DTP_HI</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">MCSymbolRefExpr</span>:<span class="o">:</span><span class="n">VK_Cpu0_DTP_LO</span><span class="o">:</span>
    <span class="n">FixupKind</span> <span class="o">=</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">fixup_Cpu0_DTP_LO</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">MCSymbolRefExpr</span>:<span class="o">:</span><span class="n">VK_Cpu0_GOTTPREL</span><span class="o">:</span>
    <span class="n">FixupKind</span> <span class="o">=</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">fixup_Cpu0_GOTTPREL</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">MCSymbolRefExpr</span>:<span class="o">:</span><span class="n">VK_Cpu0_TP_HI</span><span class="o">:</span>
    <span class="n">FixupKind</span> <span class="o">=</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">fixup_Cpu0_TP_HI</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">MCSymbolRefExpr</span>:<span class="o">:</span><span class="n">VK_Cpu0_TP_LO</span><span class="o">:</span>
    <span class="n">FixupKind</span> <span class="o">=</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">fixup_Cpu0_TP_LO</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter12_1/Cpu0InstrInfo.td</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">// TlsGd node is used to handle General Dynamic TLS</span>
<span class="n">def</span> <span class="n">Cpu0TlsGd</span> <span class="o">:</span> <span class="n">SDNode</span><span class="o">&lt;</span><span class="s">&quot;Cpu0ISD::TlsGd&quot;</span><span class="p">,</span> <span class="n">SDTIntUnaryOp</span><span class="o">&gt;</span><span class="p">;</span>

<span class="c1">// TpHi and TpLo nodes are used to handle Local Exec TLS</span>
<span class="n">def</span> <span class="n">Cpu0TpHi</span>  <span class="o">:</span> <span class="n">SDNode</span><span class="o">&lt;</span><span class="s">&quot;Cpu0ISD::TpHi&quot;</span><span class="p">,</span> <span class="n">SDTIntUnaryOp</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">Cpu0TpLo</span>  <span class="o">:</span> <span class="n">SDNode</span><span class="o">&lt;</span><span class="s">&quot;Cpu0ISD::TpLo&quot;</span><span class="p">,</span> <span class="n">SDTIntUnaryOp</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>let Predicates = [Ch12_1] in {
def : Pat&lt;(Cpu0Hi tglobaltlsaddr:$in), (LUi tglobaltlsaddr:$in)&gt;;
}
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>let Predicates = [Ch12_1] in {
def : Pat&lt;(Cpu0Lo tglobaltlsaddr:$in), (ORi ZERO, tglobaltlsaddr:$in)&gt;;
}
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">let</span> <span class="n">Predicates</span> <span class="o">=</span> <span class="p">[</span><span class="n">Ch12_1</span><span class="p">]</span> <span class="n">in</span> <span class="p">{</span>
<span class="n">def</span> <span class="o">:</span> <span class="n">WrapperPat</span><span class="o">&lt;</span><span class="n">tglobaltlsaddr</span><span class="p">,</span> <span class="n">ORi</span><span class="p">,</span> <span class="n">CPURegs</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter12_1/Cpu0SelLowering.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">Cpu0TargetLowering</span><span class="o">::</span><span class="n">Cpu0TargetLowering</span><span class="p">(</span><span class="k">const</span> <span class="n">Cpu0TargetMachine</span> <span class="o">&amp;</span><span class="n">TM</span><span class="p">,</span>
                                       <span class="k">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">STI</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">TargetLowering</span><span class="p">(</span><span class="n">TM</span><span class="p">),</span> <span class="n">Subtarget</span><span class="p">(</span><span class="n">STI</span><span class="p">),</span> <span class="n">ABI</span><span class="p">(</span><span class="n">TM</span><span class="p">.</span><span class="n">getABI</span><span class="p">())</span> <span class="p">{</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="n">setOperationAction</span><span class="p">(</span><span class="n">ISD</span><span class="o">::</span><span class="n">GlobalTLSAddress</span><span class="p">,</span>   <span class="n">MVT</span><span class="o">::</span><span class="n">i32</span><span class="p">,</span>   <span class="n">Custom</span><span class="p">);</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">SDValue</span> <span class="n">Cpu0TargetLowering</span><span class="o">::</span>
<span class="n">LowerOperation</span><span class="p">(</span><span class="n">SDValue</span> <span class="n">Op</span><span class="p">,</span> <span class="n">SelectionDAG</span> <span class="o">&amp;</span><span class="n">DAG</span><span class="p">)</span> <span class="k">const</span>
<span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">Op</span><span class="p">.</span><span class="n">getOpcode</span><span class="p">())</span>
  <span class="p">{</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="k">case</span> <span class="n">ISD</span>:<span class="o">:</span><span class="n">GlobalTLSAddress</span><span class="o">:</span>   <span class="k">return</span> <span class="n">lowerGlobalTLSAddress</span><span class="p">(</span><span class="n">Op</span><span class="p">,</span> <span class="n">DAG</span><span class="p">);</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>    <span class="p">...</span>
  <span class="p">}</span>
  <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">SDValue</span> <span class="n">Cpu0TargetLowering</span><span class="o">::</span>
<span class="n">lowerGlobalTLSAddress</span><span class="p">(</span><span class="n">SDValue</span> <span class="n">Op</span><span class="p">,</span> <span class="n">SelectionDAG</span> <span class="o">&amp;</span><span class="n">DAG</span><span class="p">)</span> <span class="k">const</span>
<span class="p">{</span>
  <span class="c1">// If the relocation model is PIC, use the General Dynamic TLS Model or</span>
  <span class="c1">// Local Dynamic TLS model, otherwise use the Initial Exec or</span>
  <span class="c1">// Local Exec TLS Model.</span>

  <span class="n">GlobalAddressSDNode</span> <span class="o">*</span><span class="n">GA</span> <span class="o">=</span> <span class="n">cast</span><span class="o">&lt;</span><span class="n">GlobalAddressSDNode</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Op</span><span class="p">);</span>
  <span class="n">SDLoc</span> <span class="nf">DL</span><span class="p">(</span><span class="n">GA</span><span class="p">);</span>
  <span class="k">const</span> <span class="n">GlobalValue</span> <span class="o">*</span><span class="n">GV</span> <span class="o">=</span> <span class="n">GA</span><span class="o">-&gt;</span><span class="n">getGlobal</span><span class="p">();</span>
  <span class="n">EVT</span> <span class="n">PtrVT</span> <span class="o">=</span> <span class="n">getPointerTy</span><span class="p">(</span><span class="n">DAG</span><span class="p">.</span><span class="n">getDataLayout</span><span class="p">());</span>

  <span class="n">TLSModel</span><span class="o">::</span><span class="n">Model</span> <span class="n">model</span> <span class="o">=</span> <span class="n">getTargetMachine</span><span class="p">().</span><span class="n">getTLSModel</span><span class="p">(</span><span class="n">GV</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">model</span> <span class="o">==</span> <span class="n">TLSModel</span><span class="o">::</span><span class="n">GeneralDynamic</span> <span class="o">||</span> <span class="n">model</span> <span class="o">==</span> <span class="n">TLSModel</span><span class="o">::</span><span class="n">LocalDynamic</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// General Dynamic and Local Dynamic TLS Model.</span>
    <span class="kt">unsigned</span> <span class="n">Flag</span> <span class="o">=</span> <span class="p">(</span><span class="n">model</span> <span class="o">==</span> <span class="n">TLSModel</span><span class="o">::</span><span class="n">LocalDynamic</span><span class="p">)</span> <span class="o">?</span> <span class="n">Cpu0II</span><span class="o">::</span><span class="n">MO_TLSLDM</span>
                                                      <span class="o">:</span> <span class="n">Cpu0II</span><span class="o">::</span><span class="n">MO_TLSGD</span><span class="p">;</span>

    <span class="n">SDValue</span> <span class="n">TGA</span> <span class="o">=</span> <span class="n">DAG</span><span class="p">.</span><span class="n">getTargetGlobalAddress</span><span class="p">(</span><span class="n">GV</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">PtrVT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">Flag</span><span class="p">);</span>
    <span class="n">SDValue</span> <span class="n">Argument</span> <span class="o">=</span> <span class="n">DAG</span><span class="p">.</span><span class="n">getNode</span><span class="p">(</span><span class="n">Cpu0ISD</span><span class="o">::</span><span class="n">Wrapper</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">PtrVT</span><span class="p">,</span>
                                   <span class="n">getGlobalReg</span><span class="p">(</span><span class="n">DAG</span><span class="p">,</span> <span class="n">PtrVT</span><span class="p">),</span> <span class="n">TGA</span><span class="p">);</span>
    <span class="kt">unsigned</span> <span class="n">PtrSize</span> <span class="o">=</span> <span class="n">PtrVT</span><span class="p">.</span><span class="n">getSizeInBits</span><span class="p">();</span>
    <span class="n">IntegerType</span> <span class="o">*</span><span class="n">PtrTy</span> <span class="o">=</span> <span class="n">Type</span><span class="o">::</span><span class="n">getIntNTy</span><span class="p">(</span><span class="o">*</span><span class="n">DAG</span><span class="p">.</span><span class="n">getContext</span><span class="p">(),</span> <span class="n">PtrSize</span><span class="p">);</span>

    <span class="n">SDValue</span> <span class="n">TlsGetAddr</span> <span class="o">=</span> <span class="n">DAG</span><span class="p">.</span><span class="n">getExternalSymbol</span><span class="p">(</span><span class="s">&quot;__tls_get_addr&quot;</span><span class="p">,</span> <span class="n">PtrVT</span><span class="p">);</span>

    <span class="n">ArgListTy</span> <span class="n">Args</span><span class="p">;</span>
    <span class="n">ArgListEntry</span> <span class="n">Entry</span><span class="p">;</span>
    <span class="n">Entry</span><span class="p">.</span><span class="n">Node</span> <span class="o">=</span> <span class="n">Argument</span><span class="p">;</span>
    <span class="n">Entry</span><span class="p">.</span><span class="n">Ty</span> <span class="o">=</span> <span class="n">PtrTy</span><span class="p">;</span>
    <span class="n">Args</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">Entry</span><span class="p">);</span>

    <span class="n">TargetLowering</span><span class="o">::</span><span class="n">CallLoweringInfo</span> <span class="n">CLI</span><span class="p">(</span><span class="n">DAG</span><span class="p">);</span>
    <span class="n">CLI</span><span class="p">.</span><span class="n">setDebugLoc</span><span class="p">(</span><span class="n">DL</span><span class="p">).</span><span class="n">setChain</span><span class="p">(</span><span class="n">DAG</span><span class="p">.</span><span class="n">getEntryNode</span><span class="p">())</span>
      <span class="p">.</span><span class="n">setCallee</span><span class="p">(</span><span class="n">CallingConv</span><span class="o">::</span><span class="n">C</span><span class="p">,</span> <span class="n">PtrTy</span><span class="p">,</span> <span class="n">TlsGetAddr</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">Args</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">SDValue</span><span class="p">,</span> <span class="n">SDValue</span><span class="o">&gt;</span> <span class="n">CallResult</span> <span class="o">=</span> <span class="n">LowerCallTo</span><span class="p">(</span><span class="n">CLI</span><span class="p">);</span>

    <span class="n">SDValue</span> <span class="n">Ret</span> <span class="o">=</span> <span class="n">CallResult</span><span class="p">.</span><span class="n">first</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">model</span> <span class="o">!=</span> <span class="n">TLSModel</span><span class="o">::</span><span class="n">LocalDynamic</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">Ret</span><span class="p">;</span>

    <span class="n">SDValue</span> <span class="n">TGAHi</span> <span class="o">=</span> <span class="n">DAG</span><span class="p">.</span><span class="n">getTargetGlobalAddress</span><span class="p">(</span><span class="n">GV</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">PtrVT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                                               <span class="n">Cpu0II</span><span class="o">::</span><span class="n">MO_DTP_HI</span><span class="p">);</span>
    <span class="n">SDValue</span> <span class="n">Hi</span> <span class="o">=</span> <span class="n">DAG</span><span class="p">.</span><span class="n">getNode</span><span class="p">(</span><span class="n">Cpu0ISD</span><span class="o">::</span><span class="n">Hi</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">PtrVT</span><span class="p">,</span> <span class="n">TGAHi</span><span class="p">);</span>
    <span class="n">SDValue</span> <span class="n">TGALo</span> <span class="o">=</span> <span class="n">DAG</span><span class="p">.</span><span class="n">getTargetGlobalAddress</span><span class="p">(</span><span class="n">GV</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">PtrVT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                                               <span class="n">Cpu0II</span><span class="o">::</span><span class="n">MO_DTP_LO</span><span class="p">);</span>
    <span class="n">SDValue</span> <span class="n">Lo</span> <span class="o">=</span> <span class="n">DAG</span><span class="p">.</span><span class="n">getNode</span><span class="p">(</span><span class="n">Cpu0ISD</span><span class="o">::</span><span class="n">Lo</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">PtrVT</span><span class="p">,</span> <span class="n">TGALo</span><span class="p">);</span>
    <span class="n">SDValue</span> <span class="n">Add</span> <span class="o">=</span> <span class="n">DAG</span><span class="p">.</span><span class="n">getNode</span><span class="p">(</span><span class="n">ISD</span><span class="o">::</span><span class="n">ADD</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">PtrVT</span><span class="p">,</span> <span class="n">Hi</span><span class="p">,</span> <span class="n">Ret</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">DAG</span><span class="p">.</span><span class="n">getNode</span><span class="p">(</span><span class="n">ISD</span><span class="o">::</span><span class="n">ADD</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">PtrVT</span><span class="p">,</span> <span class="n">Add</span><span class="p">,</span> <span class="n">Lo</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">SDValue</span> <span class="n">Offset</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">model</span> <span class="o">==</span> <span class="n">TLSModel</span><span class="o">::</span><span class="n">InitialExec</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Initial Exec TLS Model</span>
    <span class="n">SDValue</span> <span class="n">TGA</span> <span class="o">=</span> <span class="n">DAG</span><span class="p">.</span><span class="n">getTargetGlobalAddress</span><span class="p">(</span><span class="n">GV</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">PtrVT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                                             <span class="n">Cpu0II</span><span class="o">::</span><span class="n">MO_GOTTPREL</span><span class="p">);</span>
    <span class="n">TGA</span> <span class="o">=</span> <span class="n">DAG</span><span class="p">.</span><span class="n">getNode</span><span class="p">(</span><span class="n">Cpu0ISD</span><span class="o">::</span><span class="n">Wrapper</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">PtrVT</span><span class="p">,</span> <span class="n">getGlobalReg</span><span class="p">(</span><span class="n">DAG</span><span class="p">,</span> <span class="n">PtrVT</span><span class="p">),</span>
                      <span class="n">TGA</span><span class="p">);</span>
    <span class="n">Offset</span> <span class="o">=</span> <span class="n">DAG</span><span class="p">.</span><span class="n">getLoad</span><span class="p">(</span><span class="n">PtrVT</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span>
                         <span class="n">DAG</span><span class="p">.</span><span class="n">getEntryNode</span><span class="p">(),</span> <span class="n">TGA</span><span class="p">,</span> <span class="n">MachinePointerInfo</span><span class="p">(),</span>
                         <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// Local Exec TLS Model</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">model</span> <span class="o">==</span> <span class="n">TLSModel</span><span class="o">::</span><span class="n">LocalExec</span><span class="p">);</span>
    <span class="n">SDValue</span> <span class="n">TGAHi</span> <span class="o">=</span> <span class="n">DAG</span><span class="p">.</span><span class="n">getTargetGlobalAddress</span><span class="p">(</span><span class="n">GV</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">PtrVT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                                               <span class="n">Cpu0II</span><span class="o">::</span><span class="n">MO_TP_HI</span><span class="p">);</span>
    <span class="n">SDValue</span> <span class="n">TGALo</span> <span class="o">=</span> <span class="n">DAG</span><span class="p">.</span><span class="n">getTargetGlobalAddress</span><span class="p">(</span><span class="n">GV</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">PtrVT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                                               <span class="n">Cpu0II</span><span class="o">::</span><span class="n">MO_TP_LO</span><span class="p">);</span>
    <span class="n">SDValue</span> <span class="n">Hi</span> <span class="o">=</span> <span class="n">DAG</span><span class="p">.</span><span class="n">getNode</span><span class="p">(</span><span class="n">Cpu0ISD</span><span class="o">::</span><span class="n">Hi</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">PtrVT</span><span class="p">,</span> <span class="n">TGAHi</span><span class="p">);</span>
    <span class="n">SDValue</span> <span class="n">Lo</span> <span class="o">=</span> <span class="n">DAG</span><span class="p">.</span><span class="n">getNode</span><span class="p">(</span><span class="n">Cpu0ISD</span><span class="o">::</span><span class="n">Lo</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">PtrVT</span><span class="p">,</span> <span class="n">TGALo</span><span class="p">);</span>
    <span class="n">Offset</span> <span class="o">=</span> <span class="n">DAG</span><span class="p">.</span><span class="n">getNode</span><span class="p">(</span><span class="n">ISD</span><span class="o">::</span><span class="n">ADD</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">PtrVT</span><span class="p">,</span> <span class="n">Hi</span><span class="p">,</span> <span class="n">Lo</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">Offset</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter12_1/Cpu0SelLowering.h</p>
<div class="highlight-c++"><div class="highlight"><pre>    <span class="n">MachineBasicBlock</span> <span class="o">*</span>
    <span class="n">EmitInstrWithCustomInserter</span><span class="p">(</span><span class="n">MachineInstr</span> <span class="o">*</span><span class="n">MI</span><span class="p">,</span>
                                <span class="n">MachineBasicBlock</span> <span class="o">*</span><span class="n">MBB</span><span class="p">)</span> <span class="k">const</span> <span class="n">override</span><span class="p">;</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter12_1/Cpu0MCInstLower.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">MCOperand</span> <span class="n">Cpu0MCInstLower</span><span class="o">::</span><span class="n">LowerSymbolOperand</span><span class="p">(</span><span class="k">const</span> <span class="n">MachineOperand</span> <span class="o">&amp;</span><span class="n">MO</span><span class="p">,</span>
                                              <span class="n">MachineOperandType</span> <span class="n">MOTy</span><span class="p">,</span>
                                              <span class="kt">unsigned</span> <span class="n">Offset</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="n">MCSymbolRefExpr</span><span class="o">::</span><span class="n">VariantKind</span> <span class="n">Kind</span><span class="p">;</span>
  <span class="k">const</span> <span class="n">MCSymbol</span> <span class="o">*</span><span class="n">Symbol</span><span class="p">;</span>

  <span class="k">switch</span><span class="p">(</span><span class="n">MO</span><span class="p">.</span><span class="n">getTargetFlags</span><span class="p">())</span> <span class="p">{</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="k">case</span> <span class="n">Cpu0II</span>:<span class="o">:</span><span class="n">MO_TLSGD</span><span class="o">:</span>     <span class="n">Kind</span> <span class="o">=</span> <span class="n">MCSymbolRefExpr</span><span class="o">::</span><span class="n">VK_Cpu0_TLSGD</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">Cpu0II</span>:<span class="o">:</span><span class="n">MO_TLSLDM</span><span class="o">:</span>    <span class="n">Kind</span> <span class="o">=</span> <span class="n">MCSymbolRefExpr</span><span class="o">::</span><span class="n">VK_Cpu0_TLSLDM</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">Cpu0II</span>:<span class="o">:</span><span class="n">MO_DTP_HI</span><span class="o">:</span>    <span class="n">Kind</span> <span class="o">=</span> <span class="n">MCSymbolRefExpr</span><span class="o">::</span><span class="n">VK_Cpu0_DTP_HI</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">Cpu0II</span>:<span class="o">:</span><span class="n">MO_DTP_LO</span><span class="o">:</span>    <span class="n">Kind</span> <span class="o">=</span> <span class="n">MCSymbolRefExpr</span><span class="o">::</span><span class="n">VK_Cpu0_DTP_LO</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">Cpu0II</span>:<span class="o">:</span><span class="n">MO_GOTTPREL</span><span class="o">:</span>  <span class="n">Kind</span> <span class="o">=</span> <span class="n">MCSymbolRefExpr</span><span class="o">::</span><span class="n">VK_Cpu0_GOTTPREL</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">Cpu0II</span>:<span class="o">:</span><span class="n">MO_TP_HI</span><span class="o">:</span>     <span class="n">Kind</span> <span class="o">=</span> <span class="n">MCSymbolRefExpr</span><span class="o">::</span><span class="n">VK_Cpu0_TP_HI</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">Cpu0II</span>:<span class="o">:</span><span class="n">MO_TP_LO</span><span class="o">:</span>     <span class="n">Kind</span> <span class="o">=</span> <span class="n">MCSymbolRefExpr</span><span class="o">::</span><span class="n">VK_Cpu0_TP_LO</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="p">...</span>
  <span class="p">}</span>
  <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-bash"><div class="highlight"><pre>JonathantekiiMac:input Jonathan<span class="nv">$ </span>clang -target mips-unknown-linux-gnu -c
ch12_thread_var.cpp -emit-llvm -std<span class="o">=</span>c++11 -o ch12_thread_var.bc
JonathantekiiMac:input Jonathan<span class="nv">$ </span>/Users/Jonathan/llvm/test/cmake_debug_build/
Debug/bin/llvm-dis ch12_thread_var.bc -o -
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>; ModuleID = &#39;ch12_thread_var.bc&#39;
target datalayout = &quot;E-m:m-p:32:32-i8:8:32-i16:16:32-i64:64-n32-S64&quot;
target triple = &quot;mips-unknown-linux-gnu&quot;

@a = thread_local global i32 0, align 4
@b = thread_local global i32 0, align 4

; Function Attrs: nounwind
define i32 @_Z15test_thread_varv() #0 {
  store i32 2, i32* @a, align 4
  %1 = load i32, i32* @a, align 4
  ret i32 %1
}

define i32 @_Z17test_thread_var_2v() #1 {
  %1 = call i32* @_ZTW1b()
  store i32 3, i32* %1, align 4
  %2 = call i32* @_ZTW1b()
  %3 = load i32, i32* %2, align 4
  ret i32 %3
}

define weak_odr hidden i32* @_ZTW1b() {
  ret i32* @b
}

attributes #0 = { nounwind &quot;disable-tail-calls&quot;=&quot;false&quot; &quot;less-precise-fpmad&quot;=&quot;fa
lse&quot; &quot;no-frame-pointer-elim&quot;=&quot;true&quot; &quot;no-frame-pointer-elim-non-leaf&quot; &quot;no-infs-fp
-math&quot;=&quot;false&quot; &quot;no-nans-fp-math&quot;=&quot;false&quot; &quot;stack-protector-buffer-size&quot;=&quot;8&quot; &quot;targ
et-cpu&quot;=&quot;mips32r2&quot; &quot;target-features&quot;=&quot;+mips32r2&quot; &quot;unsafe-fp-math&quot;=&quot;false&quot; &quot;use-s
oft-float&quot;=&quot;false&quot; }
attributes #1 = { &quot;disable-tail-calls&quot;=&quot;false&quot; &quot;less-precise-fpmad&quot;=&quot;false&quot; &quot;no-
frame-pointer-elim&quot;=&quot;true&quot; &quot;no-frame-pointer-elim-non-leaf&quot; &quot;no-infs-fp-math&quot;=&quot;f
alse&quot; &quot;no-nans-fp-math&quot;=&quot;false&quot; &quot;stack-protector-buffer-size&quot;=&quot;8&quot; &quot;target-cpu&quot;=&quot;
mips32r2&quot; &quot;target-features&quot;=&quot;+mips32r2&quot; &quot;unsafe-fp-math&quot;=&quot;false&quot; &quot;use-soft-float
&quot;=&quot;false&quot; }

!llvm.ident = !{!0}

!0 = !{!&quot;clang version 3.7.0 (tags/RELEASE_370/final)&quot;}
</pre></div>
</div>
<div class="highlight-bash"><div class="highlight"><pre>JonathantekiiMac:input Jonathan<span class="nv">$ </span>/Users/Jonathan/llvm/test/cmake_debug_build/
Debug/bin/llc -march<span class="o">=</span>cpu0 -relocation-model<span class="o">=</span>pic -filetype<span class="o">=</span>asm ch12_thread_var.bc
-o -
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>  .text
  .section .mdebug.abiO32
  .previous
  .file  &quot;ch12_thread_var.bc&quot;
  .globl  _Z15test_thread_varv
  .align  2
  .type  _Z15test_thread_varv,@function
  .ent  _Z15test_thread_varv    # @_Z15test_thread_varv
_Z15test_thread_varv:
  .frame  $fp,16,$lr
  .mask   0x00005000,-4
  .set  noreorder
  .cpload  $t9
  .set  nomacro
# BB#0:
  addiu  $sp, $sp, -16
  st  $lr, 12($sp)            # 4-byte Folded Spill
  st  $fp, 8($sp)             # 4-byte Folded Spill
  move   $fp, $sp
  .cprestore  8
  ld  $t9, %call16(__tls_get_addr)($gp)
  ori  $4, $gp, %tlsgd(a)
  jalr  $t9
  nop
  ld  $gp, 8($fp)
  addiu  $3, $zero, 2
  st  $3, 0($2)
  addu  $2, $zero, $3
  move   $sp, $fp
  ld  $fp, 8($sp)             # 4-byte Folded Reload
  ld  $lr, 12($sp)            # 4-byte Folded Reload
  addiu  $sp, $sp, 16
  ret  $lr
  nop
  .set  macro
  .set  reorder
  .end  _Z15test_thread_varv
$func_end0:
  .size  _Z15test_thread_varv, ($func_end0)-_Z15test_thread_varv

  .globl  _Z17test_thread_var_2v
  .align  2
  .type  _Z17test_thread_var_2v,@function
  .ent  _Z17test_thread_var_2v  # @_Z17test_thread_var_2v
_Z17test_thread_var_2v:
  .cfi_startproc
  .frame  $fp,16,$lr
  .mask   0x00005000,-4
  .set  noreorder
  .cpload  $t9
  .set  nomacro
# BB#0:
  addiu  $sp, $sp, -16
$tmp0:
  .cfi_def_cfa_offset 16
  st  $lr, 12($sp)            # 4-byte Folded Spill
  st  $fp, 8($sp)             # 4-byte Folded Spill
$tmp1:
  .cfi_offset 14, -4
$tmp2:
  .cfi_offset 12, -8
  move   $fp, $sp
$tmp3:
  .cfi_def_cfa_register 12
  .cprestore  8
  ld  $t9, %call16(_ZTW1b)($gp)
  jalr  $t9
  nop
  ld  $gp, 8($fp)
  addiu  $3, $zero, 3
  st  $3, 0($2)
  ld  $t9, %call16(_ZTW1b)($gp)
  jalr  $t9
  nop
  ld  $gp, 8($fp)
  ld  $2, 0($2)
  move   $sp, $fp
  ld  $fp, 8($sp)             # 4-byte Folded Reload
  ld  $lr, 12($sp)            # 4-byte Folded Reload
  addiu  $sp, $sp, 16
  ret  $lr
  nop
  .set  macro
  .set  reorder
  .end  _Z17test_thread_var_2v
$func_end1:
  .size  _Z17test_thread_var_2v, ($func_end1)-_Z17test_thread_var_2v
  .cfi_endproc

  .hidden  _ZTW1b
  .weak  _ZTW1b
  .align  2
  .type  _ZTW1b,@function
  .ent  _ZTW1b                  # @_ZTW1b
_ZTW1b:
  .cfi_startproc
  .frame  $sp,16,$lr
  .mask   0x00004000,-4
  .set  noreorder
  .cpload  $t9
  .set  nomacro
# BB#0:
  addiu  $sp, $sp, -16
$tmp4:
  .cfi_def_cfa_offset 16
  st  $lr, 12($sp)            # 4-byte Folded Spill
$tmp5:
  .cfi_offset 14, -4
  .cprestore  8
  ld  $t9, %call16(__tls_get_addr)($gp)
  ori  $4, $gp, %tlsgd(b)
  jalr  $t9
  nop
  ld  $gp, 8($sp)
  ld  $lr, 12($sp)            # 4-byte Folded Reload
  addiu  $sp, $sp, 16
  ret  $lr
  nop
  .set  macro
  .set  reorder
  .end  _ZTW1b
$func_end2:
  .size  _ZTW1b, ($func_end2)-_ZTW1b
  .cfi_endproc

  .type  a,@object               # @a
  .section  .tbss,&quot;awT&quot;,@nobits
  .globl  a
  .align  2
a:
  .4byte  0                       # 0x0
  .size  a, 4

  .type  b,@object               # @b
  .globl  b
  .align  2
b:
  .4byte  0                       # 0x0
  .size  b, 4
</pre></div>
</div>
<p>In pic mode, the __thread variable access by call function __tls_get_addr with
the address of thread variable.
The c++11 standard thread_local variable is accessed by call function _ZTW1b
which call the function __tls_get_addr too to get the thread_local variable
address.
In static mode, the thread variable is accessed by machine instructions as follows,</p>
<div class="highlight-bash"><div class="highlight"><pre>JonathantekiiMac:input Jonathan<span class="nv">$ </span>/Users/Jonathan/llvm/test/cmake_debug_build/
Debug/bin/llc -march<span class="o">=</span>cpu0 -relocation-model<span class="o">=</span>static -filetype<span class="o">=</span>asm
ch12_thread_var.bc -o -
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>  .text
  .section .mdebug.abiO32
  .previous
  .file  &quot;ch12_thread_var.bc&quot;
  .globl  _Z15test_thread_varv
  .align  2
  .type  _Z15test_thread_varv,@function
  .ent  _Z15test_thread_varv    # @_Z15test_thread_varv
_Z15test_thread_varv:
  .frame  $fp,8,$lr
  .mask   0x00001000,-4
  .set  noreorder
  .set  nomacro
# BB#0:
  addiu  $sp, $sp, -8
  st  $fp, 4($sp)             # 4-byte Folded Spill
  move   $fp, $sp
  ori  $2, $zero, %tp_lo(a)
  lui  $3, %tp_hi(a)
  addu  $3, $3, $2
  addiu  $2, $zero, 2
  st  $2, 0($3)
  move   $sp, $fp
  ld  $fp, 4($sp)             # 4-byte Folded Reload
  addiu  $sp, $sp, 8
  ret  $lr
  nop
  .set  macro
  .set  reorder
  .end  _Z15test_thread_varv
$func_end0:
  .size  _Z15test_thread_varv, ($func_end0)-_Z15test_thread_varv

  .globl  _Z17test_thread_var_2v
  .align  2
  .type  _Z17test_thread_var_2v,@function
  .ent  _Z17test_thread_var_2v  # @_Z17test_thread_var_2v
_Z17test_thread_var_2v:
  .cfi_startproc
  .frame  $fp,16,$lr
  .mask   0x00005000,-4
  .set  noreorder
  .set  nomacro
# BB#0:
  addiu  $sp, $sp, -16
$tmp0:
  .cfi_def_cfa_offset 16
  st  $lr, 12($sp)            # 4-byte Folded Spill
  st  $fp, 8($sp)             # 4-byte Folded Spill
$tmp1:
  .cfi_offset 14, -4
$tmp2:
  .cfi_offset 12, -8
  move   $fp, $sp
$tmp3:
  .cfi_def_cfa_register 12
  jsub  _ZTW1b
  nop
  addiu  $3, $zero, 3
  st  $3, 0($2)
  jsub  _ZTW1b
  nop
  ld  $2, 0($2)
  move   $sp, $fp
  ld  $fp, 8($sp)             # 4-byte Folded Reload
  ld  $lr, 12($sp)            # 4-byte Folded Reload
  addiu  $sp, $sp, 16
  ret  $lr
  nop
  .set  macro
  .set  reorder
  .end  _Z17test_thread_var_2v
$func_end1:
  .size  _Z17test_thread_var_2v, ($func_end1)-_Z17test_thread_var_2v
  .cfi_endproc

  .hidden  _ZTW1b
  .weak  _ZTW1b
  .align  2
  .type  _ZTW1b,@function
  .ent  _ZTW1b                  # @_ZTW1b
_ZTW1b:
  .cfi_startproc
  .frame  $sp,0,$lr
  .mask   0x00000000,0
  .set  noreorder
  .set  nomacro
# BB#0:
  ori  $2, $zero, %tp_lo(b)
  lui  $3, %tp_hi(b)
  addu  $2, $3, $2
  ret  $lr
  nop
  .set  macro
  .set  reorder
  .end  _ZTW1b
$func_end2:
  .size  _ZTW1b, ($func_end2)-_ZTW1b
  .cfi_endproc

  .type  a,@object               # @a
  .section  .tbss,&quot;awT&quot;,@nobits
  .globl  a
  .align  2
a:
  .4byte  0                       # 0x0
  .size  a, 4

  .type  b,@object               # @b
  .globl  b
  .align  2
b:
  .4byte  0                       # 0x0
  .size  b, 4
</pre></div>
</div>
<p>While Mips uses rdhwr instruction to access thread varaible as below,
Cpu0 access thread varaible without inventing any new instruction.
The thread variables are keeped in thread varaible memory location which
accessed through %tp_hi and %tp_lo. Furthermore, this section of memory is
protected through kernel mode program.
As a result, the user mode program cannot access this area of memory and
no space to breathe for hack program.</p>
<div class="highlight-bash"><div class="highlight"><pre>JonathantekiiMac:input Jonathan<span class="nv">$ </span>/Users/Jonathan/llvm/test/cmake_debug_build/
Debug/bin/llc -march<span class="o">=</span>mips -relocation-model<span class="o">=</span>static -filetype<span class="o">=</span>asm
ch12_thread_var.bc -o -
  ...
  lui <span class="nv">$1</span>, %tprel_hi<span class="o">(</span>a<span class="o">)</span>
  ori <span class="nv">$1</span>, <span class="nv">$1</span>, %tprel_lo<span class="o">(</span>a<span class="o">)</span>
  .set  push
  .set  mips32r2
  rdhwr <span class="nv">$3</span>, <span class="nv">$29</span>
  .set  pop
  addu  <span class="nv">$1</span>, <span class="nv">$3</span>, <span class="nv">$1</span>
  addiu <span class="nv">$2</span>, <span class="nv">$zero</span>, 2
  sw  <span class="nv">$2</span>, 0<span class="o">(</span><span class="nv">$1</span><span class="o">)</span>
  addiu <span class="nv">$2</span>, <span class="nv">$zero</span>, 2
  ...
</pre></div>
</div>
<p>In static mode, the thread variable is similar to global variable.
In general, they are same in IRs, DAGs and machine code translation.
List them in the following tables.
You can check them with debug option enabled.</p>
<table border="1" class="docutils">
<caption>The DAGs of thread varaible of static mode</caption>
<colgroup>
<col width="46%" />
<col width="54%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">stage</th>
<th class="head">DAG</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>IR</td>
<td>load i32* &#64;a, align 4;</td>
</tr>
<tr class="row-odd"><td>Legalized selection DAG</td>
<td>(add Cpu0ISD::Hi Cpu0ISD::Lo);</td>
</tr>
<tr class="row-even"><td>Instruction Selection</td>
<td>ori $2, $zero, %tp_lo(a);</td>
</tr>
<tr class="row-odd"><td><ul class="first last simple">
<li></li>
</ul>
</td>
<td>lui $3, %tp_hi(a);</td>
</tr>
<tr class="row-even"><td><ul class="first last simple">
<li></li>
</ul>
</td>
<td>addu  $3, $3, $2;</td>
</tr>
</tbody>
</table>
<table border="1" class="docutils">
<caption>The DAGs of local_thread varaible of static mode</caption>
<colgroup>
<col width="42%" />
<col width="58%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">stage</th>
<th class="head">DAG</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>IR</td>
<td>ret i32* &#64;b;</td>
</tr>
<tr class="row-odd"><td>Legalized selection DAG</td>
<td>%0=(add Cpu0ISD::Hi Cpu0ISD::Lo);...</td>
</tr>
<tr class="row-even"><td>Instruction Selection</td>
<td>ori $2, $zero, %tp_lo(a);</td>
</tr>
<tr class="row-odd"><td><ul class="first last simple">
<li></li>
</ul>
</td>
<td>lui $3, %tp_hi(a);</td>
</tr>
<tr class="row-even"><td><ul class="first last simple">
<li></li>
</ul>
</td>
<td>addu  $3, $3, $2;</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="atomic">
<h2><a class="toc-backref" href="#id10">Atomic</a><a class="headerlink" href="#atomic" title="Permalink to this headline">¶</a></h2>
<p>In tradition, C use different API which provided by OS or library to support
multi-thread programming. For example, posix thread API on unix/linux, MS
windows API, ..., etc. In order to achieve synchronization to solve race
condition between threads, OS provide their own lock or semaphore functions to
programmer. But this solution is OS dependent.
After c++11, programmer can use atomic to program and run the code
on every different platform since the thread and atomic are part of c++ standard.
Beside of portability, the other important benifit is the compiler can generate
high performance code by the target hardware instruction rather than couting on
lock() function only <a class="footnote-reference" href="#atomic-wiki" id="id3">[3]</a> <a class="footnote-reference" href="#atomic-stackoverflow" id="id4">[4]</a>
<a class="footnote-reference" href="#atomic-herbsutter" id="id5">[5]</a>.</p>
<p>In order to support atomic in C++ and java, llvm provides the atomic IRs here
<a class="footnote-reference" href="#atomics-llvm" id="id6">[6]</a> <a class="footnote-reference" href="#llvmlang-ordering" id="id7">[7]</a>.</p>
<p>To support llvm atomic IRs, the following code added to Chapter12_1.</p>
<p class="rubric">lbdex/chapters/Chapter12_1/AsmParser/Cpu0AsmParser.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">MCSymbolRefExpr</span><span class="o">::</span><span class="n">VariantKind</span> <span class="n">Cpu0AsmParser</span><span class="o">::</span><span class="n">getVariantKind</span><span class="p">(</span><span class="n">StringRef</span> <span class="n">Symbol</span><span class="p">)</span> <span class="p">{</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>    <span class="p">.</span><span class="n">Case</span><span class="p">(</span><span class="s">&quot;tlsgd&quot;</span><span class="p">,</span>       <span class="n">MCSymbolRefExpr</span><span class="o">::</span><span class="n">VK_Cpu0_TLSGD</span><span class="p">)</span>
    <span class="p">.</span><span class="n">Case</span><span class="p">(</span><span class="s">&quot;tlsldm&quot;</span><span class="p">,</span>      <span class="n">MCSymbolRefExpr</span><span class="o">::</span><span class="n">VK_Cpu0_TLSLDM</span><span class="p">)</span>
    <span class="p">.</span><span class="n">Case</span><span class="p">(</span><span class="s">&quot;dtp_hi&quot;</span><span class="p">,</span>      <span class="n">MCSymbolRefExpr</span><span class="o">::</span><span class="n">VK_Cpu0_DTP_HI</span><span class="p">)</span>
    <span class="p">.</span><span class="n">Case</span><span class="p">(</span><span class="s">&quot;dtp_lo&quot;</span><span class="p">,</span>      <span class="n">MCSymbolRefExpr</span><span class="o">::</span><span class="n">VK_Cpu0_DTP_LO</span><span class="p">)</span>
    <span class="p">.</span><span class="n">Case</span><span class="p">(</span><span class="s">&quot;gottp&quot;</span><span class="p">,</span>       <span class="n">MCSymbolRefExpr</span><span class="o">::</span><span class="n">VK_Cpu0_GOTTPREL</span><span class="p">)</span>
    <span class="p">.</span><span class="n">Case</span><span class="p">(</span><span class="s">&quot;tp_hi&quot;</span><span class="p">,</span>       <span class="n">MCSymbolRefExpr</span><span class="o">::</span><span class="n">VK_Cpu0_TP_HI</span><span class="p">)</span>
    <span class="p">.</span><span class="n">Case</span><span class="p">(</span><span class="s">&quot;tp_lo&quot;</span><span class="p">,</span>       <span class="n">MCSymbolRefExpr</span><span class="o">::</span><span class="n">VK_Cpu0_TP_LO</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter12_1/Disassembler/Cpu0Disassembler.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="k">static</span> <span class="n">DecodeStatus</span> <span class="nf">DecodeMem</span><span class="p">(</span><span class="n">MCInst</span> <span class="o">&amp;</span><span class="n">Inst</span><span class="p">,</span>
                              <span class="kt">unsigned</span> <span class="n">Insn</span><span class="p">,</span>
                              <span class="kt">uint64_t</span> <span class="n">Address</span><span class="p">,</span>
                              <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">Decoder</span><span class="p">)</span> <span class="p">{</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="k">if</span><span class="p">(</span><span class="n">Inst</span><span class="p">.</span><span class="n">getOpcode</span><span class="p">()</span> <span class="o">==</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">SC</span><span class="p">){</span>
    <span class="n">Inst</span><span class="p">.</span><span class="n">addOperand</span><span class="p">(</span><span class="n">MCOperand</span><span class="o">::</span><span class="n">createReg</span><span class="p">(</span><span class="n">Reg</span><span class="p">));</span>
  <span class="p">}</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter12_1/Cpu0InstrInfo.td</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">def</span> <span class="n">SDT_Sync</span>             <span class="o">:</span> <span class="n">SDTypeProfile</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="n">SDTCisVT</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">,</span> <span class="n">i32</span><span class="o">&gt;</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">def</span> <span class="n">Cpu0Sync</span> <span class="o">:</span> <span class="n">SDNode</span><span class="o">&lt;</span><span class="s">&quot;Cpu0ISD::Sync&quot;</span><span class="p">,</span> <span class="n">SDT_Sync</span><span class="p">,</span> <span class="p">[</span><span class="n">SDNPHasChain</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">def</span> <span class="n">PtrRC</span> <span class="o">:</span> <span class="n">Operand</span><span class="o">&lt;</span><span class="n">iPTR</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="n">let</span> <span class="n">MIOperandInfo</span> <span class="o">=</span> <span class="p">(</span><span class="n">ops</span> <span class="n">ptr_rc</span><span class="p">);</span>
  <span class="n">let</span> <span class="n">DecoderMethod</span> <span class="o">=</span> <span class="s">&quot;DecodeCPURegsRegisterClass&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>// Atomic instructions with 2 source operands (ATOMIC_SWAP &amp; ATOMIC_LOAD_*).
class Atomic2Ops&lt;PatFrag Op, RegisterClass DRC&gt; :
  PseudoSE&lt;(outs DRC:$dst), (ins PtrRC:$ptr, DRC:$incr),
           [(set DRC:$dst, (Op iPTR:$ptr, DRC:$incr))]&gt;;

// Atomic Compare &amp; Swap.
class AtomicCmpSwap&lt;PatFrag Op, RegisterClass DRC&gt; :
  PseudoSE&lt;(outs DRC:$dst), (ins PtrRC:$ptr, DRC:$cmp, DRC:$swap),
           [(set DRC:$dst, (Op iPTR:$ptr, DRC:$cmp, DRC:$swap))]&gt;;
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>class LLBase&lt;bits&lt;8&gt; Opc, string opstring, RegisterClass RC, Operand Mem&gt; :
  FMem&lt;Opc, (outs RC:$ra), (ins Mem:$addr),
       !strconcat(opstring, &quot;\t$ra, $addr&quot;), [], IILoad&gt; {
  let mayLoad = 1;
}

class SCBase&lt;bits&lt;8&gt; Opc, string opstring, RegisterOperand RO, Operand Mem&gt; :
  FMem&lt;Opc, (outs RO:$dst), (ins RO:$ra, Mem:$addr),
       !strconcat(opstring, &quot;\t$ra, $addr&quot;), [], IIStore&gt; {
  let mayStore = 1;
  let Constraints = &quot;$ra = $dst&quot;;
}
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">let</span> <span class="n">Predicates</span> <span class="o">=</span> <span class="p">[</span><span class="n">Ch12_1</span><span class="p">]</span> <span class="n">in</span> <span class="p">{</span>
<span class="n">let</span> <span class="n">usesCustomInserter</span> <span class="o">=</span> <span class="mi">1</span> <span class="n">in</span> <span class="p">{</span>
  <span class="n">def</span> <span class="n">ATOMIC_LOAD_ADD_I8</span>   <span class="o">:</span> <span class="n">Atomic2Ops</span><span class="o">&lt;</span><span class="n">atomic_load_add_8</span><span class="p">,</span> <span class="n">CPURegs</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="n">def</span> <span class="n">ATOMIC_LOAD_ADD_I16</span>  <span class="o">:</span> <span class="n">Atomic2Ops</span><span class="o">&lt;</span><span class="n">atomic_load_add_16</span><span class="p">,</span> <span class="n">CPURegs</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="n">def</span> <span class="n">ATOMIC_LOAD_ADD_I32</span>  <span class="o">:</span> <span class="n">Atomic2Ops</span><span class="o">&lt;</span><span class="n">atomic_load_add_32</span><span class="p">,</span> <span class="n">CPURegs</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="n">def</span> <span class="n">ATOMIC_LOAD_SUB_I8</span>   <span class="o">:</span> <span class="n">Atomic2Ops</span><span class="o">&lt;</span><span class="n">atomic_load_sub_8</span><span class="p">,</span> <span class="n">CPURegs</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="n">def</span> <span class="n">ATOMIC_LOAD_SUB_I16</span>  <span class="o">:</span> <span class="n">Atomic2Ops</span><span class="o">&lt;</span><span class="n">atomic_load_sub_16</span><span class="p">,</span> <span class="n">CPURegs</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="n">def</span> <span class="n">ATOMIC_LOAD_SUB_I32</span>  <span class="o">:</span> <span class="n">Atomic2Ops</span><span class="o">&lt;</span><span class="n">atomic_load_sub_32</span><span class="p">,</span> <span class="n">CPURegs</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="n">def</span> <span class="n">ATOMIC_LOAD_AND_I8</span>   <span class="o">:</span> <span class="n">Atomic2Ops</span><span class="o">&lt;</span><span class="n">atomic_load_and_8</span><span class="p">,</span> <span class="n">CPURegs</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="n">def</span> <span class="n">ATOMIC_LOAD_AND_I16</span>  <span class="o">:</span> <span class="n">Atomic2Ops</span><span class="o">&lt;</span><span class="n">atomic_load_and_16</span><span class="p">,</span> <span class="n">CPURegs</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="n">def</span> <span class="n">ATOMIC_LOAD_AND_I32</span>  <span class="o">:</span> <span class="n">Atomic2Ops</span><span class="o">&lt;</span><span class="n">atomic_load_and_32</span><span class="p">,</span> <span class="n">CPURegs</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="n">def</span> <span class="n">ATOMIC_LOAD_OR_I8</span>    <span class="o">:</span> <span class="n">Atomic2Ops</span><span class="o">&lt;</span><span class="n">atomic_load_or_8</span><span class="p">,</span> <span class="n">CPURegs</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="n">def</span> <span class="n">ATOMIC_LOAD_OR_I16</span>   <span class="o">:</span> <span class="n">Atomic2Ops</span><span class="o">&lt;</span><span class="n">atomic_load_or_16</span><span class="p">,</span> <span class="n">CPURegs</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="n">def</span> <span class="n">ATOMIC_LOAD_OR_I32</span>   <span class="o">:</span> <span class="n">Atomic2Ops</span><span class="o">&lt;</span><span class="n">atomic_load_or_32</span><span class="p">,</span> <span class="n">CPURegs</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="n">def</span> <span class="n">ATOMIC_LOAD_XOR_I8</span>   <span class="o">:</span> <span class="n">Atomic2Ops</span><span class="o">&lt;</span><span class="n">atomic_load_xor_8</span><span class="p">,</span> <span class="n">CPURegs</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="n">def</span> <span class="n">ATOMIC_LOAD_XOR_I16</span>  <span class="o">:</span> <span class="n">Atomic2Ops</span><span class="o">&lt;</span><span class="n">atomic_load_xor_16</span><span class="p">,</span> <span class="n">CPURegs</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="n">def</span> <span class="n">ATOMIC_LOAD_XOR_I32</span>  <span class="o">:</span> <span class="n">Atomic2Ops</span><span class="o">&lt;</span><span class="n">atomic_load_xor_32</span><span class="p">,</span> <span class="n">CPURegs</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="n">def</span> <span class="n">ATOMIC_LOAD_NAND_I8</span>  <span class="o">:</span> <span class="n">Atomic2Ops</span><span class="o">&lt;</span><span class="n">atomic_load_nand_8</span><span class="p">,</span> <span class="n">CPURegs</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="n">def</span> <span class="n">ATOMIC_LOAD_NAND_I16</span> <span class="o">:</span> <span class="n">Atomic2Ops</span><span class="o">&lt;</span><span class="n">atomic_load_nand_16</span><span class="p">,</span> <span class="n">CPURegs</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="n">def</span> <span class="n">ATOMIC_LOAD_NAND_I32</span> <span class="o">:</span> <span class="n">Atomic2Ops</span><span class="o">&lt;</span><span class="n">atomic_load_nand_32</span><span class="p">,</span> <span class="n">CPURegs</span><span class="o">&gt;</span><span class="p">;</span>

  <span class="n">def</span> <span class="n">ATOMIC_SWAP_I8</span>       <span class="o">:</span> <span class="n">Atomic2Ops</span><span class="o">&lt;</span><span class="n">atomic_swap_8</span><span class="p">,</span> <span class="n">CPURegs</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="n">def</span> <span class="n">ATOMIC_SWAP_I16</span>      <span class="o">:</span> <span class="n">Atomic2Ops</span><span class="o">&lt;</span><span class="n">atomic_swap_16</span><span class="p">,</span> <span class="n">CPURegs</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="n">def</span> <span class="n">ATOMIC_SWAP_I32</span>      <span class="o">:</span> <span class="n">Atomic2Ops</span><span class="o">&lt;</span><span class="n">atomic_swap_32</span><span class="p">,</span> <span class="n">CPURegs</span><span class="o">&gt;</span><span class="p">;</span>

  <span class="n">def</span> <span class="n">ATOMIC_CMP_SWAP_I8</span>   <span class="o">:</span> <span class="n">AtomicCmpSwap</span><span class="o">&lt;</span><span class="n">atomic_cmp_swap_8</span><span class="p">,</span> <span class="n">CPURegs</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="n">def</span> <span class="n">ATOMIC_CMP_SWAP_I16</span>  <span class="o">:</span> <span class="n">AtomicCmpSwap</span><span class="o">&lt;</span><span class="n">atomic_cmp_swap_16</span><span class="p">,</span> <span class="n">CPURegs</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="n">def</span> <span class="n">ATOMIC_CMP_SWAP_I32</span>  <span class="o">:</span> <span class="n">AtomicCmpSwap</span><span class="o">&lt;</span><span class="n">atomic_cmp_swap_32</span><span class="p">,</span> <span class="n">CPURegs</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>let Predicates = [Ch12_1] in {
let hasSideEffects = 1 in
def SYNC : Cpu0Inst&lt;(outs), (ins i32imm:$stype), &quot;sync $stype&quot;,
                    [(Cpu0Sync imm:$stype)], NoItinerary, FrmOther&gt;
{
  bits&lt;5&gt; stype;
  let Opcode = 0x60;
  let Inst{25-11} = 0;
  let Inst{10-6} = stype;
  let Inst{5-0} = 0;
}
}
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">/// Load-linked, Store-conditional</span>
<span class="n">def</span> <span class="n">LL</span>      <span class="o">:</span> <span class="n">LLBase</span><span class="o">&lt;</span><span class="mh">0x61</span><span class="p">,</span> <span class="s">&quot;ll&quot;</span><span class="p">,</span> <span class="n">CPURegs</span><span class="p">,</span> <span class="n">mem</span><span class="o">&gt;</span><span class="p">;</span>
<span class="n">def</span> <span class="n">SC</span>      <span class="o">:</span> <span class="n">SCBase</span><span class="o">&lt;</span><span class="mh">0x62</span><span class="p">,</span> <span class="s">&quot;sc&quot;</span><span class="p">,</span> <span class="n">RegisterOperand</span><span class="o">&lt;</span><span class="n">CPURegs</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">mem</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">def</span> <span class="o">:</span> <span class="n">Cpu0InstAlias</span><span class="o">&lt;</span><span class="s">&quot;sync&quot;</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">SYNC</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">1</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter12_1/Cpu0SelLowering.h</p>
<div class="highlight-c++"><div class="highlight"><pre>    <span class="n">MachineBasicBlock</span> <span class="o">*</span>
    <span class="n">EmitInstrWithCustomInserter</span><span class="p">(</span><span class="n">MachineInstr</span> <span class="o">*</span><span class="n">MI</span><span class="p">,</span>
                                <span class="n">MachineBasicBlock</span> <span class="o">*</span><span class="n">MBB</span><span class="p">)</span> <span class="k">const</span> <span class="n">override</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>    <span class="n">SDValue</span> <span class="n">lowerATOMIC_FENCE</span><span class="p">(</span><span class="n">SDValue</span> <span class="n">Op</span><span class="p">,</span> <span class="n">SelectionDAG</span><span class="o">&amp;</span> <span class="n">DAG</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>    <span class="c1">/// Emit a sign-extension using shl/sra appropriately.</span>
    <span class="n">MachineBasicBlock</span> <span class="o">*</span><span class="n">emitSignExtendToI32InReg</span><span class="p">(</span><span class="n">MachineInstr</span> <span class="o">*</span><span class="n">MI</span><span class="p">,</span>
                                                <span class="n">MachineBasicBlock</span> <span class="o">*</span><span class="n">BB</span><span class="p">,</span>
                                                <span class="kt">unsigned</span> <span class="n">Size</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">DstReg</span><span class="p">,</span>
                                                <span class="kt">unsigned</span> <span class="n">SrcRec</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>
    <span class="n">MachineBasicBlock</span> <span class="o">*</span><span class="n">emitAtomicBinary</span><span class="p">(</span><span class="n">MachineInstr</span> <span class="o">*</span><span class="n">MI</span><span class="p">,</span> <span class="n">MachineBasicBlock</span> <span class="o">*</span><span class="n">BB</span><span class="p">,</span>
                    <span class="kt">unsigned</span> <span class="n">Size</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">BinOpcode</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">Nand</span> <span class="o">=</span> <span class="nb">false</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>
    <span class="n">MachineBasicBlock</span> <span class="o">*</span><span class="n">emitAtomicBinaryPartword</span><span class="p">(</span><span class="n">MachineInstr</span> <span class="o">*</span><span class="n">MI</span><span class="p">,</span>
                    <span class="n">MachineBasicBlock</span> <span class="o">*</span><span class="n">BB</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">Size</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">BinOpcode</span><span class="p">,</span>
                    <span class="kt">bool</span> <span class="n">Nand</span> <span class="o">=</span> <span class="nb">false</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>
    <span class="n">MachineBasicBlock</span> <span class="o">*</span><span class="n">emitAtomicCmpSwap</span><span class="p">(</span><span class="n">MachineInstr</span> <span class="o">*</span><span class="n">MI</span><span class="p">,</span>
                                  <span class="n">MachineBasicBlock</span> <span class="o">*</span><span class="n">BB</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">Size</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>
    <span class="n">MachineBasicBlock</span> <span class="o">*</span><span class="n">emitAtomicCmpSwapPartword</span><span class="p">(</span><span class="n">MachineInstr</span> <span class="o">*</span><span class="n">MI</span><span class="p">,</span>
                                  <span class="n">MachineBasicBlock</span> <span class="o">*</span><span class="n">BB</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">Size</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter12_1/Cpu0SelLowering.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">Cpu0TargetLowering</span><span class="o">::</span><span class="n">getTargetNodeName</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">Opcode</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="k">case</span> <span class="n">Cpu0ISD</span>:<span class="o">:</span><span class="n">Sync</span><span class="o">:</span>              <span class="k">return</span> <span class="s">&quot;Cpu0ISD::Sync&quot;</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">Cpu0TargetLowering</span><span class="o">::</span><span class="n">Cpu0TargetLowering</span><span class="p">(</span><span class="k">const</span> <span class="n">Cpu0TargetMachine</span> <span class="o">&amp;</span><span class="n">TM</span><span class="p">,</span>
                                       <span class="k">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">STI</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">TargetLowering</span><span class="p">(</span><span class="n">TM</span><span class="p">),</span> <span class="n">Subtarget</span><span class="p">(</span><span class="n">STI</span><span class="p">),</span> <span class="n">ABI</span><span class="p">(</span><span class="n">TM</span><span class="p">.</span><span class="n">getABI</span><span class="p">())</span> <span class="p">{</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="n">setOperationAction</span><span class="p">(</span><span class="n">ISD</span><span class="o">::</span><span class="n">ATOMIC_LOAD</span><span class="p">,</span>       <span class="n">MVT</span><span class="o">::</span><span class="n">i32</span><span class="p">,</span>    <span class="n">Expand</span><span class="p">);</span>
  <span class="n">setOperationAction</span><span class="p">(</span><span class="n">ISD</span><span class="o">::</span><span class="n">ATOMIC_LOAD</span><span class="p">,</span>       <span class="n">MVT</span><span class="o">::</span><span class="n">i64</span><span class="p">,</span>    <span class="n">Expand</span><span class="p">);</span>
  <span class="n">setOperationAction</span><span class="p">(</span><span class="n">ISD</span><span class="o">::</span><span class="n">ATOMIC_STORE</span><span class="p">,</span>      <span class="n">MVT</span><span class="o">::</span><span class="n">i32</span><span class="p">,</span>    <span class="n">Expand</span><span class="p">);</span>
  <span class="n">setOperationAction</span><span class="p">(</span><span class="n">ISD</span><span class="o">::</span><span class="n">ATOMIC_STORE</span><span class="p">,</span>      <span class="n">MVT</span><span class="o">::</span><span class="n">i64</span><span class="p">,</span>    <span class="n">Expand</span><span class="p">);</span>

  <span class="n">setInsertFencesForAtomic</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">SDValue</span> <span class="n">Cpu0TargetLowering</span><span class="o">::</span>
<span class="n">LowerOperation</span><span class="p">(</span><span class="n">SDValue</span> <span class="n">Op</span><span class="p">,</span> <span class="n">SelectionDAG</span> <span class="o">&amp;</span><span class="n">DAG</span><span class="p">)</span> <span class="k">const</span>
<span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">Op</span><span class="p">.</span><span class="n">getOpcode</span><span class="p">())</span>
  <span class="p">{</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="k">case</span> <span class="n">ISD</span>:<span class="o">:</span><span class="n">ATOMIC_FENCE</span><span class="o">:</span>       <span class="k">return</span> <span class="n">lowerATOMIC_FENCE</span><span class="p">(</span><span class="n">Op</span><span class="p">,</span> <span class="n">DAG</span><span class="p">);</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">MachineBasicBlock</span> <span class="o">*</span>
<span class="n">Cpu0TargetLowering</span><span class="o">::</span><span class="n">EmitInstrWithCustomInserter</span><span class="p">(</span><span class="n">MachineInstr</span> <span class="o">*</span><span class="n">MI</span><span class="p">,</span>
                                                <span class="n">MachineBasicBlock</span> <span class="o">*</span><span class="n">BB</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">MI</span><span class="o">-&gt;</span><span class="n">getOpcode</span><span class="p">())</span> <span class="p">{</span>
  <span class="nl">default:</span>
    <span class="n">llvm_unreachable</span><span class="p">(</span><span class="s">&quot;Unexpected instr type to insert&quot;</span><span class="p">);</span>
  <span class="k">case</span> <span class="n">Cpu0</span>:<span class="o">:</span><span class="n">ATOMIC_LOAD_ADD_I8</span><span class="o">:</span>
    <span class="k">return</span> <span class="n">emitAtomicBinaryPartword</span><span class="p">(</span><span class="n">MI</span><span class="p">,</span> <span class="n">BB</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">ADDu</span><span class="p">);</span>
  <span class="k">case</span> <span class="n">Cpu0</span>:<span class="o">:</span><span class="n">ATOMIC_LOAD_ADD_I16</span><span class="o">:</span>
    <span class="k">return</span> <span class="n">emitAtomicBinaryPartword</span><span class="p">(</span><span class="n">MI</span><span class="p">,</span> <span class="n">BB</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">ADDu</span><span class="p">);</span>
  <span class="k">case</span> <span class="n">Cpu0</span>:<span class="o">:</span><span class="n">ATOMIC_LOAD_ADD_I32</span><span class="o">:</span>
    <span class="k">return</span> <span class="n">emitAtomicBinary</span><span class="p">(</span><span class="n">MI</span><span class="p">,</span> <span class="n">BB</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">ADDu</span><span class="p">);</span>

  <span class="k">case</span> <span class="n">Cpu0</span>:<span class="o">:</span><span class="n">ATOMIC_LOAD_AND_I8</span><span class="o">:</span>
    <span class="k">return</span> <span class="n">emitAtomicBinaryPartword</span><span class="p">(</span><span class="n">MI</span><span class="p">,</span> <span class="n">BB</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">AND</span><span class="p">);</span>
  <span class="k">case</span> <span class="n">Cpu0</span>:<span class="o">:</span><span class="n">ATOMIC_LOAD_AND_I16</span><span class="o">:</span>
    <span class="k">return</span> <span class="n">emitAtomicBinaryPartword</span><span class="p">(</span><span class="n">MI</span><span class="p">,</span> <span class="n">BB</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">AND</span><span class="p">);</span>
  <span class="k">case</span> <span class="n">Cpu0</span>:<span class="o">:</span><span class="n">ATOMIC_LOAD_AND_I32</span><span class="o">:</span>
    <span class="k">return</span> <span class="n">emitAtomicBinary</span><span class="p">(</span><span class="n">MI</span><span class="p">,</span> <span class="n">BB</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">AND</span><span class="p">);</span>

  <span class="k">case</span> <span class="n">Cpu0</span>:<span class="o">:</span><span class="n">ATOMIC_LOAD_OR_I8</span><span class="o">:</span>
    <span class="k">return</span> <span class="n">emitAtomicBinaryPartword</span><span class="p">(</span><span class="n">MI</span><span class="p">,</span> <span class="n">BB</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">OR</span><span class="p">);</span>
  <span class="k">case</span> <span class="n">Cpu0</span>:<span class="o">:</span><span class="n">ATOMIC_LOAD_OR_I16</span><span class="o">:</span>
    <span class="k">return</span> <span class="n">emitAtomicBinaryPartword</span><span class="p">(</span><span class="n">MI</span><span class="p">,</span> <span class="n">BB</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">OR</span><span class="p">);</span>
  <span class="k">case</span> <span class="n">Cpu0</span>:<span class="o">:</span><span class="n">ATOMIC_LOAD_OR_I32</span><span class="o">:</span>
    <span class="k">return</span> <span class="n">emitAtomicBinary</span><span class="p">(</span><span class="n">MI</span><span class="p">,</span> <span class="n">BB</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">OR</span><span class="p">);</span>

  <span class="k">case</span> <span class="n">Cpu0</span>:<span class="o">:</span><span class="n">ATOMIC_LOAD_XOR_I8</span><span class="o">:</span>
    <span class="k">return</span> <span class="n">emitAtomicBinaryPartword</span><span class="p">(</span><span class="n">MI</span><span class="p">,</span> <span class="n">BB</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">XOR</span><span class="p">);</span>
  <span class="k">case</span> <span class="n">Cpu0</span>:<span class="o">:</span><span class="n">ATOMIC_LOAD_XOR_I16</span><span class="o">:</span>
    <span class="k">return</span> <span class="n">emitAtomicBinaryPartword</span><span class="p">(</span><span class="n">MI</span><span class="p">,</span> <span class="n">BB</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">XOR</span><span class="p">);</span>
  <span class="k">case</span> <span class="n">Cpu0</span>:<span class="o">:</span><span class="n">ATOMIC_LOAD_XOR_I32</span><span class="o">:</span>
    <span class="k">return</span> <span class="n">emitAtomicBinary</span><span class="p">(</span><span class="n">MI</span><span class="p">,</span> <span class="n">BB</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">XOR</span><span class="p">);</span>

  <span class="k">case</span> <span class="n">Cpu0</span>:<span class="o">:</span><span class="n">ATOMIC_LOAD_NAND_I8</span><span class="o">:</span>
    <span class="k">return</span> <span class="n">emitAtomicBinaryPartword</span><span class="p">(</span><span class="n">MI</span><span class="p">,</span> <span class="n">BB</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
  <span class="k">case</span> <span class="n">Cpu0</span>:<span class="o">:</span><span class="n">ATOMIC_LOAD_NAND_I16</span><span class="o">:</span>
    <span class="k">return</span> <span class="n">emitAtomicBinaryPartword</span><span class="p">(</span><span class="n">MI</span><span class="p">,</span> <span class="n">BB</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
  <span class="k">case</span> <span class="n">Cpu0</span>:<span class="o">:</span><span class="n">ATOMIC_LOAD_NAND_I32</span><span class="o">:</span>
    <span class="k">return</span> <span class="n">emitAtomicBinary</span><span class="p">(</span><span class="n">MI</span><span class="p">,</span> <span class="n">BB</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

  <span class="k">case</span> <span class="n">Cpu0</span>:<span class="o">:</span><span class="n">ATOMIC_LOAD_SUB_I8</span><span class="o">:</span>
    <span class="k">return</span> <span class="n">emitAtomicBinaryPartword</span><span class="p">(</span><span class="n">MI</span><span class="p">,</span> <span class="n">BB</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">SUBu</span><span class="p">);</span>
  <span class="k">case</span> <span class="n">Cpu0</span>:<span class="o">:</span><span class="n">ATOMIC_LOAD_SUB_I16</span><span class="o">:</span>
    <span class="k">return</span> <span class="n">emitAtomicBinaryPartword</span><span class="p">(</span><span class="n">MI</span><span class="p">,</span> <span class="n">BB</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">SUBu</span><span class="p">);</span>
  <span class="k">case</span> <span class="n">Cpu0</span>:<span class="o">:</span><span class="n">ATOMIC_LOAD_SUB_I32</span><span class="o">:</span>
    <span class="k">return</span> <span class="n">emitAtomicBinary</span><span class="p">(</span><span class="n">MI</span><span class="p">,</span> <span class="n">BB</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">SUBu</span><span class="p">);</span>

  <span class="k">case</span> <span class="n">Cpu0</span>:<span class="o">:</span><span class="n">ATOMIC_SWAP_I8</span><span class="o">:</span>
    <span class="k">return</span> <span class="n">emitAtomicBinaryPartword</span><span class="p">(</span><span class="n">MI</span><span class="p">,</span> <span class="n">BB</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="k">case</span> <span class="n">Cpu0</span>:<span class="o">:</span><span class="n">ATOMIC_SWAP_I16</span><span class="o">:</span>
    <span class="k">return</span> <span class="n">emitAtomicBinaryPartword</span><span class="p">(</span><span class="n">MI</span><span class="p">,</span> <span class="n">BB</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="k">case</span> <span class="n">Cpu0</span>:<span class="o">:</span><span class="n">ATOMIC_SWAP_I32</span><span class="o">:</span>
    <span class="k">return</span> <span class="n">emitAtomicBinary</span><span class="p">(</span><span class="n">MI</span><span class="p">,</span> <span class="n">BB</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

  <span class="k">case</span> <span class="n">Cpu0</span>:<span class="o">:</span><span class="n">ATOMIC_CMP_SWAP_I8</span><span class="o">:</span>
    <span class="k">return</span> <span class="n">emitAtomicCmpSwapPartword</span><span class="p">(</span><span class="n">MI</span><span class="p">,</span> <span class="n">BB</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
  <span class="k">case</span> <span class="n">Cpu0</span>:<span class="o">:</span><span class="n">ATOMIC_CMP_SWAP_I16</span><span class="o">:</span>
    <span class="k">return</span> <span class="n">emitAtomicCmpSwapPartword</span><span class="p">(</span><span class="n">MI</span><span class="p">,</span> <span class="n">BB</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
  <span class="k">case</span> <span class="n">Cpu0</span>:<span class="o">:</span><span class="n">ATOMIC_CMP_SWAP_I32</span><span class="o">:</span>
    <span class="k">return</span> <span class="n">emitAtomicCmpSwap</span><span class="p">(</span><span class="n">MI</span><span class="p">,</span> <span class="n">BB</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// This function also handles Cpu0::ATOMIC_SWAP_I32 (when BinOpcode == 0), and</span>
<span class="c1">// Cpu0::ATOMIC_LOAD_NAND_I32 (when Nand == true)</span>
<span class="n">MachineBasicBlock</span> <span class="o">*</span>
<span class="n">Cpu0TargetLowering</span><span class="o">::</span><span class="n">emitAtomicBinary</span><span class="p">(</span><span class="n">MachineInstr</span> <span class="o">*</span><span class="n">MI</span><span class="p">,</span> <span class="n">MachineBasicBlock</span> <span class="o">*</span><span class="n">BB</span><span class="p">,</span>
                                     <span class="kt">unsigned</span> <span class="n">Size</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">BinOpcode</span><span class="p">,</span>
                                     <span class="kt">bool</span> <span class="n">Nand</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="n">assert</span><span class="p">((</span><span class="n">Size</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="s">&quot;Unsupported size for EmitAtomicBinary.&quot;</span><span class="p">);</span>

  <span class="n">MachineFunction</span> <span class="o">*</span><span class="n">MF</span> <span class="o">=</span> <span class="n">BB</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">();</span>
  <span class="n">MachineRegisterInfo</span> <span class="o">&amp;</span><span class="n">RegInfo</span> <span class="o">=</span> <span class="n">MF</span><span class="o">-&gt;</span><span class="n">getRegInfo</span><span class="p">();</span>
  <span class="k">const</span> <span class="n">TargetRegisterClass</span> <span class="o">*</span><span class="n">RC</span> <span class="o">=</span> <span class="n">getRegClassFor</span><span class="p">(</span><span class="n">MVT</span><span class="o">::</span><span class="n">getIntegerVT</span><span class="p">(</span><span class="n">Size</span> <span class="o">*</span> <span class="mi">8</span><span class="p">));</span>
  <span class="k">const</span> <span class="n">TargetInstrInfo</span> <span class="o">*</span><span class="n">TII</span> <span class="o">=</span> <span class="n">Subtarget</span><span class="p">.</span><span class="n">getInstrInfo</span><span class="p">();</span>
  <span class="n">DebugLoc</span> <span class="n">DL</span> <span class="o">=</span> <span class="n">MI</span><span class="o">-&gt;</span><span class="n">getDebugLoc</span><span class="p">();</span>
  <span class="kt">unsigned</span> <span class="n">LL</span><span class="p">,</span> <span class="n">SC</span><span class="p">,</span> <span class="n">AND</span><span class="p">,</span> <span class="n">XOR</span><span class="p">,</span> <span class="n">ZERO</span><span class="p">,</span> <span class="n">BEQ</span><span class="p">;</span>

  <span class="n">LL</span> <span class="o">=</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">LL</span><span class="p">;</span>
  <span class="n">SC</span> <span class="o">=</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">SC</span><span class="p">;</span>
  <span class="n">AND</span> <span class="o">=</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">AND</span><span class="p">;</span>
  <span class="n">XOR</span> <span class="o">=</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">XOR</span><span class="p">;</span>
  <span class="n">ZERO</span> <span class="o">=</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">ZERO</span><span class="p">;</span>
  <span class="n">BEQ</span> <span class="o">=</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">BEQ</span><span class="p">;</span>

  <span class="kt">unsigned</span> <span class="n">OldVal</span> <span class="o">=</span> <span class="n">MI</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">getReg</span><span class="p">();</span>
  <span class="kt">unsigned</span> <span class="n">Ptr</span> <span class="o">=</span> <span class="n">MI</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">getReg</span><span class="p">();</span>
  <span class="kt">unsigned</span> <span class="n">Incr</span> <span class="o">=</span> <span class="n">MI</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="n">getReg</span><span class="p">();</span>

  <span class="kt">unsigned</span> <span class="n">StoreVal</span> <span class="o">=</span> <span class="n">RegInfo</span><span class="p">.</span><span class="n">createVirtualRegister</span><span class="p">(</span><span class="n">RC</span><span class="p">);</span>
  <span class="kt">unsigned</span> <span class="n">AndRes</span> <span class="o">=</span> <span class="n">RegInfo</span><span class="p">.</span><span class="n">createVirtualRegister</span><span class="p">(</span><span class="n">RC</span><span class="p">);</span>
  <span class="kt">unsigned</span> <span class="n">AndRes2</span> <span class="o">=</span> <span class="n">RegInfo</span><span class="p">.</span><span class="n">createVirtualRegister</span><span class="p">(</span><span class="n">RC</span><span class="p">);</span>
  <span class="kt">unsigned</span> <span class="n">Success</span> <span class="o">=</span> <span class="n">RegInfo</span><span class="p">.</span><span class="n">createVirtualRegister</span><span class="p">(</span><span class="n">RC</span><span class="p">);</span>

  <span class="c1">// insert new blocks after the current block</span>
  <span class="k">const</span> <span class="n">BasicBlock</span> <span class="o">*</span><span class="n">LLVM_BB</span> <span class="o">=</span> <span class="n">BB</span><span class="o">-&gt;</span><span class="n">getBasicBlock</span><span class="p">();</span>
  <span class="n">MachineBasicBlock</span> <span class="o">*</span><span class="n">loopMBB</span> <span class="o">=</span> <span class="n">MF</span><span class="o">-&gt;</span><span class="n">CreateMachineBasicBlock</span><span class="p">(</span><span class="n">LLVM_BB</span><span class="p">);</span>
  <span class="n">MachineBasicBlock</span> <span class="o">*</span><span class="n">exitMBB</span> <span class="o">=</span> <span class="n">MF</span><span class="o">-&gt;</span><span class="n">CreateMachineBasicBlock</span><span class="p">(</span><span class="n">LLVM_BB</span><span class="p">);</span>
  <span class="n">MachineFunction</span><span class="o">::</span><span class="n">iterator</span> <span class="n">It</span> <span class="o">=</span> <span class="n">BB</span><span class="p">;</span>
  <span class="o">++</span><span class="n">It</span><span class="p">;</span>
  <span class="n">MF</span><span class="o">-&gt;</span><span class="n">insert</span><span class="p">(</span><span class="n">It</span><span class="p">,</span> <span class="n">loopMBB</span><span class="p">);</span>
  <span class="n">MF</span><span class="o">-&gt;</span><span class="n">insert</span><span class="p">(</span><span class="n">It</span><span class="p">,</span> <span class="n">exitMBB</span><span class="p">);</span>

  <span class="c1">// Transfer the remainder of BB and its successor edges to exitMBB.</span>
  <span class="n">exitMBB</span><span class="o">-&gt;</span><span class="n">splice</span><span class="p">(</span><span class="n">exitMBB</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">(),</span> <span class="n">BB</span><span class="p">,</span>
                  <span class="n">std</span><span class="o">::</span><span class="n">next</span><span class="p">(</span><span class="n">MachineBasicBlock</span><span class="o">::</span><span class="n">iterator</span><span class="p">(</span><span class="n">MI</span><span class="p">)),</span> <span class="n">BB</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">());</span>
  <span class="n">exitMBB</span><span class="o">-&gt;</span><span class="n">transferSuccessorsAndUpdatePHIs</span><span class="p">(</span><span class="n">BB</span><span class="p">);</span>

  <span class="c1">//  thisMBB:</span>
  <span class="c1">//    ...</span>
  <span class="c1">//    fallthrough --&gt; loopMBB</span>
  <span class="n">BB</span><span class="o">-&gt;</span><span class="n">addSuccessor</span><span class="p">(</span><span class="n">loopMBB</span><span class="p">);</span>
  <span class="n">loopMBB</span><span class="o">-&gt;</span><span class="n">addSuccessor</span><span class="p">(</span><span class="n">loopMBB</span><span class="p">);</span>
  <span class="n">loopMBB</span><span class="o">-&gt;</span><span class="n">addSuccessor</span><span class="p">(</span><span class="n">exitMBB</span><span class="p">);</span>

  <span class="c1">//  loopMBB:</span>
  <span class="c1">//    ll oldval, 0(ptr)</span>
  <span class="c1">//    &lt;binop&gt; storeval, oldval, incr</span>
  <span class="c1">//    sc success, storeval, 0(ptr)</span>
  <span class="c1">//    beq success, $0, loopMBB</span>
  <span class="n">BB</span> <span class="o">=</span> <span class="n">loopMBB</span><span class="p">;</span>
  <span class="n">BuildMI</span><span class="p">(</span><span class="n">BB</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">TII</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">LL</span><span class="p">),</span> <span class="n">OldVal</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">Ptr</span><span class="p">).</span><span class="n">addImm</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Nand</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//  and andres, oldval, incr</span>
    <span class="c1">//  xor storeval, $0, andres</span>
    <span class="c1">//  xor storeval2, $0, storeval</span>
    <span class="n">BuildMI</span><span class="p">(</span><span class="n">BB</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">TII</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">AND</span><span class="p">),</span> <span class="n">AndRes</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">OldVal</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">Incr</span><span class="p">);</span>
    <span class="n">BuildMI</span><span class="p">(</span><span class="n">BB</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">TII</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">XOR</span><span class="p">),</span> <span class="n">StoreVal</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">ZERO</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">AndRes</span><span class="p">);</span>
    <span class="n">BuildMI</span><span class="p">(</span><span class="n">BB</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">TII</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">XOR</span><span class="p">),</span> <span class="n">AndRes2</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">ZERO</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">AndRes</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">BinOpcode</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//  &lt;binop&gt; storeval, oldval, incr</span>
    <span class="n">BuildMI</span><span class="p">(</span><span class="n">BB</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">TII</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">BinOpcode</span><span class="p">),</span> <span class="n">StoreVal</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">OldVal</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">Incr</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">StoreVal</span> <span class="o">=</span> <span class="n">Incr</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">BuildMI</span><span class="p">(</span><span class="n">BB</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">TII</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">SC</span><span class="p">),</span> <span class="n">Success</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">StoreVal</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">Ptr</span><span class="p">).</span><span class="n">addImm</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="n">BuildMI</span><span class="p">(</span><span class="n">BB</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">TII</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">BEQ</span><span class="p">)).</span><span class="n">addReg</span><span class="p">(</span><span class="n">Success</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">ZERO</span><span class="p">).</span><span class="n">addMBB</span><span class="p">(</span><span class="n">loopMBB</span><span class="p">);</span>

  <span class="n">MI</span><span class="o">-&gt;</span><span class="n">eraseFromParent</span><span class="p">();</span> <span class="c1">// The instruction is gone now.</span>

  <span class="k">return</span> <span class="n">exitMBB</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">MachineBasicBlock</span> <span class="o">*</span><span class="n">Cpu0TargetLowering</span><span class="o">::</span><span class="n">emitSignExtendToI32InReg</span><span class="p">(</span>
    <span class="n">MachineInstr</span> <span class="o">*</span><span class="n">MI</span><span class="p">,</span> <span class="n">MachineBasicBlock</span> <span class="o">*</span><span class="n">BB</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">Size</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">DstReg</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="n">SrcReg</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="k">const</span> <span class="n">TargetInstrInfo</span> <span class="o">*</span><span class="n">TII</span> <span class="o">=</span> <span class="n">Subtarget</span><span class="p">.</span><span class="n">getInstrInfo</span><span class="p">();</span>
  <span class="n">DebugLoc</span> <span class="n">DL</span> <span class="o">=</span> <span class="n">MI</span><span class="o">-&gt;</span><span class="n">getDebugLoc</span><span class="p">();</span>

  <span class="n">MachineFunction</span> <span class="o">*</span><span class="n">MF</span> <span class="o">=</span> <span class="n">BB</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">();</span>
  <span class="n">MachineRegisterInfo</span> <span class="o">&amp;</span><span class="n">RegInfo</span> <span class="o">=</span> <span class="n">MF</span><span class="o">-&gt;</span><span class="n">getRegInfo</span><span class="p">();</span>
  <span class="k">const</span> <span class="n">TargetRegisterClass</span> <span class="o">*</span><span class="n">RC</span> <span class="o">=</span> <span class="n">getRegClassFor</span><span class="p">(</span><span class="n">MVT</span><span class="o">::</span><span class="n">i32</span><span class="p">);</span>
  <span class="kt">unsigned</span> <span class="n">ScrReg</span> <span class="o">=</span> <span class="n">RegInfo</span><span class="p">.</span><span class="n">createVirtualRegister</span><span class="p">(</span><span class="n">RC</span><span class="p">);</span>

  <span class="n">assert</span><span class="p">(</span><span class="n">Size</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">);</span>
  <span class="kt">int64_t</span> <span class="n">ShiftImm</span> <span class="o">=</span> <span class="mi">32</span> <span class="o">-</span> <span class="p">(</span><span class="n">Size</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>

  <span class="n">BuildMI</span><span class="p">(</span><span class="n">BB</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">TII</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">SHL</span><span class="p">),</span> <span class="n">ScrReg</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">SrcReg</span><span class="p">).</span><span class="n">addImm</span><span class="p">(</span><span class="n">ShiftImm</span><span class="p">);</span>
  <span class="n">BuildMI</span><span class="p">(</span><span class="n">BB</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">TII</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">SRA</span><span class="p">),</span> <span class="n">DstReg</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">ScrReg</span><span class="p">).</span><span class="n">addImm</span><span class="p">(</span><span class="n">ShiftImm</span><span class="p">);</span>

  <span class="k">return</span> <span class="n">BB</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">MachineBasicBlock</span> <span class="o">*</span><span class="n">Cpu0TargetLowering</span><span class="o">::</span><span class="n">emitAtomicBinaryPartword</span><span class="p">(</span>
    <span class="n">MachineInstr</span> <span class="o">*</span><span class="n">MI</span><span class="p">,</span> <span class="n">MachineBasicBlock</span> <span class="o">*</span><span class="n">BB</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">Size</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">BinOpcode</span><span class="p">,</span>
    <span class="kt">bool</span> <span class="n">Nand</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="n">assert</span><span class="p">((</span><span class="n">Size</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">Size</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
         <span class="s">&quot;Unsupported size for EmitAtomicBinaryPartial.&quot;</span><span class="p">);</span>

  <span class="n">MachineFunction</span> <span class="o">*</span><span class="n">MF</span> <span class="o">=</span> <span class="n">BB</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">();</span>
  <span class="n">MachineRegisterInfo</span> <span class="o">&amp;</span><span class="n">RegInfo</span> <span class="o">=</span> <span class="n">MF</span><span class="o">-&gt;</span><span class="n">getRegInfo</span><span class="p">();</span>
  <span class="k">const</span> <span class="n">TargetRegisterClass</span> <span class="o">*</span><span class="n">RC</span> <span class="o">=</span> <span class="n">getRegClassFor</span><span class="p">(</span><span class="n">MVT</span><span class="o">::</span><span class="n">i32</span><span class="p">);</span>
  <span class="k">const</span> <span class="n">TargetInstrInfo</span> <span class="o">*</span><span class="n">TII</span> <span class="o">=</span> <span class="n">Subtarget</span><span class="p">.</span><span class="n">getInstrInfo</span><span class="p">();</span>
  <span class="n">DebugLoc</span> <span class="n">DL</span> <span class="o">=</span> <span class="n">MI</span><span class="o">-&gt;</span><span class="n">getDebugLoc</span><span class="p">();</span>

  <span class="kt">unsigned</span> <span class="n">Dest</span> <span class="o">=</span> <span class="n">MI</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">getReg</span><span class="p">();</span>
  <span class="kt">unsigned</span> <span class="n">Ptr</span> <span class="o">=</span> <span class="n">MI</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">getReg</span><span class="p">();</span>
  <span class="kt">unsigned</span> <span class="n">Incr</span> <span class="o">=</span> <span class="n">MI</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="n">getReg</span><span class="p">();</span>

  <span class="kt">unsigned</span> <span class="n">AlignedAddr</span> <span class="o">=</span> <span class="n">RegInfo</span><span class="p">.</span><span class="n">createVirtualRegister</span><span class="p">(</span><span class="n">RC</span><span class="p">);</span>
  <span class="kt">unsigned</span> <span class="n">ShiftAmt</span> <span class="o">=</span> <span class="n">RegInfo</span><span class="p">.</span><span class="n">createVirtualRegister</span><span class="p">(</span><span class="n">RC</span><span class="p">);</span>
  <span class="kt">unsigned</span> <span class="n">Mask</span> <span class="o">=</span> <span class="n">RegInfo</span><span class="p">.</span><span class="n">createVirtualRegister</span><span class="p">(</span><span class="n">RC</span><span class="p">);</span>
  <span class="kt">unsigned</span> <span class="n">Mask2</span> <span class="o">=</span> <span class="n">RegInfo</span><span class="p">.</span><span class="n">createVirtualRegister</span><span class="p">(</span><span class="n">RC</span><span class="p">);</span>
  <span class="kt">unsigned</span> <span class="n">Mask3</span> <span class="o">=</span> <span class="n">RegInfo</span><span class="p">.</span><span class="n">createVirtualRegister</span><span class="p">(</span><span class="n">RC</span><span class="p">);</span>
  <span class="kt">unsigned</span> <span class="n">NewVal</span> <span class="o">=</span> <span class="n">RegInfo</span><span class="p">.</span><span class="n">createVirtualRegister</span><span class="p">(</span><span class="n">RC</span><span class="p">);</span>
  <span class="kt">unsigned</span> <span class="n">OldVal</span> <span class="o">=</span> <span class="n">RegInfo</span><span class="p">.</span><span class="n">createVirtualRegister</span><span class="p">(</span><span class="n">RC</span><span class="p">);</span>
  <span class="kt">unsigned</span> <span class="n">Incr2</span> <span class="o">=</span> <span class="n">RegInfo</span><span class="p">.</span><span class="n">createVirtualRegister</span><span class="p">(</span><span class="n">RC</span><span class="p">);</span>
  <span class="kt">unsigned</span> <span class="n">MaskLSB2</span> <span class="o">=</span> <span class="n">RegInfo</span><span class="p">.</span><span class="n">createVirtualRegister</span><span class="p">(</span><span class="n">RC</span><span class="p">);</span>
  <span class="kt">unsigned</span> <span class="n">PtrLSB2</span> <span class="o">=</span> <span class="n">RegInfo</span><span class="p">.</span><span class="n">createVirtualRegister</span><span class="p">(</span><span class="n">RC</span><span class="p">);</span>
  <span class="kt">unsigned</span> <span class="n">MaskUpper</span> <span class="o">=</span> <span class="n">RegInfo</span><span class="p">.</span><span class="n">createVirtualRegister</span><span class="p">(</span><span class="n">RC</span><span class="p">);</span>
  <span class="kt">unsigned</span> <span class="n">AndRes</span> <span class="o">=</span> <span class="n">RegInfo</span><span class="p">.</span><span class="n">createVirtualRegister</span><span class="p">(</span><span class="n">RC</span><span class="p">);</span>
  <span class="kt">unsigned</span> <span class="n">BinOpRes</span> <span class="o">=</span> <span class="n">RegInfo</span><span class="p">.</span><span class="n">createVirtualRegister</span><span class="p">(</span><span class="n">RC</span><span class="p">);</span>
  <span class="kt">unsigned</span> <span class="n">BinOpRes2</span> <span class="o">=</span> <span class="n">RegInfo</span><span class="p">.</span><span class="n">createVirtualRegister</span><span class="p">(</span><span class="n">RC</span><span class="p">);</span>
  <span class="kt">unsigned</span> <span class="n">MaskedOldVal0</span> <span class="o">=</span> <span class="n">RegInfo</span><span class="p">.</span><span class="n">createVirtualRegister</span><span class="p">(</span><span class="n">RC</span><span class="p">);</span>
  <span class="kt">unsigned</span> <span class="n">StoreVal</span> <span class="o">=</span> <span class="n">RegInfo</span><span class="p">.</span><span class="n">createVirtualRegister</span><span class="p">(</span><span class="n">RC</span><span class="p">);</span>
  <span class="kt">unsigned</span> <span class="n">MaskedOldVal1</span> <span class="o">=</span> <span class="n">RegInfo</span><span class="p">.</span><span class="n">createVirtualRegister</span><span class="p">(</span><span class="n">RC</span><span class="p">);</span>
  <span class="kt">unsigned</span> <span class="n">SrlRes</span> <span class="o">=</span> <span class="n">RegInfo</span><span class="p">.</span><span class="n">createVirtualRegister</span><span class="p">(</span><span class="n">RC</span><span class="p">);</span>
  <span class="kt">unsigned</span> <span class="n">Success</span> <span class="o">=</span> <span class="n">RegInfo</span><span class="p">.</span><span class="n">createVirtualRegister</span><span class="p">(</span><span class="n">RC</span><span class="p">);</span>

  <span class="c1">// insert new blocks after the current block</span>
  <span class="k">const</span> <span class="n">BasicBlock</span> <span class="o">*</span><span class="n">LLVM_BB</span> <span class="o">=</span> <span class="n">BB</span><span class="o">-&gt;</span><span class="n">getBasicBlock</span><span class="p">();</span>
  <span class="n">MachineBasicBlock</span> <span class="o">*</span><span class="n">loopMBB</span> <span class="o">=</span> <span class="n">MF</span><span class="o">-&gt;</span><span class="n">CreateMachineBasicBlock</span><span class="p">(</span><span class="n">LLVM_BB</span><span class="p">);</span>
  <span class="n">MachineBasicBlock</span> <span class="o">*</span><span class="n">sinkMBB</span> <span class="o">=</span> <span class="n">MF</span><span class="o">-&gt;</span><span class="n">CreateMachineBasicBlock</span><span class="p">(</span><span class="n">LLVM_BB</span><span class="p">);</span>
  <span class="n">MachineBasicBlock</span> <span class="o">*</span><span class="n">exitMBB</span> <span class="o">=</span> <span class="n">MF</span><span class="o">-&gt;</span><span class="n">CreateMachineBasicBlock</span><span class="p">(</span><span class="n">LLVM_BB</span><span class="p">);</span>
  <span class="n">MachineFunction</span><span class="o">::</span><span class="n">iterator</span> <span class="n">It</span> <span class="o">=</span> <span class="n">BB</span><span class="p">;</span>
  <span class="o">++</span><span class="n">It</span><span class="p">;</span>
  <span class="n">MF</span><span class="o">-&gt;</span><span class="n">insert</span><span class="p">(</span><span class="n">It</span><span class="p">,</span> <span class="n">loopMBB</span><span class="p">);</span>
  <span class="n">MF</span><span class="o">-&gt;</span><span class="n">insert</span><span class="p">(</span><span class="n">It</span><span class="p">,</span> <span class="n">sinkMBB</span><span class="p">);</span>
  <span class="n">MF</span><span class="o">-&gt;</span><span class="n">insert</span><span class="p">(</span><span class="n">It</span><span class="p">,</span> <span class="n">exitMBB</span><span class="p">);</span>

  <span class="c1">// Transfer the remainder of BB and its successor edges to exitMBB.</span>
  <span class="n">exitMBB</span><span class="o">-&gt;</span><span class="n">splice</span><span class="p">(</span><span class="n">exitMBB</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">(),</span> <span class="n">BB</span><span class="p">,</span>
                  <span class="n">std</span><span class="o">::</span><span class="n">next</span><span class="p">(</span><span class="n">MachineBasicBlock</span><span class="o">::</span><span class="n">iterator</span><span class="p">(</span><span class="n">MI</span><span class="p">)),</span> <span class="n">BB</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">());</span>
  <span class="n">exitMBB</span><span class="o">-&gt;</span><span class="n">transferSuccessorsAndUpdatePHIs</span><span class="p">(</span><span class="n">BB</span><span class="p">);</span>

  <span class="n">BB</span><span class="o">-&gt;</span><span class="n">addSuccessor</span><span class="p">(</span><span class="n">loopMBB</span><span class="p">);</span>
  <span class="n">loopMBB</span><span class="o">-&gt;</span><span class="n">addSuccessor</span><span class="p">(</span><span class="n">loopMBB</span><span class="p">);</span>
  <span class="n">loopMBB</span><span class="o">-&gt;</span><span class="n">addSuccessor</span><span class="p">(</span><span class="n">sinkMBB</span><span class="p">);</span>
  <span class="n">sinkMBB</span><span class="o">-&gt;</span><span class="n">addSuccessor</span><span class="p">(</span><span class="n">exitMBB</span><span class="p">);</span>

  <span class="c1">//  thisMBB:</span>
  <span class="c1">//    addiu   masklsb2,$0,-4                # 0xfffffffc</span>
  <span class="c1">//    and     alignedaddr,ptr,masklsb2</span>
  <span class="c1">//    andi    ptrlsb2,ptr,3</span>
  <span class="c1">//    sll     shiftamt,ptrlsb2,3</span>
  <span class="c1">//    ori     maskupper,$0,255               # 0xff</span>
  <span class="c1">//    sll     mask,maskupper,shiftamt</span>
  <span class="c1">//    xor     mask2,$0,mask</span>
  <span class="c1">//    xor     mask3,$0,mask2</span>
  <span class="c1">//    sll     incr2,incr,shiftamt</span>

  <span class="kt">int64_t</span> <span class="n">MaskImm</span> <span class="o">=</span> <span class="p">(</span><span class="n">Size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">255</span> <span class="o">:</span> <span class="mi">65535</span><span class="p">;</span>
  <span class="n">BuildMI</span><span class="p">(</span><span class="n">BB</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">TII</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">ADDiu</span><span class="p">),</span> <span class="n">MaskLSB2</span><span class="p">)</span>
    <span class="p">.</span><span class="n">addReg</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">ZERO</span><span class="p">).</span><span class="n">addImm</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">);</span>
  <span class="n">BuildMI</span><span class="p">(</span><span class="n">BB</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">TII</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">AND</span><span class="p">),</span> <span class="n">AlignedAddr</span><span class="p">)</span>
    <span class="p">.</span><span class="n">addReg</span><span class="p">(</span><span class="n">Ptr</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">MaskLSB2</span><span class="p">);</span>
  <span class="n">BuildMI</span><span class="p">(</span><span class="n">BB</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">TII</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">ANDi</span><span class="p">),</span> <span class="n">PtrLSB2</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">Ptr</span><span class="p">).</span><span class="n">addImm</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Subtarget</span><span class="p">.</span><span class="n">isLittle</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">BuildMI</span><span class="p">(</span><span class="n">BB</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">TII</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">SHL</span><span class="p">),</span> <span class="n">ShiftAmt</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">PtrLSB2</span><span class="p">).</span><span class="n">addImm</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="n">Off</span> <span class="o">=</span> <span class="n">RegInfo</span><span class="p">.</span><span class="n">createVirtualRegister</span><span class="p">(</span><span class="n">RC</span><span class="p">);</span>
    <span class="n">BuildMI</span><span class="p">(</span><span class="n">BB</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">TII</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">XORi</span><span class="p">),</span> <span class="n">Off</span><span class="p">)</span>
      <span class="p">.</span><span class="n">addReg</span><span class="p">(</span><span class="n">PtrLSB2</span><span class="p">).</span><span class="n">addImm</span><span class="p">((</span><span class="n">Size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">3</span> <span class="o">:</span> <span class="mi">2</span><span class="p">);</span>
    <span class="n">BuildMI</span><span class="p">(</span><span class="n">BB</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">TII</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">SHL</span><span class="p">),</span> <span class="n">ShiftAmt</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">Off</span><span class="p">).</span><span class="n">addImm</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">BuildMI</span><span class="p">(</span><span class="n">BB</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">TII</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">ORi</span><span class="p">),</span> <span class="n">MaskUpper</span><span class="p">)</span>
    <span class="p">.</span><span class="n">addReg</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">ZERO</span><span class="p">).</span><span class="n">addImm</span><span class="p">(</span><span class="n">MaskImm</span><span class="p">);</span>
  <span class="n">BuildMI</span><span class="p">(</span><span class="n">BB</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">TII</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">SHLV</span><span class="p">),</span> <span class="n">Mask</span><span class="p">)</span>
    <span class="p">.</span><span class="n">addReg</span><span class="p">(</span><span class="n">MaskUpper</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">ShiftAmt</span><span class="p">);</span>
  <span class="n">BuildMI</span><span class="p">(</span><span class="n">BB</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">TII</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">XOR</span><span class="p">),</span> <span class="n">Mask2</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">ZERO</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">Mask</span><span class="p">);</span>
  <span class="n">BuildMI</span><span class="p">(</span><span class="n">BB</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">TII</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">XOR</span><span class="p">),</span> <span class="n">Mask3</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">ZERO</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">Mask2</span><span class="p">);</span>
  <span class="n">BuildMI</span><span class="p">(</span><span class="n">BB</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">TII</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">SHLV</span><span class="p">),</span> <span class="n">Incr2</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">Incr</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">ShiftAmt</span><span class="p">);</span>

  <span class="c1">// atomic.load.binop</span>
  <span class="c1">// loopMBB:</span>
  <span class="c1">//   ll      oldval,0(alignedaddr)</span>
  <span class="c1">//   binop   binopres,oldval,incr2</span>
  <span class="c1">//   and     newval,binopres,mask</span>
  <span class="c1">//   and     maskedoldval0,oldval,mask3</span>
  <span class="c1">//   or      storeval,maskedoldval0,newval</span>
  <span class="c1">//   sc      success,storeval,0(alignedaddr)</span>
  <span class="c1">//   beq     success,$0,loopMBB</span>

  <span class="c1">// atomic.swap</span>
  <span class="c1">// loopMBB:</span>
  <span class="c1">//   ll      oldval,0(alignedaddr)</span>
  <span class="c1">//   and     newval,incr2,mask</span>
  <span class="c1">//   and     maskedoldval0,oldval,mask3</span>
  <span class="c1">//   or      storeval,maskedoldval0,newval</span>
  <span class="c1">//   sc      success,storeval,0(alignedaddr)</span>
  <span class="c1">//   beq     success,$0,loopMBB</span>

  <span class="n">BB</span> <span class="o">=</span> <span class="n">loopMBB</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="n">LL</span> <span class="o">=</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">LL</span><span class="p">;</span>
  <span class="n">BuildMI</span><span class="p">(</span><span class="n">BB</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">TII</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">LL</span><span class="p">),</span> <span class="n">OldVal</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">AlignedAddr</span><span class="p">).</span><span class="n">addImm</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Nand</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//  and andres, oldval, incr2</span>
    <span class="c1">//  xor binopres,  $0, andres</span>
    <span class="c1">//  xor binopres2, $0, binopres</span>
    <span class="c1">//  and newval, binopres, mask</span>
    <span class="n">BuildMI</span><span class="p">(</span><span class="n">BB</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">TII</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">AND</span><span class="p">),</span> <span class="n">AndRes</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">OldVal</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">Incr2</span><span class="p">);</span>
    <span class="n">BuildMI</span><span class="p">(</span><span class="n">BB</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">TII</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">XOR</span><span class="p">),</span> <span class="n">BinOpRes</span><span class="p">)</span>
      <span class="p">.</span><span class="n">addReg</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">ZERO</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">AndRes</span><span class="p">);</span>
    <span class="n">BuildMI</span><span class="p">(</span><span class="n">BB</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">TII</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">XOR</span><span class="p">),</span> <span class="n">BinOpRes2</span><span class="p">)</span>
      <span class="p">.</span><span class="n">addReg</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">ZERO</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">BinOpRes</span><span class="p">);</span>
    <span class="n">BuildMI</span><span class="p">(</span><span class="n">BB</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">TII</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">AND</span><span class="p">),</span> <span class="n">NewVal</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">BinOpRes</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">Mask</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">BinOpcode</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//  &lt;binop&gt; binopres, oldval, incr2</span>
    <span class="c1">//  and newval, binopres, mask</span>
    <span class="n">BuildMI</span><span class="p">(</span><span class="n">BB</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">TII</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">BinOpcode</span><span class="p">),</span> <span class="n">BinOpRes</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">OldVal</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">Incr2</span><span class="p">);</span>
    <span class="n">BuildMI</span><span class="p">(</span><span class="n">BB</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">TII</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">AND</span><span class="p">),</span> <span class="n">NewVal</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">BinOpRes</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">Mask</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// atomic.swap</span>
    <span class="c1">//  and newval, incr2, mask</span>
    <span class="n">BuildMI</span><span class="p">(</span><span class="n">BB</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">TII</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">AND</span><span class="p">),</span> <span class="n">NewVal</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">Incr2</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">Mask</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">BuildMI</span><span class="p">(</span><span class="n">BB</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">TII</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">AND</span><span class="p">),</span> <span class="n">MaskedOldVal0</span><span class="p">)</span>
    <span class="p">.</span><span class="n">addReg</span><span class="p">(</span><span class="n">OldVal</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">Mask2</span><span class="p">);</span>
  <span class="n">BuildMI</span><span class="p">(</span><span class="n">BB</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">TII</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">OR</span><span class="p">),</span> <span class="n">StoreVal</span><span class="p">)</span>
    <span class="p">.</span><span class="n">addReg</span><span class="p">(</span><span class="n">MaskedOldVal0</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">NewVal</span><span class="p">);</span>
  <span class="kt">unsigned</span> <span class="n">SC</span> <span class="o">=</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">SC</span><span class="p">;</span>
  <span class="n">BuildMI</span><span class="p">(</span><span class="n">BB</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">TII</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">SC</span><span class="p">),</span> <span class="n">Success</span><span class="p">)</span>
    <span class="p">.</span><span class="n">addReg</span><span class="p">(</span><span class="n">StoreVal</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">AlignedAddr</span><span class="p">).</span><span class="n">addImm</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="n">BuildMI</span><span class="p">(</span><span class="n">BB</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">TII</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">BEQ</span><span class="p">))</span>
    <span class="p">.</span><span class="n">addReg</span><span class="p">(</span><span class="n">Success</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">ZERO</span><span class="p">).</span><span class="n">addMBB</span><span class="p">(</span><span class="n">loopMBB</span><span class="p">);</span>

  <span class="c1">//  sinkMBB:</span>
  <span class="c1">//    and     maskedoldval1,oldval,mask</span>
  <span class="c1">//    srl     srlres,maskedoldval1,shiftamt</span>
  <span class="c1">//    sign_extend dest,srlres</span>
  <span class="n">BB</span> <span class="o">=</span> <span class="n">sinkMBB</span><span class="p">;</span>

  <span class="n">BuildMI</span><span class="p">(</span><span class="n">BB</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">TII</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">AND</span><span class="p">),</span> <span class="n">MaskedOldVal1</span><span class="p">)</span>
    <span class="p">.</span><span class="n">addReg</span><span class="p">(</span><span class="n">OldVal</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">Mask</span><span class="p">);</span>
  <span class="n">BuildMI</span><span class="p">(</span><span class="n">BB</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">TII</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">SHRV</span><span class="p">),</span> <span class="n">SrlRes</span><span class="p">)</span>
      <span class="p">.</span><span class="n">addReg</span><span class="p">(</span><span class="n">MaskedOldVal1</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">ShiftAmt</span><span class="p">);</span>
  <span class="n">BB</span> <span class="o">=</span> <span class="n">emitSignExtendToI32InReg</span><span class="p">(</span><span class="n">MI</span><span class="p">,</span> <span class="n">BB</span><span class="p">,</span> <span class="n">Size</span><span class="p">,</span> <span class="n">Dest</span><span class="p">,</span> <span class="n">SrlRes</span><span class="p">);</span>

  <span class="n">MI</span><span class="o">-&gt;</span><span class="n">eraseFromParent</span><span class="p">();</span> <span class="c1">// The instruction is gone now.</span>

  <span class="k">return</span> <span class="n">exitMBB</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">MachineBasicBlock</span> <span class="o">*</span> <span class="n">Cpu0TargetLowering</span><span class="o">::</span><span class="n">emitAtomicCmpSwap</span><span class="p">(</span><span class="n">MachineInstr</span> <span class="o">*</span><span class="n">MI</span><span class="p">,</span>
                                                          <span class="n">MachineBasicBlock</span> <span class="o">*</span><span class="n">BB</span><span class="p">,</span>
                                                          <span class="kt">unsigned</span> <span class="n">Size</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="n">assert</span><span class="p">((</span><span class="n">Size</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="s">&quot;Unsupported size for EmitAtomicCmpSwap.&quot;</span><span class="p">);</span>

  <span class="n">MachineFunction</span> <span class="o">*</span><span class="n">MF</span> <span class="o">=</span> <span class="n">BB</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">();</span>
  <span class="n">MachineRegisterInfo</span> <span class="o">&amp;</span><span class="n">RegInfo</span> <span class="o">=</span> <span class="n">MF</span><span class="o">-&gt;</span><span class="n">getRegInfo</span><span class="p">();</span>
  <span class="k">const</span> <span class="n">TargetRegisterClass</span> <span class="o">*</span><span class="n">RC</span> <span class="o">=</span> <span class="n">getRegClassFor</span><span class="p">(</span><span class="n">MVT</span><span class="o">::</span><span class="n">getIntegerVT</span><span class="p">(</span><span class="n">Size</span> <span class="o">*</span> <span class="mi">8</span><span class="p">));</span>
  <span class="k">const</span> <span class="n">TargetInstrInfo</span> <span class="o">*</span><span class="n">TII</span> <span class="o">=</span> <span class="n">Subtarget</span><span class="p">.</span><span class="n">getInstrInfo</span><span class="p">();</span>
  <span class="n">DebugLoc</span> <span class="n">DL</span> <span class="o">=</span> <span class="n">MI</span><span class="o">-&gt;</span><span class="n">getDebugLoc</span><span class="p">();</span>
  <span class="kt">unsigned</span> <span class="n">LL</span><span class="p">,</span> <span class="n">SC</span><span class="p">,</span> <span class="n">ZERO</span><span class="p">,</span> <span class="n">BNE</span><span class="p">,</span> <span class="n">BEQ</span><span class="p">;</span>

  <span class="n">LL</span> <span class="o">=</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">LL</span><span class="p">;</span>
  <span class="n">SC</span> <span class="o">=</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">SC</span><span class="p">;</span>
  <span class="n">ZERO</span> <span class="o">=</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">ZERO</span><span class="p">;</span>
  <span class="n">BNE</span> <span class="o">=</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">BNE</span><span class="p">;</span>
  <span class="n">BEQ</span> <span class="o">=</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">BEQ</span><span class="p">;</span>

  <span class="kt">unsigned</span> <span class="n">Dest</span>    <span class="o">=</span> <span class="n">MI</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">getReg</span><span class="p">();</span>
  <span class="kt">unsigned</span> <span class="n">Ptr</span>     <span class="o">=</span> <span class="n">MI</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">getReg</span><span class="p">();</span>
  <span class="kt">unsigned</span> <span class="n">OldVal</span>  <span class="o">=</span> <span class="n">MI</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="n">getReg</span><span class="p">();</span>
  <span class="kt">unsigned</span> <span class="n">NewVal</span>  <span class="o">=</span> <span class="n">MI</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span><span class="n">getReg</span><span class="p">();</span>

  <span class="kt">unsigned</span> <span class="n">Success</span> <span class="o">=</span> <span class="n">RegInfo</span><span class="p">.</span><span class="n">createVirtualRegister</span><span class="p">(</span><span class="n">RC</span><span class="p">);</span>

  <span class="c1">// insert new blocks after the current block</span>
  <span class="k">const</span> <span class="n">BasicBlock</span> <span class="o">*</span><span class="n">LLVM_BB</span> <span class="o">=</span> <span class="n">BB</span><span class="o">-&gt;</span><span class="n">getBasicBlock</span><span class="p">();</span>
  <span class="n">MachineBasicBlock</span> <span class="o">*</span><span class="n">loop1MBB</span> <span class="o">=</span> <span class="n">MF</span><span class="o">-&gt;</span><span class="n">CreateMachineBasicBlock</span><span class="p">(</span><span class="n">LLVM_BB</span><span class="p">);</span>
  <span class="n">MachineBasicBlock</span> <span class="o">*</span><span class="n">loop2MBB</span> <span class="o">=</span> <span class="n">MF</span><span class="o">-&gt;</span><span class="n">CreateMachineBasicBlock</span><span class="p">(</span><span class="n">LLVM_BB</span><span class="p">);</span>
  <span class="n">MachineBasicBlock</span> <span class="o">*</span><span class="n">exitMBB</span> <span class="o">=</span> <span class="n">MF</span><span class="o">-&gt;</span><span class="n">CreateMachineBasicBlock</span><span class="p">(</span><span class="n">LLVM_BB</span><span class="p">);</span>
  <span class="n">MachineFunction</span><span class="o">::</span><span class="n">iterator</span> <span class="n">It</span> <span class="o">=</span> <span class="n">BB</span><span class="p">;</span>
  <span class="o">++</span><span class="n">It</span><span class="p">;</span>
  <span class="n">MF</span><span class="o">-&gt;</span><span class="n">insert</span><span class="p">(</span><span class="n">It</span><span class="p">,</span> <span class="n">loop1MBB</span><span class="p">);</span>
  <span class="n">MF</span><span class="o">-&gt;</span><span class="n">insert</span><span class="p">(</span><span class="n">It</span><span class="p">,</span> <span class="n">loop2MBB</span><span class="p">);</span>
  <span class="n">MF</span><span class="o">-&gt;</span><span class="n">insert</span><span class="p">(</span><span class="n">It</span><span class="p">,</span> <span class="n">exitMBB</span><span class="p">);</span>

  <span class="c1">// Transfer the remainder of BB and its successor edges to exitMBB.</span>
  <span class="n">exitMBB</span><span class="o">-&gt;</span><span class="n">splice</span><span class="p">(</span><span class="n">exitMBB</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">(),</span> <span class="n">BB</span><span class="p">,</span>
                  <span class="n">std</span><span class="o">::</span><span class="n">next</span><span class="p">(</span><span class="n">MachineBasicBlock</span><span class="o">::</span><span class="n">iterator</span><span class="p">(</span><span class="n">MI</span><span class="p">)),</span> <span class="n">BB</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">());</span>
  <span class="n">exitMBB</span><span class="o">-&gt;</span><span class="n">transferSuccessorsAndUpdatePHIs</span><span class="p">(</span><span class="n">BB</span><span class="p">);</span>

  <span class="c1">//  thisMBB:</span>
  <span class="c1">//    ...</span>
  <span class="c1">//    fallthrough --&gt; loop1MBB</span>
  <span class="n">BB</span><span class="o">-&gt;</span><span class="n">addSuccessor</span><span class="p">(</span><span class="n">loop1MBB</span><span class="p">);</span>
  <span class="n">loop1MBB</span><span class="o">-&gt;</span><span class="n">addSuccessor</span><span class="p">(</span><span class="n">exitMBB</span><span class="p">);</span>
  <span class="n">loop1MBB</span><span class="o">-&gt;</span><span class="n">addSuccessor</span><span class="p">(</span><span class="n">loop2MBB</span><span class="p">);</span>
  <span class="n">loop2MBB</span><span class="o">-&gt;</span><span class="n">addSuccessor</span><span class="p">(</span><span class="n">loop1MBB</span><span class="p">);</span>
  <span class="n">loop2MBB</span><span class="o">-&gt;</span><span class="n">addSuccessor</span><span class="p">(</span><span class="n">exitMBB</span><span class="p">);</span>

  <span class="c1">// loop1MBB:</span>
  <span class="c1">//   ll dest, 0(ptr)</span>
  <span class="c1">//   bne dest, oldval, exitMBB</span>
  <span class="n">BB</span> <span class="o">=</span> <span class="n">loop1MBB</span><span class="p">;</span>
  <span class="n">BuildMI</span><span class="p">(</span><span class="n">BB</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">TII</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">LL</span><span class="p">),</span> <span class="n">Dest</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">Ptr</span><span class="p">).</span><span class="n">addImm</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="n">BuildMI</span><span class="p">(</span><span class="n">BB</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">TII</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">BNE</span><span class="p">))</span>
    <span class="p">.</span><span class="n">addReg</span><span class="p">(</span><span class="n">Dest</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">OldVal</span><span class="p">).</span><span class="n">addMBB</span><span class="p">(</span><span class="n">exitMBB</span><span class="p">);</span>

  <span class="c1">// loop2MBB:</span>
  <span class="c1">//   sc success, newval, 0(ptr)</span>
  <span class="c1">//   beq success, $0, loop1MBB</span>
  <span class="n">BB</span> <span class="o">=</span> <span class="n">loop2MBB</span><span class="p">;</span>
  <span class="n">BuildMI</span><span class="p">(</span><span class="n">BB</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">TII</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">SC</span><span class="p">),</span> <span class="n">Success</span><span class="p">)</span>
    <span class="p">.</span><span class="n">addReg</span><span class="p">(</span><span class="n">NewVal</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">Ptr</span><span class="p">).</span><span class="n">addImm</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="n">BuildMI</span><span class="p">(</span><span class="n">BB</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">TII</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">BEQ</span><span class="p">))</span>
    <span class="p">.</span><span class="n">addReg</span><span class="p">(</span><span class="n">Success</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">ZERO</span><span class="p">).</span><span class="n">addMBB</span><span class="p">(</span><span class="n">loop1MBB</span><span class="p">);</span>

  <span class="n">MI</span><span class="o">-&gt;</span><span class="n">eraseFromParent</span><span class="p">();</span> <span class="c1">// The instruction is gone now.</span>

  <span class="k">return</span> <span class="n">exitMBB</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">MachineBasicBlock</span> <span class="o">*</span>
<span class="n">Cpu0TargetLowering</span><span class="o">::</span><span class="n">emitAtomicCmpSwapPartword</span><span class="p">(</span><span class="n">MachineInstr</span> <span class="o">*</span><span class="n">MI</span><span class="p">,</span>
                                              <span class="n">MachineBasicBlock</span> <span class="o">*</span><span class="n">BB</span><span class="p">,</span>
                                              <span class="kt">unsigned</span> <span class="n">Size</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="n">assert</span><span class="p">((</span><span class="n">Size</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">Size</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
      <span class="s">&quot;Unsupported size for EmitAtomicCmpSwapPartial.&quot;</span><span class="p">);</span>

  <span class="n">MachineFunction</span> <span class="o">*</span><span class="n">MF</span> <span class="o">=</span> <span class="n">BB</span><span class="o">-&gt;</span><span class="n">getParent</span><span class="p">();</span>
  <span class="n">MachineRegisterInfo</span> <span class="o">&amp;</span><span class="n">RegInfo</span> <span class="o">=</span> <span class="n">MF</span><span class="o">-&gt;</span><span class="n">getRegInfo</span><span class="p">();</span>
  <span class="k">const</span> <span class="n">TargetRegisterClass</span> <span class="o">*</span><span class="n">RC</span> <span class="o">=</span> <span class="n">getRegClassFor</span><span class="p">(</span><span class="n">MVT</span><span class="o">::</span><span class="n">i32</span><span class="p">);</span>
  <span class="k">const</span> <span class="n">TargetInstrInfo</span> <span class="o">*</span><span class="n">TII</span> <span class="o">=</span> <span class="n">Subtarget</span><span class="p">.</span><span class="n">getInstrInfo</span><span class="p">();</span>
  <span class="n">DebugLoc</span> <span class="n">DL</span> <span class="o">=</span> <span class="n">MI</span><span class="o">-&gt;</span><span class="n">getDebugLoc</span><span class="p">();</span>

  <span class="kt">unsigned</span> <span class="n">Dest</span>    <span class="o">=</span> <span class="n">MI</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">getReg</span><span class="p">();</span>
  <span class="kt">unsigned</span> <span class="n">Ptr</span>     <span class="o">=</span> <span class="n">MI</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">getReg</span><span class="p">();</span>
  <span class="kt">unsigned</span> <span class="n">CmpVal</span>  <span class="o">=</span> <span class="n">MI</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="n">getReg</span><span class="p">();</span>
  <span class="kt">unsigned</span> <span class="n">NewVal</span>  <span class="o">=</span> <span class="n">MI</span><span class="o">-&gt;</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span><span class="n">getReg</span><span class="p">();</span>

  <span class="kt">unsigned</span> <span class="n">AlignedAddr</span> <span class="o">=</span> <span class="n">RegInfo</span><span class="p">.</span><span class="n">createVirtualRegister</span><span class="p">(</span><span class="n">RC</span><span class="p">);</span>
  <span class="kt">unsigned</span> <span class="n">ShiftAmt</span> <span class="o">=</span> <span class="n">RegInfo</span><span class="p">.</span><span class="n">createVirtualRegister</span><span class="p">(</span><span class="n">RC</span><span class="p">);</span>
  <span class="kt">unsigned</span> <span class="n">Mask</span> <span class="o">=</span> <span class="n">RegInfo</span><span class="p">.</span><span class="n">createVirtualRegister</span><span class="p">(</span><span class="n">RC</span><span class="p">);</span>
  <span class="kt">unsigned</span> <span class="n">Mask2</span> <span class="o">=</span> <span class="n">RegInfo</span><span class="p">.</span><span class="n">createVirtualRegister</span><span class="p">(</span><span class="n">RC</span><span class="p">);</span>
  <span class="kt">unsigned</span> <span class="n">Mask3</span> <span class="o">=</span> <span class="n">RegInfo</span><span class="p">.</span><span class="n">createVirtualRegister</span><span class="p">(</span><span class="n">RC</span><span class="p">);</span>
  <span class="kt">unsigned</span> <span class="n">ShiftedCmpVal</span> <span class="o">=</span> <span class="n">RegInfo</span><span class="p">.</span><span class="n">createVirtualRegister</span><span class="p">(</span><span class="n">RC</span><span class="p">);</span>
  <span class="kt">unsigned</span> <span class="n">OldVal</span> <span class="o">=</span> <span class="n">RegInfo</span><span class="p">.</span><span class="n">createVirtualRegister</span><span class="p">(</span><span class="n">RC</span><span class="p">);</span>
  <span class="kt">unsigned</span> <span class="n">MaskedOldVal0</span> <span class="o">=</span> <span class="n">RegInfo</span><span class="p">.</span><span class="n">createVirtualRegister</span><span class="p">(</span><span class="n">RC</span><span class="p">);</span>
  <span class="kt">unsigned</span> <span class="n">ShiftedNewVal</span> <span class="o">=</span> <span class="n">RegInfo</span><span class="p">.</span><span class="n">createVirtualRegister</span><span class="p">(</span><span class="n">RC</span><span class="p">);</span>
  <span class="kt">unsigned</span> <span class="n">MaskLSB2</span> <span class="o">=</span> <span class="n">RegInfo</span><span class="p">.</span><span class="n">createVirtualRegister</span><span class="p">(</span><span class="n">RC</span><span class="p">);</span>
  <span class="kt">unsigned</span> <span class="n">PtrLSB2</span> <span class="o">=</span> <span class="n">RegInfo</span><span class="p">.</span><span class="n">createVirtualRegister</span><span class="p">(</span><span class="n">RC</span><span class="p">);</span>
  <span class="kt">unsigned</span> <span class="n">MaskUpper</span> <span class="o">=</span> <span class="n">RegInfo</span><span class="p">.</span><span class="n">createVirtualRegister</span><span class="p">(</span><span class="n">RC</span><span class="p">);</span>
  <span class="kt">unsigned</span> <span class="n">MaskedCmpVal</span> <span class="o">=</span> <span class="n">RegInfo</span><span class="p">.</span><span class="n">createVirtualRegister</span><span class="p">(</span><span class="n">RC</span><span class="p">);</span>
  <span class="kt">unsigned</span> <span class="n">MaskedNewVal</span> <span class="o">=</span> <span class="n">RegInfo</span><span class="p">.</span><span class="n">createVirtualRegister</span><span class="p">(</span><span class="n">RC</span><span class="p">);</span>
  <span class="kt">unsigned</span> <span class="n">MaskedOldVal1</span> <span class="o">=</span> <span class="n">RegInfo</span><span class="p">.</span><span class="n">createVirtualRegister</span><span class="p">(</span><span class="n">RC</span><span class="p">);</span>
  <span class="kt">unsigned</span> <span class="n">StoreVal</span> <span class="o">=</span> <span class="n">RegInfo</span><span class="p">.</span><span class="n">createVirtualRegister</span><span class="p">(</span><span class="n">RC</span><span class="p">);</span>
  <span class="kt">unsigned</span> <span class="n">SrlRes</span> <span class="o">=</span> <span class="n">RegInfo</span><span class="p">.</span><span class="n">createVirtualRegister</span><span class="p">(</span><span class="n">RC</span><span class="p">);</span>
  <span class="kt">unsigned</span> <span class="n">Success</span> <span class="o">=</span> <span class="n">RegInfo</span><span class="p">.</span><span class="n">createVirtualRegister</span><span class="p">(</span><span class="n">RC</span><span class="p">);</span>

  <span class="c1">// insert new blocks after the current block</span>
  <span class="k">const</span> <span class="n">BasicBlock</span> <span class="o">*</span><span class="n">LLVM_BB</span> <span class="o">=</span> <span class="n">BB</span><span class="o">-&gt;</span><span class="n">getBasicBlock</span><span class="p">();</span>
  <span class="n">MachineBasicBlock</span> <span class="o">*</span><span class="n">loop1MBB</span> <span class="o">=</span> <span class="n">MF</span><span class="o">-&gt;</span><span class="n">CreateMachineBasicBlock</span><span class="p">(</span><span class="n">LLVM_BB</span><span class="p">);</span>
  <span class="n">MachineBasicBlock</span> <span class="o">*</span><span class="n">loop2MBB</span> <span class="o">=</span> <span class="n">MF</span><span class="o">-&gt;</span><span class="n">CreateMachineBasicBlock</span><span class="p">(</span><span class="n">LLVM_BB</span><span class="p">);</span>
  <span class="n">MachineBasicBlock</span> <span class="o">*</span><span class="n">sinkMBB</span> <span class="o">=</span> <span class="n">MF</span><span class="o">-&gt;</span><span class="n">CreateMachineBasicBlock</span><span class="p">(</span><span class="n">LLVM_BB</span><span class="p">);</span>
  <span class="n">MachineBasicBlock</span> <span class="o">*</span><span class="n">exitMBB</span> <span class="o">=</span> <span class="n">MF</span><span class="o">-&gt;</span><span class="n">CreateMachineBasicBlock</span><span class="p">(</span><span class="n">LLVM_BB</span><span class="p">);</span>
  <span class="n">MachineFunction</span><span class="o">::</span><span class="n">iterator</span> <span class="n">It</span> <span class="o">=</span> <span class="n">BB</span><span class="p">;</span>
  <span class="o">++</span><span class="n">It</span><span class="p">;</span>
  <span class="n">MF</span><span class="o">-&gt;</span><span class="n">insert</span><span class="p">(</span><span class="n">It</span><span class="p">,</span> <span class="n">loop1MBB</span><span class="p">);</span>
  <span class="n">MF</span><span class="o">-&gt;</span><span class="n">insert</span><span class="p">(</span><span class="n">It</span><span class="p">,</span> <span class="n">loop2MBB</span><span class="p">);</span>
  <span class="n">MF</span><span class="o">-&gt;</span><span class="n">insert</span><span class="p">(</span><span class="n">It</span><span class="p">,</span> <span class="n">sinkMBB</span><span class="p">);</span>
  <span class="n">MF</span><span class="o">-&gt;</span><span class="n">insert</span><span class="p">(</span><span class="n">It</span><span class="p">,</span> <span class="n">exitMBB</span><span class="p">);</span>

  <span class="c1">// Transfer the remainder of BB and its successor edges to exitMBB.</span>
  <span class="n">exitMBB</span><span class="o">-&gt;</span><span class="n">splice</span><span class="p">(</span><span class="n">exitMBB</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">(),</span> <span class="n">BB</span><span class="p">,</span>
                  <span class="n">std</span><span class="o">::</span><span class="n">next</span><span class="p">(</span><span class="n">MachineBasicBlock</span><span class="o">::</span><span class="n">iterator</span><span class="p">(</span><span class="n">MI</span><span class="p">)),</span> <span class="n">BB</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">());</span>
  <span class="n">exitMBB</span><span class="o">-&gt;</span><span class="n">transferSuccessorsAndUpdatePHIs</span><span class="p">(</span><span class="n">BB</span><span class="p">);</span>

  <span class="n">BB</span><span class="o">-&gt;</span><span class="n">addSuccessor</span><span class="p">(</span><span class="n">loop1MBB</span><span class="p">);</span>
  <span class="n">loop1MBB</span><span class="o">-&gt;</span><span class="n">addSuccessor</span><span class="p">(</span><span class="n">sinkMBB</span><span class="p">);</span>
  <span class="n">loop1MBB</span><span class="o">-&gt;</span><span class="n">addSuccessor</span><span class="p">(</span><span class="n">loop2MBB</span><span class="p">);</span>
  <span class="n">loop2MBB</span><span class="o">-&gt;</span><span class="n">addSuccessor</span><span class="p">(</span><span class="n">loop1MBB</span><span class="p">);</span>
  <span class="n">loop2MBB</span><span class="o">-&gt;</span><span class="n">addSuccessor</span><span class="p">(</span><span class="n">sinkMBB</span><span class="p">);</span>
  <span class="n">sinkMBB</span><span class="o">-&gt;</span><span class="n">addSuccessor</span><span class="p">(</span><span class="n">exitMBB</span><span class="p">);</span>

  <span class="c1">// FIXME: computation of newval2 can be moved to loop2MBB.</span>
  <span class="c1">//  thisMBB:</span>
  <span class="c1">//    addiu   masklsb2,$0,-4                # 0xfffffffc</span>
  <span class="c1">//    and     alignedaddr,ptr,masklsb2</span>
  <span class="c1">//    andi    ptrlsb2,ptr,3</span>
  <span class="c1">//    shl     shiftamt,ptrlsb2,3</span>
  <span class="c1">//    ori     maskupper,$0,255               # 0xff</span>
  <span class="c1">//    shl     mask,maskupper,shiftamt</span>
  <span class="c1">//    xor     mask2,$0,mask</span>
  <span class="c1">//    xor     mask3,$0,mask2</span>
  <span class="c1">//    andi    maskedcmpval,cmpval,255</span>
  <span class="c1">//    shl     shiftedcmpval,maskedcmpval,shiftamt</span>
  <span class="c1">//    andi    maskednewval,newval,255</span>
  <span class="c1">//    shl     shiftednewval,maskednewval,shiftamt</span>
  <span class="kt">int64_t</span> <span class="n">MaskImm</span> <span class="o">=</span> <span class="p">(</span><span class="n">Size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">255</span> <span class="o">:</span> <span class="mi">65535</span><span class="p">;</span>
  <span class="n">BuildMI</span><span class="p">(</span><span class="n">BB</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">TII</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">ADDiu</span><span class="p">),</span> <span class="n">MaskLSB2</span><span class="p">)</span>
    <span class="p">.</span><span class="n">addReg</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">ZERO</span><span class="p">).</span><span class="n">addImm</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">);</span>
  <span class="n">BuildMI</span><span class="p">(</span><span class="n">BB</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">TII</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">AND</span><span class="p">),</span> <span class="n">AlignedAddr</span><span class="p">)</span>
    <span class="p">.</span><span class="n">addReg</span><span class="p">(</span><span class="n">Ptr</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">MaskLSB2</span><span class="p">);</span>
  <span class="n">BuildMI</span><span class="p">(</span><span class="n">BB</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">TII</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">ANDi</span><span class="p">),</span> <span class="n">PtrLSB2</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">Ptr</span><span class="p">).</span><span class="n">addImm</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">Subtarget</span><span class="p">.</span><span class="n">isLittle</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">BuildMI</span><span class="p">(</span><span class="n">BB</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">TII</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">SHL</span><span class="p">),</span> <span class="n">ShiftAmt</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">PtrLSB2</span><span class="p">).</span><span class="n">addImm</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="n">Off</span> <span class="o">=</span> <span class="n">RegInfo</span><span class="p">.</span><span class="n">createVirtualRegister</span><span class="p">(</span><span class="n">RC</span><span class="p">);</span>
    <span class="n">BuildMI</span><span class="p">(</span><span class="n">BB</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">TII</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">XORi</span><span class="p">),</span> <span class="n">Off</span><span class="p">)</span>
      <span class="p">.</span><span class="n">addReg</span><span class="p">(</span><span class="n">PtrLSB2</span><span class="p">).</span><span class="n">addImm</span><span class="p">((</span><span class="n">Size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">3</span> <span class="o">:</span> <span class="mi">2</span><span class="p">);</span>
    <span class="n">BuildMI</span><span class="p">(</span><span class="n">BB</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">TII</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">SHL</span><span class="p">),</span> <span class="n">ShiftAmt</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">Off</span><span class="p">).</span><span class="n">addImm</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">BuildMI</span><span class="p">(</span><span class="n">BB</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">TII</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">ORi</span><span class="p">),</span> <span class="n">MaskUpper</span><span class="p">)</span>
    <span class="p">.</span><span class="n">addReg</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">ZERO</span><span class="p">).</span><span class="n">addImm</span><span class="p">(</span><span class="n">MaskImm</span><span class="p">);</span>
  <span class="n">BuildMI</span><span class="p">(</span><span class="n">BB</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">TII</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">SHLV</span><span class="p">),</span> <span class="n">Mask</span><span class="p">)</span>
    <span class="p">.</span><span class="n">addReg</span><span class="p">(</span><span class="n">MaskUpper</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">ShiftAmt</span><span class="p">);</span>
  <span class="n">BuildMI</span><span class="p">(</span><span class="n">BB</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">TII</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">XOR</span><span class="p">),</span> <span class="n">Mask2</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">ZERO</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">Mask</span><span class="p">);</span>
  <span class="n">BuildMI</span><span class="p">(</span><span class="n">BB</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">TII</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">XOR</span><span class="p">),</span> <span class="n">Mask3</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">ZERO</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">Mask2</span><span class="p">);</span>
  <span class="n">BuildMI</span><span class="p">(</span><span class="n">BB</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">TII</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">ANDi</span><span class="p">),</span> <span class="n">MaskedCmpVal</span><span class="p">)</span>
    <span class="p">.</span><span class="n">addReg</span><span class="p">(</span><span class="n">CmpVal</span><span class="p">).</span><span class="n">addImm</span><span class="p">(</span><span class="n">MaskImm</span><span class="p">);</span>
  <span class="n">BuildMI</span><span class="p">(</span><span class="n">BB</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">TII</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">SHLV</span><span class="p">),</span> <span class="n">ShiftedCmpVal</span><span class="p">)</span>
    <span class="p">.</span><span class="n">addReg</span><span class="p">(</span><span class="n">MaskedCmpVal</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">ShiftAmt</span><span class="p">);</span>
  <span class="n">BuildMI</span><span class="p">(</span><span class="n">BB</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">TII</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">ANDi</span><span class="p">),</span> <span class="n">MaskedNewVal</span><span class="p">)</span>
    <span class="p">.</span><span class="n">addReg</span><span class="p">(</span><span class="n">NewVal</span><span class="p">).</span><span class="n">addImm</span><span class="p">(</span><span class="n">MaskImm</span><span class="p">);</span>
  <span class="n">BuildMI</span><span class="p">(</span><span class="n">BB</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">TII</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">SHLV</span><span class="p">),</span> <span class="n">ShiftedNewVal</span><span class="p">)</span>
    <span class="p">.</span><span class="n">addReg</span><span class="p">(</span><span class="n">MaskedNewVal</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">ShiftAmt</span><span class="p">);</span>

  <span class="c1">//  loop1MBB:</span>
  <span class="c1">//    ll      oldval,0(alginedaddr)</span>
  <span class="c1">//    and     maskedoldval0,oldval,mask</span>
  <span class="c1">//    bne     maskedoldval0,shiftedcmpval,sinkMBB</span>
  <span class="n">BB</span> <span class="o">=</span> <span class="n">loop1MBB</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="n">LL</span> <span class="o">=</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">LL</span><span class="p">;</span>
  <span class="n">BuildMI</span><span class="p">(</span><span class="n">BB</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">TII</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">LL</span><span class="p">),</span> <span class="n">OldVal</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">AlignedAddr</span><span class="p">).</span><span class="n">addImm</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="n">BuildMI</span><span class="p">(</span><span class="n">BB</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">TII</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">AND</span><span class="p">),</span> <span class="n">MaskedOldVal0</span><span class="p">)</span>
    <span class="p">.</span><span class="n">addReg</span><span class="p">(</span><span class="n">OldVal</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">Mask</span><span class="p">);</span>
  <span class="n">BuildMI</span><span class="p">(</span><span class="n">BB</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">TII</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">BNE</span><span class="p">))</span>
    <span class="p">.</span><span class="n">addReg</span><span class="p">(</span><span class="n">MaskedOldVal0</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">ShiftedCmpVal</span><span class="p">).</span><span class="n">addMBB</span><span class="p">(</span><span class="n">sinkMBB</span><span class="p">);</span>

  <span class="c1">//  loop2MBB:</span>
  <span class="c1">//    and     maskedoldval1,oldval,mask3</span>
  <span class="c1">//    or      storeval,maskedoldval1,shiftednewval</span>
  <span class="c1">//    sc      success,storeval,0(alignedaddr)</span>
  <span class="c1">//    beq     success,$0,loop1MBB</span>
  <span class="n">BB</span> <span class="o">=</span> <span class="n">loop2MBB</span><span class="p">;</span>
  <span class="n">BuildMI</span><span class="p">(</span><span class="n">BB</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">TII</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">AND</span><span class="p">),</span> <span class="n">MaskedOldVal1</span><span class="p">)</span>
    <span class="p">.</span><span class="n">addReg</span><span class="p">(</span><span class="n">OldVal</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">Mask3</span><span class="p">);</span>
  <span class="n">BuildMI</span><span class="p">(</span><span class="n">BB</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">TII</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">OR</span><span class="p">),</span> <span class="n">StoreVal</span><span class="p">)</span>
    <span class="p">.</span><span class="n">addReg</span><span class="p">(</span><span class="n">MaskedOldVal1</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">ShiftedNewVal</span><span class="p">);</span>
  <span class="kt">unsigned</span> <span class="n">SC</span> <span class="o">=</span> <span class="n">Cpu0</span><span class="o">::</span><span class="n">SC</span><span class="p">;</span>
  <span class="n">BuildMI</span><span class="p">(</span><span class="n">BB</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">TII</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">SC</span><span class="p">),</span> <span class="n">Success</span><span class="p">)</span>
      <span class="p">.</span><span class="n">addReg</span><span class="p">(</span><span class="n">StoreVal</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">AlignedAddr</span><span class="p">).</span><span class="n">addImm</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="n">BuildMI</span><span class="p">(</span><span class="n">BB</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">TII</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">BEQ</span><span class="p">))</span>
      <span class="p">.</span><span class="n">addReg</span><span class="p">(</span><span class="n">Success</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">ZERO</span><span class="p">).</span><span class="n">addMBB</span><span class="p">(</span><span class="n">loop1MBB</span><span class="p">);</span>

  <span class="c1">//  sinkMBB:</span>
  <span class="c1">//    srl     srlres,maskedoldval0,shiftamt</span>
  <span class="c1">//    sign_extend dest,srlres</span>
  <span class="n">BB</span> <span class="o">=</span> <span class="n">sinkMBB</span><span class="p">;</span>

  <span class="n">BuildMI</span><span class="p">(</span><span class="n">BB</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">TII</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">SHRV</span><span class="p">),</span> <span class="n">SrlRes</span><span class="p">)</span>
      <span class="p">.</span><span class="n">addReg</span><span class="p">(</span><span class="n">MaskedOldVal0</span><span class="p">).</span><span class="n">addReg</span><span class="p">(</span><span class="n">ShiftAmt</span><span class="p">);</span>
  <span class="n">BB</span> <span class="o">=</span> <span class="n">emitSignExtendToI32InReg</span><span class="p">(</span><span class="n">MI</span><span class="p">,</span> <span class="n">BB</span><span class="p">,</span> <span class="n">Size</span><span class="p">,</span> <span class="n">Dest</span><span class="p">,</span> <span class="n">SrlRes</span><span class="p">);</span>

  <span class="n">MI</span><span class="o">-&gt;</span><span class="n">eraseFromParent</span><span class="p">();</span>   <span class="c1">// The instruction is gone now.</span>

  <span class="k">return</span> <span class="n">exitMBB</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">SDValue</span> <span class="n">Cpu0TargetLowering</span><span class="o">::</span><span class="n">lowerATOMIC_FENCE</span><span class="p">(</span><span class="n">SDValue</span> <span class="n">Op</span><span class="p">,</span>
                                              <span class="n">SelectionDAG</span> <span class="o">&amp;</span><span class="n">DAG</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="c1">// FIXME: Need pseudo-fence for &#39;singlethread&#39; fences</span>
  <span class="c1">// FIXME: Set SType for weaker fences where supported/appropriate.</span>
  <span class="kt">unsigned</span> <span class="n">SType</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">SDLoc</span> <span class="nf">DL</span><span class="p">(</span><span class="n">Op</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">DAG</span><span class="p">.</span><span class="n">getNode</span><span class="p">(</span><span class="n">Cpu0ISD</span><span class="o">::</span><span class="n">Sync</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">MVT</span><span class="o">::</span><span class="n">Other</span><span class="p">,</span> <span class="n">Op</span><span class="p">.</span><span class="n">getOperand</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
                     <span class="n">DAG</span><span class="p">.</span><span class="n">getConstant</span><span class="p">(</span><span class="n">SType</span><span class="p">,</span> <span class="n">DL</span><span class="p">,</span> <span class="n">MVT</span><span class="o">::</span><span class="n">i32</span><span class="p">));</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter12_1/Cpu0RegisterInfo.h</p>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="c1">/// Code Generation virtual methods...</span>
  <span class="k">const</span> <span class="n">TargetRegisterClass</span> <span class="o">*</span><span class="n">getPointerRegClass</span><span class="p">(</span><span class="k">const</span> <span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">MF</span><span class="p">,</span>
                                                <span class="kt">unsigned</span> <span class="n">Kind</span><span class="p">)</span> <span class="k">const</span> <span class="n">override</span><span class="p">;</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter12_1/Cpu0RegisterInfo.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="k">const</span> <span class="n">TargetRegisterClass</span> <span class="o">*</span>
<span class="n">Cpu0RegisterInfo</span><span class="o">::</span><span class="n">getPointerRegClass</span><span class="p">(</span><span class="k">const</span> <span class="n">MachineFunction</span> <span class="o">&amp;</span><span class="n">MF</span><span class="p">,</span>
                                     <span class="kt">unsigned</span> <span class="n">Kind</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="k">return</span> <span class="o">&amp;</span><span class="n">Cpu0</span><span class="o">::</span><span class="n">CPURegsRegClass</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter12_1/Cpu0SEISelLowering.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">Cpu0SETargetLowering</span><span class="o">::</span><span class="n">Cpu0SETargetLowering</span><span class="p">(</span><span class="k">const</span> <span class="n">Cpu0TargetMachine</span> <span class="o">&amp;</span><span class="n">TM</span><span class="p">,</span>
                                           <span class="k">const</span> <span class="n">Cpu0Subtarget</span> <span class="o">&amp;</span><span class="n">STI</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">Cpu0TargetLowering</span><span class="p">(</span><span class="n">TM</span><span class="p">,</span> <span class="n">STI</span><span class="p">)</span> <span class="p">{</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="n">setOperationAction</span><span class="p">(</span><span class="n">ISD</span><span class="o">::</span><span class="n">ATOMIC_FENCE</span><span class="p">,</span>       <span class="n">MVT</span><span class="o">::</span><span class="n">Other</span><span class="p">,</span> <span class="n">Custom</span><span class="p">);</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p class="rubric">lbdex/chapters/Chapter12_1/Cpu0TargetMachine.cpp</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">/// Cpu0 Code Generator Pass Configuration Options.</span>
<span class="k">class</span> <span class="nc">Cpu0PassConfig</span> <span class="o">:</span> <span class="k">public</span> <span class="n">TargetPassConfig</span> <span class="p">{</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="kt">void</span> <span class="n">addIRPasses</span><span class="p">()</span> <span class="n">override</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre>  <span class="p">...</span>
<span class="p">};</span>
</pre></div>
</div>
<div class="highlight-c++"><div class="highlight"><pre><span class="kt">void</span> <span class="n">Cpu0PassConfig</span><span class="o">::</span><span class="n">addIRPasses</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">TargetPassConfig</span><span class="o">::</span><span class="n">addIRPasses</span><span class="p">();</span>
  <span class="n">addPass</span><span class="p">(</span><span class="n">createAtomicExpandPass</span><span class="p">(</span><span class="o">&amp;</span><span class="n">getCpu0TargetMachine</span><span class="p">()));</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Since SC instruction uses RegisterOperand type in Cpu0InstrInfo.td and SC uses
FMem node which DecoderMethod is &#8220;DecodeMem&#8221;, the DecodeMem() of
Cpu0Disassembler.cpp need to change as above.</p>
<p>The atomic node defined in &#8220;let usesCustomInserter = 1 in&#8221; of Cpu0InstrInfo.td
tells llvm calling EmitInstrWithCustomInserter() of Cpu0ISelLowering.cpp. For
example, &#8220;def ATOMIC_LOAD_ADD_I8 : Atomic2Ops&lt;atomic_load_add_8, CPURegs&gt;;&#8221; will
calling EmitInstrWithCustomInserter() with Machine Instruction Opcode
&#8220;ATOMIC_LOAD_ADD_I8&#8221; when it meets IR &#8220;load atomic i8*&#8221;.</p>
<p>The &#8220;setInsertFencesForAtomic(true);&#8221; in Cpu0ISelLowering.cpp will trigger
addIRPasses() of Cpu0TargetMachine.cpp, then createAtomicExpandPass() in
addIRPasses() will create llvm IR ATOMIC_FENCE. Next, the lowerATOMIC_FENCE()
of Cpu0ISelLowering.cpp will create Cpu0ISD::Sync when it meets IR ATOMIC_FENCE
since &#8220;setOperationAction(ISD::ATOMIC_FENCE, MVT::Other, Custom);&#8221; of
Cpu0SEISelLowering.cpp. Finally the pattern defined in Cpu0InstrInfo.td translate
it into instruction &#8220;sync&#8221; by &#8220;def SYNC&#8221; and alias &#8220;SYNC 0&#8221;.</p>
<p>This part of Cpu0 backend code is same with Mips except Cpu0 has no instruction
&#8220;nor&#8221;.</p>
<p>List the atomic IRs, corresponding DAGs and Opcode as the following table.</p>
<table border="1" class="docutils">
<caption>The atomic related IRs, their corresponding DAGs and Opcode of Cpu0ISelLowering.cpp</caption>
<colgroup>
<col width="33%" />
<col width="34%" />
<col width="34%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">IR</th>
<th class="head">DAG</th>
<th class="head">Opcode</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>load atomic</td>
<td>AtomicLoad</td>
<td>ATOMIC_CMP_SWAP_XXX</td>
</tr>
<tr class="row-odd"><td>store atomic</td>
<td>AtomicStore</td>
<td>ATOMIC_SWAP_XXX</td>
</tr>
<tr class="row-even"><td>atomicrmw add</td>
<td>AtomicLoadAdd</td>
<td>ATOMIC_LOAD_ADD_XXX</td>
</tr>
<tr class="row-odd"><td>atomicrmw sub</td>
<td>AtomicLoadSub</td>
<td>ATOMIC_LOAD_SUB_XXX</td>
</tr>
<tr class="row-even"><td>atomicrmw xor</td>
<td>AtomicLoadXor</td>
<td>ATOMIC_LOAD_XOR_XXX</td>
</tr>
<tr class="row-odd"><td>atomicrmw and</td>
<td>AtomicLoadAnd</td>
<td>ATOMIC_LOAD_AND_XXX</td>
</tr>
<tr class="row-even"><td>atomicrmw nand</td>
<td>AtomicLoadNand</td>
<td>ATOMIC_LOAD_NAND_XXX</td>
</tr>
<tr class="row-odd"><td>atomicrmw or</td>
<td>AtomicLoadOr</td>
<td>ATOMIC_LOAD_OR_XXX</td>
</tr>
<tr class="row-even"><td>cmpxchg</td>
<td>AtomicCmpSwapWithSuccess</td>
<td>ATOMIC_CMP_SWAP_XXX</td>
</tr>
<tr class="row-odd"><td>atomicrmw xchg</td>
<td>AtomicLoadSwap</td>
<td>ATOMIC_SWAP_XXX</td>
</tr>
</tbody>
</table>
<p>Input files atomics.ll and atomics-fences.ll include the llvm atomic IRs test.
Input files ch12_atomics.cpp and ch12_atomics-fences.cpp are the C++ source
files for generating llvm atomic IRs. The C++ files need to run with clang
options &#8220;clang++ -pthread -std=c++11&#8221;.</p>
<table class="docutils footnote" frame="void" id="exception" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td><a class="reference external" href="http://llvm.org/docs/ExceptionHandling.html">http://llvm.org/docs/ExceptionHandling.html</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="thread-wiki" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td><a class="reference external" href="http://en.wikipedia.org/wiki/Thread-local_storage">http://en.wikipedia.org/wiki/Thread-local_storage</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="atomic-wiki" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[3]</a></td><td><a class="reference external" href="https://en.wikipedia.org/wiki/Memory_model_%28programming%29">https://en.wikipedia.org/wiki/Memory_model_%28programming%29</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="atomic-stackoverflow" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id4">[4]</a></td><td><a class="reference external" href="http://stackoverflow.com/questions/6319146/c11-introduced-a-standardized-memory-model-what-does-it-mean-and-how-is-it-g">http://stackoverflow.com/questions/6319146/c11-introduced-a-standardized-memory-model-what-does-it-mean-and-how-is-it-g</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="atomic-herbsutter" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id5">[5]</a></td><td><a class="reference external" href="http://herbsutter.com/2013/02/11/atomic-weapons-the-c-memory-model-and-modern-hardware/">http://herbsutter.com/2013/02/11/atomic-weapons-the-c-memory-model-and-modern-hardware/</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="atomics-llvm" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id6">[6]</a></td><td><a class="reference external" href="http://llvm.org/docs/Atomics.html">http://llvm.org/docs/Atomics.html</a></td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="llvmlang-ordering" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id7">[7]</a></td><td><a class="reference external" href="http://llvm.org/docs/LangRef.html#ordering">http://llvm.org/docs/LangRef.html#ordering</a></td></tr>
</tbody>
</table>
</div>
</div>


      </div>
      <div class="bottomnav">
      
        <p>
        «&#160;&#160;<a href="asm.html">Assembler</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="verilog.html">Verify backend on verilog simulator</a>&#160;&#160;»
        </p>

      </div>

    <div class="footer">
        &copy; Copyright 2013, LLVM.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>